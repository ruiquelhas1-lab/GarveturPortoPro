<!doctype html>
<html lang="pt-PT">
<head>
  <meta charset="utf-8" />
  <title>Garvetur Porto Pro ‚Äî Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --gold:#A38B63;
      --gold-soft:rgba(163,139,99,.35);
      --bg:#0B0B0B;
      --panel:#121212;
      --panel-soft:#181818;
      --text:#FFFFFF;
      --muted:#A0A0A0;
      --border:rgba(255,255,255,.12);
      --danger:#F25F5C;
      --success:#4CAF50;
      --warning:#FFC857;
      --radius-lg:18px;
      --radius-md:12px;
      --shadow-soft:0 14px 25px rgba(0,0,0,.4);
    }
    *{box-sizing:border-box;}
    html,body{
      margin:0;
      height:100%;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      background:radial-gradient(circle at top,#1c1c1c 0,#050505 55%,#000 100%);
      color:var(--text);
    }
    body{display:flex;flex-direction:column;}

    .app-shell{
      display:grid;
      grid-template-rows:64px auto;
      height:100%;
    }

    header.app-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 18px;
      border-bottom:1px solid rgba(163,139,99,.35);
      background:linear-gradient(90deg,#050505,#111,#050505);
      position:sticky;
      top:0;
      z-index:20;
      gap:16px;
      flex-wrap:wrap;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .brand-icon{
      width:26px;
      height:26px;
      border-radius:999px;
      border:1px solid var(--gold);
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:0 0 0 1px rgba(163,139,99,.3);
    }
    .brand h1{
      margin:0;
      font-size:17px;
      letter-spacing:.04em;
      text-transform:uppercase;
      color:var(--gold);
    }
    .brand span.sub{
      display:block;
      font-size:11px;
      color:var(--muted);
      letter-spacing:.12em;
      text-transform:uppercase;
    }

    .nav-tabs{
      display:flex;
      align-items:center;
      flex-wrap:wrap;
      gap:4px;
      background:rgba(0,0,0,.35);
      padding:4px;
      border-radius:999px;
      border:1px solid rgba(163,139,99,.35);
    }
    .nav-tab{
      padding:5px 10px;
      border-radius:999px;
      font-size:11px;
      text-decoration:none;
      color:var(--muted);
      letter-spacing:.12em;
      text-transform:uppercase;
      border:1px solid transparent;
      transition:.16s background,.16s color,.16s border-color,.16s transform;
    }
    .nav-tab:hover{
      color:#fff;
      border-color:rgba(163,139,99,.6);
      transform:translateY(-1px);
    }
    .nav-tab.active{
      background:var(--gold);
      color:#0A0A0A;
      border-color:var(--gold);
      font-weight:600;
    }

    .header-actions{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }
    .btn{
      border-radius:999px;
      border:1px solid var(--gold-soft);
      background:rgba(12,12,12,.9);
      color:var(--text);
      padding:7px 12px;
      font-size:13px;
      display:inline-flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
      transition:.18s border-color,.18s background,.18s transform;
    }
    .btn-primary{
      background:var(--gold);
      color:#0A0A0A;
      border-color:var(--gold);
      font-weight:500;
    }
    .btn-ghost{
      background:transparent;
    }
    .btn:hover{
      border-color:var(--gold);
      transform:translateY(-1px);
    }

    .layout{
      display:grid;
      grid-template-columns:280px minmax(0,1fr);
      height:calc(100vh - 64px);
      max-height:calc(100vh - 64px);
      overflow:hidden;
    }
    @media(max-width:960px){
      .layout{
        grid-template-columns:1fr;
        grid-template-rows:auto auto;
        height:auto;
        max-height:none;
      }
    }

    .sidebar{
      border-right:1px solid rgba(163,139,99,.24);
      background:radial-gradient(circle at top left,#141414,#060606);
      padding:12px 14px;
      overflow-y:auto;
    }
    .sidebar-section{
      border-radius:var(--radius-md);
      padding:10px 11px;
      background:rgba(0,0,0,.45);
      border:1px solid rgba(163,139,99,.18);
      margin-bottom:10px;
    }
    .sidebar-section h3{
      margin:0 0 6px;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.16em;
      color:var(--muted);
    }
    .sidebar-section p{
      margin:2px 0 6px;
      font-size:12px;
      color:var(--muted);
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:4px;
      margin-bottom:8px;
    }
    .field-row{
      display:flex;
      gap:6px;
    }
    label.field-label{
      font-size:11px;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.12em;
    }
    input[type="date"],
    select{
      background:rgba(0,0,0,.7);
      color:var(--text);
      border-radius:10px;
      border:1px solid rgba(163,139,99,.22);
      padding:6px 8px;
      font-size:13px;
      outline:none;
      width:100%;
    }
    input:focus,select:focus{
      border-color:var(--gold);
      box-shadow:0 0 0 1px rgba(163,139,99,.35);
    }
    .checks{
      display:flex;
      flex-direction:column;
      gap:6px;
      margin-top:4px;
      font-size:12px;
      color:var(--muted);
    }
    .checks label{
      display:flex;
      align-items:center;
      gap:6px;
    }
    .checks input{
      accent-color:var(--gold);
    }

    .main-area{
      padding:14px 16px 18px;
      overflow-y:auto;
      background:radial-gradient(circle at top,#1a1a1a,#050505 55%,#000 100%);
    }

    .section-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:10px;
      margin-bottom:10px;
    }
    .section-header h2{
      margin:0;
      font-size:15px;
      letter-spacing:.16em;
      text-transform:uppercase;
      color:var(--muted);
    }
    .section-header p{
      margin:2px 0 0;
      font-size:12px;
      color:var(--muted);
    }

    .context-label{
      font-size:11px;
      color:var(--muted);
      text-align:right;
    }

    .kpi-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(190px,1fr));
      gap:10px;
      margin-bottom:14px;
    }
    .kpi-card{
      border-radius:var(--radius-lg);
      border:1px solid rgba(163,139,99,.35);
      background:radial-gradient(circle at top left,#181818,#070707);
      padding:10px 12px;
      box-shadow:var(--shadow-soft);
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .kpi-label{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.14em;
      color:var(--muted);
    }
    .kpi-value{
      font-size:20px;
      font-weight:600;
      color:#fff;
    }
    .kpi-sub{
      font-size:11px;
      color:var(--muted);
    }
    .kpi-badge{
      align-self:flex-start;
      margin-top:4px;
      padding:2px 7px;
      border-radius:999px;
      border:1px solid rgba(163,139,99,.4);
      font-size:10px;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.08em;
    }
    .kpi-badge.ok{border-color:rgba(76,175,80,.7);color:#A5D6A7;}
    .kpi-badge.warn{border-color:rgba(255,200,87,.8);color:#FFE082;}
    .kpi-badge.bad{border-color:rgba(242,95,92,.8);color:#FFABAB;}

    .area-tabs{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-bottom:10px;
    }
    .area-tab{
      border-radius:999px;
      border:1px solid rgba(163,139,99,.28);
      background:rgba(5,5,5,.9);
      color:var(--muted);
      padding:4px 10px;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.14em;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      transition:.16s background,.16s border-color,.16s color,.16s transform;
    }
    .area-tab span.icon{
      font-size:13px;
    }
    .area-tab.active{
      background:var(--gold);
      color:#0A0A0A;
      border-color:var(--gold);
      font-weight:600;
      transform:translateY(-1px);
    }

    .area-panel{
      display:none;
      animation:fadeIn .18s ease-out;
    }
    .area-panel.active{
      display:block;
    }
    @keyframes fadeIn{
      from{opacity:0;transform:translateY(4px);}
      to{opacity:1;transform:none;}
    }

    .charts-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
      gap:10px;
      margin-top:6px;
    }
    .chart-card{
      border-radius:var(--radius-md);
      border:1px solid rgba(163,139,99,.26);
      background:radial-gradient(circle at top,#191919,#050505);
      padding:8px 10px;
      box-shadow:0 12px 24px rgba(0,0,0,.55);
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .chart-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:6px;
    }
    .chart-title{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.14em;
      color:var(--muted);
    }
    .chart-subtitle{
      font-size:11px;
      color:var(--muted);
      text-align:right;
    }

    .chart-rows{
      margin-top:4px;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .chart-row{
      display:flex;
      align-items:center;
      gap:6px;
      font-size:11px;
      color:var(--muted);
    }
    .chart-label{
      width:90px;
      flex-shrink:0;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .chart-bar-wrap{
      flex:1;
      background:linear-gradient(90deg,#111,#080808);
      border-radius:999px;
      overflow:hidden;
      position:relative;
      height:8px;
      box-shadow:inset 0 0 0 1px rgba(255,255,255,.04);
    }
    .chart-bar{
      position:absolute;
      inset:0;
      border-radius:999px;
      background:linear-gradient(90deg,rgba(163,139,99,1),rgba(245,225,181,0.85));
      width:0%;
      transform-origin:left center;
      transition:width .25s ease-out;
    }
    .chart-value{
      width:90px;
      text-align:right;
      flex-shrink:0;
      font-variant-numeric:tabular-nums;
    }
    .chart-empty{
      font-size:11px;
      color:var(--muted);
      margin-top:4px;
    }

    @media(max-width:1100px){
      .chart-card.responsive{
        display:none;
      }
    }

    .empty{
      font-size:12px;
      color:var(--muted);
      margin-top:10px;
    }
  </style>
</head>
<body>
<div class="app-shell">
  <header class="app-header">
    <div class="brand">
      <div class="brand-icon">
        <svg width="16" height="16" viewBox="0 0 24 24" stroke="var(--gold)" fill="none" stroke-width="1.8">
          <circle cx="12" cy="12" r="9"></circle>
          <path d="M8 12.5l2.5 2.5L16 9"></path>
        </svg>
      </div>
      <div>
        <h1>Garvetur Porto Pro ‚Äî Dashboard</h1>
        <span class="sub">Vis√£o global ¬∑ Leads ¬∑ Produto ¬∑ Fecho ¬∑ Tarefas</span>
      </div>
    </div>

    <nav class="nav-tabs">
      <a href="index.html" class="nav-tab">In√≠cio</a>
      <a href="mapa.html" class="nav-tab">Mapa</a>
      <a href="kanban.html" class="nav-tab">Leads</a>
      <a href="angariacoes.html" class="nav-tab">Angaria√ß√µes</a>
      <a href="dashboard.html" class="nav-tab active">Dashboard</a>
      <a href="vendas.html" class="nav-tab">Vendas</a>
      <a href="tarefas.html" class="nav-tab">Tarefas</a>
    </nav>

    <div class="header-actions">
      <button class="btn btn-ghost" id="reloadBtn">Atualizar dados</button>
    </div>
  </header>

  <div class="layout">
    <aside class="sidebar">
      <div class="sidebar-section">
        <h3>Filtros</h3>
        <div class="field">
          <label class="field-label" for="filterConsultor">Consultor</label>
          <select id="filterConsultor">
            <option value="">Todos</option>
          </select>
        </div>
        <div class="field-row">
          <div class="field">
            <label class="field-label" for="filterDataDe">De</label>
            <input type="date" id="filterDataDe" />
          </div>
          <div class="field">
            <label class="field-label" for="filterDataAte">At√©</label>
            <input type="date" id="filterDataAte" />
          </div>
        </div>
        <div class="checks">
          <label><input type="checkbox" id="filterShowHidden" /> Mostrar invis√≠veis</label>
          <label><input type="checkbox" id="filterOnlyHidden" /> S√≥ invis√≠veis</label>
        </div>
        <button class="btn" id="applyFiltersBtn" style="margin-top:6px;width:100%;">Aplicar filtros</button>
        <button class="btn" id="clearFiltersBtn" style="margin-top:4px;width:100%;background:transparent;border-color:rgba(255,255,255,.2);">Limpar</button>
        <p style="margin-top:6px;">Per√≠odo aplica-se √† <strong>data da Lead</strong>, <strong>data da Angaria√ß√£o</strong>, datas de Fecho & tarefas (data limite / CPCV para neg√≥cios).</p>
      </div>

      <div class="sidebar-section">
        <h3>Dicas</h3>
        <p>Use o filtro de <strong>Consultor</strong> para preparar reuni√µes individuais.</p>
        <p>Combine com o per√≠odo para ver apenas o m√™s atual, um trimestre ou o ano.</p>
        <p>Os gr√°ficos complementares escondem-se em ecr√£s pequenos para manter a leitura limpa.</p>
      </div>
    </aside>

    <main class="main-area">
      <div class="section-header">
        <div>
          <h2>Vis√£o Geral</h2>
          <p>Resumo consolidado de pipeline comercial ‚Äî Leads, Produto, Fecho e Tarefas.</p>
        </div>
        <div id="contextLabel" class="context-label"></div>
      </div>

      <section class="kpi-grid" id="kpiGrid"></section>

      <div class="area-tabs">
        <button class="area-tab active" data-area="leads">
          <span class="icon">üìä</span> Leads
        </button>
        <button class="area-tab" data-area="angs">
          <span class="icon">üèóÔ∏è</span> Angaria√ß√µes
        </button>
        <button class="area-tab" data-area="fechos">
          <span class="icon">üíº</span> Fechos & Vendas
        </button>
        <button class="area-tab" data-area="tarefas">
          <span class="icon">‚úÖ</span> Tarefas
        </button>
      </div>

      <section class="area-panel active" id="areaLeads">
        <div class="charts-grid" id="leadsCharts"></div>
        <div class="empty" id="leadsEmpty" style="display:none;">Sem leads nos filtros atuais.</div>
      </section>

      <section class="area-panel" id="areaAngs">
        <div class="charts-grid" id="angsCharts"></div>
        <div class="empty" id="angsEmpty" style="display:none;">Sem angaria√ß√µes nos filtros atuais.</div>
      </section>

      <section class="area-panel" id="areaFechos">
        <div class="charts-grid" id="fechosCharts"></div>
        <div class="empty" id="fechosEmpty" style="display:none;">Sem neg√≥cios de fecho nos filtros atuais.</div>
      </section>

      <section class="area-panel" id="areaTarefas">
        <div class="charts-grid" id="tarefasCharts"></div>
        <div class="empty" id="tarefasEmpty" style="display:none;">Sem tarefas nos filtros atuais.</div>
      </section>
    </main>
  </div>
</div>

<script>
(function(){
  const STORAGE_LEADS    = 'gpp_leads_v5';
  const STORAGE_ANG      = 'gpp_angariacoes_v2';
  const STORAGE_TASKS    = 'gpp_tarefas_v1';
  const STORAGE_FILTERS  = 'gpp_dashboard_filters_v1';

  const filterConsultor   = document.getElementById('filterConsultor');
  const filterDataDe      = document.getElementById('filterDataDe');
  const filterDataAte     = document.getElementById('filterDataAte');
  const filterShowHidden  = document.getElementById('filterShowHidden');
  const filterOnlyHidden  = document.getElementById('filterOnlyHidden');
  const applyFiltersBtn   = document.getElementById('applyFiltersBtn');
  const clearFiltersBtn   = document.getElementById('clearFiltersBtn');
  const reloadBtn         = document.getElementById('reloadBtn');

  const kpiGrid           = document.getElementById('kpiGrid');
  const contextLabel      = document.getElementById('contextLabel');

  const leadsCharts       = document.getElementById('leadsCharts');
  const angsCharts        = document.getElementById('angsCharts');
  const fechosCharts      = document.getElementById('fechosCharts');
  const tarefasCharts     = document.getElementById('tarefasCharts');

  const leadsEmpty        = document.getElementById('leadsEmpty');
  const angsEmpty         = document.getElementById('angsEmpty');
  const fechosEmpty       = document.getElementById('fechosEmpty');
  const tarefasEmpty      = document.getElementById('tarefasEmpty');

  const areaTabs = Array.from(document.querySelectorAll('.area-tab'));
  const areaPanels = {
    leads:  document.getElementById('areaLeads'),
    angs:   document.getElementById('areaAngs'),
    fechos: document.getElementById('areaFechos'),
    tarefas:document.getElementById('areaTarefas')
  };

  let allLeads = [];
  let allAngs  = [];
  let allTasks = [];

  const FILTERS = {
    consultor:'',
    de:'',
    ate:'',
    showHidden:false,
    onlyHidden:false
  };

  /* ========= HELPERS NUM√âRICOS ========= */
  function parseNum(v){
    if(v===null || v===undefined || v==='') return 0;
    const n = parseFloat(String(v).replace(/\./g,'').replace(',','.'));
    return isFinite(n) ? n : 0;
  }
  function parsePct(v){
    if(v===null || v===undefined || v==='') return NaN;
    const n = parseFloat(String(v).replace('%','').replace(',','.'));
    return isFinite(n) ? n : NaN;
  }
  function formatMoney(n){
    if(n===null || n===undefined || n===0) return '‚Ç¨ 0';
    const v = (typeof n === 'number') ? n : parseNum(n);
    if(!isFinite(v) || v === 0) return '‚Ç¨ 0';
    return v.toLocaleString('pt-PT',{style:'currency',currency:'EUR',maximumFractionDigits:0});
  }
  function formatInt(n){
    const v = parseInt(n,10) || 0;
    return v.toLocaleString('pt-PT');
  }
  function formatPct(n){
    const v = (typeof n === 'number') ? n : parsePct(n);
    if(!isFinite(v)) return '‚Äî';
    return v.toFixed(1).replace('.',',') + '%';
  }

  /* ========= HELPERS DE DATA ========= */
  function normalizeDateToISO(v){
    if(!v) return '';
    let s = String(v).trim();

    if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;

    const m = /^(\d{2})\/(\d{2})\/(\d{4})$/.exec(s);
    if(m){
      const dd = m[1], mm = m[2], yyyy = m[3];
      return `${yyyy}-${mm}-${dd}`;
    }

    return s.slice(0,10);
  }

  function findDateWithToken(objs, token){
    const tk = String(token).toLowerCase();
    for(const obj of objs){
      if(!obj || typeof obj!=='object') continue;
      for(const k of Object.keys(obj)){
        const lk = k.toLowerCase();
        if(!lk.includes(tk)) continue;
        const v = obj[k];
        if(typeof v === 'string' || typeof v === 'number'){
          const iso = normalizeDateToISO(v);
          if(/^\d{4}-\d{2}-\d{2}$/.test(iso)) return iso;
        }
      }
    }
    return '';
  }

  /* ========= HELPERS DE AGRUPAMENTO ========= */
  function groupCount(arr, labelFn){
    const map = {};
    arr.forEach(item=>{
      const label = labelFn(item);
      if(!label) return;
      map[label] = (map[label] || 0) + 1;
    });
    return map;
  }
  function mapToSortedArray(map){
    return Object.entries(map)
      .filter(([,v])=>v>0)
      .sort((a,b)=>b[1]-a[1])
      .map(([label,value])=>({label,value}));
  }
  function topN(items,n){
    if(items.length <= n) return items;
    const top = items.slice(0,n);
    const resto = items.slice(n);
    const somaResto = resto.reduce((acc,it)=>acc+it.value,0);
    if(somaResto>0){
      top.push({label:'Outros',value:somaResto});
    }
    return top;
  }

  /* ========= HELPERS GEN√âRICOS ========= */
  function findDeep(obj, matcher){
    const visited = new Set();
    function _search(o){
      if(!o || typeof o !== 'object' || visited.has(o)) return undefined;
      visited.add(o);
      for(const k in o){
        const v = o[k];
        if(matcher(k,v)) return v;
        if(v && typeof v === 'object'){
          const r = _search(v);
          if(r !== undefined) return r;
        }
      }
      return undefined;
    }
    return _search(obj);
  }

  function resolveFromFecho(obj, keys){
    if(!obj || typeof obj !== 'object') return '';
    for(const k of keys){
      if(obj[k]) return obj[k];
    }
    const candidatos = [obj.fecho, obj.Fecho, obj.fechos, obj.dadosFecho, obj.fechar];
    for(const sub of candidatos){
      if(!sub || typeof sub !== 'object') continue;
      for(const k of keys){
        if(sub[k]) return sub[k];
      }
    }
    return '';
  }

  /* ========= LOAD DE STORAGE ========= */
  function loadLeads(){
    try{
      const raw = localStorage.getItem(STORAGE_LEADS);
      const parsed = raw ? JSON.parse(raw) : [];
      allLeads = Array.isArray(parsed) ? parsed : [];
    }catch(e){
      console.error('Erro a ler leads:',e);
      allLeads = [];
    }
  }
  function loadAngs(){
    try{
      const raw = localStorage.getItem(STORAGE_ANG);
      const parsed = raw ? JSON.parse(raw) : {};
      allAngs = (parsed && Array.isArray(parsed.deals)) ? parsed.deals : [];
    }catch(e){
      console.error('Erro a ler angaria√ß√µes:',e);
      allAngs = [];
    }
  }
  function loadTasks(){
    try{
      const raw = localStorage.getItem(STORAGE_TASKS);
      if(!raw){ allTasks = []; return; }
      const parsed = JSON.parse(raw);
      if(parsed && Array.isArray(parsed.tasks)){
        allTasks = parsed.tasks;
      }else if(Array.isArray(parsed)){
        allTasks = parsed;
      }else{
        allTasks = [];
      }
    }catch(e){
      console.error('Erro a ler tarefas:',e);
      allTasks = [];
    }
  }

  /* ========= FILTROS (LOCAL STORAGE) ========= */
  function loadFiltersState(){
    try{
      const raw = localStorage.getItem(STORAGE_FILTERS);
      if(!raw) return;
      const f = JSON.parse(raw);
      if(!f || typeof f !== 'object') return;
      FILTERS.consultor  = f.consultor  || '';
      FILTERS.de         = f.de         || '';
      FILTERS.ate        = f.ate        || '';
      FILTERS.showHidden = !!f.showHidden;
      FILTERS.onlyHidden = !!f.onlyHidden;
    }catch(e){
      console.error('Erro a ler filtros do dashboard:',e);
    }
  }

  function saveFiltersState(){
    try{
      localStorage.setItem(STORAGE_FILTERS, JSON.stringify(FILTERS));
    }catch(e){
      console.error('Erro a gravar filtros do dashboard:',e);
    }
  }

  function syncFiltersToUI(){
    filterConsultor.value      = FILTERS.consultor || '';
    filterDataDe.value         = FILTERS.de || '';
    filterDataAte.value        = FILTERS.ate || '';
    filterShowHidden.checked   = FILTERS.showHidden;
    filterOnlyHidden.checked   = FILTERS.onlyHidden;
  }

  function buildConsultorOptions(){
    const set = new Set();
    allLeads.forEach(l=>{ if(l && l.consultor) set.add(l.consultor); });
    allAngs.forEach(d=>{ if(d && d.consultor) set.add(d.consultor); });
    allTasks.forEach(t=>{ if(t && t.responsavel) set.add(t.responsavel); });

    const current = FILTERS.consultor || filterConsultor.value;
    filterConsultor.innerHTML = '<option value="">Todos</option>';
    Array.from(set).sort().forEach(name=>{
      const opt = document.createElement('option');
      opt.value = name;
      opt.textContent = name;
      filterConsultor.appendChild(opt);
    });
    if(current && set.has(current)){
      filterConsultor.value = current;
    }
  }

  /* ========= RESOLU√á√ÉO DE DATAS/COMISS√ïES (FECHOS) ========= */

  function resolveDataFechoFromLead(l){
    const fecho = l.fecho || {};

    let d = fecho['Data do CPCV'] ||
            fecho['dataCpcv'] ||
            fecho['data_cpcv'] ||
            fecho['dataCPCV'] ||
            fecho['dataCpcvFecho'] ||
            fecho['dataFechoCpcv'];
    if(d) return normalizeDateToISO(d);

    const deep = findDeep(l,(k,v)=>{
      const kl = k.toLowerCase();
      if(!kl.includes('cpcv')) return false;
      const iso = normalizeDateToISO(v);
      return /^\d{4}-\d{2}-\d{2}$/.test(iso);
    });
    if(deep) return normalizeDateToISO(deep);

    const fallback =
      l.dataFechoNegocio ||
      l.dataFecho ||
      l.dataVenda ||
      l.data ||
      '';
    return normalizeDateToISO(fallback);
  }

  function resolveDataFechoFromAng(a){
    const fecho = a.fecho || {};

    let d = fecho['Data do CPCV'] ||
            fecho['dataCpcv'] ||
            fecho['data_cpcv'] ||
            fecho['dataCPCV'] ||
            fecho['dataCpcvFecho'] ||
            fecho['dataFechoCpcv'];
    if(d) return normalizeDateToISO(d);

    const deep = findDeep(a,(k,v)=>{
      const kl = k.toLowerCase();
      if(!kl.includes('cpcv')) return false;
      const iso = normalizeDateToISO(v);
      return /^\d{4}-\d{2}-\d{2}$/.test(iso);
    });
    if(deep) return normalizeDateToISO(deep);

    const fallback =
      a.dataVenda ||
      a.dataFecho ||
      a.dataAngariacao ||
      '';
    return normalizeDateToISO(fallback);
  }

  function resolveTipoNegocioFromLead(l){
    return (resolveFromFecho(l, ['tipo_negocio','tipoNegocio','Natureza neg√≥cio']) ||
            l.tipo_negocio ||
            l.tipoNegocio ||
            '').trim();
  }
  function resolveTipoNegocioFromAng(a){
    return (resolveFromFecho(a, ['tipo_negocio','tipoNegocio','naturezaNegocio']) ||
            a.tipoNegocio ||
            a.tipo_negocio ||
            a.naturezaNegocio ||
            '').trim();
  }
  function resolveZonaFromLead(l){
    return (resolveFromFecho(l, ['zonaFecho','zona']) ||
            l.zona ||
            l.zonaPreferencial ||
            '').trim();
  }
  function resolveZonaFromAng(a){
    return (resolveFromFecho(a, ['zonaImovel','zona']) ||
            a.zona ||
            a.zonaImovel ||
            a.localizacao ||
            '').trim();
  }
  function resolveTipologiaFromLead(l){
    return (resolveFromFecho(l, ['tipologiaFecho','tipologia']) ||
            l.tipologia ||
            '').trim();
  }
  function resolveTipologiaFromAng(a){
    return (resolveFromFecho(a, ['tipologiaImovel','tipologia']) ||
            a.tipologia ||
            a.tipologiaImovel ||
            '').trim();
  }

  function resolvePctComissaoFromLead(l){
    let pct;

    const rawFecho = resolveFromFecho(l, [
      'Comiss√£o','Comiss√£o (%)','Percentagem comiss√£o',
      'percentComissao','comissao_percent','taxaComissao','comissao',
      'fecho_comissao_pct','fechoComissaoPct','comissaoPct'
    ]);
    pct = parsePct(rawFecho);
    if(isFinite(pct) && pct>0 && pct<=100) return pct;

    if(l.comissao === 'outro' && l.comissaoOutro){
      pct = parsePct(l.comissaoOutro);
    }else if(l.comissao){
      pct = parsePct(l.comissao);
    }else if(l.taxaComissao){
      pct = parsePct(l.taxaComissao);
    }else if(l.comissao_percent){
      pct = parsePct(l.comissao_percent);
    }
    if(isFinite(pct) && pct>0 && pct<=100) return pct;

    const deepVal = findDeep(l,(k,v)=>{
      const kl = k.toLowerCase();
      if(!kl.includes('comiss')) return false;
      const p = parsePct(v);
      return isFinite(p) && p>0 && p<=100;
    });
    const deepPct = parsePct(deepVal);
    if(isFinite(deepPct) && deepPct>0 && deepPct<=100) return deepPct;

    return NaN;
  }

  function resolvePctComissaoFromAng(a){
    let pct;

    const rawFecho = resolveFromFecho(a, [
      'Comiss√£o','Comiss√£o (%)','Percentagem comiss√£o',
      'percentComissao','comissao_percent','taxaComissao','comissao'
    ]);
    pct = parsePct(rawFecho);
    if(isFinite(pct) && pct>0 && pct<=100) return pct;

    if(a.comissao === 'outro' && a.comissaoOutro){
      pct = parsePct(a.comissaoOutro);
    }else if(a.comissao){
      pct = parsePct(a.comissao);
    }else if(a.taxaComissao){
      pct = parsePct(a.taxaComissao);
    }else if(a.comissao_percent){
      pct = parsePct(a.comissao_percent);
    }
    if(isFinite(pct) && pct>0 && pct<=100) return pct;

    const deepVal = findDeep(a,(k,v)=>{
      const kl = k.toLowerCase();
      if(!kl.includes('comiss')) return false;
      const p = parsePct(v);
      return isFinite(p) && p>0 && p<=100;
    });
    const deepPct = parsePct(deepVal);
    if(isFinite(deepPct) && deepPct>0 && deepPct<=100) return deepPct;

    return NaN;
  }

  /* ========= CONSTRU√á√ÉO DE NEG√ìCIOS (FECHOS) ========= */
  function buildNegocios(leads, angs){
    const list = [];

    // LEADS EM FECHO
    leads.forEach(l=>{
      if(l.estado !== 'Fecho') return;

      const valorNegocio = parseNum(l.fecho_negocio || l.valor || 0);

      const fechoObj = l.fecho || {};
      const dataCpcv = findDateWithToken([l, fechoObj], 'cpcv');
      const dataEscritura = findDateWithToken([l, fechoObj], 'escritura');
      const dataFecho = resolveDataFechoFromLead(l);

      const tipoNegocio = resolveTipoNegocioFromLead(l);
      const zona = resolveZonaFromLead(l);
      const tipologia = resolveTipologiaFromLead(l);
      const pctCom = resolvePctComissaoFromLead(l);
      const comValor = (isFinite(pctCom) && valorNegocio>0) ? (pctCom/100)*valorNegocio : 0;

      list.push({
        tipo: 'lead',
        id: l.id || '',
        consultor: l.consultor || '',
        cliente: l.nome || '',
        titulo: l.imovel ? (l.imovel + (l.tipologia? ' ' + l.tipologia : '')) : (l.imovel || 'Lead'),
        data: normalizeDateToISO(l.data || ''),
        dataFecho: dataFecho || normalizeDateToISO(l.data || ''),
        dataCpcv: dataCpcv || '',
        dataEscritura: dataEscritura || '',
        valor: valorNegocio,
        origem: (l.papel || '') ? ('Lead ‚Äî '+l.papel) : 'Lead',
        tipoNegocio: tipoNegocio,
        zona: zona,
        tipologia: tipologia,
        comPercent: pctCom,
        comValor: comValor
      });
    });

    // ANGARIA√á√ïES APROVADAS
    angs.forEach(a=>{
      if(a.estadoAng !== 'aprovado') return;

      const precoPedido = parseNum(a.precoPedido || 0);

      const fechoObj = a.fecho || {};
      const dataCpcv = findDateWithToken([a, fechoObj], 'cpcv');
      const dataEscritura = findDateWithToken([a, fechoObj], 'escritura');
      const dataFecho = resolveDataFechoFromAng(a);

      const titulo = a.isEmpreendimento && a.nomeEmp
        ? a.nomeEmp
        : (a.tituloImovel || 'Angaria√ß√£o');
      const tipoNegocio = resolveTipoNegocioFromAng(a);
      const zona = resolveZonaFromAng(a);
      const tipologia = resolveTipologiaFromAng(a);
      const pctCom = resolvePctComissaoFromAng(a);
      const comValor = (isFinite(pctCom) && precoPedido>0) ? (pctCom/100)*precoPedido : 0;

      list.push({
        tipo:'ang',
        id:a.id || '',
        consultor:a.consultor || '',
        cliente: a.isEmpreendimento ? (a.promotor || '') : (a.nomeProp || ''),
        titulo,
        data: normalizeDateToISO(a.dataAngariacao || ''),
        dataFecho: dataFecho || normalizeDateToISO(a.dataAngariacao || ''),
        dataCpcv: dataCpcv || '',
        dataEscritura: dataEscritura || '',
        valor:precoPedido,
        origem:a.isEmpreendimento ? 'Angaria√ß√£o ‚Äî Empreendimento' : 'Angaria√ß√£o',
        tipoNegocio: tipoNegocio,
        zona: zona,
        tipologia: tipologia,
        comPercent: pctCom,
        comValor: comValor
      });
    });

    list.sort((a,b)=>{
      const da = a.dataFecho || a.data || '';
      const db = b.dataFecho || b.data || '';
      return db.localeCompare(da);
    });
    return list;
  }

  /* ========= APLICA√á√ÉO DE FILTROS =========
     - Leads / Angaria√ß√µes: filtradas pelo per√≠odo com base na data de cria√ß√£o
     - Neg√≥cios (Fechos): filtrados pelo per√≠odo com base na dataFecho (CPCV / fecho)
  ========================================= */
  function applyFilters(){
    const cons = FILTERS.consultor;
    const de   = FILTERS.de;
    const ate  = FILTERS.ate;
    const showHidden = FILTERS.showHidden;
    const onlyHidden = FILTERS.onlyHidden;

    /* ---- Leads para √°rea de Leads (filtradas pela data de cria√ß√£o) ---- */
    let leads = allLeads.slice().filter(l=>l);
    if(cons){
      leads = leads.filter(l=> (l.consultor || '') === cons);
    }
    if(de){
      leads = leads.filter(l=> !l.data || l.data >= de);
    }
    if(ate){
      leads = leads.filter(l=> !l.data || l.data <= ate);
    }
    if(onlyHidden){
      leads = leads.filter(l=> l.visivel === false);
    }else if(!showHidden){
      leads = leads.filter(l=> l.visivel !== false);
    }

    /* ---- Angaria√ß√µes para √°rea de Angaria√ß√µes (data de angaria√ß√£o) ---- */
    let angs = allAngs.slice().filter(d=>d);
    if(cons){
      angs = angs.filter(d=> (d.consultor || '') === cons);
    }
    if(de){
      angs = angs.filter(d=> !d.dataAngariacao || d.dataAngariacao >= de);
    }
    if(ate){
      angs = angs.filter(d=> !d.dataAngariacao || d.dataAngariacao <= ate);
    }
    if(onlyHidden){
      angs = angs.filter(d=> d.visible === false);
    }else if(!showHidden){
      angs = angs.filter(d=> d.visible !== false);
    }

    /* ---- Neg√≥cios (Fechos) // base: todos, filtro por CPCV/Fecho ---- */
    let baseLeads = allLeads.slice().filter(l=>l);
    let baseAngs  = allAngs.slice().filter(a=>a);

    if(cons){
      baseLeads = baseLeads.filter(l=> (l.consultor || '') === cons);
      baseAngs  = baseAngs.filter(a=> (a.consultor || '') === cons);
    }
    if(onlyHidden){
      baseLeads = baseLeads.filter(l=> l.visivel === false);
      baseAngs  = baseAngs.filter(a=> a.visible === false);
    }else if(!showHidden){
      baseLeads = baseLeads.filter(l=> l.visivel !== false);
      baseAngs  = baseAngs.filter(a=> a.visible !== false);
    }

    const allNegocios = buildNegocios(baseLeads, baseAngs);
    const negocios = allNegocios.filter(n=>{
      const dFecho = n.dataFecho || n.data || '';
      if(de && dFecho && dFecho < de) return false;
      if(ate && dFecho && dFecho > ate) return false;
      return true;
    });

    /* ---- Tarefas (mant√©m l√≥gica anterior) ---- */
    let tasks = allTasks.slice().filter(t=>t);
    if(cons){
      tasks = tasks.filter(t=> (t.responsavel || '') === cons);
    }
    if(de){
      tasks = tasks.filter(t=> !t.dataLimite || t.dataLimite >= de);
    }
    if(ate){
      tasks = tasks.filter(t=> !t.dataLimite || t.dataLimite <= ate);
    }

    return {leads, angs, negocios, tasks};
  }

  /* ========= KPIs GLOBAIS ========= */
  function renderGlobalKpis(leads, angs, negocios, tasks){
    kpiGrid.innerHTML = '';

    const leadsAtivas = leads.length;
    const angsAtivas  = angs.length;

    const negociosCount = negocios.length;
    const negociosVolume = negocios.reduce((acc,n)=>acc+(n.valor||0),0);

    const tarefasAbertas = tasks.filter(t=> t.estado!=='concluida' && t.estado!=='cancelada').length;
    const proxTarefa = tasks
      .filter(t=>t.dataLimite && t.estado!=='concluida' && t.estado!=='cancelada')
      .sort((a,b)=>(a.dataLimite||'').localeCompare(b.dataLimite||''))[0];

    const kpis = [
      {
        label:'Leads ativas',
        value: formatInt(leadsAtivas),
        sub:'Leads ap√≥s filtros (respeitando visibilidade).'
      },
      {
        label:'Angaria√ß√µes ativas',
        value: formatInt(angsAtivas),
        sub:'Angaria√ß√µes ap√≥s filtros (respeitando visibilidade).'
      },
      {
        label:'Neg√≥cios (Fechos/Vendas)',
        value: formatInt(negociosCount),
        sub:'Leads em Fecho + Angaria√ß√µes aprovadas (por CPCV/fecho).',
        badge: negociosVolume ? 'Volume: ' + formatMoney(negociosVolume) : ''
      },
      {
        label:'Tarefas em aberto',
        value: formatInt(tarefasAbertas),
        sub: proxTarefa ? ('Pr√≥xima data: ' + proxTarefa.dataLimite) : 'Sem tarefas com data limite nos filtros.'
      }
    ];

    kpis.forEach(k=>{
      const card = document.createElement('div');
      card.className = 'kpi-card';

      const lab = document.createElement('div');
      lab.className = 'kpi-label';
      lab.textContent = k.label;
      const val = document.createElement('div');
      val.className = 'kpi-value';
      val.textContent = k.value;
      const sub = document.createElement('div');
      sub.className = 'kpi-sub';
      sub.textContent = k.sub || '';

      card.appendChild(lab);
      card.appendChild(val);
      card.appendChild(sub);

      if(k.badge){
        const b = document.createElement('div');
        b.className = 'kpi-badge';
        b.textContent = k.badge;
        card.appendChild(b);
      }

      kpiGrid.appendChild(card);
    });
  }

  /* ========= RENDER DE GR√ÅFICOS GEN√âRICO ========= */
  function renderBarChart(container, opts){
    const {title, subtitle, items, formatter, responsive} = opts;
    if(!items || !items.length){
      const card = document.createElement('div');
      card.className = 'chart-card' + (responsive ? ' responsive':'');
      const header = document.createElement('div');
      header.className = 'chart-header';
      const t = document.createElement('div');
      t.className = 'chart-title';
      t.textContent = title;
      const s = document.createElement('div');
      s.className = 'chart-subtitle';
      s.textContent = subtitle || '';
      header.appendChild(t);
      header.appendChild(s);
      const empty = document.createElement('div');
      empty.className = 'chart-empty';
      empty.textContent = 'Sem dados suficientes para este gr√°fico.';
      card.appendChild(header);
      card.appendChild(empty);
      container.appendChild(card);
      return;
    }

    const max = Math.max(...items.map(it=>it.value || 0)) || 1;

    const card = document.createElement('div');
    card.className = 'chart-card' + (responsive ? ' responsive':'');
    const header = document.createElement('div');
    header.className = 'chart-header';
    const t = document.createElement('div');
    t.className = 'chart-title';
    t.textContent = title;
    const s = document.createElement('div');
    s.className = 'chart-subtitle';
    s.textContent = subtitle || '';
    header.appendChild(t);
    header.appendChild(s);
    card.appendChild(header);

    const rows = document.createElement('div');
    rows.className = 'chart-rows';

    items.forEach(it=>{
      const row = document.createElement('div');
      row.className = 'chart-row';

      const lab = document.createElement('div');
      lab.className = 'chart-label';
      lab.textContent = it.label;

      const barWrap = document.createElement('div');
      barWrap.className = 'chart-bar-wrap';
      const bar = document.createElement('div');
      bar.className = 'chart-bar';
      const pct = max>0 ? (it.value/max*100) : 0;
      bar.style.width = pct.toFixed(1) + '%';
      barWrap.appendChild(bar);

      const val = document.createElement('div');
      val.className = 'chart-value';
      val.textContent = formatter ? formatter(it.value) : it.value;

      row.appendChild(lab);
      row.appendChild(barWrap);
      row.appendChild(val);
      rows.appendChild(row);
    });

    card.appendChild(rows);
    container.appendChild(card);
  }

  /* ========= √ÅREA LEADS ========= */
  function renderLeadsArea(leads){
    leadsCharts.innerHTML = '';
    const hasData = leads.length>0;
    leadsEmpty.style.display = hasData ? 'none':'block';
    if(!hasData) return;

    const visibles = leads;

    const estadosOrden = ["Novo","Em Contacto","Qualificado","Visita","Proposta","Fecho","Perdido"];
    const byEstado = groupCount(visibles, l=>l.estado && estadosOrden.includes(l.estado) ? l.estado : '');
    const arrEstados = estadosOrden.map(e=>({label:e, value: byEstado[e] || 0}));
    renderBarChart(leadsCharts,{
      title:'Leads por Estado',
      subtitle:'Distribui√ß√£o atual do funil.',
      items:arrEstados,
      formatter:formatInt,
      responsive:false
    });

    const tipoMap = groupCount(visibles, l=> (l.tipo_negocio || l.tipoNegocio || '').trim());
    const tipoArr = mapToSortedArray(tipoMap);
    renderBarChart(leadsCharts,{
      title:'Tipo de Neg√≥cio (Leads)',
      subtitle:'Venda ¬∑ Compra ¬∑ Arrendamento ¬∑ Permuta (contagem).',
      items:tipoArr,
      formatter:formatInt,
      responsive:false
    });

    const classMap = groupCount(visibles, l=>l.classificacao || '');
    const classOrder = ['1','2','3','4','5'];
    const classArr = classOrder.map(c=>({label:'N√≠vel '+c, value:classMap[c] || 0}));
    renderBarChart(leadsCharts,{
      title:'Classifica√ß√£o (1‚Äì5)',
      subtitle:'Temperatura das leads.',
      items:classArr,
      formatter:formatInt,
      responsive:false
    });

    const perfilMap = groupCount(visibles, l=>l.perfil || '');
    const perfilArr = mapToSortedArray(perfilMap);
    renderBarChart(leadsCharts,{
      title:'Perfil do Cliente',
      subtitle:'Investidor vs Cliente final.',
      items:perfilArr,
      formatter:formatInt,
      responsive:true
    });

    const tipoLogMap = groupCount(visibles, l=>l.tipologia || '');
    const tipArr = topN(mapToSortedArray(tipoLogMap), 6);
    renderBarChart(leadsCharts,{
      title:'Tipologias mais procuradas',
      subtitle:'Top tipologias nas leads.',
      items:tipArr,
      formatter:formatInt,
      responsive:true
    });

    const imovelMap = groupCount(visibles, l=>l.imovel || '');
    const imovelArr = topN(mapToSortedArray(imovelMap), 6);
    renderBarChart(leadsCharts,{
      title:'Tipo de Im√≥vel',
      subtitle:'Moradia ¬∑ Apartamento ¬∑ Loja ¬∑ etc.',
      items:imovelArr,
      formatter:formatInt,
      responsive:true
    });

    const zonaMap = groupCount(visibles, l=>l.zona || '');
    const zonaArr = topN(mapToSortedArray(zonaMap), 6);
    renderBarChart(leadsCharts,{
      title:'Zonas preferenciais (Top)',
      subtitle:'Principais zonas pedidas nas leads.',
      items:zonaArr,
      formatter:formatInt,
      responsive:true
    });
  }

  /* ========= √ÅREA ANGARIA√á√ïES ========= */
  function renderAngsArea(angs, leads){
    angsCharts.innerHTML = '';
    const hasData = angs.length>0;
    angsEmpty.style.display = hasData ? 'none':'block';
    if(!hasData && (!leads || !leads.length)) return;

    const vis = angs;

    if(hasData){
      const estadosOrder = ['novo','negociacao','aprovado','perdido'];
      const labelEstado = {novo:'Novo',negociacao:'Negocia√ß√£o',aprovado:'Aprovado',perdido:'Perdido'};
      const estMap = groupCount(vis, a=>a.estadoAng || '');
      const estArr = estadosOrder.map(k=>({label:labelEstado[k], value:estMap[k] || 0}));
      renderBarChart(angsCharts,{
        title:'Angaria√ß√µes por Estado',
        subtitle:'Pipeline de produto.',
        items:estArr,
        formatter:formatInt,
        responsive:false
      });

      const exclMap = {
        'Exclusivo': vis.filter(a=>a.exclusivo).length,
        'N√£o exclusivo': vis.filter(a=>a.naoExclusivo).length
      };
      const exclArr = mapToSortedArray(exclMap);
      renderBarChart(angsCharts,{
        title:'Exclusivo vs N√£o exclusivo',
        subtitle:'Posicionamento dos im√≥veis.',
        items:exclArr,
        formatter:formatInt,
        responsive:false
      });

      const empMap = {
        'Empreendimento': vis.filter(a=>a.isEmpreendimento).length,
        'Unidade isolada': vis.filter(a=>!a.isEmpreendimento).length
      };
      const empArr = mapToSortedArray(empMap);
      renderBarChart(angsCharts,{
        title:'Empreendimentos',
        subtitle:'Carteira de empreendimentos vs unidades isoladas.',
        items:empArr,
        formatter:formatInt,
        responsive:false
      });

      const natMap = groupCount(vis, a=>a.natureza || '');
      const natArr = topN(mapToSortedArray(natMap), 6);
      renderBarChart(angsCharts,{
        title:'Natureza do Im√≥vel',
        subtitle:'Apartamento, Moradia, Loja, etc.',
        items:natArr,
        formatter:formatInt,
        responsive:true
      });

      const estImovelMap = groupCount(vis, a=>a.estadoImovel || '');
      const estImovelArr = topN(mapToSortedArray(estImovelMap), 6);
      renderBarChart(angsCharts,{
        title:'Estado do Im√≥vel',
        subtitle:'Novo, usado, em constru√ß√£o...',
        items:estImovelArr,
        formatter:formatInt,
        responsive:true
      });

      const comBuckets = {
        '<=3%':0,
        '3‚Äì5%':0,
        '>=5%':0
      };
      let somaValor = 0;
      let countValor = 0;
      vis.forEach(a=>{
        const preco = parseNum(a.precoPedido || 0);
        if(preco>0){ somaValor += preco; countValor++; }

        let pct = resolvePctComissaoFromAng(a);
        if(!isFinite(pct)) return;
        if(pct <= 3) comBuckets['<=3%']++;
        else if(pct <5) comBuckets['3‚Äì5%']++;
        else comBuckets['>=5%']++;
      });
      const comArr = mapToSortedArray(comBuckets);
      const valorMedio = countValor ? somaValor/countValor : 0;
      renderBarChart(angsCharts,{
        title:'Comiss√£o (intervalos)',
        subtitle:'Valor m√©dio de carteira: ' + formatMoney(valorMedio),
        items:comArr,
        formatter:formatInt,
        responsive:true
      });
    }

    const mixMap = {};
    const addTipo = (raw)=>{
      const t = (raw || '').trim();
      if(!t) return;
      mixMap[t] = (mixMap[t] || 0) + 1;
    };
    (leads || []).forEach(l=> addTipo(resolveTipoNegocioFromLead(l)));
    (angs  || []).forEach(a=> addTipo(resolveTipoNegocioFromAng(a)));

    const totalMix = Object.values(mixMap).reduce((a,b)=>a+b,0);
    const mixArr = Object.entries(mixMap)
      .filter(([,v])=>v>0)
      .map(([label,value])=>({
        label,
        value: totalMix ? (value/totalMix*100) : 0
      }))
      .sort((a,b)=>b.value-a.value);

    if(mixArr.length){
      renderBarChart(angsCharts,{
        title:'Mix de Neg√≥cio (Leads + Angaria√ß√µes)',
        subtitle:'Percentagem de vendas, arrendamentos, permutas, etc.',
        items:mixArr,
        formatter:formatPct,
        responsive:true
      });
    }
  }

  /* ========= √ÅREA FECHOS & VENDAS ========= */
  function renderFechosArea(negocios){
    fechosCharts.innerHTML = '';
    const hasData = negocios.length>0;
    fechosEmpty.style.display = hasData ? 'none':'block';
    if(!hasData) return;

    // Volume mensal (por data de fecho/CPCV)
    const mapaMensal = {};
    negocios.forEach(n=>{
      const dataBase = n.dataFecho || n.data;
      if(!dataBase) return;
      const d = new Date(dataBase);
      if(isNaN(d.getTime())) return;
      const key = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0');
      mapaMensal[key] = (mapaMensal[key] || 0) + (n.valor || 0);
    });
    const arrMensal = Object.entries(mapaMensal)
      .sort((a,b)=>a[0].localeCompare(b[0]))
      .map(([key,val])=>{
        const [y,m] = key.split('-');
        return {label: m+'/'+y.slice(-2), value:val};
      });

    // üîπ Total global do volume de neg√≥cios no per√≠odo filtrado
    const totalVolume = negocios.reduce((acc,n)=>acc+(n.valor || 0),0);

    renderBarChart(fechosCharts,{
      title:'Volume Mensal de Neg√≥cios',
      subtitle:'Baseado na data de CPCV / fecho ¬∑ Total: ' + formatMoney(totalVolume),
      items:arrMensal,
      formatter:formatMoney,
      responsive:false
    });

    const consMap = groupCount(negocios, n=>n.consultor || '(sem consultor)');
    const consArr = mapToSortedArray(consMap);
    renderBarChart(fechosCharts,{
      title:'Neg√≥cios por Consultor',
      subtitle:'N√∫mero de neg√≥cios fechados por consultor.',
      items:consArr,
      formatter:formatInt,
      responsive:false
    });

    const volTipoMap = {};
    negocios.forEach(n=>{
      const label = n.tipo === 'lead' ? 'Leads ¬∑ Fecho' : 'Angaria√ß√µes aprovadas';
      volTipoMap[label] = (volTipoMap[label] || 0) + (n.valor || 0);
    });
    const volTipoArr = mapToSortedArray(volTipoMap);
    renderBarChart(fechosCharts,{
      title:'Origem dos Neg√≥cios',
      subtitle:'Peso de Leads vs Angaria√ß√µes nos neg√≥cios fechados.',
      items:volTipoArr,
      formatter:formatMoney,
      responsive:true
    });

    const comNegocios = negocios.filter(n=>isFinite(n.comPercent) && n.comPercent>0 && n.valor>0);

    const comMensalMap = {};
    comNegocios.forEach(n=>{
      const dataBase = n.dataFecho || n.data;
      if(!dataBase) return;
      const d = new Date(dataBase);
      if(isNaN(d.getTime())) return;
      const key = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0');
      const comVal = n.comValor || (n.valor * (n.comPercent/100));
      comMensalMap[key] = (comMensalMap[key] || 0) + comVal;
    });
    const comMensalArr = Object.entries(comMensalMap)
      .sort((a,b)=>a[0].localeCompare(b[0]))
      .map(([key,val])=>{
        const [y,m] = key.split('-');
        return {label: m+'/'+y.slice(-2), value:val};
      });

    // üîπ Total global de comiss√µes no per√≠odo filtrado
    const totalComissoes = comNegocios.reduce((acc,n)=>{
      const comVal = n.comValor || (n.valor * (n.comPercent/100));
      return acc + (comVal || 0);
    },0);

    renderBarChart(fechosCharts,{
      title:'Comiss√µes da Ag√™ncia (Mensal)',
      subtitle:'Sobre neg√≥cios fechados no per√≠odo filtrado (inclui arrendamentos) ¬∑ Total: ' + formatMoney(totalComissoes),
      items:comMensalArr,
      formatter:formatMoney,
      responsive:false
    });

    const comPorTipo = {};
    comNegocios.forEach(n=>{
      const raw = (n.tipoNegocio || 'Outro').toLowerCase();
      let bucket = 'Outro';
      if(raw.includes('arrend')) bucket = 'Arrendamento';
      else if(raw.includes('venda')) bucket = 'Venda';
      else if(raw.includes('compra')) bucket = 'Compra';

      if(!comPorTipo[bucket]){
        comPorTipo[bucket] = {
          porConsultor:{},
          somaPct:0,
          countPct:0
        };
      }
      const info = comPorTipo[bucket];

      const cons = n.consultor || '(sem consultor)';
      const pctRounded = Math.round(n.comPercent * 10) / 10;

      if(!info.porConsultor[cons]){
        info.porConsultor[cons] = {freq:{}};
      }
      info.porConsultor[cons].freq[pctRounded] =
        (info.porConsultor[cons].freq[pctRounded] || 0) + 1;

      info.somaPct  += n.comPercent;
      info.countPct += 1;
    });

    const ordemTiposBase = ['Compra','Venda','Arrendamento','Outro'];
    const tiposExistentes = Object.keys(comPorTipo);
    const ordemTipos = ordemTiposBase
      .filter(t=>tiposExistentes.includes(t))
      .concat(tiposExistentes.filter(t=>!ordemTiposBase.includes(t)));

    ordemTipos.forEach(tipo=>{
      const info = comPorTipo[tipo];
      if(!info) return;

      const arrConsultores = [];

      Object.entries(info.porConsultor).forEach(([cons,dataCons])=>{
        let bestPct = null;
        let bestCount = -1;
        Object.entries(dataCons.freq).forEach(([pctStr,count])=>{
          const pct = parseFloat(pctStr);
          if(count > bestCount || (count === bestCount && pct > bestPct)){
            bestCount = count;
            bestPct = pct;
          }
        });
        if(isFinite(bestPct)){
          arrConsultores.push({label:cons, value:bestPct});
        }
      });

      if(!arrConsultores.length) return;

      arrConsultores.sort((a,b)=>b.value-a.value);
      const mediaPct = info.countPct ? (info.somaPct / info.countPct) : NaN;

      renderBarChart(fechosCharts,{
        title:'Ranking de Comiss√µes por Consultor ‚Äî ' + tipo,
        subtitle:'Comiss√£o mais usada em neg√≥cios de ' + tipo.toLowerCase() +
                 ' ¬∑ M√©dia equipa: ' + formatPct(mediaPct),
        items:arrConsultores,
        formatter:formatPct,
        responsive:false
      });
    });

    const comTipoPctMap = {};
    comNegocios.forEach(n=>{
      const tipo = (n.tipoNegocio || 'Outro').trim() || 'Outro';
      if(!isFinite(n.comPercent)) return;
      if(!comTipoPctMap[tipo]){
        comTipoPctMap[tipo] = {sumPct:0,count:0};
      }
      comTipoPctMap[tipo].sumPct += n.comPercent;
      comTipoPctMap[tipo].count  += 1;
    });
    const comTipoPctArr = Object.entries(comTipoPctMap)
      .map(([label,obj])=>({label,value: obj.count ? obj.sumPct/obj.count : 0}))
      .sort((a,b)=>b.value-a.value);
    renderBarChart(fechosCharts,{
      title:'M√©dia % Comiss√£o por Tipo de Neg√≥cio',
      subtitle:'Compara√ß√£o entre vendas, arrendamentos, etc.',
      items:comTipoPctArr,
      formatter:formatPct,
      responsive:true
    });

    const mapTipTicket = {};
    negocios.forEach(n=>{
      const tipoRaw = (n.tipoNegocio || '').toLowerCase();
      const isCompraVenda =
        tipoRaw.includes('compra') ||
        tipoRaw.includes('venda');

      if(!isCompraVenda) return;
      if(!n.valor) return;

      const tip = (n.tipologia || 'Sem tipologia').trim() || 'Sem tipologia';
      if(!mapTipTicket[tip]){
        mapTipTicket[tip] = {sum:0,count:0};
      }
      mapTipTicket[tip].sum  += n.valor;
      mapTipTicket[tip].count += 1;
    });
    const tipTicketArr = Object.entries(mapTipTicket)
      .map(([label,obj])=>({label,value: obj.count ? obj.sum/obj.count : 0}))
      .sort((a,b)=>b.value-a.value);
    const tipTicketTop = topN(tipTicketArr,6);
    renderBarChart(fechosCharts,{
      title:'Ticket M√©dio por Tipologia',
      subtitle:'S√≥ neg√≥cios de compra/venda.',
      items:tipTicketTop,
      formatter:formatMoney,
      responsive:true
    });

    const mapZonaTicket = {};
    negocios.forEach(n=>{
      const zona = (n.zona || 'Sem zona').trim() || 'Sem zona';
      if(!n.valor) return;
      if(!mapZonaTicket[zona]){
        mapZonaTicket[zona] = {sum:0,count:0};
      }
      mapZonaTicket[zona].sum  += n.valor;
      mapZonaTicket[zona].count += 1;
    });
    const zonaTicketArr = Object.entries(mapZonaTicket)
      .map(([label,obj])=>({label,value: obj.count ? obj.sum/obj.count : 0}))
      .sort((a,b)=>b.value-a.value);
    const zonaTicketTop = topN(zonaTicketArr,6);
    renderBarChart(fechosCharts,{
      title:'Ticket M√©dio por Zona (Top)',
      subtitle:'Valor m√©dio de fecho por zona/geografia.',
      items:zonaTicketTop,
      formatter:formatMoney,
      responsive:true
    });
  }

  /* ========= √ÅREA TAREFAS ========= */
  function renderTarefasArea(tasks){
    tarefasCharts.innerHTML = '';
    const hasData = tasks.length>0;
    tarefasEmpty.style.display = hasData ? 'none':'block';
    if(!hasData) return;

    const estOrder = ['por_fazer','em_curso','concluida','adiada','cancelada'];
    const estLabel = {
      por_fazer:'Por fazer',
      em_curso:'Em curso',
      concluida:'Conclu√≠da',
      adiada:'Adiada',
      cancelada:'Cancelada'
    };
    const estMap = groupCount(tasks, t=>t.estado || '');
    const estArr = estOrder.map(k=>({label:estLabel[k], value:estMap[k] || 0}));
    renderBarChart(tarefasCharts,{
      title:'Tarefas por Estado',
      subtitle:'Carga de trabalho e execu√ß√£o.',
      items:estArr,
      formatter:formatInt,
      responsive:false
    });

    const prioOrder = ['baixa','normal','alta','critica'];
    const prioLabel = {
      baixa:'Baixa',
      normal:'Normal',
      alta:'Alta',
      critica:'Cr√≠tica'
    };
    const prioMap = groupCount(tasks, t=>t.prioridade || '');
    const prioArr = prioOrder.map(k=>({label:prioLabel[k], value:prioMap[k] || 0}));
    renderBarChart(tarefasCharts,{
      title:'Prioridade das Tarefas',
      subtitle:'Em que n√≠vel est√° o foco.',
      items:prioArr,
      formatter:formatInt,
      responsive:false
    });

    const tipoLabel = {
      chamada:'Chamada',
      email:'Email',
      visita:'Visita',
      reuniao:'Reuni√£o',
      followup:'Follow-up',
      outro:'Outro'
    };
    const tipoMap = groupCount(tasks, t=>t.tipoTarefa || '');
    const tipoArrRaw = Object.entries(tipoMap)
      .map(([k,v])=>({label:tipoLabel[k] || k, value:v}))
      .sort((a,b)=>b.value-a.value);
    const tipoArr = topN(tipoArrRaw, 6);
    renderBarChart(tarefasCharts,{
      title:'Tipo de Tarefa',
      subtitle:'Distribui√ß√£o por tipo de a√ß√£o.',
      items:tipoArr,
      formatter:formatInt,
      responsive:true
    });

    const respMap = groupCount(tasks, t=>t.responsavel || '(sem respons√°vel)');
    const respArr = mapToSortedArray(respMap);
    renderBarChart(tarefasCharts,{
      title:'Tarefas por Respons√°vel',
      subtitle:'Carga de tarefas por consultor.',
      items:respArr,
      formatter:formatInt,
      responsive:true
    });
  }

  /* ========= CONTEXTO ========= */
  function updateContextLabel(){
    const cons = FILTERS.consultor;
    const de   = FILTERS.de;
    const ate  = FILTERS.ate;
    const parts = [];
    if(cons) parts.push('Consultor: ' + cons);
    if(de || ate){
      parts.push('Per√≠odo: ' + (de || '‚Ä¶') + ' a ' + (ate || '‚Ä¶'));
    }
    if(FILTERS.onlyHidden){
      parts.push('S√≥ invis√≠veis');
    }else if(FILTERS.showHidden){
      parts.push('Inclui invis√≠veis');
    }
    contextLabel.textContent = parts.length ? parts.join(' | ') : 'Sem filtros ‚Äî vis√£o global';
  }

  /* ========= TABS ========= */
  areaTabs.forEach(btn=>{
    btn.addEventListener('click',()=>{
      const area = btn.dataset.area;
      areaTabs.forEach(b=>b.classList.toggle('active', b===btn));
      Object.keys(areaPanels).forEach(key=>{
        areaPanels[key].classList.toggle('active', key===area);
      });
    });
  });

  /* ========= CICLO PRINCIPAL ========= */
  function refresh(){
    loadLeads();
    loadAngs();
    loadTasks();
    buildConsultorOptions();
    syncFiltersToUI();

    const {leads, angs, negocios, tasks} = applyFilters();

    renderGlobalKpis(leads, angs, negocios, tasks);
    renderLeadsArea(leads);
    renderAngsArea(angs, leads);
    renderFechosArea(negocios);
    renderTarefasArea(tasks);
    updateContextLabel();
  }

  function applyFiltersFromUI(){
    FILTERS.consultor  = filterConsultor.value || '';
    FILTERS.de         = filterDataDe.value || '';
    FILTERS.ate        = filterDataAte.value || '';
    FILTERS.showHidden = filterShowHidden.checked;
    FILTERS.onlyHidden = filterOnlyHidden.checked;

    if(FILTERS.onlyHidden){
      FILTERS.showHidden = true;
      filterShowHidden.checked = true;
    }

    saveFiltersState();
    refresh();
  }

  function clearFilters(){
    filterConsultor.value       = '';
    filterDataDe.value          = '';
    filterDataAte.value         = '';
    filterShowHidden.checked    = false;
    filterOnlyHidden.checked    = false;

    FILTERS.consultor  = '';
    FILTERS.de         = '';
    FILTERS.ate        = '';
    FILTERS.showHidden = false;
    FILTERS.onlyHidden = false;

    saveFiltersState();
    refresh();
  }

  applyFiltersBtn.addEventListener('click', applyFiltersFromUI);
  clearFiltersBtn.addEventListener('click', clearFilters);
  reloadBtn.addEventListener('click', refresh);

  loadFiltersState();
  refresh();
})();
</script>
</body>
</html>
