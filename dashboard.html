<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <title>Garvetur Porto Pro ‚Äî Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #050608;
      --bg-elevated: #101217;
      --panel: #141720;
      --gold: #A38B63;
      --gold-soft: rgba(163,139,99,0.35);
      --gold-strong: rgba(163,139,99,0.85);
      --text: #FFFFFF;
      --muted: #9AA0A6;
      --danger: #F97373;
      --success: #4ADE80;
      --border-subtle: rgba(255,255,255,0.06);
      --shadow-soft: 0 20px 40px rgba(0,0,0,0.35);
      --radius-lg: 18px;
      --radius-xl: 22px;
    }

    * { box-sizing: border-box; }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #151826 0, #050608 55%, #020308 100%);
      color: var(--text);
    }

    body {
      display: flex;
      flex-direction: column;
    }

    /* TOP BAR */
    header {
      height: 64px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 18px;
      border-bottom: 1px solid rgba(163,139,99,0.45);
      background: radial-gradient(circle at top left, #181b26 0, #050608 65%);
      position: sticky;
      top: 0;
      z-index: 20;
      backdrop-filter: blur(16px);
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand-icon {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      border: 1px solid rgba(163,139,99,0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--gold);
      box-shadow: 0 0 18px rgba(163,139,99,0.45);
      background: radial-gradient(circle at 30% 0, #373020 0, #0e0e0e 65%);
    }

    .brand h1 {
      margin: 0;
      font-size: 17px;
      font-weight: 600;
      letter-spacing: 0.03em;
      color: var(--gold);
    }

    .brand-sub {
      font-size: 11px;
      color: var(--muted);
      margin-top: 2px;
    }

    .nav-tabs {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-left: 22px;
    }

    .nav-tab {
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid transparent;
      color: var(--muted);
      text-decoration: none;
      cursor: pointer;
      transition: 0.15s ease;
      background: transparent;
    }

    .nav-tab:hover {
      border-color: var(--gold-soft);
      color: #e3e3e3;
      background: rgba(11,14,22,0.8);
    }

    .nav-tab.active {
      border-color: var(--gold);
      background: radial-gradient(circle at top, rgba(163,139,99,0.28), rgba(9,9,10,0.9));
      color: #f7f3eb;
    }

    .top-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn {
      border-radius: 999px;
      border: 1px solid rgba(163,139,99,0.5);
      padding: 7px 11px;
      font-size: 12px;
      cursor: pointer;
      background: transparent;
      color: var(--text);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: 0.15s ease;
    }

    .btn:hover {
      border-color: var(--gold);
      background: rgba(163,139,99,0.08);
    }

    .btn.danger {
      border-color: rgba(248,113,113,0.7);
      color: #fecaca;
    }

    .btn.danger:hover {
      background: rgba(248,113,113,0.08);
    }

    .chip-soft {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(0,0,0,0.4);
      border: 1px solid rgba(163,139,99,0.4);
      color: var(--muted);
    }

    main {
      flex: 1;
      display: flex;
      padding: 14px 18px 18px;
      gap: 14px;
    }

    .col-main {
      flex: 3;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .col-side {
      flex: 1.4;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .panel {
      background: radial-gradient(circle at top left, #1b1f2b 0, #090b10 45%, #06070c 100%);
      border-radius: var(--radius-xl);
      border: 1px solid rgba(255,255,255,0.06);
      box-shadow: var(--shadow-soft);
      padding: 14px 14px 12px;
      position: relative;
      overflow: hidden;
    }

    .panel::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top left, rgba(163,139,99,0.15), transparent 50%);
      opacity: 0.6;
      pointer-events: none;
    }

    .panel-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      margin-bottom: 8px;
      position: relative;
      z-index: 1;
    }

    .panel-title {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--muted);
    }

    .panel-sub {
      font-size: 11px;
      color: var(--muted);
    }

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
      position: relative;
      z-index: 1;
    }

    .kpi-card {
      background: linear-gradient(to bottom right, rgba(5,6,11,0.95), rgba(2,3,6,0.98));
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-subtle);
      padding: 10px;
      position: relative;
      overflow: hidden;
    }

    .kpi-label {
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: 0.09em;
    }

    .kpi-value {
      font-size: 20px;
      font-weight: 600;
      color: #f5f5f5;
      display: flex;
      align-items: baseline;
      gap: 6px;
    }

    .kpi-suffix {
      font-size: 11px;
      color: var(--muted);
    }

    .kpi-trend {
      font-size: 11px;
      margin-top: 4px;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .kpi-trend .up { color: var(--success); }
    .kpi-trend .down { color: var(--danger); }

    .divider {
      height: 1px;
      border-radius: 999px;
      background: linear-gradient(to right, rgba(163,139,99,0.5), transparent);
      margin: 8px 0 10px;
      opacity: 0.8;
    }

    .list {
      position: relative;
      z-index: 1;
      font-size: 12px;
    }

    .list-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 4px;
      border-bottom: 1px dashed rgba(255,255,255,0.08);
    }

    .list-row:last-child {
      border-bottom: none;
    }

    .pill {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.07);
      color: #e1e1e1;
      background: rgba(3,3,5,0.9);
    }

    .pill.soft {
      border-color: rgba(163,139,99,0.5);
      background: rgba(163,139,99,0.13);
      color: #f5f0e6;
    }

    .pill.danger {
      border-color: rgba(248,113,113,0.7);
      background: rgba(248,113,113,0.08);
      color: #fecaca;
    }

    .pill.success {
      border-color: rgba(74,222,128,0.7);
      background: rgba(34,197,94,0.1);
      color: #bbf7d0;
    }

    .muted {
      color: var(--muted);
    }

    .small {
      font-size: 11px;
    }

    .footer-note {
      margin-top: 6px;
      font-size: 11px;
      color: var(--muted);
    }

    .tag-cloud {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 2px;
    }

    .tag {
      font-size: 11px;
      padding: 3px 7px;
      border-radius: 999px;
      border: 1px solid rgba(163,139,99,0.4);
      background: rgba(7,8,12,0.95);
      color: #ddd;
    }

    @media (max-width: 1100px) {
      main {
        flex-direction: column;
      }
      .col-main, .col-side {
        flex: none;
      }
      .kpi-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 720px) {
      header {
        flex-wrap: wrap;
        height: auto;
        gap: 10px;
      }
      .nav-tabs {
        margin-left: 0;
        flex-wrap: wrap;
      }
      main {
        padding: 10px;
      }
      .panel {
        padding: 10px;
      }
      .kpi-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }
  </style>
</head>
<body>
<header>
  <div style="display:flex;align-items:center;gap:18px;">
    <div class="brand">
      <div class="brand-icon">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <circle cx="12" cy="12" r="9" stroke-width="1.5" />
          <path d="M8 12l2.5 2.5L16 9" stroke-width="1.8" />
        </svg>
      </div>
      <div>
        <h1>Garvetur Porto Pro</h1>
        <div class="brand-sub">Dashboard de Leads ¬∑ Angaria√ß√µes ¬∑ Mapa</div>
      </div>
    </div>

    <nav class="nav-tabs">
      <a href="index.html" class="nav-tab">Mapa</a>
      <a href="kanban.html" class="nav-tab">Leads</a>
      <a href="angariacoes.html" class="nav-tab">Angaria√ß√µes</a>
      <button class="nav-tab active" type="button">Dashboard</button>
    </nav>
  </div>

  <div class="top-actions">
    <span id="lastSync" class="chip-soft">√öltima leitura: ‚Äî</span>
    <button id="refreshBtn" class="btn" type="button">
      ‚ü≥ Atualizar m√©tricas
    </button>
    <button id="resetBtn" class="btn danger" type="button">
      üóëÔ∏è Reiniciar dados locais (leads/angaria√ß√µes)
    </button>
  </div>
</header>

<main>
  <section class="col-main">
    <!-- KPIs principais -->
    <div class="panel">
      <div class="panel-header">
        <div>
          <div class="panel-title">Vis√£o geral</div>
          <div class="panel-sub">Resumo das leads e angaria√ß√µes registadas no navegador</div>
        </div>
      </div>

      <div class="kpi-grid">
        <div class="kpi-card">
          <div class="kpi-label">Leads ativas</div>
          <div class="kpi-value">
            <span id="kpiLeadsTotal">0</span>
          </div>
          <div class="kpi-trend">
            <span id="kpiLeadsResumo" class="muted">‚Äî</span>
          </div>
        </div>

        <div class="kpi-card">
          <div class="kpi-label">Angaria√ß√µes ativas</div>
          <div class="kpi-value">
            <span id="kpiAngTotal">0</span>
          </div>
          <div class="kpi-trend">
            <span id="kpiAngResumo" class="muted">‚Äî</span>
          </div>
        </div>

        <div class="kpi-card">
          <div class="kpi-label">Leads em fecho</div>
          <div class="kpi-value">
            <span id="kpiLeadsFecho">0</span>
            <span class="kpi-suffix" id="kpiLeadsFechoPct">0%</span>
          </div>
          <div class="kpi-trend">
            <span id="kpiLeadsFechoResumo" class="muted">‚Äî</span>
          </div>
        </div>

        <div class="kpi-card">
          <div class="kpi-label">Angaria√ß√µes Exclusivas</div>
          <div class="kpi-value">
            <span id="kpiAngExclusivas">0</span>
            <span class="kpi-suffix" id="kpiAngExclusivasPct">0%</span>
          </div>
          <div class="kpi-trend">
            <span id="kpiAngExclusivasResumo" class="muted">‚Äî</span>
          </div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="list">
        <div class="list-row">
          <div>
            <div class="small muted">Distribui√ß√£o pipeline de leads</div>
            <div id="leadsPipelineText" class="small">Sem leads registadas.</div>
          </div>
        </div>
        <div class="list-row">
          <div>
            <div class="small muted">Distribui√ß√£o de estados de angaria√ß√£o</div>
            <div id="angEstadosText" class="small">Sem angaria√ß√µes registadas.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Ranking consultores -->
    <div class="panel">
      <div class="panel-header">
        <div>
          <div class="panel-title">Ranking por consultor</div>
          <div class="panel-sub">Leads + angaria√ß√µes por consultor (dados locais)</div>
        </div>
      </div>
      <div class="divider"></div>
      <div class="list" id="rankingConsultores">
        <div class="list-row">
          <div class="muted small">Ainda sem dados suficientes para ranking.</div>
        </div>
      </div>
      <div class="footer-note">
        Para alimentar este painel, utilize as p√°ginas <strong>Leads</strong> e <strong>Angaria√ß√µes</strong> com o campo de consultor preenchido.
      </div>
    </div>
  </section>

  <!-- Lado direito: Insights & filtros resumidos -->
  <aside class="col-side">
    <div class="panel">
      <div class="panel-header">
        <div>
          <div class="panel-title">Resumo executivo</div>
          <div class="panel-sub">S√≠ntese autom√°tica com base nos dados atuais</div>
        </div>
      </div>
      <div class="divider"></div>
      <div id="insightsExec" class="small">
        Ainda n√£o existem dados suficientes para gerar insights.  
        Comece por registar leads e angaria√ß√µes.
      </div>
    </div>

    <div class="panel">
      <div class="panel-header">
        <div>
          <div class="panel-title">Origem e neg√≥cio</div>
          <div class="panel-sub">Tipos de neg√≥cio e origens mais frequentes</div>
        </div>
      </div>
      <div class="divider"></div>
      <div>
        <div class="small muted">Tipos de neg√≥cio (Leads)</div>
        <div id="tagsTipoNegocio" class="tag-cloud"></div>
      </div>
      <div style="margin-top:8px;">
        <div class="small muted">Origem das leads</div>
        <div id="tagsOrigem" class="tag-cloud"></div>
      </div>
    </div>
  </aside>
</main>

<script>
(function() {
  function nowLabel() {
    const d = new Date();
    return d.toLocaleString('pt-PT', {
      day: '2-digit', month: '2-digit', year: 'numeric',
      hour: '2-digit', minute: '2-digit'
    });
  }

  function safeParse(value) {
    if (!value) return null;
    try {
      return JSON.parse(value);
    } catch (e) {
      return null;
    }
  }

  // LEADS: qualquer key com "lead"
  function loadLeads() {
    const leads = [];
    if (!window.localStorage) return leads;
    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      if (!/lead/i.test(key)) continue;
      const parsed = safeParse(localStorage.getItem(key));
      if (Array.isArray(parsed)) {
        for (const item of parsed) {
          if (item && typeof item === 'object') {
            leads.push(item);
          }
        }
      }
    }
    return leads;
  }

  // ANGARIA√á√ïES: qualquer key com "ang" (ex.: gpp_ang_v3, angariacoes, etc.)
  function loadAngariacoes() {
    const ang = [];
    if (!window.localStorage) return ang;
    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      if (!/ang/i.test(key)) continue;      // <-- mais abrangente que "angari"
      const parsed = safeParse(localStorage.getItem(key));
      if (Array.isArray(parsed)) {
        for (const item of parsed) {
          if (item && typeof item === 'object') {
            ang.push(item);
          }
        }
      }
    }
    return ang;
  }

  function filterVisiveis(arr) {
    return (arr || []).filter(a => {
      if (a === null || typeof a !== 'object') return false;
      if (a.hidden === true) return false;
      if (a.visivel === false) return false;
      if (a.visible === false) return false;
      return true;
    });
  }

  function groupBy(arr, getter) {
    const map = new Map();
    for (const item of arr) {
      const key = getter(item) || '‚Äî';
      map.set(key, (map.get(key) || 0) + 1);
    }
    return map;
  }

  function pct(value, total) {
    if (!total || total <= 0) return 0;
    return Math.round((value / total) * 100);
  }

  // DOM
  const elLastSync = document.getElementById('lastSync');
  const elKpiLeadsTotal = document.getElementById('kpiLeadsTotal');
  const elKpiAngTotal = document.getElementById('kpiAngTotal');
  const elKpiLeadsResumo = document.getElementById('kpiLeadsResumo');
  const elKpiAngResumo = document.getElementById('kpiAngResumo');
  const elKpiLeadsFecho = document.getElementById('kpiLeadsFecho');
  const elKpiLeadsFechoPct = document.getElementById('kpiLeadsFechoPct');
  const elKpiLeadsFechoResumo = document.getElementById('kpiLeadsFechoResumo');
  const elKpiAngExclusivas = document.getElementById('kpiAngExclusivas');
  const elKpiAngExclusivasPct = document.getElementById('kpiAngExclusivasPct');
  const elKpiAngExclusivasResumo = document.getElementById('kpiAngExclusivasResumo');
  const elLeadsPipelineText = document.getElementById('leadsPipelineText');
  const elAngEstadosText = document.getElementById('angEstadosText');
  const elRanking = document.getElementById('rankingConsultores');
  const elInsights = document.getElementById('insightsExec');
  const elTagsTipoNegocio = document.getElementById('tagsTipoNegocio');
  const elTagsOrigem = document.getElementById('tagsOrigem');

  function refreshDashboard() {
    const rawLeads = filterVisiveis(loadLeads());
    const rawAng = filterVisiveis(loadAngariacoes());

    const totalLeads = rawLeads.length;
    const totalAng = rawAng.length;

    elKpiLeadsTotal.textContent = totalLeads;
    elKpiAngTotal.textContent = totalAng;

    elKpiLeadsResumo.textContent = totalLeads
      ? `${totalLeads} lead(s) ativas registadas localmente.`
      : 'Sem leads registadas no navegador.';

    elKpiAngResumo.textContent = totalAng
      ? `${totalAng} angaria√ß√£o(√µes) ativas registadas localmente.`
      : 'Sem angaria√ß√µes registadas no navegador.';

    // Leads em "fecho"
    const leadsFecho = rawLeads.filter(l => {
      const estado = String(
        l.estado || l.estadoLead || l.coluna || l.colunaId || ''
      ).toLowerCase();
      return estado.includes('fecho') || estado.includes('fechad');
    });
    const nFecho = leadsFecho.length;
    elKpiLeadsFecho.textContent = nFecho;
    const pctFecho = pct(nFecho, totalLeads);
    elKpiLeadsFechoPct.textContent = totalLeads ? pctFecho + '%' : '0%';
    elKpiLeadsFechoResumo.textContent = totalLeads
      ? `${pctFecho}% das leads encontram-se em fecho.`
      : 'Sem leads suficientes para calcular taxa de fecho.';

    // Angaria√ß√µes Exclusivas ‚Äì dete√ß√£o mais robusta (‚Äúexclus‚Äù em v√°rios campos)
    const angExclusivas = rawAng.filter(a => {
      const txt = [
        a.exclusivo,
        a.exclusividade,
        a.tipoExclusividade,
        a.naturezaContrato,
        a.tipoContrato
      ]
        .filter(Boolean)
        .join(' ')
        .toString()
        .toLowerCase();
      return txt.includes('exclus'); // apanha ‚Äúexclusivo‚Äù, ‚Äúexclusiva‚Äù, etc.
    });

    const nEx = angExclusivas.length;
    elKpiAngExclusivas.textContent = nEx;
    const pctEx = pct(nEx, totalAng);
    elKpiAngExclusivasPct.textContent = totalAng ? pctEx + '%' : '0%';
    elKpiAngExclusivasResumo.textContent = totalAng
      ? `${pctEx}% das angaria√ß√µes t√™m car√°cter exclusivo.`
      : 'Sem angaria√ß√µes exclusivas registadas.';

    // Pipeline de leads (por estado)
    if (!totalLeads) {
      elLeadsPipelineText.textContent = 'Sem leads registadas.';
    } else {
      const map = groupBy(rawLeads, l => {
        const estado = (l.estado || l.estadoLead || l.coluna || '').toString();
        return estado || 'Sem estado definido';
      });
      const parts = [];
      for (const [estado, count] of map.entries()) {
        const p = pct(count, totalLeads);
        parts.push(`${estado}: ${count} (${p}%)`);
      }
      elLeadsPipelineText.textContent = parts.join(' ¬∑ ');
    }

    // Estados de angaria√ß√£o
    if (!totalAng) {
      elAngEstadosText.textContent = 'Sem angaria√ß√µes registadas.';
    } else {
      const map = groupBy(rawAng, a => {
        const estado = (a.estadoAng || a.estado || a.estadoNegocio || '').toString();
        return estado || 'Sem estado definido';
      });
      const parts = [];
      for (const [estado, count] of map.entries()) {
        const p = pct(count, totalAng);
        parts.push(`${estado}: ${count} (${p}%)`);
      }
      elAngEstadosText.textContent = parts.join(' ¬∑ ');
    }

    // Ranking consultores
    const mapConsultores = new Map();
    function acumular(nome, tipo) {
      if (!nome) return;
      const key = nome.toString().trim();
      if (!key) return;
      const prev = mapConsultores.get(key) || { leads: 0, ang: 0 };
      prev[tipo]++;
      mapConsultores.set(key, prev);
    }

    for (const l of rawLeads) {
      const c = l.consultor || l.consultorResponsavel || l.gestor || l.gestorNome;
      acumular(c, 'leads');
    }
    for (const a of rawAng) {
      const c = a.consultor || a.angariador || a.gestor || a.gestorNome;
      acumular(c, 'ang');
    }

    elRanking.innerHTML = '';
    const entries = Array.from(mapConsultores.entries())
      .map(([nome, v]) => ({ nome, leads: v.leads, ang: v.ang, total: v.leads + v.ang }))
      .sort((a, b) => b.total - a.total);

    if (!entries.length) {
      const row = document.createElement('div');
      row.className = 'list-row';
      row.innerHTML = '<div class="muted small">Ainda sem dados suficientes para ranking.</div>';
      elRanking.appendChild(row);
    } else {
      for (const e of entries) {
        const row = document.createElement('div');
        row.className = 'list-row';
        row.innerHTML = `
          <div>
            <div class="small"><strong>${e.nome}</strong></div>
            <div class="small muted">Leads: ${e.leads} ¬∑ Angaria√ß√µes: ${e.ang}</div>
          </div>
          <div>
            <span class="pill soft">${e.total} total</span>
          </div>
        `;
        elRanking.appendChild(row);
      }
    }

    // Origem & tipos de neg√≥cio (Leads)
    elTagsTipoNegocio.innerHTML = '';
    elTagsOrigem.innerHTML = '';

    const mapTipoNeg = groupBy(rawLeads, l => {
      const t = (l.tipoNegocio || l.tipo_negocio || l.negocio || '').toString();
      return t || 'N√£o definido';
    });
    for (const [tipo, count] of mapTipoNeg.entries()) {
      const span = document.createElement('span');
      span.className = 'tag';
      span.textContent = `${tipo} (${count})`;
      elTagsTipoNegocio.appendChild(span);
    }

    const mapOrigem = groupBy(rawLeads, l => {
      const o = (l.origem || l.canal || '').toString();
      return o || 'N√£o definido';
    });
    for (const [origem, count] of mapOrigem.entries()) {
      const span = document.createElement('span');
      span.className = 'tag';
      span.textContent = `${origem} (${count})`;
      elTagsOrigem.appendChild(span);
    }

    // Insights
    const insights = [];
    if (!totalLeads && !totalAng) {
      insights.push('Ainda n√£o existem leads nem angaria√ß√µes registadas neste navegador.');
    } else {
      if (totalLeads) {
        insights.push(`Tem atualmente <strong>${totalLeads}</strong> lead(s) ativa(s) no pipeline.`);
      }
      if (totalAng) {
        insights.push(`Existem <strong>${totalAng}</strong> angaria√ß√£o(√µes) ativa(s) registadas.`);
      }
      if (totalLeads && nFecho) {
        insights.push(`A taxa de leads em fecho √© de <strong>${pctFecho}%</strong>.`);
      }
      if (totalAng && nEx) {
        insights.push(`<strong>${pctEx}%</strong> das angaria√ß√µes s√£o exclusivas, refor√ßando o controlo de stock da Garvetur Porto Pro.`);
      }
      if (!nFecho && totalLeads > 0) {
        insights.push('Nenhuma lead se encontra ainda em ‚ÄúFecho‚Äù. Pode valer a pena rever as oportunidades em ‚ÄúProposta‚Äù.');
      }
      if (!nEx && totalAng > 0) {
        insights.push('Ainda n√£o existem angaria√ß√µes marcadas como exclusivas. Considere refor√ßar a negocia√ß√£o de exclusividade em ativos-chave.');
      }
    }
    elInsights.innerHTML = insights.join('<br><br>');

    if (elLastSync) {
      elLastSync.textContent = '√öltima leitura: ' + nowLabel();
    }
  }

  function resetLocalData() {
    if (!window.localStorage) return;
    const ok = window.confirm(
      'Esta a√ß√£o vai limpar todas as leads e angaria√ß√µes guardadas localmente (neste navegador) ' +
      'e reiniciar o dashboard.\n\n' +
      'Isto N√ÉO apaga nada do GitHub, apenas os dados guardados neste dispositivo.\n\n' +
      'Pretende continuar?'
    );
    if (!ok) return;

    const keysToRemove = [];
    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      if (/lead/i.test(key) || /ang/i.test(key)) {
        keysToRemove.push(key);
      }
    }
    keysToRemove.forEach(k => localStorage.removeItem(k));
    refreshDashboard();
  }

  document.getElementById('refreshBtn').addEventListener('click', refreshDashboard);
  document.getElementById('resetBtn').addEventListener('click', resetLocalData);

  refreshDashboard();
})();
</script>
</body>
</html>
