<!doctype html>
<html lang="pt-PT">
<head>
  <meta charset="utf-8" />
  <title>Garvetur Porto Pro — Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Chart.js para gráficos -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    :root{
      --gold:#A38B63;
      --gold-soft:rgba(163,139,99,.35);
      --bg:#0B0B0B;
      --panel:#121212;
      --panel-soft:#181818;
      --text:#FFFFFF;
      --muted:#A0A0A0;
      --border:rgba(255,255,255,.12);
      --danger:#F25F5C;
      --success:#4CAF50;
      --warning:#FFC857;
      --radius-lg:18px;
      --radius-md:12px;
      --shadow-soft:0 14px 25px rgba(0,0,0,.4);
    }
    *{box-sizing:border-box;}
    html,body{
      margin:0;
      height:100%;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      background:radial-gradient(circle at top,#1c1c1c 0,#050505 55%,#000 100%);
      color:var(--text);
    }
    body{display:flex;flex-direction:column;}

    .app-shell{
      display:grid;
      grid-template-rows:64px auto;
      height:100%;
    }

    header.app-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 18px;
      border-bottom:1px solid rgba(163,139,99,.35);
      background:linear-gradient(90deg,#050505,#111,#050505);
      position:sticky;
      top:0;
      z-index:20;
      gap:16px;
      flex-wrap:wrap;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .brand-icon{
      width:26px;
      height:26px;
      border-radius:999px;
      border:1px solid var(--gold);
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:0 0 0 1px rgba(163,139,99,.3);
    }
    .brand h1{
      margin:0;
      font-size:17px;
      letter-spacing:.04em;
      text-transform:uppercase;
      color:var(--gold);
    }
    .brand span.sub{
      display:block;
      font-size:11px;
      color:var(--muted);
      letter-spacing:.12em;
      text-transform:uppercase;
    }

    .nav-tabs{
      display:flex;
      align-items:center;
      flex-wrap:wrap;
      gap:4px;
      background:rgba(0,0,0,.35);
      padding:4px;
      border-radius:999px;
      border:1px solid rgba(163,139,99,.35);
    }
    .nav-tab{
      padding:5px 10px;
      border-radius:999px;
      font-size:11px;
      text-decoration:none;
      color:var(--muted);
      letter-spacing:.12em;
      text-transform:uppercase;
      border:1px solid transparent;
      transition:.16s background,.16s color,.16s border-color,.16s transform;
    }
    .nav-tab:hover{
      color:#fff;
      border-color:rgba(163,139,99,.6);
      transform:translateY(-1px);
    }
    .nav-tab.active{
      background:var(--gold);
      color:#0A0A0A;
      border-color:var(--gold);
      font-weight:600;
    }

    .header-actions{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }
    .btn{
      border-radius:999px;
      border:1px solid var(--gold-soft);
      background:rgba(12,12,12,.9);
      color:var(--text);
      padding:7px 12px;
      font-size:13px;
      display:inline-flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
      transition:.18s border-color,.18s background,.18s transform;
    }
    .btn-primary{
      background:var(--gold);
      color:#0A0A0A;
      border-color:var(--gold);
      font-weight:500;
    }
    .btn-ghost{
      background:transparent;
    }
    .btn:hover{
      border-color:var(--gold);
      transform:translateY(-1px);
    }

    .layout{
      display:grid;
      grid-template-columns:280px minmax(0,1fr);
      height:calc(100vh - 64px);
      max-height:calc(100vh - 64px);
      overflow:hidden;
    }
    @media(max-width:960px){
      .layout{
        grid-template-columns:1fr;
        grid-template-rows:auto auto;
        height:auto;
        max-height:none;
      }
    }

    .sidebar{
      border-right:1px solid rgba(163,139,99,.24);
      background:radial-gradient(circle at top left,#141414,#060606);
      padding:12px 14px;
      overflow-y:auto;
    }
    .sidebar-section{
      border-radius:var(--radius-md);
      padding:10px 11px;
      background:rgba(0,0,0,.45);
      border:1px solid rgba(163,139,99,.18);
      margin-bottom:10px;
    }
    .sidebar-section h3{
      margin:0 0 6px;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.16em;
      color:var(--muted);
    }
    .sidebar-section p{
      margin:2px 0 6px;
      font-size:12px;
      color:var(--muted);
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:4px;
      margin-bottom:8px;
    }
    .field-row{
      display:flex;
      gap:6px;
    }
    label.field-label{
      font-size:11px;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.12em;
    }
    input[type="date"],
    select{
      background:rgba(0,0,0,.7);
      color:var(--text);
      border-radius:10px;
      border:1px solid rgba(163,139,99,.22);
      padding:6px 8px;
      font-size:13px;
      outline:none;
      width:100%;
    }
    input:focus,select:focus{
      border-color:var(--gold);
      box-shadow:0 0 0 1px rgba(163,139,99,.35);
    }

    .main-area{
      padding:14px 16px 18px;
      overflow-y:auto;
      background:radial-gradient(circle at top,#1a1a1a,#050505 55%,#000 100%);
    }

    .section-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:10px;
      margin-bottom:10px;
    }
    .section-header h2{
      margin:0;
      font-size:15px;
      letter-spacing:.16em;
      text-transform:uppercase;
      color:var(--muted);
    }
    .section-header p{
      margin:2px 0 0;
      font-size:12px;
      color:var(--muted);
    }

    .kpi-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
      gap:10px;
      margin-bottom:14px;
    }
    .kpi-card{
      border-radius:var(--radius-lg);
      border:1px solid rgba(163,139,99,.35);
      background:radial-gradient(circle at top left,#181818,#070707);
      padding:10px 12px;
      box-shadow:var(--shadow-soft);
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .kpi-label{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.14em;
      color:var(--muted);
    }
    .kpi-value{
      font-size:20px;
      font-weight:600;
      color:#fff;
    }
    .kpi-sub{
      font-size:11px;
      color:var(--muted);
    }
    .kpi-badge{
      align-self:flex-start;
      margin-top:4px;
      padding:2px 7px;
      border-radius:999px;
      border:1px solid rgba(163,139,99,.4);
      font-size:10px;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.08em;
    }
    .kpi-badge.ok{border-color:rgba(76,175,80,.7);color:#A5D6A7;}
    .kpi-badge.warn{border-color:rgba(255,200,87,.8);color:#FFE082;}
    .kpi-badge.bad{border-color:rgba(242,95,92,.8);color:#FFABAB;}

    /* NOVO: zona de gráficos */
    .charts-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
      gap:12px;
      margin-bottom:14px;
    }
    .chart-card{
      border-radius:var(--radius-md);
      border:1px solid rgba(163,139,99,.3);
      background:radial-gradient(circle at top left,#181818,#050505);
      padding:8px 10px 10px;
      box-shadow:var(--shadow-soft);
      min-height:220px;
      display:flex;
      flex-direction:column;
    }
    .chart-header{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.14em;
      color:var(--muted);
      margin-bottom:6px;
    }
    .chart-wrapper{
      position:relative;
      flex:1;
      min-height:160px;
    }
    .chart-wrapper canvas{
      width:100% !important;
      height:100% !important;
    }

    .details-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
      gap:12px;
      margin-top:4px;
    }
    .panel{
      border-radius:var(--radius-md);
      border:1px solid rgba(163,139,99,.28);
      background:rgba(0,0,0,.55);
      padding:9px 10px;
    }
    .panel h3{
      margin:0 0 6px;
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.14em;
      color:var(--muted);
    }
    .panel small{
      font-size:11px;
      color:var(--muted);
    }
    .stat-row{
      display:flex;
      justify-content:space-between;
      font-size:12px;
      margin:2px 0;
      color:var(--muted);
    }
    .stat-row strong{
      color:#f5f5f5;
      font-weight:500;
    }

    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:4px;
      margin-top:4px;
    }
    .chip{
      border-radius:999px;
      padding:2px 7px;
      font-size:10px;
      border:1px solid rgba(163,139,99,.4);
      background:#1B1B1B;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.06em;
    }

    .empty{
      font-size:12px;
      color:var(--muted);
      margin-top:10px;
    }

  </style>
</head>
<body>
<div class="app-shell">
  <header class="app-header">
    <div class="brand">
      <div class="brand-icon">
        <svg width="16" height="16" viewBox="0 0 24 24" stroke="var(--gold)" fill="none" stroke-width="1.8">
          <circle cx="12" cy="12" r="9"></circle>
          <path d="M8 12.5l2.5 2.5L16 9"></path>
        </svg>
      </div>
      <div>
        <h1>Garvetur Porto Pro — Dashboard</h1>
        <span class="sub">Visão global · Leads, Angariações & Tarefas</span>
      </div>
    </div>

    <nav class="nav-tabs">
      <a href="index.html" class="nav-tab">Início</a>
      <a href="mapa.html" class="nav-tab">Mapa</a>
      <a href="kanban.html" class="nav-tab">Leads</a>
      <a href="angariacoes.html" class="nav-tab">Angariações</a>
      <a href="dashboard.html" class="nav-tab active">Dashboard</a>
      <a href="vendas.html" class="nav-tab">Vendas</a>
      <a href="tarefas.html" class="nav-tab">Tarefas</a>
    </nav>

    <div class="header-actions">
      <button class="btn btn-ghost" id="reloadBtn">Atualizar dados</button>
    </div>
  </header>

  <div class="layout">
    <aside class="sidebar">
      <div class="sidebar-section">
        <h3>Filtros</h3>
        <div class="field">
          <label class="field-label" for="filterConsultor">Consultor</label>
          <select id="filterConsultor">
            <option value="">Todos</option>
          </select>
        </div>
        <div class="field-row">
          <div class="field">
            <label class="field-label" for="filterDataDe">De</label>
            <input type="date" id="filterDataDe" />
          </div>
          <div class="field">
            <label class="field-label" for="filterDataAte">Até</label>
            <input type="date" id="filterDataAte" />
          </div>
        </div>
        <p>O período aplica-se à <strong>data da Lead</strong>, à <strong>data da Angariação</strong> e à <strong>data limite das Tarefas</strong>.</p>
      </div>

      <div class="sidebar-section">
        <h3>Dicas</h3>
        <p>
          Use o filtro de <strong>Consultor</strong> para preparar reuniões individuais.<br>
          Combine com o período para ver apenas o mês atual ou um trimestre.
        </p>
        <p>Os gráficos e KPIs atualizam automaticamente com os filtros.</p>
      </div>
    </aside>

    <main class="main-area">
      <div class="section-header">
        <div>
          <h2>Visão Geral</h2>
          <p>Resumo consolidado de pipeline comercial — Leads, Produto, Negócios & Ações.</p>
        </div>
        <div id="contextLabel" style="font-size:11px;color:var(--muted);text-align:right;"></div>
      </div>

      <!-- KPIs principais -->
      <section class="kpi-grid" id="kpiGrid"></section>

      <!-- NOVO: zona de gráficos -->
      <section class="charts-grid">
        <div class="chart-card">
          <div class="chart-header">Leads por estado</div>
          <div class="chart-wrapper">
            <canvas id="chartLeadsEstado"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <div class="chart-header">Negócios por mês (Fecho + Aprovado)</div>
          <div class="chart-wrapper">
            <canvas id="chartNegociosMes"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <div class="chart-header">Tarefas por estado</div>
          <div class="chart-wrapper">
            <canvas id="chartTarefasEstado"></canvas>
          </div>
        </div>
      </section>

      <!-- Detalhes -->
      <section class="details-grid">
        <div class="panel">
          <h3>Leads — Detalhe por estado</h3>
          <small>Baseado em leads <strong>visíveis</strong> no Kanban.</small>
          <div id="leadStates"></div>
        </div>

        <div class="panel">
          <h3>Angariações — Detalhe por estado</h3>
          <small>Baseado em angariações <strong>visíveis</strong>.</small>
          <div id="dealStates"></div>
        </div>

        <div class="panel">
          <h3>Perfil & Origem</h3>
          <small>Distribuição simplificada de perfil de leads.</small>
          <div id="profileSummary"></div>
        </div>

        <div class="panel">
          <h3>Notas rápidas</h3>
          <small>Indicadores úteis para discussão em reunião.</small>
          <div id="notesSummary" class="chips"></div>
        </div>

        <div class="panel">
          <h3>Visibilidade Leads</h3>
          <small>Total de leads filtradas, visíveis e invisíveis.</small>
          <div id="leadVisibility"></div>
        </div>

        <div class="panel">
          <h3>Visibilidade Angariações</h3>
          <small>Total de angariações filtradas, visíveis e invisíveis.</small>
          <div id="dealVisibility"></div>
        </div>

        <div class="panel">
          <h3>Tarefas — Estado & Prioridade</h3>
          <small>Tarefas filtradas por responsável / período.</small>
          <div id="taskSummary"></div>
        </div>
      </section>

      <div id="emptyState" class="empty" style="display:none;">
        Ainda não existem dados em Leads, Angariações ou Tarefas com os filtros atuais.
      </div>
    </main>
  </div>
</div>

<script>
(function(){
  const STORAGE_LEADS = 'gpp_leads_v5';
  const STORAGE_ANG   = 'gpp_angariacoes_v2';
  const STORAGE_TASKS = 'gpp_tarefas_v1';

  const filterConsultor   = document.getElementById('filterConsultor');
  const filterDataDe      = document.getElementById('filterDataDe');
  const filterDataAte     = document.getElementById('filterDataAte');
  const kpiGrid           = document.getElementById('kpiGrid');
  const leadStatesEl      = document.getElementById('leadStates');
  const dealStatesEl      = document.getElementById('dealStates');
  const profileSummaryEl  = document.getElementById('profileSummary');
  const notesSummaryEl    = document.getElementById('notesSummary');
  const leadVisibilityEl  = document.getElementById('leadVisibility');
  const dealVisibilityEl  = document.getElementById('dealVisibility');
  const taskSummaryEl     = document.getElementById('taskSummary');
  const emptyState        = document.getElementById('emptyState');
  const contextLabel      = document.getElementById('contextLabel');
  const reloadBtn         = document.getElementById('reloadBtn');

  const chartLeadsEstadoCanvas   = document.getElementById('chartLeadsEstado');
  const chartNegociosMesCanvas   = document.getElementById('chartNegociosMes');
  const chartTarefasEstadoCanvas = document.getElementById('chartTarefasEstado');

  let allLeads  = [];
  let allDeals  = [];
  let allTasks  = [];

  let chartLeadsEstado   = null;
  let chartNegociosMes   = null;
  let chartTarefasEstado = null;

  function parseNum(v){
    if(v===null || v===undefined || v==='') return 0;
    const n = parseFloat(String(v).replace(',','.'));
    return isFinite(n) ? n : 0;
  }
  function parsePct(v){
    if(v===null || v===undefined || v==='') return NaN;
    const n = parseFloat(String(v).replace(',','.'));
    return isFinite(n) ? n : NaN;
  }
  function formatMoney(n){
    const v = parseNum(n);
    if(!isFinite(v) || v === 0) return '—';
    return v.toLocaleString('pt-PT',{style:'currency',currency:'EUR',maximumFractionDigits:0});
  }
  function formatPct(n){
    const v = parsePct(n);
    if(!isFinite(v)) return '—';
    return v.toFixed(1).replace('.',',') + '%';
  }

  function todayISO(){
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    return y + '-' + m + '-' + day;
  }

  function loadLeads(){
    try{
      const raw = localStorage.getItem(STORAGE_LEADS);
      const parsed = raw ? JSON.parse(raw) : [];
      allLeads = Array.isArray(parsed) ? parsed : [];
    }catch(e){
      console.error('Erro a ler leads:',e);
      allLeads = [];
    }
  }

  function loadDeals(){
    try{
      const raw = localStorage.getItem(STORAGE_ANG);
      const parsed = raw ? JSON.parse(raw) : {};
      allDeals = (parsed && Array.isArray(parsed.deals)) ? parsed.deals : [];
    }catch(e){
      console.error('Erro a ler angariações:',e);
      allDeals = [];
    }
  }

  function loadTasks(){
    try{
      const raw = localStorage.getItem(STORAGE_TASKS);
      if(!raw){
        allTasks = [];
        return;
      }
      const parsed = JSON.parse(raw);
      if(parsed && Array.isArray(parsed.tasks)){
        allTasks = parsed.tasks;
      }else if(Array.isArray(parsed)){
        allTasks = parsed;
      }else{
        allTasks = [];
      }
    }catch(e){
      console.error('Erro a ler tarefas:',e);
      allTasks = [];
    }
  }

  function applyFilters(){
    const cons = filterConsultor.value || '';
    const de   = filterDataDe.value || '';
    const ate  = filterDataAte.value || '';

    let leads = allLeads.slice().filter(l => l);
    let deals = allDeals.slice().filter(d => d);

    if(cons){
      leads = leads.filter(l => (l.consultor || '') === cons);
      deals = deals.filter(d => (d.consultor || '') === cons);
    }
    if(de){
      leads = leads.filter(l => !l.data || l.data >= de);
      deals = deals.filter(d => !d.dataAngariacao || d.dataAngariacao >= de);
    }
    if(ate){
      leads = leads.filter(l => !l.data || l.data <= ate);
      deals = deals.filter(d => !d.dataAngariacao || d.dataAngariacao <= ate);
    }

    return {leads, deals};
  }

  function applyTaskFilters(){
    const cons = filterConsultor.value || '';
    const de   = filterDataDe.value || '';
    const ate  = filterDataAte.value || '';

    let tasks = allTasks.slice().filter(t=>t);

    if(cons){
      tasks = tasks.filter(t => (t.responsavel || '') === cons);
    }
    if(de){
      tasks = tasks.filter(t => !t.dataLimite || t.dataLimite >= de);
    }
    if(ate){
      tasks = tasks.filter(t => !t.dataLimite || t.dataLimite <= ate);
    }
    return tasks;
  }

  function buildConsultorOptions(){
    const set = new Set();
    allLeads.forEach(l => { if(l && l.consultor) set.add(l.consultor); });
    allDeals.forEach(d => { if(d && d.consultor) set.add(d.consultor); });
    allTasks.forEach(t => { if(t && t.responsavel) set.add(t.responsavel); });

    const current = filterConsultor.value;
    filterConsultor.innerHTML = '<option value="">Todos</option>';
    Array.from(set).sort().forEach(name=>{
      const opt = document.createElement('option');
      opt.value = name;
      opt.textContent = name;
      filterConsultor.appendChild(opt);
    });
    if(current && set.has(current)){
      filterConsultor.value = current;
    }
  }

  function buildNegocios(leadsFiltered, dealsFiltered){
    const list = [];

    // Leads em Fecho
    leadsFiltered.forEach(l=>{
      if(!l || l.estado !== 'Fecho') return;
      const valor = parseNum(l.fecho_negocio || l.valor || 0);
      list.push({
        tipo:'lead',
        consultor: l.consultor || '',
        data: l.data || '',
        valor: isFinite(valor) ? valor : 0
      });
    });

    // Angariações aprovadas
    dealsFiltered.forEach(a=>{
      if(!a || a.estadoAng !== 'aprovado') return;
      const preco = parseNum(a.precoPedido || 0);
      list.push({
        tipo:'ang',
        consultor: a.consultor || '',
        data: a.dataAngariacao || '',
        valor: isFinite(preco) ? preco : 0
      });
    });

    return list;
  }

  function computeStats(leadsFiltered, dealsFiltered){
    const leadsVisible = leadsFiltered.filter(l => l.visivel !== false);
    const leadsHidden  = leadsFiltered.filter(l => l.visivel === false);
    const dealsVisible = dealsFiltered.filter(d => d.visible !== false);
    const dealsHidden  = dealsFiltered.filter(d => d.visible === false);

    const estadosLead = ["Novo","Em Contacto","Qualificado","Visita","Proposta","Fecho","Perdido"];
    const byEstadoLeadVisible = {};
    const byEstadoLeadHidden  = {};
    estadosLead.forEach(e=>{ byEstadoLeadVisible[e]=0; byEstadoLeadHidden[e]=0; });

    leadsVisible.forEach(l=>{
      if(byEstadoLeadVisible[l.estado] !== undefined){
        byEstadoLeadVisible[l.estado]++;
      }
    });
    leadsHidden.forEach(l=>{
      if(byEstadoLeadHidden[l.estado] !== undefined){
        byEstadoLeadHidden[l.estado]++;
      }
    });

    const totalLeadsVisible = leadsVisible.length;
    const totalLeadsHidden  = leadsHidden.length;
    const totalLeadsAll     = totalLeadsVisible + totalLeadsHidden;

    const fechoLeadsVisiveis = leadsVisible.filter(l => l.estado === 'Fecho');
    const totalFecho         = fechoLeadsVisiveis.length;
    const taxaFecho          = totalLeadsVisible ? (totalFecho / totalLeadsVisible * 100) : 0;

    let totalNegocio  = 0;
    let totalComissao = 0;
    fechoLeadsVisiveis.forEach(l=>{
      const negocio = parseNum(l.fecho_negocio);
      const pct     = parsePct(l.fecho_comissao_pct);
      totalNegocio += negocio;
      if(isFinite(pct) && negocio>0){
        totalComissao += negocio * (pct/100);
      }
    });

    const estadosDeal = ["novo","negociacao","aprovado","perdido"];
    const byEstadoDealVisible = {};
    const byEstadoDealHidden  = {};
    estadosDeal.forEach(e=>{ byEstadoDealVisible[e]=0; byEstadoDealHidden[e]=0; });

    let totalExcl = 0;
    let totalNaoExcl = 0;
    let volumePedido = 0;
    let totalComissaoPot = 0;
    let somaAjust = 0;
    let countAjust = 0;

    dealsVisible.forEach(d=>{
      if(byEstadoDealVisible[d.estadoAng] !== undefined){
        byEstadoDealVisible[d.estadoAng]++;
      }
      if(d.exclusivo) totalExcl++;
      if(d.naoExclusivo) totalNaoExcl++;

      const preco = parseNum(d.precoPedido);
      volumePedido += preco;

      let pct = NaN;
      if(d.comissao === 'outro'){
        pct = parsePct(d.comissaoOutro);
      }else if(d.comissao){
        pct = parsePct(d.comissao);
      }
      if(isFinite(pct) && preco>0){
        totalComissaoPot += preco * (pct/100);
      }

      const aj = parsePct(d.percentAjust);
      if(isFinite(aj)){
        somaAjust += aj;
        countAjust++;
      }
    });

    dealsHidden.forEach(d=>{
      if(byEstadoDealHidden[d.estadoAng] !== undefined){
        byEstadoDealHidden[d.estadoAng]++;
      }
    });

    const mediaAjust = countAjust ? (somaAjust / countAjust) : NaN;

    const perfilCounts = {
      Investidor:0,
      "Cliente final":0,
      Comprador:0,
      Vendedor:0
    };
    leadsVisible.forEach(l=>{
      if(l.perfil === 'Investidor') perfilCounts.Investidor++;
      if(l.perfil === 'Cliente final') perfilCounts["Cliente final"]++;
      if(l.papel === 'Comprador') perfilCounts.Comprador++;
      if(l.papel === 'Vendedor') perfilCounts.Vendedor++;
    });

    return {
      totalLeadsVisible,
      totalLeadsHidden,
      totalLeadsAll,
      byEstadoLeadVisible,
      byEstadoLeadHidden,
      totalFecho,
      taxaFecho,
      totalNegocio,
      totalComissao,

      totalDealsVisible: dealsVisible.length,
      totalDealsHidden: dealsHidden.length,
      totalDealsAll: dealsVisible.length + dealsHidden.length,
      byEstadoDealVisible,
      byEstadoDealHidden,
      totalExcl,
      totalNaoExcl,
      volumePedido,
      totalComissaoPot,
      mediaAjust,
      perfilCounts
    };
  }

  function computeTaskStats(tasks){
    const countsByEstado = {
      por_fazer:0,
      em_curso:0,
      concluida:0,
      adiada:0,
      cancelada:0
    };
    const countsByPrioridade = {
      baixa:0,
      normal:0,
      alta:0,
      critica:0
    };

    let abertas  = 0;
    let criticas = 0;
    let atrasadas= 0;
    const hoje   = todayISO();

    tasks.forEach(t=>{
      if(countsByEstado[t.estado] !== undefined){
        countsByEstado[t.estado]++;
      }
      if(countsByPrioridade[t.prioridade] !== undefined){
        countsByPrioridade[t.prioridade]++;
      }

      const isDone = t.estado === 'concluida' || t.estado === 'cancelada';
      if(!isDone){
        abertas++;
        if(t.prioridade === 'alta' || t.prioridade === 'critica'){
          criticas++;
        }
        if(t.dataLimite && t.dataLimite < hoje){
          atrasadas++;
        }
      }
    });

    return {
      total: tasks.length,
      countsByEstado,
      countsByPrioridade,
      abertas,
      criticas,
      atrasadas
    };
  }

  function renderKpis(stats, negocios, taskStats){
    kpiGrid.innerHTML = '';

    const totalNegocios   = negocios.length;
    const totalNegLead    = negocios.filter(n=>n.tipo==='lead').length;
    const totalNegAng     = negocios.filter(n=>n.tipo==='ang').length;
    const volumeNegocios  = negocios.reduce((acc,n)=>acc+(n.valor||0),0);

    const kpiData = [];

    kpiData.push({
      label:'Leads ativas',
      value:stats.totalLeadsVisible,
      sub:'Leads visíveis, após filtros',
      badge: stats.totalFecho > 0 ? `${stats.totalFecho} em Fecho` : ''
    });

    kpiData.push({
      label:'Taxa de Fecho (Leads)',
      value: stats.totalLeadsVisible ? stats.taxaFecho.toFixed(1).replace('.',',') + '%' : '—',
      sub:`${stats.totalFecho} de ${stats.totalLeadsVisible} leads visíveis`,
      badge: stats.taxaFecho >= 20 ? 'Saudável' : (stats.taxaFecho >= 10 ? 'Atenção' : 'Baixa'),
      badgeClass: stats.taxaFecho >= 20 ? 'ok' : (stats.taxaFecho >= 10 ? 'warn' : 'bad')
    });

    kpiData.push({
      label:'Negócio em Fecho',
      value:formatMoney(stats.totalNegocio),
      sub:'Valor do Negócio (leads em Fecho visíveis)',
      badge: stats.totalComissao ? ('Comissão estimada ' + formatMoney(stats.totalComissao)) : ''
    });

    kpiData.push({
      label:'Angariações ativas',
      value:stats.totalDealsVisible,
      sub:'Angariações visíveis, após filtros',
      badge: stats.totalExcl || stats.totalNaoExcl
        ? `Exclusivo: ${stats.totalExcl} · Não exclusivo: ${stats.totalNaoExcl}`
        : ''
    });

    kpiData.push({
      label:'Volume de Produto',
      value:formatMoney(stats.volumePedido),
      sub:'Preço pedido (angariações visíveis)',
      badge: stats.totalComissaoPot ? ('Comissão potencial ' + formatMoney(stats.totalComissaoPot)) : ''
    });

    kpiData.push({
      label:'Negócios (Fecho + Aprovado)',
      value: totalNegocios,
      sub: `Leads: ${totalNegLead} · Angariações: ${totalNegAng}`,
      badge: volumeNegocios ? ('Volume ' + formatMoney(volumeNegocios)) : ''
    });

    kpiData.push({
      label:'Tarefas em aberto',
      value: taskStats.abertas || 0,
      sub: `Total tarefas filtradas: ${taskStats.total}`,
      badge: taskStats.atrasadas ? (`${taskStats.atrasadas} em atraso`) : ''
    });

    kpiData.push({
      label:'Tarefas críticas',
      value: taskStats.criticas || 0,
      sub:'Prioridade alta / crítica em aberto',
      badge: taskStats.total ? '' : ''
    });

    kpiData.forEach(k=>{
      const card = document.createElement('div');
      card.className = 'kpi-card';
      const lab = document.createElement('div');
      lab.className = 'kpi-label';
      lab.textContent = k.label;
      const val = document.createElement('div');
      val.className = 'kpi-value';
      val.textContent = k.value;
      const sub = document.createElement('div');
      sub.className = 'kpi-sub';
      sub.textContent = k.sub || '';
      card.appendChild(lab);
      card.appendChild(val);
      card.appendChild(sub);
      if(k.badge){
        const b = document.createElement('div');
        b.className = 'kpi-badge';
        if(k.badgeClass) b.classList.add(k.badgeClass);
        b.textContent = k.badge;
        card.appendChild(b);
      }
      kpiGrid.appendChild(card);
    });
  }

  function renderLeadStates(stats){
    const mapLabel = {
      "Novo":"Novo",
      "Em Contacto":"Em Contacto",
      "Qualificado":"Qualificado",
      "Visita":"Visita",
      "Proposta":"Proposta",
      "Fecho":"Fecho",
      "Perdido":"Perdido"
    };
    leadStatesEl.innerHTML = '';
    Object.keys(mapLabel).forEach(key=>{
      const row = document.createElement('div');
      row.className = 'stat-row';
      const l = document.createElement('span');
      l.textContent = mapLabel[key];
      const v = document.createElement('span');
      v.innerHTML = '<strong>'+ (stats.byEstadoLeadVisible[key] || 0) +'</strong>';
      row.appendChild(l);
      row.appendChild(v);
      leadStatesEl.appendChild(row);
    });
  }

  function renderDealStates(stats){
    const mapLabel = {
      novo:'Novo',
      negociacao:'Em negociação',
      aprovado:'Aprovado',
      perdido:'Perdido'
    };
    dealStatesEl.innerHTML = '';
    Object.keys(mapLabel).forEach(key=>{
      const row = document.createElement('div');
      row.className = 'stat-row';
      const l = document.createElement('span');
      l.textContent = mapLabel[key];
      const v = document.createElement('span');
      v.innerHTML = '<strong>'+ (stats.byEstadoDealVisible[key] || 0) +'</strong>';
      row.appendChild(l);
      row.appendChild(v);
      dealStatesEl.appendChild(row);
    });
  }

  function renderProfile(stats){
    profileSummaryEl.innerHTML = '';

    const makeRow = (label, value) => {
      const row = document.createElement('div');
      row.className = 'stat-row';
      const l = document.createElement('span');
      l.textContent = label;
      const v = document.createElement('span');
      v.innerHTML = '<strong>'+value+'</strong>';
      row.appendChild(l);
      row.appendChild(v);
      profileSummaryEl.appendChild(row);
    };

    makeRow('Investidor', stats.perfilCounts.Investidor || 0);
    makeRow('Cliente final', stats.perfilCounts["Cliente final"] || 0);
    makeRow('Comprador', stats.perfilCounts.Comprador || 0);
    makeRow('Vendedor', stats.perfilCounts.Vendedor || 0);
  }

  function renderNotes(stats){
    notesSummaryEl.innerHTML = '';

    const chips = [];

    if(stats.totalLeadsVisible === 0 && stats.totalDealsVisible === 0){
      const c = document.createElement('span');
      c.className = 'chip';
      c.textContent = 'Sem dados visíveis nos módulos';
      notesSummaryEl.appendChild(c);
      return;
    }

    if(stats.totalLeadsVisible > 0){
      chips.push(`Pipeline de leads ativo (${stats.totalLeadsVisible})`);
      if(stats.taxaFecho < 10 && stats.totalLeadsVisible >= 5){
        chips.push('Taxa de fecho baixa — rever qualificação');
      }else if(stats.taxaFecho >= 20){
        chips.push('Taxa de fecho saudável');
      }
    }

    if(stats.totalDealsVisible > 0){
      if(stats.totalExcl > stats.totalNaoExcl){
        chips.push('Predomínio de angariações em exclusivo');
      }else if(stats.totalNaoExcl > 0){
        chips.push('Várias angariações não exclusivas — reforçar diferenciação');
      }
      if(isFinite(stats.mediaAjust)){
        if(stats.mediaAjust < -5){
          chips.push('Ajustamento médio acima de 5% — foco em alinhamento de preço');
        }else{
          chips.push('Ajustamento médio controlado');
        }
      }
    }

    chips.forEach(txt=>{
      const c = document.createElement('span');
      c.className = 'chip';
      c.textContent = txt;
      notesSummaryEl.appendChild(c);
    });
  }

  function renderVisibilityLeads(stats){
    leadVisibilityEl.innerHTML = '';

    const makeRow = (label, value) => {
      const row = document.createElement('div');
      row.className = 'stat-row';
      const l = document.createElement('span');
      l.textContent = label;
      const v = document.createElement('span');
      v.innerHTML = '<strong>'+value+'</strong>';
      row.appendChild(l);
      row.appendChild(v);
      leadVisibilityEl.appendChild(row);
    };

    makeRow('Total (todas)', stats.totalLeadsAll);
    makeRow('Visíveis', stats.totalLeadsVisible);
    makeRow('Invisíveis', stats.totalLeadsHidden);

    const sep = document.createElement('div');
    sep.className = 'stat-row';
    sep.innerHTML = '<span><strong>Por estado</strong></span><span></span>';
    leadVisibilityEl.appendChild(sep);

    const estados = ["Novo","Em Contacto","Qualificado","Visita","Proposta","Fecho","Perdido"];
    estados.forEach(e=>{
      const row = document.createElement('div');
      row.className = 'stat-row';
      const l = document.createElement('span');
      l.textContent = e;
      const vis = stats.byEstadoLeadVisible[e] || 0;
      const hid = stats.byEstadoLeadHidden[e] || 0;
      const v = document.createElement('span');
      v.innerHTML = `<strong>${vis}</strong> visíveis · <strong>${hid}</strong> invisíveis`;
      row.appendChild(l);
      row.appendChild(v);
      leadVisibilityEl.appendChild(row);
    });
  }

  function renderVisibilityDeals(stats){
    dealVisibilityEl.innerHTML = '';

    const makeRow = (label, value) => {
      const row = document.createElement('div');
      row.className = 'stat-row';
      const l = document.createElement('span');
      l.textContent = label;
      const v = document.createElement('span');
      v.innerHTML = '<strong>'+value+'</strong>';
      row.appendChild(l);
      row.appendChild(v);
      dealVisibilityEl.appendChild(row);
    };

    makeRow('Total (todas)', stats.totalDealsAll);
    makeRow('Visíveis', stats.totalDealsVisible);
    makeRow('Invisíveis', stats.totalDealsHidden);

    const sep = document.createElement('div');
    sep.className = 'stat-row';
    sep.innerHTML = '<span><strong>Por estado</strong></span><span></span>';
    dealVisibilityEl.appendChild(sep);

    const mapLabel = {
      novo:'Novo',
      negociacao:'Em negociação',
      aprovado:'Aprovado',
      perdido:'Perdido'
    };
    Object.keys(mapLabel).forEach(key=>{
      const row = document.createElement('div');
      row.className = 'stat-row';
      const l = document.createElement('span');
      l.textContent = mapLabel[key];
      const vis = stats.byEstadoDealVisible[key] || 0;
      const hid = stats.byEstadoDealHidden[key] || 0;
      const v = document.createElement('span');
      v.innerHTML = `<strong>${vis}</strong> visíveis · <strong>${hid}</strong> invisíveis`;
      row.appendChild(l);
      row.appendChild(v);
      dealVisibilityEl.appendChild(row);
    });
  }

  function renderTaskSummary(taskStats){
    taskSummaryEl.innerHTML = '';

    const ESTADO_LABEL = {
      por_fazer:'Por fazer',
      em_curso:'Em curso',
      concluida:'Concluída',
      adiada:'Adiada',
      cancelada:'Cancelada'
    };
    const PRIO_LABEL = {
      baixa:'Baixa',
      normal:'Normal',
      alta:'Alta',
      critica:'Crítica'
    };

    const makeRow = (label, value) => {
      const row = document.createElement('div');
      row.className = 'stat-row';
      const l = document.createElement('span');
      l.textContent = label;
      const v = document.createElement('span');
      v.innerHTML = '<strong>'+value+'</strong>';
      row.appendChild(l);
      row.appendChild(v);
      taskSummaryEl.appendChild(row);
    };

    makeRow('Total tarefas (filtros)', taskStats.total || 0);
    makeRow('Em aberto', taskStats.abertas || 0);
    makeRow('Críticas / Alta', taskStats.criticas || 0);
    makeRow('Em atraso', taskStats.atrasadas || 0);

    const sep1 = document.createElement('div');
    sep1.className = 'stat-row';
    sep1.innerHTML = '<span><strong>Por estado</strong></span><span></span>';
    taskSummaryEl.appendChild(sep1);

    Object.keys(ESTADO_LABEL).forEach(k=>{
      makeRow(ESTADO_LABEL[k], taskStats.countsByEstado[k] || 0);
    });

    const sep2 = document.createElement('div');
    sep2.className = 'stat-row';
    sep2.innerHTML = '<span><strong>Por prioridade</strong></span><span></span>';
    taskSummaryEl.appendChild(sep2);

    Object.keys(PRIO_LABEL).forEach(k=>{
      makeRow(PRIO_LABEL[k], taskStats.countsByPrioridade[k] || 0);
    });
  }

  function updateContextLabel(){
    const cons = filterConsultor.value || '';
    const de   = filterDataDe.value || '';
    const ate  = filterDataAte.value || '';
    const parts = [];
    if(cons) parts.push('Consultor: ' + cons);
    if(de || ate){
      parts.push('Período: ' + (de || '…') + ' a ' + (ate || '…'));
    }
    contextLabel.textContent = parts.length ? parts.join(' | ') : 'Sem filtros — visão global';
  }

  function renderCharts(stats, negocios, taskStats){
    if(typeof Chart === 'undefined'){
      return;
    }

    // Leads por estado (doughnut)
    const leadLabels = ["Novo","Em Contacto","Qualificado","Visita","Proposta","Fecho","Perdido"];
    const leadData   = leadLabels.map(l=>stats.byEstadoLeadVisible[l] || 0);

    if(chartLeadsEstado){ chartLeadsEstado.destroy(); }
    chartLeadsEstado = new Chart(chartLeadsEstadoCanvas, {
      type:'doughnut',
      data:{
        labels:leadLabels,
        datasets:[{
          data:leadData,
          backgroundColor:[
            '#A38B63',
            '#C9A87B',
            '#7C6A4D',
            '#4E4E4E',
            '#888888',
            '#4CAF50',
            '#F25F5C'
          ],
          borderColor:'#000',
          borderWidth:1
        }]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        plugins:{
          legend:{labels:{color:'#ddd',font:{size:10}}}
        }
      }
    });

    // Negócios por mês (bar)
    const mapaMes = {};
    negocios.forEach(n=>{
      if(!n.data) return;
      const d = new Date(n.data);
      if(isNaN(d.getTime())) return;
      const key = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0');
      if(!mapaMes[key]) mapaMes[key] = 0;
      mapaMes[key] += n.valor || 0;
    });
    const keys = Object.keys(mapaMes).sort((a,b)=>a.localeCompare(b));
    const negLabels = keys.map(k=>{
      const [y,m] = k.split('-');
      return m + '/' + y.slice(-2);
    });
    const negData   = keys.map(k=>mapaMes[k]);

    if(chartNegociosMes){ chartNegociosMes.destroy(); }
    chartNegociosMes = new Chart(chartNegociosMesCanvas, {
      type:'bar',
      data:{
        labels:negLabels,
        datasets:[{
          label:'Volume',
          data:negData,
          backgroundColor:'#A38B63'
        }]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        plugins:{
          legend:{display:false}
        },
        scales:{
          x:{ticks:{color:'#ddd'}},
          y:{ticks:{color:'#ddd'},beginAtZero:true}
        }
      }
    });

    // Tarefas por estado (bar horizontal)
    const ESTADO_LABEL = {
      por_fazer:'Por fazer',
      em_curso:'Em curso',
      concluida:'Concluída',
      adiada:'Adiada',
      cancelada:'Cancelada'
    };
    const tLabels = Object.keys(ESTADO_LABEL).map(k=>ESTADO_LABEL[k]);
    const tData   = Object.keys(ESTADO_LABEL).map(k=>taskStats.countsByEstado[k] || 0);

    if(chartTarefasEstado){ chartTarefasEstado.destroy(); }
    chartTarefasEstado = new Chart(chartTarefasEstadoCanvas, {
      type:'bar',
      data:{
        labels:tLabels,
        datasets:[{
          data:tData,
          backgroundColor:'#C9A87B'
        }]
      },
      options:{
        indexAxis:'y',
        responsive:true,
        maintainAspectRatio:false,
        plugins:{
          legend:{display:false}
        },
        scales:{
          x:{ticks:{color:'#ddd'},beginAtZero:true},
          y:{ticks:{color:'#ddd'}}
        }
      }
    });
  }

  function refresh(){
    loadLeads();
    loadDeals();
    loadTasks();
    buildConsultorOptions();

    const {leads,deals} = applyFilters();
    const tasksFiltered = applyTaskFilters();
    const negocios      = buildNegocios(leads,deals);

    const stats      = computeStats(leads,deals);
    const taskStats  = computeTaskStats(tasksFiltered);

    const hasData = (stats.totalLeadsVisible > 0) ||
                    (stats.totalDealsVisible > 0) ||
                    (taskStats.total > 0);

    emptyState.style.display = hasData ? 'none' : 'block';

    renderKpis(stats, negocios, taskStats);
    renderLeadStates(stats);
    renderDealStates(stats);
    renderProfile(stats);
    renderNotes(stats);
    renderVisibilityLeads(stats);
    renderVisibilityDeals(stats);
    renderTaskSummary(taskStats);
    renderCharts(stats, negocios, taskStats);
    updateContextLabel();
  }

  filterConsultor.addEventListener('change', refresh);
  filterDataDe.addEventListener('change', refresh);
  filterDataAte.addEventListener('change', refresh);
  reloadBtn.addEventListener('click', refresh);

  refresh();
})();
</script>
</body>
</html>
