<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="utf-8">
  <title>Garvetur Porto Pro — Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="preconnect" href="https://unpkg.com" crossorigin>
  <style>
    :root{ --bg:#0E0E0E; --panel:#131313; --text:#FFFFFF; --muted:#9AA0A6; --gold:#FFD166; --edge:#1a1a1a; --card:#141414; --acc:#118AB2; --ok:#06D6A0; --warn:#FFC107; }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    #topbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.08);background:#0F0F0F}
    .tabs{display:flex;gap:6px;align-items:center;margin-left:4px}
    .tab{font-size:12px;padding:6px 10px;border:1px solid rgba(255,255,255,.12);border-radius:8px;background:#121212;color:#ddd;text-decoration:none}
    .tab:hover{border-color:var(--gold)}
    .tab.active{background:var(--gold);color:#111;border-color:var(--gold);font-weight:600}
    .btn{background:transparent;border:1px solid rgba(255,209,102,.5);color:#fff;padding:6px 9px;border-radius:8px;cursor:pointer;font-size:12px}
    .btn:hover{border-color:var(--gold)}
    .input{background:#121212;border:1px solid rgba(255,255,255,.12);color:#fff;padding:7px 9px;border-radius:10px;outline:none}
    .wrap{display:grid;grid-template-columns:1fr 1fr;gap:14px;padding:12px}
    .card{background:var(--panel);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px}
    .title{font-size:12px;text-transform:uppercase;letter-spacing:.06em;color:#ddd;margin-bottom:6px}
    .kpis{display:grid;grid-template-columns:repeat(6,1fr);gap:10px}
    .kpi{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:10px}
    .kpi .big{font-size:18px;font-weight:800}
    .flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .bar{height:10px;background:#1b1b1b;border-radius:8px;overflow:hidden;border:1px solid rgba(255,255,255,.06)}
    .bar > div{height:100%;background:linear-gradient(90deg,var(--ok),var(--gold));}
    canvas{background:#0E0E0E;border:1px solid rgba(255,255,255,.06);border-radius:10px}
    @media (max-width:1000px){ .wrap{grid-template-columns:1fr} .kpis{grid-template-columns:repeat(3,1fr)} }
    .list{display:flex;flex-direction:column;gap:8px}
    .row{display:flex;gap:10px;align-items:center;justify-content:space-between;background:#161616;border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:8px}
  </style>
</head>
<body>
  <div id="topbar">
    <div class="brand" style="display:flex;align-items:center;gap:10px">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" style="color:#FFD166"><circle cx="12" cy="12" r="10" stroke-width="1.5"/><path d="M8 12l2.5 2.5L16 9" stroke-width="1.8"/></svg>
      <h1 style="margin:0;font-size:16px;color:#FFD166">Garvetur Porto Pro</h1>
      <nav class="tabs">
        <a class="tab" href="./index.html">Mapa</a>
        <a class="tab" href="./kanban.html">Kanban</a>
        <a class="tab active" href="./dashboard.html">Dashboard</a>
      </nav>
    </div>
    <button id="exportCsv" class="btn" style="margin-left:auto">Exportar CSV</button>
    <button id="print" class="btn">Imprimir / PDF</button>
  </div>

  <div class="wrap">
    <div class="card">
      <div class="title">KPI geral (do Kanban)</div>
      <div class="kpis">
        <div class="kpi"><div>Total leads</div><div id="kpi_total" class="big">—</div></div>
        <div class="kpi"><div>Novas</div><div id="kpi_novas" class="big">—</div></div>
        <div class="kpi"><div>Em contacto</div><div id="kpi_contacto" class="big">—</div></div>
        <div class="kpi"><div>Visitas</div><div id="kpi_visita" class="big">—</div></div>
        <div class="kpi"><div>Propostas</div><div id="kpi_proposta" class="big">—</div></div>
        <div class="kpi"><div>CPCV</div><div id="kpi_cpcv" class="big">—</div></div>
      </div>
      <div class="flex" style="margin-top:10px">
        <div>Potencial agregado:</div>
        <div id="kpi_valor" class="big">—</div>
      </div>
    </div>

    <div class="card">
      <div class="title">Metas mensais por consultor</div>
      <div id="targets"></div>
    </div>

    <div class="card">
      <div class="title">Metas de valor (€) por consultor</div>
      <div id="targetsValor"></div>
    </div>

    <div class="card">
      <div class="title">Leads por consultor</div>
      <canvas id="chartLeads" height="180"></canvas>
    </div>

    <div class="card">
      <div class="title">Valor potencial por consultor (€)</div>
      <canvas id="chartValor" height="180"></canvas>
    </div>

    <div class="card">
      <div class="title">Ranking semanal (últimos 7 dias)</div>
      <div id="ranking" class="list"></div>
    </div>
  </div>

  <script src="https://unpkg.com/chart.js@4.4.0/dist/chart.umd.js" crossorigin="anonymous"></script>
  <script>
    const STORAGE='gpp_kanban_v1';
    const TARGETS='gpp_dashboard_targets';
    const TARGETS_VALOR='gpp_dashboard_targets_valor';

    function loadKanban(){
      try{ return JSON.parse(localStorage.getItem(STORAGE)||'{}'); }catch(_){ return {}; }
    }
    function money(n){ const v=Number(n); return Number.isFinite(v)? v.toLocaleString('pt-PT',{style:'currency',currency:'EUR'}) : '—'; }

    function aggregate(state){
      const cols=['nova','contacto','visita','proposta','cpcv','escritura'];
      const agg={ total:0, valor:0, byCol:{}, byConsultorCount:{}, byConsultorValor:{}, created:{}};
      cols.forEach(c=>{
        const arr=state[c]||[];
        agg.byCol[c]=arr.length; agg.total+=arr.length;
        arr.forEach(it=>{
          const v=Number(it.valor); if(Number.isFinite(v)) agg.valor+=v;
          const k=(it.consultor||'—').trim()||'—';
          agg.byConsultorCount[k]=(agg.byConsultorCount[k]||0)+1;
          if(Number.isFinite(v)) agg.byConsultorValor[k]=(agg.byConsultorValor[k]||0)+v;
          const d=(it.createdAt||'').slice(0,10);
          if(d){ agg.created[d]=(agg.created[d]||0)+1; }
        });
      });
      return agg;
    }

    function renderKPIs(agg){
      document.getElementById('kpi_total').textContent=agg.total;
      document.getElementById('kpi_novas').textContent=agg.byCol.nova||0;
      document.getElementById('kpi_contacto').textContent=agg.byCol.contacto||0;
      document.getElementById('kpi_visita').textContent=agg.byCol.visita||0;
      document.getElementById('kpi_proposta').textContent=agg.byCol.proposta||0;
      document.getElementById('kpi_cpcv').textContent=agg.byCol.cpcv||0;
      document.getElementById('kpi_valor').textContent=money(agg.valor);
    }

    function renderTargets(agg){
      let targets={};
      try{ targets=JSON.parse(localStorage.getItem(TARGETS)||'{}'); }catch(_){}
      const names = Object.keys(agg.byConsultorCount).filter(n=>n!=='—').sort((a,b)=>a.localeCompare(b,'pt'));
      const wrap=document.getElementById('targets'); wrap.innerHTML='';
      names.forEach(name=>{
        const cur=agg.byConsultorCount[name]||0;
        const goal=Number(targets[name]||0);
        const pct=goal>0? Math.min(100, Math.round((cur/goal)*100)) : 0;
        const row=document.createElement('div'); row.className='flex'; row.style.marginBottom='8px';
        row.innerHTML=`
          <div style="min-width:120px"><strong>${name}</strong></div>
          <div class="bar" style="width:240px"><div style="width:${pct}%;"></div></div>
          <div style="min-width:160px;text-align:right">${cur} / <input data-name="${name}" class="input" style="width:70px" placeholder="meta" value="${goal||''}"></div>
          <button class="btn" data-save="${name}">Guardar</button>
        `;
        wrap.appendChild(row);
      });
      wrap.querySelectorAll('[data-save]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const name=btn.getAttribute('data-save');
          const input=wrap.querySelector(`input[data-name="${name}"]`);
          const val=Number(input.value||0);
          let t={}; try{ t=JSON.parse(localStorage.getItem(TARGETS)||'{}'); }catch(_){}
          t[name]=val>0? val : 0;
          localStorage.setItem(TARGETS, JSON.stringify(t));
          alert('Meta atualizada.');
          boot();
        });
      });
    }

    function renderTargetsValor(agg){
      let targets={};
      try{ targets=JSON.parse(localStorage.getItem(TARGETS_VALOR)||'{}'); }catch(_){}
      const names = Object.keys(agg.byConsultorValor).filter(n=>n!=='—').sort((a,b)=>a.localeCompare(b,'pt'));
      const wrap=document.getElementById('targetsValor'); wrap.innerHTML='';
      names.forEach(name=>{
        const cur=agg.byConsultorValor[name]||0;
        const goal=Number(targets[name]||0);
        const pct=goal>0? Math.min(100, Math.round((cur/goal)*100)) : 0;
        const row=document.createElement('div'); row.className='flex'; row.style.marginBottom='8px';
        row.innerHTML=`
          <div style="min-width:120px"><strong>${name}</strong></div>
          <div class="bar" style="width:240px"><div style="width:${pct}%;"></div></div>
          <div style="min-width:220px;text-align:right">${money(cur)} / <input data-name="${name}" class="input" style="width:110px" placeholder="meta €" value="${goal||''}"></div>
          <button class="btn" data-save-v="${name}">Guardar</button>
        `;
        wrap.appendChild(row);
      });
      wrap.querySelectorAll('[data-save-v]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const name=btn.getAttribute('data-save-v');
          const input=wrap.querySelector(`input[data-name="${name}"]`);
          const val=Number(input.value||0);
          let t={}; try{ t=JSON.parse(localStorage.getItem(TARGETS_VALOR)||'{}'); }catch(_){}
          t[name]=val>0? val : 0;
          localStorage.setItem(TARGETS_VALOR, JSON.stringify(t));
          alert('Meta de valor atualizada.');
          boot();
        });
      });
    }

    function renderCharts(agg){
      const ctx1=document.getElementById('chartLeads'); const ctx2=document.getElementById('chartValor');
      const labels=Object.keys(agg.byConsultorCount).filter(n=>n!=='—').sort((a,b)=>a.localeCompare(b,'pt'));
      const dataCount=labels.map(l=>agg.byConsultorCount[l]||0);
      const dataValor=labels.map(l=>Math.round((agg.byConsultorValor[l]||0)));
      const opt={responsive:true, plugins:{legend:{display:false}}, scales:{x:{ticks:{color:'#ddd'}}, y:{ticks:{color:'#ddd'}}}};
      new Chart(ctx1,{type:'bar',data:{labels,datasets:[{data:dataCount}]},options:opt});
      new Chart(ctx2,{type:'bar',data:{labels,datasets:[{data:dataValor}]},options:opt});
    }

    function renderRanking(state){
      const wrap=document.getElementById('ranking'); wrap.innerHTML='';
      const now=new Date();
      const d7=new Date(now.getTime()-7*24*60*60*1000);
      const cols=['nova','contacto','visita','proposta','cpcv','escritura'];
      const byCons={};
      cols.forEach(c=> (state[c]||[]).forEach(it=>{
        const created = it.createdAt ? new Date(it.createdAt) : null;
        if(created && created>=d7){ const k=(it.consultor||'—').trim()||'—'; byCons[k]=(byCons[k]||0)+1; }
      }));
      const arr=Object.entries(byCons).sort((a,b)=>b[1]-a[1]);
      if(!arr.length){ wrap.innerHTML='<div class="row"><div>Sem registos nos últimos 7 dias.</div></div>'; return; }
      arr.forEach(([name,cnt],i)=>{
        const row=document.createElement('div'); row.className='row';
        row.innerHTML=`<div><strong>#${i+1}</strong> ${name}</div><div><strong>${cnt}</strong> novas leads</div>`;
        wrap.appendChild(row);
      });
    }

    document.getElementById('exportCsv').addEventListener('click', ()=>{
      const st=loadKanban(); const cols=['nova','contacto','visita','proposta','cpcv','escritura'];
      const rows=[]; cols.forEach(c=> (st[c]||[]).forEach(it=> rows.push({ coluna:c, ...it })));
      const headers=['coluna','consultor','cliente','telefone','email','etiquetas','imovel','promotor','valor','proxima','quando','origem','prioridade','notas','createdAt'];
      const csv=[headers.join(';')].concat(rows.map(r=>headers.map(h=>String(r[h]??'').replace(/[\r\n]/g,' ').trim()).join(';'))).join('\n');
      const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const a=document.createElement('a');
      a.href=URL.createObjectURL(blob); a.download='dashboard_kanban.csv'; document.body.appendChild(a); a.click(); document.body.removeChild(a);
    });
    document.getElementById('print').addEventListener('click', ()=>window.print());

    function boot(){
      const st=loadKanban();
      const agg=aggregate(st);
      renderKPIs(agg);
      renderTargets(agg);
      renderTargetsValor(agg);
      renderCharts(agg);
      renderRanking(st);
    }
    boot();
  </script>
</body>
</html>
