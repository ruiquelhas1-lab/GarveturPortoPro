<!doctype html>
<html lang="pt-PT">
<head>
  <meta charset="utf-8" />
  <title>Garvetur Porto Pro — Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --gold:#A38B63;
      --gold-soft:rgba(163,139,99,.35);
      --bg:#0B0B0B;
      --panel:#121212;
      --panel-soft:#181818;
      --text:#FFFFFF;
      --muted:#A0A0A0;
      --border:rgba(255,255,255,.12);
      --danger:#F25F5C;
      --success:#4CAF50;
      --warning:#FFC857;
      --radius-lg:18px;
      --radius-md:12px;
      --shadow-soft:0 14px 25px rgba(0,0,0,.4);
    }
    *{box-sizing:border-box;}
    html,body{
      margin:0;
      height:100%;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      background:radial-gradient(circle at top,#1c1c1c 0,#050505 55%,#000 100%);
      color:var(--text);
    }
    body{display:flex;flex-direction:column;}

    .app-shell{
      display:grid;
      grid-template-rows:64px auto;
      height:100%;
    }

    header.app-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 18px;
      border-bottom:1px solid rgba(163,139,99,.35);
      background:linear-gradient(90deg,#050505,#111,#050505);
      position:sticky;
      top:0;
      z-index:20;
      gap:16px;
      flex-wrap:wrap;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .brand-icon{
      width:26px;
      height:26px;
      border-radius:999px;
      border:1px solid var(--gold);
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:0 0 0 1px rgba(163,139,99,.3);
    }
    .brand h1{
      margin:0;
      font-size:17px;
      letter-spacing:.04em;
      text-transform:uppercase;
      color:var(--gold);
    }
    .brand span.sub{
      display:block;
      font-size:11px;
      color:var(--muted);
      letter-spacing:.12em;
      text-transform:uppercase;
    }

    .nav-tabs{
      display:flex;
      align-items:center;
      flex-wrap:wrap;
      gap:4px;
      background:rgba(0,0,0,.35);
      padding:4px;
      border-radius:999px;
      border:1px solid rgba(163,139,99,.35);
    }
    .nav-tab{
      padding:5px 10px;
      border-radius:999px;
      font-size:11px;
      text-decoration:none;
      color:var(--muted);
      letter-spacing:.12em;
      text-transform:uppercase;
      border:1px solid transparent;
      transition:.16s background,.16s color,.16s border-color,.16s transform;
    }
    .nav-tab:hover{
      color:#fff;
      border-color:rgba(163,139,99,.6);
      transform:translateY(-1px);
    }
    .nav-tab.active{
      background:var(--gold);
      color:#0A0A0A;
      border-color:var(--gold);
      font-weight:600;
    }

    .header-actions{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }
    .btn{
      border-radius:999px;
      border:1px solid var(--gold-soft);
      background:rgba(12,12,12,.9);
      color:var(--text);
      padding:7px 12px;
      font-size:13px;
      display:inline-flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
      transition:.18s border-color,.18s background,.18s transform;
    }
    .btn-primary{
      background:var(--gold);
      color:#0A0A0A;
      border-color:var(--gold);
      font-weight:500;
    }
    .btn-ghost{
      background:transparent;
    }
    .btn:hover{
      border-color:var(--gold);
      transform:translateY(-1px);
    }

    .layout{
      display:grid;
      grid-template-columns:280px minmax(0,1fr);
      height:calc(100vh - 64px);
      max-height:calc(100vh - 64px);
      overflow:hidden;
    }
    @media(max-width:960px){
      .layout{
        grid-template-columns:1fr;
        grid-template-rows:auto auto;
        height:auto;
        max-height:none;
      }
    }

    .sidebar{
      border-right:1px solid rgba(163,139,99,.24);
      background:radial-gradient(circle at top left,#141414,#060606);
      padding:12px 14px;
      overflow-y:auto;
    }
    .sidebar-section{
      border-radius:var(--radius-md);
      padding:10px 11px;
      background:rgba(0,0,0,.45);
      border:1px solid rgba(163,139,99,.18);
      margin-bottom:10px;
    }
    .sidebar-section h3{
      margin:0 0 6px;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.16em;
      color:var(--muted);
    }
    .sidebar-section p{
      margin:2px 0 6px;
      font-size:12px;
      color:var(--muted);
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:4px;
      margin-bottom:8px;
    }
    .field-row{
      display:flex;
      gap:6px;
    }
    label.field-label{
      font-size:11px;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.12em;
    }
    input[type="date"],
    select{
      background:rgba(0,0,0,.7);
      color:var(--text);
      border-radius:10px;
      border:1px solid rgba(163,139,99,.22);
      padding:6px 8px;
      font-size:13px;
      outline:none;
      width:100%;
    }
    input:focus,select:focus{
      border-color:var(--gold);
      box-shadow:0 0 0 1px rgba(163,139,99,.35);
    }
    .checks{
      display:flex;
      flex-direction:column;
      gap:4px;
      margin-top:4px;
      font-size:12px;
      color:var(--muted);
    }
    .checks label{
      display:flex;
      align-items:center;
      gap:6px;
    }
    .checks input{
      accent-color:var(--gold);
    }
    .sidebar-buttons{
      display:flex;
      gap:6px;
      margin-top:6px;
    }

    .main-area{
      padding:14px 16px 18px;
      overflow-y:auto;
      background:radial-gradient(circle at top,#1a1a1a,#050505 55%,#000 100%);
    }

    .section-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:10px;
      margin-bottom:10px;
    }
    .section-header h2{
      margin:0;
      font-size:15px;
      letter-spacing:.16em;
      text-transform:uppercase;
      color:var(--muted);
    }
    .section-header p{
      margin:2px 0 0;
      font-size:12px;
      color:var(--muted);
    }
    #contextLabel{
      font-size:11px;
      color:var(--muted);
      text-align:right;
    }

    /* Sub-tabs (Leads / Angariações / Fechos / Tarefas) */
    .subtabs{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-bottom:10px;
      border-radius:999px;
      padding:4px;
      background:rgba(0,0,0,.5);
      border:1px solid rgba(163,139,99,.25);
    }
    .subtab{
      border-radius:999px;
      border:1px solid transparent;
      padding:5px 10px;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.12em;
      color:var(--muted);
      background:transparent;
      cursor:pointer;
      transition:.16s background,.16s color,.16s border-color,.16s transform;
    }
    .subtab.active{
      background:var(--gold);
      color:#000;
      border-color:var(--gold);
      font-weight:600;
    }
    .subtab:hover{
      border-color:rgba(163,139,99,.6);
      transform:translateY(-1px);
    }

    .area{
      display:none;
    }
    .area.active{
      display:block;
    }

    .kpi-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
      gap:10px;
      margin-bottom:14px;
    }
    .kpi-card{
      border-radius:var(--radius-lg);
      border:1px solid rgba(163,139,99,.35);
      background:radial-gradient(circle at top left,#181818,#070707);
      padding:10px 12px;
      box-shadow:var(--shadow-soft);
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .kpi-label{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.14em;
      color:var(--muted);
    }
    .kpi-value{
      font-size:20px;
      font-weight:600;
      color:#fff;
    }
    .kpi-sub{
      font-size:11px;
      color:var(--muted);
    }
    .kpi-badge{
      align-self:flex-start;
      margin-top:4px;
      padding:2px 7px;
      border-radius:999px;
      border:1px solid rgba(163,139,99,.4);
      font-size:10px;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.08em;
    }
    .kpi-badge.ok{border-color:rgba(76,175,80,.7);color:#A5D6A7;}
    .kpi-badge.warn{border-color:rgba(255,200,87,.8);color:#FFE082;}
    .kpi-badge.bad{border-color:rgba(242,95,92,.8);color:#FFABAB;}

    .charts-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
      gap:10px;
      margin-bottom:10px;
    }
    .chart-card{
      border-radius:var(--radius-md);
      border:1px solid rgba(163,139,99,.28);
      background:rgba(0,0,0,.55);
      padding:8px 9px 6px;
    }
    .chart-card h3{
      margin:0 0 4px;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.14em;
      color:var(--muted);
    }
    .chart-card canvas{
      width:100% !important;
      height:200px !important;
    }

    .details-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
      gap:12px;
      margin-top:4px;
    }
    .panel{
      border-radius:var(--radius-md);
      border:1px solid rgba(163,139,99,.28);
      background:rgba(0,0,0,.55);
      padding:9px 10px;
    }
    .panel h3{
      margin:0 0 6px;
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.14em;
      color:var(--muted);
    }
    .panel small{
      font-size:11px;
      color:var(--muted);
    }
    .stat-row{
      display:flex;
      justify-content:space-between;
      font-size:12px;
      margin:2px 0;
      color:var(--muted);
    }
    .stat-row strong{
      color:#f5f5f5;
      font-weight:500;
    }

    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:4px;
      margin-top:4px;
    }
    .chip{
      border-radius:999px;
      padding:2px 7px;
      font-size:10px;
      border:1px solid rgba(163,139,99,.4);
      background:#1B1B1B;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.06em;
    }

    .empty{
      font-size:12px;
      color:var(--muted);
      margin-top:10px;
    }
  </style>

  <!-- Chart.js para os gráficos -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
<div class="app-shell">
  <header class="app-header">
    <div class="brand">
      <div class="brand-icon">
        <svg width="16" height="16" viewBox="0 0 24 24" stroke="var(--gold)" fill="none" stroke-width="1.8">
          <circle cx="12" cy="12" r="9"></circle>
          <path d="M8 12.5l2.5 2.5L16 9"></path>
        </svg>
      </div>
      <div>
        <h1>Garvetur Porto Pro — Dashboard</h1>
        <span class="sub">Visão global — Leads, Angariações, Fechos & Tarefas</span>
      </div>
    </div>

    <nav class="nav-tabs">
      <a href="index.html" class="nav-tab">Início</a>
      <a href="mapa.html" class="nav-tab">Mapa</a>
      <a href="kanban.html" class="nav-tab">Leads</a>
      <a href="angariacoes.html" class="nav-tab">Angariações</a>
      <a href="dashboard.html" class="nav-tab active">Dashboard</a>
      <a href="vendas.html" class="nav-tab">Vendas</a>
      <a href="tarefas.html" class="nav-tab">Tarefas</a>
    </nav>

    <div class="header-actions">
      <button class="btn btn-ghost" id="reloadBtn">Recalcular</button>
    </div>
  </header>

  <div class="layout">
    <aside class="sidebar">
      <div class="sidebar-section">
        <h3>Filtros</h3>
        <div class="field">
          <label class="field-label" for="filterConsultor">Consultor</label>
          <select id="filterConsultor">
            <option value="">Todos</option>
          </select>
        </div>
        <div class="field-row">
          <div class="field">
            <label class="field-label" for="filterDataDe">De</label>
            <input type="date" id="filterDataDe" />
          </div>
          <div class="field">
            <label class="field-label" for="filterDataAte">Até</label>
            <input type="date" id="filterDataAte" />
          </div>
        </div>
        <div class="checks">
          <label><input type="checkbox" id="filterShowHidden"> Mostrar invisíveis</label>
          <label><input type="checkbox" id="filterOnlyHidden"> Só invisíveis</label>
        </div>
        <div class="sidebar-buttons">
          <button class="btn" id="applyFiltersBtn" style="flex:1;">Aplicar</button>
          <button class="btn btn-ghost" id="clearFiltersBtn" style="flex:1;">Limpar</button>
        </div>
        <p style="margin-top:6px;">O período aplica-se à <strong>data da Lead</strong>, <strong>data da Angariação</strong>, fechos e tarefas (data limite).</p>
      </div>

      <div class="sidebar-section">
        <h3>Dicas</h3>
        <p>Use o filtro de <strong>Consultor</strong> para preparar reuniões individuais, combinando com o período (mês, trimestre, ano).</p>
        <p>Os botões <strong>Mostrar/Só invisíveis</strong> ajudam a auditar o que foi retirado da vista principal nos módulos de Leads e Angariações.</p>
      </div>
    </aside>

    <main class="main-area">
      <div class="section-header">
        <div>
          <h2>Visão Geral</h2>
          <p>Resumo consolidado do funil comercial — Leads, Produto, Fechos e Tarefas.</p>
        </div>
        <div id="contextLabel"></div>
      </div>

      <div class="subtabs">
        <button class="subtab active" data-area="leads">Leads</button>
        <button class="subtab" data-area="ang">Angariações</button>
        <button class="subtab" data-area="fechos">Fechos / Negócios</button>
        <button class="subtab" data-area="tarefas">Tarefas</button>
      </div>

      <!-- ÁREA LEADS -->
      <section class="area active" id="areaLeads">
        <div class="kpi-grid" id="kpiLeadsGrid"></div>
        <div class="charts-grid">
          <div class="chart-card">
            <h3>Leads por tipo de negócio</h3>
            <canvas id="chartLeadTipo"></canvas>
          </div>
          <div class="chart-card">
            <h3>Classificação (1–5)</h3>
            <canvas id="chartLeadClass"></canvas>
          </div>
          <div class="chart-card">
            <h3>Perfil (Investidor / Cliente final)</h3>
            <canvas id="chartLeadPerfil"></canvas>
          </div>
          <div class="chart-card">
            <h3>Tipologia mais procurada</h3>
            <canvas id="chartLeadTipologia"></canvas>
          </div>
        </div>

        <div class="details-grid">
          <div class="panel">
            <h3>Distribuição por imóvel</h3>
            <small>Contagem por tipo de imóvel nas leads filtradas.</small>
            <div id="leadImovelStats"></div>
          </div>
          <div class="panel">
            <h3>Zonas preferenciais (Top)</h3>
            <small>Zonas mais mencionadas nas leads visíveis com filtros atuais.</small>
            <div id="leadZonaStats"></div>
          </div>
          <div class="panel">
            <h3>Resumo de classificações</h3>
            <small>Mistura de leads “frias” e “quentes”.</small>
            <div id="leadClassStats"></div>
          </div>
        </div>
      </section>

      <!-- ÁREA ANGARIAÇÕES -->
      <section class="area" id="areaAng">
        <div class="kpi-grid" id="kpiAngGrid"></div>
        <div class="charts-grid">
          <div class="chart-card">
            <h3>Exclusivo vs Não exclusivo</h3>
            <canvas id="chartAngExclusivo"></canvas>
          </div>
          <div class="chart-card">
            <h3>Empreendimentos vs Unidade isolada</h3>
            <canvas id="chartAngEmp"></canvas>
          </div>
          <div class="chart-card">
            <h3>Natureza do imóvel</h3>
            <canvas id="chartAngNatureza"></canvas>
          </div>
          <div class="chart-card">
            <h3>Comissão média por intervalo</h3>
            <canvas id="chartAngComissao"></canvas>
          </div>
        </div>

        <div class="details-grid">
          <div class="panel">
            <h3>Estado do imóvel</h3>
            <small>Novo, usado, remodelado, etc.</small>
            <div id="angEstadoImovelStats"></div>
          </div>
          <div class="panel">
            <h3>Valores médios</h3>
            <small>Produto médio por angariação.</small>
            <div id="angValoresMedios"></div>
          </div>
          <div class="panel">
            <h3>Resumo por consultor</h3>
            <small>Quantidade e volume de produto.</small>
            <div id="angConsultorResumo"></div>
          </div>
        </div>
      </section>

      <!-- ÁREA FECHOS / NEGÓCIOS -->
      <section class="area" id="areaFechos">
        <div class="kpi-grid" id="kpiFechosGrid"></div>
        <div class="charts-grid">
          <div class="chart-card">
            <h3>Negócios por mês (Leads Fecho)</h3>
            <canvas id="chartFechosMes"></canvas>
          </div>
          <div class="chart-card">
            <h3>Negócios por consultor</h3>
            <canvas id="chartFechosConsultor"></canvas>
          </div>
        </div>

        <div class="details-grid">
          <div class="panel">
            <h3>Origem dos negócios</h3>
            <small>Leads fechadas vs angariações aprovadas.</small>
            <div id="fechosOrigemStats"></div>
          </div>
          <div class="panel">
            <h3>Ticket médio por tipo de negócio</h3>
            <small>Compra, venda, arrendamento, etc.</small>
            <div id="fechosTipoStats"></div>
          </div>
          <div class="panel">
            <h3>Resumo financeiro</h3>
            <small>Volumes e comissões estimadas.</small>
            <div id="fechosResumoFinanceiro"></div>
          </div>
        </div>
      </section>

      <!-- ÁREA TAREFAS -->
      <section class="area" id="areaTarefas">
        <div class="kpi-grid" id="kpiTarefasGrid"></div>
        <div class="charts-grid">
          <div class="chart-card">
            <h3>Tarefas por estado</h3>
            <canvas id="chartTarefasEstado"></canvas>
          </div>
          <div class="chart-card">
            <h3>Tarefas por prioridade</h3>
            <canvas id="chartTarefasPrioridade"></canvas>
          </div>
          <div class="chart-card">
            <h3>Tarefas por tipo</h3>
            <canvas id="chartTarefasTipo"></canvas>
          </div>
          <div class="chart-card">
            <h3>Tarefas por consultor</h3>
            <canvas id="chartTarefasConsultor"></canvas>
          </div>
        </div>

        <div class="details-grid">
          <div class="panel">
            <h3>Estado & atraso</h3>
            <small>Situação das tarefas abertas.</small>
            <div id="tarefasEstadoStats"></div>
          </div>
          <div class="panel">
            <h3>Resumo de prazos</h3>
            <small>Limites, atrasos e carga média.</small>
            <div id="tarefasPrazoStats"></div>
          </div>
          <div class="panel">
            <h3>Notas rápidas</h3>
            <small>Pontos para reunião de pipeline.</small>
            <div id="tarefasNotas" class="chips"></div>
          </div>
        </div>
      </section>

      <div id="emptyState" class="empty" style="display:none;">
        Ainda não existem dados nas Leads, Angariações, Fechos ou Tarefas com os filtros atuais.
      </div>
    </main>
  </div>
</div>

<script>
(function(){
  const STORAGE_LEADS = 'gpp_leads_v5';
  const STORAGE_ANG   = 'gpp_angariacoes_v2';
  const STORAGE_TAR   = 'gpp_tarefas_v1';
  const DASH_FILTERS  = 'gpp_dashboard_filters_v2';

  const filterConsultor   = document.getElementById('filterConsultor');
  const filterDataDe      = document.getElementById('filterDataDe');
  const filterDataAte     = document.getElementById('filterDataAte');
  const filterShowHidden  = document.getElementById('filterShowHidden');
  const filterOnlyHidden  = document.getElementById('filterOnlyHidden');
  const applyFiltersBtn   = document.getElementById('applyFiltersBtn');
  const clearFiltersBtn   = document.getElementById('clearFiltersBtn');
  const reloadBtn         = document.getElementById('reloadBtn');

  const contextLabel   = document.getElementById('contextLabel');
  const emptyState     = document.getElementById('emptyState');

  const kpiLeadsGrid   = document.getElementById('kpiLeadsGrid');
  const kpiAngGrid     = document.getElementById('kpiAngGrid');
  const kpiFechosGrid  = document.getElementById('kpiFechosGrid');
  const kpiTarefasGrid = document.getElementById('kpiTarefasGrid');

  const leadImovelStats   = document.getElementById('leadImovelStats');
  const leadZonaStats     = document.getElementById('leadZonaStats');
  const leadClassStats    = document.getElementById('leadClassStats');

  const angEstadoImovelStats = document.getElementById('angEstadoImovelStats');
  const angValoresMedios     = document.getElementById('angValoresMedios');
  const angConsultorResumo   = document.getElementById('angConsultorResumo');

  const fechosOrigemStats      = document.getElementById('fechosOrigemStats');
  const fechosTipoStats        = document.getElementById('fechosTipoStats');
  const fechosResumoFinanceiro = document.getElementById('fechosResumoFinanceiro');

  const tarefasEstadoStats = document.getElementById('tarefasEstadoStats');
  const tarefasPrazoStats  = document.getElementById('tarefasPrazoStats');
  const tarefasNotas       = document.getElementById('tarefasNotas');

  const CHARTS = {}; // para destruir/recriar Chart.js

  let allLeads = [];
  let allDeals = [];
  let allTasks = [];

  let FILTER = {
    consultor:'',
    de:'',
    ate:'',
    showHidden:false,
    onlyHidden:false
  };

  function parseNum(v){
    if(v===null || v===undefined || v==='') return 0;
    const n = parseFloat(String(v).replace(',','.'));
    return isFinite(n) ? n : 0;
  }
  function parsePct(v){
    if(v===null || v===undefined || v==='') return NaN;
    const n = parseFloat(String(v).replace(',','.'));
    return isFinite(n) ? n : NaN;
  }
  function formatMoney(n){
    const v = parseNum(n);
    if(!isFinite(v) || v === 0) return '€ 0';
    return v.toLocaleString('pt-PT',{style:'currency',currency:'EUR',maximumFractionDigits:0});
  }
  function formatPct(n){
    const v = parsePct(n);
    if(!isFinite(v)) return '—';
    return v.toFixed(1).replace('.',',') + '%';
  }
  function todayISO(){
    const d = new Date();
    return d.toISOString().slice(0,10);
  }

  function loadLeads(){
    try{
      const raw = localStorage.getItem(STORAGE_LEADS);
      const parsed = raw ? JSON.parse(raw) : [];
      allLeads = Array.isArray(parsed) ? parsed : [];
    }catch(e){
      console.error('Erro a ler leads:',e);
      allLeads = [];
    }
  }

  function loadAngariacoes(){
    try{
      const raw = localStorage.getItem(STORAGE_ANG);
      const parsed = raw ? JSON.parse(raw) : {};
      allDeals = (parsed && Array.isArray(parsed.deals)) ? parsed.deals : [];
    }catch(e){
      console.error('Erro a ler angariações:',e);
      allDeals = [];
    }
  }

  function loadTarefas(){
    try{
      const raw = localStorage.getItem(STORAGE_TAR);
      const parsed = raw ? JSON.parse(raw) : {};
      allTasks = (parsed && Array.isArray(parsed.tasks)) ? parsed.tasks : [];
    }catch(e){
      console.error('Erro a ler tarefas:',e);
      allTasks = [];
    }
  }

  function loadFilters(){
    try{
      const raw = localStorage.getItem(DASH_FILTERS);
      if(!raw) return;
      const parsed = JSON.parse(raw);
      if(parsed && typeof parsed === 'object'){
        FILTER = Object.assign(FILTER, parsed);
      }
    }catch{}
  }
  function saveFilters(){
    try{
      localStorage.setItem(DASH_FILTERS, JSON.stringify(FILTER));
    }catch{}
  }
  function applyFiltersToControls(){
    filterConsultor.value = FILTER.consultor || '';
    filterDataDe.value    = FILTER.de || '';
    filterDataAte.value   = FILTER.ate || '';
    filterShowHidden.checked = !!FILTER.showHidden;
    filterOnlyHidden.checked = !!FILTER.onlyHidden;
  }
  function updateFiltersFromControls(){
    FILTER.consultor   = filterConsultor.value || '';
    FILTER.de          = filterDataDe.value || '';
    FILTER.ate         = filterDataAte.value || '';
    FILTER.showHidden  = filterShowHidden.checked;
    FILTER.onlyHidden  = filterOnlyHidden.checked;
  }

  function buildConsultorOptions(){
    const set = new Set();
    allLeads.forEach(l => { if(l && l.consultor) set.add(l.consultor); });
    allDeals.forEach(d => { if(d && d.consultor) set.add(d.consultor); });
    allTasks.forEach(t => { if(t && t.responsavel) set.add(t.responsavel); });

    const current = filterConsultor.value;
    filterConsultor.innerHTML = '<option value="">Todos</option>';
    Array.from(set).sort().forEach(name=>{
      const opt = document.createElement('option');
      opt.value = name;
      opt.textContent = name;
      filterConsultor.appendChild(opt);
    });
    if(current && set.has(current)){
      filterConsultor.value = current;
    }
  }

  function filterLeads(){
    let arr = allLeads.slice();
    if(FILTER.consultor){
      arr = arr.filter(l => (l.consultor || '') === FILTER.consultor);
    }
    if(FILTER.de){
      arr = arr.filter(l => !l.data || l.data >= FILTER.de);
    }
    if(FILTER.ate){
      arr = arr.filter(l => !l.data || l.data <= FILTER.ate);
    }
    if(FILTER.onlyHidden){
      arr = arr.filter(l => l.visivel === false);
    }else if(!FILTER.showHidden){
      arr = arr.filter(l => l.visivel !== false);
    }
    return arr;
  }

  function filterDeals(){
    let arr = allDeals.slice();
    if(FILTER.consultor){
      arr = arr.filter(d => (d.consultor || '') === FILTER.consultor);
    }
    if(FILTER.de){
      arr = arr.filter(d => !d.dataAngariacao || d.dataAngariacao >= FILTER.de);
    }
    if(FILTER.ate){
      arr = arr.filter(d => !d.dataAngariacao || d.dataAngariacao <= FILTER.ate);
    }
    if(FILTER.onlyHidden){
      arr = arr.filter(d => d.visible === false);
    }else if(!FILTER.showHidden){
      arr = arr.filter(d => d.visible !== false);
    }
    return arr;
  }

  function filterTasks(){
    let arr = allTasks.slice();
    if(FILTER.consultor){
      arr = arr.filter(t => (t.responsavel || '') === FILTER.consultor);
    }
    if(FILTER.de){
      arr = arr.filter(t => !t.dataLimite || t.dataLimite >= FILTER.de);
    }
    if(FILTER.ate){
      arr = arr.filter(t => !t.dataLimite || t.dataLimite <= FILTER.ate);
    }
    return arr;
  }

  function updateContextLabel(){
    const parts = [];
    if(FILTER.consultor) parts.push('Consultor: ' + FILTER.consultor);
    if(FILTER.de || FILTER.ate){
      parts.push('Período: ' + (FILTER.de||'…') + ' a ' + (FILTER.ate||'…'));
    }
    contextLabel.textContent = parts.length ? parts.join(' | ') : 'Sem filtros — visão global';
  }

  /* Helpers gráficos */
  function destroyChart(key){
    if(CHARTS[key]){
      CHARTS[key].destroy();
      CHARTS[key] = null;
    }
  }
  function createChart(key, ctx, config){
    destroyChart(key);
    CHARTS[key] = new Chart(ctx, config);
  }

  /* ====== LEADS ====== */
  function renderLeadsArea(leads){
    kpiLeadsGrid.innerHTML = '';
    leadImovelStats.innerHTML = '';
    leadZonaStats.innerHTML   = '';
    leadClassStats.innerHTML  = '';

    const total = leads.length;
    const fechos = leads.filter(l => l.estado === 'Fecho');
    const totalFecho = fechos.length;
    const taxaFecho = total ? (totalFecho/total*100) : 0;

    let somaNegocio = 0;
    let somaClass   = 0;
    let contaClass  = 0;
    leads.forEach(l=>{
      if(l.fecho_negocio){
        somaNegocio += parseNum(l.fecho_negocio);
      }
      if(l.classificacao){
        somaClass += parseNum(l.classificacao);
        contaClass++;
      }
    });
    const ticketMedio = totalFecho ? somaNegocio/totalFecho : 0;
    const classMedia  = contaClass ? somaClass/contaClass : NaN;

    const kpis = [
      {
        label:'Leads (filtros atuais)',
        value: total,
        sub: 'Total de leads após filtros e regras de visibilidade',
        badge: totalFecho ? `${totalFecho} em Fecho` : ''
      },
      {
        label:'Taxa de fecho',
        value: total ? taxaFecho.toFixed(1).replace('.',',') + '%' : '—',
        sub: total ? `${totalFecho} fechos em ${total} leads` : 'Sem leads nos filtros atuais',
        badge: total ? (taxaFecho>=20?'Saudável':(taxaFecho>=10?'Atenção':'Baixa')) : '',
        badgeClass: total ? (taxaFecho>=20?'ok':(taxaFecho>=10?'warn':'bad')) : ''
      },
      {
        label:'Ticket médio (Fecho)',
        value: formatMoney(ticketMedio),
        sub: 'Valor médio de negócio nas leads em Fecho',
        badge: totalFecho ? 'Volume Fecho ' + formatMoney(somaNegocio) : ''
      },
      {
        label:'Classificação média',
        value: isFinite(classMedia)? classMedia.toFixed(1).replace('.',',') : '—',
        sub: 'Baseada nas classificações 1–5 das leads',
        badge:''
      }
    ];

    kpis.forEach(k=>{
      const card = document.createElement('div');
      card.className = 'kpi-card';
      card.innerHTML = `
        <div class="kpi-label">${k.label}</div>
        <div class="kpi-value">${k.value}</div>
        <div class="kpi-sub">${k.sub || ''}</div>
      `;
      if(k.badge){
        const b = document.createElement('div');
        b.className = 'kpi-badge';
        if(k.badgeClass) b.classList.add(k.badgeClass);
        b.textContent = k.badge;
        card.appendChild(b);
      }
      kpiLeadsGrid.appendChild(card);
    });

    const countBy = (arr, fn) => {
      const m = {};
      arr.forEach(item=>{
        const key = fn(item);
        if(!key) return;
        m[key] = (m[key]||0)+1;
      });
      return m;
    };

    const tipoMap      = countBy(leads, l=>l.tipo_negocio || '');
    const classMap     = countBy(leads, l=>l.classificacao || '');
    const perfilMap    = countBy(leads, l=>l.perfil || '');
    const tipologiaMap = countBy(leads, l=>l.tipologia || '');
    const imovelMap    = countBy(leads, l=>l.imovel || '');
    const zonaMap      = countBy(leads, l=>(l.zona||'').trim().toLowerCase());

    /* Gráficos */
    const ctxTipo   = document.getElementById('chartLeadTipo').getContext('2d');
    const ctxClass  = document.getElementById('chartLeadClass').getContext('2d');
    const ctxPerfil = document.getElementById('chartLeadPerfil').getContext('2d');
    const ctxTip    = document.getElementById('chartLeadTipologia').getContext('2d');

    const tipoLabels = Object.keys(tipoMap);
    const tipoValues = tipoLabels.map(k=>tipoMap[k]);
    createChart('leadTipo', ctxTipo, {
      type:'bar',
      data:{
        labels: tipoLabels,
        datasets:[{label:'Leads', data:tipoValues, backgroundColor:'rgba(163,139,99,0.8)'}]
      },
      options:{plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}}}
    });

    const classLabels = ['1','2','3','4','5'];
    const classValues = classLabels.map(k=>classMap[k]||0);
    createChart('leadClass', ctxClass, {
      type:'bar',
      data:{
        labels: classLabels,
        datasets:[{label:'Leads', data:classValues, backgroundColor:'rgba(163,139,99,0.8)'}]
      },
      options:{plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}}}
    });

    const perfilLabels = ['Investidor','Cliente final'];
    const perfilValues = perfilLabels.map(lbl=>{
      if(lbl==='Investidor') return perfilMap['Investidor']||0;
      if(lbl==='Cliente final') return perfilMap['Cliente final']||0;
      return 0;
    });
    createChart('leadPerfil', ctxPerfil, {
      type:'pie',
      data:{
        labels: perfilLabels,
        datasets:[{data:perfilValues, backgroundColor:['rgba(163,139,99,0.9)','rgba(120,120,120,0.9)']}]
      },
      options:{plugins:{legend:{position:'bottom'}}}
    });

    const tipLabels = Object.keys(tipologiaMap);
    const tipValues = tipLabels.map(k=>tipologiaMap[k]);
    createChart('leadTipologia', ctxTip, {
      type:'bar',
      data:{
        labels: tipLabels,
        datasets:[{label:'Leads', data:tipValues, backgroundColor:'rgba(163,139,99,0.8)'}]
      },
      options:{plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}}}
    });

    // Imóvel
    Object.keys(imovelMap).sort((a,b)=>imovelMap[b]-imovelMap[a]).forEach(k=>{
      const row = document.createElement('div');
      row.className = 'stat-row';
      row.innerHTML = `<span>${k||'—'}</span><span><strong>${imovelMap[k]}</strong></span>`;
      leadImovelStats.appendChild(row);
    });

    // Zonas top
    const zonasSorted = Object.entries(zonaMap)
      .filter(([z])=>z)
      .sort((a,b)=>b[1]-a[1])
      .slice(0,8);
    if(zonasSorted.length===0){
      leadZonaStats.textContent = 'Sem zonas preferenciais nos filtros atuais.';
    }else{
      zonasSorted.forEach(([z,count])=>{
        const row = document.createElement('div');
        row.className = 'stat-row';
        row.innerHTML = `<span>${z}</span><span><strong>${count}</strong></span>`;
        leadZonaStats.appendChild(row);
      });
    }

    // Summary classificações
    ['1','2','3','4','5'].forEach(k=>{
      const row = document.createElement('div');
      row.className='stat-row';
      const labelMap = {
        '1':'Lead sem interesse',
        '2':'Partilha',
        '3':'Sem resposta',
        '4':'Info s/ imóvel',
        '5':'Quer visita'
      };
      row.innerHTML = `<span>${k} — ${labelMap[k]||''}</span><span><strong>${classMap[k]||0}</strong></span>`;
      leadClassStats.appendChild(row);
    });
  }

  /* ====== ANGARIAÇÕES ====== */
  function renderAngArea(deals){
    kpiAngGrid.innerHTML = '';
    angEstadoImovelStats.innerHTML = '';
    angValoresMedios.innerHTML = '';
    angConsultorResumo.innerHTML = '';

    const total = deals.length;
    const excl   = deals.filter(d=>d.exclusivo).length;
    const naoExcl= deals.filter(d=>d.naoExclusivo).length;
    const empr   = deals.filter(d=>d.isEmpreendimento).length;

    let somaPreco = 0;
    deals.forEach(d=>{ somaPreco += parseNum(d.precoPedido); });
    const mediaPreco = total ? somaPreco/total : 0;

    let somaCom = 0, contaCom = 0;
    deals.forEach(d=>{
      let pct = NaN;
      if(d.comissao === 'outro' && d.comissaoOutro){
        pct = parsePct(d.comissaoOutro);
      }else if(d.comissao){
        pct = parsePct(d.comissao);
      }
      if(isFinite(pct)){
        somaCom += pct;
        contaCom++;
      }
    });
    const mediaCom = contaCom ? somaCom/contaCom : NaN;

    const kpis = [
      {
        label:'Angariações (filtros atuais)',
        value: total,
        sub:'Produto ativo após filtros e visibilidade',
        badge: total ? `Exclusivo: ${excl} · Não exclusivo: ${naoExcl}` : ''
      },
      {
        label:'Empreendimentos',
        value: empr,
        sub:'Número de angariações marcadas como empreendimentos',
        badge: total ? Math.round(empr/total*100)+'% do total' : ''
      },
      {
        label:'Valor médio',
        value: formatMoney(mediaPreco),
        sub:'Preço pedido médio por angariação',
        badge: somaPreco ? 'Volume total ' + formatMoney(somaPreco) : ''
      },
      {
        label:'Comissão média',
        value: isFinite(mediaCom)? mediaCom.toFixed(1).replace('.',',')+'%' : '—',
        sub:'Média simples da comissão configurada',
        badge:''
      }
    ];

    kpis.forEach(k=>{
      const card = document.createElement('div');
      card.className = 'kpi-card';
      card.innerHTML = `
        <div class="kpi-label">${k.label}</div>
        <div class="kpi-value">${k.value}</div>
        <div class="kpi-sub">${k.sub||''}</div>
      `;
      if(k.badge){
        const b = document.createElement('div');
        b.className = 'kpi-badge';
        b.textContent = k.badge;
        card.appendChild(b);
      }
      kpiAngGrid.appendChild(card);
    });

    const countBy = (arr, fn) => {
      const m={};
      arr.forEach(d=>{
        const key = fn(d);
        if(!key) return;
        m[key] = (m[key]||0)+1;
      });
      return m;
    };

    const exclusivoMap = { 'Exclusivo':excl, 'Não exclusivo':naoExcl };
    const empMap       = { 'Empreendimento':empr, 'Unidade isolada': total - empr };

    const naturezaMap  = countBy(deals,d=>d.naturezaImovel || '');
    const estadoImMap  = countBy(deals,d=>d.estadoImovel || '');

    const comBuckets   = {'≤3%':0,'3–5%':0,'>5%':0};
    deals.forEach(d=>{
      let pct = NaN;
      if(d.comissao === 'outro' && d.comissaoOutro){
        pct = parsePct(d.comissaoOutro);
      }else if(d.comissao){
        pct = parsePct(d.comissao);
      }
      if(!isFinite(pct)) return;
      if(pct<=3) comBuckets['≤3%']++;
      else if(pct<=5) comBuckets['3–5%']++;
      else comBuckets['>5%']++;
    });

    const ctxExcl    = document.getElementById('chartAngExclusivo').getContext('2d');
    const ctxEmp     = document.getElementById('chartAngEmp').getContext('2d');
    const ctxNat     = document.getElementById('chartAngNatureza').getContext('2d');
    const ctxCom     = document.getElementById('chartAngComissao').getContext('2d');

    createChart('angExcl', ctxExcl, {
      type:'pie',
      data:{
        labels:Object.keys(exclusivoMap),
        datasets:[{data:Object.values(exclusivoMap),backgroundColor:['rgba(163,139,99,0.9)','rgba(120,120,120,0.9)']}]
      },
      options:{plugins:{legend:{position:'bottom'}}}
    });

    createChart('angEmp', ctxEmp, {
      type:'doughnut',
      data:{
        labels:Object.keys(empMap),
        datasets:[{data:Object.values(empMap),backgroundColor:['rgba(163,139,99,0.9)','rgba(80,80,80,0.9)']}]
      },
      options:{plugins:{legend:{position:'bottom'}}}
    });

    const natLabels = Object.keys(naturezaMap);
    const natValues = natLabels.map(k=>naturezaMap[k]);
    createChart('angNat', ctxNat,{
      type:'bar',
      data:{labels:natLabels,datasets:[{data:natValues,backgroundColor:'rgba(163,139,99,0.8)'}]},
      options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
    });

    const comLabels = Object.keys(comBuckets);
    const comValues = comLabels.map(k=>comBuckets[k]);
    createChart('angCom', ctxCom,{
      type:'bar',
      data:{labels:comLabels,datasets:[{data:comValues,backgroundColor:'rgba(163,139,99,0.8)'}]},
      options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
    });

    // Estado do imóvel
    Object.keys(estadoImMap).sort((a,b)=>estadoImMap[b]-estadoImMap[a]).forEach(k=>{
      const row = document.createElement('div');
      row.className='stat-row';
      row.innerHTML = `<span>${k||'—'}</span><span><strong>${estadoImMap[k]}</strong></span>`;
      angEstadoImovelStats.appendChild(row);
    });

    // Valores médios
    const row1 = document.createElement('div');
    row1.className='stat-row';
    row1.innerHTML = `<span>Valor médio</span><span><strong>${formatMoney(mediaPreco)}</strong></span>`;
    angValoresMedios.appendChild(row1);

    const row2 = document.createElement('div');
    row2.className='stat-row';
    row2.innerHTML = `<span>Volume total</span><span><strong>${formatMoney(somaPreco)}</strong></span>`;
    angValoresMedios.appendChild(row2);

    const row3 = document.createElement('div');
    row3.className='stat-row';
    row3.innerHTML = `<span>Comissão média</span><span><strong>${isFinite(mediaCom)? mediaCom.toFixed(1).replace('.',',')+'%' : '—'}</strong></span>`;
    angValoresMedios.appendChild(row3);

    // Por consultor
    const porCons={};
    deals.forEach(d=>{
      const c = d.consultor||'';
      if(!c) return;
      if(!porCons[c]) porCons[c] = {q:0,vol:0};
      porCons[c].q++;
      porCons[c].vol += parseNum(d.precoPedido);
    });
    if(Object.keys(porCons).length===0){
      angConsultorResumo.textContent='Sem dados por consultor.';
    }else{
      Object.entries(porCons).sort((a,b)=>b[1].vol-a[1].vol).forEach(([nome,info])=>{
        const row = document.createElement('div');
        row.className='stat-row';
        row.innerHTML = `<span>${nome} (${info.q})</span><span><strong>${formatMoney(info.vol)}</strong></span>`;
        angConsultorResumo.appendChild(row);
      });
    }
  }

  /* ====== FECHOS / NEGÓCIOS ====== */
  function renderFechosArea(leads, deals){
    kpiFechosGrid.innerHTML='';
    fechosOrigemStats.innerHTML='';
    fechosTipoStats.innerHTML='';
    fechosResumoFinanceiro.innerHTML='';

    const fechosLeads = leads.filter(l=>l.estado==='Fecho');
    const aprovados   = deals.filter(d=>d.estadoAng==='aprovado');

    let volFechos = 0;
    let volCom    = 0;
    let diasTot   = 0;
    let diasCount = 0;

    const tipoAgg = {};
    const porCons = {};

    fechosLeads.forEach(l=>{
      const valor = parseNum(l.fecho_negocio || l.valor);
      volFechos += valor;

      const pct = parsePct(l.fecho_comissao_pct);
      if(isFinite(pct)) volCom += valor*(pct/100);

      const tipo = l.tipo_negocio || '—';
      if(!tipoAgg[tipo]) tipoAgg[tipo]={q:0,vol:0};
      tipoAgg[tipo].q++;
      tipoAgg[tipo].vol += valor;

      const c = l.consultor||'';
      if(c){
        if(!porCons[c]) porCons[c]={q:0,vol:0};
        porCons[c].q++;
        porCons[c].vol += valor;
      }

      if(l.data && l.fecho_cpcv_date){
        const d1 = new Date(l.data);
        const d2 = new Date(l.fecho_cpcv_date);
        if(!isNaN(d1.getTime()) && !isNaN(d2.getTime())){
          const diff = (d2-d1)/(1000*60*60*24);
          diasTot += diff;
          diasCount++;
        }
      }
    });

    const ticketMedio = fechosLeads.length ? volFechos/fechosLeads.length : 0;
    const tempoMedio  = diasCount ? diasTot/diasCount : NaN;

    let volAprovados = 0;
    aprovados.forEach(a=>{
      volAprovados += parseNum(a.precoPedido);
    });

    const kpis = [
      {
        label:'Negócios fechados (Leads)',
        value: fechosLeads.length,
        sub:'Baseado em leads em Fecho com filtros atuais',
        badge: fechosLeads.length ? 'Ticket médio '+formatMoney(ticketMedio) : ''
      },
      {
        label:'Volume de negócios (Leads)',
        value: formatMoney(volFechos),
        sub:'Somatório do valor de negócio das leads fechadas',
        badge: volCom ? 'Comissão estimada '+formatMoney(volCom) : ''
      },
      {
        label:'Carteira aprovada',
        value: aprovados.length,
        sub:'Angariações em Aprovado (carteira pronta a vender)',
        badge: volAprovados ? 'Volume carteira '+formatMoney(volAprovados) : ''
      },
      {
        label:'Tempo médio até CPCV',
        value: isFinite(tempoMedio)? Math.round(tempoMedio)+' dias' : '—',
        sub:'Entre data da lead e data do CPCV (quando preenchido)',
        badge:''
      }
    ];
    kpis.forEach(k=>{
      const card=document.createElement('div');
      card.className='kpi-card';
      card.innerHTML=`
        <div class="kpi-label">${k.label}</div>
        <div class="kpi-value">${k.value}</div>
        <div class="kpi-sub">${k.sub||''}</div>
      `;
      if(k.badge){
        const b=document.createElement('div');
        b.className='kpi-badge';
        b.textContent=k.badge;
        card.appendChild(b);
      }
      kpiFechosGrid.appendChild(card);
    });

    // Origem
    const row1=document.createElement('div');
    row1.className='stat-row';
    row1.innerHTML=`<span>Leads em Fecho</span><span><strong>${fechosLeads.length}</strong> (${formatMoney(volFechos)})</span>`;
    fechosOrigemStats.appendChild(row1);

    const row2=document.createElement('div');
    row2.className='stat-row';
    row2.innerHTML=`<span>Angariações aprovadas</span><span><strong>${aprovados.length}</strong> (${formatMoney(volAprovados)})</span>`;
    fechosOrigemStats.appendChild(row2);

    // Tipo de negócio
    Object.entries(tipoAgg).forEach(([tipo,info])=>{
      const r=document.createElement('div');
      r.className='stat-row';
      r.innerHTML=`<span>${tipo}</span><span><strong>${info.q}</strong> (${formatMoney(info.vol)})</span>`;
      fechosTipoStats.appendChild(r);
    });

    // Resumo financeiro
    const r1=document.createElement('div');
    r1.className='stat-row';
    r1.innerHTML=`<span>Volume negócios (Leads)</span><span><strong>${formatMoney(volFechos)}</strong></span>`;
    fechosResumoFinanceiro.appendChild(r1);
    const r2=document.createElement('div');
    r2.className='stat-row';
    r2.innerHTML=`<span>Comissão estimada</span><span><strong>${formatMoney(volCom)}</strong></span>`;
    fechosResumoFinanceiro.appendChild(r2);
    const r3=document.createElement('div');
    r3.className='stat-row';
    r3.innerHTML=`<span>Volume carteira aprovada</span><span><strong>${formatMoney(volAprovados)}</strong></span>`;
    fechosResumoFinanceiro.appendChild(r3);

    // Gráficos
    const ctxMes  = document.getElementById('chartFechosMes').getContext('2d');
    const ctxCons = document.getElementById('chartFechosConsultor').getContext('2d');

    const porMes = {};
    fechosLeads.forEach(l=>{
      const ds = l.fecho_cpcv_date || l.data || '';
      if(!ds) return;
      const d = new Date(ds);
      if(isNaN(d.getTime())) return;
      const key = d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0');
      porMes[key]=(porMes[key]||0)+1;
    });
    const mesLabels = Object.keys(porMes).sort();
    const mesVals   = mesLabels.map(k=>porMes[k]);
    createChart('fechosMes', ctxMes,{
      type:'line',
      data:{labels:mesLabels,datasets:[{label:'Negócios',data:mesVals,borderColor:'rgba(163,139,99,0.9)',backgroundColor:'rgba(163,139,99,0.2)',tension:0.2}]},
      options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
    });

    const consLabels = Object.keys(porCons);
    const consVals   = consLabels.map(k=>porCons[k].q);
    createChart('fechosCons', ctxCons,{
      type:'bar',
      data:{labels:consLabels,datasets:[{data:consVals,backgroundColor:'rgba(163,139,99,0.8)'}]},
      options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
    });
  }

  /* ====== TAREFAS ====== */
  function renderTarefasArea(tasks){
    kpiTarefasGrid.innerHTML='';
    tarefasEstadoStats.innerHTML='';
    tarefasPrazoStats.innerHTML='';
    tarefasNotas.innerHTML='';

    const total = tasks.length;
    const concluidas = tasks.filter(t=>t.estado==='concluida').length;
    const canceladas = tasks.filter(t=>t.estado==='cancelada').length;
    const abertas = total - concluidas - canceladas;
    const criticas = tasks.filter(t=>t.prioridade==='critica').length;

    const hoje = todayISO();
    const atrasadas = tasks.filter(t=>{
      if(!t.dataLimite) return false;
      return t.dataLimite < hoje && t.estado!=='concluida' && t.estado!=='cancelada';
    }).length;

    const kpis = [
      {
        label:'Tarefas (filtros atuais)',
        value: total,
        sub:'Total de tarefas encontradas',
        badge:''
      },
      {
        label:'Em aberto',
        value: abertas,
        sub:'Por fazer ou em curso',
        badge: atrasadas ? atrasadas+' atrasadas' : ''
      },
      {
        label:'Concluídas',
        value: concluidas,
        sub:'Tarefas marcadas como concluídas',
        badge:''
      },
      {
        label:'Críticas',
        value: criticas,
        sub:'Prioridade crítica',
        badge:''
      }
    ];
    kpis.forEach(k=>{
      const card=document.createElement('div');
      card.className='kpi-card';
      card.innerHTML=`
        <div class="kpi-label">${k.label}</div>
        <div class="kpi-value">${k.value}</div>
        <div class="kpi-sub">${k.sub||''}</div>
      `;
      if(k.badge){
        const b=document.createElement('div');
        b.className='kpi-badge';
        b.textContent=k.badge;
        card.appendChild(b);
      }
      kpiTarefasGrid.appendChild(card);
    });

    const countBy = (arr, fn)=>{
      const m={};
      arr.forEach(t=>{
        const k = fn(t);
        if(!k) return;
        m[k]=(m[k]||0)+1;
      });
      return m;
    };

    const estadoMap = countBy(tasks,t=>t.estado||'');
    const prioMap   = countBy(tasks,t=>t.prioridade||'');
    const tipoMap   = countBy(tasks,t=>t.tipoTarefa||'');
    const consMap   = countBy(tasks,t=>t.responsavel||'');

    const ctxEst  = document.getElementById('chartTarefasEstado').getContext('2d');
    const ctxPrio = document.getElementById('chartTarefasPrioridade').getContext('2d');
    const ctxTipo = document.getElementById('chartTarefasTipo').getContext('2d');
    const ctxCons = document.getElementById('chartTarefasConsultor').getContext('2d');

    const estLabelsMap = {
      por_fazer:'Por fazer',
      em_curso:'Em curso',
      concluida:'Concluída',
      adiada:'Adiada',
      cancelada:'Cancelada'
    };
    const estKeys   = Object.keys(estLabelsMap);
    const estLabels = estKeys.map(k=>estLabelsMap[k]);
    const estValues = estKeys.map(k=>estadoMap[k]||0);
    createChart('tarEstado', ctxEst,{
      type:'bar',
      data:{labels:estLabels,datasets:[{data:estValues,backgroundColor:'rgba(163,139,99,0.8)'}]},
      options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
    });

    const prioLabelsMap = {baixa:'Baixa',normal:'Normal',alta:'Alta',critica:'Crítica'};
    const prioKeys   = Object.keys(prioLabelsMap);
    const prioLabels = prioKeys.map(k=>prioLabelsMap[k]);
    const prioValues = prioKeys.map(k=>prioMap[k]||0);
    createChart('tarPrio', ctxPrio,{
      type:'bar',
      data:{labels:prioLabels,datasets:[{data:prioValues,backgroundColor:'rgba(163,139,99,0.8)'}]},
      options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
    });

    const tipoLabelsMap = {
      chamada:'Chamada',
      email:'Email',
      visita:'Visita',
      reuniao:'Reunião',
      followup:'Follow-up',
      outro:'Outro'
    };
    const tipoKeys   = Object.keys(tipoLabelsMap);
    const tipoLabels = tipoKeys.map(k=>tipoLabelsMap[k]);
    const tipoValues = tipoKeys.map(k=>tipoMap[k]||0);
    createChart('tarTipo', ctxTipo,{
      type:'pie',
      data:{labels:tipoLabels,datasets:[{data:tipoValues,backgroundColor:[
        'rgba(163,139,99,0.9)','rgba(120,120,120,0.9)','rgba(90,90,90,0.9)',
        'rgba(70,70,70,0.9)','rgba(50,50,50,0.9)','rgba(30,30,30,0.9)'
      ]}]},
      options:{plugins:{legend:{position:'bottom'}}}
    });

    const consLabels = Object.keys(consMap);
    const consValues = consLabels.map(k=>consMap[k]);
    createChart('tarCons', ctxCons,{
      type:'bar',
      data:{labels:consLabels,datasets:[{data:consValues,backgroundColor:'rgba(163,139,99,0.8)'}]},
      options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
    });

    // Estado & atraso
    const r1=document.createElement('div');
    r1.className='stat-row';
    r1.innerHTML=`<span>Em aberto</span><span><strong>${abertas}</strong></span>`;
    tarefasEstadoStats.appendChild(r1);

    const r2=document.createElement('div');
    r2.className='stat-row';
    r2.innerHTML=`<span>Concluídas</span><span><strong>${concluidas}</strong></span>`;
    tarefasEstadoStats.appendChild(r2);

    const r3=document.createElement('div');
    r3.className='stat-row';
    r3.innerHTML=`<span>Canceladas</span><span><strong>${canceladas}</strong></span>`;
    tarefasEstadoStats.appendChild(r3);

    const r4=document.createElement('div');
    r4.className='stat-row';
    r4.innerHTML=`<span>Atrasadas</span><span><strong>${atrasadas}</strong></span>`;
    tarefasEstadoStats.appendChild(r4);

    // Prazo
    let comData=0;
    tasks.forEach(t=>{ if(t.dataLimite) comData++; });
    const p1=document.createElement('div');
    p1.className='stat-row';
    p1.innerHTML=`<span>Com data limite</span><span><strong>${comData}</strong></span>`;
    tarefasPrazoStats.appendChild(p1);

    const p2=document.createElement('div');
    p2.className='stat-row';
    p2.innerHTML=`<span>Sem data limite</span><span><strong>${total-comData}</strong></span>`;
    tarefasPrazoStats.appendChild(p2);

    // Notas
    if(total===0){
      const c=document.createElement('span');
      c.className='chip';
      c.textContent='Sem tarefas nos filtros atuais';
      tarefasNotas.appendChild(c);
    }else{
      if(atrasadas>0){
        const c=document.createElement('span');
        c.className='chip';
        c.textContent=atrasadas+' tarefas atrasadas — rever follow-up';
        tarefasNotas.appendChild(c);
      }
      if(criticas>0){
        const c=document.createElement('span');
        c.className='chip';
        c.textContent=criticas+' tarefas críticas';
        tarefasNotas.appendChild(c);
      }
      const porResp = Object.entries(consMap).sort((a,b)=>b[1]-a[1]).slice(0,3);
      porResp.forEach(([nome,q])=>{
        const c=document.createElement('span');
        c.className='chip';
        c.textContent=`${nome}: ${q} tarefas`;
        tarefasNotas.appendChild(c);
      });
    }
  }

  function refresh(){
    loadLeads();
    loadAngariacoes();
    loadTarefas();
    buildConsultorOptions();

    const leads = filterLeads();
    const deals = filterDeals();
    const tasks = filterTasks();

    const hasData = leads.length || deals.length || tasks.length;
    emptyState.style.display = hasData ? 'none' : 'block';

    renderLeadsArea(leads);
    renderAngArea(deals);
    renderFechosArea(leads,deals);
    renderTarefasArea(tasks);
    updateContextLabel();
  }

  /* Subtabs */
  document.querySelectorAll('.subtab').forEach(btn=>{
    btn.addEventListener('click',()=>{
      document.querySelectorAll('.subtab').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const area = btn.dataset.area;
      document.querySelectorAll('.area').forEach(a=>{
        a.classList.remove('active');
      });
      document.getElementById('area'+area.charAt(0).toUpperCase()+area.slice(1)).classList.add('active');
    });
  });

  applyFiltersBtn.addEventListener('click',()=>{
    updateFiltersFromControls();
    saveFilters();
    refresh();
  });
  clearFiltersBtn.addEventListener('click',()=>{
    FILTER={consultor:'',de:'',ate:'',showHidden:false,onlyHidden:false};
    applyFiltersToControls();
    saveFilters();
    refresh();
  });
  reloadBtn.addEventListener('click', refresh);

  // INIT
  loadFilters();
  loadLeads();
  loadAngariacoes();
  loadTarefas();
  buildConsultorOptions();
  applyFiltersToControls();
  refresh();
})();
</script>
</body>
</html>
