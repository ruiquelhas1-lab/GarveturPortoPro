<!doctype html>
<html lang="pt-PT">
<head>
  <meta charset="utf-8" />
  <title>Garvetur Porto Pro — Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --gold:#A38B63;
      --gold-soft:rgba(163,139,99,.35);
      --bg:#0B0B0B;
      --panel:#121212;
      --panel-soft:#181818;
      --text:#FFFFFF;
      --muted:#A0A0A0;
      --danger:#F25F5C;
      --success:#4CAF50;
      --warning:#FFC857;
      --card-border:rgba(163,139,99,.3);
      --chip-bg:#1E1E1E;
      --radius-lg:18px;
      --radius-md:12px;
      --shadow-soft:0 14px 25px rgba(0,0,0,.4);
    }

    *{box-sizing:border-box;}
    html,body{
      margin:0;
      height:100%;
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      background:radial-gradient(circle at top,#1c1c1c 0,#050505 55%,#000 100%);
      color:var(--text);
    }

    body{
      display:flex;
      flex-direction:column;
    }

    .app-shell{
      display:grid;
      grid-template-rows:64px auto;
      height:100%;
    }

    header.app-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 18px;
      border-bottom:1px solid rgba(163,139,99,.35);
      background:linear-gradient(90deg,#050505,#111,#050505);
      position:sticky;
      top:0;
      z-index:20;
      gap:16px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .brand-icon{
      width:26px;
      height:26px;
      border-radius:999px;
      border:1px solid var(--gold);
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:0 0 0 1px rgba(163,139,99,.3);
    }
    .brand h1{
      margin:0;
      font-size:17px;
      letter-spacing:.04em;
      text-transform:uppercase;
      color:var(--gold);
    }
    .brand span.sub{
      display:block;
      font-size:11px;
      color:var(--muted);
      letter-spacing:.12em;
      text-transform:uppercase;
    }

    /* NAV TABS */
    .nav-tabs{
      display:flex;
      align-items:center;
      gap:4px;
      background:rgba(0,0,0,.35);
      padding:4px;
      border-radius:999px;
      border:1px solid rgba(163,139,99,.35);
    }
    .nav-tab{
      padding:5px 10px;
      border-radius:999px;
      font-size:11px;
      text-decoration:none;
      color:var(--muted);
      letter-spacing:.12em;
      text-transform:uppercase;
      border:1px solid transparent;
      transition:.16s background,.16s color,.16s border-color,.16s transform;
    }
    .nav-tab:hover{
      color:#fff;
      border-color:rgba(163,139,99,.6);
      transform:translateY(-1px);
    }
    .nav-tab.active{
      background:var(--gold);
      color:#0A0A0A;
      border-color:var(--gold);
      font-weight:600;
    }

    .header-actions{
      display:flex;
      align-items:center;
      gap:8px;
      font-size:11px;
      color:var(--muted);
    }

    .badge-soft{
      border-radius:999px;
      padding:3px 8px;
      border:1px solid rgba(163,139,99,.4);
      background:rgba(0,0,0,.4);
      color:var(--muted);
    }

    /* Layout principal */
    .layout{
      display:grid;
      grid-template-columns: minmax(0, 1.7fr) minmax(0, 1.3fr);
      gap:14px;
      padding:14px 16px 18px;
      height:calc(100vh - 64px);
      max-height:calc(100vh - 64px);
      overflow:hidden;
    }
    @media (max-width: 1024px){
      .layout{
        grid-template-columns:1fr;
        grid-auto-rows:auto;
        height:auto;
        max-height:none;
      }
    }

    .column{
      display:flex;
      flex-direction:column;
      gap:12px;
      overflow-y:auto;
    }

    /* Cards */
    .card{
      border-radius:var(--radius-lg);
      border:1px solid var(--card-border);
      background:radial-gradient(circle at top left,#181818,#070707);
      box-shadow:var(--shadow-soft);
      padding:10px 11px 11px;
    }
    .card-header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      margin-bottom:6px;
    }
    .card-title-block h2{
      margin:0;
      font-size:15px;
      letter-spacing:.16em;
      text-transform:uppercase;
      color:var(--muted);
    }
    .card-title-block p{
      margin:2px 0 0;
      font-size:12px;
      color:var(--muted);
    }

    .kpi-grid{
      display:grid;
      grid-template-columns:repeat(3, minmax(0,1fr));
      gap:8px;
      margin-top:4px;
    }
    @media (max-width: 680px){
      .kpi-grid{
        grid-template-columns:repeat(2,minmax(0,1fr));
      }
    }

    .kpi-card{
      border-radius:var(--radius-md);
      border:1px solid rgba(163,139,99,.28);
      background:rgba(0,0,0,.55);
      padding:7px 8px;
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .kpi-label{
      font-size:11px;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.12em;
    }
    .kpi-value{
      font-size:18px;
      font-weight:600;
      color:#fff;
    }
    .kpi-sub{
      font-size:11px;
      color:var(--muted);
    }
    .kpi-trend-good{
      color:var(--success);
      font-size:11px;
    }
    .kpi-trend-bad{
      color:var(--danger);
      font-size:11px;
    }

    .chip-row{
      display:flex;
      flex-wrap:wrap;
      gap:4px;
      margin-top:4px;
    }
    .chip{
      border-radius:999px;
      padding:2px 7px;
      font-size:10px;
      border:1px solid rgba(163,139,99,.4);
      background:var(--chip-bg);
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.08em;
    }
    .chip-highlight{
      border-color:var(--gold);
      color:var(--gold);
    }

    .list-simple{
      margin-top:4px;
      font-size:12px;
      color:var(--muted);
    }
    .list-simple-row{
      display:flex;
      justify-content:space-between;
      gap:8px;
      padding:3px 0;
      border-bottom:1px dashed rgba(255,255,255,.05);
    }
    .list-simple-row:last-child{
      border-bottom:none;
    }
    .list-simple-label{
      color:#e0e0e0;
    }
    .list-simple-value{
      font-weight:500;
      color:var(--gold);
    }

    .bar-row{
      margin-top:4px;
      font-size:11px;
      color:var(--muted);
    }
    .bar-label{
      display:flex;
      justify-content:space-between;
      margin-bottom:2px;
    }
    .bar-track{
      width:100%;
      height:6px;
      border-radius:999px;
      background:rgba(255,255,255,.06);
      overflow:hidden;
    }
    .bar-fill{
      height:100%;
      border-radius:999px;
      background:linear-gradient(90deg, rgba(163,139,99,.2), var(--gold));
      width:0%;
      transition:width .25s ease-out;
    }

    .muted{
      color:var(--muted);
      font-size:12px;
    }

    .pill-pill{
      display:inline-flex;
      align-items:center;
      gap:4px;
      font-size:11px;
      border-radius:999px;
      padding:3px 8px;
      border:1px solid rgba(163,139,99,.3);
      background:rgba(0,0,0,.4);
    }
  </style>
</head>
<body>
<div class="app-shell">
  <header class="app-header">
    <div class="brand">
      <div class="brand-icon">
        <svg width="16" height="16" viewBox="0 0 24 24" stroke="var(--gold)" fill="none" stroke-width="1.8">
          <circle cx="12" cy="12" r="9"></circle>
          <path d="M8 12.5l2.5 2.5L16 9"></path>
        </svg>
      </div>
      <div>
        <h1>Garvetur Porto Pro — Dashboard</h1>
        <span class="sub">Visão global | Leads & Angariações</span>
      </div>
    </div>

    <nav class="nav-tabs">
      <a href="index.html" class="nav-tab">Mapa</a>
      <a href="kanban.html" class="nav-tab">Leads</a>
      <a href="angariacoes.html" class="nav-tab">Angariações</a>
      <a href="dashboard.html" class="nav-tab active">Dashboard</a>
    </nav>

    <div class="header-actions">
      <span class="badge-soft" id="headerTotals">Sessão atual</span>
    </div>
  </header>

  <div class="layout">
    <!-- Coluna Esquerda: Leads -->
    <div class="column" id="colLeads">
      <section class="card">
        <div class="card-header">
          <div class="card-title-block">
            <h2>Leads</h2>
            <p>Pipeline de clientes — do primeiro contacto até ao fecho.</p>
          </div>
        </div>
        <div class="kpi-grid">
          <div class="kpi-card">
            <div class="kpi-label">Total de leads</div>
            <div class="kpi-value" id="leadsTotal">0</div>
            <div class="kpi-sub">Leads visíveis (todas as colunas)</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Leads em fecho</div>
            <div class="kpi-value" id="leadsFecho">0</div>
            <div class="kpi-sub">Coluna “Fecho”</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Taxa de fecho</div>
            <div class="kpi-value" id="leadsTaxaFecho">0%</div>
            <div class="kpi-sub">Fecho / Total</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Em contacto</div>
            <div class="kpi-value" id="leadsEmContacto">0</div>
            <div class="kpi-sub">Leads a trabalhar</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Qualificadas</div>
            <div class="kpi-value" id="leadsQualificado">0</div>
            <div class="kpi-sub">Com perfil definido</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Em visita / proposta</div>
            <div class="kpi-value" id="leadsVisitaProposta">0</div>
            <div class="kpi-sub">Visita + Proposta</div>
          </div>
        </div>

        <div class="chip-row" id="leadsEstadoChips"></div>
      </section>

      <section class="card">
        <div class="card-header">
          <div class="card-title-block">
            <h2>Leads por consultor</h2>
            <p>Distribuição de leads ativas por consultor.</p>
          </div>
        </div>
        <div class="list-simple" id="leadsPorConsultor"></div>
      </section>
    </div>

    <!-- Coluna Direita: Angariações -->
    <div class="column" id="colAngs">
      <section class="card">
        <div class="card-header">
          <div class="card-title-block">
            <h2>Angariações</h2>
            <p>Carteira de produto — exclusividade, estado e ajustamento.</p>
          </div>
        </div>
        <div class="kpi-grid">
          <div class="kpi-card">
            <div class="kpi-label">Total de angariações</div>
            <div class="kpi-value" id="angTotal">0</div>
            <div class="kpi-sub">Registos visíveis</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Exclusivas</div>
            <div class="kpi-value" id="angExclusivo">0</div>
            <div class="kpi-sub">Contrato em exclusivo</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Não exclusivas</div>
            <div class="kpi-value" id="angNaoExclusivo">0</div>
            <div class="kpi-sub">Contrato não exclusivo</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Novo / Negociação</div>
            <div class="kpi-value" id="angNovoNeg">0</div>
            <div class="kpi-sub">Novo + Em negociação</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Aprovados</div>
            <div class="kpi-value" id="angAprovado">0</div>
            <div class="kpi-sub">Prontos a trabalhar</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Perdidos</div>
            <div class="kpi-value" id="angPerdido">0</div>
            <div class="kpi-sub">Historico</div>
          </div>
        </div>

        <div class="chip-row" id="angEstadoChips"></div>
      </section>

      <section class="card">
        <div class="card-header">
          <div class="card-title-block">
            <h2>Resumo por consultor</h2>
            <p>Proporção de angariações ativas por consultor.</p>
          </div>
        </div>
        <div id="angPorConsultor" class="list-simple"></div>
      </section>
    </div>
  </div>
</div>

<script>
(function(){
  const LEADS_KEY = 'gpp_leads_v5';
  const ANG_KEY   = 'gpp_angariacoes_v2';

  function safeLoadLeads(){
    try{
      const raw = localStorage.getItem(LEADS_KEY);
      if(!raw) return [];
      const arr = JSON.parse(raw);
      return Array.isArray(arr) ? arr : [];
    }catch(e){
      console.error('Erro a ler leads:', e);
      return [];
    }
  }

  function safeLoadAngs(){
    try{
      const raw = localStorage.getItem(ANG_KEY);
      if(!raw) return [];
      const parsed = JSON.parse(raw);
      if(Array.isArray(parsed?.deals)) return parsed.deals;
      if(Array.isArray(parsed)) return parsed;
      return [];
    }catch(e){
      console.error('Erro a ler angariações:', e);
      return [];
    }
  }

  function text(id, value){
    const el = document.getElementById(id);
    if(el) el.textContent = value;
  }

  function pct(num, den){
    if(!den) return '0%';
    return (num/den*100).toFixed(1).replace('.',',') + '%';
  }

  function render(){
    const leadsAll = safeLoadLeads();
    const leads = leadsAll.filter(l => l.visivel !== false);

    const angAll = safeLoadAngs();
    const angs = angAll.filter(a => a.visible !== false);

    // Header mini resumo
    text('headerTotals', `Sessão atual · ${leads.length} leads · ${angs.length} angariações`);

    /* === LEADS === */
    const totalLeads = leads.length;
    const byEstado = {
      'Novo':0,
      'Em Contacto':0,
      'Qualificado':0,
      'Visita':0,
      'Proposta':0,
      'Fecho':0
    };
    leads.forEach(l=>{
      if(byEstado[l.estado] != null){
        byEstado[l.estado]++;
      }
    });

    const totalFecho = byEstado['Fecho'] || 0;
    const emContacto = byEstado['Em Contacto'] || 0;
    const qualif     = byEstado['Qualificado'] || 0;
    const visitaProp = (byEstado['Visita'] || 0) + (byEstado['Proposta'] || 0);

    text('leadsTotal', totalLeads);
    text('leadsFecho', totalFecho);
    text('leadsTaxaFecho', pct(totalFecho, totalLeads));
    text('leadsEmContacto', emContacto);
    text('leadsQualificado', qualif);
    text('leadsVisitaProposta', visitaProp);

    // Chips por estado
    const chipsLead = document.getElementById('leadsEstadoChips');
    if(chipsLead){
      chipsLead.innerHTML = '';
      Object.entries(byEstado).forEach(([estado, n])=>{
        const span = document.createElement('span');
        span.className = 'chip' + (estado==='Fecho' ? ' chip-highlight' : '');
        span.textContent = estado + ': ' + n;
        chipsLead.appendChild(span);
      });
    }

    // Leads por consultor
    const porConsLeads = {};
    leads.forEach(l=>{
      if(!l.consultor) return;
      porConsLeads[l.consultor] = (porConsLeads[l.consultor] || 0) + 1;
    });
    const elLpc = document.getElementById('leadsPorConsultor');
    if(elLpc){
      elLpc.innerHTML = '';
      const entries = Object.entries(porConsLeads).sort((a,b)=>b[1]-a[1]);
      if(!entries.length){
        elLpc.innerHTML = '<div class="muted">Sem leads registadas neste navegador.</div>';
      }else{
        entries.forEach(([nome, n])=>{
          const row = document.createElement('div');
          row.className = 'list-simple-row';
          const label = document.createElement('div');
          label.className = 'list-simple-label';
          label.textContent = nome;
          const value = document.createElement('div');
          value.className = 'list-simple-value';
          value.textContent = n;
          row.appendChild(label);
          row.appendChild(value);
          elLpc.appendChild(row);
        });
      }
    }

    /* === ANGARIAÇÕES === */
    const totalAng = angs.length;
    const excls = angs.filter(a => !!a.exclusivo).length;
    const naoExcls = angs.filter(a => !!a.naoExclusivo).length;

    const byEstadoAng = { novo:0, negociacao:0, aprovado:0, perdido:0 };
    angs.forEach(a=>{
      if(byEstadoAng[a.estadoAng] != null){
        byEstadoAng[a.estadoAng]++;
      }
    });

    const novoNeg = (byEstadoAng.novo || 0) + (byEstadoAng.negociacao || 0);
    const aprov   = byEstadoAng.aprovado || 0;
    const perd    = byEstadoAng.perdido || 0;

    text('angTotal', totalAng);
    text('angExclusivo', excls);
    text('angNaoExclusivo', naoExcls);
    text('angNovoNeg', novoNeg);
    text('angAprovado', aprov);
    text('angPerdido', perd);

    const chipsAng = document.getElementById('angEstadoChips');
    if(chipsAng){
      chipsAng.innerHTML = '';
      const mapLabel = {novo:'Novo',negociacao:'Em negociação',aprovado:'Aprovado',perdido:'Perdido'};
      Object.entries(byEstadoAng).forEach(([k,v])=>{
        const span = document.createElement('span');
        span.className = 'chip' + (k==='aprovado' ? ' chip-highlight' : '');
        span.textContent = (mapLabel[k] || k) + ': ' + v;
        chipsAng.appendChild(span);
      });
    }

    // Angariações por consultor
    const porConsAng = {};
    angs.forEach(a=>{
      if(!a.consultor) return;
      porConsAng[a.consultor] = (porConsAng[a.consultor] || 0) + 1;
    });
    const elApc = document.getElementById('angPorConsultor');
    if(elApc){
      elApc.innerHTML = '';
      const entries = Object.entries(porConsAng).sort((a,b)=>b[1]-a[1]);
      if(!entries.length){
        elApc.innerHTML = '<div class="muted">Sem angariações registadas neste navegador.</div>';
      }else{
        entries.forEach(([nome,n])=>{
          const wrap = document.createElement('div');
          wrap.className = 'bar-row';

          const lbl = document.createElement('div');
          lbl.className = 'bar-label';
          const left = document.createElement('span');
          left.textContent = nome;
          const right = document.createElement('span');
          right.textContent = n + ' ang.';
          lbl.appendChild(left);
          lbl.appendChild(right);

          const track = document.createElement('div');
          track.className = 'bar-track';
          const fill = document.createElement('div');
          fill.className = 'bar-fill';
          const percent = totalAng ? Math.max(4, (n/totalAng)*100) : 0;
          fill.style.width = percent.toFixed(1) + '%';
          track.appendChild(fill);

          wrap.appendChild(lbl);
          wrap.appendChild(track);
          elApc.appendChild(wrap);
        });
      }
    }
  }

  document.addEventListener('DOMContentLoaded', render);
})();
</script>
</body>
</html>
