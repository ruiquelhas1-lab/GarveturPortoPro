<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8">
  <title>Garvetur Porto Pro — Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    :root {
      --gold: #A38B63;
      --bg: #0E0E0E;
      --panel: #141414;
      --panel-soft: #181818;
      --border-subtle: rgba(163,139,99,0.35);
      --text: #FFFFFF;
      --muted: #A0A0A0;
      --danger: #F45B5B;
      --success: #3FBF7F;
      --info: #4BA3FF;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background: radial-gradient(circle at top left, #202020 0, #0E0E0E 55%);
      color: var(--text);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
    }

    body { display: flex; flex-direction: column; }

    .app-shell { min-height: 100vh; display: flex; flex-direction: column; }

    /* HEADER / NAV */

    .app-header {
      position: sticky;
      top: 0;
      z-index: 20;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      padding: 10px 18px;
      border-bottom: 1px solid rgba(163,139,99,0.6);
      background: linear-gradient(90deg, #050505, #121212 35%, #050505 100%);
      box-shadow: 0 10px 28px rgba(0,0,0,0.6);
    }

    .app-header-left { display: flex; align-items: center; gap: 12px; }

    .brand-mark {
      width: 32px; height: 32px; border-radius: 50%;
      border: 1px solid var(--gold);
      display: flex; align-items: center; justify-content: center;
      background: radial-gradient(circle at 30% 0, #f3e4c1 0, #A38B63 40%, #2b2416 100%);
      color: #121212; font-weight: 700; font-size: 15px;
    }

    .brand-text { display: flex; flex-direction: column; }
    .brand-title { font-size: 16px; font-weight: 600; letter-spacing: 0.04em; }
    .brand-subtitle { font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.1em; }

    .app-header-center { flex: 1; display: flex; justify-content: center; }

    .nav-tabs {
      display: inline-flex;
      padding: 3px;
      border-radius: 999px;
      background: rgba(20,20,20,0.9);
      border: 1px solid rgba(163,139,99,0.4);
      backdrop-filter: blur(10px);
    }

    .nav-tab {
      position: relative;
      padding: 6px 14px;
      font-size: 12px;
      color: var(--muted);
      text-decoration: none;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      border: none;
      background: transparent;
      transition: all 0.18s ease;
    }

    .nav-tab span.dot {
      width: 6px; height: 6px; border-radius: 50%; background: transparent;
    }

    .nav-tab:hover {
      color: #f5f5f5;
      background: rgba(255,255,255,0.04);
    }

    .nav-tab.active {
      color: #0D0D0D;
      background: linear-gradient(135deg, #F5E6C9, #A38B63);
      box-shadow: 0 0 0 1px rgba(250,244,230,0.4), 0 8px 22px rgba(0,0,0,0.7);
    }

    .nav-tab.active span.dot { background: #0D0D0D; }

    .app-header-right {
      display: flex; align-items: center; gap: 8px;
      font-size: 11px; color: var(--muted);
    }

    .badge-env {
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(163,139,99,0.7);
      background: rgba(5,5,5,0.9);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .btn-ghost-xs {
      padding: 4px 9px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      background: transparent;
      color: var(--muted);
      font-size: 11px;
      cursor: pointer;
    }

    .btn-ghost-xs:hover {
      border-color: rgba(255,255,255,0.4);
      color: #fff;
    }

    /* LAYOUT PRINCIPAL */

    .app-main {
      flex: 1;
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: 14px;
      padding: 12px 18px 18px;
      box-sizing: border-box;
    }

    @media (max-width: 1024px) {
      .app-main {
        grid-template-columns: 1fr;
        grid-template-rows: auto auto;
      }
    }

    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .panel {
      background: #141414;
      border-radius: 14px;
      border: 1px solid var(--border-subtle);
      box-shadow: 0 14px 40px rgba(0,0,0,0.7);
      padding: 10px 12px;
      box-sizing: border-box;
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }

    .panel-title {
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .panel-body {
      font-size: 12px;
      color: var(--muted);
    }

    .btn-subtle {
      font-size: 11px;
      border-radius: 999px;
      padding: 4px 9px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.02);
      color: var(--muted);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn-subtle:hover {
      background: rgba(255,255,255,0.05);
      border-color: rgba(255,255,255,0.25);
      color: #fff;
    }

    .badge-small {
      font-size: 11px;
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(0,0,0,0.4);
      color: var(--muted);
    }

    .text-muted { color: var(--muted); font-size: 12px; }

    /* KPIs */

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 8px;
      margin-top: 6px;
    }

    .kpi-card {
      background: #181818;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.06);
      padding: 7px 8px;
      font-size: 12px;
    }

    .kpi-label {
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: 4px;
    }

    .kpi-value {
      font-size: 18px;
      font-weight: 600;
    }

    .kpi-trend {
      font-size: 11px;
      margin-top: 2px;
    }

    .kpi-trend.good { color: var(--success); }
    .kpi-trend.bad { color: var(--danger); }

    /* ÁREA PRINCIPAL */

    .main-content {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .cards-row {
      display: grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 10px;
    }

    @media (max-width: 1200px) {
      .cards-row { grid-template-columns: repeat(2, minmax(0,1fr)); }
    }
    @media (max-width: 800px) {
      .cards-row { grid-template-columns: 1fr; }
    }

    .metric-card {
      background: #151515;
      border-radius: 14px;
      border: 1px solid rgba(163,139,99,0.45);
      padding: 10px 12px;
      box-shadow: 0 14px 40px rgba(0,0,0,0.7);
      font-size: 12px;
    }

    .metric-title {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
      margin-bottom: 4px;
    }

    .metric-main {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .metric-sub {
      font-size: 12px;
      color: var(--muted);
    }

    .metric-list {
      margin-top: 6px;
      font-size: 12px;
      list-style: none;
      padding: 0;
      margin-left: 0;
    }

    .metric-list li {
      display: flex;
      justify-content: space-between;
      padding: 3px 0;
      border-bottom: 1px dashed rgba(255,255,255,0.04);
    }

    .metric-list li:last-child { border-bottom: none; }

    /* TABELA RESUMO CONSULTOR */

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      color: var(--muted);
    }

    th, td {
      padding: 5px 4px;
      text-align: left;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }

    th {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
    }

    tr.highlight td {
      background: rgba(163,139,99,0.08);
      color: #f5f5f5;
    }

    .chip-tiny {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(0,0,0,0.5);
      color: var(--muted);
    }

    .empty {
      font-size: 12px;
      color: var(--muted);
      padding: 4px 0;
    }
  </style>
</head>
<body>
<div class="app-shell">
  <header class="app-header">
    <div class="app-header-left">
      <div class="brand-mark">G</div>
      <div class="brand-text">
        <div class="brand-title">Garvetur Porto Pro</div>
        <div class="brand-subtitle">Garvetur Luxury Porto · Dashboard</div>
      </div>
    </div>
    <div class="app-header-center">
      <nav class="nav-tabs">
        <a href="index.html" class="nav-tab">
          <span class="dot"></span>Mapa
        </a>
        <a href="kanban.html" class="nav-tab">
          <span class="dot"></span>Leads
        </a>
        <a href="angariacoes.html" class="nav-tab">
          <span class="dot"></span>Angariações
        </a>
        <a href="dashboard.html" class="nav-tab active">
          <span class="dot"></span>Dashboard
        </a>
      </nav>
    </div>
    <div class="app-header-right">
      <div class="badge-env">Visão global</div>
      <button type="button" class="btn-ghost-xs" id="btnRefresh">Recalcular</button>
    </div>
  </header>

  <main class="app-main">
    <!-- Sidebar esquerda -->
    <aside class="sidebar">
      <section class="panel">
        <div class="panel-header">
          <div class="panel-title">Estado geral</div>
          <span id="lblResumoEstado" class="text-muted">—</span>
        </div>
        <div class="panel-body">
          <div class="kpi-grid">
            <div class="kpi-card">
              <div class="kpi-label">Leads ativas</div>
              <div class="kpi-value" id="kpiLeadsAtivas">0</div>
              <div class="kpi-trend" id="kpiLeadsFecho">Taxa de fecho: —</div>
            </div>
            <div class="kpi-card">
              <div class="kpi-label">Angariações ativas</div>
              <div class="kpi-value" id="kpiAngAtivas">0</div>
              <div class="kpi-trend" id="kpiAngExclusivo">Exclusivas: —</div>
            </div>
          </div>
          <p style="margin-top:8px;">
            Dados consolidados em tempo real a partir das páginas <strong>Leads</strong> e <strong>Angariações</strong>.
          </p>
          <div class="badge-small" id="lblFonteDados">Fonte: localStorage</div>
        </div>
      </section>

      <section class="panel">
        <div class="panel-header">
          <div class="panel-title">Filtros de análise</div>
        </div>
        <div class="panel-body">
          <div class="field-group">
            <label class="field-label">Consultor</label>
            <select id="fDashConsultor">
              <option value="todos">Todos</option>
              <option value="Rui Quelhas">Rui Quelhas</option>
              <option value="Manuel Oliveira">Manuel Oliveira</option>
              <option value="João Sousa">João Sousa</option>
              <option value="Francisco dos Santos">Francisco dos Santos</option>
              <option value="Rosário Vasconcelos">Rosário Vasconcelos</option>
              <option value="Armanda Meireles">Armanda Meireles</option>
              <option value="Audrey Lucas">Audrey Lucas</option>
            </select>
          </div>
          <div class="field-group" style="margin-top:6px;">
            <label class="field-label">Origem dos dados</label>
            <div class="text-muted" id="lblDebugKeys" style="font-size:11px;">—</div>
          </div>
          <div style="margin-top:8px;">
            <button type="button" class="btn-subtle" id="btnLimparLS">
              Limpar caches antigas
            </button>
          </div>
          <p class="text-muted" style="margin-top:6px; font-size:11px;">
            (apenas remove versões antigas dos dados no navegador; não afeta os registos atuais nas páginas).
          </p>
        </div>
      </section>
    </aside>

    <!-- Área principal -->
    <section class="main-content">
      <div class="cards-row">
        <div class="metric-card">
          <div class="metric-title">Funil de Leads</div>
          <div class="metric-main" id="mFunilTotalLeads">0</div>
          <div class="metric-sub" id="mFunilResumo">—</div>
          <ul class="metric-list" id="listFunil"></ul>
        </div>

        <div class="metric-card">
          <div class="metric-title">Angariações</div>
          <div class="metric-main" id="mAngTotal">0</div>
          <div class="metric-sub" id="mAngResumo">—</div>
          <ul class="metric-list" id="listAng"></ul>
        </div>

        <div class="metric-card">
          <div class="metric-title">Performance por estado</div>
          <div class="metric-main" id="mPerfResumo">—</div>
          <div class="metric-sub" id="mPerfSub">—</div>
          <ul class="metric-list" id="listPerf"></ul>
        </div>
      </div>

      <div class="metric-card">
        <div class="metric-title">Consultores · Resumo</div>
        <div class="metric-sub" id="mConsultorResumo">Distribuição de leads e angariações por consultor.</div>
        <div style="margin-top:6px; overflow-x:auto;">
          <table>
            <thead>
              <tr>
                <th>Consultor</th>
                <th>Leads</th>
                <th>Fechos</th>
                <th>Angariações</th>
                <th>Exclusivas</th>
              </tr>
            </thead>
            <tbody id="tblConsultores">
              <tr><td colspan="5" class="empty">Sem dados disponíveis.</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>
  </main>
</div>

<script>
  // --- Carregamento robusto das diferentes versões de dados ---

  function safeParse(key) {
    try {
      const raw = localStorage.getItem(key);
      if (!raw) return null;
      const val = JSON.parse(raw);
      if (!Array.isArray(val)) return null;
      return val;
    } catch (e) {
      return null;
    }
  }

  function chooseFirstNonEmpty(keys) {
    for (const k of keys) {
      const arr = safeParse(k);
      if (arr && arr.length > 0) {
        return { key: k, data: arr };
      }
    }
    // se nenhuma tem dados, devolve vazio com a primeira key
    return { key: keys[0] || '—', data: [] };
  }

  function loadLeadsData() {
    // ordem de preferência: versões mais recentes para trás
    const candidateKeys = ['gpp_leads_v3', 'gpp_leads_v2', 'gpp_leads'];
    return chooseFirstNonEmpty(candidateKeys);
  }

  function loadAngData() {
    const candidateKeys = ['gpp_ang_v3', 'gpp_angariacoes_v2', 'gpp_angariacoes'];
    return chooseFirstNonEmpty(candidateKeys);
  }

  function limparCachesAntigas() {
    const oldKeys = [
      'gpp_leads', 'gpp_leads_v2',
      'gpp_angariacoes', 'gpp_angariacoes_v2'
    ];
    oldKeys.forEach(k => {
      try { localStorage.removeItem(k); } catch (e) {}
    });
  }

  // --- Utilitários de formato ---

  function percent(part, total) {
    if (!total || total <= 0) return '—';
    const p = (part / total) * 100;
    return p.toFixed(1).replace('.', ',') + ' %';
  }

  function formatMoney(v) {
    if (!v) return '';
    const num = Number(String(v).replace(/\./g, '').replace(',', '.'));
    if (!isFinite(num)) return String(v);
    return num.toLocaleString('pt-PT', { maximumFractionDigits: 0 }) + ' €';
  }

  function normalizeEstadoLead(l) {
    const e = (l && l.estado) ? String(l.estado).toLowerCase() : 'novo';
    if (e.includes('contact')) return 'em_contacto';
    if (e.includes('qualif')) return 'qualificado';
    if (e.includes('visita')) return 'visita';
    if (e.includes('propost')) return 'proposta';
    if (e.includes('fech')) return 'fecho';
    if (e.includes('novo')) return 'novo';
    return e;
  }

  function isLeadVisivel(l) {
    // se nunca foi definido, consideramos visível
    if (l.visivel === undefined) return true;
    return l.visivel !== false;
  }

  function isAngAtiva(a) {
    const est = (a.estadoNegocio || a.estado || a.status || '').toString().toLowerCase();
    if (!est) return true; // se não há estado, consideramos ativa
    if (est.includes('perd') || est.includes('cancel') || est.includes('retir')) return false;
    return true;
  }

  function isAngExclusiva(a) {
    const exc = (a.exclusivo || a.tipoExclusividade || '').toString().toLowerCase();
    return exc.includes('exclus');
  }

  function getConsultorFromAng(a) {
    return a.consultor || a.angariador || a.angariadorPrincipal || '';
  }

  // --- Renderização do dashboard ---

  function renderDashboard() {
    const lblResumoEstado = document.getElementById('lblResumoEstado');
    const lblFonteDados = document.getElementById('lblFonteDados');
    const lblDebugKeys = document.getElementById('lblDebugKeys');
    const fConsultor = document.getElementById('fDashConsultor').value;

    const leadsBundle = loadLeadsData();
    const angBundle = loadAngData();

    const leadsAll = (leadsBundle.data || []).filter(l => typeof l === 'object');
    const angAll = (angBundle.data || []).filter(a => typeof a === 'object');

    const leads = leadsAll.filter(l => {
      if (!isLeadVisivel(l)) return false; // só contamos visíveis como "ativas"
      if (fConsultor !== 'todos' && l.consultor && l.consultor !== fConsultor) return false;
      return true;
    });

    const angs = angAll.filter(a => {
      if (!isAngAtiva(a)) return false;
      if (fConsultor !== 'todos') {
        const c = getConsultorFromAng(a);
        if (c && c !== fConsultor) return false;
      }
      return true;
    });

    const leadsTotal = leads.length;
    const angTotal = angs.length;

    // LEADS: contagem por estado
    const countsLeads = { novo:0, em_contacto:0, qualificado:0, visita:0, proposta:0, fecho:0 };
    leads.forEach(l => {
      const est = normalizeEstadoLead(l);
      if (countsLeads[est] === undefined) countsLeads[est] = 0;
      countsLeads[est]++;
    });

    const leadsFechadas = countsLeads['fecho'] || 0;
    const taxaFecho = percent(leadsFechadas, leadsTotal);

    // ANGARIAÇÕES: exclusivas / não exclusivas
    let angExclusivas = 0;
    angs.forEach(a => { if (isAngExclusiva(a)) angExclusivas++; });

    const taxaExclusivo = percent(angExclusivas, angTotal);

    // KPI topo
    document.getElementById('kpiLeadsAtivas').textContent = leadsTotal;
    document.getElementById('kpiLeadsFecho').textContent =
      leadsTotal > 0 ? `Taxa de fecho: ${taxaFecho}` : 'Taxa de fecho: —';

    document.getElementById('kpiAngAtivas').textContent = angTotal;
    document.getElementById('kpiAngExclusivo').textContent =
      angTotal > 0 ? `Exclusivas: ${taxaExclusivo}` : 'Exclusivas: —';

    // Resumo de estado global
    if (leadsTotal === 0 && angTotal === 0) {
      lblResumoEstado.textContent = 'Sem dados registados.';
    } else if (leadsTotal > 0 && angTotal === 0) {
      lblResumoEstado.textContent = `Leads ativas: ${leadsTotal} · Sem angariações no filtro atual.`;
    } else if (leadsTotal === 0 && angTotal > 0) {
      lblResumoEstado.textContent = `Angariações ativas: ${angTotal} · Sem leads no filtro atual.`;
    } else {
      lblResumoEstado.textContent = `Leads: ${leadsTotal} · Angariações: ${angTotal}`;
    }

    lblFonteDados.textContent = `Leads: ${leadsBundle.key || '—'} · Angariações: ${angBundle.key || '—'}`;
    lblDebugKeys.textContent = `Leads em: ${leadsBundle.key || '—'} | Angariações em: ${angBundle.key || '—'}`;

    // BLOCO FUNIL
    document.getElementById('mFunilTotalLeads').textContent = leadsTotal;
    document.getElementById('mFunilResumo').textContent =
      leadsTotal === 0 ? 'Sem leads no funil.' : 'Distribuição atual por etapa.';

    const listFunil = document.getElementById('listFunil');
    listFunil.innerHTML = '';
    const labelsFunil = [
      { key:'novo', label:'Novo' },
      { key:'em_contacto', label:'Em Contacto' },
      { key:'qualificado', label:'Qualificado' },
      { key:'visita', label:'Visita' },
      { key:'proposta', label:'Proposta' },
      { key:'fecho', label:'Fecho' },
    ];
    if (leadsTotal === 0) {
      listFunil.innerHTML = '<li class="empty">Nenhuma lead registada no filtro atual.</li>';
    } else {
      labelsFunil.forEach(item => {
        const val = countsLeads[item.key] || 0;
        const li = document.createElement('li');
        li.innerHTML = `
          <span>${item.label}</span>
          <span>${val} · ${percent(val, leadsTotal)}</span>
        `;
        listFunil.appendChild(li);
      });
    }

    // BLOCO ANGARIAÇÕES
    document.getElementById('mAngTotal').textContent = angTotal;
    document.getElementById('mAngResumo').textContent =
      angTotal === 0 ? 'Sem angariações no filtro atual.' : 'Atividade global de angariações.';

    const listAng = document.getElementById('listAng');
    listAng.innerHTML = '';
    if (angTotal === 0) {
      listAng.innerHTML = '<li class="empty">Nenhuma angariação registada no filtro atual.</li>';
    } else {
      // tentamos ver estados típicos
      let angEmCurso = 0, angConcluidas = 0, angPerdidas = 0;
      angAll.forEach(a => {
        const est = (a.estadoNegocio || a.estado || '').toString().toLowerCase();
        if (est.includes('perd') || est.includes('cancel')) angPerdidas++;
        else if (est.includes('concl') || est.includes('vend')) angConcluidas++;
        else angEmCurso++;
      });
      listAng.innerHTML = `
        <li><span>Ativas (filtro) </span><span>${angTotal}</span></li>
        <li><span>Exclusivas (filtro) </span><span>${angExclusivas} · ${taxaExclusivo}</span></li>
        <li><span>Em curso (total) </span><span>${angEmCurso}</span></li>
        <li><span>Concluídas (total) </span><span>${angConcluidas}</span></li>
        <li><span>Perdidas/Canceladas (total) </span><span>${angPerdidas}</span></li>
      `;
    }

    // BLOCO PERFORMANCE
    const listPerf = document.getElementById('listPerf');
    const mPerfResumo = document.getElementById('mPerfResumo');
    const mPerfSub = document.getElementById('mPerfSub');

    if (leadsTotal === 0) {
      mPerfResumo.textContent = 'Sem histórico';
      mPerfSub.textContent = 'Não há leads no filtro atual para análise de desempenho.';
      listPerf.innerHTML = '<li class="empty">Sem dados de funil.</li>';
    } else {
      mPerfResumo.textContent = `${taxaFecho} · fecho sobre leads ativas`;
      mPerfSub.textContent = 'Conversão atual do funil (Fecho / Leads ativas).';

      listPerf.innerHTML = '';
      const etapasChave = [
        { from:'em_contacto', to:'qualificado', label:'Contacto → Qualificado' },
        { from:'qualificado', to:'visita', label:'Qualificado → Visita' },
        { from:'visita', to:'proposta', label:'Visita → Proposta' },
        { from:'proposta', to:'fecho', label:'Proposta → Fecho' },
      ];
      etapasChave.forEach(e => {
        const base = countsLeads[e.from] || 0;
        const alvo = countsLeads[e.to] || 0;
        const txt = base > 0 ? percent(alvo, base) : '—';
        const li = document.createElement('li');
        li.innerHTML = `<span>${e.label}</span><span>${txt}</span>`;
        listPerf.appendChild(li);
      });
    }

    // TABELA CONSULTOR
    const tbl = document.getElementById('tblConsultores');
    tbl.innerHTML = '';
    const consultores = [
      'Rui Quelhas',
      'Manuel Oliveira',
      'João Sousa',
      'Francisco dos Santos',
      'Rosário Vasconcelos',
      'Armanda Meireles',
      'Audrey Lucas'
    ];

    if (leadsAll.length === 0 && angAll.length === 0) {
      tbl.innerHTML = '<tr><td colspan="5" class="empty">Sem dados disponíveis.</td></tr>';
    } else {
      let bestRow = null;
      let bestFechos = -1;

      consultores.forEach(nome => {
        const leadsC = leadsAll.filter(l => l.consultor === nome && isLeadVisivel(l));
        const angC = angAll.filter(a => getConsultorFromAng(a) === nome);

        const totalLeads = leadsC.length;
        const totalFechos = leadsC.filter(l => normalizeEstadoLead(l) === 'fecho').length;

        const angAtivasC = angC.filter(a => isAngAtiva(a)).length;
        const angExclC = angC.filter(a => isAngExclusiva(a)).length;

        if (totalLeads === 0 && angC.length === 0) {
          return;
        }

        if (totalFechos > bestFechos) {
          bestFechos = totalFechos;
          bestRow = nome;
        }

        const tr = document.createElement('tr');
        tr.dataset.consultor = nome;
        tr.innerHTML = `
          <td>${nome}</td>
          <td>${totalLeads}</td>
          <td>${totalFechos}</td>
          <td>${angAtivasC}</td>
          <td>${angExclC}</td>
        `;
        tbl.appendChild(tr);
      });

      if (!tbl.children.length) {
        tbl.innerHTML = '<tr><td colspan="5" class="empty">Sem dados disponíveis.</td></tr>';
      } else if (bestRow) {
        const rows = tbl.querySelectorAll('tr');
        rows.forEach(r => {
          if (r.dataset.consultor === bestRow) {
            r.classList.add('highlight');
          }
        });
        document.getElementById('mConsultorResumo').textContent =
          `Melhor fecho no período: ${bestRow} (${bestFechos} fecho(s)).`;
      }
    }
  }

  // --- Eventos globais ---

  document.getElementById('btnRefresh').addEventListener('click', renderDashboard);
  document.getElementById('fDashConsultor').addEventListener('change', renderDashboard);

  document.getElementById('btnLimparLS').addEventListener('click', () => {
    if (!confirm('Esta ação remove apenas versões antigas de dados (não os registos atuais). Continuar?')) return;
    limparCachesAntigas();
    renderDashboard();
  });

  document.addEventListener('DOMContentLoaded', () => {
    renderDashboard();
  });
</script>
</body>
</html>
