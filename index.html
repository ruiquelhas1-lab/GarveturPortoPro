<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <title>Garvetur Porto Pro — Mapa</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="preconnect" href="https://unpkg.com" crossorigin>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="preconnect" href="https://raw.githubusercontent.com" crossorigin>
  <link rel="preconnect" href="https://a.tile.openstreetmap.org" crossorigin>
  <link rel="preconnect" href="https://b.tile.openstreetmap.org" crossorigin>
  <link rel="preconnect" href="https://c.tile.openstreetmap.org" crossorigin>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
  <style>
    :root{ --bg:#0E0E0E; --text:#FFFFFF; --gold:#A38B63 }
    *{ box-sizing: border-box }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    #topbar{background:#0F0F0F;padding:8px 12px;border-bottom:1px solid rgba(255,255,255,.08);
      display:flex;gap:10px;align-items:center;position:relative;z-index:30;flex-wrap:wrap}
    .tab{font-size:12px;padding:6px 10px;border:1px solid rgba(255,255,255,.12);border-radius:8px;background:#121212;color:#ddd;text-decoration:none}
    .tab.active{background:var(--gold);color:#111;border-color:var(--gold);font-weight:600}
    .actionBtn{background:transparent;border:1px solid rgba(163,139,99,.5);color:#fff;padding:6px 9px;border-radius:8px;cursor:pointer;font-size:12px}
    #status{font-size:12px;color:#E6E6E6;margin-left:auto}
    #map{position:absolute;inset:48px 0 0 0}
    @media (max-width: 640px){ #map{ inset: 80px 0 0 0 } }
  </style>
</head>
<body>
  <div id="topbar">
    <div style="display:flex;align-items:center;gap:10px;">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" style="color:#FFD166"><circle cx="12" cy="12" r="10" stroke-width="1.5"/><path d="M8 12l2.5 2.5L16 9" stroke-width="1.8"/></svg>
      <h1 style="margin:0;font-size:16px;color:#FFD166">Garvetur Porto Pro</h1>
      <nav style="display:flex;gap:6px;margin-left:10px">
        <a class="tab active" href="./index.html">Mapa</a>
        <a class="tab" href="./kanban.html">Leads</a>
        <a class="tab" href="./angariacoes.html">Angariações</a>
        <a class="tab" href="./dashboard.html">Dashboard</a>
      </nav>
    </div>
    <button id="retryBtn" class="actionBtn">Recarregar</button>
    <a id="openGeo" class="actionBtn" target="_blank" rel="noreferrer">Abrir GeoJSON</a>
    <div id="status">A iniciar…</div>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script>
  const RAW  = "https://raw.githubusercontent.com/ruiquelhas1-lab/GarveturPortoPro/main/data/empreendimentos.geojson";
  const CDN  = "https://cdn.jsdelivr.net/gh/ruiquelhas1-lab/GarveturPortoPro@main/data/empreendimentos.geojson";
  const LOCAL= "./data/empreendimentos.geojson";

  const params   = new URLSearchParams(location.search);
  const override = params.get("src");
  const SOURCES  = override ? [override, RAW, CDN, LOCAL] : [RAW, CDN, LOCAL];

  const statusEl = document.getElementById('status');
  const openGeo  = document.getElementById('openGeo');

  const map = L.map('map', { zoomControl:true, scrollWheelZoom:true }).setView([41.15,-8.61], 11);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19, attribution:'&copy; OpenStreetMap' }).addTo(map);
  const cluster = L.markerClusterGroup(); map.addLayer(cluster);

  function setStatus(m){ statusEl.textContent = m; }
  function colorByEstado(e){
    const m={ licenciado:"#118AB2", em_construcao:"#FFD166", em_licenciamento:"#8E7CC3", concluido:"#06D6A0" };
    return m[(e||'').toLowerCase()]||"#A38B63";
  }

  async function tryFetch(url){
    const bust = (url.includes("?")? "&":"?") + "v=" + Date.now();
    setStatus("A carregar: " + url);
    openGeo.href = url;
    const r = await fetch(url + bust, {cache:'no-store'});
    if(!r.ok) throw new Error("HTTP " + r.status + " em " + url);
    const t = await r.text();
    if(t.trim().startsWith("<")) throw new Error("Conteúdo HTML (404/página) em " + url);
    let gj; try{ gj = JSON.parse(t); }catch(e){ throw new Error("JSON inválido em " + url + " (" + e.message + ")"); }
    if(gj.type!=="FeatureCollection" || !Array.isArray(gj.features)) throw new Error("Formato inesperado em " + url);
    return gj;
  }

  function addMarkers(features){
    cluster.clearLayers();
    let added=0;
    features.forEach(f=>{
      if(!f||!f.geometry||f.geometry.type!=="Point") return;
      const c=f.geometry.coordinates||[];
      const lng=Number(String(c[0]).replace(',','.'));
      const lat=Number(String(c[1]).replace(',','.'));
      if(!Number.isFinite(lat)||!Number.isFinite(lng)) return;
      const p=f.properties||{};
      const marker=L.marker([lat,lng],{
        icon:L.divIcon({className:'gpp-pin',html:`<div style="transform:translate(-10px,-24px)">
        <svg width="24" height="24" viewBox="0 0 24 24">
          <path d="M12 2C8.1 2 5 5.1 5 9c0 5.3 7 13 7 13s7-7.7 7-13c0-3.9-3.1-7-7-7z" fill="${colorByEstado(p.estado)}" stroke="white" stroke-width="1"/>
          <circle cx="12" cy="9" r="3" fill="#111" stroke="white" stroke-width="1"/>
        </svg></div>`,iconSize:[24,24],iconAnchor:[12,24]})
      });
      marker.bindTooltip(p.nome||'—',{direction:'top'});
      marker.bindPopup(`<b>${p.nome||'—'}</b><br>${p.concelho||''} · ${(p.estado||'').toLowerCase()}
        ${p.conclusao?'<br>Conclusão: '+p.conclusao:''}
        ${p.promotor?'<br>Promotor: '+p.promotor:''}
        ${p.link?'<br><a href="${p.link}" target="_blank" rel="noreferrer">Abrir link</a>':''}`);
      cluster.addLayer(marker); added++;
    });
    if(added){ const b=cluster.getBounds(); if(b&&b.isValid()) map.fitBounds(b.pad(0.2)); }
    return added;
  }

  async function load(){
    cluster.clearLayers();
    let lastErr=null;
    for(const url of SOURCES){
      try{
        const gj = await tryFetch(url);
        const total = Array.isArray(gj.features)? gj.features.length:0;
        const vis  = addMarkers(gj.features||[]);
        setStatus(`✅ Dados carregados (features: ${total}; visíveis: ${vis}) de ${url}`);
        return;
      }catch(err){ console.warn("Falha nesta fonte:", url, err); lastErr=err; }
    }
    setStatus("❌ Falha ao carregar GeoJSON. " + (lastErr? lastErr.message : "Sem detalhe"));
    alert('Falha ao carregar o ficheiro GeoJSON. Use "Abrir GeoJSON" para confirmar que abre JSON (FeatureCollection).');
  }

  document.getElementById('retryBtn').onclick = load;
  load();
  </script>
</body>
</html>
