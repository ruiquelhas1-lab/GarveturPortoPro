<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <title>Garvetur Porto Pro — Mapa (pins + pesquisa + foco AMP)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Preconnects -->
  <link rel="preconnect" href="https://unpkg.com" crossorigin>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="preconnect" href="https://a.tile.openstreetmap.org" crossorigin>
  <link rel="preconnect" href="https://b.tile.openstreetmap.org" crossorigin>
  <link rel="preconnect" href="https://c.tile.openstreetmap.org" crossorigin>

  <!-- Leaflet CSS -->
  <link id="leaflet-css" rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous">
  <!-- MarkerCluster CSS -->
  <link id="mc-css" rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" crossorigin="anonymous">
  <link id="mc-def" rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" crossorigin="anonymous">

  <style>
    :root{
      --bg:#0E0E0E; --panel:#131313; --text:#FFFFFF; --muted:#9AA0A6;
      --gold:#FFD166;     /* licenciado */
      --blue:#118AB2;     /* em construção */
      --green:#06D6A0;    /* concluído */
      --yellow:#FFC107;   /* em licenciamento (se existir) */
    }
    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--text); font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial; }

    /* Topbar */
    #topbar {
      background: #0F0F0F;
      padding: 10px 14px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      display:flex; gap:12px; flex-wrap:wrap; align-items:center;
    }
    #stats { font-size: 14px; color:#E6E6E6; margin-right:auto; }
    #filters { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    #filters label { font-size: 13px; color:#D9D9D9; }
    #filters input { transform: translateY(1px); }

    #searchWrap { display:flex; align-items:center; gap:8px; background:#121212; border:1px solid rgba(255,255,255,.12); border-radius:10px; padding:6px 10px; }
    #search { background:transparent; border:none; color:#fff; outline:none; width:220px; }
    #focusBtn, #exportBtn {
      background: transparent; border:1px solid rgba(255,209,102,.5); color:#fff;
      padding:6px 10px; border-radius:8px; cursor:pointer;
    }
    #focusBtn:hover, #exportBtn:hover { border-color: var(--gold); }

    #map { height: calc(100% - 62px); }

    /* Legenda */
    .legend { background: #0F0F0F; color:#fff; padding: 8px 10px; font: 12px/14px Arial, sans-serif;
      box-shadow: 0 0 15px rgba(0,0,0,0.3); border-radius: 8px; border:1px solid rgba(255,255,255,.06); }
    .legend .row { display:flex; align-items:center; gap:8px; margin:4px 0; }
    .legend .color { width:12px; height:12px; border-radius:50%; border:1px solid rgba(0,0,0,.2); }

    /* Clusters com dourado */
    .marker-cluster-small, .marker-cluster-medium, .marker-cluster-large {
      background: rgba(255,209,102, .15);
      border: 2px solid var(--gold);
      color:#111;
    }
    .marker-cluster div { background: var(--gold); color:#111; }

    /* Tooltip dark-friendly */
    .leaflet-tooltip { background:#111; color:#fff; border:1px solid rgba(255,255,255,.1); border-radius:8px; box-shadow: 0 2px 10px rgba(0,0,0,.4); }
    .leaflet-tooltip-top:before, .leaflet-tooltip-bottom:before, .leaflet-tooltip-left:before, .leaflet-tooltip-right:before {
      border-top-color:#111 !important; border-bottom-color:#111 !important;
      border-left-color:#111 !important; border-right-color:#111 !important;
    }
  </style>
</head>
<body>
  <div id="topbar">
    <div id="stats">A carregar…</div>

    <div id="searchWrap" title="Pesquisar por nome, concelho ou notas">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#FFD166" stroke-width="2"><circle cx="11" cy="11" r="7"/><path d="M21 21l-4.35-4.35"/></svg>
      <input id="search" placeholder="Pesquisar empreendimentos…" />
    </div>

    <div id="filters">
      <label><input type="checkbox" class="state-filter" value="em_construcao" checked> Em construção</label>
      <label><input type="checkbox" class="state-filter" value="licenciado" checked> Licenciado</label>
      <label><input type="checkbox" class="state-filter" value="em_licenciamento" checked> Em licenciamento</label>
      <label><input type="checkbox" class="state-filter" value="concluido" checked> Concluído</label>
    </div>

    <button id="focusBtn" title="Recentrar no Grande Porto (AMP)">Focar AMP/Porto</button>
    <button id="exportBtn" title="Exporta os empreendimentos visíveis/filtrados">Exportar CSV</button>
  </div>
  <div id="map"></div>

  <!-- Loader de scripts com fallback -->
  <script>
    function loadScript(srcPrimary, srcBackup){
      return new Promise((resolve, reject)=>{
        const s1 = document.createElement('script');
        s1.src = srcPrimary; s1.crossOrigin = 'anonymous'; s1.defer = true;
        s1.onload = ()=> resolve(true);
        s1.onerror = ()=>{
          if (!srcBackup) return reject(new Error('Falha no CDN primário: ' + srcPrimary));
          const s2 = document.createElement('script');
          s2.src = srcBackup; s2.crossOrigin = 'anonymous'; s2.defer = true;
          s2.onload = ()=> resolve(true);
          s2.onerror = ()=> reject(new Error('Falha nos CDNs: ' + srcPrimary + ' e ' + srcBackup));
          document.head.appendChild(s2);
        };
        document.head.appendChild(s1);
      });
    }
  </script>

  <!-- Leaflet + MarkerCluster -->
  <script>
    const DEFAULT_GEOJSON = "https://ruiquelhas1-lab.github.io/Mapa-Porto/data/empreendimentos.geojson";
    const RAW_MAIN       = "https://raw.githubusercontent.com/ruiquelhas1-lab/Mapa-Porto/main/data/empreendimentos.geojson";
    const RAW_GHPAGES    = "https://raw.githubusercontent.com/ruiquelhas1-lab/Mapa-Porto/gh-pages/data/empreendimentos.geojson";

    const stateColors = {
      "licenciado": "#FFD166",
      "em_construcao": "#118AB2",
      "concluido": "#06D6A0",
      "em_licenciamento": "#FFC107"
    };
    const stateDisplay = {
      "licenciado": "Licenciado",
      "em_construcao": "Em construção",
      "concluido": "Concluído",
      "em_licenciamento": "Em licenciamento"
    };

    function normalizeEstado(text) {
      if (!text) return "";
      let s = String(text).toLowerCase()
        .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
        .replace(/\s+/g,'_').replace(/[^\w]/g,'');
      if (s.includes('licenc')) return 'licenciado';
      if (s.includes('constr')) return 'em_construcao';
      if (s.includes('conclu') || s.includes('entreg')) return 'concluido';
      return s;
    }

    function makePinIcon(color = '#FFD166') {
      const svg = encodeURIComponent(`
        <svg xmlns="http://www.w3.org/2000/svg" width="26" height="36" viewBox="0 0 26 36">
          <defs>
            <filter id="s" x="-50%" y="-50%" width="200%" height="200%">
              <feOffset dy="1" in="SourceAlpha" result="shadow"/>
              <feGaussianBlur stdDeviation="1.2" in="shadow" result="blur"/>
              <feColorMatrix type="matrix" values="0 0 0 0 0  0 0 0 0 0  0 0 0 0 0  0 0 0 .35 0" in="blur" result="shadow"/>
              <feMerge><feMergeNode in="shadow"/><feMergeNode in="SourceGraphic"/></feMerge>
            </filter>
          </defs>
          <g filter="url(#s)">
            <path d="M13 35c-3.5-6.1-10.5-11-10.5-18.3C2.5 8.6 7.8 3 13 3s10.5 5.6 10.5 13.7C23.5 24 16.5 28.9 13 35z" fill="${color}"/>
            <circle cx="13" cy="16" r="4.2" fill="#1A1A1A" opacity="0.85"/>
            <circle cx="13" cy="16" r="2.2" fill="#fff"/>
            <path d="M13 0v5" stroke="${color}" stroke-width="2" stroke-linecap="round" opacity="0.75"/>
          </g>
        </svg>
      `);
      return L.icon({
        iconUrl: `data:image/svg+xml;charset=UTF-8,${svg}`,
        iconSize: [26, 36],
        iconAnchor: [13, 34],
        popupAnchor: [0, -30],
        tooltipAnchor: [0, -30]
      });
    }

    function sanitizeToJSON(txt){
      return txt
        .replace(/^\uFEFF/, '')
        .replace(/\bNaN\b/g, 'null')
        .replace(/\bInfinity\b/g, 'null')
        .replace(/\b-Infinity\b/g, 'null')
        .replace(/,\s*([}\]])/g, '$1');
    }
    function parseJSONSafe(txt){
      const safe = sanitizeToJSON(txt);
      return JSON.parse(safe);
    }
    async function fetchTextNoCache(url){
      const bust = url.includes('?') ? `&t=${Date.now()}` : `?t=${Date.now()}`;
      const r = await fetch(url + bust, { cache:'no-store' });
      if (!r.ok) throw new Error(`HTTP ${r.status} @ ${url}`);
      return await r.text();
    }

    async function loadLeafletStack(){
      await loadScript(
        'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js',
        'https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js'
      );
      await loadScript(
        'https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js',
        'https://cdn.jsdelivr.net/npm/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js'
      );
    }

    (async function init(){
      const statsEl = document.getElementById('stats');
      const searchEl = document.getElementById('search');
      const exportBtn = document.getElementById('exportBtn');
      const focusBtn  = document.getElementById('focusBtn');

      // 1) Leaflet + Cluster
      try { await loadLeafletStack(); }
      catch(e){
        document.body.style.background = '#fff';
        document.body.innerHTML = '<div style="padding:16px;font-family:Arial">❌ Falha a carregar bibliotecas do mapa (CDNs bloqueados). Tente noutro browser/rede.</div>';
        return;
      }

      // 2) Mapa
      const map = L.map('map');
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19, attribution:'&copy; OpenStreetMap' }).addTo(map);
      const cluster = L.markerClusterGroup({ showCoverageOnHover:false, disableClusteringAtZoom:17 });
      map.addLayer(cluster);

      // Limites da AMP/Porto (aprox.)
      const AMP_BOUNDS = L.latLngBounds([[41.05, -8.75], [41.25, -8.45]]);
      function focusAMP(){ map.fitBounds(AMP_BOUNDS.pad(0.1)); }
      focusBtn.addEventListener('click', focusAMP);

      // Estruturas de dados
      const markersByState = {};    // estado -> [markers]
      const allMarkers = [];        // [{marker, estadoKey, nome, concelho, notas, conclusao, link}]
      let allRowsForExport = [];    // para CSV
      let usedUrl = '';

      // 3) GeoJSON (multi-fonte)
      const candidates = [DEFAULT_GEOJSON, RAW_MAIN, RAW_GHPAGES];
      const errors = [];
      let gj = null;
      for (const url of candidates) {
        try {
          const txt = await fetchTextNoCache(url);
          gj = parseJSONSafe(txt);
          usedUrl = url;
          break;
        } catch (e) { errors.push(url + ' → ' + e.message); }
      }
      if (!gj || !Array.isArray(gj.features)) {
        statsEl.innerHTML = '❌ Falha a carregar dados. <small>' + errors.join(' · ') + '</small>';
        return;
      }

      // 4) Construir marcadores
      let total = 0;
      const counts = { licenciado:0, em_construcao:0, concluido:0, em_licenciamento:0 };

      gj.features.forEach(f=>{
        const p = f?.properties || {};
        const coords = (f?.geometry?.type === 'Point' && Array.isArray(f.geometry.coordinates)) ? f.geometry.coordinates : null;
        if (!coords) return;
        const [x,y] = coords;
        const lng = Number(x), lat = Number(y);
        if (!Number.isFinite(lat) || !Number.isFinite(lng)) return;

        const nome = p.nome || p.name || 'Empreendimento';
        const concelho = p.concelho || p.municipio || '';
        const estadoKey = normalizeEstado(p.estado || p.status);
        const estadoLabel = stateDisplay[estadoKey] || (p.estado || p.status || '');
        const conclusao = p.conclusao || p['conclusao_prevista'] || p['completion'] || '';
        const notas = p.notas || p['observacoes'] || '';

        if (!estadoKey || !stateDisplay[estadoKey]) return;

        total++;
        counts[estadoKey] = (counts[estadoKey] || 0) + 1;

        const icon = makePinIcon(stateColors[estadoKey] || '#BBBBBB');
        const marker = L.marker([lat, lng], { icon, title: nome });

        const tooltipHtml = `
          <div style="min-width:220px">
            <div style="font-weight:700; font-size:13px; margin-bottom:4px;">${nome}</div>
            <div style="font-size:12px; color:#ccc;">${concelho ? concelho + ' · ' : ''}${estadoLabel}</div>
            ${conclusao ? `<div style="font-size:12px; margin-top:4px;"><strong>Conclusão:</strong> ${conclusao}</div>` : ''}
            ${notas ? `<div style="font-size:12px; margin-top:4px; color:#ddd;">${String(notas).length>160 ? (String(notas).substring(0,157)+'…') : notas}</div>` : ''}
          </div>
        `;
        marker.bindTooltip(tooltipHtml, { direction:'top', offset:[0, -28], sticky:true, opacity:0.95 });

        let link = p.link || p.url || p.website || '';
        let popup = `<div style="min-width:240px">
          <div style="font-weight:700; font-size:14px; margin-bottom:6px; color:#111;">${nome}</div>
          <div style="font-size:12px; color:#444;">${concelho ? concelho + ' · ' : ''}${estadoLabel}</div>
          ${conclusao ? `<div style="font-size:12px; margin-top:6px;"><strong>Conclusão:</strong> ${conclusao}</div>` : ''}
          ${notas ? `<div style="font-size:12px; margin-top:6px;">${notas}</div>` : ''}
        `;
        if (link) {
          if (!/^https?:\/\//i.test(link)) link = 'http://' + link;
          popup += `<div style="margin-top:8px;"><a href="${link}" target="_blank" rel="noreferrer">Abrir ligação</a></div>`;
        }
        popup += `</div>`;
        marker.bindPopup(popup);

        // Guardar
        if (!markersByState[estadoKey]) markersByState[estadoKey] = [];
        markersByState[estadoKey].push(marker);

        allMarkers.push({ marker, estadoKey, nome: (nome||'').toLowerCase(), concelho: (concelho||'').toLowerCase(), notas: (notas||'').toLowerCase(), conclusao, link, lat, lng });

        allRowsForExport.push({
          nome, concelho, estado: estadoLabel, conclusao, notas, link, latitude: lat, longitude: lng
        });

        cluster.addLayer(marker);
      });

      // Enquadrar
      if (cluster.getLayers().length) map.fitBounds(cluster.getBounds().pad(0.2));
      else map.setView([41.15, -8.6], 12);

      // KPIs + fonte
      function updateKPIs(filteredSet = null){
        const arr = filteredSet || allMarkers;
        const by = { licenciado:0, em_construcao:0, concluido:0, em_licenciamento:0 };
        arr.forEach(o => { if (by.hasOwnProperty(o.estadoKey)) by[o.estadoKey]++; });
        const parts = [
          `Fonte: <small>${usedUrl.replace('https://','')}</small>`,
          `Total visíveis: <strong>${arr.length}</strong>`,
          `Licenciado: <strong>${by.licenciado}</strong>`,
          `Em construção: <strong>${by.em_construcao}</strong>`,
          `Concluído: <strong>${by.concluido}</strong>`
        ];
        if (by.em_licenciamento) parts.splice(2, 0, `Em licenciamento: <strong>${by.em_licenciamento}</strong>`);
        statsEl.innerHTML = parts.join(' · ');
      }
      updateKPIs(allMarkers);

      // 5) Filtros + Pesquisa (reconstrução do cluster)
      function applyFilters(){
        const q = (searchEl.value || '').trim().toLowerCase();
        const allowed = new Set(
          Array.from(document.querySelectorAll('.state-filter'))
            .filter(cb => cb.checked)
            .map(cb => cb.value)
        );

        cluster.clearLayers();

        const filtered = allMarkers.filter(o => {
          if (!allowed.has(o.estadoKey)) return false;
          if (!q) return true;
          // pesquisa em nome, concelho e notas
          return o.nome.includes(q) || o.concelho.includes(q) || o.notas.includes(q);
        });

        filtered.forEach(o => cluster.addLayer(o.marker));

        // Atualizar KPIs com base no conjunto visível
        updateKPIs(filtered);

        // Ajustar vista se não houver marcadores
        if (!filtered.length) {
          focusAMP();
        }
      }

      // Eventos de filtros
      document.querySelectorAll('.state-filter').forEach(cb => cb.addEventListener('change', applyFilters));
      // Evento de pesquisa (com pequeno debounce)
      let to = null;
      searchEl.addEventListener('input', () => {
        clearTimeout(to);
        to = setTimeout(applyFilters, 150);
      });

      // 6) Botão Exportar (exporta o conjunto visível)
      exportBtn.addEventListener('click', () => {
        const visible = cluster.getAllChildMarkers();
        if (!visible || !visible.length) {
          alert('Não há empreendimentos visíveis para exportar.');
          return;
        }
        const key = v => `${v.latitude}|${v.longitude}`;
        const visibleKeys = new Set(visible.map(m => key({latitude: m.getLatLng().lat, longitude: m.getLatLng().lng})));
        const exportData = allRowsForExport.filter(r => visibleKeys.has(key(r)));

        const headers = ['nome','concelho','estado','conclusao','notas','link','latitude','longitude'];
        const csv = [headers.join(';')].concat(
          exportData.map(r => headers.map(h => (r[h] ?? '')).join(';'))
        ).join('\n');

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'empreendimentos_filtrados.csv';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      });

      // 7) Legenda
      const legend = L.control({ position: 'bottomleft' });
      legend.onAdd = function() {
        const div = L.DomUtil.create('div', 'legend');
        div.innerHTML = `
          <div class="row"><span class="color" style="background:${stateColors.licenciado}"></span> Licenciado</div>
          <div class="row"><span class="color" style="background:${stateColors.em_construcao}"></span> Em construção</div>
          <div class="row"><span class="color" style="background:${stateColors.concluido}"></span> Concluído</div>
        `;
        return div;
      };
      legend.addTo(map);
    })();
  </script>
</body>
</html>
