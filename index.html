<!doctype html>
<html lang="pt-PT">
<head>
<meta charset="utf-8"/>
<title>Garvetur Porto Pro — Home</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<style>
:root{
  --gold:#A38B63;
  --bg:#0B0B0B;
  --text:#FFFFFF;
  --muted:#A0A0A0;
}

*{box-sizing:border-box;}
html,body{
  margin:0;height:100%;
  font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
  background:radial-gradient(circle at top,#1c1c1c 0,#050505 55%,#000 100%);
  color:var(--text);
}
body{display:flex;flex-direction:column;}

header{
  padding:14px 18px;
  border-bottom:1px solid rgba(163,139,99,.35);
  background:#050505;
}
h1{margin:0;font-size:18px;color:var(--gold);}

main{
  flex:1;padding:20px;display:flex;flex-direction:column;gap:16px;
}

.card{
  background:#151515;
  padding:14px;border-radius:16px;
  border:1px solid rgba(255,255,255,.1);
}
.btn{
  display:inline-block;margin-top:8px;
  padding:6px 12px;border-radius:999px;
  border:1px solid var(--gold);
  color:var(--gold);text-decoration:none;
  font-size:12px;
}

footer{
  padding:10px 14px;
  font-size:11px;
  color:var(--muted);
  border-top:1px solid rgba(163,139,99,.28);
  background:#050505;
  display:flex;
  justify-content:space-between;
}
</style>
</head>

<body>

<header>
  <h1>Garvetur Porto Pro</h1>
</header>

<main>

<div class="card">
  <strong>Mapa (Equipa)</strong><br>
  <a class="btn" href="./equipa-mapa.html">Abrir Mapa</a>
</div>

<div class="card">
  <strong>Prospecção (Equipa)</strong><br>
  <a class="btn" href="./prospeccao.html">Abrir Prospecção</a>
</div>

</main>

<footer>
  <span id="licenseInfo">Validando licença...</span>
  <span><a style="color:#999;" href="./admin.html">Admin</a></span>
</footer>

<script>
(function(){

// ===== CONFIGURAÇÃO =====
const LICENSE_SERVER = "https://script.google.com/macros/s/AKfycbyz5e15CDZP8qLbd-tpTd1i4zje2v7aEDXZjDp3q8HqdwZ8RST1rWXBuL94eRuodkQY/exec";
const LICENSE_KEY_STORAGE = "gpp_license_key_v2";
const DEVICE_ID_STORAGE   = "gpp_device_id_v2";

const TEAM_PASS = 'Garvetur#Porto2026';
const AUTH_KEY  = 'gpp_team_auth_v1';

// ===== UTIL =====
function generateDeviceId(){
  return 'DEV-' + crypto.randomUUID();
}

function getDeviceId(){
  let id = localStorage.getItem(DEVICE_ID_STORAGE);
  if(!id){
    id = generateDeviceId();
    localStorage.setItem(DEVICE_ID_STORAGE, id);
  }
  return id;
}

function formatDateISO(iso){
  if(!iso) return "";
  const d = new Date(iso);
  return d.toLocaleDateString('pt-PT');
}

async function callServer(action, licenseKey){
  const res = await fetch(LICENSE_SERVER,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      action:action,
      license_key:licenseKey,
      device_id:getDeviceId()
    })
  });
  return res.json();
}

function blockApp(message){
  document.body.innerHTML = `
    <div style="display:flex;align-items:center;justify-content:center;height:100vh;background:#000;color:#fff;font-family:system-ui;">
      <div style="text-align:center;max-width:420px;">
        <h2 style="color:#A38B63;">Acesso bloqueado</h2>
        <p style="margin-top:10px;line-height:1.5;">${message}</p>
      </div>
    </div>
  `;
}

// ===== LICENÇA =====
async function checkLicense(){

  let licenseKey = localStorage.getItem(LICENSE_KEY_STORAGE);

  if(!licenseKey){
    licenseKey = prompt("Introduza a sua chave de licença:");
    if(!licenseKey){
      blockApp("Licença obrigatória.");
      return;
    }

    const activation = await callServer("activate", licenseKey);

    if(!activation.ok || activation.status !== "ACTIVE"){
      blockApp("Licença inválida ou não ativa.");
      return;
    }

    localStorage.setItem(LICENSE_KEY_STORAGE, licenseKey);
    updateFooter(licenseKey, activation);
    return;
  }

  const check = await callServer("check", licenseKey);

  if(!check.ok){
    blockApp("Erro na validação da licença.");
    return;
  }

  if(check.status === "REVOKED"){
    blockApp("Licença revogada pela administração.");
    return;
  }

  if(check.status !== "ACTIVE"){
    blockApp("Licença inválida.");
    return;
  }

  updateFooter(licenseKey, check);
}

function updateFooter(key,data){
  const footer = document.getElementById("licenseInfo");
  footer.innerHTML = `
    Licenciado para: ${data.user_name || "Utilizador"} |
    Válido até: ${formatDateISO(data.expires_at)} |
    Chave: ${key}
  `;
}

// ===== PASSWORD EQUIPA =====
function checkAccess(e){
  e.preventDefault();
  const target = e.currentTarget.getAttribute('href');

  if(sessionStorage.getItem(AUTH_KEY) === '1'){
    window.location.href = target;
    return;
  }

  const pwd = prompt('Introduza a password de acesso:');
  if(pwd === TEAM_PASS){
    sessionStorage.setItem(AUTH_KEY,'1');
    window.location.href = target;
  }else{
    alert('Password incorreta.');
  }
}

document.querySelectorAll('a[href="./equipa-mapa.html"], a[href="./prospeccao.html"]')
  .forEach(link => link.addEventListener('click', checkAccess));

checkLicense();

})();
</script>

</body>
</html>
