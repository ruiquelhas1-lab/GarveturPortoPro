<!doctype html>
<html lang="pt">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Garvetur Porto Pro ‚Äî Mapa (Edi√ß√£o + CSV + Anexos Locais)</title>

<link rel="preconnect" href="https://unpkg.com" crossorigin>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" crossorigin="anonymous">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" crossorigin="anonymous">

<!-- PapaParse para CSV (pode ficar bloqueado; se ficar, continua a funcionar mas sem import CSV) -->
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js" crossorigin="anonymous"></script>
<!-- idb-keyval (pode falhar; temos fallback para dataURL) -->
<script src="https://unpkg.com/idb-keyval@6/dist/idb-keyval.iife.min.js" crossorigin="anonymous"></script>

<style>
:root{ --gold:#A38B63; --bg:#0E0E0E; --panel:#131313; --text:#fff; --muted:#9AA0A6; --ok:#43A047; --info:#1E88E5; --warn:#E53935; --border:rgba(255,255,255,.12) }
html,body{height:100%;margin:0;background:#0E0E0E;color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial}
a{color:#e6e6e6;text-decoration:none}
.app{display:grid;grid-template-columns:380px 1fr;grid-template-rows:56px 40px 1fr;height:100%}
header{grid-column:1 / span 2;display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--border);background:#0F0F0F}
.brand{display:flex;align-items:center;gap:10px}
.brand h1{font-size:16px;margin:0;color:var(--gold)}
.nav{display:flex;gap:8px}
.nav a{border:1px solid var(--border);padding:6px 10px;border-radius:8px;color:#ddd}
.nav a.active{background:var(--gold);color:#111;border-color:var(--gold);font-weight:700}

.kpis{grid-column:1 / span 2;display:flex;gap:8px;align-items:center;padding:6px 12px;background:#0F0F0F;border-bottom:1px solid var(--border)}
.kpi{display:flex;align-items:center;gap:6px;border:1px solid var(--border);border-radius:10px;padding:6px 10px;font-size:12px}
.dot{width:10px;height:10px;border-radius:50%;background:#999;display:inline-block;border:1px solid rgba(0,0,0,.2)}
.dot.c{background:var(--warn)}
.dot.l{background:var(--info)}
.dot.f{background:var(--ok)}
.toolbar{margin-left:auto;display:flex;gap:6px;flex-wrap:wrap}
.btn{background:transparent;border:1px solid rgba(163,139,99,.5);color:#fff;padding:6px 10px;border-radius:10px;cursor:pointer;font-size:12px}
.btn.primary{background:var(--gold);color:#111;border-color:var(--gold);font-weight:700}
.btn.ghost{border-color:var(--border);color:#ddd}
.btn-sm{font-size:12px;border:1px solid var(--border);padding:4px 8px;border-radius:8px;background:transparent;color:#eee}
input[type="file"]{display:none}

.sidebar{background:var(--panel);border-right:1px solid var(--border);overflow:auto}
.section{padding:10px;border-bottom:1px solid rgba(255,255,255,.08)}
.hint{font-size:11px;color:#bdbdbd}
.label{font-size:12px;color:#cfcfcf;margin:6px 0 4px}
.field{display:flex;gap:6px}
.field input,.field select{flex:1;background:#0E0E0E;border:1px solid rgba(255,255,255,.15);border-radius:8px;padding:8px 10px;color:#fff;outline:none}
.chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
.chip{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.16);background:#0E0E0E;color:#ddd;cursor:pointer}
.chip.active{background:var(--gold);color:#111;border-color:var(--gold);font-weight:700}
.list{padding:8px 12px}
.card{border:1px solid rgba(163,139,99,.25);border-radius:12px;padding:10px;margin-bottom:10px;background:#0E0E0E}
.card .row{display:flex;justify-content:space-between;gap:8px}
.card .name{font-weight:700}
.card .meta{font-size:11px;color:#bbb;text-transform:uppercase;letter-spacing:.05em;margin-top:2px}
.card .state{font-size:12px;color:#bbb;margin-top:4px}
.card .actions{display:flex;gap:6px;margin-top:8px;flex-wrap:wrap}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--border);font-size:11px}
.empty{padding:10px;color:#bbb;font-size:13px}

#map{width:100%;height:100%}
.leaflet-container{background:#eaeaea}
.legend{position:absolute;left:12px;bottom:16px;z-index:5000;background:#111;border:1px solid var(--border);border-radius:10px;padding:8px 10px;font-size:12px;color:#fff}
.legend .row{display:flex;gap:8px;align-items:center}
.legend .swatch{width:12px;height:12px;border-radius:3px;border:1px solid rgba(0,0,0,.3)}
.legend .c{background:#E53935}.legend .l{background:#1E88E5}.legend .f{background:#43A047}

#side-panel{position:absolute;right:12px;top:80px;bottom:12px;width:min(470px,92vw);z-index:5001;background:#0F0F0F;border:1px solid var(--border);border-radius:12px;overflow:auto;display:none}
#side-panel.show{display:block}
.panel-head{position:sticky;top:0;background:#0F0F0F;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:10px 12px}
.panel-inner{padding:12px}
.meta-line{font-size:13px;margin:4px 0;color:#ddd}

.pin{width:28px;height:28px;border-radius:50%;border:2px solid #111;box-shadow:0 2px 6px rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:12px;position:relative;}
.pin.c{ background:#E53935 }
.pin.l{ background:#1E88E5 }
.pin.f{ background:#43A047 }
.pin.c::after{content:""; position:absolute; width:28px;height:28px;border-radius:50%; box-shadow:0 0 0 0 rgba(229,57,53,.55); animation:pulse 1.8s ease-out infinite;}
@keyframes pulse{0%{ box-shadow:0 0 0 0 rgba(229,57,53,.55)}70%{ box-shadow:0 0 0 18px rgba(229,57,53,0)}100%{ box-shadow:0 0 0 0 rgba(229,57,53,0)}}

.modal-backdrop{display:none; position:fixed; inset:0; z-index:10000; background:rgba(0,0,0,.6); backdrop-filter:blur(2px); align-items:center; justify-content:center; padding:16px;}
.modal-backdrop.show{display:flex}
.modal{width:min(900px,96vw); background:#0F0F0F; border:1px solid var(--border); border-radius:12px; overflow:hidden;}
.modal header{padding:10px 12px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border)}
.modal .content{padding:12px;max-height:72vh;overflow:auto}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.form-field{display:flex;flex-direction:column;gap:6px}
.form-field input,.form-field select,.form-field textarea{background:#0E0E0E;border:1px solid rgba(255,255,255,.15);border-radius:8px;padding:8px 10px;color:#fff;outline:none}
.doc-row{display:grid;grid-template-columns:1fr 120px 1fr auto;gap:6px;align-items:center}
.doc-row .del{border-color:#cc4b4b;color:#ffdddd}

.pdf-backdrop{display:none; position:fixed; inset:0; z-index:11000; background:rgba(0,0,0,.6); backdrop-filter:blur(2px); align-items:center; justify-content:center; padding:16px;}
.pdf-backdrop.show{display:flex}
.pdf-card{width:min(1100px,96vw); height:min(88vh,900px); background:#0F0F0F; border:1px solid var(--border); border-radius:12px; overflow:hidden; display:flex; flex-direction:column;}
.pdf-card header{padding:8px 10px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border)}
.pdf-card .frame{flex:1}
.pdf-card iframe{width:100%;height:100%;border:0}

.hidden{display:none !important}
@media (max-width: 1000px){
  .app{grid-template-columns:1fr;grid-template-rows:56px 40px 280px 1fr}
  .sidebar{grid-row:3}
  #map{grid-row:4}
  #side-panel{top:auto;bottom:72px}
}
</style>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" style="color:var(--gold)"><circle cx="12" cy="12" r="10" stroke-width="1.5"/><path d="M8 12l2.5 2.5L16 9" stroke-width="1.8"/></svg>
        <h1>Garvetur Porto Pro ‚Äî Mapa</h1>
      </div>
      <div class="nav">
        <a class="active" href="./index.html">Mapa</a>
        <a href="./kanban.html">Leads</a>
        <a href="./angariacoes.html">Angaria√ß√µes</a>
        <a href="./dashboard.html">Dashboard</a>
      </div>
    </header>

    <div class="kpis">
      <div class="kpi"><span class="dot"></span>Total: <b id="k_total">0</b></div>
      <div class="kpi"><span class="dot c"></span>Em constru√ß√£o: <b id="k_c">0</b></div>
      <div class="kpi"><span class="dot l"></span>Licenciado: <b id="k_l">0</b></div>
      <div class="kpi"><span class="dot f"></span>Conclu√≠do: <b id="k_f">0</b></div>
      <div class="toolbar">
        <button class="btn" id="focusAmp">Focar AMP/Porto</button>
        <button class="btn" id="exportCsv">Exportar CSV</button>
        <button class="btn" id="exportGeo">Exportar GeoJSON</button>
        <button class="btn ghost" id="toggleEdit" title="Modo Edi√ß√£o">üîí Editar</button>

        <label class="btn" for="csvFile" id="btnImport" style="display:none">Importar CSV</label>
        <input id="csvFile" type="file" accept=".csv" />
        <button class="btn primary" id="btnNew" style="display:none">+ Novo</button>
        <button class="btn ghost" id="btnSave" style="display:none">Guardar</button>
        <button class="btn ghost" id="btnClearAll" style="display:none">Limpar Tudo</button>
      </div>
    </div>

    <aside class="sidebar">
      <div class="section">
        <div class="label">Pesquisa global</div>
        <div class="field"><input id="q" placeholder="Ex.: 'Gaia licenciado 2027 promotor X'"></div>
        <div class="hint">Pesquisa por nome, concelho, promotor, tipologias, estado, conclus√£o, notas e ‚Ç¨/m¬≤.</div>
      </div>
      <div class="section">
        <div class="label">Concelho</div>
        <div class="field"><select id="f_concelho"><option value="">(Todos)</option></select></div>
        <div class="label">Estado</div>
        <div class="chips" id="estadoChips">
          <div class="chip active" data-v="">Todos</div>
          <div class="chip" data-v="em_construcao">Em constru√ß√£o</div>
          <div class="chip" data-v="licenciado">Licenciado</div>
          <div class="chip" data-v="concluido">Conclu√≠do</div>
        </div>
      </div>
      <div class="section">
        <div class="label">Conclus√£o (ano)</div>
        <div class="field">
          <input id="f_cmin" type="number" placeholder="M√≠n. ex.: 2025">
          <input id="f_cmax" type="number" placeholder="M√°x. ex.: 2029">
        </div>
        <div class="label" style="margin-top:6px">Pre√ßo ‚Ç¨/m¬≤</div>
        <div class="field">
          <input id="f_pmin" type="number" placeholder="M√≠n.">
          <input id="f_pmax" type="number" placeholder="M√°x.">
        </div>
      </div>
      <div class="section">
        <div class="label">Promotor</div>
        <div class="field"><select id="f_promotor"><option value="">(Todos)</option></select></div>
        <div class="label" style="margin-top:6px">Tipologias (texto)</div>
        <div class="field"><input id="f_tipos" placeholder="Ex.: T1,T2"></div>
      </div>
      <div class="section">
        <div class="actions">
          <button class="btn primary" id="apply">Aplicar</button>
          <button class="btn ghost" id="clear">Limpar</button>
        </div>
      </div>
      <div class="section"><div class="label">Resultados</div></div>
      <div class="list" id="list"></div>
    </aside>

    <div style="position:relative">
      <div id="map"></div>
      <div class="legend">
        <div class="row"><span class="swatch c"></span> Em constru√ß√£o</div>
        <div class="row"><span class="swatch l"></span> Licenciado</div>
        <div class="row"><span class="swatch f"></span> Conclu√≠do</div>
      </div>

      <div id="side-panel">
        <div class="panel-head">
          <div style="font-weight:700">Detalhes</div>
          <button class="btn" id="closePanel">Fechar ‚úï</button>
        </div>
        <div class="panel-inner" id="panelInner"></div>
      </div>
    </div>
  </div>

<!-- Modal Empreendimento -->
<div id="editModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-label="Empreendimento">
  <div class="modal">
    <header>
      <div><strong id="editTitle">Novo Empreendimento</strong></div>
      <div style="display:flex;gap:8px">
        <button class="btn ghost" id="pickCoord">Definir no mapa</button>
        <label class="btn" id="attachLocalLabel" for="attachLocalInput" style="display:none">üìé Anexar ficheiro (local)</label>
        <input id="attachLocalInput" type="file" accept=".pdf,image/*" style="display:none">
        <button class="btn" id="cancelEdit">Cancelar</button>
        <button class="btn primary" id="saveEdit">Guardar</button>
      </div>
    </header>
    <div class="content">
      <div class="grid2">
        <div class="form-field"><label>Nome</label><input id="f_nome"></div>
        <div class="form-field"><label>Concelho</label><input id="f_concelho_e"></div>
        <div class="form-field"><label>Estado</label>
          <select id="f_estado">
            <option value="">‚Äî</option>
            <option value="em_construcao">Em constru√ß√£o</option>
            <option value="licenciado">Licenciado</option>
            <option value="concluido">Conclu√≠do</option>
          </select>
        </div>
        <div class="form-field"><label>Promotor</label><input id="f_promotor_e"></div>
        <div class="form-field"><label>Tipologias</label><input id="f_tipologias"></div>
        <div class="form-field"><label>Conclus√£o (ano)</label><input id="f_conclusao" type="number" min="1900" max="2100"></div>
        <div class="form-field"><label>‚Ç¨/m¬≤</label><input id="f_preco" type="number" min="0" step="1"></div>
        <div class="form-field"><label>Link</label><input id="f_link"></div>
        <div class="form-field"><label>Latitude</label><input id="f_lat" type="number" step="0.000001"></div>
        <div class="form-field"><label>Longitude</label><input id="f_lng" type="number" step="0.000001"></div>
        <div class="form-field" style="grid-column:1 / span 2"><label>Notas</label><textarea id="f_notas" rows="3"></textarea></div>
      </div>

      <div style="margin-top:10px">
        <div class="label">Documentos & Media</div>
        <div id="docsBox"></div>
        <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap">
          <button class="btn" id="addDoc">+ Adicionar documento (URL)</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal PDF fullscreen -->
<div id="pdfModal" class="pdf-backdrop" role="dialog" aria-modal="true" aria-label="Documento">
  <div class="pdf-card">
    <header>
      <div><strong>Documento</strong></div>
      <div style="display:flex;gap:8px">
        <a id="pdfOpenNew" class="btn" target="_blank" rel="noreferrer">Abrir em nova aba</a>
        <button class="btn" id="pdfClose">Fechar ‚úï</button>
      </div>
    </header>
    <div class="frame"><iframe id="pdfFrame"></iframe></div>
  </div>
</div>

<script>
/* ================== CONFIG ================== */
const AMP_CENTER=[41.15,-8.61], AMP_ZOOM=12;
const LS_KEY='gpp_dataset_v1';

/* ================== ESTADO ================== */
let MAP, CLUSTER, LAYER, CLUSTER_OK=false;
let RAW=[], FILT=[];
let ACTIVE=null;
let EDIT_MODE=false;
let EDIT_INDEX=-1;
let PICKING=false;
let UIState={ q:'', concelho:'', estado:'', cmin:'', cmax:'', pmin:'', pmax:'', promotor:'', tipos:'' };

/* ================== HELPERS ================== */
const el=id=>document.getElementById(id);
function norm(s){return String(s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'')}
function stateKey(s){ const x=norm(s); if(x.includes('constr'))return 'em_construcao'; if(x.includes('licen'))return 'licenciado'; if(x.includes('concl'))return 'concluido'; return x||''; }
function colorByState(k){ if(k==='em_construcao')return '#E53935'; if(k==='licenciado')return '#1E88E5'; if(k==='concluido')return '#43A047'; return '#A38B63'; }
function pinClass(k){ if(k==='em_construcao')return 'pin c'; if(k==='licenciado')return 'pin l'; if(k==='concluido')return 'pin f'; return 'pin'; }
function toCSV(rows){ return rows.map(r=>r.map(v=>`"${String(v??'').replaceAll('"','""')}"`).join(',')).join('\n'); }
function slugify(s){ return norm(s).replace(/\s+/g,'-').replace(/[^a-z0-9\-]/g,''); }
/* n√∫meros ‚ÄúPT‚Äù: troca v√≠rgula por ponto antes do Number() */
function numPT(v){
  if(v===null||v===undefined||v==='') return null;
  const n = Number(String(v).replace(',','.'));
  return Number.isFinite(n)? n : null;
}

/* ====== Loader robusto do Leaflet & MarkerCluster ====== */
function loadScript(src){return new Promise((res,rej)=>{const s=document.createElement('script'); s.src=src; s.crossOrigin='anonymous'; s.defer=true; s.onload=()=>res(true); s.onerror=()=>rej(new Error('Falha a carregar '+src)); document.head.appendChild(s);});}
async function loadLeafletAndCluster(){
  if(!window.L){
    try{ await loadScript('https://unpkg.com/leaflet@1.9.4/dist/leaflet.js'); }
    catch{ await loadScript('https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js'); }
  }
  try{
    if(!window.L || window.L.markerClusterGroup) { CLUSTER_OK = !!window.L?.markerClusterGroup; return; }
    try{ await loadScript('https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js'); }
    catch{ await loadScript('https://cdn.jsdelivr.net/npm/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js'); }
    CLUSTER_OK = !!window.L.markerClusterGroup;
  }catch{ CLUSTER_OK=false; }
}

/* ====== Dete√ß√£o de armazenamento ====== */
let STORAGE_MODE='idb'; // 'idb' | 'dataurl'
async function detectStorageMode(){
  // Se idbKeyval n√£o existir, saltamos para dataURL
  if(!window.idbKeyval){ STORAGE_MODE='dataurl'; return; }
  try{
    const testKey='__gpp_test__', testVal=new Blob(['ok'],{type:'text/plain'});
    await idbKeyval.set(testKey, testVal);
    const v=await idbKeyval.get(testKey);
    await idbKeyval.del(testKey);
    if(!v) throw new Error('Sem leitura IDB');
    STORAGE_MODE='idb';
  }catch{ STORAGE_MODE='dataurl'; }
}

/* ====== Anexos locais (IDB + fallback DataURL) ====== */
const DB_PREFIX='gpp_docs_';
async function saveLocalBlob(blob, slug, filename){
  if(STORAGE_MODE==='idb'){
    try{
      const key = DB_PREFIX + (slug || 'sem-slug') + '_' + (filename || ('file_' + Date.now()));
      await idbKeyval.set(key, blob);
      return 'idb://' + key;
    }catch{ /* falhou IDB ‚Üí tenta dataURL */ }
  }
  const b64 = await new Promise((res,rej)=>{ const fr=new FileReader(); fr.onerror=()=>rej(new Error('Falha FileReader')); fr.onload=()=>res(fr.result); fr.readAsDataURL(blob); });
  return b64; // data:...
}
async function getLocalBlobUrl(idbUrl){
  if(!idbUrl) return null;
  if(idbUrl.startsWith('data:')) return idbUrl;
  if(!window.idbKeyval) return null;
  try{
    const key=idbUrl.replace('idb://','');
    const blob=await idbKeyval.get(key);
    return blob? URL.createObjectURL(blob): null;
  }catch{ return null; }
}
async function deleteLocalBlob(idbUrl){
  try{
    if(!idbUrl || idbUrl.startsWith('data:') || !window.idbKeyval) return;
    const key=idbUrl.replace('idb://','');
    await idbKeyval.del(key);
  }catch{}
}
function isIdbUrl(u){ return typeof u==='string' && u.startsWith('idb://'); }

/* ================== PERSIST√äNCIA ================== */
function saveLS(){ localStorage.setItem(LS_KEY, JSON.stringify(RAW)); }
function loadLS(){ try{ const x=localStorage.getItem(LS_KEY); return x? JSON.parse(x): null; }catch{ return null; } }

/* ================== MAPA ================== */
function initMap(){
  MAP = L.map('map',{ zoomControl:true, scrollWheelZoom:true }).setView(AMP_CENTER, AMP_ZOOM);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ maxZoom:19, attribution:'&copy; OpenStreetMap' }).addTo(MAP);
  if(CLUSTER_OK){
    const clusterOpts={ spiderfyOnEveryZoom:false, showCoverageOnHover:false, maxClusterRadius:48 };
    CLUSTER = L.markerClusterGroup(clusterOpts);
    LAYER = L.layerGroup().addTo(CLUSTER);
    MAP.addLayer(CLUSTER);
  }else{
    LAYER = L.layerGroup().addTo(MAP);
  }
  el('focusAmp').addEventListener('click', ()=>MAP.setView(AMP_CENTER, AMP_ZOOM, {animate:true}));
}

/* ================== KPI, FILTROS, LISTA ================== */
function buildFacetOptions(){
  const concelhos=[...new Set(RAW.map(x=>x.concelho).filter(Boolean))].sort();
  const promotores=[...new Set(RAW.map(x=>x.promotor).filter(Boolean))].sort();
  el('f_concelho').innerHTML='<option value="">(Todos)</option>'+concelhos.map(c=>`<option>${c}</option>`).join('');
  el('f_promotor').innerHTML='<option value="">(Todos)</option>'+promotores.map(c=>`<option>${c}</option>`).join('');
}
function matchTokens(obj, tokens){
  if(!tokens.length) return true;
  const hay = norm([obj.nome,obj.concelho,obj.promotor,obj.tipologias,obj.estado,obj.notas,obj.conclusao,obj.preco_m2].join(' '));
  return tokens.every(tok => hay.includes(tok));
}
function applyFilters(){
  const tokens = norm(UIState.q).split(/\s+/).filter(Boolean);
  const tiposTokens = norm(UIState.tipos||'').split(/[,\s]+/).filter(Boolean);
  FILT = RAW.filter(p=>{
    if(!matchTokens(p, tokens)) return false;
    if(UIState.concelho && p.concelho!==UIState.concelho) return false;
    if(UIState.estado && p.estado!==UIState.estado) return false;
    const c = numPT(p.conclusao);
    if(UIState.cmin && c!==null && c < Number(UIState.cmin)) return false;
    if(UIState.cmax && c!==null && c > Number(UIState.cmax)) return false;
    const m2 = numPT(p.preco_m2);
    if(UIState.pmin && m2!==null && m2 < Number(UIState.pmin)) return false;
    if(UIState.pmax && m2!==null && m2 > Number(UIState.pmax)) return false;
    if(UIState.promotor && p.promotor!==UIState.promotor) return false;
    if(tiposTokens.length){
      const base=norm(p.tipologias||'');
      const hit = tiposTokens.some(t=>base.includes(t));
      if(!hit) return false;
    }
    return true;
  });
}
function renderKPIs(){
  const total = FILT.length;
  const c=FILT.filter(x=>x.estado==='em_construcao').length;
  const l=FILT.filter(x=>x.estado==='licenciado').length;
  const f=FILT.filter(x=>x.estado==='concluido').length;
  el('k_total').textContent=total; el('k_c').textContent=c; el('k_l').textContent=l; el('k_f').textContent=f;
}
function renderList(){
  const box=el('list'); box.innerHTML='';
  if(!FILT.length){ box.innerHTML='<div class="empty">Sem resultados com os filtros atuais.</div>'; return; }
  FILT.forEach(p=>{
    const div=document.createElement('div'); div.className='card';
    div.innerHTML=`
      <div class="row">
        <div>
          <div class="name">${p.nome||'‚Äî'}</div>
          <div class="meta">${p.concelho||'‚Äî'}</div>
        </div>
        <span class="badge" style="border-color:${colorByState(p.estado)};color:${colorByState(p.estado)}">${p.estado||'‚Äî'}</span>
      </div>
      <div class="state">Conclus√£o: ${p.conclusao||'‚Äî'} ¬∑ ‚Ç¨/m¬≤: ${p.preco_m2? Number(String(p.preco_m2).replace(',','.')).toLocaleString('pt-PT'): '‚Äî'}</div>
      <div class="actions">
        <button class="btn" data-act="zoom">Abrir no mapa</button>
        ${p.link? `<a class="btn" href="${p.link}" target="_blank" rel="noreferrer">Abrir link</a>` : ''}
        <button class="btn" data-act="open">Detalhes</button>
        ${EDIT_MODE ? `<button class="btn ghost" data-act="edit">Editar</button>
        <button class="btn" style="border-color:#cc4b4b;color:#ffdddd" data-act="del">Apagar</button>`:''}
      </div>`;
    div.querySelector('[data-act="zoom"]').addEventListener('click', ()=>{ if(p._lat&&p._lng) MAP?.setView([p._lat,p._lng], 16, {animate:true}); });
    div.querySelector('[data-act="open"]').addEventListener('click', ()=>openFicha(p,true));
    if(EDIT_MODE){
      div.querySelector('[data-act="edit"]').addEventListener('click', ()=>openEditBySlug(p.slug));
      div.querySelector('[data-act="del"]').addEventListener('click', ()=>deleteBySlug(p.slug));
    }
    box.appendChild(div);
  });
}

/* ================== MARCADORES ================== */
function makeDivIcon(state){ return L.divIcon({ className: pinClass(state), html:'', iconSize:[28,28], iconAnchor:[14,14], popupAnchor:[0,-12] }); }
function renderMarkers(){
  if(!window.L || !LAYER) return; // modo sem mapa
  if(CLUSTER){ CLUSTER.clearLayers(); }
  LAYER.clearLayers();
  const pts=[];
  FILT.forEach(p=>{
    const lat = numPT(p._lat), lng = numPT(p._lng);
    if(lat===null || lng===null) return;
    pts.push([lat,lng]);
    const m=L.marker([lat,lng],{icon:makeDivIcon(p.estado)});
    m.on('click',()=>openFicha(p,true));
    m.bindTooltip(`${p.nome||''}`,{direction:'top',offset:[0,-8],opacity:.9});
    (CLUSTER||LAYER).addLayer ? (CLUSTER||LAYER).addLayer(m) : m.addTo(LAYER);
  });
  if(pts.length && MAP){
    const b=L.latLngBounds(pts);
    if(b.isValid()) MAP.fitBounds(b.pad(0.2));
  }
}

/* ================== FICHA (drawer) ================== */
function stateLabel(s){ const c=colorByState(s); return `<span class="badge" style="border-color:${c};color:${c}">${s||'‚Äî'}</span>`; }
function buildDocsHTML(docs){
  if(!Array.isArray(docs)||!docs.length) return '<div class="hint">Sem documentos anexados.</div>';
  const items = docs.map(d=>{
    const icon = d.type==='pdf'?'üìÑ':(d.type==='img'?'üñºÔ∏è':'üîó');
    const more = d.type==='pdf' ? ` <button class="btn-sm" data-act="expand" data-url="${d.url}">Expandir</button>` : '';
    return `<li style="margin-bottom:6px;border:1px solid var(--border);padding:6px 8px;border-radius:8px" data-type="${d.type}" data-url="${d.url}">
      ${icon} <a class="btn-sm" href="${d.url}" target="_blank" rel="noreferrer">Abrir</a> ¬∑ ${d.title||d.url}${more}
    </li>`;
  }).join('');
  return `<ul id="docList" style="list-style:none;margin:0;padding:0">${items}</ul>
          <div id="docView" style="margin-top:8px"></div>`;
}

/* ======= Preview universal (Safari friendly) ======= */
const IS_SAFARI = /^((?!chrome|android).)*safari/i.test(navigator.userAgent || '');
async function resolveLocalUrl(rawUrl){
  return rawUrl && rawUrl.startsWith('idb://') ? (await getLocalBlobUrl(rawUrl)) : rawUrl;
}
async function renderDocPreview(container, rawUrl, type){
  const url = await resolveLocalUrl(rawUrl);
  if(!url){ container.innerHTML = '<div class="hint">Documento indispon√≠vel.</div>'; return; }
  if(type === 'img'){
    container.innerHTML = `<img src="${url}" alt="" style="max-width:100%;border-radius:8px">`; return;
  }
  if(type === 'pdf'){
    if(IS_SAFARI){
      container.innerHTML = `
        <object data="${url}#view=FitH" type="application/pdf" style="width:100%;height:420px;border:0;border-radius:8px">
          <div class="hint">O seu navegador n√£o consegue apresentar o PDF embebido. Use "Abrir em nova aba".</div>
        </object>
        <div style="margin-top:6px;display:flex;gap:6px;flex-wrap:wrap">
          <a class="btn-sm" href="${url}" target="_blank" rel="noreferrer">Abrir em nova aba</a>
          <button class="btn-sm" data-act="expand" data-url="${rawUrl}">Expandir</button>
        </div>`;
    }else{
      container.innerHTML = `
        <iframe src="${url}#view=FitH" style="width:100%;height:420px;border:0;border-radius:8px"></iframe>
        <div style="margin-top:6px;display:flex;gap:6px;flex-wrap:wrap">
          <a class="btn-sm" href="${url}" target="_blank" rel="noreferrer">Abrir em nova aba</a>
          <button class="btn-sm" data-act="expand" data-url="${rawUrl}">Expandir</button>
        </div>`;
    }
    container.querySelector('[data-act="expand"]')?.addEventListener('click', async (e)=>{
      const raw = e.target.getAttribute('data-url');
      const u = await resolveLocalUrl(raw);
      openPDF(u);
    });
    return;
  }
  container.innerHTML = `<a class="btn-sm" href="${url}" target="_blank" rel="noreferrer">Abrir liga√ß√£o</a>`;
}

function openFicha(p, focus=false){
  ACTIVE=p;
  const html=`
    <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
      <div>
        <div style="font-weight:800;font-size:16px">${p.nome||'‚Äî'}</div>
        <div style="font-size:12px;color:#bbb">${p.concelho||'‚Äî'} ¬∑ ${stateLabel(p.estado)}</div>
      </div>
      <div style="display:flex;gap:6px;flex-wrap:wrap">
        <button class="btn" data-act="center">Centrar</button>
        <a class="btn" href="https://www.google.com/maps?q=${p._lat},${p._lng}" target="_blank" rel="noreferrer">Google Maps</a>
        ${p.link? `<a class="btn" href="${p.link}" target="_blank" rel="noreferrer">Abrir link</a>`:''}
        <button class="btn" data-act="copy">Copiar resumo</button>
        <button class="btn" data-act="share">Partilhar</button>
        ${EDIT_MODE? `<button class="btn ghost" data-act="edit">Editar</button>`:''}
      </div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:10px">
      <div>
        <div class="meta-line"><b>Promotor:</b> ${p.promotor||'‚Äî'}</div>
        <div class="meta-line"><b>Tipologias:</b> ${p.tipologias||'‚Äî'}</div>
        <div class="meta-line"><b>Conclus√£o:</b> ${p.conclusao||'‚Äî'}</div>
        <div class="meta-line"><b>‚Ç¨/m¬≤:</b> ${p.preco_m2? Number(String(p.preco_m2).replace(',','.')).toLocaleString('pt-PT') : '‚Äî'}</div>
        <div class="meta-line"><b>Notas:</b> ${p.notas||'‚Äî'}</div>
        <div class="meta-line"><b>Coordenadas:</b> ${numPT(p._lat)??'‚Äî'}, ${numPT(p._lng)??'‚Äî'}</div>
      </div>
      <div>
        <div class="label">Documentos & Media</div>
        ${buildDocsHTML(p.docs||[])}
      </div>
    </div>
  `;
  el('panelInner').innerHTML=html;
  el('side-panel').classList.add('show');
  if(focus && numPT(p._lat)!==null && numPT(p._lng)!==null) MAP?.setView([numPT(p._lat),numPT(p._lng)], 16, {animate:true});

  el('panelInner').querySelector('[data-act="center"]')?.addEventListener('click',()=>{ 
    if(numPT(p._lat)!==null && numPT(p._lng)!==null) MAP?.setView([numPT(p._lat),numPT(p._lng)], 16,{animate:true}); 
  });
  el('panelInner').querySelector('[data-act="copy"]')?.addEventListener('click',async ()=>{
    const resumo = `${p.nome||''} ‚Äî ${p.concelho||''} (${p.estado||''}); Conclus√£o ${p.conclusao||'‚Äî'}; ${p.link||''}`.trim();
    try{ await navigator.clipboard.writeText(resumo); }catch{}
  });
  el('panelInner').querySelector('[data-act="share"]')?.addEventListener('click',async ()=>{
    const shareData={ title:p.nome||'Empreendimento', text:`${p.nome||''} ‚Äî ${p.concelho||''} (${p.estado||''}) ¬∑ Conclus√£o ${p.conclusao||'‚Äî'}`, url: location.href };
    if(navigator.share){ try{ await navigator.share(shareData); }catch{} }
    else{ try{ await navigator.clipboard.writeText(shareData.text + ' ' + (p.link||location.href)); }catch{} }
  });
  if(EDIT_MODE){
    el('panelInner').querySelector('[data-act="edit"]')?.addEventListener('click', ()=>openEditBySlug(p.slug));
  }

  const ul = el('panelInner').querySelector('#docList');
  if(ul){
    ul.querySelectorAll('li').forEach(li=>{
      li.addEventListener('click', async ()=>{
        const rawUrl = li.getAttribute('data-url');
        const tp = li.getAttribute('data-type');
        const view = el('panelInner').querySelector('#docView');
        await renderDocPreview(view, rawUrl, tp);
      });
      li.querySelector('[data-act="expand"]')?.addEventListener('click', async (e)=>{
        e.stopPropagation();
        const rawUrl = e.target.getAttribute('data-url');
        const url = await resolveLocalUrl(rawUrl);
        openPDF(url);
      });
    });
  }
}
el('closePanel').addEventListener('click', ()=>{ el('side-panel').classList.remove('show'); });

/* ================== EXPORTA√á√ÉO ================== */
function exportCSV(){
  const headers=["nome","concelho","estado","promotor","tipologias","conclusao","preco_m2","notas","link","latitude","longitude"];
  const rows=FILT.map(p=>[p.nome,p.concelho,p.estado,p.promotor,p.tipologias,p.conclusao,p.preco_m2||'',p.notas||'',p.link||'',p._lat||'',p._lng||'']);
  const csv=toCSV([headers,...rows]);
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='empreendimentos.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}
function exportGeo(){
  const fc = {
    type:"FeatureCollection",
    features: RAW.filter(p=>numPT(p._lat)!==null && numPT(p._lng)!==null).map(p=>({
      type:"Feature",
      geometry:{type:"Point", coordinates:[numPT(p._lng), numPT(p._lat)]},
      properties:{ slug:p.slug,nome:p.nome,concelho:p.concelho,estado:p.estado,promotor:p.promotor,tipologias:p.tipologias,conclusao:p.conclusao,preco_m2:p.preco_m2,notas:p.notas,link:p.link,docs:p.docs||[] }
    }))
  };
  const blob=new Blob([JSON.stringify(fc,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='empreendimentos.geojson'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}
el('exportCsv').addEventListener('click', exportCSV);
el('exportGeo').addEventListener('click', exportGeo);

/* ================== MODO EDI√á√ÉO ================== */
function setEditMode(on){
  EDIT_MODE=on;
  el('toggleEdit').textContent = on? 'üîì Edi√ß√£o ON' : 'üîí Editar';
  ['btnImport','btnNew','btnSave','btnClearAll','attachLocalLabel'].forEach(id=>{
    const b = el(id); if(!b) return;
    b.style.display = on? 'inline-block' : 'none';
  });
  renderList();
}
el('toggleEdit').addEventListener('click', ()=> setEditMode(!EDIT_MODE));
el('btnClearAll').addEventListener('click', ()=>{
  if(confirm('Tem a certeza que pretende limpar todos os empreendimentos?')){ RAW=[]; saveLS(); run(); }
});
el('btnSave').addEventListener('click', ()=>{ saveLS(); alert('Dados guardados localmente.'); });

/* ===== CSV Import ===== */
el('csvFile').addEventListener('change', async (ev)=>{
  const file = ev.target.files?.[0]; if(!file) return;
  if(!window.Papa){ alert('Leitor CSV indispon√≠vel. Verifique a rede/ambiente.'); return; }
  const text = await file.text();
  Papa.parse(text,{
    header:true, dynamicTyping:false, skipEmptyLines:true,
    complete:res=>{
      const incoming = (res.data||[]).map(row=>{
        const p = {
          slug: slugify(row.nome||row.Nome||''),
          nome: row.nome||row.Nome||'',
          concelho: row.concelho||row.Concelho||row.municipio||'',
          estado: stateKey(row.estado||row.status||''),
          promotor: row.promotor||'',
          tipologias: row.tipologias||'',
          conclusao: row.conclusao||row["Ano de Conclus√£o"]||'',
          preco_m2: row.preco_m2||row["preco_m2"]||row["Pre√ßo_m2"]||'',
          notas: row.notas||row.Observacoes||row["Observa√ß√µes"]||'',
          link: row.link||row.url||'',
          _lat: numPT(row.latitude||row.Lat||row.lat),
          _lng: numPT(row.longitude||row.Lng||row.lng),
          docs:[]
        };
        return p;
      }).filter(p=>p.nome);
      if(!incoming.length){ alert('Nenhuma linha v√°lida encontrada no CSV.'); return; }

      const bySlug = new Map(RAW.map(p=>[p.slug||slugify(p.nome), p]));
      incoming.forEach(n=>{
        const key = n.slug || slugify(n.nome);
        if(bySlug.has(key)){ Object.assign(bySlug.get(key), n); }
        else { RAW.push(n); }
      });
      saveLS(); buildFacetOptions(); run();
      alert(`Importa√ß√£o conclu√≠da: ${incoming.length} registos processados.`);
      ev.target.value='';
    },
    error:()=> alert('Falha a ler CSV.')
  });
});

/* ===== Modal de Edi√ß√£o ===== */
function openEditBySlug(slug){
  const idx = RAW.findIndex(p=>p.slug===slug);
  if(idx<0) return;
  EDIT_INDEX = idx;
  const p = RAW[idx];
  fillEditForm(p);
  el('editTitle').textContent='Editar Empreendimento';
  el('editModal').classList.add('show');
}
el('btnNew').addEventListener('click', ()=>{
  EDIT_INDEX = -1;
  fillEditForm({nome:'',concelho:'',estado:'',promotor:'',tipologias:'',conclusao:'',preco_m2:'',notas:'',link:'',_lat:'',_lng:'',docs:[]});
  el('editTitle').textContent='Novo Empreendimento';
  el('editModal').classList.add('show');
});
el('cancelEdit').addEventListener('click', ()=>{ el('editModal').classList.remove('show'); PICKING=false; });

el('pickCoord').addEventListener('click', ()=>{
  PICKING = !PICKING;
  const b=el('pickCoord');
  b.textContent = PICKING? 'Clique no mapa‚Ä¶' : 'Definir no mapa';
  b.classList.toggle('primary', PICKING);
});

/* anexar ficheiro local (com fallback) */
function updateLocalAttachVisibility(){
  const lab = el('attachLocalLabel');
  if(lab) lab.style.display = EDIT_MODE ? 'inline-block' : 'none';
}
updateLocalAttachVisibility();
el('toggleEdit').addEventListener('click', ()=>{ setTimeout(updateLocalAttachVisibility, 0); });

el('attachLocalInput').addEventListener('change', async (ev)=>{
  const file = ev.target.files?.[0];
  if(!file) return;
  const slugCurrent = slugify(el('f_nome').value || (EDIT_INDEX>=0 ? RAW[EDIT_INDEX].nome : 'novo'));
  try{
    const url = await saveLocalBlob(file, slugCurrent, file.name);
    const ext = (file.name.split('.').pop()||'').toLowerCase();
    const type = (ext==='pdf') ? 'pdf' : (['png','jpg','jpeg','webp','gif'].includes(ext) ? 'img' : 'link');
    addDocRow({ title: file.name, type, url });
  }catch(e){
    alert('N√£o foi poss√≠vel anexar o ficheiro. ('+(e.message||e)+')');
  }
  ev.target.value='';
});

el('addDoc').addEventListener('click', ()=> addDocRow({title:'', type:'pdf', url:''}));

function fillEditForm(p){
  el('f_nome').value = p.nome||'';
  el('f_concelho_e').value = p.concelho||'';
  el('f_estado').value = p.estado||'';
  el('f_promotor_e').value = p.promotor||'';
  el('f_tipologias').value = p.tipologias||'';
  el('f_conclusao').value = p.conclusao||'';
  el('f_preco').value = p.preco_m2||'';
  el('f_link').value = p.link||'';
  el('f_lat').value = p._lat!=null? p._lat : '';
  el('f_lng').value = p._lng!=null? p._lng : '';
  el('f_notas').value = p.notas||'';
  const box = el('docsBox'); box.innerHTML='';
  (p.docs||[]).forEach(d=> addDocRow(d));
}
function addDocRow(d){
  const row = document.createElement('div');
  row.className='doc-row';
  row.innerHTML = `
    <input placeholder="T√≠tulo (ex.: Brochura)" value="${d.title||''}">
    <select>
      <option value="pdf" ${d.type==='pdf'?'selected':''}>pdf</option>
      <option value="img" ${d.type==='img'?'selected':''}>img</option>
      <option value="link" ${d.type==='link'?'selected':''}>link</option>
    </select>
    <input placeholder="URL (https://‚Ä¶ ou idb://‚Ä¶ ou data:‚Ä¶)" value="${d.url||''}">
    <button class="btn del">Apagar</button>
  `;
  row.querySelector('.del').addEventListener('click', async ()=>{
    const inputs = row.querySelectorAll('input,select');
    const u = inputs[2].value.trim();
    if(isIdbUrl(u)) await deleteLocalBlob(u);
    row.remove();
  });
  el('docsBox').appendChild(row);
}

el('saveEdit').addEventListener('click', ()=>{
  const p = {
    nome: el('f_nome').value.trim(),
    concelho: el('f_concelho_e').value.trim(),
    estado: el('f_estado').value,
    promotor: el('f_promotor_e').value.trim(),
    tipologias: el('f_tipologias').value.trim(),
    conclusao: el('f_conclusao').value? Number(el('f_conclusao').value): '',
    preco_m2: el('f_preco').value? Number(el('f_preco').value): '',
    notas: el('f_notas').value.trim(),
    link: el('f_link').value.trim(),
    _lat: el('f_lat').value? numPT(el('f_lat').value): null,
    _lng: el('f_lng').value? numPT(el('f_lng').value): null,
    docs: []
  };
  el('docsBox').querySelectorAll('.doc-row').forEach(r=>{
    const inputs = r.querySelectorAll('input,select');
    const d = { title: inputs[0].value.trim(), type: inputs[1].value, url: inputs[2].value.trim() };
    if(d.url) p.docs.push(d);
  });
  if(!p.nome){ alert('O nome √© obrigat√≥rio.'); return; }
  p.slug = slugify(p.nome);

  if(EDIT_INDEX>=0){
    RAW[EDIT_INDEX] = Object.assign(RAW[EDIT_INDEX], p);
  }else{
    const exist = RAW.find(x=>x.slug===p.slug);
    if(exist){ if(!confirm('J√° existe um empreendimento com este nome. Substituir?')) return;
      Object.assign(exist, p);
    }else{
      RAW.push(p);
    }
  }
  saveLS();
  el('editModal').classList.remove('show'); PICKING=false;
  buildFacetOptions();
  run();
});
function deleteBySlug(slug){
  if(!confirm('Apagar este empreendimento?')) return;
  const idx = RAW.findIndex(p=>p.slug===slug);
  if(idx>=0){ RAW.splice(idx,1); saveLS(); buildFacetOptions(); run(); }
}

/* ================== PDF MODAL ================== */
function openPDF(url){
  el('pdfFrame').src=url;
  el('pdfOpenNew').href=url;
  el('pdfModal').classList.add('show');
}
el('pdfClose').addEventListener('click', ()=>{ el('pdfModal').classList.remove('show'); el('pdfFrame').src='about:blank'; });
el('pdfModal').addEventListener('click', (e)=>{ if(e.target.id==='pdfModal') el('pdfClose').click(); });

/* ================== EVENTOS UI ================== */
document.querySelectorAll('#estadoChips .chip').forEach(ch=>{
  ch.addEventListener('click', ()=>{
    document.querySelectorAll('#estadoChips .chip').forEach(c=>c.classList.remove('active'));
    ch.classList.add('active'); UIState.estado=ch.dataset.v||''; run();
  });
});
el('apply').addEventListener('click', ()=>{
  UIState.q=el('q').value.trim();
  UIState.concelho=el('f_concelho').value;
  UIState.cmin=el('f_cmin').value;
  UIState.cmax=el('f_cmax').value;
  UIState.pmin=el('f_pmin').value;
  UIState.pmax=el('f_pmax').value;
  UIState.promotor=el('f_promotor').value;
  UIState.tipos=el('f_tipos').value.trim();
  run();
});
el('clear').addEventListener('click', ()=>{
  ['q','f_concelho','f_cmin','f_cmax','f_pmin','f_pmax','f_promotor','f_tipos'].forEach(id=>el(id).value='');
  document.querySelectorAll('#estadoChips .chip').forEach(c=>c.classList.remove('active'));
  document.querySelector('#estadoChips .chip[data-v=""]').classList.add('active');
  UIState={ q:'', concelho:'', estado:'', cmin:'', cmax:'', pmin:'', pmax:'', promotor:'', tipos:'' };
  run();
});

/* ================== CICLO RENDER ================== */
function run(){ applyFilters(); renderKPIs(); renderList(); renderMarkers(); }

/* ================== Arranque robusto ================== */
(async function init(){
  // Leaflet + cluster (com fallbacks); se falhar, arranca sem mapa
  let MAP_OK=true;
  try{ await loadLeafletAndCluster(); }
  catch(e){ MAP_OK=false; console.warn('Sem Leaflet:', e.message||e); }
  if(MAP_OK && window.L){ initMap(); } else { el('map')?.classList.add('hidden'); }

  await detectStorageMode();
  if(STORAGE_MODE==='dataurl'){
    const warn=document.createElement('div');
    warn.className='hint'; warn.style.cssText='margin-left:8px;color:#ffcc99';
    warn.textContent='Aviso: anexos gravados como Data URL (fallback).';
    document.querySelector('.toolbar')?.appendChild(warn);
  }

  const mem = loadLS();
  RAW = Array.isArray(mem) ? mem : [];
  buildFacetOptions();
  run();
})();
</script>
</body>
</html>
