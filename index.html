<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <title>Garvetur Porto Pro — Mapa de Empreendimentos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://unpkg.com" crossorigin>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
  <style>
    :root { --gold:#A38B63; --bg:#0E0E0E; --text:#FFFFFF; }
    html,body { height:100%; margin:0; background:var(--bg); color:var(--text); font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial; }
    #topbar { background:#0F0F0F; padding:8px 12px; border-bottom:1px solid rgba(255,255,255,.08);
      display:flex; gap:10px; align-items:center; position:relative; z-index:30; flex-wrap:wrap; }
    .tab { font-size:12px; padding:6px 10px; border:1px solid rgba(255,255,255,.12); border-radius:8px; background:#121212; color:#ddd; text-decoration:none; }
    .tab.active { background:var(--gold); color:#111; border-color:var(--gold); font-weight:600; }
    .actionBtn { background:transparent; border:1px solid rgba(163,139,99,.5); color:#fff; padding:6px 9px; border-radius:8px; cursor:pointer; font-size:12px; }
    #status { font-size:12px; color:#E6E6E6; margin-left:auto; }
    #map { position:absolute; inset:46px 0 0 0; }
    .legend { position:absolute; bottom:20px; left:20px; background:#111; color:#eee; font-size:11px; padding:8px 10px; border-radius:8px; border:1px solid rgba(255,255,255,.1); line-height:1.4; }
    .legend div { display:flex; align-items:center; gap:6px; margin-bottom:4px; }
    .swatch { width:12px; height:12px; border-radius:50%; display:inline-block; }
    @media (max-width:640px){ #map{ inset:78px 0 0 0; } }
  </style>
</head>
<body>
  <div id="topbar">
    <div style="display:flex;align-items:center;gap:10px;">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" style="color:#FFD166">
        <circle cx="12" cy="12" r="10" stroke-width="1.5"/>
        <path d="M8 12l2.5 2.5L16 9" stroke-width="1.8"/>
      </svg>
      <h1 style="margin:0;font-size:16px;color:#FFD166">Garvetur Porto Pro</h1>
      <nav style="display:flex;gap:6px;margin-left:10px">
        <a class="tab active" href="./index.html">Mapa</a>
        <a class="tab" href="./kanban.html">Leads</a>
        <a class="tab" href="./angariacoes.html">Angariações</a>
        <a class="tab" href="./dashboard.html">Dashboard</a>
      </nav>
    </div>
    <button id="reloadBtn" class="actionBtn">Atualizar dados</button>
    <div id="status">A iniciar…</div>
  </div>

  <div id="map"></div>
  <div class="legend">
    <div><span class="swatch" style="background:#FFD166"></span> Em Construção</div>
    <div><span class="swatch" style="background:#118AB2"></span> Licenciado</div>
    <div><span class="swatch" style="background:#06D6A0"></span> Concluído</div>
  </div>

  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script>
  const CSV_SOURCE = "./data/empreendimentos.csv";
  const PORTO_CENTER = [41.15, -8.61];
  const statusEl = document.getElementById('status');
  const map = L.map('map', { zoomControl:true, scrollWheelZoom:true }).setView(PORTO_CENTER, 11);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19, attribution:'&copy; OpenStreetMap' }).addTo(map);
  const cluster = L.markerClusterGroup(); map.addLayer(cluster);

  function setStatus(m){ statusEl.textContent = m; }
  function toNum(v){ if(v==null) return null; const n = Number(String(v).replace(',','.')); return Number.isFinite(n)?n:null; }
  function colorByEstado(e){
    const s=(e||'').toLowerCase();
    if(s.includes('conclu')) return '#06D6A0';
    if(s.includes('licen')) return '#118AB2';
    if(s.includes('constr')) return '#FFD166';
    return '#A38B63';
  }

  function createMarker(p){
    const marker = L.circleMarker([p.lat,p.lng], {
      radius:8, color:colorByEstado(p.estado), fillColor:colorByEstado(p.estado), fillOpacity:0.7, weight:1
    });
    marker.bindPopup(`
      <b>${p.nome}</b><br>
      ${p.concelho || ''}${p.estado ? ' · ' + p.estado : ''}<br>
      ${p.conclusao ? 'Conclusão: '+p.conclusao+'<br>' : ''}
      ${p.promotor ? 'Promotor: '+p.promotor+'<br>' : ''}
      ${p.tipologias ? 'Tipologias: '+p.tipologias+'<br>' : ''}
      ${p.preco_m2 ? 'Preço/m²: '+p.preco_m2+'€<br>' : ''}
      ${p.notas ? '<em>'+p.notas+'</em><br>' : ''}
      ${p.link ? '<a href="${p.link}" target="_blank" rel="noreferrer">Abrir Link</a>' : ''}
    `);
    return marker;
  }

  async function loadCSV(){
    try{
      setStatus("A carregar ficheiro CSV...");
      const resp = await fetch(CSV_SOURCE, { cache:'no-store' });
      if(!resp.ok) throw new Error("HTTP "+resp.status);
      const csvText = await resp.text();
      const parsed = Papa.parse(csvText, { header:true, skipEmptyLines:true });
      const data = parsed.data || [];
      cluster.clearLayers();
      let count=0;
      data.forEach(row=>{
        const lat=toNum(row.latitude || row.Latitude);
        const lng=toNum(row.longitude || row.Longitude);
        const nome=row.nome || row.Nome;
        if(!nome || lat==null || lng==null) return;
        const p={
          nome, concelho:row.concelho||row.Concelho, estado:row.estado||row.Estado,
          promotor:row.promotor||row.Promotor, tipologias:row.tipologias||row.Tipologias,
          conclusao:row.conclusao||row.Conclusao, preco_m2:row.preco_m2||row['Preço/m2']||row['preco_m2'],
          notas:row.notas||row.Notas, link:row.link||row.Link, lat, lng
        };
        cluster.addLayer(createMarker(p)); count++;
      });
      setStatus(`✅ ${count} empreendimentos carregados`);
      if(count>0) map.setView(PORTO_CENTER, 11);
    }catch(err){
      console.error(err);
      setStatus("❌ Falha ao carregar CSV ("+(err.message||err)+")");
    }
  }

  document.getElementById('reloadBtn').addEventListener('click', loadCSV);
  loadCSV();
  </script>
</body>
</html>
