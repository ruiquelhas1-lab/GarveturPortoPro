<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <title>Mapa Empreendimentos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- MarkerCluster CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.Default.css" />
  <style>
    html, body { height: 100%; margin: 0; }
    body { display: flex; flex-direction: column; }
    #topbar { background: #fff; padding: 8px 12px; font-family: sans-serif; line-height: 1.5; }
    #map { flex: 1; }
    .legend { background: white; padding: 6px 8px; font: 14px/16px Arial, sans-serif; box-shadow: 0 0 15px rgba(0,0,0,0.2); border-radius: 5px; }
    .legend .legend-circle { display: inline-block; width: 10px; height: 10px; margin-right: 5px; border-radius: 50%; }
    #filters label { margin-right: 10px; }
  </style>
</head>
<body>
  <div id="topbar">
    <div id="stats"></div>
    <div id="filters">
      <label><input type="checkbox" class="state-filter" value="em_construcao" checked> Em construção</label>
      <label><input type="checkbox" class="state-filter" value="licenciado" checked> Licenciado</label>
      <label><input type="checkbox" class="state-filter" value="em_licenciamento" checked> Em licenciamento</label>
      <label><input type="checkbox" class="state-filter" value="concluido" checked> Concluído</label>
      <button id="exportBtn">Exportar CSV</button>
    </div>
  </div>
  <div id="map"></div>
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- MarkerCluster JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/leaflet.markercluster.js"></script>
  <!-- PapaParse JS for CSV parsing -->
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    // Define colors for each estado (categoria)
    var stateColors = {
      "em_construcao": "#FF9800",    // laranja
      "licenciado": "#2196F3",      // azul
      "em_licenciamento": "#FFC107",// amarelo
      "concluido": "#4CAF50"        // verde
    };
    // Mapping estado keys to display labels
    var stateDisplay = {
      "em_construcao": "Em construção",
      "licenciado": "Licenciado",
      "em_licenciamento": "Em licenciamento",
      "concluido": "Concluído"
    };
    // Normalize estado text to key
    function normalizeEstado(text) {
      if (!text) return "";
      text = text.toLowerCase();
      text = text.replace(/ç/g, "c").replace(/ã/g, "a").replace(/í/g, "i").replace(/ú/g, "u").replace(/é/g, "e").replace(/ /g, "_");
      text = text.replace(/[^\w]/g, ""); // remove other non-word chars
      return text;
    }
    // Initialize map
    var map = L.map('map');
    // Add OpenStreetMap base tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; <a href="https://openstreetmap.org">OpenStreetMap</a> contributors'
    }).addTo(map);
    // Marker cluster group
    var markersCluster = L.markerClusterGroup();
    // Hold markers by estado for filtering
    var markersByState = {};
    // Will store CSV fields for export
    var csvFields;
    // Fetch and load CSV data
    Papa.parse('data/empreendimentos_utf8.csv', {
      download: true,
      header: true,
      delimiter: ";",
      skipEmptyLines: true,
      complete: function(results) {
        csvFields = results.meta.fields;
        var data = results.data;
        // Calculate counts
        var total = 0;
        var counts = { "em_construcao": 0, "licenciado": 0, "em_licenciamento": 0, "concluido": 0 };
        data.forEach(function(item) {
          var estadoKey = normalizeEstado(item.estado || item['estado']);
          if (!estadoKey || !stateDisplay[estadoKey]) return;
          var latStr = item.latitude && item.latitude.trim();
          var lonStr = item.longitude && item.longitude.trim();
          if (!latStr || !lonStr) return;
          latStr = latStr.replace(',', '.');
          lonStr = lonStr.replace(',', '.');
          var lat = parseFloat(latStr);
          var lon = parseFloat(lonStr);
          if (isNaN(lat) || isNaN(lon)) return;
          total++;
          counts[estadoKey] = (counts[estadoKey] || 0) + 1;
          // Create marker with colored icon
          var color = stateColors[estadoKey] || "#000";
          var icon = L.divIcon({ html: '<div style="background:' + color + '; width:12px; height:12px; border-radius:50%;"></div>', iconSize: [12, 12], iconAnchor: [6, 6] });
          var marker = L.marker([lat, lon], { icon: icon });
          marker.original = item;
          // Popup content for marker
          var popupHtml = '<strong>' + (item.nome || 'Empreendimento') + '</strong>';
          if (item.notas) popupHtml += '<br>' + item.notas;
          popupHtml += '<br><em>' + stateDisplay[estadoKey] + '</em>';
          if (item.conclusao) popupHtml += '<br>Conclusão: ' + item.conclusao;
          if (item.Link) {
            var linkUrl = item.Link;
            if (linkUrl && !/^https?:\/\//.test(linkUrl)) {
              linkUrl = 'http://' + linkUrl;
            }
            popupHtml += '<br><a href="' + linkUrl + '" target="_blank">Mais informações</a>';
          }
          marker.bindPopup(popupHtml);
          if (!markersByState[estadoKey]) {
            markersByState[estadoKey] = [];
          }
          markersByState[estadoKey].push(marker);
          markersCluster.addLayer(marker);
        });
        // Add cluster group to map and fit bounds
        map.addLayer(markersCluster);
        if (total > 0) {
          map.fitBounds(markersCluster.getBounds());
        } else {
          map.setView([41.15, -8.6], 12);
        }
        // Update stats display (KPIs por estado)
        var statsText = 'Total: ' + total;
        var categories = ['em_construcao','licenciado','em_licenciamento','concluido'];
        categories.forEach(function(cat) {
          statsText += ' | ' + stateDisplay[cat] + ': ' + (counts[cat] || 0);
        });
        document.getElementById('stats').textContent = statsText;
      }
    });
    // Legend (visualização das cores por estado)
    var legend = L.control({ position: 'bottomright' });
    legend.onAdd = function(map) {
      var div = L.DomUtil.create('div', 'legend');
      var categories = ['em_licenciamento', 'licenciado', 'em_construcao', 'concluido'];
      categories.forEach(function(cat) {
        var label = stateDisplay[cat] || cat;
        var color = stateColors[cat] || '#000';
        div.innerHTML += '<span class="legend-circle" style="background:' + color + '"></span> ' + label + '<br>';
      });
      return div;
    };
    legend.addTo(map);
    // Filtro por estado (checkboxes)
    document.querySelectorAll('.state-filter').forEach(function(cb) {
      cb.addEventListener('change', function() {
        var stateKey = cb.value;
        if (cb.checked) {
          if (markersByState[stateKey]) {
            markersByState[stateKey].forEach(function(m) {
              markersCluster.addLayer(m);
            });
          }
        } else {
          if (markersByState[stateKey]) {
            markersByState[stateKey].forEach(function(m) {
              markersCluster.removeLayer(m);
            });
          }
        }
      });
    });
    // Exportar CSV dos resultados filtrados
    document.getElementById('exportBtn').addEventListener('click', function() {
      var allMarkers = markersCluster.getAllChildMarkers();
      if (!allMarkers || allMarkers.length === 0) {
        alert('Não há empreendimentos filtrados para exportar.');
        return;
      }
      var exportData = allMarkers.map(function(m) { return m.original; });
      var csv = Papa.unparse({ fields: csvFields, data: exportData }, { delimiter: ";" });
      var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      var a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'empreendimentos_filtrados.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    });
  </script>
</body>
</html>
