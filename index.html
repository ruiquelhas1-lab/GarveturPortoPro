<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <title>Garvetur Porto Pro — Mapa</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Preconnects -->
  <link rel="preconnect" href="https://unpkg.com" crossorigin>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="preconnect" href="https://a.tile.openstreetmap.org" crossorigin>
  <link rel="preconnect" href="https://b.tile.openstreetmap.org" crossorigin>
  <link rel="preconnect" href="https://c.tile.openstreetmap.org" crossorigin>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous">
  <!-- MarkerCluster CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" crossorigin="anonymous">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" crossorigin="anonymous">

  <style>
    :root{
      --bg:#0E0E0E; --panel:#131313; --text:#FFFFFF; --muted:#9AA0A6;
      --gold:#FFD166; --blue:#118AB2; --green:#06D6A0; --yellow:#FFC107;
      --card:#111; --border:rgba(255,255,255,.10); --edge:#181818;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial}

    /* Topbar */
    #topbar{background:#0F0F0F;padding:8px 12px;border-bottom:1px solid rgba(255,255,255,.08);
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;position:relative;z-index:30}
    .searchWrap{display:flex;align-items:center;gap:6px;background:#121212;border:1px solid rgba(255,255,255,.12);
      border-radius:10px;padding:4px 8px}
    .searchWrap input{background:transparent;border:none;color:#fff;outline:none;width:220px;font-size:13px}
    #filters{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    #filters label{font-size:12px;color:#D9D9D9}
    .actionBtn{background:transparent;border:1px solid rgba(255,209,102,.5);color:#fff;padding:6px 9px;border-radius:8px;cursor:pointer;font-size:12px}
    .actionBtn:hover{border-color:var(--gold)}
    #statsLine{font-size:12px;color:#E6E6E6;margin-right:auto}

    /* KPIs – compacto */
    #kpiBar{background:#0E0E0E;border-bottom:1px solid var(--border);padding:6px 12px;position:relative;z-index:20}
    .kpiGrid{display:grid;gap:8px;grid-template-columns:repeat(12,1fr)}
    .kpiCard{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:8px;min-height:44px}
    .kpiTitle{font-size:10px;color:#CFCFCF;text-transform:uppercase;letter-spacing:.05em}
    .kpiValue{font-size:16px;font-weight:700;margin-top:2px}
    .kpiNote{font-size:10px;color:#9AA0A6;margin-top:4px;line-height:1.3}
    .badge{display:inline-block;font-size:10px;padding:1px 6px;border-radius:999px;border:1px solid var(--border);background:#141414;margin-right:4px;margin-bottom:4px}

    /* Viewport */
    #viewport{position:relative;height:calc(100% - 54px - 64px);z-index:10}
    @media (max-width:1100px){#viewport{height:calc(100% - 54px - 100px)}}
    #map{position:absolute;inset:0}

    /* Painel lateral */
    #drawer{position:absolute;top:0;right:0;height:100%;width:360px;background:linear-gradient(180deg,#151515,#101010);
      border-left:1px solid var(--edge);transform:translateX(100%);transition:transform .28s ease;
      display:flex;flex-direction:column;z-index:1000;box-shadow:-12px 0 30px rgba(0,0,0,.35)}
    #drawer.open{transform:translateX(0)}
    .drawer-head{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:10px;border-bottom:1px solid var(--edge)}
    .drawer-title{font-weight:700;font-size:14px;color:#FFD166;line-height:1.2}
    .drawer-sub{font-size:11px;color:#BFBFBF}
    .drawer-body{padding:10px;overflow:auto}
    .row{margin-bottom:8px}
    .label{font-size:10px;color:#9AA0A6;text-transform:uppercase;letter-spacing:.05em;margin-bottom:3px}
    .value{font-size:13px;color:#EAEAEA;white-space:pre-wrap}
    .chip{display:inline-block;font-size:10px;padding:3px 7px;background:#171717;border:1px solid rgba(255,255,255,.12);border-radius:999px}
    .drawer-actions{display:flex;flex-wrap:wrap;gap:6px;padding:10px;border-top:1px dashed var(--edge)}
    .btn{background:transparent;border:1px solid rgba(255,209,102,.5);color:#fff;padding:7px 9px;border-radius:9px;cursor:pointer;font-size:12px}
    .btn:hover{border-color:var(--gold)}
    .closeBtn{background:#191919;border:1px solid rgba(255,255,255,.15);color:#ddd;padding:6px 8px;border-radius:8px;cursor:pointer}

    /* Legenda/Clusters */
    .legend{background:#0F0F0F;color:#fff;padding:8px 10px;font:12px/14px Arial,sans-serif;box-shadow:0 0 15px rgba(0,0,0,.3);border-radius:8px;border:1px solid rgba(255,255,255,.06)}
    .legend .row{display:flex;align-items:center;gap:8px;margin:4px 0}
    .legend .color{width:12px;height:12px;border-radius:50%;border:1px solid rgba(0,0,0,.2)}
    .leaflet-bottom.leaflet-left .legend{margin-bottom:96px;margin-left:10px}

    .marker-cluster-small,.marker-cluster-medium,.marker-cluster-large{background:rgba(255,209,102,.15);border:2px solid var(--gold);color:#111}
    .marker-cluster div{background:var(--gold);color:#111}
    .leaflet-tooltip{background:#111;color:#fff;border:1px solid rgba(255,255,255,.1);border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,.4)}
    .leaflet-tooltip-top:before,.leaflet-tooltip-bottom:before,.leaflet-tooltip-left:before,.leaflet-tooltip-right:before{
      border-top-color:#111!important;border-bottom-color:#111!important;border-left-color:#111!important;border-right-color:#111!important}
  </style>
</head>
<body>
  <!-- Topbar -->
  <div id="topbar">
    <div id="statsLine">A carregar…</div>

    <div class="searchWrap" title="Pesquisar por nome, notas…">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#FFD166" stroke-width="2"><circle cx="11" cy="11" r="7"/><path d="M21 21l-4.35-4.35"/></svg>
      <input id="search" placeholder="Pesquisar empreendimentos…" />
    </div>

    <div class="searchWrap" title="Concelho (inferido)">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#FFD166" stroke-width="2"><circle cx="11" cy="11" r="7"/><path d="M21 21l-4.35-4.35"/></svg>
      <input id="concelhoSearch" placeholder="Concelho (ex.: Porto, Matosinhos…)" list="concelhosList" />
      <datalist id="concelhosList"></datalist>
    </div>

    <div class="searchWrap" title="Ano/Conclusão">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#FFD166" stroke-width="2"><circle cx="11" cy="11" r="7"/><path d="M21 21l-4.35-4.35"/></svg>
      <input id="yearSearch" placeholder="Ano/Conclusão (ex.: 2027 ou Q2 2026)" />
    </div>

    <div id="filters">
      <label><input type="checkbox" class="state-filter" value="em_construcao" checked> Em construção</label>
      <label><input type="checkbox" class="state-filter" value="licenciado" checked> Licenciado</label>
      <label><input type="checkbox" class="state-filter" value="em_licenciamento" checked> Em licenciamento</label>
      <label><input type="checkbox" class="state-filter" value="concluido" checked> Concluído</label>
    </div>

    <button id="focusBtn" class="actionBtn">Focar AMP/Porto</button>
    <button id="clearBtn" class="actionBtn">Limpar filtros</button>
    <button id="exportBtn" class="actionBtn">Exportar CSV</button>
  </div>

  <!-- KPIs (compacto) -->
  <div id="kpiBar">
    <div class="kpiGrid">
      <div class="kpiCard" style="grid-column: span 2;"><div class="kpiTitle">Total visíveis</div><div class="kpiValue" id="kpiTotal">—</div></div>
      <div class="kpiCard" style="grid-column: span 2;"><div class="kpiTitle">Licenciado</div><div class="kpiValue" id="kpiLic">—</div></div>
      <div class="kpiCard" style="grid-column: span 2;"><div class="kpiTitle">Em construção</div><div class="kpiValue" id="kpiCons">—</div></div>
      <div class="kpiCard" style="grid-column: span 2;"><div class="kpiTitle">Concluído</div><div class="kpiValue" id="kpiConc">—</div></div>
      <div class="kpiCard" style="grid-column: span 4;"><div class="kpiTitle">Top 5 Concelhos</div><div class="kpiNote" id="kpiTopConc">—</div></div>
    </div>
  </div>

  <!-- Viewport: mapa + painel -->
  <div id="viewport">
    <div id="map"></div>

    <!-- Painel Lateral -->
    <aside id="drawer" aria-hidden="true">
      <div class="drawer-head">
        <div>
          <div class="drawer-title" id="d_name">—</div>
          <div class="drawer-sub" id="d_sub">—</div>
        </div>
        <button id="drawerClose" class="closeBtn">Fechar ✕</button>
      </div>
      <div class="drawer-body">
        <div class="row"><div class="label">Conclusão</div><div class="value" id="d_conc">—</div></div>
        <div class="row"><div class="label">Notas</div><div class="value" id="d_notes">—</div></div>
        <div class="row"><div class="label">Coordenadas</div><div class="value" id="d_coords">—</div></div>
        <div class="row" id="d_link_row" style="display:none;">
          <div class="label">Ligação</div>
          <div class="value"><a id="d_link" href="#" target="_blank" rel="noreferrer">Abrir ligação do promotor</a></div>
        </div>
      </div>
      <div class="drawer-actions">
        <button id="act_center" class="btn">Centrar no mapa</button>
        <button id="act_gmaps" class="btn">Abrir no Google Maps</button>
        <button id="act_copy"  class="btn">Copiar resumo</button>
        <!-- ALTERAÇÃO: botão → link real -->
        <a id="act_share" class="btn" href="#" target="_blank" rel="noopener noreferrer">Partilhar</a>
      </div>
    </aside>
  </div>

  <!-- Utilitário de scripts -->
  <script>
    function loadScript(srcPrimary, srcBackup){
      return new Promise((resolve, reject)=>{
        const s1=document.createElement('script');
        s1.src=srcPrimary; s1.crossOrigin='anonymous'; s1.defer=true;
        s1.onload=()=>resolve(true);
        s1.onerror=()=>{
          if(!srcBackup) return reject(new Error('Falha no CDN primário: '+srcPrimary));
          const s2=document.createElement('script');
          s2.src=srcBackup; s2.crossOrigin='anonymous'; s2.defer=true;
          s2.onload=()=>resolve(true);
          s2.onerror=()=>reject(new Error('Falha nos CDNs: '+srcPrimary+' e '+srcBackup));
          document.head.appendChild(s2);
        };
        document.head.appendChild(s1);
      });
    }
  </script>

  <!-- App -->
  <script>
    const DEFAULT_GEOJSON="https://ruiquelhas1-lab.github.io/Mapa-Porto/data/empreendimentos.geojson";
    const RAW_MAIN="https://raw.githubusercontent.com/ruiquelhas1-lab/Mapa-Porto/main/data/empreendimentos.geojson";
    const RAW_GHPAGES="https://raw.githubusercontent.com/ruiquelhas1-lab/Mapa-Porto/gh-pages/data/empreendimentos.geojson";

    const stateColors={ licenciado:"#FFD166", em_construcao:"#118AB2", concluido:"#06D6A0", em_licenciamento:"#FFC107" };
    const stateDisplay={ licenciado:"Licenciado", em_construcao:"Em construção", concluido:"Concluído", em_licenciamento:"Em licenciamento" };

    function normalizeEstado(text){
      if(!text) return "";
      let s=String(text).toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/\s+/g,'_').replace(/[^\w]/g,'');
      if(s.includes('licenc')) return 'licenciado';
      if(s.includes('constr')) return 'em_construcao';
      if(s.includes('conclu')||s.includes('entreg')) return 'concluido';
      return s;
    }
    function mapName(obj, keys){ for(const k of keys){ if(obj && obj[k]!=null){ const v=String(obj[k]).trim(); if(v!=='') return v; } } return ''; }
    function normStr(s){ return String(s||'').replace(/\u00A0/g,' ').trim().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,''); }

    // Title Case PT com exceções
    function toTitleCasePt(s){
      const small = new Set(['de','da','do','das','dos','e']);
      const parts = String(s||'').trim().toLowerCase().split(/\s+/);
      return parts.map((w,i)=> small.has(w) && i>0 ? w : w.replace(/^\p{L}/u, m=>m.toUpperCase())).join(' ');
    }

    // Normaliza “2028.0” -> “2028”
    function normalizeConclusao(val){
      if(val==null) return '';
      let s=String(val).trim();
      if(/^(\d{4})([.,]0+)$/.test(s)) return s.replace(/^(\d{4}).*$/,'$1');
      const n=Number(s);
      if(Number.isFinite(n) && Math.abs(n - Math.round(n))<1e-9) return String(Math.round(n));
      return s;
    }

    // Pin SVG com cor
    function makePinIcon(color='#FFD166'){
      const svg = `
        <svg xmlns="http://www.w3.org/2000/svg" width="26" height="36" viewBox="0 0 26 36">
          <defs><filter id="s" x="-50%" y="-50%" width="200%" height="200%">
            <feOffset dy="1" in="SourceAlpha" result="sh"/><feGaussianBlur stdDeviation="1.2" in="sh" result="b"/>
            <feColorMatrix type="matrix" values="0 0 0 0 0  0 0 0 0 0  0 0 0 0 0  0 0 0 .35 0" in="b" result="sh2"/>
            <feMerge><feMergeNode in="sh2"/><feMergeNode in="SourceGraphic"/></feMerge></filter></defs>
          <g filter="url(#s)"><path d="M13 35c-3.5-6.1-10.5-11-10.5-18.3C2.5 8.6 7.8 3 13 3s10.5 5.6 10.5 13.7C23.5 24 16.5 28.9 13 35z" fill="${color}"/>
          <circle cx="13" cy="16" r="4.2" fill="#1A1A1A" opacity="0.85"/><circle cx="13" cy="16" r="2.2" fill="#ffffff"/></g>
        </svg>`;
      const url = 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(svg);
      return L.icon({ iconUrl:url, iconSize:[26,36], iconAnchor:[13,34], popupAnchor:[0,-30], tooltipAnchor:[0,-30] });
    }

    // Fallback por BBOX (AMP/Norte)
    const BBOX = {
      "Porto":            { minLat:41.12, maxLat:41.20, minLng:-8.69, maxLng:-8.55 },
      "Vila Nova de Gaia":{ minLat:41.03, maxLat:41.16, minLng:-8.70, maxLng:-8.51 },
      "Matosinhos":       { minLat:41.17, maxLat:41.26, minLng:-8.75, maxLng:-8.60 },
      "Gondomar":         { minLat:41.09, maxLat:41.19, minLng:-8.59, maxLng:-8.44 },
      "Maia":             { minLat:41.20, maxLat:41.28, minLng:-8.67, maxLng:-8.52 },
      "Valongo":          { minLat:41.16, maxLat:41.25, minLng:-8.53, maxLng:-8.41 },
      "Espinho":          { minLat:40.98, maxLat:41.02, minLng:-8.68, maxLng:-8.58 },
      "Póvoa de Varzim":  { minLat:41.34, maxLat:41.44, minLng:-8.78, maxLng:-8.71 },
      "Vila do Conde":    { minLat:41.27, maxLat:41.41, minLng:-8.78, maxLng:-8.64 }
    };
    function guessConcelhoFromBBox(lat, lng){
      for (const [name, box] of Object.entries(BBOX)) {
        if (lat>=box.minLat && lat<=box.maxLat && lng>=box.minLng && lng<=box.maxLng) return name;
      }
      return '';
    }

    function sanitizeToJSON(txt){ return txt.replace(/^\uFEFF/,'').replace(/\bNaN\b/g,'null').replace(/\bInfinity\b/g,'null').replace(/\b-Infinity\b/g,'null').replace(/,\s*([}\]])/g,'$1'); }
    function parseJSONSafe(txt){ return JSON.parse(sanitizeToJSON(txt)); }
    async function fetchTextNoCache(url){ const bust=url.includes('?')?`&t=${Date.now()}`:`?t=${Date.now()}`; const r=await fetch(url+bust,{cache:'no-store'}); if(!r.ok) throw new Error(`HTTP ${r.status} @ ${url}`); return await r.text(); }
    function loadLeafletStack(){
      return Promise.resolve()
        .then(()=>loadScript('https://unpkg.com/leaflet@1.9.4/dist/leaflet.js','https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js'))
        .then(()=>loadScript('https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js','https://cdn.jsdelivr.net/npm/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js'));
    }

    (async function init(){
      const statsLine=document.getElementById('statsLine');
      const searchEl=document.getElementById('search');
      const concSearchEl=document.getElementById('concelhoSearch');
      const concListEl=document.getElementById('concelhosList');
      const yearEl=document.getElementById('yearSearch');

      const kpiTotal=document.getElementById('kpiTotal');
      const kpiLic=document.getElementById('kpiLic');
      const kpiCons=document.getElementById('kpiCons');
      const kpiConc=document.getElementById('kpiConc');
      const kpiTopConc=document.getElementById('kpiTopConc');

      const drawer=document.getElementById('drawer');
      const dName=document.getElementById('d_name');
      const dSub=document.getElementById('d_sub');
      const dConc=document.getElementById('d_conc');
      const dNotes=document.getElementById('d_notes');
      const dCoords=document.getElementById('d_coords');
      const dLinkRow=document.getElementById('d_link_row');
      const dLink=document.getElementById('d_link');

      const bCenter=document.getElementById('act_center');
      const bGMaps=document.getElementById('act_gmaps');
      const bCopy=document.getElementById('act_copy');
      const aShare=document.getElementById('act_share'); // link (não botão)

      try{ await loadLeafletStack(); }catch(e){
        document.body.innerHTML='<div style="padding:16px;font-family:Arial;color:#111">❌ Falha a carregar bibliotecas do mapa (CDNs bloqueados). Tente noutro browser/rede.</div>';
        return;
      }

      const map=L.map('map');
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:'&copy; OpenStreetMap'}).addTo(map);
      const cluster=L.markerClusterGroup({ showCoverageOnHover:false, disableClusteringAtZoom:17 });
      map.addLayer(cluster);

      const AMP_BOUNDS=L.latLngBounds([[41.03,-8.78],[41.44,-8.41]]);
      document.getElementById('focusBtn').addEventListener('click', ()=>map.fitBounds(AMP_BOUNDS.pad(0.1)));
      document.getElementById('clearBtn').addEventListener('click', ()=>{
        searchEl.value=''; concSearchEl.value=''; yearEl.value='';
        document.querySelectorAll('.state-filter').forEach(cb=>cb.checked=true);
        applyFilters();
      });

      // Export
      document.getElementById('exportBtn').addEventListener('click', ()=>{
        const visible=cluster.getAllChildMarkers();
        if(!visible||!visible.length){ alert('Não há empreendimentos visíveis para exportar.'); return; }
        const key=v=>`${v.latitude}|${v.longitude}`;
        const visibleKeys=new Set(visible.map(m=>key({latitude:m.getLatLng().lat, longitude:m.getLatLng().lng})));
        const headers=['nome','concelho','estado','conclusao','notas','link','latitude','longitude'];
        const csv=[headers.join(';')].concat(
          allRowsForExport.filter(r=>visibleKeys.has(key(r))).map(r=>headers.map(h=>(r[h]??'')).join(';'))
        ).join('\n');
        const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const a=document.createElement('a');
        a.href=URL.createObjectURL(blob); a.download='empreendimentos_filtrados.csv';
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
      });

      // Legenda
      const legend=L.control({position:'bottomleft'});
      legend.onAdd=function(){
        const div=L.DomUtil.create('div','legend');
        const item=(c,l)=>`<div class="row"><span class="color" style="background:${c}"></span><span>${l}</span></div>`;
        div.innerHTML = item('#118AB2','Em construção') + item('#FFD166','Licenciado') + item('#FFC107','Em licenciamento') + item('#06D6A0','Concluído');
        return div;
      };
      legend.addTo(map);

      // Carregar dados (3 fontes)
      const candidates=[DEFAULT_GEOJSON, RAW_MAIN, RAW_GHPAGES];
      const errors=[]; let gj=null; let usedUrl='';
      for(const url of candidates){
        try{ const txt=await fetchTextNoCache(url); gj=parseJSONSafe(txt); usedUrl=url; break; }
        catch(e){ errors.push(url+' → '+e.message); }
      }
      if(!gj||!Array.isArray(gj.features)){
        statsLine.innerHTML='❌ Falha a carregar dados. <small>'+errors.join(' · ')+'</small>';
        return;
      }
      window.__usedUrl = usedUrl;

      const concelhosSet=new Set();
      const allMarkers=[]; let allRowsForExport=[];
      let currentSel=null;

      function openDrawer(data){
        currentSel=data;
        dName.textContent = data.nomeDisplay || 'Empreendimento';
        dSub.innerHTML = `${data.concLabel?toTitleCasePt(data.concLabel)+' · ':''}<span class="chip">${data.estadoLabel||'—'}</span>`;
        dConc.textContent = normalizeConclusao(data.conclusao) || '—';
        dNotes.textContent = data.notasFull || '—';
        dCoords.textContent = `${data.lat.toFixed(6)}, ${data.lng.toFixed(6)}`;
        if(data.link){
          dLinkRow.style.display='';
          dLink.href = /^https?:\/\//i.test(data.link) ? data.link : ('http://' + data.link);
        } else {
          dLinkRow.style.display='none';
        }
        drawer.classList.add('open');
        drawer.setAttribute('aria-hidden','false');
        // Atualiza destino do link de partilha a cada seleção
        setShareHref();
      }
      function closeDrawer(){
        drawer.classList.remove('open');
        drawer.setAttribute('aria-hidden','true');
        currentSel=null;
        setShareHref();
      }
      document.getElementById('drawerClose').addEventListener('click', closeDrawer);

      // Construir marcadores
      gj.features.forEach(f=>{
        const p=f?.properties||{};
        const coords=(f?.geometry?.type==='Point' && Array.isArray(f.geometry.coordinates))? f.geometry.coordinates : null;
        if(!coords) return;
        const [x,y]=coords; const lng=Number(x), lat=Number(y);
        if(!Number.isFinite(lat)||!Number.isFinite(lng)) return;

        // concelho (properties → fallback BBOX)
        let concelho=mapName(p,['concelho','Concelho','municipio','município','city','local','freguesia']).replace(/\s+/g,' ').trim();
        if(!concelho || concelho==='NaN' || concelho==='—'){
          const g = guessConcelhoFromBBox(lat, lng);
          if(g) concelho = g;
        }
        const concLower=normStr(concelho);
        const concLabel=toTitleCasePt(concelho);

        const nomeRaw=mapName(p,['nome','name','titulo','título','projecto','projeto'])||'Empreendimento';
        const nomeDisplay=nomeRaw; const nome=normStr(nomeRaw);
        const estadoKey=normalizeEstado(mapName(p,['estado','status']));
        const estadoLabel=stateDisplay[estadoKey]||mapName(p,['estado','status']);
        const conclusao=normalizeConclusao(mapName(p,['conclusao','conclusão','conclusao_prevista','completion','entrega']));
        const notasFull=mapName(p,['notas','observacoes','observações','notes']); const notas=normStr(notasFull);
        let link=mapName(p,['link','url','website']);
        if(!estadoKey||!stateDisplay[estadoKey]) return;

        if(concLabel) concelhosSet.add(concLabel);

        const icon = makePinIcon(stateColors[estadoKey] || '#FFD166');
        const marker=L.marker([lat,lng],{icon,title:nomeDisplay});

        const tooltipHtml=`<div style="min-width:220px">
            <div style="font-weight:700;font-size:13px;margin-bottom:4px;">${nomeDisplay}</div>
            <div style="font-size:12px;color:#ccc;">${concLabel?concLabel+' · ':''}${estadoLabel}</div>
            ${conclusao?`<div style="font-size:12px;margin-top:4px;"><strong>Conclusão:</strong> ${conclusao}</div>`:''}
            ${notasFull?`<div style="font-size:12px;margin-top:4px;color:#ddd;">${String(notasFull).length>160?(String(notasFull).substring(0,157)+'…'):notasFull}</div>`:''}
          </div>`;
        marker.bindTooltip(tooltipHtml,{direction:'top',offset:[0,-28],sticky:true,opacity:0.95});

        marker.on('click', ()=>{
          map.setView([lat,lng], Math.max(map.getZoom(), 15), {animate:true});
          openDrawer({ nomeDisplay, concLabel, estadoLabel, conclusao, notasFull, link, lat, lng });
        });
        marker.bindPopup(`<strong>${nomeDisplay}</strong><br>${concLabel?concLabel+' · ':''}${estadoLabel}`);

        allMarkers.push({
          marker, estadoKey, estadoLabel,
          nome, nomeDisplay, concLower, concLabel,
          notas, notasFull,
          conclusaoLower: normStr(conclusao),
          conclusaoYear: (/(\b20\d{2}\b)/.exec(normStr(conclusao))||[])[1]||'',
          link, lat, lng
        });
        cluster.addLayer(marker);

        allRowsForExport.push({
          nome: nomeDisplay, concelho: concLabel, estado: estadoLabel, conclusao, notas: notasFull, link, latitude: lat, longitude: lng
        });
      });

      // Autocomplete concelhos
      const frag=document.createDocumentFragment();
      Array.from(concelhosSet.values()).sort((a,b)=>a.localeCompare(b,'pt')).forEach(label=>{
        const opt=document.createElement('option'); opt.value=label; frag.appendChild(opt);
      });
      concListEl.replaceChildren(frag);

      // Enquadramento inicial
      if(cluster.getLayers().length) map.fitBounds(cluster.getBounds().pad(0.2)); else map.setView([41.15,-8.6],12);

      // KPIs + Top5 concelhos
      function renderKPIs(arr){
        const by={ licenciado:0, em_construcao:0, concluido:0, em_licenciamento:0 };
        const concCounts=new Map();
        arr.forEach(o=>{
          if(by.hasOwnProperty(o.estadoKey)) by[o.estadoKey]++;
          const label=(o.concLabel||'').trim();
          if(label){ concCounts.set(label, (concCounts.get(label)||0)+1 ); }
        });
        kpiTotal.textContent=arr.length;
        kpiLic.textContent=by.licenciado;
        kpiCons.textContent=by.em_construcao;
        kpiConc.textContent=by.concluido;

        const top = Array.from(concCounts.entries()).sort((a,b)=>b[1]-a[1]).slice(0,5);
        kpiTopConc.innerHTML = top.length
          ? top.map(([label,n])=>`<span class="badge">${label}: ${n}</span>`).join(' ')
          : '—';

        const usedUrl=(window.__usedUrl||DEFAULT_GEOJSON);
        statsLine.innerHTML=[
          `Fonte: <small>${usedUrl.replace('https://','')}</small>`,
          `Total visíveis: <strong>${arr.length}</strong>`,
          `Licenciado: <strong>${by.licenciado}</strong>`,
          `Em construção: <strong>${by.em_construcao}</strong>`,
          `Concluído: <strong>${by.concluido}</strong>`
        ].join(' · ');
      }
      renderKPIs(allMarkers);

      // Filtros
      function matchesYear(o,yq){
        if(!yq) return true; const s=normStr(yq);
        const yr=/^\d{4}$/.test(s)?s:null; if(yr) return o.conclusaoYear===yr;
        return o.conclusaoLower.includes(s);
      }
      function applyFilters(){
        const q=normStr(searchEl.value);
        const cq=normStr(concSearchEl.value);
        const yq=yearEl.value;
        const allowed=new Set(Array.from(document.querySelectorAll('.state-filter')).filter(cb=>cb.checked).map(cb=>cb.value));
        cluster.clearLayers();
        const filtered=allMarkers.filter(o=>{
          if(!allowed.has(o.estadoKey)) return false;
          const textOk=!q || o.nome.includes(q) || o.notas.includes(q);
          const concOk=!cq|| (o.concLower && o.concLower.includes(cq));
          const conclOk=matchesYear(o,yq);
          return textOk && concOk && conclOk;
        });
        filtered.forEach(o=>cluster.addLayer(o.marker));
        renderKPIs(filtered);
        if(!filtered.length){ map.fitBounds(AMP_BOUNDS.pad(0.1)); }
        else {
          const b=L.latLngBounds(filtered.map(o=>[o.lat,o.lng]));
          if(b.isValid()) map.fitBounds(b.pad(0.2));
        }
        if(currentSel && !filtered.some(o=>o.lat===currentSel.lat && o.lng===currentSel.lng)){
          drawer.classList.remove('open');
          drawer.setAttribute('aria-hidden','true');
        }
      }

      document.querySelectorAll('.state-filter').forEach(cb=>cb.addEventListener('change', applyFilters));
      let t1=null,t2=null,t3=null;
      searchEl.addEventListener('input', ()=>{ clearTimeout(t1); t1=setTimeout(applyFilters,120); });
      concSearchEl.addEventListener('input', ()=>{ clearTimeout(t2); t2=setTimeout(applyFilters,120); });
      yearEl.addEventListener('input', ()=>{ clearTimeout(t3); t3=setTimeout(applyFilters,120); });

      // Botões do painel
      bCenter.addEventListener('click', ()=>{
        if(!currentSel) return;
        map.setView([currentSel.lat,currentSel.lng], Math.max(map.getZoom(), 16), {animate:true});
      });
      bGMaps.addEventListener('click', ()=>{
        if(!currentSel) return;
        const url=`https://www.google.com/maps?q=${currentSel.lat},${currentSel.lng}`;
        window.open(url,'_blank','noopener,noreferrer');
      });
      bCopy.addEventListener('click', async ()=>{
        if(!currentSel) return;
        const lines=[
          `Empreendimento: ${currentSel.nomeDisplay||'—'}`,
          `Concelho: ${currentSel.concLabel||'—'}`,
          `Estado: ${currentSel.estadoLabel||'—'}`,
          `Conclusão: ${normalizeConclusao(currentSel.conclusao)||'—'}`,
          `Notas: ${currentSel.notasFull||'—'}`,
          `Coordenadas: ${currentSel.lat.toFixed(6)}, ${currentSel.lng.toFixed(6)}`,
          currentSel.link ? `Link: ${/^https?:\/\//i.test(currentSel.link)?currentSel.link:('http://'+currentSel.link)}` : ''
        ].filter(Boolean).join('\n');
        try{
          await navigator.clipboard.writeText(lines);
          alert('Resumo copiado para a área de transferência.');
        }catch(_){
          prompt('Copie manualmente o resumo:', lines);
        }
      });

      // PARTILHAR (link real + Web Share + clipboard)
      function buildShareText(sel){
        const gmaps = `https://www.google.com/maps?q=${sel.lat},${sel.lng}`;
        return `${sel.nomeDisplay||'Empreendimento'} · ${sel.concLabel||'—'} · ${sel.estadoLabel||'—'}\n`+
               `Conclusão: ${normalizeConclusao(sel.conclusao)||'—'}\n${gmaps}`;
      }
      function setShareHref(){
        if(!aShare) return;
        if(!currentSel){ aShare.setAttribute('href','#'); return; }
        const text = buildShareText(currentSel);
        const wa = `https://wa.me/?text=${encodeURIComponent(text)}`;
        aShare.setAttribute('href', wa);
      }
      // Handler robusto
      aShare.addEventListener('click', (ev)=>{
        if(!currentSel) { ev.preventDefault(); return; }
        const text = buildShareText(currentSel);
        const gmaps = `https://www.google.com/maps?q=${currentSel.lat},${currentSel.lng}`;

        if (navigator.share) {
          ev.preventDefault();
          navigator.share({ title: currentSel.nomeDisplay || 'Empreendimento', text, url: gmaps })
            .catch(()=>{ /* cancelado */ });
          return;
        }
        // Sem Web Share: segue o link (WhatsApp). Copiamos em paralelo.
        try { navigator.clipboard.writeText(text); } catch(_) {}
        // não impedir a navegação do <a>
      }, { passive:false });

      // KPIs iniciais
      renderKPIs(allMarkers);
    })();
  </script>
</body>
</html>
