<!doctype html>
<html lang="pt-PT">
<head>
  <meta charset="utf-8" />
  <title>Garvetur Porto Pro — Acesso</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --gold:#A38B63;
      --gold-soft:rgba(163,139,99,.35);
      --bg:#0B0B0B;
      --panel:#121212;
      --panel-soft:#181818;
      --text:#FFFFFF;
      --muted:#A0A0A0;
      --danger:#F25F5C;
      --success:#4CAF50;
      --line:rgba(255,255,255,.12);
      --shadow: 0 10px 30px rgba(0,0,0,.55);
      --radius: 18px;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Inter, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 20% 0%, rgba(163,139,99,.18), transparent 55%),
                  radial-gradient(900px 520px at 90% 20%, rgba(76,175,80,.10), transparent 55%),
                  var(--bg);
      color: var(--text);
    }
    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 28px 18px 40px;
    }
    header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:16px;
      margin-bottom: 18px;
    }
    .brand{
      display:flex; flex-direction:column; gap:6px;
    }
    .brand h1{
      font-size: 22px;
      margin:0;
      letter-spacing:.2px;
    }
    .brand p{
      margin:0;
      color:var(--muted);
      font-size: 13px;
    }
    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(0,0,0,.25));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panelHeader{
      padding: 14px 16px;
      border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background: rgba(0,0,0,.35);
    }
    .panelHeader .title{
      font-weight: 650;
      letter-spacing:.2px;
    }
    .pills{
      display:flex; flex-wrap:wrap; gap:8px;
      justify-content:flex-end;
    }
    .pill{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      color:var(--muted);
      background: rgba(0,0,0,.35);
      white-space:nowrap;
    }
    .content{
      padding: 16px;
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 14px;
    }
    @media (max-width: 820px){
      .content{ grid-template-columns: 1fr; }
      header{ flex-direction:column; }
      .pills{ justify-content:flex-start; }
    }
    .card{
      background: rgba(0,0,0,.28);
      border:1px solid var(--line);
      border-radius: 16px;
      padding: 14px;
    }
    .card h2{
      margin:0 0 10px;
      font-size: 15px;
      letter-spacing:.2px;
    }
    .muted{ color:var(--muted); }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    label{ font-size:12px; color:var(--muted); display:block; margin-bottom:6px; }
    input{
      width:100%;
      padding: 11px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.55);
      color: var(--text);
      outline:none;
    }
    input:focus{
      border-color: rgba(163,139,99,.75);
      box-shadow: 0 0 0 3px rgba(163,139,99,.18);
    }
    .btn{
      padding: 10px 12px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color: var(--text);
      cursor:pointer;
      font-weight: 650;
      letter-spacing:.2px;
    }
    .btnPrimary{
      border-color: rgba(163,139,99,.65);
      background: linear-gradient(180deg, rgba(163,139,99,.22), rgba(0,0,0,.45));
    }
    .btnDanger{
      border-color: rgba(242,95,92,.55);
      background: rgba(242,95,92,.10);
    }
    .btn:active{ transform: translateY(1px); }
    .status{
      padding: 10px 12px;
      border:1px dashed rgba(255,255,255,.16);
      border-radius: 12px;
      background: rgba(0,0,0,.25);
      color: var(--muted);
      font-size: 13px;
      line-height: 1.45;
    }
    .msg{
      display:none;
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 13px;
      line-height: 1.35;
      border:1px solid var(--line);
      background: rgba(0,0,0,.25);
    }
    .ok{ border-color: rgba(76,175,80,.55); background: rgba(76,175,80,.10); color:#d8ffe0; }
    .err{ border-color: rgba(242,95,92,.55); background: rgba(242,95,92,.10); color:#ffd7d6; }
    .kv{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      padding: 10px 12px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.40);
      overflow:auto;
      white-space:nowrap;
    }
    .hidden{ display:none !important; }
    .hint{ font-size:12px; color:var(--muted); margin-top:8px; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <h1>Garvetur Porto Pro</h1>
        <p>Acesso e validação de licença (localhost)</p>
      </div>
      <div class="pills">
        <span class="pill" id="pillNet">Rede: —</span>
        <span class="pill" id="pillLic">Licença: —</span>
        <span class="pill" id="pillProf">Perfil: —</span>
      </div>
    </header>

    <div class="panel">
      <div class="panelHeader">
        <div class="title">Estado do Sistema</div>
        <div class="muted" style="font-size:12px">Endpoint: <span id="endpointText"></span></div>
      </div>

      <div class="content">
        <div class="card">
          <h2>Ativação</h2>

          <div class="status" id="statusText">
            A preparar validação…
          </div>

          <div id="gridPanels">
            <div style="margin-top:12px">
              <label for="licenseKey">Chave de licença</label>
              <input id="licenseKey" placeholder="Ex.: GPP-PORTO-006" autocomplete="off" />
              <div class="hint">A ativação inicial requer ligação online. A validação mantém tolerância offline de 48h.</div>
            </div>

            <div class="row" style="margin-top:12px">
              <button class="btn btnPrimary" id="btnActivate">Ativar</button>
              <button class="btn" id="btnRetry">Revalidar</button>
              <button class="btn btnDanger" id="btnReset">Remover licença</button>
            </div>

            <div class="msg ok" id="okBox"></div>
            <div class="msg err" id="errBox"></div>
          </div>
        </div>

        <div class="card">
          <h2>Notas técnicas</h2>
          <p class="muted" style="margin:0 0 10px">
            Esta página valida a licença e encaminha para o Hub. Se o perfil estiver incompleto, abre o módulo de Perfil.
          </p>
          <div class="kv">
            Localhost recomendado: http://localhost:8000
          </div>
          <p class="muted" style="margin:10px 0 0">
            Se trocar de máquina ou browser, valide novamente e confirme as chaves em Local Storage.
          </p>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  const HUB_DEFAULT = 'dashboard.html';
  const PROFILE_PAGE = 'perfil.html';
  const PROFILE_KEY = 'gpp_user_profile_v1';

  const LIC_STORE_KEY = 'gpp_license_state_v1';
  const LICENSE_KEY_STORE = 'gpp_license_key_v1';      // ✅ garante compatibilidade com config-consultores.js
  const CONSULTOR_NOME_KEY = 'gpp_consultor_nome_v1';   // ✅ nome do titular
  const CONSULTORS_LIST_KEY = 'gpp_consultores_v1';     // ✅ para rebuild controlado

  const OFFLINE_TOLERANCE_MS = 48 * 60 * 60 * 1000;

  // ⚠️ URL do Web App (Google Apps Script publicado)
  const LICENSE_ENDPOINT = "https://script.google.com/macros/s/AKfycbyz5e15CDZP8qLbd-tpTd1i4zje2v7aEDXZjDp3q8HqdwZ8RST1rWXBuL94eRuodkQY/exec";

  const el = (id)=>document.getElementById(id);
  const pillNet = el('pillNet');
  const pillLic = el('pillLic');
  const pillProf = el('pillProf');
  const statusText = el('statusText');
  const gridPanels = el('gridPanels');
  const licenseKey = el('licenseKey');
  const btnActivate = el('btnActivate');
  const btnRetry = el('btnRetry');
  const btnReset = el('btnReset');
  const okBox = el('okBox');
  const errBox = el('errBox');
  const endpointText = el('endpointText');
  endpointText.textContent = LICENSE_ENDPOINT ? LICENSE_ENDPOINT : '(a configurar)';

  function setPill(pill, label, good){
    pill.textContent = label;
    pill.style.borderColor = good ? 'rgba(76,175,80,.45)' : 'rgba(255,255,255,.14)';
    pill.style.color = good ? '#d8ffe0' : 'var(--muted)';
    pill.style.background = good ? 'rgba(76,175,80,.10)' : 'rgba(0,0,0,.35)';
  }
  function setPillWarn(pill, label){
    pill.textContent = label;
    pill.style.borderColor = 'rgba(242,95,92,.55)';
    pill.style.color = '#ffd7d6';
    pill.style.background = 'rgba(242,95,92,.10)';
  }

  function showErr(msg){
    errBox.style.display='block';
    errBox.textContent = msg || 'Erro.';
  }
  function showOk(msg){
    okBox.style.display='block';
    okBox.textContent = msg || 'OK.';
  }
  function clearMsgs(){
    okBox.style.display='none'; okBox.textContent='';
    errBox.style.display='none'; errBox.textContent='';
  }

  function safeParse(raw){
    try{ return JSON.parse(raw); }catch(e){ return null; }
  }
  function nowISO(){ return new Date().toISOString(); }

  function uuid(){
    const a = (crypto && crypto.getRandomValues) ? crypto.getRandomValues(new Uint8Array(16)) : null;
    if(!a) return 'id-'+Math.random().toString(16).slice(2)+'-'+Date.now();
    a[6]=(a[6]&0x0f)|0x40; a[8]=(a[8]&0x3f)|0x80;
    const h=[...a].map(b=>b.toString(16).padStart(2,'0')).join('');
    return `${h.slice(0,8)}-${h.slice(8,12)}-${h.slice(12,16)}-${h.slice(16,20)}-${h.slice(20)}`;
  }
  function getDeviceId(){
    const k='gpp_device_id_v1';
    try{
      let v = localStorage.getItem(k);
      if(!v){ v = uuid(); localStorage.setItem(k, v); }
      return v;
    }catch{
      if(!window.__gpp_device_id) window.__gpp_device_id = uuid();
      return window.__gpp_device_id;
    }
  }

  function readLicState(){ return safeParse(localStorage.getItem(LIC_STORE_KEY)) || {}; }
  function writeLicState(obj){ localStorage.setItem(LIC_STORE_KEY, JSON.stringify(obj || {})); }
  function resetLicState(){ try{ localStorage.removeItem(LIC_STORE_KEY); }catch{} }

  function setCompatKeysFromResponse(license_key, resp){
    // ✅ garante que módulos obtêm sempre o titular
    try{
      if(license_key){
        localStorage.setItem(LICENSE_KEY_STORE, String(license_key).trim().toUpperCase());
      }
    }catch(e){}

    // se o endpoint devolver consultor_nome, grava; caso não devolva, não inventa
    const cn = resp && (resp.consultor_nome || resp.consultorNome || resp.owner_name || resp.ownerName);
    if(cn){
      try{ localStorage.setItem(CONSULTOR_NOME_KEY, String(cn).trim()); }catch(e){}
    }
  }

  function profileIsComplete(){
    const p = safeParse(localStorage.getItem(PROFILE_KEY)) || {};
    return !!(p && p.nome && p.empresa && p.cargo);
  }

  function goNext(){
    if(!profileIsComplete()){
      setPillWarn(pillProf, 'Perfil: incompleto');
      statusText.textContent = 'Perfil incompleto — a abrir o módulo de Perfil para registo.';
      window.location.href = PROFILE_PAGE;
      return;
    }
    setPill(pillProf, 'Perfil: OK', true);
    statusText.textContent = 'Acesso validado — a abrir o hub.';
    window.location.href = HUB_DEFAULT;
  }

  async function callEndpoint(payload){
    if(!LICENSE_ENDPOINT) throw new Error('Endpoint de licenças não configurado.');
    const res = await fetch(LICENSE_ENDPOINT, {
      method:'POST',
      headers:{'Content-Type':'text/plain;charset=utf-8'},
      body: JSON.stringify(payload),
      cache:'no-store'
    });
    const txt = await res.text();
    let json=null; try{ json = JSON.parse(txt); }catch{}
    if(!res.ok) throw new Error((json && json.error) ? json.error : (txt || 'Falha de validação.'));
    return json || { ok:false, raw:txt };
  }

  function isOnline(){ return navigator.onLine !== false; }
  function licenseIsWithinOfflineTolerance(state){
    const lastOk = state && state.last_ok_at ? Date.parse(state.last_ok_at) : NaN;
    if(!Number.isFinite(lastOk)) return false;
    return (Date.now() - lastOk) <= OFFLINE_TOLERANCE_MS;
  }

  async function checkLicense(){
    clearMsgs();
    if(isOnline()) setPill(pillNet,'Rede: online',true);
    else setPillWarn(pillNet,'Rede: offline');

    const state = readLicState();
    const deviceId = getDeviceId();

    if(!state || !state.license_key){
      setPillWarn(pillLic,'Licença: por ativar');
      statusText.textContent='Esta máquina ainda não está ativada. Introduza a chave de licença.';
      gridPanels.classList.remove('hidden');
      return false;
    }

    // ✅ compat: garantir também a chave simples, mesmo vinda do state
    setCompatKeysFromResponse(state.license_key, null);

    if(!isOnline()){
      if(licenseIsWithinOfflineTolerance(state)){
        setPill(pillLic,'Licença: OK (offline)',true);
        statusText.textContent='Licença válida (offline dentro da tolerância).';
        goNext(); return true;
      }
      setPillWarn(pillLic,'Licença: bloqueada');
      statusText.textContent='Sem internet e fora da tolerância (48h). Necessita revalidar online.';
      showErr('Sem internet e fora da tolerância. Ligue-se à internet e clique “Revalidar”.');
      return false;
    }

    statusText.textContent='A validar licença online…';
    try{
      const resp = await callEndpoint({ action:'check', license_key: state.license_key, device_id: deviceId });
      if(!resp || !resp.ok) throw new Error((resp && resp.error) ? resp.error : 'Licença inválida.');

      // ✅ gravar chaves auxiliares se o endpoint devolver o nome do consultor
      setCompatKeysFromResponse(state.license_key, resp);

      const st = String(resp.status || '').toUpperCase();
      const next = {
        ...state,
        status: st || 'ACTIVE',
        expires_at: resp.expires_at || state.expires_at || '',
        last_ok_at: nowISO(),
        last_check_at: nowISO()
      };
      writeLicState(next);

      if(st === 'REVOKED'){
        setPillWarn(pillLic,'Licença: revogada'); statusText.textContent='Acesso removido pelo administrador.';
        showErr('Acesso removido. Contacte a administração para reativação.'); return false;
      }
      if(st === 'EXPIRED'){
        setPillWarn(pillLic,'Licença: expirada'); statusText.textContent='Licença expirada. Necessita renovação.';
        showErr('Licença expirada. Contacte a administração para renovação.'); return false;
      }

      setPill(pillLic,'Licença: OK',true);
      statusText.textContent='Licença validada com sucesso.';
      goNext(); return true;

    }catch(e){
      if(licenseIsWithinOfflineTolerance(state)){
        setPill(pillLic,'Licença: OK (tolerância)',true);
        statusText.textContent='Endpoint indisponível, mas dentro da tolerância (48h).';
        goNext(); return true;
      }
      setPillWarn(pillLic,'Licença: bloqueada');
      statusText.textContent='Não foi possível validar a licença online.';
      showErr((e && e.message) ? e.message : 'Não foi possível validar a licença.');
      return false;
    }
  }

  async function activate(){
    clearMsgs();
    const key = (licenseKey.value||'').trim();
    if(!key){ showErr('Introduza a chave de licença.'); return; }

    const deviceId = getDeviceId();
    if(!isOnline()){ showErr('Sem internet. A ativação inicial requer ligação online.'); return; }
    if(!LICENSE_ENDPOINT){ showErr('Endpoint de licenças ainda não configurado. Defina o URL no index.html (LICENSE_ENDPOINT).'); return; }

    statusText.textContent='A ativar licença…';
    try{
      const resp = await callEndpoint({ action:'activate', license_key:key, device_id:deviceId });
      if(!resp || !resp.ok) throw new Error((resp && resp.error) ? resp.error : 'Não foi possível ativar.');

      // ✅ gravar chaves auxiliares (licença e nome do consultor, se vier)
      setCompatKeysFromResponse(key, resp);

      const st = String(resp.status || 'ACTIVE').toUpperCase();
      writeLicState({
        license_key:key,
        status: st,
        expires_at: resp.expires_at || '',
        activated_at: resp.activated_at || nowISO(),
        last_ok_at: nowISO(),
        last_check_at: nowISO()
      });

      if(st === 'REVOKED' || st === 'EXPIRED'){
        setPillWarn(pillLic, st === 'REVOKED' ? 'Licença: revogada' : 'Licença: expirada');
        showErr(resp.message || 'Licença não ativa.'); return;
      }

      setPill(pillLic,'Licença: OK',true);
      showOk('Licença ativada com sucesso nesta máquina.');
      goNext();

    }catch(e){
      setPillWarn(pillLic,'Licença: erro');
      showErr((e && e.message) ? e.message : 'Falha na ativação.');
    }
  }

  btnActivate.addEventListener('click', activate);
  btnRetry.addEventListener('click', checkLicense);

  btnReset.addEventListener('click', ()=>{
    if(!confirm('Pretende remover a licença desta máquina?')) return;

    // limpar estado de licença
    resetLicState();

    // ✅ limpar também as chaves auxiliares e a lista de consultores (para reconstruir “limpo”)
    try{ localStorage.removeItem(LICENSE_KEY_STORE); }catch(e){}
    try{ localStorage.removeItem(CONSULTOR_NOME_KEY); }catch(e){}
    try{ localStorage.removeItem(CONSULTORS_LIST_KEY); }catch(e){}

    setPillWarn(pillLic,'Licença: por ativar');
    statusText.textContent='Licença removida. Introduza uma nova chave para ativar.';
    clearMsgs();
  });

  try{
    if(profileIsComplete()) setPill(pillProf,'Perfil: OK',true);
    else setPillWarn(pillProf,'Perfil: incompleto');
  }catch{ setPillWarn(pillProf,'Perfil: n/d'); }

  checkLicense();
})();
</script>
</body>
</html>
