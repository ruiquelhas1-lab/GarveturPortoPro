<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <title>Garvetur Porto Pro — Mapa</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin="anonymous"
  />
  <style>
    :root {
      --gold: #A38B63;
      --bg: #0E0E0E;
      --panel: #141414;
      --panel-soft: #181818;
      --border-subtle: rgba(163,139,99,0.35);
      --text: #FFFFFF;
      --muted: #A0A0A0;
      --accent: #A38B63;
      --danger: #F45B5B;
      --success: #3FBF7F;
      --info: #4BA3FF;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      background: radial-gradient(circle at top left, #202020 0, #0E0E0E 55%);
      color: var(--text);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
    }

    body {
      display: flex;
      flex-direction: column;
    }

    /* Shell geral */

    .app-shell {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .app-main {
      flex: 1;
      display: grid;
      grid-template-columns: 380px 1fr;
      padding: 12px 18px 18px;
      gap: 16px;
      box-sizing: border-box;
    }

    @media (max-width: 1024px) {
      .app-main {
        grid-template-columns: 1fr;
        grid-template-rows: auto 360px;
      }
      .sidebar {
        order: 2;
      }
      .map-wrapper {
        order: 1;
      }
    }

    /* Cabeçalho comum */

    .app-header {
      position: sticky;
      top: 0;
      z-index: 20;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      padding: 10px 18px;
      border-bottom: 1px solid rgba(163,139,99,0.6);
      background: linear-gradient(90deg, #050505, #121212 35%, #050505 100%);
      box-shadow: 0 10px 28px rgba(0,0,0,0.6);
    }

    .app-header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .brand-mark {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 1px solid var(--gold);
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at 30% 0, #f3e4c1 0, #A38B63 40%, #2b2416 100%);
      color: #121212;
      font-weight: 700;
      font-size: 15px;
    }

    .brand-text {
      display: flex;
      flex-direction: column;
    }

    .brand-title {
      font-size: 16px;
      font-weight: 600;
      letter-spacing: 0.04em;
    }

    .brand-subtitle {
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    .app-header-center {
      flex: 1;
      display: flex;
      justify-content: center;
    }

    .nav-tabs {
      display: inline-flex;
      padding: 3px;
      border-radius: 999px;
      background: rgba(20,20,20,0.9);
      border: 1px solid rgba(163,139,99,0.4);
      backdrop-filter: blur(10px);
    }

    .nav-tab {
      position: relative;
      padding: 6px 14px;
      font-size: 12px;
      color: var(--muted);
      text-decoration: none;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      border: none;
      background: transparent;
      transition: all 0.18s ease;
    }

    .nav-tab span.dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: transparent;
    }

    .nav-tab:hover {
      color: #f5f5f5;
      background: rgba(255,255,255,0.04);
    }

    .nav-tab.active {
      color: #0D0D0D;
      background: linear-gradient(135deg, #F5E6C9, #A38B63);
      box-shadow: 0 0 0 1px rgba(250,244,230,0.4), 0 8px 22px rgba(0,0,0,0.7);
    }

    .nav-tab.active span.dot {
      background: #0D0D0D;
    }

    .app-header-right {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      color: var(--muted);
    }

    .badge-env {
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(163,139,99,0.7);
      background: rgba(5,5,5,0.9);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .btn-ghost-xs {
      padding: 4px 9px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      background: transparent;
      color: var(--muted);
      font-size: 11px;
      cursor: pointer;
    }
    .btn-ghost-xs:hover {
      border-color: rgba(255,255,255,0.4);
      color: #fff;
    }

    /* Painéis do mapa */

    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .panel {
      background: var(--panel);
      border-radius: 14px;
      border: 1px solid var(--border-subtle);
      box-shadow: 0 14px 40px rgba(0,0,0,0.7);
      padding: 10px 12px;
      box-sizing: border-box;
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }

    .panel-title {
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .kpi-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .kpi-pill {
      flex: 1 1 90px;
      min-width: 90px;
      background: radial-gradient(circle at top left, #262018 0, #151515 55%);
      border-radius: 12px;
      border: 1px solid rgba(163,139,99,0.5);
      padding: 6px 8px;
      box-sizing: border-box;
    }

    .kpi-label {
      font-size: 10px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .kpi-value {
      margin-top: 2px;
      font-size: 16px;
      font-weight: 600;
    }

    .kpi-sub {
      font-size: 11px;
      color: var(--muted);
      margin-top: 2px;
    }

    .field-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 4px;
    }

    .field-label {
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .field-row {
      display: flex;
      gap: 8px;
    }

    .field-row > * {
      flex: 1;
    }

    .input, select {
      width: 100%;
      box-sizing: border-box;
      background: #0E0E0E;
      border-radius: 10px;
      border: 1px solid rgba(163,139,99,0.4);
      color: #f5f5f5;
      font-size: 12px;
      padding: 6px 8px;
      outline: none;
    }

    .input::placeholder {
      color: #6f6f6f;
    }

    .input:focus, select:focus {
      border-color: var(--gold);
    }

    .btn-sm {
      font-size: 11px;
      border-radius: 999px;
      padding: 5px 9px;
      border: 1px solid rgba(163,139,99,0.6);
      background: rgba(255,255,255,0.02);
      color: #f5f5f5;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }

    .btn-sm:hover {
      background: rgba(163,139,99,0.15);
    }

    .btn-sm.primary {
      background: linear-gradient(135deg, #F5E6C9, #A38B63);
      color: #111;
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }

    .list-panel {
      margin-top: 4px;
      max-height: 380px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .card {
      border-radius: 12px;
      border: 1px solid rgba(163,139,99,0.35);
      background: radial-gradient(circle at top left, #252018 0, #121212 65%);
      padding: 8px 9px;
      margin-bottom: 7px;
      cursor: pointer;
      transition: border-color 0.15s ease, transform 0.12s ease, box-shadow 0.12s ease;
    }

    .card:hover {
      border-color: var(--gold);
      transform: translateY(-1px);
      box-shadow: 0 8px 18px rgba(0,0,0,0.6);
    }

    .card-title {
      font-size: 13px;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      gap: 6px;
    }

    .card-meta {
      margin-top: 2px;
      font-size: 11px;
      color: var(--muted);
    }

    .card-badges {
      margin-top: 5px;
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
    }

    .chip {
      font-size: 10px;
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.17);
      color: var(--muted);
    }

    .chip-estado {
      text-transform: uppercase;
      letter-spacing: 0.1em;
      font-weight: 600;
    }

    .chip-estado.construcao {
      border-color: var(--danger);
      color: #ffb3b3;
    }

    .chip-estado.licenciado {
      border-color: var(--gold);
      color: #f3e8c6;
    }

    .chip-estado.concluido {
      border-color: var(--success);
      color: #adf7c9;
    }

    .empty {
      font-size: 12px;
      color: var(--muted);
      padding: 6px 2px;
    }

    /* Mapa */

    .map-wrapper {
      position: relative;
      border-radius: 16px;
      background: #101010;
      border: 1px solid rgba(163,139,99,0.4);
      overflow: hidden;
      box-shadow: 0 18px 44px rgba(0,0,0,0.85);
      display: flex;
      flex-direction: column;
    }

    #map {
      flex: 1;
      width: 100%;
      height: 100%;
      min-height: 420px;
    }

    .map-top-bar {
      position: absolute;
      top: 8px;
      left: 8px;
      right: 8px;
      z-index: 500;
      display: flex;
      justify-content: space-between;
      align-items: center;
      pointer-events: none;
    }

    .map-top-left, .map-top-right {
      pointer-events: auto;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .map-badge {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(15,15,15,0.86);
      border: 1px solid rgba(163,139,99,0.7);
      color: var(--muted);
      backdrop-filter: blur(6px);
    }

    .legend {
      position: absolute;
      bottom: 10px;
      left: 10px;
      z-index: 500;
      background: rgba(15,15,15,0.88);
      border-radius: 10px;
      border: 1px solid rgba(163,139,99,0.5);
      padding: 6px 8px;
      font-size: 11px;
      color: var(--muted);
      backdrop-filter: blur(6px);
    }

    .legend-row {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 3px;
    }

    .legend-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      border: 1px solid rgba(0,0,0,0.7);
    }

    .legend-dot.construcao {
      background: #F45B5B;
      box-shadow: 0 0 0 3px rgba(244,91,91,0.4);
    }

    .legend-dot.licenciado {
      background: #F5E6C9;
      box-shadow: 0 0 0 3px rgba(163,139,99,0.4);
    }

    .legend-dot.concluido {
      background: #3FBF7F;
      box-shadow: 0 0 0 3px rgba(63,191,127,0.3);
    }

    .legend-dot.outros {
      background: #CBCBCB;
      box-shadow: 0 0 0 3px rgba(203,203,203,0.3);
    }

    /* Pins (Leaflet divIcon) */

    .g-pin {
      position: relative;
      width: 18px;
      height: 24px;
      transform: translate(-9px, -22px);
    }

    .g-pin-core {
      position: absolute;
      left: 50%;
      top: 0;
      width: 16px;
      height: 16px;
      margin-left: -8px;
      border-radius: 999px 999px 999px 999px;
      border: 2px solid rgba(0,0,0,0.8);
      box-sizing: border-box;
      box-shadow: 0 5px 14px rgba(0,0,0,0.8);
    }

    .g-pin-tail {
      position: absolute;
      left: 50%;
      bottom: 1px;
      width: 4px;
      height: 8px;
      margin-left: -2px;
      background: rgba(0,0,0,0.75);
      border-radius: 999px;
    }

    .g-pin-core.construcao {
      background: #F45B5B;
      box-shadow:
        0 0 0 2px rgba(244,91,91,0.65),
        0 0 0 8px rgba(244,91,91,0.18),
        0 6px 14px rgba(0,0,0,0.9);
      animation: pulse-obra 1.5s infinite ease-out;
    }

    .g-pin-core.licenciado {
      background: #F5E6C9;
      box-shadow:
        0 0 0 2px rgba(163,139,99,0.8),
        0 6px 14px rgba(0,0,0,0.9);
    }

    .g-pin-core.concluido {
      background: #3FBF7F;
      box-shadow:
        0 0 0 2px rgba(63,191,127,0.8),
        0 6px 14px rgba(0,0,0,0.9);
    }

    .g-pin-core.outros {
      background: #CBCBCB;
      box-shadow:
        0 0 0 2px rgba(180,180,180,0.8),
        0 6px 14px rgba(0,0,0,0.9);
    }

    @keyframes pulse-obra {
      0% {
        box-shadow:
          0 0 0 2px rgba(244,91,91,0.7),
          0 0 0 8px rgba(244,91,91,0.26),
          0 6px 14px rgba(0,0,0,0.9);
      }
      70% {
        box-shadow:
          0 0 0 2px rgba(244,91,91,0.0),
          0 0 0 14px rgba(244,91,91,0.0),
          0 6px 16px rgba(0,0,0,1);
      }
      100% {
        box-shadow:
          0 0 0 2px rgba(244,91,91,0.0),
          0 0 0 4px rgba(244,91,91,0.0),
          0 6px 14px rgba(0,0,0,0.9);
      }
    }

    /* Popup */

    .leaflet-popup-content {
      font-size: 12px;
      margin: 6px 8px;
    }

    .popup-title {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .popup-meta {
      font-size: 11px;
      color: #555;
      margin-bottom: 3px;
    }

    .popup-link {
      font-size: 11px;
      margin-top: 4px;
    }

    .popup-link a {
      color: #0A67C2;
      text-decoration: none;
    }

    .popup-link a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header class="app-header">
      <div class="app-header-left">
        <div class="brand-mark">G</div>
        <div class="brand-text">
          <div class="brand-title">Garvetur Porto Pro</div>
          <div class="brand-subtitle">Garvetur Luxury Porto · Mapa</div>
        </div>
      </div>
      <div class="app-header-center">
        <nav class="nav-tabs">
          <a href="index.html" class="nav-tab active">
            <span class="dot"></span>Mapa
          </a>
          <a href="kanban.html" class="nav-tab">
            <span class="dot"></span>Leads
          </a>
          <a href="angariacoes.html" class="nav-tab">
            <span class="dot"></span>Angariações
          </a>
          <a href="dashboard.html" class="nav-tab">
            <span class="dot"></span>Dashboard
          </a>
        </nav>
      </div>
      <div class="app-header-right">
        <div class="badge-env">Porto · Comercial</div>
        <button type="button" class="btn-ghost-xs" onclick="location.reload()">Recarregar</button>
      </div>
    </header>

    <main class="app-main">
      <!-- Sidebar esquerda -->
      <section class="sidebar">
        <!-- KPIs topo -->
        <div class="panel">
          <div class="panel-header">
            <div class="panel-title">Resumo Mapa</div>
            <span class="text-muted" style="font-size:11px;" id="kpi-dataLabel">Sem dados</span>
          </div>
          <div class="kpi-row">
            <div class="kpi-pill">
              <div class="kpi-label">Total empreendimentos</div>
              <div class="kpi-value" id="kpi-total">0</div>
              <div class="kpi-sub" id="kpi-concelhos">— concelhos</div>
            </div>
            <div class="kpi-pill">
              <div class="kpi-label">Em construção</div>
              <div class="kpi-value" id="kpi-construcao">0</div>
              <div class="kpi-sub">Obras em curso</div>
            </div>
            <div class="kpi-pill">
              <div class="kpi-label">Licenciado</div>
              <div class="kpi-value" id="kpi-licenciado">0</div>
              <div class="kpi-sub">Projetos licenciados</div>
            </div>
            <div class="kpi-pill">
              <div class="kpi-label">Concluído</div>
              <div class="kpi-value" id="kpi-concluido">0</div>
              <div class="kpi-sub">Pronto / entregue</div>
            </div>
          </div>
        </div>

        <!-- Controlo de dados -->
        <div class="panel">
          <div class="panel-header">
            <div class="panel-title">Dados (CSV)</div>
          </div>
          <div class="field-group">
            <label class="field-label">Importar empreendimentos</label>
            <input type="file" id="csvInput" accept=".csv" class="input" />
            <div class="text-muted" style="margin-top:4px;">
              Espera-se um ficheiro <strong>empreendimentos.csv</strong> com colunas:<br>
              <em>nome, concelho, estado, promotor, tipologias, conclusao, preco_m2, notas, latitude, longitude, link</em>.
            </div>
            <div class="btn-row">
              <button type="button" class="btn-sm primary" id="btnLoadSample">
                Usar dados guardados
              </button>
              <button type="button" class="btn-sm" id="btnClear">
                Limpar dados
              </button>
            </div>
            <div class="text-muted" id="dataStatus" style="margin-top:4px; font-size:11px;">
              Nenhum ficheiro carregado.
            </div>
          </div>
        </div>

        <!-- Filtros -->
        <div class="panel">
          <div class="panel-header">
            <div class="panel-title">Filtros</div>
          </div>
          <div class="field-group">
            <label class="field-label">Estado</label>
            <div class="field-row">
              <select id="estadoFilter">
                <option value="todos">Todos</option>
                <option value="em_construcao">Em construção</option>
                <option value="licenciado">Licenciado</option>
                <option value="concluido">Concluído</option>
              </select>
            </div>
          </div>
          <div class="field-group">
            <label class="field-label">Concelho</label>
            <select id="concelhoFilter">
              <option value="todos">Todos</option>
            </select>
          </div>
          <div class="field-group">
            <label class="field-label">Pesquisa livre</label>
            <input id="searchInput" class="input" placeholder="Nome, promotor, notas…" />
          </div>
        </div>

        <!-- Lista de empreendimentos -->
        <div class="panel" style="flex:1; min-height:0;">
          <div class="panel-header">
            <div class="panel-title">Empreendimentos</div>
            <span class="text-muted" id="listCount" style="font-size:11px;">0</span>
          </div>
          <div class="list-panel" id="listPanel">
            <div class="empty">Sem dados. Importe um ficheiro CSV.</div>
          </div>
        </div>
      </section>

      <!-- Mapa à direita -->
      <section class="map-wrapper">
        <div class="map-top-bar">
          <div class="map-top-left">
            <div class="map-badge">
              AMP / Porto · vista geral
            </div>
          </div>
          <div class="map-top-right">
            <button type="button" class="btn-sm" id="btnFocusPorto">
              Focar AMP/Porto
            </button>
          </div>
        </div>
        <div id="map"></div>
        <div class="legend">
          <div class="legend-row">
            <div class="legend-dot construcao"></div>
            <span>Em construção</span>
          </div>
          <div class="legend-row">
            <div class="legend-dot licenciado"></div>
            <span>Licenciado</span>
          </div>
          <div class="legend-row">
            <div class="legend-dot concluido"></div>
            <span>Concluído</span>
          </div>
          <div class="legend-row">
            <div class="legend-dot outros"></div>
            <span>Outros / sem estado</span>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin="anonymous"
  ></script>
  <script>
    // --- Estado global ---
    let empreendimentos = [];
    let map, markerLayer;

    // --- Utils ---

    function normalizeEstado(raw) {
      if (!raw) return '';
      const s = String(raw).toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
      if (s.includes('constr')) return 'em_construcao';
      if (s.includes('licen')) return 'licenciado';
      if (s.includes('conclu') || s.includes('entreg')) return 'concluido';
      return s || '';
    }

    function parseNumber(n) {
      if (n === null || n === undefined) return null;
      if (typeof n === 'number') return isFinite(n) ? n : null;
      const s = String(n).trim().replace(/\./g, '').replace(',', '.');
      if (!s) return null;
      const v = Number(s);
      return isFinite(v) ? v : null;
    }

    function parseCSV(text) {
      const lines = text.split(/\r?\n/).filter(l => l.trim().length > 0);
      if (!lines.length) return [];

      // Detectar separador (vírgula ou ponto e vírgula)
      const headSample = lines[0];
      const commaCount = (headSample.match(/,/g) || []).length;
      const semiCount = (headSample.match(/;/g) || []).length;
      const sep = semiCount > commaCount ? ';' : ',';

      const headers = lines[0].split(sep).map(h => h.trim().toLowerCase());
      const rows = [];

      for (let i = 1; i < lines.length; i++) {
        const line = lines[i];
        if (!line.trim()) continue;
        const cols = line.split(sep);
        const row = {};
        headers.forEach((h, idx) => {
          row[h] = cols[idx] !== undefined ? cols[idx].trim() : '';
        });
        rows.push(row);
      }
      return rows;
    }

    function getPinClass(estadoNorm) {
      if (estadoNorm === 'em_construcao') return 'construcao';
      if (estadoNorm === 'licenciado') return 'licenciado';
      if (estadoNorm === 'concluido') return 'concluido';
      return 'outros';
    }

    function formatConclusao(c) {
      if (!c) return '—';
      const n = parseNumber(c);
      if (n && n % 1 === 0 && n > 1900 && n < 2100) return String(n);
      return String(c);
    }

    // --- UI update ---

    function updateKPIs() {
      const total = empreendimentos.length;
      const estadosCount = { em_construcao: 0, licenciado: 0, concluido: 0 };
      const concelhosSet = new Set();

      empreendimentos.forEach(e => {
        if (e.concelho) concelhosSet.add(e.concelho);
        const est = normalizeEstado(e.estado);
        if (est === 'em_construcao') estadosCount.em_construcao++;
        else if (est === 'licenciado') estadosCount.licenciado++;
        else if (est === 'concluido') estadosCount.concluido++;
      });

      document.getElementById('kpi-total').textContent = total;
      document.getElementById('kpi-construcao').textContent = estadosCount.em_construcao;
      document.getElementById('kpi-licenciado').textContent = estadosCount.licenciado;
      document.getElementById('kpi-concluido').textContent = estadosCount.concluido;
      document.getElementById('kpi-concelhos').textContent = concelhosSet.size
        ? concelhosSet.size + ' concelhos'
        : '— concelhos';
      document.getElementById('kpi-dataLabel').textContent =
        total ? 'Dados carregados (' + total + ')' : 'Sem dados';

      // Popular filtro de concelho
      const concelhoFilter = document.getElementById('concelhoFilter');
      const current = concelhoFilter.value;
      const concelhos = Array.from(concelhosSet).sort((a, b) =>
        a.localeCompare(b, 'pt')
      );
      concelhoFilter.innerHTML = '<option value="todos">Todos</option>';
      concelhos.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c;
        opt.textContent = c;
        concelhoFilter.appendChild(opt);
      });
      if (concelhos.includes(current)) concelhoFilter.value = current;
    }

    function applyFiltersAndRender() {
      const estadoSel = document.getElementById('estadoFilter').value;
      const concelhoSel = document.getElementById('concelhoFilter').value;
      const q = document.getElementById('searchInput').value.trim().toLowerCase();

      const filtered = empreendimentos.filter(e => {
        const estNorm = normalizeEstado(e.estado);
        if (estadoSel !== 'todos' && estNorm !== estadoSel) return false;
        if (concelhoSel !== 'todos' && e.concelho !== concelhoSel) return false;

        if (q) {
          const haystack = [
            e.nome,
            e.concelho,
            e.promotor,
            e.tipologias,
            e.notas
          ]
            .map(v => (v || '').toString().toLowerCase())
            .join(' ');
          if (!haystack.includes(q)) return false;
        }
        return true;
      });

      renderList(filtered);
      renderMarkers(filtered);
    }

    function renderList(list) {
      const listPanel = document.getElementById('listPanel');
      const listCount = document.getElementById('listCount');
      listPanel.innerHTML = '';

      listCount.textContent = list.length;

      if (!list.length) {
        listPanel.innerHTML = '<div class="empty">Sem resultados com os filtros atuais.</div>';
        return;
      }

      list.forEach(item => {
        const card = document.createElement('div');
        card.className = 'card';
        const estNorm = normalizeEstado(item.estado);
        const estClass =
          estNorm === 'em_construcao'
            ? 'construcao'
            : estNorm === 'licenciado'
            ? 'licenciado'
            : estNorm === 'concluido'
            ? 'concluido'
            : '';

        card.innerHTML = `
          <div class="card-title">
            <span>${item.nome || '—'}</span>
            <span style="font-size:11px; color:${item.preco_m2 ? '#f3e8c6' : '#888'};">
              ${item.preco_m2 ? Number(item.preco_m2).toLocaleString('pt-PT', { maximumFractionDigits: 0 }) + ' €/m²' : ''}
            </span>
          </div>
          <div class="card-meta">
            ${item.concelho || '—'} ${item.tipologias ? '· ' + item.tipologias : ''} ${
          item.conclusao ? '· ' + formatConclusao(item.conclusao) : ''
        }
          </div>
          <div class="card-badges">
            <span class="chip chip-estado ${estClass}">
              ${estNorm || 'sem estado'}
            </span>
            ${
              item.promotor
                ? '<span class="chip">Promotor: ' + item.promotor + '</span>'
                : ''
            }
          </div>
        `;

        card.addEventListener('click', () => {
          if (item._lat != null && item._lng != null && map) {
            map.setView([item._lat, item._lng], 16, { animate: true });
          }
        });

        listPanel.appendChild(card);
      });
    }

    function renderMarkers(list) {
      if (!map || !markerLayer) return;
      markerLayer.clearLayers();

      if (!list.length) return;

      const bounds = [];

      list.forEach(item => {
        if (item._lat == null || item._lng == null) return;

        const estNorm = normalizeEstado(item.estado);
        const pinClass = getPinClass(estNorm);

        const icon = L.divIcon({
          className: '',
          html:
            '<div class="g-pin">' +
            '<div class="g-pin-core ' +
            pinClass +
            '"></div>' +
            '<div class="g-pin-tail"></div>' +
            '</div>',
          iconSize: [18, 24],
          iconAnchor: [9, 22]
        });

        const marker = L.marker([item._lat, item._lng], { icon });

        const popupHtml =
          '<div class="popup-title">' +
          (item.nome || '—') +
          '</div>' +
          '<div class="popup-meta">' +
          (item.concelho || '—') +
          (item.tipologias ? ' · ' + item.tipologias : '') +
          (item.conclusao ? ' · ' + formatConclusao(item.conclusao) : '') +
          '</div>' +
          (item.estado
            ? '<div class="popup-meta">Estado: ' + item.estado + '</div>'
            : '') +
          (item.promotor
            ? '<div class="popup-meta">Promotor: ' + item.promotor + '</div>'
            : '') +
          (item.preco_m2
            ? '<div class="popup-meta">Preço médio: ' +
              Number(item.preco_m2).toLocaleString('pt-PT', {
                maximumFractionDigits: 0
              }) +
              ' €/m²</div>'
            : '') +
          (item.notas
            ? '<div class="popup-meta">Notas: ' + item.notas + '</div>'
            : '') +
          (item.link
            ? '<div class="popup-link"><a href="' +
              item.link +
              '" target="_blank" rel="noreferrer">Abrir link do empreendimento</a></div>'
            : '');

        marker.bindPopup(popupHtml);
        marker.addTo(markerLayer);

        bounds.push([item._lat, item._lng]);
      });

      if (bounds.length) {
        const b = L.latLngBounds(bounds);
        map.fitBounds(b.pad(0.2));
      }
    }

    function mapRowToEmpreendimento(row) {
      const get = (keys) => {
        for (const k of keys) {
          if (row[k] !== undefined && row[k] !== '') return row[k];
        }
        return '';
      };

      const nome = get(['nome', 'name', 'titulo', 'título']);
      const concelho = get(['concelho', 'municipio', 'município']);
      const estado = get(['estado', 'status']);
      const promotor = get(['promotor', 'developer']);
      const tipologias = get(['tipologias', 'typologies']);
      const conclusao = get(['conclusao', 'conclusão', 'conclusao_prevista']);
      const preco_m2 = get(['preco_m2', 'preço_m2', 'preco_med_m2']);
      const notas = get(['notas', 'observacoes', 'observações']);
      const link = get(['link', 'url', 'website']);
      const lat = parseNumber(get(['latitude', 'lat']));
      const lng = parseNumber(get(['longitude', 'lng', 'lon']));

      return {
        nome,
        concelho,
        estado,
        promotor,
        tipologias,
        conclusao,
        preco_m2,
        notas,
        link,
        _lat: lat,
        _lng: lng
      };
    }

    // --- Inicialização ---

    function initMap() {
      map = L.map('map', {
        zoomControl: true,
        scrollWheelZoom: true
      }).setView([41.15, -8.61], 12); // AMP/Porto

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution:
          '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
      }).addTo(map);

      markerLayer = L.layerGroup().addTo(map);
    }

    function initEvents() {
      document.getElementById('csvInput').addEventListener('change', (ev) => {
        const file = ev.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const text = e.target.result;
            const rows = parseCSV(text);
            empreendimentos = rows.map(mapRowToEmpreendimento);
            localStorage.setItem('gpp_empreendimentos_csv', text);
            document.getElementById('dataStatus').textContent =
              'Ficheiro carregado: ' + file.name + ' (' + empreendimentos.length + ' registos).';
            updateKPIs();
            applyFiltersAndRender();
          } catch (err) {
            console.error(err);
            document.getElementById('dataStatus').textContent =
              'Erro ao ler o ficheiro CSV.';
          }
        };
        reader.readAsText(file, 'utf-8');
      });

      document.getElementById('btnLoadSample').addEventListener('click', () => {
        const stored = localStorage.getItem('gpp_empreendimentos_csv');
        if (!stored) {
          document.getElementById('dataStatus').textContent =
            'Não existem dados guardados no navegador.';
          return;
        }
        try {
          const rows = parseCSV(stored);
          empreendimentos = rows.map(mapRowToEmpreendimento);
          document.getElementById('dataStatus').textContent =
            'Dados carregados do navegador (' + empreendimentos.length + ' registos).';
          updateKPIs();
          applyFiltersAndRender();
        } catch (err) {
          console.error(err);
          document.getElementById('dataStatus').textContent =
            'Erro ao ler dados guardados.';
        }
      });

      document.getElementById('btnClear').addEventListener('click', () => {
        empreendimentos = [];
        localStorage.removeItem('gpp_empreendimentos_csv');
        updateKPIs();
        applyFiltersAndRender();
        document.getElementById('dataStatus').textContent =
          'Dados limpos. Importe um novo ficheiro CSV.';
      });

      document.getElementById('estadoFilter').addEventListener('change', applyFiltersAndRender);
      document.getElementById('concelhoFilter').addEventListener('change', applyFiltersAndRender);
      document.getElementById('searchInput').addEventListener('input', applyFiltersAndRender);

      document.getElementById('btnFocusPorto').addEventListener('click', () => {
        if (map) {
          map.setView([41.15, -8.61], 12, { animate: true });
        }
      });

      // Ao iniciar, tentar carregar CSV guardado anteriormente
      const stored = localStorage.getItem('gpp_empreendimentos_csv');
      if (stored) {
        try {
          const rows = parseCSV(stored);
          empreendimentos = rows.map(mapRowToEmpreendimento);
          document.getElementById('dataStatus').textContent =
            'Dados carregados automaticamente (' + empreendimentos.length + ' registos).';
          updateKPIs();
          applyFiltersAndRender();
        } catch (err) {
          console.error(err);
        }
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      initMap();
      initEvents();
    });
  </script>
</body>
</html>
