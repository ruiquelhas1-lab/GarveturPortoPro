<!doctype html>
<html lang="pt-PT">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Garvetur Porto Pro — Relatório Semanal</title>

<style>
  :root{
    --gold:#A38B63;
    --bg:#0B0B0B;
    --panel:#141414;
    --border:rgba(255,255,255,.14);
    --text:#FFFFFF;
    --muted:#C9C9C9;
    --radius:14px;
  }
  *{ box-sizing:border-box; }
  html,body{ margin:0; height:100%; }
  body{
    font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
    background:radial-gradient(circle at top,#1c1c1c 0,#050505 55%,#000 100%);
    color:var(--text);
  }

  header{
    display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;
    padding:12px 16px;
    border-bottom:1px solid rgba(163,139,99,.35);
    background:linear-gradient(90deg,#050505,#111,#050505);
  }
  .brand{
    display:flex;align-items:center;gap:10px;
  }
  .brand-icon{
    width:26px;height:26px;border-radius:999px;border:1px solid var(--gold);
    display:flex;align-items:center;justify-content:center;
    box-shadow:0 0 0 1px rgba(163,139,99,.3);
  }
  .brand h1{
    margin:0;font-size:15px;letter-spacing:.06em;text-transform:uppercase;color:var(--gold);
  }
  .brand .sub{
    margin-top:2px;font-size:11px;color:var(--muted);letter-spacing:.12em;text-transform:uppercase;
  }

  .btn{
    border-radius:10px;
    border:1px solid rgba(163,139,99,.35);
    background:rgba(12,12,12,.9);
    color:var(--text);
    padding:8px 12px;
    font-size:13px;
    cursor:pointer;
    transition:.18s border-color,.18s transform;
    white-space:nowrap;
  }
  .btn:hover{ border-color:var(--gold); transform:translateY(-1px); }
  .btn.primary{
    background:var(--gold);
    color:#0A0A0A;
    border-color:var(--gold);
    font-weight:800;
  }

  .wrap{
    display:grid;
    grid-template-columns:360px minmax(0,1fr);
    min-height:calc(100vh - 62px);
  }
  @media(max-width:980px){
    .wrap{ grid-template-columns:1fr; }
  }

  .side{
    padding:14px;
    border-right:1px solid var(--border);
    background:radial-gradient(circle at top left,#141414,#060606);
  }
  .main{
    padding:14px 16px;
    overflow:auto;
  }

  .card{
    background:rgba(0,0,0,.45);
    border:1px solid rgba(163,139,99,.22);
    border-radius:var(--radius);
    padding:12px;
    margin-bottom:12px;
  }

  .hint{ color:var(--muted); font-size:12px; line-height:1.35; }
  label{ display:block; font-size:12px; color:#dcdcdc; margin:8px 0 6px; }
  input,textarea{
    width:100%;
    background:rgba(0,0,0,.7);
    border:1px solid rgba(255,255,255,.16);
    border-radius:10px;
    color:#fff;
    padding:8px 10px;
    outline:none;
    font-size:12px;
  }
  input:focus,textarea:focus{
    border-color:var(--gold);
    box-shadow:0 0 0 1px rgba(163,139,99,.35);
  }
  textarea{ min-height:90px; resize:vertical; }

  .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }

 /* ===== Hero premium — Garvetur dark + gold ===== */
.hero{
  position:relative;
  border:1px solid rgba(163,139,99,.35);
  background:
    radial-gradient(900px 380px at 10% 0%, rgba(163,139,99,.18) 0%, rgba(0,0,0,0) 55%),
    linear-gradient(180deg, #0B0B0B 0%, #000000 100%);
  border-radius:18px;
  padding:14px 14px 12px;
  margin-bottom:12px;
  box-shadow:0 18px 36px rgba(0,0,0,.65);
}

.hero::after{
  content:"";
  position:absolute;
  inset:0;
  border-radius:18px;
  pointer-events:none;
  box-shadow:inset 0 0 0 1px rgba(255,255,255,.06);
}

.hero .top{
  display:flex;
  align-items:flex-end;
  justify-content:space-between;
  gap:10px;
  flex-wrap:wrap;
}

.hero h2{
  margin:0;
  font-size:16px;
  letter-spacing:.10em;
  text-transform:uppercase;
  color:#FFFFFF;
  text-shadow:0 2px 16px rgba(0,0,0,.75);
}

.range{
  color:var(--gold);
  font-size:12px;
  letter-spacing:.14em;
  text-transform:uppercase;
  font-weight:700;
  text-shadow:0 2px 14px rgba(0,0,0,.75);
}

.hero .hint,
.hero .hint b{
  color:rgba(255,255,255,.82);
}

  .kpis{
    display:grid;
    grid-template-columns:repeat(2, minmax(0,1fr));
    gap:10px;
  }
  @media(max-width:900px){
    .kpis{ grid-template-columns:1fr; }
  }
 .kpi{
  position:relative;
  background:
    linear-gradient(180deg, rgba(18,18,18,.95), rgba(6,6,6,.85));
  border:1px solid rgba(163,139,99,.65);
  border-radius:14px;
  padding:14px 12px 12px;
  box-shadow:0 18px 32px rgba(0,0,0,.65);
}

/* linha dourada subtil — reforço visual do KPI */
.kpi::before{
  content:"";
  position:absolute;
  left:14px;
  right:14px;
  top:10px;
  height:2px;
  border-radius:999px;
  background:linear-gradient(
    90deg,
    rgba(163,139,99,.10),
    rgba(163,139,99,.85),
    rgba(163,139,99,.10)
  );
  opacity:.6;
}
  .kpi .name{
    font-size:11px;
    color:#ddd;
    letter-spacing:.14em;
    text-transform:uppercase;
  }
  .kpi .val{
  font-size:28px;
  font-weight:900;
  margin-top:6px;
  color:#FFFFFF;
  text-shadow:0 2px 10px rgba(0,0,0,.55);
}
 .kpi .src{
  margin-top:8px;
  display:inline-flex;
  font-size:11px;
  padding:3px 9px;
  border-radius:999px;
  border:1px solid rgba(163,139,99,.35);
  color:rgba(255,255,255,.88);
  background:linear-gradient(180deg, rgba(163,139,99,.12), rgba(0,0,0,.55));
}

  .toast{
    position:fixed;
    right:14px;
    bottom:14px;
    z-index:99999;
    padding:10px 12px;
    border-radius:12px;
    background:rgba(0,0,0,.85);
    border:1px solid rgba(163,139,99,.35);
    color:#fff;
    font-size:12px;
    display:none;
  }

@media print{
  header,.side,.toast{ display:none !important; }

  body{
  /* fundo premium — off-white quente */
  background:#F4F2EE !important; /* marfim/cinza muito claro */
  color:#111 !important;
  -webkit-print-color-adjust: exact !important;
  print-color-adjust: exact !important;
}
  .wrap{ display:block; }

  /* dar contraste entre fundo e conteúdo */
.wrap{
  background:#F4F2EE !important;
}

/* painéis mantêm-se brancos para leitura */
.hero,
.kpi,
.card{
  background:#FFFFFF !important;
}

  /* HERO — versão executiva clara com assinatura dourada */
  .hero{
    background:#fff !important;
    border:1px solid rgba(163,139,99,.75) !important;
    box-shadow:none !important;
  }
  .hero::after{ box-shadow:none !important; }
  .hero h2{ color:#111 !important; text-shadow:none !important; }
  .range{ color:rgba(163,139,99,1) !important; text-shadow:none !important; }
  .hero .hint, .hero .hint b{ color:#333 !important; }

  /* KPIs / Cards — branco “premium”, não “vazio” */
  .kpi, .card{
    background:#fff !important;
    border:1px solid rgba(163,139,99,.60) !important;
    box-shadow:none !important;
  }

  /* manter o detalhe premium no topo do KPI (linha dourada) */
  .kpi::before{
    background: linear-gradient(
      90deg,
      rgba(163,139,99,.10),
      rgba(163,139,99,1),
      rgba(163,139,99,.10)
    ) !important;
    opacity:.90 !important;
  }

  .kpi .name{ color:#333 !important; }
  .kpi .val{ color:#111 !important; text-shadow:none !important; }

  /* Chip “Fonte” com look executivo */
  .kpi .src{
    border:1px solid rgba(163,139,99,.55) !important;
    color:#333 !important;
    background:#fff !important;
  }

  /* Último bloco (Comentário) — destaque dourado no PDF */
  .main .card:last-of-type{
    border:1px solid rgba(163,139,99,.80) !important;
    background:#fff !important;
  }
  .main .card:last-of-type::before{
    background: linear-gradient(
      90deg,
      rgba(163,139,99,.10),
      rgba(163,139,99,1),
      rgba(163,139,99,.10)
    ) !important;
    opacity:.95 !important;
  }
  .main .card:last-of-type .hint{
    color: rgba(163,139,99,1) !important;
    letter-spacing:.12em !important;
    text-transform:uppercase !important;
    font-weight:900 !important;
  }

  textarea, input{
    background:#fff !important;
    color:#111 !important;
    border:1px solid rgba(0,0,0,.18) !important;
    box-shadow:none !important;
  }

  /* ===== Observações nos KPI — legibilidade premium em PDF ===== */

/* Label "Observações" */
.kpi label{
  color:#111 !important;
  font-weight:800 !important;
  letter-spacing:.08em !important;
  text-transform:uppercase !important;
  margin-top:10px !important;
}

/* Campo de texto das observações */
.kpi textarea{
  background:#FAF9F7 !important; /* branco quente */
  border:1px solid rgba(163,139,99,.55) !important;
  color:#111 !important;
  padding:10px 12px !important;
  font-size:12px !important;
  line-height:1.45 !important;
}

/* Placeholder (quando vazio) */
.kpi textarea::placeholder{
  color:#777 !important;
}

/* Foco visual (não agressivo no PDF) */
.kpi textarea:focus{
  border-color:rgba(163,139,99,.85) !important;
  box-shadow:none !important;
}

  @page{ margin: 12mm; }
}
/* ===== Destaque premium — Comentário semanal do Diretor ===== */
.main .card:last-of-type{
  position:relative;
  border:1px solid rgba(163,139,99,.55);
  background:
    radial-gradient(900px 260px at 12% 0%, rgba(163,139,99,.22) 0%, rgba(0,0,0,0) 55%),
    linear-gradient(180deg, rgba(10,10,10,.95), rgba(0,0,0,.75));
  box-shadow:0 22px 40px rgba(0,0,0,.65);
}

/* Linha dourada superior — assinatura Garvetur */
.main .card:last-of-type::before{
  content:"";
  position:absolute;
  left:14px;
  right:14px;
  top:10px;
  height:3px;
  border-radius:999px;
  background:linear-gradient(
    90deg,
    rgba(163,139,99,.10),
    rgba(163,139,99,1),
    rgba(163,139,99,.10)
  );
}

/* Título do bloco final com presença executiva */
.main .card:last-of-type .hint{
  color:var(--gold);
  letter-spacing:.14em;
  text-transform:uppercase;
  font-weight:900;
}
  


  /* ===== Versão Executiva (PDF) ===== */
  .print-only{ display:none; }
  .screen-only{ display:block; }

  .exec-cover, .exec-page{ break-inside: avoid; }
  .exec-cover{
    border:1px solid rgba(163,139,99,.60);
    border-radius:18px;
    padding:22px 22px 18px;
    background:
      radial-gradient(900px 380px at 12% 0%, rgba(163,139,99,.18) 0%, rgba(0,0,0,0) 58%),
      linear-gradient(180deg, #0B0B0B 0%, #000000 100%);
    box-shadow:0 18px 36px rgba(0,0,0,.55);
    margin:0 0 14px;
  }
  .exec-cover .brandline{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    flex-wrap:wrap;
  }
  .exec-cover .ttl{
    margin:0;
    color:#fff;
    font-size:18px;
    letter-spacing:.10em;
    text-transform:uppercase;
  }
  .exec-cover .subttl{
    margin-top:6px;
    color:rgba(255,255,255,.82);
    font-size:12px;
    letter-spacing:.10em;
    text-transform:uppercase;
  }
  .exec-kpi-grid{
    display:grid;
    grid-template-columns:repeat(3, minmax(0,1fr));
    gap:10px;
    margin-top:14px;
  }
  .exec-kpi{
    position:relative;
    border:1px solid rgba(163,139,99,.55);
    border-radius:14px;
    padding:12px 12px 10px;
    background:linear-gradient(180deg, rgba(18,18,18,.96), rgba(6,6,6,.86));
  }
  .exec-kpi .kname{ font-size:11px; color:rgba(255,255,255,.80); letter-spacing:.14em; text-transform:uppercase; }
  .exec-kpi .kval{ font-size:26px; font-weight:900; color:#fff; margin-top:6px; }
  .exec-kpi .kchip{ margin-top:6px; display:inline-flex; font-size:11px; padding:3px 9px; border-radius:999px; border:1px solid rgba(163,139,99,.35); color:rgba(255,255,255,.88); background:linear-gradient(180deg, rgba(163,139,99,.12), rgba(0,0,0,.55)); }

  .exec-page{
    border:1px solid rgba(163,139,99,.35);
    border-radius:16px;
    padding:14px;
    background:rgba(0,0,0,.45);
    margin:0 0 12px;
  }
  .exec-page h3{
    margin:0 0 10px;
    color:var(--gold);
    font-size:13px;
    letter-spacing:.14em;
    text-transform:uppercase;
  }
  .exec-topic{
    border:1px solid rgba(163,139,99,.22);
    border-radius:14px;
    padding:12px;
    background:rgba(0,0,0,.30);
    margin-bottom:10px;
  }
  .exec-topic .topline{ display:flex; align-items:baseline; justify-content:space-between; gap:10px; flex-wrap:wrap; }
  .exec-topic .tname{ font-weight:900; letter-spacing:.10em; text-transform:uppercase; font-size:11px; color:#fff; }
  .exec-topic .tval{ font-weight:900; font-size:16px; color:#fff; }
  .exec-notes{ margin-top:8px; color:rgba(255,255,255,.90); font-size:12px; line-height:1.45; white-space:pre-wrap; }
  .exec-notes.empty{ color:rgba(255,255,255,.55); }

  @media print{
    .print-only{ display:block !important; }
    .screen-only{ display:none !important; }

    /* Página com respiro e contraste */
    body{ background:#F4F2EE !important; color:#111 !important; }
    .main{ padding:0 !important; overflow:visible !important; }

    /* Cover/Pages em versão clara */
    .exec-cover{
      background:
        radial-gradient(900px 380px at 12% 0%, rgba(163,139,99,.20) 0%, rgba(0,0,0,0) 58%),
        linear-gradient(180deg, #ffffff 0%, #fbfaf8 100%) !important;
      box-shadow:none !important;
      border:1px solid rgba(163,139,99,.75) !important;
    }
    .exec-cover .ttl{ color:#111 !important; text-shadow:none !important; }
    .exec-cover .subttl{ color:#333 !important; }

    .exec-kpi{ background:#fff !important; border:1px solid rgba(163,139,99,.60) !important; }
    .exec-kpi .kname{ color:#333 !important; }
    .exec-kpi .kval{ color:#111 !important; }
    .exec-kpi .kchip{ background:#fff !important; color:#333 !important; border:1px solid rgba(163,139,99,.55) !important; }

    .exec-page{ background:#fff !important; border:1px solid rgba(163,139,99,.60) !important; box-shadow:none !important; }
    .exec-page h3{ color:rgba(163,139,99,1) !important; }
    .exec-topic{ background:#fff !important; border:1px solid rgba(163,139,99,.40) !important; }
    .exec-topic .tname{ color:#111 !important; }
    .exec-topic .tval{ color:#111 !important; }
    .exec-notes{ color:#111 !important; }
    .exec-notes.empty{ color:#555 !important; }

    /* Forçar que o Comentário nunca parte a meio */
    .exec-page.comment{ page-break-inside: avoid !important; break-inside: avoid !important; }
    .exec-page.comment{ page-break-before: always !important; }

    /* Forçar que "Notas por tópico" começa numa nova página */
    .exec-page.notes{ page-break-before: always !important; }

    @page{ margin: 12mm; }
  }

</style>
</head>

<body>
<header>
  <div class="brand">
    <div class="brand-icon">
      <svg width="16" height="16" viewBox="0 0 24 24" stroke="var(--gold)" fill="none" stroke-width="1.8">
        <circle cx="12" cy="12" r="9"></circle>
        <path d="M8 12.5l2.5 2.5L16 9"></path>
      </svg>
    </div>
    <div>
      <h1>Garvetur Porto Pro — Relatório Semanal</h1>
      <div class="sub">Automático + comentário do Diretor/Coordenador</div>
    </div>
  </div>

  <div class="row">
    <button class="btn" id="btnCopy">Copiar Email</button>
    <button class="btn" id="btnPrint">Imprimir / PDF</button>
  </div>
</header>

<div class="wrap">
  <aside class="side">
    <div class="card">
      <div class="hint">Semana (2.ª feira → domingo)</div>

      <label for="weekStart">Início (2.ª feira)</label>
      <input id="weekStart" type="date" />

      <label for="weekEnd">Fim (domingo)</label>
      <input id="weekEnd" type="date" />

      <div class="row" style="margin-top:10px">
        <button class="btn primary" id="btnRefresh">Atualizar</button>
        <button class="btn" id="btnThisWeek">Esta semana</button>
      </div>

      <div class="hint" style="margin-top:10px">
        Esta página é <b>só de leitura</b>. Não altera os módulos.
      </div>
    </div>

    <div class="card">
      <div class="hint" style="margin-bottom:8px">Assunto & destinatários (opcional)</div>

      <label for="emailSubject">Assunto</label>
      <input id="emailSubject" placeholder="Relatório Semanal — 12 a 18 Jan 2026" />

      <label for="emailTo">Destinatários</label>
      <textarea id="emailTo" placeholder="Direção / Administração"></textarea>

      <div class="hint" style="margin-top:10px">
        As observações e comentário ficam guardados por semana (localmente no navegador).
      </div>
    </div>
  </aside>

  <main class="main">

    <!-- ===== Versão Executiva (impressão/PDF) ===== -->
    <div class="print-only">
      <section class="exec-cover">
        <div class="brandline">
          <div>
            <h2 class="ttl">Relatório Semanal — Garvetur Luxury Porto</h2>
            <div class="subttl" id="pRange">Semana: —</div>
          </div>
          <div class="subttl">Executivo · KPI + Notas</div>
        </div>

        <div class="exec-kpi-grid" aria-label="KPIs">
          <div class="exec-kpi"><div class="kname">Leads</div><div class="kval" id="pKLeads">0</div><div class="kchip">Fonte: Kanban</div></div>
          <div class="exec-kpi"><div class="kname">Angariações</div><div class="kval" id="pKAng">0</div><div class="kchip">Fonte: Angariações</div></div>
          <div class="exec-kpi"><div class="kname">Visitas</div><div class="kval" id="pKVis">0</div><div class="kchip">Fonte: Kanban</div></div>
          <div class="exec-kpi"><div class="kname">Propostas</div><div class="kval" id="pKProp">0</div><div class="kchip">Fonte: Kanban</div></div>
          <div class="exec-kpi"><div class="kname">CPCV</div><div class="kval" id="pKCpcv">0</div><div class="kchip">Fonte: Kanban</div></div>
          <div class="exec-kpi"><div class="kname">Escrituras</div><div class="kval" id="pKEsc">0</div><div class="kchip">Fonte: Kanban</div></div>
        </div>
      </section>

      <section class="exec-page notes">
        <h3>Notas por tópico</h3>

        <div class="exec-topic">
          <div class="topline"><div class="tname">Leads</div><div class="tval" id="pKLeads2">0</div></div>
          <div class="exec-notes" id="pObsLeads"></div>
        </div>

        <div class="exec-topic">
          <div class="topline"><div class="tname">Angariações</div><div class="tval" id="pKAng2">0</div></div>
          <div class="exec-notes" id="pObsAng"></div>
        </div>

        <div class="exec-topic">
          <div class="topline"><div class="tname">Visitas</div><div class="tval" id="pKVis2">0</div></div>
          <div class="exec-notes" id="pObsVis"></div>
        </div>

        <div class="exec-topic">
          <div class="topline"><div class="tname">Propostas</div><div class="tval" id="pKProp2">0</div></div>
          <div class="exec-notes" id="pObsProp"></div>
        </div>

        <div class="exec-topic">
          <div class="topline"><div class="tname">CPCV</div><div class="tval" id="pKCpcv2">0</div></div>
          <div class="exec-notes" id="pObsCpcv"></div>
        </div>

        <div class="exec-topic">
          <div class="topline"><div class="tname">Escrituras</div><div class="tval" id="pKEsc2">0</div></div>
          <div class="exec-notes" id="pObsEsc"></div>
        </div>
      </section>

      <section class="exec-page comment">
        <h3>Comentário semanal do Coordenador / Diretor</h3>
        <div class="exec-notes" id="pWeeklyComment"></div>
      </section>
    </div>

    <!-- ===== Versão de trabalho (ecrã) ===== -->
    <div class="screen-only">

    <div class="hero">
      <div class="top">
        <h2>Resumo semanal de actividade</h2>
        <div class="range" id="rangeLabel">—</div>
      </div>
      <div class="hint" style="margin-top:6px">
        KPIs calculados automaticamente a partir de <b>Leads</b> e <b>Angariações</b>. Observações e comentário são editáveis.
      </div>
    </div>

    <section class="kpis">
      <div class="kpi">
        <div class="name">Leads (semana)</div>
        <div class="val" id="kLeads">0</div>
        <div class="src">Fonte: Kanban (lead.data)</div>
        <label>Observações</label>
        <textarea id="obsLeads" placeholder="Origem, qualidade, temas recorrentes, próximos passos..."></textarea>
      </div>

      <div class="kpi">
        <div class="name">Angariações (semana)</div>
        <div class="val" id="kAng">0</div>
        <div class="src">Fonte: Angariações (dataAngariacao)</div>
        <label>Observações</label>
        <textarea id="obsAng" placeholder="Produto, exclusividade, pricing, obstáculos, ações comerciais..."></textarea>
      </div>

            <div class="kpi">
        <div class="name">Visitas (semana)</div>
        <div class="val" id="kVis">0</div>
        <div class="src">Fonte: Kanban (campos de visita)</div>
        <label>Observações</label>
        <textarea id="obsVis" placeholder="Visitas realizadas, taxa de comparência, principais feedbacks, próximos passos..."></textarea>
      </div>

      <div class="kpi">
        <div class="name">Propostas (semana)</div>
        <div class="val" id="kProp">0</div>
        <div class="src">Fonte: Kanban (campos de proposta)</div>
        <label>Observações</label>
        <textarea id="obsProp" placeholder="Propostas recebidas/enviadas, condições, contrapropostas, riscos e follow-ups..."></textarea>
      </div>

      <div class="kpi">
        <div class="name">CPCV (semana)</div>
        <div class="val" id="kCpcv">0</div>
        <div class="src">Fonte: Kanban (fecho_cpcv_date)</div>
        <label>Observações</label>
        <textarea id="obsCpcv" placeholder="Principais negócios, condições, prazos, pontos críticos..."></textarea>
      </div>

      <div class="kpi">
        <div class="name">Escrituras (semana)</div>
        <div class="val" id="kEsc">0</div>
        <div class="src">Fonte: Kanban (fecho_escritura_date)</div>
        <label>Observações</label>
        <textarea id="obsEsc" placeholder="Fechos, pendências, risco de atraso, follow-ups..."></textarea>
      </div>
    </section>

    <div class="card" style="margin-top:12px">
      <div class="hint" style="margin-bottom:8px">Comentário semanal do Coordenador / Diretor</div>
      <textarea id="weeklyComment" style="min-height:170px" placeholder="Resumo executivo: principais acontecimentos, decisões tomadas, riscos, prioridades e foco para a próxima semana..."></textarea>
    </div>
      </div>
  </main>
</div>

<div class="toast" id="toast"></div>

<script>
(function(){
  // ====== Fontes (confirmadas nos seus módulos) ======
  const LS_LEADS_KEY = 'gpp_leads_v5';        // Kanban: LEADS array (lead.data, fecho_cpcv_date, fecho_escritura_date)
  const LS_ANG_KEY   = 'gpp_angariacoes_v2';  // Angariações: array ou {deals:[]}, usa dataAngariacao

  // ====== Persistência do relatório semanal ======
  const REPORT_KEY_PREFIX = 'gpp_weekly_report_v1:'; // por semana

  const $ = (id)=>document.getElementById(id);

  function toast(msg){
    const el = $('toast');
    el.textContent = msg;
    el.style.display = 'block';
    setTimeout(()=>{ el.style.display='none'; }, 2200);
  }

  function safeParse(raw){
    if(!raw) return null;
    try{ return JSON.parse(raw); }catch(e){ return null; }
  }

function parseISODateUTC(s){
  // Aceita: YYYY-MM-DD (inputs type="date") e DD/MM/YYYY (ex.: 16/01/2026)
  if(!s || typeof s !== 'string') return null;
  const raw = s.trim();

  // YYYY-MM-DD
  let m = raw.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if(m){
    const dt = new Date(Date.UTC(+m[1], +m[2]-1, +m[3]));
    return isNaN(dt.getTime()) ? null : dt;
  }

  // DD/MM/YYYY
  m = raw.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
  if(m){
    const dd = +m[1], mm = +m[2], yy = +m[3];
    const dt = new Date(Date.UTC(yy, mm-1, dd));
    return isNaN(dt.getTime()) ? null : dt;
  }

  return null;
}

  function inRangeISO(dateStr, startUTC, endUTC){
    const dt = parseISODateUTC(dateStr);
    if(!dt) return false;
    const t = dt.getTime();
    return t >= startUTC.getTime() && t <= endUTC.getTime();
  }

  function isoYMD(dt){
    const y = dt.getUTCFullYear();
    const m = String(dt.getUTCMonth()+1).padStart(2,'0');
    const d = String(dt.getUTCDate()).padStart(2,'0');
    return y + '-' + m + '-' + d;
  }

  function getWeekBoundsUTC(baseDate){
    // 2ª feira -> domingo
    const d = new Date(baseDate);
    const day = d.getDay(); // 0=Dom..1=Seg
    const diffToMon = (day === 0) ? -6 : (1 - day);
    d.setDate(d.getDate() + diffToMon);
    const start = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
    const end = new Date(start);
    end.setUTCDate(end.getUTCDate() + 6);
    return { start, end };
  }

  function reportKeyForCurrentWeek(){
    const s = $('weekStart').value;
    const e = $('weekEnd').value;
    return REPORT_KEY_PREFIX + s + '|' + e;
  }

  function loadLeads(){
    const parsed = safeParse(localStorage.getItem(LS_LEADS_KEY));
    return Array.isArray(parsed) ? parsed : [];
  }

  function loadAngariacoes(){
    const parsed = safeParse(localStorage.getItem(LS_ANG_KEY));
    if(Array.isArray(parsed)) return parsed;
    if(parsed && typeof parsed === 'object' && Array.isArray(parsed.deals)) return parsed.deals;
    return [];
  }

  // ====== Guardar/Carregar observações por semana ======
  function loadWeeklyNotes(){
    const key = reportKeyForCurrentWeek();
    const saved = safeParse(localStorage.getItem(key));
    if(!saved || typeof saved !== 'object') return;

    $('emailSubject').value = saved.emailSubject || $('emailSubject').value || '';
    $('emailTo').value      = saved.emailTo || '';

    $('obsLeads').value     = saved.obsLeads || '';
    $('obsAng').value       = saved.obsAng || '';
    $('obsCpcv').value      = saved.obsCpcv || '';
    $('obsEsc').value       = saved.obsEsc || '';
    $('obsVis').value       = saved.obsVis || '';
    $('obsProp').value      = saved.obsProp || '';
    $('weeklyComment').value= saved.weeklyComment || '';

    syncExecutive();
  }

  function saveWeeklyNotes(){
    const key = reportKeyForCurrentWeek();
    const payload = {
      emailSubject: $('emailSubject').value || '',
      emailTo: $('emailTo').value || '',
      obsLeads: $('obsLeads').value || '',
      obsAng: $('obsAng').value || '',
      obsCpcv: $('obsCpcv').value || '',
      obsEsc: $('obsEsc').value || '',
      obsVis: $('obsVis').value || '',
      obsProp: $('obsProp').value || '',
      weeklyComment: $('weeklyComment').value || '',
      savedAt: new Date().toISOString()
    };
    try{
      localStorage.setItem(key, JSON.stringify(payload));
    }catch(e){
      console.error('Relatório semanal: erro ao guardar notas', e);
    }
  }

  function wireAutosave(){
    const ids = ['emailSubject','emailTo','obsLeads','obsAng','obsCpcv','obsEsc','obsVis','obsProp','weeklyComment'];
    ids.forEach(id=>{
      const el = $(id);
      if(!el) return;
      el.addEventListener('input', ()=>{
        // pequeno debounce
        clearTimeout(el.__t);
        el.__t = setTimeout(()=>{ saveWeeklyNotes(); syncExecutive(); }, 220);
      });
    });
  }

  // ====== Cálculo KPIs ======
  function computeKPIs(){
    const startStr = $('weekStart').value;
    const endStr = $('weekEnd').value;

    const start = parseISODateUTC(startStr);
    const end = parseISODateUTC(endStr);

    if(!start || !end){
      toast('Datas inválidas.');
      return;
    }

    $('rangeLabel').textContent = startStr + ' → ' + endStr;

    const leads = loadLeads();
    const angs  = loadAngariacoes();

    // Leads da semana: usar o campo garantido do Kanban: lead.data (vem do input id="ld_data")
    const leadsWeek = leads.filter(l => inRangeISO(l.data || '', start, end));
    $('kLeads').textContent = String(leadsWeek.length);

    // Angariações da semana: dataAngariacao
    const angWeek = angs.filter(a => inRangeISO(a.dataAngariacao || '', start, end));
    $('kAng').textContent = String(angWeek.length);

    // CPCV / Escrituras: campos de fecho do Kanban
    const cpcvWeek = leads.filter(l => inRangeISO(l.fecho_cpcv_date || '', start, end));
    const escWeek  = leads.filter(l => inRangeISO(l.fecho_escritura_date || '', start, end));
    $('kCpcv').textContent = String(cpcvWeek.length);
    $('kEsc').textContent  = String(escWeek.length);

      // ===== Visitas (semana) =====
// Regra: lead em estado "Visita" cuja data principal esteja na semana
const visitasWeek = leads.filter(l =>
  l.estado === 'Visita' && inRangeISO(l.data || '', start, end)
);
$('kVis').textContent = String(visitasWeek.length);

// ===== Propostas (semana) =====
// Conta: proposta inicial + contra-propostas (mesmo lead).
// Robusto: aceita lead.proposta como object OU string(JSON) e aceita várias chaves de data nas contra-propostas.

const propEvents = new Set();

// Campos “soltos” (compatibilidade com versões antigas)
const PROP_FIELDS = [
  'ld_prop_data',            // (se alguma versão guardou assim)
  'proposta_date',
  'dataProposta',
  'propostaData',
  'proposta_enviada_date',
  'proposta_recebida_date'
];

// Chaves possíveis para datas nas contra-propostas (robusto)
const CP_DATE_FIELDS = [
  'data',                   // formato atual do teu Kanban (PROPOSTA_CONTRAS)
  'dataContraProposta',
  'data_contra',
  'dataContra',
  'dataProposta',
  'propostaData'
];

leads.forEach((l, idx) => {
  if(!l) return;
  const lid = l.id || ('lead_' + idx);

  // (A) Fallback antigo — datas diretas no lead (se existirem)
  PROP_FIELDS.forEach(f => {
    const raw = l[f];
    if(typeof raw === 'string' && raw.trim()){
      const iso = normDateToISO(raw);
      if(iso && inRangeISO(iso, start, end)){
        propEvents.add(`direct|${lid}|${iso}`);
      }
    }
  });

  // (B) Estrutura do Kanban: lead.proposta (pode ser objeto OU string JSON)
  let p = l.proposta;

  if(typeof p === 'string' && p.trim()){
    try{ p = JSON.parse(p); }catch(e){ /* ignora */ }
  }

  if(p && typeof p === 'object'){

    // Proposta inicial
    const pISO = normDateToISO(String(p.dataProposta || ''));
    if(pISO && inRangeISO(pISO, start, end)){
      propEvents.add(`prop|${lid}|${pISO}`);
    }

    // Contra-propostas: pode haver variações de nome do array
    const cps =
      Array.isArray(p.contraPropostas) ? p.contraPropostas :
      Array.isArray(p.contrapropostas) ? p.contrapropostas :
      Array.isArray(p.contra_propostas) ? p.contra_propostas :
      [];

    cps.forEach((cp, cidx) => {
      if(!cp) return;

      // tenta várias chaves até encontrar uma data
      const rawDate = CP_DATE_FIELDS
        .map(k => cp && cp[k])
        .find(v => typeof v === 'string' && v.trim());

      const cpISO = normDateToISO(String(rawDate || ''));
      if(cpISO && inRangeISO(cpISO, start, end)){
        propEvents.add(`contra|${lid}|${cidx}|${cpISO}`);
      }
    });
  }

  // (C) Ultra-fallback (opcional): se o lead estiver em "Proposta" e a data principal estiver na semana
  // Isto evita zeros em cenários onde a equipa muda o estado mas não preenche datas na proposta/contra-proposta.
  if(l.estado === 'Proposta'){
    const dISO = normDateToISO(String(l.data || ''));
    if(dISO && inRangeISO(dISO, start, end)){
      propEvents.add(`estado|${lid}|${dISO}`);
    }
  }
});

$('kProp').textContent = String(propEvents.size);

    
    // assunto sugerido (não pisa se o Rui já escreveu)
    if(!$('emailSubject').value.trim()){
      $('emailSubject').value = 'Relatório Semanal — ' + startStr + ' a ' + endStr;
    }

    syncExecutive();

    toast('Relatório atualizado.');
  }

  function copyEmail(){
    const s = $('weekStart').value;
    const e = $('weekEnd').value;
    const subject = ($('emailSubject').value || '').trim() || ('Relatório Semanal — ' + s + ' a ' + e);
    const to = ($('emailTo').value || '').trim();

    const body =
`Assunto: ${subject}
${to ? ('Para: ' + to + '\n') : ''}
Relatório Semanal de Actividade (${s} → ${e})

1) Leads: ${$('kLeads').textContent}
Observações: ${$('obsLeads').value.trim() || '-'}

2) Angariações: ${$('kAng').textContent}
Observações: ${$('obsAng').value.trim() || '-'}

3) Visitas: ${$('kVis').textContent}
Observações: ${$('obsVis').value.trim() || '-'}

4) Propostas: ${$('kProp').textContent}
Observações: ${$('obsProp').value.trim() || '-'}

5) CPCV: ${$('kCpcv').textContent}
Observações: ${$('obsCpcv').value.trim() || '-'}

6) Escrituras: ${$('kEsc').textContent}
Observações: ${$('obsEsc').value.trim() || '-'}

Comentário do Coordenador/Diretor:
${$('weeklyComment').value.trim() || '-'}

Cumprimentos,
Rui Quelhas`;

    // Safari: pode bloquear clipboard — fallback para prompt
    navigator.clipboard.writeText(body)
      .then(()=>toast('Email copiado.'))
      .catch(()=>{ prompt('Copie o texto do email:', body); });
  }



  // ====== Versão Executiva (PDF) ======
  function setText(id, txt){
    const el = $(id);
    if(!el) return;
    el.textContent = (txt == null ? '' : String(txt));
  }
  function setNotes(id, txt){
    const el = $(id);
    if(!el) return;
    const v = (txt || '').toString().trim();
    if(!v){
      el.textContent = '—';
      el.classList.add('empty');
    }else{
      el.textContent = v;
      el.classList.remove('empty');
    }
  }
  function syncExecutive(){
    // Range
    setText('pRange', 'Semana: ' + ($('rangeLabel')?.textContent || '—'));

    // KPIs (capa + notas)
    const map = [
      ['kLeads','pKLeads'],['kAng','pKAng'],['kVis','pKVis'],['kProp','pKProp'],['kCpcv','pKCpcv'],['kEsc','pKEsc'],
      ['kLeads','pKLeads2'],['kAng','pKAng2'],['kVis','pKVis2'],['kProp','pKProp2'],['kCpcv','pKCpcv2'],['kEsc','pKEsc2']
    ];
    map.forEach(([src,dst])=> setText(dst, $(src)?.textContent || '0'));

    // Notas
    setNotes('pObsLeads', $('obsLeads')?.value || '');
    setNotes('pObsAng', $('obsAng')?.value || '');
    setNotes('pObsVis', $('obsVis')?.value || '');
    setNotes('pObsProp', $('obsProp')?.value || '');
    setNotes('pObsCpcv', $('obsCpcv')?.value || '');
    setNotes('pObsEsc', $('obsEsc')?.value || '');
    setNotes('pWeeklyComment', $('weeklyComment')?.value || '');
  }

  // Garantir que ao imprimir o PDF leva o texto completo (sem ficar "cortado" por caixas)
  window.addEventListener('beforeprint', syncExecutive);

  // ====== Semana atual por defeito ======
  function setThisWeek(){
    const b = getWeekBoundsUTC(new Date());
    $('weekStart').value = isoYMD(b.start);
    $('weekEnd').value = isoYMD(b.end);
  }

  // quando a semana muda: carregar notas da semana e recalcular
  function onWeekChanged(){
    loadWeeklyNotes();
    computeKPIs();
  }

  // ====== Boot ======
  setThisWeek();
  wireAutosave();
  onWeekChanged();

  $('btnRefresh').addEventListener('click', ()=>{
    // ao atualizar, mantém as notas já carregadas e apenas recalcula KPIs
    computeKPIs();
  });

  $('btnThisWeek').addEventListener('click', ()=>{
    setThisWeek();
    onWeekChanged();
  });

  $('weekStart').addEventListener('change', onWeekChanged);
  $('weekEnd').addEventListener('change', onWeekChanged);

  $('btnCopy').addEventListener('click', copyEmail);
  $('btnPrint').addEventListener('click', ()=>window.print());
})();
</script>
</body>
</html>
