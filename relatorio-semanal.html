<!doctype html>
<html lang="pt-PT">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Garvetur Porto Pro — Relatório Semanal</title>

<style>
  :root{
    --gold:#A38B63;
    --bg:#0B0B0B;
    --panel:#141414;
    --border:rgba(255,255,255,.14);
    --text:#FFFFFF;
    --muted:#C9C9C9;
    --radius:14px;
  }
  *{ box-sizing:border-box; }
  html,body{ margin:0; height:100%; }
  body{
    font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
    background:radial-gradient(circle at top,#1c1c1c 0,#050505 55%,#000 100%);
    color:var(--text);
  }

  header{
    display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;
    padding:12px 16px;
    border-bottom:1px solid rgba(163,139,99,.35);
    background:linear-gradient(90deg,#050505,#111,#050505);
  }
  .brand{
    display:flex;align-items:center;gap:10px;
  }
  .brand-icon{
    width:26px;height:26px;border-radius:999px;border:1px solid var(--gold);
    display:flex;align-items:center;justify-content:center;
    box-shadow:0 0 0 1px rgba(163,139,99,.3);
  }
  .brand h1{
    margin:0;font-size:15px;letter-spacing:.06em;text-transform:uppercase;color:var(--gold);
  }
  .brand .sub{
    margin-top:2px;font-size:11px;color:var(--muted);letter-spacing:.12em;text-transform:uppercase;
  }

  .btn{
    border-radius:10px;
    border:1px solid rgba(163,139,99,.35);
    background:rgba(12,12,12,.9);
    color:var(--text);
    padding:8px 12px;
    font-size:13px;
    cursor:pointer;
    transition:.18s border-color,.18s transform;
    white-space:nowrap;
  }
  .btn:hover{ border-color:var(--gold); transform:translateY(-1px); }
  .btn.primary{
    background:var(--gold);
    color:#0A0A0A;
    border-color:var(--gold);
    font-weight:800;
  }

  .wrap{
    display:grid;
    grid-template-columns:360px minmax(0,1fr);
    min-height:calc(100vh - 62px);
  }
  @media(max-width:980px){
    .wrap{ grid-template-columns:1fr; }
  }

  .side{
    padding:14px;
    border-right:1px solid var(--border);
    background:radial-gradient(circle at top left,#141414,#060606);
  }
  .main{
    padding:14px 16px;
    overflow:auto;
  }

  .card{
    background:rgba(0,0,0,.45);
    border:1px solid rgba(163,139,99,.22);
    border-radius:var(--radius);
    padding:12px;
    margin-bottom:12px;
  }

  .hint{ color:var(--muted); font-size:12px; line-height:1.35; }
  label{ display:block; font-size:12px; color:#dcdcdc; margin:8px 0 6px; }
  input,textarea{
    width:100%;
    background:rgba(0,0,0,.7);
    border:1px solid rgba(255,255,255,.16);
    border-radius:10px;
    color:#fff;
    padding:8px 10px;
    outline:none;
    font-size:12px;
  }
  input:focus,textarea:focus{
    border-color:var(--gold);
    box-shadow:0 0 0 1px rgba(163,139,99,.35);
  }
  textarea{ min-height:90px; resize:vertical; }
  /* ===== PDF: espelho do conteúdo dos textarea (texto completo) ===== */
.print-only{ display:none; }

  .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }

 /* ===== Hero premium — Garvetur dark + gold ===== */
.hero{
  position:relative;
  border:1px solid rgba(163,139,99,.35);
  background:
    radial-gradient(900px 380px at 10% 0%, rgba(163,139,99,.18) 0%, rgba(0,0,0,0) 55%),
    linear-gradient(180deg, #0B0B0B 0%, #000000 100%);
  border-radius:18px;
  padding:14px 14px 12px;
  margin-bottom:12px;
  box-shadow:0 18px 36px rgba(0,0,0,.65);
}

.hero::after{
  content:"";
  position:absolute;
  inset:0;
  border-radius:18px;
  pointer-events:none;
  box-shadow:inset 0 0 0 1px rgba(255,255,255,.06);
}

.hero .top{
  display:flex;
  align-items:flex-end;
  justify-content:space-between;
  gap:10px;
  flex-wrap:wrap;
}

.hero h2{
  margin:0;
  font-size:16px;
  letter-spacing:.10em;
  text-transform:uppercase;
  color:#FFFFFF;
  text-shadow:0 2px 16px rgba(0,0,0,.75);
}

.range{
  color:var(--gold);
  font-size:12px;
  letter-spacing:.14em;
  text-transform:uppercase;
  font-weight:700;
  text-shadow:0 2px 14px rgba(0,0,0,.75);
}

.hero .hint,
.hero .hint b{
  color:rgba(255,255,255,.82);
}

  .kpis{
    display:grid;
    grid-template-columns:repeat(2, minmax(0,1fr));
    gap:10px;
  }
  @media(max-width:900px){
    .kpis{ grid-template-columns:1fr; }
  }
 .kpi{
  position:relative;
  background:
    linear-gradient(180deg, rgba(18,18,18,.95), rgba(6,6,6,.85));
  border:1px solid rgba(163,139,99,.65);
  border-radius:14px;
  padding:14px 12px 12px;
  box-shadow:0 18px 32px rgba(0,0,0,.65);
}

/* linha dourada subtil — reforço visual do KPI */
.kpi::before{
  content:"";
  position:absolute;
  left:14px;
  right:14px;
  top:10px;
  height:2px;
  border-radius:999px;
  background:linear-gradient(
    90deg,
    rgba(163,139,99,.10),
    rgba(163,139,99,.85),
    rgba(163,139,99,.10)
  );
  opacity:.6;
}
  .kpi .name{
    font-size:11px;
    color:#ddd;
    letter-spacing:.14em;
    text-transform:uppercase;
  }
  .kpi .val{
  font-size:28px;
  font-weight:900;
  margin-top:6px;
  color:#FFFFFF;
  text-shadow:0 2px 10px rgba(0,0,0,.55);
}
 .kpi .src{
  margin-top:8px;
  display:inline-flex;
  font-size:11px;
  padding:3px 9px;
  border-radius:999px;
  border:1px solid rgba(163,139,99,.35);
  color:rgba(255,255,255,.88);
  background:linear-gradient(180deg, rgba(163,139,99,.12), rgba(0,0,0,.55));
}

  .toast{
    position:fixed;
    right:14px;
    bottom:14px;
    z-index:99999;
    padding:10px 12px;
    border-radius:12px;
    background:rgba(0,0,0,.85);
    border:1px solid rgba(163,139,99,.35);
    color:#fff;
    font-size:12px;
    display:none;
  }

@media print{
  header,.side,.toast{ display:none !important; }

  body{
  /* fundo premium — off-white quente */
  background:#F4F2EE !important; /* marfim/cinza muito claro */
  color:#111 !important;
  -webkit-print-color-adjust: exact !important;
  print-color-adjust: exact !important;
}
  .wrap{ display:block; }

  /* dar contraste entre fundo e conteúdo */
.wrap{
  background:#F4F2EE !important;
}

/* painéis mantêm-se brancos para leitura */
.hero,
.kpi,
.card{
  background:#FFFFFF !important;
}

  /* HERO — versão executiva clara com assinatura dourada */
  .hero{
    background:#fff !important;
    border:1px solid rgba(163,139,99,.75) !important;
    box-shadow:none !important;
  }
  .hero::after{ box-shadow:none !important; }
  .hero h2{ color:#111 !important; text-shadow:none !important; }
  .range{ color:rgba(163,139,99,1) !important; text-shadow:none !important; }
  .hero .hint, .hero .hint b{ color:#333 !important; }

  /* KPIs / Cards — branco “premium”, não “vazio” */
  .kpi, .card{
    background:#fff !important;
    border:1px solid rgba(163,139,99,.60) !important;
    box-shadow:none !important;
  }

  /* manter o detalhe premium no topo do KPI (linha dourada) */
  .kpi::before{
    background: linear-gradient(
      90deg,
      rgba(163,139,99,.10),
      rgba(163,139,99,1),
      rgba(163,139,99,.10)
    ) !important;
    opacity:.90 !important;
  }

  .kpi .name{ color:#333 !important; }
  .kpi .val{ color:#111 !important; text-shadow:none !important; }

  /* Chip “Fonte” com look executivo */
  .kpi .src{
    border:1px solid rgba(163,139,99,.55) !important;
    color:#333 !important;
    background:#fff !important;
  }

  /* Último bloco (Comentário) — destaque dourado no PDF */
  .main .card:last-of-type{
    border:1px solid rgba(163,139,99,.80) !important;
    background:#fff !important;
  }
  .main .card:last-of-type::before{
    background: linear-gradient(
      90deg,
      rgba(163,139,99,.10),
      rgba(163,139,99,1),
      rgba(163,139,99,.10)
    ) !important;
    opacity:.95 !important;
  }
  .main .card:last-of-type .hint{
    color: rgba(163,139,99,1) !important;
    letter-spacing:.12em !important;
    text-transform:uppercase !important;
    font-weight:900 !important;
  }

  textarea, input{
    background:#fff !important;
    color:#111 !important;
    border:1px solid rgba(0,0,0,.18) !important;
    box-shadow:none !important;
  }

  /* ===== PDF: Comentário semanal não pode ser cortado ===== */
  .comment-card{
    break-inside: avoid !important;
    page-break-inside: avoid !important;
    break-before: page !important;
    page-break-before: always !important;
  }
  
  /* ===== Observações nos KPI — legibilidade premium em PDF ===== */

/* Label "Observações" */
.kpi label{
  color:#111 !important;
  font-weight:800 !important;
  letter-spacing:.08em !important;
  text-transform:uppercase !important;
  margin-top:10px !important;
}

/* Campo de texto das observações */
.kpi textarea{
  background:#FAF9F7 !important; /* branco quente */
  border:1px solid rgba(163,139,99,.55) !important;
  color:#111 !important;
  padding:10px 12px !important;
  font-size:12px !important;
  line-height:1.45 !important;
}

/* Placeholder (quando vazio) */
.kpi textarea::placeholder{
  color:#777 !important;
}

/* Foco visual (não agressivo no PDF) */
.kpi textarea:focus{
  border-color:rgba(163,139,99,.85) !important;
  box-shadow:none !important;
}
  /* ===== PDF: imprimir conteúdo completo (sem cortar) ===== */
  textarea{ display:none !important; } /* no PDF, não imprimir textarea */

  .print-only{
    display:block !important;
    white-space:pre-wrap !important;   /* respeita quebras de linha */
    word-break:break-word !important;
    background:#FAF9F7 !important;     /* branco quente */
    border:1px solid rgba(163,139,99,.55) !important;
    color:#111 !important;
    border-radius:10px !important;
    padding:10px 12px !important;
    line-height:1.45 !important;
    min-height:50px !important;
  }

/* ===== CONTROLO DE QUEBRA DE PÁGINA — OBSERVAÇÕES KPI ===== */

/* Nunca quebrar um KPI a meio */
.kpi{
  break-inside: avoid !important;
  page-break-inside: avoid !important;
}

/* Textareas expandem totalmente no PDF */
.kpi textarea{
  height: auto !important;
  max-height: none !important;
  overflow: visible !important;
}

/* Garantir que o conteúdo não é cortado */
.kpis{
  break-inside: auto;
}
  
  @page{ margin: 12mm; }
}
/* ===== Destaque premium — Comentário semanal do Diretor ===== */
.main .card:last-of-type{
  position:relative;
  border:1px solid rgba(163,139,99,.55);
  background:
    radial-gradient(900px 260px at 12% 0%, rgba(163,139,99,.22) 0%, rgba(0,0,0,0) 55%),
    linear-gradient(180deg, rgba(10,10,10,.95), rgba(0,0,0,.75));
  box-shadow:0 22px 40px rgba(0,0,0,.65);
}

/* Linha dourada superior — assinatura Garvetur */
.main .card:last-of-type::before{
  content:"";
  position:absolute;
  left:14px;
  right:14px;
  top:10px;
  height:3px;
  border-radius:999px;
  background:linear-gradient(
    90deg,
    rgba(163,139,99,.10),
    rgba(163,139,99,1),
    rgba(163,139,99,.10)
  );
}

/* Título do bloco final com presença executiva */
.main .card:last-of-type .hint{
  color:var(--gold);
  letter-spacing:.14em;
  text-transform:uppercase;
  font-weight:900;
}
  
</style>
</head>

<body>
<header>
  <div class="brand">
    <div class="brand-icon">
      <svg width="16" height="16" viewBox="0 0 24 24" stroke="var(--gold)" fill="none" stroke-width="1.8">
        <circle cx="12" cy="12" r="9"></circle>
        <path d="M8 12.5l2.5 2.5L16 9"></path>
      </svg>
    </div>
    <div>
      <h1>Garvetur Porto Pro — Relatório Semanal</h1>
      <div class="sub">Automático + comentário do Diretor/Coordenador</div>
    </div>
  </div>

  <div class="row">
    <button class="btn" id="btnCopy">Copiar Email</button>
    <button class="btn" id="btnPrint">Imprimir / PDF</button>
  </div>
</header>

<div class="wrap">
  <aside class="side">
    <div class="card">
      <div class="hint">Semana (2.ª feira → domingo)</div>

      <label for="weekStart">Início (2.ª feira)</label>
      <input id="weekStart" type="date" />

      <label for="weekEnd">Fim (domingo)</label>
      <input id="weekEnd" type="date" />

      <div class="row" style="margin-top:10px">
        <button class="btn primary" id="btnRefresh">Atualizar</button>
        <button class="btn" id="btnThisWeek">Esta semana</button>
      </div>

      <div class="hint" style="margin-top:10px">
        Esta página é <b>só de leitura</b>. Não altera os módulos.
      </div>
    </div>

    <div class="card">
      <div class="hint" style="margin-bottom:8px">Assunto & destinatários (opcional)</div>

      <label for="emailSubject">Assunto</label>
      <input id="emailSubject" placeholder="Relatório Semanal — 12 a 18 Jan 2026" />

      <label for="emailTo">Destinatários</label>
      <textarea id="emailTo" placeholder="Direção / Administração"></textarea>

      <div class="hint" style="margin-top:10px">
        As observações e comentário ficam guardados por semana (localmente no navegador).
      </div>
    </div>
  </aside>

  <main class="main">
    <div class="hero">
      <div class="top">
        <h2>Resumo semanal de actividade</h2>
        <div class="range" id="rangeLabel">—</div>
      </div>
      <div class="hint" style="margin-top:6px">
        KPIs calculados automaticamente a partir de <b>Leads</b> e <b>Angariações</b>. Observações e comentário são editáveis.
      </div>
    </div>

    <section class="kpis">
      <div class="kpi">
        <div class="name">Leads (semana)</div>
        <div class="val" id="kLeads">0</div>
        <div class="src">Fonte: Kanban (lead.data)</div>
        <label>Observações</label>
        <textarea id="obsLeads" placeholder="Origem, qualidade, temas recorrentes, próximos passos..."></textarea>
      </div>

      <div class="kpi">
        <div class="name">Angariações (semana)</div>
        <div class="val" id="kAng">0</div>
        <div class="src">Fonte: Angariações (dataAngariacao)</div>
        <label>Observações</label>
        <textarea id="obsAng" placeholder="Produto, exclusividade, pricing, obstáculos, ações comerciais..."></textarea>
      </div>

            <div class="kpi">
        <div class="name">Visitas (semana)</div>
        <div class="val" id="kVis">0</div>
        <div class="src">Fonte: Kanban (campos de visita)</div>
        <label>Observações</label>
        <textarea id="obsVis" placeholder="Visitas realizadas, taxa de comparência, principais feedbacks, próximos passos..."></textarea>
      </div>

      <div class="kpi">
        <div class="name">Propostas (semana)</div>
        <div class="val" id="kProp">0</div>
        <div class="src">Fonte: Kanban (campos de proposta)</div>
        <label>Observações</label>
        <textarea id="obsProp" placeholder="Propostas recebidas/enviadas, condições, contrapropostas, riscos e follow-ups..."></textarea>
      </div>

      <div class="kpi">
        <div class="name">CPCV (semana)</div>
        <div class="val" id="kCpcv">0</div>
        <div class="src">Fonte: Kanban (fecho_cpcv_date)</div>
        <label>Observações</label>
        <textarea id="obsCpcv" placeholder="Principais negócios, condições, prazos, pontos críticos..."></textarea>
      </div>

      <div class="kpi">
        <div class="name">Escrituras (semana)</div>
        <div class="val" id="kEsc">0</div>
        <div class="src">Fonte: Kanban (fecho_escritura_date)</div>
        <label>Observações</label>
        <textarea id="obsEsc" placeholder="Fechos, pendências, risco de atraso, follow-ups..."></textarea>
      </div>
    </section>

    <div class="card comment-card" style="margin-top:12px">
      <div class="hint" style="margin-bottom:8px">Comentário semanal do Coordenador / Diretor</div>
      <textarea id="weeklyComment" style="min-height:170px" placeholder="Resumo executivo: principais acontecimentos, decisões tomadas, riscos, prioridades e foco para a próxima semana..."></textarea>
    </div>
  </main>
</div>

<div class="toast" id="toast"></div>

<script>
(function(){
  // ====== Fontes (confirmadas nos seus módulos) ======
  const LS_LEADS_KEY = 'gpp_leads_v5';        // Kanban: LEADS array (lead.data, fecho_cpcv_date, fecho_escritura_date)
  const LS_ANG_KEY   = 'gpp_angariacoes_v2';  // Angariações: array ou {deals:[]}, usa dataAngariacao

  // ====== Persistência do relatório semanal ======
  const REPORT_KEY_PREFIX = 'gpp_weekly_report_v1:'; // por semana

  const $ = (id)=>document.getElementById(id);

  function toast(msg){
    const el = $('toast');
    el.textContent = msg;
    el.style.display = 'block';
    setTimeout(()=>{ el.style.display='none'; }, 2200);
  }

  function safeParse(raw){
    if(!raw) return null;
    try{ return JSON.parse(raw); }catch(e){ return null; }
  }

function parseISODateUTC(s){
  // Aceita:
  // - YYYY-MM-DD
  // - DD/MM/YYYY
  // - DD-MM-YYYY
  // - YYYY/MM/DD
  // - ISO DateTime (ex.: 2026-01-23T15:10:11.123Z)

  if(!s) return null;

  // Se já vier Date (por segurança)
  if(s instanceof Date) return isNaN(s.getTime()) ? null : s;

  if(typeof s !== 'string') return null;
  const raw = s.trim();
  if(!raw) return null;

  // ISO datetime (contém 'T' ou termina com 'Z' ou tem offset)
  if(raw.includes('T') || raw.endsWith('Z') || /[+-]\d{2}:\d{2}$/.test(raw)){
    const dt = new Date(raw);
    return isNaN(dt.getTime()) ? null : dt;
  }

  // YYYY-MM-DD
  let m = raw.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if(m){
    const dt = new Date(Date.UTC(+m[1], +m[2]-1, +m[3]));
    return isNaN(dt.getTime()) ? null : dt;
  }

  // DD/MM/YYYY
  m = raw.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
  if(m){
    const dd = +m[1], mm = +m[2], yy = +m[3];
    const dt = new Date(Date.UTC(yy, mm-1, dd));
    return isNaN(dt.getTime()) ? null : dt;
  }

  // DD-MM-YYYY
  m = raw.match(/^(\d{1,2})-(\d{1,2})-(\d{4})$/);
  if(m){
    const dd = +m[1], mm = +m[2], yy = +m[3];
    const dt = new Date(Date.UTC(yy, mm-1, dd));
    return isNaN(dt.getTime()) ? null : dt;
  }

  // YYYY/MM/DD
  m = raw.match(/^(\d{4})\/(\d{1,2})\/(\d{1,2})$/);
  if(m){
    const yy = +m[1], mm = +m[2], dd = +m[3];
    const dt = new Date(Date.UTC(yy, mm-1, dd));
    return isNaN(dt.getTime()) ? null : dt;
  }

  return null;
}

  function inRangeISO(dateStr, startUTC, endUTC){
    const dt = parseISODateUTC(dateStr);
    if(!dt) return false;
    const t = dt.getTime();
    return t >= startUTC.getTime() && t <= endUTC.getTime();
  }

  function isoYMD(dt){
    const y = dt.getUTCFullYear();
    const m = String(dt.getUTCMonth()+1).padStart(2,'0');
    const d = String(dt.getUTCDate()).padStart(2,'0');
    return y + '-' + m + '-' + d;
  }

  function getWeekBoundsUTC(baseDate){
    // 2ª feira -> domingo
    const d = new Date(baseDate);
    const day = d.getDay(); // 0=Dom..1=Seg
    const diffToMon = (day === 0) ? -6 : (1 - day);
    d.setDate(d.getDate() + diffToMon);
    const start = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
    const end = new Date(start);
    end.setUTCDate(end.getUTCDate() + 6);
    return { start, end };
  }

  function reportKeyForCurrentWeek(){
    const s = $('weekStart').value;
    const e = $('weekEnd').value;
    return REPORT_KEY_PREFIX + s + '|' + e;
  }

  function loadLeads(){
    const parsed = safeParse(localStorage.getItem(LS_LEADS_KEY));
    return Array.isArray(parsed) ? parsed : [];
  }

  function loadAngariacoes(){
    const parsed = safeParse(localStorage.getItem(LS_ANG_KEY));
    if(Array.isArray(parsed)) return parsed;
    if(parsed && typeof parsed === 'object' && Array.isArray(parsed.deals)) return parsed.deals;
    return [];
  }

  // ====== Guardar/Carregar observações por semana ======
  function loadWeeklyNotes(){
    const key = reportKeyForCurrentWeek();
    const saved = safeParse(localStorage.getItem(key));
    if(!saved || typeof saved !== 'object') return;

    $('emailSubject').value = saved.emailSubject || $('emailSubject').value || '';
    $('emailTo').value      = saved.emailTo || '';

    $('obsLeads').value     = saved.obsLeads || '';
    $('obsAng').value       = saved.obsAng || '';
    $('obsCpcv').value      = saved.obsCpcv || '';
    $('obsEsc').value       = saved.obsEsc || '';
    $('obsVis').value       = saved.obsVis || '';
    $('obsProp').value      = saved.obsProp || '';
    $('weeklyComment').value= saved.weeklyComment || '';
  }

  function saveWeeklyNotes(){
    const key = reportKeyForCurrentWeek();
    const payload = {
      emailSubject: $('emailSubject').value || '',
      emailTo: $('emailTo').value || '',
      obsLeads: $('obsLeads').value || '',
      obsAng: $('obsAng').value || '',
      obsCpcv: $('obsCpcv').value || '',
      obsEsc: $('obsEsc').value || '',
      obsVis: $('obsVis').value || '',
      obsProp: $('obsProp').value || '',
      weeklyComment: $('weeklyComment').value || '',
      savedAt: new Date().toISOString()
    };
    try{
      localStorage.setItem(key, JSON.stringify(payload));
    }catch(e){
      console.error('Relatório semanal: erro ao guardar notas', e);
    }
  }

  function wireAutosave(){
    const ids = ['emailSubject','emailTo','obsLeads','obsAng','obsCpcv','obsEsc','obsVis','obsProp','weeklyComment'];
    ids.forEach(id=>{
      const el = $(id);
      if(!el) return;
      el.addEventListener('input', ()=>{
        // pequeno debounce
        clearTimeout(el.__t);
        el.__t = setTimeout(saveWeeklyNotes, 220);
      });
    });
  }

  // ====== Cálculo KPIs ======
  function computeKPIs(){
    const startStr = $('weekStart').value;
    const endStr = $('weekEnd').value;

    const start = parseISODateUTC(startStr);
    const end = parseISODateUTC(endStr);

    if(!start || !end){
      toast('Datas inválidas.');
      return;
    }

    // Garantir range inclusivo do dia inteiro (00:00 → 23:59:59.999)
start.setUTCHours(0,0,0,0);
end.setUTCHours(23,59,59,999);

    $('rangeLabel').textContent = startStr + ' → ' + endStr;

    const leads = loadLeads();
    const angs  = loadAngariacoes();

    // Leads da semana: usar o campo garantido do Kanban: lead.data (vem do input id="ld_data")
    const leadsWeek = leads.filter(l => inRangeISO(l.data || '', start, end));
    $('kLeads').textContent = String(leadsWeek.length);

    // Angariações da semana: dataAngariacao
    const angWeek = angs.filter(a => inRangeISO(a.dataAngariacao || '', start, end));
    $('kAng').textContent = String(angWeek.length);

    // CPCV / Escrituras: campos de fecho do Kanban
    const cpcvWeek = leads.filter(l => inRangeISO(l.fecho_cpcv_date || '', start, end));
    const escWeek  = leads.filter(l => inRangeISO(l.fecho_escritura_date || '', start, end));
    $('kCpcv').textContent = String(cpcvWeek.length);
    $('kEsc').textContent  = String(escWeek.length);

     // ===== Visitas (semana) =====
// Novo (multi-estado):
// - Se existir estadosHist.Visita, conta pela data/hora em que a etapa "Visita" foi registada
// - Fallback: comportamento antigo (estado único + lead.data)
const visitasWeek = leads.filter(l=>{
  // (A) Multi-estado
  const hist = l && l.estadosHist && typeof l.estadosHist === 'object' ? l.estadosHist : null;
  const dtVis = hist ? parseISODateUTC(hist['Visita']) : null;
  if(dtVis){
    return dtVis.getTime() >= start.getTime() && dtVis.getTime() <= end.getTime();
  }

  // (B) Fallback antigo
  return (l && l.estado === 'Visita' && inRangeISO(l.data || '', start, end));
});
$('kVis').textContent = String(visitasWeek.length);

// ===== Propostas (semana) =====
// Conta apenas com base no objeto "proposta" do Kanban:
// - proposta inicial: l.proposta.dataProposta (ou variações dentro de l.proposta)
// - contra-propostas: l.proposta.contraPropostas[].data (ou variações dentro do cp)
// Não usa campos legado para evitar contagens erradas.

const propEvents = new Set();

    function ymdFromAnyDate(raw){
  const dt = parseISODateUTC(raw);
  if(!dt) return '';
  const y = dt.getUTCFullYear();
  const m = String(dt.getUTCMonth()+1).padStart(2,'0');
  const d = String(dt.getUTCDate()).padStart(2,'0');
  return `${y}-${m}-${d}`;
}

leads.forEach((l, idxLead) => {
  if(!l) return;

  // id estável por lead (se não existir, cai para o índice)
  const lid = (l.id != null && String(l.id).trim()) ? String(l.id) : String(idxLead);

    // ===== ETAPA "PROPOSTA" (multi-estado, sem data obrigatória) =====
  if(Array.isArray(l.estados) && l.estados.includes('Proposta')){
    // usar histórico se existir, senão contar no intervalo da semana
    let counted = false;

    if(Array.isArray(l.estadosHist)){
      const hist = l.estadosHist.find(h => h.estado === 'Proposta');
      if(hist){
        const iso = ymdFromAnyDate(hist.data);
        if(iso && inRangeISO(iso, start, end)){
          propEvents.add(`stage|${lid}|${iso}`);
          counted = true;
        }
      }
    }

    // fallback: não há data no histórico → conta uma vez na semana atual
    if(!counted){
      propEvents.add(`stage|${lid}|nodate`);
    }
  }

  const p = l.proposta;
  if(!p || typeof p !== 'object') return;

  // Proposta inicial (aceita algumas variações possíveis dentro de "proposta")
  const pISO = normDateToISO(p.dataProposta || p.data || p.date || p.dataPropostaISO || '');
  if(pISO && inRangeISO(pISO, start, end)){
    propEvents.add(`prop|${lid}|${pISO}`);
  }

  // Contra-propostas
  const cps = Array.isArray(p.contraPropostas) ? p.contraPropostas : [];
  cps.forEach((cp) => {
    if(!cp || typeof cp !== 'object') return;

    const cpISO = normDateToISO(cp.data || cp.dataProposta || cp.date || cp.dataISO || '');
    if(!cpISO) return;
    if(!inRangeISO(cpISO, start, end)) return;

    // dedupe por: lead + dia + valor + termos
    const v = String(cp.valor ?? '').trim().toLowerCase();
    const t = String(cp.termos ?? '')
      .trim()
      .toLowerCase()
      .replace(/\s+/g,' ');

    propEvents.add(`contra|${lid}|${cpISO}|${v}|${t}`);
  });
});

$('kProp').textContent = String(propEvents.size);
    
    // assunto sugerido (não pisa se o Rui já escreveu)
    if(!$('emailSubject').value.trim()){
      $('emailSubject').value = 'Relatório Semanal — ' + startStr + ' a ' + endStr;
    }

    toast('Relatório atualizado.');
  }

  function copyEmail(){
    const s = $('weekStart').value;
    const e = $('weekEnd').value;
    const subject = ($('emailSubject').value || '').trim() || ('Relatório Semanal — ' + s + ' a ' + e);
    const to = ($('emailTo').value || '').trim();

    const body =
`Assunto: ${subject}
${to ? ('Para: ' + to + '\n') : ''}
Relatório Semanal de Actividade (${s} → ${e})

1) Leads: ${$('kLeads').textContent}
Observações: ${$('obsLeads').value.trim() || '-'}

2) Angariações: ${$('kAng').textContent}
Observações: ${$('obsAng').value.trim() || '-'}

3) Visitas: ${$('kVis').textContent}
Observações: ${$('obsVis').value.trim() || '-'}

4) Propostas: ${$('kProp').textContent}
Observações: ${$('obsProp').value.trim() || '-'}

5) CPCV: ${$('kCpcv').textContent}
Observações: ${$('obsCpcv').value.trim() || '-'}

6) Escrituras: ${$('kEsc').textContent}
Observações: ${$('obsEsc').value.trim() || '-'}

Comentário do Coordenador/Diretor:
${$('weeklyComment').value.trim() || '-'}

Cumprimentos,
Rui Quelhas`;

    // Safari: pode bloquear clipboard — fallback para prompt
    navigator.clipboard.writeText(body)
      .then(()=>toast('Email copiado.'))
      .catch(()=>{ prompt('Copie o texto do email:', body); });
  }

  // ====== Semana atual por defeito ======
  function setThisWeek(){
    const b = getWeekBoundsUTC(new Date());
    $('weekStart').value = isoYMD(b.start);
    $('weekEnd').value = isoYMD(b.end);
  }

  // quando a semana muda: carregar notas da semana e recalcular
  function onWeekChanged(){
    loadWeeklyNotes();
    computeKPIs();
  }

    // ===== PDF: imprimir texto completo (sem cortar em caixas) =====
  function ensurePrintMirrors(){
    const areas = Array.from(document.querySelectorAll('textarea'));
    areas.forEach(ta=>{
      let mirror = ta.nextElementSibling;
      if(!mirror || !mirror.classList || !mirror.classList.contains('print-only')){
        mirror = document.createElement('div');
        mirror.className = 'print-only';
        ta.insertAdjacentElement('afterend', mirror);
      }
      const val = (ta.value || '').trim();
      mirror.textContent = val ? val : '-';
    });
  }

  // Atualiza espelhos antes de imprimir (inclui Cmd+P)
  window.addEventListener('beforeprint', ensurePrintMirrors);

  // ====== Boot ======
  setThisWeek();
  wireAutosave();
  onWeekChanged();

  $('btnRefresh').addEventListener('click', ()=>{
    // ao atualizar, mantém as notas já carregadas e apenas recalcula KPIs
    computeKPIs();
  });

  $('btnThisWeek').addEventListener('click', ()=>{
    setThisWeek();
    onWeekChanged();
  });

  $('weekStart').addEventListener('change', onWeekChanged);
  $('weekEnd').addEventListener('change', onWeekChanged);

  $('btnCopy').addEventListener('click', copyEmail);
  $('btnPrint').addEventListener('click', ()=>{ ensurePrintMirrors(); window.print(); });
})();
</script>
</body>
</html>
