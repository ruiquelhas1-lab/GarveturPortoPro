
<!doctype html>
<html lang="pt-PT">
<head>
  <meta charset="utf-8" />
  <title>Garvetur Porto Pro ‚Äî FSBO</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --gold:#A38B63;
      --gold-soft:rgba(163,139,99,.35);
      --bg:#0B0B0B;
      --panel:#121212;
      --panel-soft:#181818;
      --text:#FFFFFF;
      --muted:#A0A0A0;
      --muted-2:#7d7d7d;
      --danger:#F25F5C;
      --success:#4CAF50;
      --warning:#FFC857;
      --card-border:rgba(163,139,99,.3);
      --chip-bg:#1E1E1E;
      --radius-lg:18px;
      --radius-md:12px;
      --shadow-soft:0 14px 25px rgba(0,0,0,.4);
      --shadow-hard:0 26px 60px rgba(0,0,0,.65);
      --outline:rgba(255,255,255,.10);
      --outline-2:rgba(255,255,255,.16);
    }

    *{box-sizing:border-box;}
    html,body{
      margin:0;
      height:100%;
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      background:radial-gradient(circle at top,#1c1c1c 0,#050505 55%,#000 100%);
      color:var(--text);
    }

    body{ display:flex; flex-direction:column; }

    .app-shell{
      display:grid;
      grid-template-rows:72px auto;
      height:100%;
    }

    header.app-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 14px;
      border-bottom:1px solid rgba(163,139,99,.35);
      background:linear-gradient(90deg,#050505,#111,#050505);
      position:sticky;
      top:0;
      z-index:20;
      gap:12px;
      flex-wrap:wrap;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:260px;
    }
    .brand-icon{
      width:28px;
      height:28px;
      border-radius:999px;
      border:1px solid var(--gold);
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:0 0 0 1px rgba(163,139,99,.3);
      flex:0 0 auto;
    }
    .brand-app{
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:.18em;
      color:var(--muted);
      margin-bottom:2px;
    }
    .brand h1{
      margin:0;
      font-size:18px;
      letter-spacing:.08em;
      text-transform:uppercase;
      color:var(--gold);
      line-height:1.05;
    }
    .brand span.sub{
      display:block;
      font-size:11px;
      color:var(--muted);
      letter-spacing:.06em;
      max-width:560px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* NAV TABS */
    .nav-tabs{
      display:flex;
      align-items:center;
      gap:4px;
      background:rgba(0,0,0,.35);
      padding:4px;
      border-radius:999px;
      border:1px solid rgba(163,139,99,.35);
      flex-wrap:wrap;
    }
    .nav-tab{
      padding:6px 10px;
      border-radius:999px;
      font-size:11px;
      text-decoration:none;
      color:var(--muted);
      letter-spacing:.12em;
      text-transform:uppercase;
      border:1px solid transparent;
      transition:.16s background,.16s color,.16s border-color,.16s transform;
    }
    .nav-tab:hover{
      color:#fff;
      border-color:rgba(163,139,99,.6);
      transform:translateY(-1px);
    }
    .nav-tab.active{
      background:var(--gold);
      color:#0A0A0A;
      border-color:var(--gold);
      font-weight:650;
    }

    /* TOP TOOLBAR (melhorada) */
    .toolbar{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
      min-width:280px;
    }
    .tool-group{
      display:flex;
      align-items:center;
      gap:8px;
      padding:6px 8px;
      border-radius:999px;
      border:1px solid rgba(163,139,99,.22);
      background:rgba(0,0,0,.35);
      box-shadow:0 8px 22px rgba(0,0,0,.35);
    }
    .tool-label{
      font-size:10px;
      letter-spacing:.16em;
      text-transform:uppercase;
      color:var(--muted-2);
      padding:0 4px 0 6px;
      border-right:1px solid rgba(255,255,255,.10);
      margin-right:2px;
      user-select:none;
      white-space:nowrap;
    }

    .btn{
      border-radius:999px;
      border:1px solid var(--gold-soft);
      background:rgba(12,12,12,.9);
      color:var(--text);
      padding:7px 12px;
      font-size:13px;
      display:inline-flex;
      align-items:center;
      gap:7px;
      cursor:pointer;
      transition:.18s border-color,.18s background,.18s transform, .18s box-shadow;
      white-space:nowrap;
    }
    .btn:hover{
      border-color:var(--gold);
      transform:translateY(-1px);
      box-shadow:0 10px 22px rgba(0,0,0,.35);
    }
    .btn:disabled{ opacity:.45; cursor:not-allowed; transform:none; box-shadow:none; }
    .btn-primary{
      background:var(--gold);
      color:#0A0A0A;
      border-color:var(--gold);
      font-weight:650;
    }
    .btn-ghost{ background:transparent; border-color:rgba(255,255,255,.14); }
    .btn-icon{
      width:34px;
      height:34px;
      padding:0;
      border-radius:999px;
      justify-content:center;
    }

    .pill-lock{
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      background:rgba(0,0,0,.45);
      border:1px solid rgba(255,255,255,.14);
      color:var(--muted);
    }
    .pill-lock span.state{
      font-weight:650;
      color:var(--gold);
    }
    .pill-lock button{
      all:unset;
      cursor:pointer;
      padding:2px 7px;
      border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      transition:.15s transform,.15s border-color;
    }
    .pill-lock button:hover{
      transform:translateY(-1px);
      border-color:rgba(163,139,99,.6);
    }

    .layout{
      display:grid;
      grid-template-columns:320px minmax(0,1fr);
      height:calc(100vh - 72px);
      max-height:calc(100vh - 72px);
      overflow:hidden;
    }
    @media (max-width: 1100px){
      .brand span.sub{ max-width:420px; }
    }
    @media (max-width: 960px){
      .layout{
        grid-template-columns:1fr;
        grid-template-rows:auto auto;
        height:auto;
        max-height:none;
      }
      .sidebar{ max-height:none; }
      header.app-header{ align-items:flex-start; }
      .brand{ min-width:auto; width:100%; }
      .nav-tabs{ width:100%; }
      .toolbar{ width:100%; justify-content:flex-start; }
    }

    .sidebar{
      border-right:1px solid rgba(163,139,99,.24);
      background:radial-gradient(circle at top left,#141414,#060606);
      padding:12px 14px;
      overflow-y:auto;
    }
    .sidebar-section{
      border-radius:var(--radius-md);
      padding:10px 11px;
      background:rgba(0,0,0,.45);
      border:1px solid rgba(163,139,99,.18);
      margin-bottom:10px;
      box-shadow:0 12px 26px rgba(0,0,0,.25);
    }
    .sidebar-section h3{
      margin:0 0 6px;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.16em;
      color:var(--muted);
    }
    .sidebar-section p{
      margin:2px 0 6px;
      font-size:12px;
      color:var(--muted);
    }

    .field{
      display:flex;
      flex-direction:column;
      gap:4px;
      margin-bottom:8px;
    }
    .field-row{
      display:flex;
      gap:6px;
    }
    label.field-label{
      font-size:11px;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.12em;
    }

    input[type="text"],
    input[type="number"],
    input[type="date"],
    input[type="email"],
    select,
    textarea{
      background:rgba(0,0,0,.72);
      color:var(--text);
      border-radius:10px;
      border:1px solid rgba(163,139,99,.22);
      padding:7px 9px;
      font-size:13px;
      outline:none;
      width:100%;
    }
    input::placeholder, textarea::placeholder{ color:rgba(255,255,255,.35); }
    input:focus, select:focus, textarea:focus{
      border-color:var(--gold);
      box-shadow:0 0 0 1px rgba(163,139,99,.35);
    }
    textarea{
      resize:vertical;
      min-height:64px;
    }

    .toggle-line{
      display:flex;
      align-items:center;
      justify-content:space-between;
      font-size:12px;
      margin-top:4px;
    }
    .toggle-line span{ color:var(--muted); }
    .switch{
      position:relative;
      display:inline-block;
      width:34px;
      height:18px;
    }
    .switch input{ opacity:0; width:0; height:0; }
    .slider{
      position:absolute;
      cursor:pointer;
      inset:0;
      background-color:#444;
      transition:.2s;
      border-radius:34px;
    }
    .slider:before{
      position:absolute;
      content:"";
      height:14px; width:14px;
      left:3px; bottom:2px;
      background-color:white;
      transition:.2s;
      border-radius:50%;
    }
    .switch input:checked + .slider{ background-color:var(--gold); }
    .switch input:checked + .slider:before{ transform:translateX(14px); }

    .filters-badges{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:4px;
    }
    .badge{
      font-size:11px;
      border-radius:999px;
      padding:3px 7px;
      border:1px solid rgba(163,139,99,.35);
      background:rgba(8,8,8,.85);
      color:var(--muted);
    }
    .badge strong{ color:var(--gold); }

    .cards-area{
      padding:14px 16px 18px;
      overflow-y:auto;
      background:radial-gradient(circle at top,#1a1a1a,#050505 55%,#000 100%);
    }
    .cards-header{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      margin-bottom:8px;
      gap:10px;
      flex-wrap:wrap;
    }
    .cards-header-left h2{
      margin:0;
      font-size:15px;
      letter-spacing:.16em;
      text-transform:uppercase;
      color:var(--muted);
    }
    .cards-header-left p{
      margin:2px 0 0;
      font-size:12px;
      color:var(--muted);
      max-width:980px;
    }
    .pipeline-kpis{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:6px;
    }
    .kpi-chip{
      border-radius:999px;
      padding:4px 9px;
      border:1px solid rgba(163,139,99,.32);
      font-size:11px;
      color:var(--muted);
      background:rgba(8,8,8,.9);
    }
    .kpi-chip span.value{
      color:var(--gold);
      font-weight:700;
      margin-left:4px;
    }

    .cards-grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(340px,1fr));
      gap:10px;
    }

    .card{
      border-radius:var(--radius-lg);
      border:1px solid var(--card-border);
      padding:10px 11px 9px;
      background:radial-gradient(circle at top left,#181818,#070707);
      box-shadow:var(--shadow-soft);
      display:flex;
      flex-direction:column;
      gap:6px;
      position:relative;
      transition:box-shadow .2s, transform .2s, border-color .2s, background .2s;
    }
    .card:hover{
      transform:translateY(-2px);
      border-color:rgba(163,139,99,.55);
      box-shadow:var(--shadow-hard);
    }
    .card.hidden-card{
      opacity:.45;
      border-style:dashed;
    }
        /* ============ URG√äNCIA (Pr√≥xima a√ß√£o) ============ */
   
    .card-top-row{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:8px;
    }
    .card-title-block{
      flex:1;
      min-width:0;
    }
    .card-title{
      margin:0;
      font-size:14px;
      font-weight:700;
      color:#fff;
      text-overflow:ellipsis;
      white-space:nowrap;
      overflow:hidden;
    }
    .card-subtitle{
      margin:2px 0 0;
      font-size:11px;
      color:var(--muted);
      text-overflow:ellipsis;
      white-space:nowrap;
      overflow:hidden;
    }

    .chip-row{
      display:flex;
      flex-wrap:wrap;
      gap:4px;
      margin-top:6px;
    }
    .chip{
      border-radius:999px;
      padding:2px 7px;
      font-size:10px;
      border:1px solid rgba(163,139,99,.4);
      background:var(--chip-bg);
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.08em;
    }
    .chip-primary{ border-color:var(--gold); color:var(--gold); }
    .chip-green{ border-color:rgba(76,175,80,.7); color:#A5D6A7; }
    .chip-red{ border-color:rgba(242,95,92,.8); color:#FFABAB; }
    .chip-yellow{ border-color:rgba(255,200,87,.8); color:#FFE082; }
    .chip-urg{
      border-color: rgba(255,255,255,.18);
      background: rgba(0,0,0,.35);
      color: rgba(255,255,255,.75);
    }
    .chip-urg.warn{
      border-color: rgba(255,200,87,.75);
      color: #FFE082;
    }
    .chip-urg.soon{
      border-color: rgba(255,159,28,.85);
      color: #FFD0A3;
    }
    .chip-urg.due{
      border-color: rgba(242,95,92,.85);
      color: #FFABAB;
    }
    .card-section{
      border-top:1px solid rgba(163,139,99,.18);
      padding-top:6px;
      margin-top:2px;
      font-size:12px;
      color:var(--muted);
    }
    .card-mini-grid{
      display:grid;
      grid-template-columns:1fr;
      gap:4px;
    }
    .mini-line{
      display:flex;
      gap:8px;
      align-items:flex-start;
      line-height:1.2;
    }
    .mini-k{
      width:78px;
      flex:0 0 auto;
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:.14em;
      color:rgba(255,255,255,.38);
    }
    .mini-v{
      font-size:12px;
      color:rgba(255,255,255,.78);
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .mini-v a{ color:var(--gold); text-decoration:none; border-bottom:1px dashed rgba(163,139,99,.45); }
    .mini-v a:hover{ border-bottom-color:rgba(163,139,99,.9); }

    .card-footer{
      margin-top:6px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      font-size:11px;
      color:var(--muted);
      flex-wrap:wrap;
    }
    .card-footer-left{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      align-items:center;
    }
    .card-footer-right{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      justify-content:flex-end;
    }

    .btn-xs{
      border-radius:999px;
      padding:4px 8px;
      border:1px solid rgba(163,139,99,.35);
      background:rgba(5,5,5,.9);
      color:var(--muted);
      font-size:10px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      transition:.16s transform,.16s border-color,.16s box-shadow;
      white-space:nowrap;
    }
    .btn-xs:hover{
      transform:translateY(-1px);
      border-color:rgba(163,139,99,.7);
      box-shadow:0 10px 18px rgba(0,0,0,.35);
    }
    .btn-xs.primary{ border-color:var(--gold); color:var(--gold); }
    .btn-xs.danger{ border-color:var(--danger); color:#FFB3B0; }
    .btn-xs.success{ border-color:rgba(76,175,80,.75); color:#BDEFC0; }
    .btn-xs.warn{ border-color:rgba(255,200,87,.8); color:#FFE6A7; }

    .empty{
      font-size:12px;
      color:var(--muted);
      padding:16px 4px;
    }

    /* MODALS */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.72);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:40;
      padding:10px;
    }
    .modal-backdrop.open{ display:flex; }
    .modal{
      width:min(1040px,96vw);
      max-height:90vh;
      background:radial-gradient(circle at top,#151515,#050505);
      border-radius:22px;
      border:1px solid rgba(163,139,99,.5);
      box-shadow:0 24px 45px rgba(0,0,0,.8);
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }
    .modal-header{
      padding:10px 14px 9px;
      border-bottom:1px solid rgba(163,139,99,.25);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background:linear-gradient(90deg,#050505,#111,#050505);
    }
    .modal-header h2{
      margin:0;
      font-size:14px;
      letter-spacing:.12em;
      text-transform:uppercase;
      color:var(--gold);
    }
    .modal-body{ padding:10px 14px 12px; overflow-y:auto; }
    .modal-footer{
      padding:9px 14px 10px;
      border-top:1px solid rgba(163,139,99,.25);
      display:flex;
      justify-content:space-between;
      gap:10px;
      background:#050505;
      flex-wrap:wrap;
      align-items:center;
    }
    .modal-footer-left{ font-size:11px; color:var(--muted); max-width:720px; }

    .form-grid{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:10px;
    }
    @media (max-width: 980px){
      .form-grid{ grid-template-columns:1fr; }
    }
    .form-section{
      border-radius:var(--radius-md);
      border:1px solid rgba(163,139,99,.22);
      background:rgba(0,0,0,.55);
      padding:9px 10px;
    }
    .form-section h3{
      margin:0 0 6px;
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.14em;
      color:var(--muted);
    }
    .help{
      font-size:11px;
      color:rgba(255,255,255,.45);
      margin:6px 0 0;
      line-height:1.25;
    }

    /* KIT FSBO (modal) */
    .kit-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    @media (max-width: 980px){
      .kit-grid{ grid-template-columns:1fr; }
    }
    .kit-box{
      border-radius:14px;
      border:1px solid rgba(163,139,99,.22);
      background:rgba(0,0,0,.55);
      padding:10px 10px 8px;
    }
    .kit-box h3{
      margin:0 0 6px;
      font-size:11px;
      letter-spacing:.14em;
      text-transform:uppercase;
      color:var(--muted);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    .kit-box textarea{
      min-height:150px;
      font-size:12px;
      line-height:1.3;
    }
    .kit-actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:8px;
    }
    .toast{
      position:fixed;
      bottom:14px;
      left:50%;
      transform:translateX(-50%);
      background:rgba(0,0,0,.85);
      border:1px solid rgba(163,139,99,.35);
      color:#fff;
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      display:none;
      z-index:80;
      box-shadow:0 18px 40px rgba(0,0,0,.55);
    }
    .toast.show{ display:block; }
/* Kit FSBO ‚Äî bot√µes compactos (sobretudo para obje√ß√µes) */
.kit-actions.objections .btn{
  padding: 6px 10px;
  font-size: 11px;
  gap: 6px;
  border-radius: 999px;
}

.kit-actions.objections{
  gap: 6px;
}
    /* Attachments */
    .attach-list{
      display:flex;
      flex-direction:column;
      gap:6px;
      margin-top:6px;
    }
    .attach-item{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      padding:8px 9px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.55);
    }
    .attach-left{
      min-width:0;
    }
    .attach-name{
      font-size:12px;
      color:rgba(255,255,255,.85);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:520px;
    }
    .attach-meta{
      font-size:11px;
      color:rgba(255,255,255,.42);
      margin-top:2px;
    }

    .hr-soft{
      height:1px;
      background:linear-gradient(90deg, transparent, rgba(163,139,99,.25), transparent);
      margin:10px 0;
      border:0;
    }
    /* === FSBO ‚Äî Alerta por proximidade da Pr√≥xima A√ß√£o === */
.card.fsbo-warning{
  border-color: rgba(255, 200, 87, .95); /* amarelo */
  box-shadow: 0 0 0 1px rgba(255, 200, 87, .28), var(--shadow-soft);
}

.card.fsbo-urgent{
  border-color: rgba(230, 126, 34, .95); /* laranja */
  box-shadow: 0 0 0 1px rgba(230, 126, 34, .30), var(--shadow-soft);
}

.card.fsbo-overdue{
  border-color: rgba(242, 95, 92, .95); /* vermelho */
  box-shadow: 0 0 0 1px rgba(242, 95, 92, .34), var(--shadow-soft);
}
    /* ================================
   KIT FSBO ‚Äî Bot√µes com ‚Äúvida‚Äù (com cor)
   (apenas dentro do modal do Kit)
================================ */
#kitBackdrop .kit-actions .btn{
  border-radius: 999px;
  padding: 7px 12px;
  font-size: 12px;
  gap: 7px;

  border: 1px solid rgba(255,255,255,.14);
  background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(0,0,0,.35));
  box-shadow: 0 10px 22px rgba(0,0,0,.35);
  backdrop-filter: blur(6px);

  transition: .16s transform, .16s box-shadow, .16s border-color, .16s filter;
}

#kitBackdrop .kit-actions .btn:hover{
  transform: translateY(-1px);
  border-color: rgba(163,139,99,.65);
  box-shadow: 0 18px 40px rgba(0,0,0,.55);
  filter: brightness(1.05);
}

#kitBackdrop .kit-actions .btn:disabled{
  opacity: .45;
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
  filter: none;
}

/* Ghost no Kit (deixa de ser ‚Äúplano‚Äù) */
#kitBackdrop .kit-actions .btn.btn-ghost{
  border-color: rgba(255,255,255,.16);
  background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.38));
}

/* Primary no Kit (mant√©m ouro, mas com profundidade) */
#kitBackdrop .kit-actions .btn.btn-primary{
  border-color: rgba(163,139,99,.95);
  background: linear-gradient(180deg, rgba(163,139,99,1), rgba(163,139,99,.72));
  color: #0A0A0A;
  box-shadow: 0 16px 34px rgba(163,139,99,.18), 0 20px 50px rgba(0,0,0,.55);
}

/* ================================
   Cores por bot√£o (sem mudar HTML)
   (WhatsApp / Follow-ups / Copiar / Obje√ß√µes)
================================ */

/* Abrir WhatsApp ‚Äî verde */
#kitBackdrop #openWhatsappBtn{
  border-color: rgba(76,175,80,.65);
  background: linear-gradient(180deg, rgba(76,175,80,.95), rgba(20,70,30,.35));
  color: #061006;
}

/* Follow-up 48h ‚Äî laranja ‚Äúa√ß√£o‚Äù */
#kitBackdrop #followup48hBtn{
  border-color: rgba(255,159,28,.75);
  background: linear-gradient(180deg, rgba(255,159,28,.95), rgba(40,20,0,.35));
  color: #120900;
}

/* Copiar ‚Äî azul neutro (profissional) */
#kitBackdrop #copyWhatsappBtn,
#kitBackdrop #copyCallBtn,
#kitBackdrop #copyEmailBtn,
#kitBackdrop #copySwotBtn{
  border-color: rgba(90,160,255,.55);
  background: linear-gradient(180deg, rgba(90,160,255,.22), rgba(0,0,0,.42));
}

/* Abrir email ‚Äî dourado/neutral (para n√£o competir com WhatsApp) */
#kitBackdrop #openMailtoBtn{
  border-color: rgba(163,139,99,.65);
  background: linear-gradient(180deg, rgba(163,139,99,.22), rgba(0,0,0,.42));
}

/* Obje√ß√µes WhatsApp ‚Äî ‚Äúchips com cor‚Äù */
#kitBackdrop #objSoloBtn{
  border-color: rgba(255,200,87,.80);
  background: linear-gradient(180deg, rgba(255,200,87,.22), rgba(0,0,0,.45));
}
#kitBackdrop #objManyAgenciesBtn{
  border-color: rgba(90,160,255,.65);
  background: linear-gradient(180deg, rgba(90,160,255,.18), rgba(0,0,0,.45));
}
#kitBackdrop #objCommissionBtn{
  border-color: rgba(242,95,92,.75);
  background: linear-gradient(180deg, rgba(242,95,92,.18), rgba(0,0,0,.45));
}
#kitBackdrop #objExclusiveBtn{
  border-color: rgba(163,139,99,.75);
  background: linear-gradient(180deg, rgba(163,139,99,.18), rgba(0,0,0,.45));
}

/* Reset ‚Äî discreto, mas consistente */
#kitBackdrop #objResetWhatsappBtn,
#kitBackdrop #emailResetBtn{
  border-color: rgba(255,255,255,.16);
  background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.50));
}

/* Obje√ß√µes Email ‚Äî mesma l√≥gica (compactos j√° est√£o) */
#kitBackdrop #emailObjManyAgenciesBtn{
  border-color: rgba(90,160,255,.65);
  background: linear-gradient(180deg, rgba(90,160,255,.16), rgba(0,0,0,.48));
}
#kitBackdrop #emailObjCommissionBtn{
  border-color: rgba(242,95,92,.75);
  background: linear-gradient(180deg, rgba(242,95,92,.16), rgba(0,0,0,.48));
}
#kitBackdrop #emailObjExclusiveBtn{
  border-color: rgba(163,139,99,.75);
  background: linear-gradient(180deg, rgba(163,139,99,.16), rgba(0,0,0,.48));
}
  </style>
</head>

<body>
<div class="app-shell">
  <header class="app-header">
    <div class="brand">
      <div class="brand-icon" aria-hidden="true">
        <svg width="16" height="16" viewBox="0 0 24 24" stroke="var(--gold)" fill="none" stroke-width="1.8">
          <circle cx="12" cy="12" r="9"></circle>
          <path d="M8 12.5l2.5 2.5L16 9"></path>
        </svg>
      </div>
      <div>
        <div class="brand-app">Garvetur Porto Pro</div>
        <h1>FSBO</h1>
        <span class="sub">Prospe√ß√£o ‚ÄúFor Sale By Owner‚Äù (Idealista ¬∑ Imovirtual ¬∑ Casa Sapo ¬∑ Outros) ‚Äî registo, contacto, kit de abordagem e anexos.</span>
      </div>
    </div>

    <nav class="nav-tabs">
      <a href="index.html" class="nav-tab">In√≠cio</a>
      <a href="mapa.html" class="nav-tab">Mapa</a>
      <a href="kanban.html" class="nav-tab">Leads</a>
      <a href="angariacoes.html" class="nav-tab">Angaria√ß√µes</a>
      <a href="particulares.html" class="nav-tab active">FSBO</a>
      <a href="dashboard.html" class="nav-tab">Dashboard</a>
      <a href="vendas.html" class="nav-tab">Vendas</a>
      <a href="tarefas.html" class="nav-tab">Tarefas</a>
      <a href="consultores-admin.html" class="nav-tab">Consultores</a>
    </nav>

    <div class="toolbar">
      <div class="tool-group">
        <div class="tool-label">Dados</div>
        <div class="pill-lock" id="lockPill">
          <span>Modo</span>
          <span class="state" id="lockStateLabel">Bloqueado</span>
          <button id="toggleLockBtn" title="Alternar entre edi√ß√£o bloqueada e ativa">üîí</button>
        </div>
        <button class="btn btn-ghost" id="importCsvBtn" title="Importar registos de CSV">‚§í Importar CSV</button>
      </div>

      <div class="tool-group">
        <div class="tool-label">Exportar</div>
        <button class="btn btn-ghost" id="exportCsvBtn" title="Exportar para CSV">‚§ì CSV</button>
        <button class="btn btn-ghost" id="exportPdfBtn" title="Imprimir / PDF">‚§ì PDF</button>
      </div>

      <div class="tool-group">
        <div class="tool-label">Backup</div>
        <button class="btn btn-ghost" id="backupBtn" title="Exportar backup (JSON)">üíæ Backup</button>
        <button class="btn btn-ghost" id="restoreBtn" title="Restaurar backup (JSON)">‚§∫ Restaurar</button>
      </div>

      <div class="tool-group">
        <div class="tool-label">Criar</div>
        <button class="btn btn-primary" id="newItemBtn">+ Novo FSBO</button>
      </div>
    </div>
  </header>

  <div class="layout">
    <aside class="sidebar">
      <div class="sidebar-section">
        <h3>Filtros</h3>

        <div class="field">
          <label class="field-label" for="filterConsultor">Consultor</label>
          <select id="filterConsultor">
            <option value="">Todos</option>
          </select>
        </div>

        <div class="field">
          <label class="field-label" for="filterPortal">Portal</label>
          <select id="filterPortal">
            <option value="">Todos</option>
            <option value="Idealista">Idealista</option>
            <option value="Imovirtual">Imovirtual</option>
            <option value="Casa Sapo">Casa Sapo</option>
            <option value="OLX">OLX</option>
            <option value="Outro">Outro</option>
          </select>
        </div>

        <div class="field">
          <label class="field-label" for="filterEstado">Estado prospe√ß√£o</label>
          <select id="filterEstado">
            <option value="">Todos</option>
            <option value="identificado">Identificado</option>
            <option value="contacto-feito">Contacto feito</option>
            <option value="follow-up">Follow-up</option>
            <option value="visita">Visita</option>
            <option value="proposta-enviada">Proposta enviada</option>
            <option value="angariado">Angariado</option>
            <option value="descartado">Descartado</option>
          </select>
        </div>

        <div class="field">
          <label class="field-label" for="filterSearchText">Pesquisa r√°pida</label>
          <input type="text" id="filterSearchText" placeholder="T√≠tulo, concelho, freguesia, zona, propriet√°rio, contacto‚Ä¶" />
        </div>

        <div class="field">
          <label class="field-label">Per√≠odo (identifica√ß√£o)</label>
          <div class="field-row">
            <div class="field">
              <label class="field-label" for="filterDataDe">De</label>
              <input type="date" id="filterDataDe" />
            </div>
            <div class="field">
              <label class="field-label" for="filterDataAte">At√©</label>
              <input type="date" id="filterDataAte" />
            </div>
          </div>
        </div>

        <div class="toggle-line">
          <span>Mostrar invis√≠veis</span>
          <label class="switch">
            <input type="checkbox" id="filterShowHidden">
            <span class="slider"></span>
          </label>
        </div>
        <div class="toggle-line">
          <span>S√≥ invis√≠veis</span>
          <label class="switch">
            <input type="checkbox" id="filterOnlyHidden">
            <span class="slider"></span>
          </label>
        </div>

        <div class="field-row" style="margin-top:8px;">
          <button class="btn" id="filterApplyBtn" style="flex:1;">Aplicar</button>
          <button class="btn btn-ghost" id="filterClearBtn" style="flex:1;border-color:rgba(255,255,255,.2);">Limpar</button>
        </div>

        <p style="margin-top:6px;">
          Use estes filtros para preparar o trabalho de prospe√ß√£o (por consultor, portal, estado e datas).
          O bot√£o <strong>Aplicar</strong> guarda os filtros neste navegador.
        </p>
      </div>

      <div class="sidebar-section">
        <h3>Resumo r√°pido</h3>
        <div class="filters-badges" id="summaryBadges"></div>
      </div>

      <div class="sidebar-section">
        <h3>Notas</h3>
        <p>Quando o cadeado est√° em <strong>Bloqueado</strong>, n√£o h√° risco de alterar dados por engano.</p>
        <p>Quando est√° <strong>Edi√ß√£o ativa</strong>, pode criar, editar e apagar registos FSBO.</p>
        <p class="help">
          <strong>Anexos PDF:</strong> s√£o guardados localmente no browser (IndexedDB). N√£o seguem no CSV. No backup JSON seguem apenas as refer√™ncias.
        </p>
      </div>
    </aside>

    <main class="cards-area">
      <div class="cards-header">
        <div class="cards-header-left">
          <h2>FSBO</h2>
          <p>Vis√£o consolidada de prospe√ß√£o a particulares. Em cada cart√£o: contacto do propriet√°rio, link, e ‚ÄúKit FSBO‚Äù (WhatsApp, chamada, email + SWOT).</p>
          <div class="pipeline-kpis" id="pipelineKpis"></div>
        </div>
      </div>

      <div id="cardsGrid" class="cards-grid"></div>
      <div id="emptyState" class="empty" style="display:none;">
        Ainda n√£o existem registos FSBO com os filtros atuais.
      </div>
    </main>
  </div>
</div>

<!-- MODAL: REGISTO FSBO -->
<div class="modal-backdrop" id="modalBackdrop">
  <div class="modal">
    <div class="modal-header">
      <h2 id="modalTitle">Novo FSBO</h2>
      <button class="btn btn-icon btn-ghost" id="closeModalBtn" title="Fechar">‚úï</button>
    </div>
    <div class="modal-body">
      <form id="itemForm">
        <input type="hidden" id="itemId" />
        <div class="form-grid">

          <!-- COLUNA 1 -->
          <div class="form-section">
            <h3>Propriet√°rio & Portal</h3>

            <div class="field-row">
              <div class="field">
                <label class="field-label" for="consultor">Consultor</label>
                <select id="consultor"></select>
              </div>
              <div class="field">
                <label class="field-label" for="portal">Portal</label>
                <select id="portal">
                  <option value="">‚Äî</option>
                  <option value="Idealista">Idealista</option>
                  <option value="Imovirtual">Imovirtual</option>
                  <option value="Casa Sapo">Casa Sapo</option>
                  <option value="OLX">OLX</option>
                  <option value="Outro">Outro</option>
                </select>
              </div>
            </div>

            <div class="field">
              <label class="field-label" for="link">Link do an√∫ncio</label>
              <input type="text" id="link" placeholder="https://‚Ä¶" />
              <div class="help">Se o portal bloquear a leitura autom√°tica, o ‚ÄúKit FSBO‚Äù usa o que estiver preenchido no registo (t√≠tulo, tipologia, pre√ßo, zona, observa√ß√µes).</div>
            </div>

            <hr class="hr-soft"/>

            <div class="field-row">
              <div class="field">
                <label class="field-label" for="ownerName">Nome do propriet√°rio</label>
                <input type="text" id="ownerName" placeholder="Ex.: Sr. Jo√£o Silva" />
              </div>
              <div class="field">
                <label class="field-label" for="ownerPhone">M√≥vel</label>
                <input type="text" id="ownerPhone" placeholder="Ex.: 9xx xxx xxx" />
              </div>
            </div>

            <div class="field">
              <label class="field-label" for="ownerEmail">Email</label>
              <input type="email" id="ownerEmail" placeholder="ex.: nome@email.com" />
            </div>

            <hr class="hr-soft"/>

            <div class="field-row">
              <div class="field">
                <label class="field-label" for="estadoProspeccao">Estado prospe√ß√£o</label>
                <select id="estadoProspeccao">
                  <option value="identificado">Identificado</option>
                  <option value="contacto-feito">Contacto feito</option>
                  <option value="follow-up">Follow-up</option>
                  <option value="visita">Visita</option>
                  <option value="proposta-enviada">Proposta enviada</option>
                  <option value="angariado">Angariado</option>
                  <option value="descartado">Descartado</option>
                </select>
              </div>
              <div class="field">
                <label class="field-label" for="refAngariacao">Ref. angaria√ß√£o (se j√° existir)</label>
                <input type="text" id="refAngariacao" placeholder="Ex.: GPP-2025-001" />
              </div>
            </div>

            <div class="field-row">
              <div class="field">
                <label class="field-label" for="dataIdentificacao">Data identifica√ß√£o</label>
                <input type="date" id="dataIdentificacao" />
              </div>
              <div class="field">
                <label class="field-label" for="dataPrimeiroContacto">Primeiro contacto</label>
                <input type="date" id="dataPrimeiroContacto" />
              </div>
            </div>

            <div class="field-row">
              <div class="field">
                <label class="field-label" for="dataUltimaAcao">√öltima a√ß√£o</label>
                <input type="date" id="dataUltimaAcao" />
              </div>
              <div class="field">
                <label class="field-label" for="proximaAcaoData">Pr√≥xima a√ß√£o (data)</label>
                <input type="date" id="proximaAcaoData" />
              </div>
            </div>

            <div class="field">
              <label class="field-label" for="proximaAcaoTipo">Pr√≥xima a√ß√£o (tipo)</label>
              <select id="proximaAcaoTipo">
                <option value="">‚Äî</option>
                <option value="ligar">Ligar</option>
                <option value="email">Enviar email</option>
                <option value="visita">Visita</option>
                <option value="proposta">Enviar proposta</option>
                <option value="outro">Outro</option>
              </select>
            </div>
          </div>

          <!-- COLUNA 2 -->
          <div class="form-section">
            <h3>Im√≥vel, Notas & Anexos</h3>

            <div class="field">
              <label class="field-label" for="tituloImovel">T√≠tulo / Designa√ß√£o</label>
              <input type="text" id="tituloImovel" placeholder="Ex.: T2 com varanda junto ao Parque da Cidade" />
            </div>

            <div class="field-row">
              <div class="field">
                <label class="field-label" for="concelho">Concelho</label>
                <input type="text" id="concelho" />
              </div>
              <div class="field">
                <label class="field-label" for="freguesia">Freguesia</label>
                <input type="text" id="freguesia" />
              </div>
            </div>

            <div class="field">
              <label class="field-label" for="zona">Zona / Refer√™ncia local</label>
              <input type="text" id="zona" placeholder="Ex.: Boavista, Foz, Antas‚Ä¶" />
            </div>

            <div class="field-row">
              <div class="field">
                <label class="field-label" for="natureza">Natureza</label>
                <select id="natureza">
                  <option value="">‚Äî</option>
                  <option value="apartamento">Apartamento</option>
                  <option value="moradia">Moradia</option>
                  <option value="terreno">Terreno</option>
                  <option value="loja">Loja</option>
                  <option value="escritorio">Escrit√≥rio</option>
                  <option value="outro">Outro</option>
                </select>
              </div>
              <div class="field">
                <label class="field-label" for="tipologia">Tipologia</label>
                <input type="text" id="tipologia" placeholder="Ex.: T1, T2, T3+1" />
              </div>
            </div>

            <div class="field">
              <label class="field-label" for="precoAnuncio">Pre√ßo an√∫ncio (‚Ç¨)</label>
              <input type="number" id="precoAnuncio" min="0" step="1000" />
            </div>

            <div class="field">
              <label class="field-label" for="observacoes">Observa√ß√µes</label>
              <textarea id="observacoes" placeholder="Notas sobre o propriet√°rio, obje√ß√µes, alinhamento de pre√ßo, etc."></textarea>
            </div>

            <div class="field">
              <label class="field-label" for="notasInternas">Notas internas</label>
              <textarea id="notasInternas" placeholder="Uso interno: estrat√©gia, hist√≥rico de conversas, alertas."></textarea>
            </div>

            <hr class="hr-soft"/>

            <div class="field">
              <label class="field-label">Anexos PDF (v√°rios)</label>
              <div class="field-row" style="align-items:center;">
                <button type="button" class="btn btn-ghost" id="addPdfBtn">+ Adicionar PDFs</button>
                <button type="button" class="btn btn-ghost" id="refreshPdfsBtn">‚Üª Atualizar lista</button>
              </div>
              <div class="help">Ex.: estudos de mercado, CMA, relat√≥rios, plantas. Guardado no browser (IndexedDB).</div>
              <div id="pdfList" class="attach-list"></div>
            </div>
          </div>

        </div>
      </form>
    </div>
    <div class="modal-footer">
      <div class="modal-footer-left">
        Dados do FSBO guardados neste navegador (localStorage). PDFs guardados no browser (IndexedDB). Use exporta√ß√µes/backup para seguran√ßa.
      </div>
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <button class="btn btn-ghost" id="cancelModalBtn">Cancelar</button>
        <button class="btn btn-primary" id="saveItemBtn">Guardar</button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL: KIT FSBO -->
<div class="modal-backdrop" id="kitBackdrop">
  <div class="modal">
    <div class="modal-header">
      <h2 id="kitTitle">Kit FSBO</h2>
      <button class="btn btn-icon btn-ghost" id="closeKitBtn" title="Fechar">‚úï</button>
    </div>

    <div class="modal-body">
      <div class="form-section" style="margin-bottom:10px;">
        <h3>Resumo do registo</h3>
        <div class="card-mini-grid" id="kitSummary"></div>
        <div class="help" id="kitFetchNote"></div>
      </div>

      <div class="kit-grid">
        <div class="kit-box">
          <h3>
            WhatsApp (mensagem)
            <span style="font-size:10px;color:rgba(255,255,255,.45);letter-spacing:.12em;">copy & enviar</span>
          </h3>
          <textarea id="kitWhatsapp"></textarea>
          <!-- BEGIN: Kit WhatsApp actions (com Follow-up 48h) -->
<div class="kit-actions">
  <button class="btn btn-ghost" id="copyWhatsappBtn">üìã Copiar</button>
  <button class="btn btn-primary" id="openWhatsappBtn">üü¢ Abrir WhatsApp</button>
  <button class="btn btn-ghost" id="followup48hBtn" title="Gera Follow-up 48h e abre WhatsApp + Email">‚è± Follow-up 48h (WA+Email)</button>
  <button class="btn btn-ghost" id="pdfWhatsappBtn" title="Gerar PDF desta mensagem">üßæ PDF</button>
</div>
<!-- END: Kit WhatsApp actions (com Follow-up 48h) -->
          <div class="kit-actions" style="margin-top:8px;">
  <button class="btn btn-ghost" id="objSoloBtn">Responder: Vendo sozinho</button>
  <button class="btn btn-ghost" id="objManyAgenciesBtn">Responder: J√° tenho imobili√°rias</button>
  <button class="btn btn-ghost" id="objCommissionBtn">Responder: Comiss√£o</button>
  <button class="btn btn-ghost" id="objExclusiveBtn">Responder: Sem exclusivo</button>
  <button class="btn btn-ghost" id="objResetWhatsappBtn" title="Voltar √† mensagem principal gerada pelo Kit">‚Ü©Ô∏é Voltar ao principal</button>
</div>
        </div>

        <div class="kit-box">
          <h3>Chamada (script)</h3>
          <textarea id="kitCall"></textarea>
         <div class="kit-actions">
  <button class="btn btn-ghost" id="copyCallBtn">üìã Copiar</button>
  <button class="btn btn-ghost" id="pdfCallBtn" title="Gerar PDF deste script">üßæ PDF</button>
</div>
        </div>

       <div class="kit-box">
  <h3>Email (profissional)</h3>
  <textarea id="kitEmail"></textarea>

 <div class="kit-actions">
  <button class="btn btn-ghost" id="copyEmailBtn">üìã Copiar</button>
  <button class="btn btn-ghost" id="openMailtoBtn">‚úâÔ∏è Abrir email</button>
  <button class="btn btn-ghost" id="pdfEmailBtn" title="Gerar PDF deste email">üßæ PDF</button>
</div>

  <div class="kit-actions objections">
    <button class="btn btn-ghost" id="emailObjManyAgenciesBtn">Email: J√° tenho imobili√°rias</button>
    <button class="btn btn-ghost" id="emailObjCommissionBtn">Email: Comiss√£o</button>
    <button class="btn btn-ghost" id="emailObjExclusiveBtn">Email: Sem exclusivo</button>
    <button class="btn btn-ghost" id="emailResetBtn" title="Voltar ao email principal gerado pelo Kit">‚Ü©Ô∏é Voltar ao principal</button>
  </div>
</div>

        <div class="kit-box">
  <h3>Resumo do an√∫ncio</h3>
  <textarea id="kitResumo" placeholder="Clique em ‚ÄúGerar resumo‚Äù para criar um resumo premium a partir das Observa√ß√µes/Notas."></textarea>

  <div class="kit-actions">
    <button class="btn btn-primary" id="genResumoBtn">‚ú® Gerar resumo</button>
    <button class="btn btn-ghost" id="clearResumoBtn">üßπ Limpar</button>
    <button class="btn btn-ghost" id="copyResumoBtn">üìã Copiar</button>
    <button class="btn btn-ghost" id="pdfResumoBtn" title="Gerar PDF deste resumo">üßæ PDF</button>
  </div>
</div>
        <div class="kit-box">
          <h3>SWOT (base)</h3>
          <textarea id="kitSwot"></textarea>
         <div class="kit-actions">
  <button class="btn btn-ghost" id="copySwotBtn">üìã Copiar</button>
  <button class="btn btn-ghost" id="pdfSwotBtn" title="Gerar PDF desta SWOT">üßæ PDF</button>
</div>
        </div>
      </div>

      <div class="help" style="margin-top:10px;">
        Nota: Este ‚ÄúKit FSBO‚Äù n√£o √© IA externa ‚Äî √© um gerador profissional, consistente e orientado √† convers√£o, com base nos dados do registo + tentativa de leitura do t√≠tulo do link quando tecnicamente poss√≠vel.
      </div>
    </div>

    <div class="modal-footer">
      <div class="modal-footer-left">
        Recomenda-se personaliza√ß√£o final (nome do propriet√°rio, refer√™ncia de zona, proposta de valor, e pr√≥ximo passo).
      </div>
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <button class="btn btn-ghost" id="regenKitBtn">‚Üª Regenerar</button>
        <button class="btn btn-primary" id="closeKitBtn2">Fechar</button>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast">Copiado</div>

<!-- Config central de consultores -->
<script src="config-consultores.js?v=2"></script>

<script>
(function(){
  const STORAGE_KEY = 'gpp_particulares_v2';            // incrementado
  const STORAGE_KEY_LEGACY = 'gpp_particulares_v1';     // compat
  const FILTERS_STORAGE_KEY = 'gpp_particulares_filters_v1';

  // IndexedDB para PDFs
  const DB_NAME = 'gpp_fsbo_attachments_db';
  const DB_VERSION = 1;
  const STORE = 'attachments';

  // Lista fallback
  const FALLBACK_CONSULTOR_OPTIONS = [
    "Rui Quelhas","Manuel Oliveira","Jo√£o Sousa","Francisco dos Santos",
    "Ros√°rio Vasconcelos","Armanda Meireles","Audrey Lucas","Dalila Cunha","Outro"
  ];

  function obterConsultorOptions(){
    try{
      if(window.GPPConsultores && typeof window.GPPConsultores.getAtivos === 'function'){
        const lista = window.GPPConsultores.getAtivos();
        if(!Array.isArray(lista) || !lista.length) return FALLBACK_CONSULTOR_OPTIONS;

        const nomes = lista
          .map(c=>{
            if(typeof c === 'string') return c;
            if(c && typeof c === 'object'){
              return c.nome || c.name || c.id || '';
            }
            return '';
          })
          .filter(Boolean);
        return nomes.length ? nomes : FALLBACK_CONSULTOR_OPTIONS;
      }
    }catch(e){
      console.error('Erro ao ler consultores de GPPConsultores', e);
    }
    return FALLBACK_CONSULTOR_OPTIONS;
  }

  function $(id){ return document.getElementById(id); }
    /* ============ Import via Bookmarklet (Idealista/Imovirtual) ============ */
  function decodeImportPayload(raw){
  try{
    if(!raw) return null;

    // 1) desfazer URL encoding (muito importante)
    let b64 = String(raw).trim();
    try{ b64 = decodeURIComponent(b64); }catch(e){}

    // 2) aceitar base64url tamb√©m (caso apare√ßa)
    b64 = b64.replace(/-/g,'+').replace(/_/g,'/');

    // 3) garantir padding
    while(b64.length % 4) b64 += '=';

    const json = decodeURIComponent(escape(atob(b64)));
    const obj = JSON.parse(json);
    return (obj && typeof obj === 'object') ? obj : null;
  }catch(e){
    console.error('Falha a descodificar import payload', e);
    return null;
  }
}

  function prefillFormFromPayload(p){
    // abre como NOVO (n√£o cria ID nem grava automaticamente)
    openModal(null);

    // Mapeamento para o teu formul√°rio
    $('portal').value = p.portal || '';
    $('link').value = p.link || '';
    $('tituloImovel').value = p.tituloImovel || '';
    $('precoAnuncio').value = (p.precoAnuncio != null ? String(p.precoAnuncio) : '');
    $('concelho').value = p.concelho || '';
    $('freguesia').value = p.freguesia || '';
    $('zona').value = p.zona || '';
    $('natureza').value = p.natureza || '';
    $('tipologia').value = p.tipologia || '';
    $('ownerName').value = p.ownerName || '';
$('ownerPhone').value = p.ownerPhone || '';

    // Se vier descri√ß√£o longa, vai para observa√ß√µes
    if(p.descricao){
      $('observacoes').value = p.descricao;
    }

    // Metadados √∫teis para rastreabilidade
    const metaLines = [];
    if(p.ref) metaLines.push('Ref an√∫ncio: ' + p.ref);
    if(p.area) metaLines.push('√Årea: ' + p.area);
    if(p.quartos != null) metaLines.push('Quartos: ' + p.quartos);
    if(p.wc != null) metaLines.push('WC: ' + p.wc);
    if(p.andar) metaLines.push('Andar: ' + p.andar);
    if(p.extras && p.extras.length) metaLines.push('Extras: ' + p.extras.join(', '));
    if(p.anunciante) metaLines.push('Anunciante: ' + p.anunciante);

    if(metaLines.length){
      const prev = $('notasInternas').value || '';
      $('notasInternas').value =
        (prev ? (prev + '\n\n') : '') +
        'Import (bookmarklet):\n' +
        metaLines.join('\n');
    }

    showToast('Import preparado ‚Äî desbloqueie para guardar');
  }

  // Header
  const lockStateLabel = $('lockStateLabel');
  const toggleLockBtn = $('toggleLockBtn');
  const newItemBtn = $('newItemBtn');
  const importCsvBtn = $('importCsvBtn');
  const exportCsvBtn = $('exportCsvBtn');
  const exportPdfBtn = $('exportPdfBtn');
  const backupBtn = $('backupBtn');
  const restoreBtn = $('restoreBtn');

  // Main
  const cardsGrid = $('cardsGrid');
  const emptyState = $('emptyState');
  const pipelineKpis = $('pipelineKpis');
  const summaryBadges = $('summaryBadges');

  // Filters
  const filterConsultor = $('filterConsultor');
  const filterPortal = $('filterPortal');
  const filterEstado = $('filterEstado');
  const filterSearchText = $('filterSearchText');
  const filterDataDe = $('filterDataDe');
  const filterDataAte = $('filterDataAte');
  const filterShowHidden = $('filterShowHidden');
  const filterOnlyHidden = $('filterOnlyHidden');
  const filterApplyBtn = $('filterApplyBtn');
  const filterClearBtn = $('filterClearBtn');

  // Modal FSBO
  const modalBackdrop = $('modalBackdrop');
  const modalTitle = $('modalTitle');
  const closeModalBtn = $('closeModalBtn');
  const cancelModalBtn = $('cancelModalBtn');
  const saveItemBtn = $('saveItemBtn');
  const itemForm = $('itemForm');

  const consultorSelect = $('consultor');
  const portalSelect = $('portal');
  const estadoProspeccaoSelect = $('estadoProspeccao');

  const addPdfBtn = $('addPdfBtn');
  const refreshPdfsBtn = $('refreshPdfsBtn');
  const pdfList = $('pdfList');

  // Modal Kit
  const kitBackdrop = $('kitBackdrop');
  const kitTitle = $('kitTitle');
  const closeKitBtn = $('closeKitBtn');
  const closeKitBtn2 = $('closeKitBtn2');
  const regenKitBtn = $('regenKitBtn');
  const kitSummary = $('kitSummary');
  const kitFetchNote = $('kitFetchNote');
  const kitWhatsapp = $('kitWhatsapp');
  const kitCall = $('kitCall');
  const kitEmail = $('kitEmail');
  const kitSwot = $('kitSwot');

  const copyWhatsappBtn = $('copyWhatsappBtn');
  const openWhatsappBtn = $('openWhatsappBtn');
  const followup48hBtn = $('followup48hBtn');
  const objSoloBtn = $('objSoloBtn');
const objManyAgenciesBtn = $('objManyAgenciesBtn');
const objCommissionBtn = $('objCommissionBtn');
const objExclusiveBtn = $('objExclusiveBtn');
const objResetWhatsappBtn = $('objResetWhatsappBtn');

let kitWhatsappMainMessage = ''; // guarda o ‚Äúprincipal‚Äù para voltar atr√°s
  const copyCallBtn = $('copyCallBtn');
  const copyEmailBtn = $('copyEmailBtn');
  const emailObjManyAgenciesBtn = $('emailObjManyAgenciesBtn');
const emailObjCommissionBtn = $('emailObjCommissionBtn');
const emailObjExclusiveBtn = $('emailObjExclusiveBtn');
const emailResetBtn = $('emailResetBtn');

    // Resumo no Kit
  const kitResumo = $('kitResumo');
  const genResumoBtn = $('genResumoBtn');
  const clearResumoBtn = $('clearResumoBtn');
  const copyResumoBtn = $('copyResumoBtn');
  const pdfResumoBtn = $('pdfResumoBtn');

let kitEmailMainMessage = '';
  const openMailtoBtn = $('openMailtoBtn');
  const copySwotBtn = $('copySwotBtn');

  const toast = $('toast');

  let state = { locked:true, items:[] };
  let currentEditingId = null;
  let currentKitItem = null;
  let lastFetchedTitle = null;

  function showToast(msg){
    toast.textContent = msg || 'OK';
    toast.classList.add('show');
    setTimeout(()=>toast.classList.remove('show'), 1600);
  }

 function migrateItem(d){
  if(!d || typeof d !== 'object'){
    return {
      visible: true,
      estadoProspeccao: 'identificado',
      ownerName: '',
      ownerPhone: '',
      ownerEmail: ''
    };
  }

  const out = { ...d };

  // Defaults aplicados no fim (n√£o podem ser anulados)
  out.visible = (d.visible === false) ? false : true;
  out.estadoProspeccao = d.estadoProspeccao || 'identificado';
  out.ownerName = d.ownerName || '';
  out.ownerPhone = d.ownerPhone || '';
  out.ownerEmail = d.ownerEmail || '';
// Normalizar precoAnuncio (CSV/backups antigos podem vir como string)
if(out.precoAnuncio === '' || out.precoAnuncio == null){
  out.precoAnuncio = null;
}else{
  const n = Number(out.precoAnuncio);
  out.precoAnuncio = isFinite(n) ? n : null;
}
  return out;
}

  function safeParse(raw){
    if(!raw) return null;
    try{ return JSON.parse(raw); }catch(e){ return null; }
  }

  function loadState(){
    // tenta v2
    let parsed = safeParse(localStorage.getItem(STORAGE_KEY));

    // fallback v1
    if(!parsed){
      parsed = safeParse(localStorage.getItem(STORAGE_KEY_LEGACY));
      if(parsed){
        // migra para v2
        try{
          localStorage.setItem(STORAGE_KEY, JSON.stringify(parsed));
        }catch(e){}
      }
    }

    if(parsed){
      if(Array.isArray(parsed)){
        state.items = parsed.map(migrateItem);
        state.locked = true;
        updateLockUI();
        saveState();
        return;
      }
      if(parsed && typeof parsed === 'object' && Array.isArray(parsed.items)){
        state.items = parsed.items.map(migrateItem);
        state.locked = parsed.locked !== false;
        updateLockUI();
        saveState();
        return;
      }
    }

    state.items = [];
    state.locked = true;
    updateLockUI();
    saveState();
  }

  function saveState(){
    try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
    catch(e){ console.error('Erro ao guardar storage de FSBO', e); }
  }

  function updateLockUI(){
    if(state.locked){
      lockStateLabel.textContent = 'Bloqueado';
      toggleLockBtn.textContent = 'üîí';
      newItemBtn.disabled = true;
      importCsvBtn.disabled = true;
    }else{
      lockStateLabel.textContent = 'Edi√ß√£o ativa';
      toggleLockBtn.textContent = 'üîì';
      newItemBtn.disabled = false;
      importCsvBtn.disabled = false;
    }
  }

  function initConsultores(){
    const nomes = obterConsultorOptions();
    consultorSelect.innerHTML = '';
    filterConsultor.innerHTML = '<option value="">Todos</option>';

    nomes.forEach(name=>{
      const opt1 = document.createElement('option');
      opt1.value = name; opt1.textContent = name;
      consultorSelect.appendChild(opt1);

      const opt2 = document.createElement('option');
      opt2.value = name; opt2.textContent = name;
      filterConsultor.appendChild(opt2);
    });
  }

  /* ============ IndexedDB (PDFs) ============ */
  function openDB(){
    return new Promise((resolve, reject)=>{
      const req = indexedDB.open(DB_NAME, DB_VERSION);
      req.onupgradeneeded = (ev)=>{
        const db = req.result;
        if(!db.objectStoreNames.contains(STORE)){
          const store = db.createObjectStore(STORE, { keyPath:'id' });
          store.createIndex('by_item', 'itemId', { unique:false });
        }
      };
      req.onsuccess = ()=>resolve(req.result);
      req.onerror = ()=>reject(req.error);
    });
  }

  async function addAttachment(itemId, file){
    const db = await openDB();
    const id = 'att_' + itemId + '_' + Date.now() + '_' + Math.random().toString(16).slice(2);
    const rec = {
      id,
      itemId,
      name: file.name || 'documento.pdf',
      type: file.type || 'application/pdf',
      size: file.size || 0,
      createdAt: new Date().toISOString(),
      blob: file
    };

    return new Promise((resolve, reject)=>{
      const tx = db.transaction(STORE, 'readwrite');
      tx.objectStore(STORE).put(rec);
      tx.oncomplete = ()=>resolve(rec);
      tx.onerror = ()=>reject(tx.error);
    });
  }

  async function listAttachments(itemId){
    const db = await openDB();
    return new Promise((resolve, reject)=>{
      const tx = db.transaction(STORE, 'readonly');
      const idx = tx.objectStore(STORE).index('by_item');
      const req = idx.getAll(itemId);
      req.onsuccess = ()=>resolve(req.result || []);
      req.onerror = ()=>reject(req.error);
    });
  }

  async function deleteAttachment(attId){
    const db = await openDB();
    return new Promise((resolve, reject)=>{
      const tx = db.transaction(STORE, 'readwrite');
      tx.objectStore(STORE).delete(attId);
      tx.oncomplete = ()=>resolve(true);
      tx.onerror = ()=>reject(tx.error);
    });
  }

  async function getAttachment(attId){
    const db = await openDB();
    return new Promise((resolve, reject)=>{
      const tx = db.transaction(STORE, 'readonly');
      const req = tx.objectStore(STORE).get(attId);
      req.onsuccess = ()=>resolve(req.result || null);
      req.onerror = ()=>reject(req.error);
    });
  }

  function bytesToNice(n){
    if(!n || !isFinite(n)) return '';
    const units = ['B','KB','MB','GB'];
    let i=0; let v=n;
    while(v>=1024 && i<units.length-1){ v/=1024; i++; }
    return (i===0 ? v.toFixed(0) : v.toFixed(1)) + ' ' + units[i];
  }

  async function refreshPdfList(){
    pdfList.innerHTML = '';
    if(!currentEditingId){
      pdfList.innerHTML = '<div class="help">Guarde o registo primeiro para poder anexar PDFs.</div>';
      return;
    }
    const list = await listAttachments(currentEditingId);
    if(!list.length){
      pdfList.innerHTML = '<div class="help">Sem anexos PDF neste registo.</div>';
      return;
    }

    list.sort((a,b)=>String(b.createdAt||'').localeCompare(String(a.createdAt||'')));

    list.forEach(att=>{
      const row = document.createElement('div');
      row.className = 'attach-item';

      const left = document.createElement('div');
      left.className = 'attach-left';

      const name = document.createElement('div');
      name.className = 'attach-name';
      name.textContent = att.name || 'documento.pdf';
      left.appendChild(name);

      const meta = document.createElement('div');
      meta.className = 'attach-meta';
      meta.textContent = (att.createdAt ? ('Adicionado: ' + att.createdAt.slice(0,10)) : '') + (att.size ? (' ¬∑ ' + bytesToNice(att.size)) : '');
      left.appendChild(meta);

      const right = document.createElement('div');
      right.style.display='flex';
      right.style.gap='6px';
      right.style.flexWrap='wrap';

      const openBtn = document.createElement('button');
      openBtn.className = 'btn-xs';
      openBtn.textContent = 'Abrir';
      openBtn.addEventListener('click', async ()=>{
        const rec = await getAttachment(att.id);
        if(!rec || !rec.blob){
          alert('N√£o foi poss√≠vel abrir este anexo.');
          return;
        }
        const url = URL.createObjectURL(rec.blob);
        window.open(url, '_blank');
        setTimeout(()=>URL.revokeObjectURL(url), 60000);
      });
      right.appendChild(openBtn);

      const delBtn = document.createElement('button');
      delBtn.className = 'btn-xs danger';
      delBtn.textContent = 'Remover';
      delBtn.addEventListener('click', async ()=>{
        if(state.locked){
          alert('Desbloqueie o modo de edi√ß√£o para remover anexos.');
          return;
        }
        if(confirm('Remover este PDF do registo?')){
          await deleteAttachment(att.id);
          await refreshPdfList();
        }
      });
      right.appendChild(delBtn);

      row.appendChild(left);
      row.appendChild(right);
      pdfList.appendChild(row);
    });
  }

  async function handleAddPdfs(){
    if(state.locked){
      alert('O modo de edi√ß√£o est√° bloqueado. Desbloqueie para anexar PDFs.');
      return;
    }
    if(!currentEditingId){
      alert('Guarde primeiro o registo (para criar ID) e depois anexe PDFs.');
      return;
    }

    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'application/pdf,.pdf';
    input.multiple = true;

    input.addEventListener('change', async (e)=>{
      const files = Array.from(e.target.files || []);
      if(!files.length) return;

      for(const f of files){
        try{ await addAttachment(currentEditingId, f); }
        catch(err){
          console.error('Erro ao anexar PDF', err);
          alert('Falha ao anexar um PDF. Pode ser limita√ß√£o do browser/armazenamento.');
        }
      }
      await refreshPdfList();
      showToast('PDF(s) anexado(s)');
    });

    input.click();
  }

  /* ============ Modal FSBO ============ */
  function openModal(item){
    modalBackdrop.classList.add('open');

    if(item){
      currentEditingId = item.id || '';
      modalTitle.textContent = 'Editar FSBO';
      $('itemId').value = item.id || '';
      consultorSelect.value = item.consultor || '';
      portalSelect.value = item.portal || '';
      $('link').value = item.link || '';
      estadoProspeccaoSelect.value = item.estadoProspeccao || 'identificado';
      $('refAngariacao').value = item.refAngariacao || '';
      $('dataIdentificacao').value = item.dataIdentificacao || '';
      $('dataPrimeiroContacto').value = item.dataPrimeiroContacto || '';
      $('dataUltimaAcao').value = item.dataUltimaAcao || '';
      $('proximaAcaoData').value = item.proximaAcaoData || '';
      $('proximaAcaoTipo').value = item.proximaAcaoTipo || '';
      $('tituloImovel').value = item.tituloImovel || '';
      $('concelho').value = item.concelho || '';
      $('freguesia').value = item.freguesia || '';
      $('zona').value = item.zona || '';
      $('natureza').value = item.natureza || '';
      $('tipologia').value = item.tipologia || '';
      $('precoAnuncio').value = item.precoAnuncio || '';
      $('observacoes').value = item.observacoes || '';
      $('notasInternas').value = item.notasInternas || '';

      $('ownerName').value = item.ownerName || '';
      $('ownerPhone').value = item.ownerPhone || '';
      $('ownerEmail').value = item.ownerEmail || '';
    }else{
      modalTitle.textContent = 'Novo FSBO';
      itemForm.reset();
      $('itemId').value = '';
      estadoProspeccaoSelect.value = 'identificado';
      const hoje = new Date().toISOString().slice(0,10);
      $('dataIdentificacao').value = hoje;
      $('consultor').value = $('consultor').value || 'Rui Quelhas';
      currentEditingId = null;
    }

    refreshPdfList();
  }

  function closeModal(){
    modalBackdrop.classList.remove('open');
    currentEditingId = null;
    pdfList.innerHTML = '';
  }

  function collectFormData(){
    let id = $('itemId').value || '';
    if(!id){ id = 'part_' + Date.now(); }

    let dataIdent = $('dataIdentificacao').value || '';

// se j√° existe registo, a dataIdentificacao fica fixa (hist√≥rico)
const existing = state.items.find(x => x.id === id);
if(existing && existing.dataIdentificacao){
  dataIdent = existing.dataIdentificacao;
  $('dataIdentificacao').value = dataIdent;
}

// se √© novo e n√£o tem data, define hoje
if(!dataIdent){
  dataIdent = new Date().toISOString().slice(0,10);
  $('dataIdentificacao').value = dataIdent;
}

    const data = {
      id,
      consultor: consultorSelect.value || '',
      portal: portalSelect.value || '',
      link: $('link').value || '',
      ownerName: $('ownerName').value || '',
      ownerPhone: $('ownerPhone').value || '',
      ownerEmail: $('ownerEmail').value || '',
      estadoProspeccao: estadoProspeccaoSelect.value || 'identificado',
      refAngariacao: $('refAngariacao').value || '',
      dataIdentificacao: dataIdent,
      dataPrimeiroContacto: $('dataPrimeiroContacto').value || '',
      dataUltimaAcao: $('dataUltimaAcao').value || '',
      proximaAcaoData: $('proximaAcaoData').value || '',
      proximaAcaoTipo: $('proximaAcaoTipo').value || '',
      tituloImovel: $('tituloImovel').value || '',
      concelho: $('concelho').value || '',
      freguesia: $('freguesia').value || '',
      zona: $('zona').value || '',
      natureza: $('natureza').value || '',
      tipologia: $('tipologia').value || '',
      precoAnuncio: (function(){
  const v = $('precoAnuncio').value;
  if(v === '' || v == null) return null;
  const n = Number(v);
  return isFinite(n) ? n : null;
})(),
      observacoes: $('observacoes').value || '',
      notasInternas: $('notasInternas').value || ''
    };

    return data;
  }

  /* ============ Filters ============ */
  function loadFilterState(){
    try{
      const raw = localStorage.getItem(FILTERS_STORAGE_KEY);
      if(!raw) return;
      const obj = JSON.parse(raw);
      if(!obj || typeof obj !== 'object') return;

      if(obj.consultor && filterConsultor.querySelector('option[value="'+obj.consultor+'"]')){
        filterConsultor.value = obj.consultor;
      }
      filterPortal.value = obj.portal || '';
      filterEstado.value = obj.estado || '';
      filterSearchText.value = obj.searchText || '';
      filterDataDe.value = obj.de || '';
      filterDataAte.value = obj.ate || '';
      filterShowHidden.checked = !!obj.mostrarInvisiveis;
      filterOnlyHidden.checked = !!obj.soInvisiveis;
    }catch(e){
      console.error('Erro a carregar filtros de FSBO', e);
    }
  }

  function saveFilterStateFromUI(){
    const data = {
      consultor: filterConsultor.value || '',
      portal: filterPortal.value || '',
      estado: filterEstado.value || '',
      searchText: filterSearchText.value || '',
      de: filterDataDe.value || '',
      ate: filterDataAte.value || '',
      mostrarInvisiveis: filterShowHidden.checked,
      soInvisiveis: filterOnlyHidden.checked
    };
    try{ localStorage.setItem(FILTERS_STORAGE_KEY, JSON.stringify(data)); }
    catch(e){ console.error('Erro a guardar filtros de FSBO', e); }
  }

  function applyFilters(items){
    const cons = filterConsultor.value;
    const portal = filterPortal.value;
    const est = filterEstado.value;
    const search = (filterSearchText.value || '').trim().toLowerCase();
    const from = filterDataDe.value;
    const to = filterDataAte.value;
    const showHidden = filterShowHidden.checked;
    const onlyHidden = filterOnlyHidden.checked;

    return items.filter(d=>{
      if(cons && d.consultor !== cons) return false;
      if(portal && d.portal !== portal) return false;
      if(est && d.estadoProspeccao !== est) return false;

      if(onlyHidden){
        if(d.visible !== false) return false;
      }else if(!showHidden && d.visible === false){
        return false;
      }

      if(from && d.dataIdentificacao && d.dataIdentificacao < from) return false;
      if(to && d.dataIdentificacao && d.dataIdentificacao > to) return false;

      if(search){
        const texto = [
          d.tituloImovel, d.concelho, d.freguesia, d.zona,
          d.portal, d.consultor, d.refAngariacao,
          d.ownerName, d.ownerPhone, d.ownerEmail
        ].filter(Boolean).join(' ').toLowerCase();
        if(!texto.includes(search)) return false;
      }
      return true;
    });
  }

  function formatMoney(v){
    const n = parseFloat(String(v).replace(',', '.'));
    if(!isFinite(n)) return '';
    return n.toLocaleString('pt-PT',{style:'currency',currency:'EUR',maximumFractionDigits:0});
  }
    /* ============ Pr√≥xima a√ß√£o: urg√™ncia (cor + ordena√ß√£o) ============ */


  // regras:
  // - vermelho: data <= hoje (atrasada ou hoje)
  // - laranja: faltam 1-3 dias
  // - amarelo: faltam 4-7 dias
  // - sem classe: > 7 dias ou sem data
 

  // chave de ordena√ß√£o:
  // - quem tem pr√≥xima a√ß√£o vem primeiro (mais cedo = mais acima)
  // - atrasados (<= hoje) ficam no topo absoluto
  // - quem n√£o tem data vai para o fim
 
 function getNextActionChip(item){
  const dd = daysDiffFromToday(
    item && item.proximaAcaoData ? item.proximaAcaoData : ''
  );
  if(dd == null) return null;

  if(dd < 0)  return { text: 'ATRASADO', tone: 'due' };
  if(dd === 0) return { text: 'HOJE', tone: 'due' };
  if(dd <= 3)  return { text: dd + ' DIAS', tone: 'soon' };
  if(dd <= 7)  return { text: dd + ' DIAS', tone: 'warn' };
  return null;
}
  /* ============ FSBO ‚Äî Pr√≥xima a√ß√£o: cor + prioridade ============ */
  function toDateOnly(str){
    // Espera "YYYY-MM-DD" (input date). Se inv√°lido, devolve null.
    if(!str) return null;
    const s = String(str).trim();
    const m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if(!m) return null;
    const y = parseInt(m[1],10), mo = parseInt(m[2],10)-1, d = parseInt(m[3],10);
    const dt = new Date(y, mo, d);
    if(!isFinite(dt.getTime())) return null;
    // normalizar para meia-noite local
    dt.setHours(0,0,0,0);
    return dt;
  }

  function daysDiffFromToday(dateStr){
    const dt = toDateOnly(dateStr);
    if(!dt) return null;
    const today = new Date();
    today.setHours(0,0,0,0);
    const ms = dt.getTime() - today.getTime();
    return Math.round(ms / 86400000); // dias
  }

  function getNextActionClass(item){
    // Regras sugeridas:
    // - vermelho: hoje ou atrasado (<= 0)
    // - laranja: 1-3 dias
    // - amarelo: 4-7 dias
    // - sem classe: > 7 dias ou sem data
    const dd = daysDiffFromToday(item && item.proximaAcaoData ? item.proximaAcaoData : '');
    if(dd == null) return '';
    if(dd <= 0) return 'fsbo-overdue';
    if(dd <= 3) return 'fsbo-urgent';
    if(dd <= 7) return 'fsbo-warning';
    return '';
  }

  function getNextActionSortKey(item){
    // Para ordenar no topo por data mais pr√≥xima:
    // - sem data => vai para o fundo (valor grande)
    // - com data => usa timestamp (quanto menor, mais urgente)
    const dt = toDateOnly(item && item.proximaAcaoData ? item.proximaAcaoData : '');
    if(!dt) return Number.POSITIVE_INFINITY;
    return dt.getTime();
  }
  /* ============ Kit FSBO (Gerador) ============ */
  function normalizePhone(phone){
    if(!phone) return '';
    const digits = String(phone).replace(/[^\d+]/g,'');
    // tenta normalizar PT
    if(digits.startsWith('00')) return '+' + digits.slice(2);
    if(digits.startsWith('+')) return digits;
    if(digits.length===9) return '+351' + digits;
    return digits;
  }

  function buildSummaryLine(k, v, link){
    const row = document.createElement('div');
    row.className = 'mini-line';

    const kk = document.createElement('div');
    kk.className = 'mini-k';
    kk.textContent = k;
    row.appendChild(kk);

    const vv = document.createElement('div');
    vv.className = 'mini-v';
    if(link){
      const a = document.createElement('a');
      a.href = link; a.target = '_blank';
      a.textContent = v || link;
      vv.appendChild(a);
    }else{
      vv.textContent = v || '-';
    }
    row.appendChild(vv);
    return row;
  }

  function firstNameFromOwner(name){
    if(!name) return '';
    const parts = String(name).trim().split(/\s+/);
    return parts[0] || '';
  }

  function guessHighlights(item){
    const base = (item.tituloImovel || '') + ' ' + (item.observacoes || '') + ' ' + (item.notasInternas || '');
    const t = base.toLowerCase();
    const hits = [];
    const rules = [
      ['varanda','Varanda/terra√ßo'],['terra√ßo','Varanda/terra√ßo'],['garagem','Garagem'],['box','Garagem/box'],
      ['elevador','Elevador'],['vista','Vista'],['remodel','Remodela√ß√£o'],['renov','Renova√ß√£o'],
      ['metro','Proximidade ao metro'],['praia','Proximidade √† praia'],['parque','Proximidade a parque'],['rio','Proximidade ao rio'],
      ['luz','Luminosidade'],['sul','Exposi√ß√£o solar favor√°vel'],['poente','Exposi√ß√£o solar favor√°vel'],['nascente','Exposi√ß√£o solar favor√°vel'],
      ['suite','Suite'],['logradouro','Logradouro'],['jardim','Jardim'],['piscina','Piscina'],
      ['novo','Im√≥vel recente/novo'],['constru','Constru√ß√£o'],['reabil','Reabilita√ß√£o']
    ];
    rules.forEach(([key,label])=>{
      if(t.includes(key) && !hits.includes(label)) hits.push(label);
    });
    return hits.slice(0,5);
  }
  function cleanText(s){
    return String(s || '').replace(/\s+/g,' ').trim();
  }

  function pickFirstMatch(text, regex){
    const m = String(text||'').match(regex);
    return m ? (m[1] || m[0]) : '';
  }

  function extractFactsFromText(text){
    const t = String(text||'');

    // √Årea: "120 m2", "120m¬≤", "120,5 m2"
    const area = pickFirstMatch(t, /(\d{2,4}(?:[.,]\d{1,2})?)\s*(?:m2|m¬≤)\b/i);

    // Quartos: "T2", "2 quartos"
    const tip = pickFirstMatch(t, /\bT\s?(\d{1,2})(?:\+\d)?\b/i);
    const quartos = pickFirstMatch(t, /\b(\d{1,2})\s*(?:quartos?|qts?)\b/i) || (tip ? tip : '');

    // WC: "2 wc", "2 casas de banho", "2 wcs"
    const wc = pickFirstMatch(t, /\b(\d{1,2})\s*(?:wc|wcs|casa(?:s)?\s*de\s*banho)\b/i);

    // Andar/Piso: "3¬∫ andar", "piso 2", "r√©s-do-ch√£o"
    let andar = pickFirstMatch(t, /\b(\d{1,2})\s*(?:¬∫|o)?\s*(?:andar|piso)\b/i);
    if(!andar){
      const rdc = t.match(/\b(r[√©e]s(?:-|\s)?do(?:-|\s)?ch[a√£]o|rc)\b/i);
      if(rdc) andar = 'R√©s-do-ch√£o';
    }

    // Elevador (sim/n√£o) ‚Äì tenta detectar presen√ßa
    let elevador = '';
    if(/\belevador\b/i.test(t)) elevador = 'Sim';
    if(/\bsem\s+elevador\b/i.test(t)) elevador = 'N√£o';

    return { area, quartos, wc, andar, elevador };
  }

function buildKitResumo(item){
  // =========================
  // RESUMO PREMIUM (Texto)
  // - Melhor espa√ßamento
  // - Buckets adicionais
  // - Deduplica√ß√£o + controlo de tamanho
  // =========================

  const localidade = [item.zona, item.freguesia, item.concelho].filter(Boolean).join(' ¬∑ ');
  const preco = item.precoAnuncio ? formatMoney(item.precoAnuncio) : '';

  // Base para extra√ß√£o de factos (n√£o entra ‚Äúcru‚Äù nos detalhes para evitar duplicados)
  const baseTextForFacts = [
    item.tituloImovel,
    item.tipologia,
    item.zona,
    item.freguesia,
    item.concelho,
    item.observacoes,
    item.notasInternas
  ].filter(Boolean).join('\n');

  const hasAnyText = cleanText(baseTextForFacts).length >= 10;
  const facts = extractFactsFromText(baseTextForFacts);

  // Para ‚ÄúDETALHES ORGANIZADOS‚Äù usamos s√≥ Observa√ß√µes + Notas internas (evita repetir t√≠tulo/localidade)
  const rawDetailsText = [
    item.observacoes,
    item.notasInternas
  ].filter(Boolean).join('\n');

  // -------------------------
  // Helpers (locais, para n√£o mexer no resto do ficheiro)
  // -------------------------
  function normKey(s){
    return String(s||'')
      .toLowerCase()
      .normalize('NFD').replace(/[\u0300-\u036f]/g,'') // remove acentos
      .replace(/[^\w\s]/g,' ')                        // remove pontua√ß√£o
      .replace(/\s+/g,' ')
      .trim();
  }

  function splitToBullets(text){
    const t = String(text||'').replace(/\r/g,'\n');

    // quebra por linhas e tamb√©m por separadores ‚Äú - ‚Äù frequentes em an√∫ncios
    const raw = t
      .split('\n')
      .flatMap(line => line.split(/\s+-\s+/g))
      .map(s => cleanText(s))
      .filter(Boolean);

    // limpa ‚Äú---‚Äù, ‚Äú--‚Äù, etc.
    return raw
      .map(s => s.replace(/^-{2,}\s*/g,'').trim())
      .filter(s => s && s !== '‚Äî' && s !== '-' && s !== '--');
  }

  function dedupeKeepOrder(arr){
    const seen = new Set();
    const out = [];
    for(const x of arr){
      const k = normKey(x);
      if(!k) continue;
      if(seen.has(k)) continue;
      seen.add(k);
      out.push(x);
    }
    return out;
  }

  // remove duplica√ß√µes ‚ÄúA‚Äù vs ‚ÄúClasse energ√©tica: A‚Äù e similares
  function normalizeEnergyLines(lines){
    let energy = '';
    const keep = [];

    for(const line of lines){
      const k = normKey(line);

      // capturar classe energ√©tica
      let m = String(line).match(/\bclasse?\s+energ[e√©]tica[:\s]*([A-G][\+\-]{0,2})\b/i);
      if(!m) m = String(line).match(/\bclassifica[c√ß][a√£]o\s+energ[e√©]tica[:\s]*([A-G][\+\-]{0,2})\b/i);

      if(m && m[1]){
        energy = m[1].toUpperCase();
        continue; // n√£o guarda a linha original, vamos injetar uma vers√£o ‚Äúlimpa‚Äù
      }

      // tamb√©m apanha ‚ÄúCertificado energ√©tico ‚Ä¶ Classe ‚Ä¶‚Äù
      const m2 = String(line).match(/\bcertificado\s+energ[e√©]tico\b/i);
      if(m2) continue;

      keep.push(line);
    }

    if(energy){
      keep.push('Classe energ√©tica: ' + energy);
    }
    return keep;
  }

  function bucketOf(line){
    const k = normKey(line);

    // Rentabilidade / Investimento
    if(/\b(rentabil|yield|invest|arrend|alugar|airbnb|alojamento local|al)\b/.test(k)) return 'Rentabilidade / Investimento';

    // Condom√≠nio / Amenities
    if(/\b(condominio|quota|piscina|ginasio|spa|porteiro|seguranca 24|salao|jardim comum|terra[c√ß]o comum|areas comuns)\b/.test(k)) return 'Condom√≠nio / Amenities';

    // Dom√≥tica / Seguran√ßa
    if(/\b(domotic|alarme|videoporteiro|cctv|seguranc|porta blindada|fechadura|biometr|detetor|incendio)\b/.test(k)) return 'Dom√≥tica / Seguran√ßa';

    // Vistas / Exposi√ß√£o solar
    if(/\b(vista|rio|mar|exposi[c√ß]ao solar|nascente|poente|sul|norte|luminos|sol|varanda|terra[c√ß]o)\b/.test(k)) return 'Vistas / Exposi√ß√£o solar';

    // Acabamentos & Materiais
    if(/\b(acabament|materia|soalho|madeira|carvalho|marmore|granito|ceramic|porcelan|lacad|caixilh|alumin|vidro duplo|estores eletr|armarios embutidos|roupeiro)\b/.test(k)) return 'Acabamentos & Materiais';

    // Cozinha & Equipamentos
    if(/\b(cozinha|placa|forno|exaustor|frigorifico|maquina lavar|maquina de lavar|secar|bosch|siemens|aeg|miele|equipad)\b/.test(k)) return 'Cozinha & Equipamentos';

    // Conforto & Climatiza√ß√£o
    if(/\b(ar condicionado|ac|bomba de calor|aquecimento|piso radiante|recuperador|ventil|climatiza|isolament)\b/.test(k)) return 'Conforto & Climatiza√ß√£o';

    // Estacionamento & Arrumos
    if(/\b(garagem|box|lugar|estacion|carregamento|veiculo eletric|arrumo|arrecada[c√ß]ao|cave)\b/.test(k)) return 'Estacionamento & Arrumos';

    // Edif√≠cio
    if(/\b(elevador|andar|piso|predio|edificio|rc|res do chao|ultimo piso|duplex)\b/.test(k)) return 'Edif√≠cio & Acessos';

    // Estado & Reabilita√ß√£o
    if(/\b(novo|segunda mao|bom estado|remodel|renov|reabilit|construcao|acabado|em obra)\b/.test(k)) return 'Estado & Reabilita√ß√£o';

    // Efici√™ncia Energ√©tica
    if(/\b(energ|classe)\b/.test(k)) return 'Efici√™ncia Energ√©tica';

    return 'Outros detalhes';
  }

  function limitBucket(lines, maxItems){
    if(lines.length <= maxItems) return lines;
    const cut = lines.slice(0, maxItems);
    cut.push(`(‚Ä¶ +${lines.length - maxItems} itens)`);
    return cut;
  }

  // -------------------------
  // Highlights (como j√° tinhas)
  // -------------------------
  const highlights = guessHighlights(item);
  const highlightsBlock = highlights.length
    ? ('‚Ä¢ ' + highlights.join('\n‚Ä¢ '))
    : '‚Ä¢ (Sem caracter√≠sticas destacadas detectadas no texto)';

  // -------------------------
  // DETALHES ORGANIZADOS (bullets -> buckets)
  // -------------------------
  let detailLines = splitToBullets(rawDetailsText);

  // dedupe + normaliza√ß√µes
  detailLines = dedupeKeepOrder(detailLines);
  detailLines = normalizeEnergyLines(detailLines);
  detailLines = dedupeKeepOrder(detailLines);

  // agrupar por bucket
  const buckets = {};
  for(const ln of detailLines){
    const b = bucketOf(ln);
    if(!buckets[b]) buckets[b] = [];
    buckets[b].push(ln);
  }

  // ordem ‚Äúpremium‚Äù (o que interessa primeiro)
  const bucketOrder = [
    'Estado & Reabilita√ß√£o',
    'Acabamentos & Materiais',
    'Cozinha & Equipamentos',
    'Conforto & Climatiza√ß√£o',
    'Vistas / Exposi√ß√£o solar',
    'Edif√≠cio & Acessos',
    'Estacionamento & Arrumos',
    'Condom√≠nio / Amenities',
    'Dom√≥tica / Seguran√ßa',
    'Efici√™ncia Energ√©tica',
    'Rentabilidade / Investimento',
    'Outros detalhes'
  ];

  // -------------------------
  // Montagem final (com ESPA√áAMENTO)
  // -------------------------
  const lines = [];
  lines.push('RESUMO PREMIUM DO AN√öNCIO (FSBO)');
  lines.push('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
  lines.push(`‚ñå Im√≥vel: ${cleanText(item.tituloImovel) || '‚Äî'}`);
  if(preco)      lines.push(`‚ñå Pre√ßo: ${preco}`);
  if(localidade) lines.push(`‚ñå Localiza√ß√£o: ${localidade}`);
  if(cleanText(item.tipologia)) lines.push(`‚ñå Tipologia: ${cleanText(item.tipologia)}`);

  // Espa√ßo
  lines.push('');
  lines.push('üü´  FICHA R√ÅPIDA');
  lines.push('‚Äî');
  if(facts.area)     lines.push(`‚Ä¢ √Årea: ${facts.area} m¬≤`);
  if(facts.quartos)  lines.push(`‚Ä¢ Quartos: ${facts.quartos}`);
  if(facts.wc)       lines.push(`‚Ä¢ Casas de banho: ${facts.wc}`);
  if(facts.andar)    lines.push(`‚Ä¢ Andar/Piso: ${facts.andar}`);
  if(facts.elevador) lines.push(`‚Ä¢ Elevador: ${facts.elevador}`);
  if(!facts.area && !facts.quartos && !facts.wc && !facts.andar && !facts.elevador){
    lines.push('‚Ä¢ (Sem dados t√©cnicos extra√≠dos automaticamente)');
  }

  lines.push('');
  lines.push('üü´  PONTOS-CHAVE');
  lines.push('‚Äî');
  lines.push(highlightsBlock);

  lines.push('');
  lines.push('üü´  DETALHES DO AN√öNCIO (ORGANIZADO)');
  lines.push('‚Äî');

  // render buckets com espa√ßamento claro
  let renderedAnyBucket = false;

  bucketOrder.forEach(title=>{
    const arr = buckets[title] || [];
    const cleanArr = dedupeKeepOrder(arr).filter(Boolean);

    if(!cleanArr.length) return;

    renderedAnyBucket = true;

    // Limites por bucket (evita resumo gigante)
    const limited = limitBucket(cleanArr, 6);

    // Espa√ßo entre buckets
    lines.push('');
    lines.push(`‚¨õ ${title.toUpperCase()}`);
    lines.push('‚Ä¢ ' + limited.map(x => String(x)).join('\n‚Ä¢ '));
  });

  if(!renderedAnyBucket){
    lines.push('');
    lines.push('‚Ä¢ (Sem detalhes adicionais detetados em Observa√ß√µes/Notas internas)');
  }

  if(!hasAnyText){
    lines.push('');
    lines.push('Nota: Para um resumo mais completo, preencha ‚ÄúObserva√ß√µes‚Äù e/ou ‚ÄúNotas internas‚Äù no registo.');
  }

  lines.push('');
  lines.push('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
  lines.push('Fim do resumo');
  lines.push('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');

  return lines.join('\n');
}
  
  function generateWhatsapp(item, fetchedTitle){
    const owner = item.ownerName ? item.ownerName.trim() : '';
    const greetName = owner ? (' ' + firstNameFromOwner(owner)) : '';
    const title = fetchedTitle || item.tituloImovel || (item.tipologia ? (item.tipologia + ' ' + (item.concelho||'').trim()) : 'o seu im√≥vel');
    const zone = [item.zona, item.freguesia, item.concelho].filter(Boolean).join(' ¬∑ ');
    const price = item.precoAnuncio ? formatMoney(item.precoAnuncio) : '';
    const highlights = guessHighlights(item);
    const hLine = highlights.length ? ('\n‚Ä¢ ' + highlights.join('\n‚Ä¢ ')) : '';

    return (
`Boa tarde${greetName}.

O meu nome √© ${item.consultor || 'Rui Quelhas'}, da Garvetur Luxury Porto. Vi o an√∫ncio${item.portal ? ' no ' + item.portal : ''} relativo a ‚Äú${title}‚Äù${zone ? ' ('+zone+')' : ''}${price ? ' ‚Äî ' + price : ''}.

Trabalho diariamente com compradores qualificados para esta zona e gostaria de perceber se faz sentido ajud√°-lo(a) a vender com mais seguran√ßa e melhor posicionamento no mercado.

Em 10 minutos consigo:
1) validar o enquadramento de pre√ßo vs. mercado,
2) sugerir melhorias de apresenta√ß√£o para aumentar procura,
3) explicar um plano de venda com triagem de compradores e acompanhamento jur√≠dico.

Podemos agendar uma chamada curta hoje ao final do dia ou amanh√£ de manh√£?`
    );
  }
  /* ============ FSBO ‚Äî Standard (Prompt interno + modos WhatsApp) ============ */

  // Prompt/base ‚Äî guardado no m√≥dulo para consist√™ncia interna
  const FSBO_PROMPT_STANDARD = [
    "Especialista de vendas imobili√°rias e conversa√ß√£o WhatsApp.",
    "Consultor s√©nior (+10 anos) em imobili√°rio de luxo.",
    "Scripts claros, humanos e execut√°veis, para abordagem a frio a propriet√°rios (FSBO).",
    "Linguagem simples, direta e profissional. Sem clich√©s. Sem frases gen√©ricas.",
    "Objetivo: transformar WhatsApp num processo previs√≠vel, focado em conversa√ß√£o e pr√≥ximo passo."
  ].join(" ");

  // Mapear estado -> modo de WhatsApp
  function getWhatsappModeByEstado(item){
    const est = (item && item.estadoProspeccao) ? String(item.estadoProspeccao) : 'identificado';

    if(est === 'identificado') return 'first_contact';
    if(est === 'contacto-feito') return 'follow_up_1';
    if(est === 'follow-up') return 'follow_up_2';
    if(est === 'visita') return 'visit_confirm';
    if(est === 'proposta-enviada') return 'proposal_follow';
    if(est === 'angariado') return 'post_signed';
    if(est === 'descartado') return 'soft_close';
    return 'first_contact';
  }

  function buildContextBlock(item, fetchedTitle){
    const owner = item.ownerName ? item.ownerName.trim() : '';
    const greetName = owner ? (' ' + firstNameFromOwner(owner)) : '';
    const title = fetchedTitle || item.tituloImovel || (item.tipologia ? (item.tipologia + ' ' + (item.concelho||'').trim()) : 'o seu im√≥vel');
    const zone = [item.zona, item.freguesia, item.concelho].filter(Boolean).join(' ¬∑ ');
    const price = item.precoAnuncio ? formatMoney(item.precoAnuncio) : '';
    const portal = item.portal ? (' no ' + item.portal) : '';

    const line1 = `Boa tarde${greetName}.`;
    const line2 = `O meu nome √© ${item.consultor || 'Rui Quelhas'}, da Garvetur Luxury Porto. Vi o an√∫ncio${portal} relativo a ‚Äú${title}‚Äù${zone ? ' ('+zone+')' : ''}${price ? ' ‚Äî ' + price : ''}.`;

    return [line1, '', line2].join('\n');
  }

  function buildValueBlock(item){
  const highlights = guessHighlights(item);
  const h = highlights.length ? highlights.slice(0,3) : [];

  const parts = [];

  parts.push(
    "Analisei o seu an√∫ncio com aten√ß√£o porque corresponde exatamente ao tipo de im√≥vel que os compradores est√£o hoje a procurar nesta zona."
  );

  if(h.length){
    parts.push(
      `H√° 2‚Äì3 detalhes que fazem muita diferen√ßa na procura e que, bem ajustados, costumam acelerar visitas e proteger o valor (ex.: ${h.join(', ')}).`
    );
  }

  parts.push(
    "Na maioria dos casos, o desafio n√£o √© a falta de interesse, mas sim o posicionamento inicial ‚Äî quando falha, o im√≥vel come√ßa a negociar contra o propriet√°rio."
  );

  parts.push(
    "Se fizer sentido, posso dar-lhe um enquadramento objetivo em 10 minutos: pre√ßo real vs. mercado, pontos de melhoria imediata e a forma mais segura de conduzir contactos e negocia√ß√£o."
  );

  return parts.join('\n');
}

  function buildQuestionBlock(item, mode){
    // pergunta curta que obriga a resposta (sim/n√£o ou op√ß√£o A/B)
    if(mode === 'visit_confirm'){
      return "Para alinharmos a visita: confirma-me por favor se prefere manh√£ ou fim do dia?";
    }
    if(mode === 'proposal_follow'){
      return "Chegou a ver a proposta? Faz sentido ajustarmos algum ponto antes de avan√ßar?";
    }
    if(mode === 'post_signed'){
      return "Quer que trate j√° do pr√≥ximo passo (fotografia/briefing) para colocarmos no mercado com for√ßa desde o primeiro dia?";
    }
    if(mode === 'soft_close'){
      return "Se n√£o for prioridade agora, posso s√≥ deixar-lhe uma avalia√ß√£o r√°pida (sem compromisso) para refer√™ncia futura?";
    }
    // follow-ups
    if(mode === 'follow_up_1'){
      return "O im√≥vel continua dispon√≠vel? Se sim, posso partilhar-lhe um enquadramento de pre√ßo em 2‚Äì3 linhas.";
    }
    if(mode === 'follow_up_2'){
      return "Teve contactos/visitas desde o an√∫ncio? Qual foi o feedback mais comum?";
    }
    // first contact
    return "O im√≥vel continua dispon√≠vel e est√° a considerar apoio profissional para vender com melhor resultado?";
  }

  function buildCtaBlock(item, mode){
    // CTA sempre com escolha bin√°ria (reduz fric√ß√£o)
    if(mode === 'visit_confirm'){
      return "Se me disser a sua prefer√™ncia (manh√£ / fim do dia), ajusto j√° na agenda.";
    }
    if(mode === 'proposal_follow'){
      return "Podemos falar 8‚Äì10 minutos hoje ao final do dia ou amanh√£ de manh√£?";
    }
    if(mode === 'follow_up_1' || mode === 'follow_up_2'){
      return "Prefere uma chamada r√°pida hoje ao final do dia ou amanh√£ de manh√£?";
    }
    if(mode === 'post_signed'){
      return "Diga-me um hor√°rio e eu envio-lhe j√° o plano de a√ß√£o (checklist + timings).";
    }
    if(mode === 'soft_close'){
      return "Se concordar, diga-me s√≥ a melhor hora para uma chamada curta (10 min) e eu trato do resto.";
    }
    return "Podemos agendar uma chamada curta hoje ao final do dia ou amanh√£ de manh√£?";
  }

  function buildWhatsappMessage(item, fetchedTitle){
    const mode = getWhatsappModeByEstado(item);

    const blocks = [];
    blocks.push(buildContextBlock(item, fetchedTitle));
    blocks.push('');
    blocks.push(buildValueBlock(item));
    blocks.push('');
    blocks.push(buildQuestionBlock(item, mode));
    blocks.push(buildCtaBlock(item, mode));

    const msg = blocks.join('\n').trim();
return `‚úÖ [GPP-SMART]\n${msg}`;
  }

  // Novo gerador ‚Äúsmart‚Äù (mant√©m fallback para o atual)
function generateWhatsappSmart(item, fetchedTitle){
  try{
    void FSBO_PROMPT_STANDARD;
    // buildWhatsappMessage() j√° inclui o prefixo ‚úÖ [GPP-SMART]
    return buildWhatsappMessage(item, fetchedTitle);
  }catch(e){
    console.error('Erro em generateWhatsappSmart ‚Äî fallback para generateWhatsapp', e);
    return generateWhatsapp(item, fetchedTitle);
  }
}
  function buildObjectionReply(objectionKey, item, fetchedTitle){
  const owner = item.ownerName ? item.ownerName.trim() : '';
  const greetName = owner ? (' ' + firstNameFromOwner(owner)) : '';
  const title = fetchedTitle || item.tituloImovel || (item.tipologia ? (item.tipologia + ' ' + (item.concelho||'').trim()) : 'o seu im√≥vel');
  const zone = [item.zona, item.freguesia, item.concelho].filter(Boolean).join(' ¬∑ ');
  const price = item.precoAnuncio ? formatMoney(item.precoAnuncio) : '';
  const portal = item.portal ? (' no ' + item.portal) : '';

  const header = `‚úÖ [GPP-SMART]`;
  const intro = `Boa tarde${greetName}.`;
  const ref = `Vi o an√∫ncio${portal} relativo a ‚Äú${title}‚Äù${zone ? ' ('+zone+')' : ''}${price ? ' ‚Äî ' + price : ''}.`;

  let body = '';
  let cta  = '';

  if(objectionKey === 'solo'){
    body =
      "Percebo perfeitamente ‚Äî muitos propriet√°rios come√ßam por vender sozinhos.\n" +
      "O ponto cr√≠tico costuma ser o mesmo: ou se perde margem em negocia√ß√£o, ou perde-se tempo com leads n√£o qualificadas.\n" +
      "Se fizer sentido, posso ajud√°-lo(a) apenas com um enquadramento r√°pido de pre√ßo e posicionamento (sem compromisso).";
    cta = "Quer que lhe diga em 2‚Äì3 linhas se o pre√ßo est√° alinhado com o mercado, ou prefere uma chamada de 10 minutos hoje ao final do dia?";
  }else if(objectionKey === 'many'){
    body =
      "Compreendo ‚Äî e faz bem em evitar ‚Äòmais do mesmo‚Äô.\n" +
      "A diferen√ßa n√£o √© estar em mais sites; √© ter triagem real, estrat√©gia de pre√ßo e condu√ß√£o de negocia√ß√£o com controlo documental.\n" +
      "Se me disser o que j√° foi feito (fotos, visitas, feedback), eu digo-lhe onde est√° a fuga de valor e o ajuste mais r√°pido.";
    cta = "Podemos falar 10 minutos hoje ao final do dia ou amanh√£ de manh√£ para eu lhe dar um diagn√≥stico objetivo?";
  }else if(objectionKey === 'commission'){
    body =
      "Percebo a quest√£o da comiss√£o ‚Äî √© natural.\n" +
      "Na pr√°tica, o maior custo tende a ser o desconto final e o tempo no mercado quando o an√∫ncio est√° mal posicionado.\n" +
      "O meu foco √© maximizar o valor l√≠quido e reduzir risco: triagem, negocia√ß√£o e acompanhamento documental do in√≠cio ao fim.";
    cta = "Quer que lhe fa√ßa uma simula√ß√£o simples (valor l√≠quido esperado) e comparamos ‚Äòvenda direta‚Äô vs ‚Äòplano com triagem‚Äô em 10 minutos?";
  }else if(objectionKey === 'exclusive'){
    body =
      "Percebo ‚Äî ‚Äòexclusivo‚Äô s√≥ faz sentido se trouxer controlo e responsabilidade.\n" +
      "Sem exclusivo, normalmente perde-se coer√™ncia (pre√ßo, comunica√ß√£o, visitas) e isso abre espa√ßo a descontos.\n" +
      "Podemos fazer um exclusivo com prazo e objetivos claros, para manter a sua seguran√ßa e a nossa performance.";
    cta = "Aceita um exclusivo de 30 dias, com plano e metas, e no fim decide com total liberdade?";
  }else{
    body = "Percebi. Diga-me s√≥ qual √© a sua principal preocupa√ß√£o para eu ser o mais objetivo poss√≠vel.";
    cta = "Prefere uma chamada curta hoje ao final do dia ou amanh√£ de manh√£?";
  }

  return [header, intro, '', ref, '', body, '', cta].join('\n').trim();
}
  function buildEmailObjectionReply(objectionKey, item, fetchedTitle){
  const owner = item.ownerName || 'Propriet√°rio(a)';
  const title = fetchedTitle || item.tituloImovel || 'o seu im√≥vel';
  const zone = [item.zona, item.freguesia, item.concelho].filter(Boolean).join(' ¬∑ ');
  const price = item.precoAnuncio ? formatMoney(item.precoAnuncio) : '';

  const subjBase = `Enquadramento e estrat√©gia ‚Äî ${title}${zone ? ' | ' + zone : ''}`;
  let subject = subjBase;

  let body = '';
  if(objectionKey === 'many'){
    subject = `Diferencia√ß√£o e controlo do processo ‚Äî ${title}${zone ? ' | ' + zone : ''}`;
    body =
`Caro(a) ${owner},

Compreendo perfeitamente que j√° esteja a falar com outras imobili√°rias. A quest√£o raramente √© ‚Äúter mais contactos‚Äù; √© garantir controlo do processo e prote√ß√£o do valor.

Na pr√°tica, √© aqui que normalmente se perde margem:
‚Ä¢ triagem fraca (muitos curiosos / poucos compradores reais),
‚Ä¢ mensagem e pre√ßo inconsistentes,
‚Ä¢ negocia√ß√£o sem estrat√©gia e sem controlo documental.

Se fizer sentido, proponho uma chamada curta de 10 minutos para lhe dar um diagn√≥stico objetivo: o que est√° bem, o que est√° a travar, e qual o ajuste mais r√°pido para proteger o valor.

Com os melhores cumprimentos,
Rui Quelhas
Director Comercial ‚Äî Garvetur Luxury Porto`;
  }else if(objectionKey === 'commission'){
    subject = `Valor l√≠quido e risco ‚Äî ${title}${zone ? ' | ' + zone : ''}`;
    body =
`Caro(a) ${owner},

Percebo a quest√£o da comiss√£o ‚Äî √© um ponto leg√≠timo. O que importa, no final, √© o valor l√≠quido e a seguran√ßa do processo.

Nos casos em que acompanho, a diferen√ßa tende a surgir em tr√™s √°reas:
‚Ä¢ desconto final (negocia√ß√£o conduzida sem estrat√©gia),
‚Ä¢ tempo em mercado (posicionamento inicial desalinhado),
‚Ä¢ risco (documentos, reservas, condi√ß√µes e timings).

Se desejar, fa√ßo-lhe uma simula√ß√£o simples e objetiva (cen√°rios de valor l√≠quido) e comparamos venda direta vs. plano com triagem e negocia√ß√£o estruturada.

Podemos falar 10 minutos hoje ao final do dia ou amanh√£ de manh√£?

Com os melhores cumprimentos,
Rui Quelhas
Director Comercial ‚Äî Garvetur Luxury Porto`;
  }else if(objectionKey === 'exclusive'){
    subject = `Exclusivo com m√©tricas e prazo ‚Äî ${title}${zone ? ' | ' + zone : ''}`;
    body =
`Caro(a) ${owner},

Compreendo a reserva relativamente ao exclusivo. ‚ÄúExclusivo‚Äù s√≥ faz sentido quando existe responsabilidade, m√©tricas e um plano claro.

A minha proposta (quando faz sentido) √© simples:
‚Ä¢ prazo curto (ex.: 30 dias),
‚Ä¢ plano de a√ß√£o definido (marketing + triagem + visitas),
‚Ä¢ metas objetivas (procura, visitas, feedback e ajuste),
‚Ä¢ decis√£o livre no final do per√≠odo.

Se considerar √∫til, explico-lhe a diferen√ßa pr√°tica entre ‚Äúsem exclusivo‚Äù e ‚Äúexclusivo com controlo‚Äù numa chamada de 10 minutos.

Com os melhores cumprimentos,
Rui Quelhas
Director Comercial ‚Äî Garvetur Luxury Porto`;
  }else{
    body = buildEmailObjectionReply('many', item, fetchedTitle);
  }

  return `Assunto: ${subject}\n\n${body}`;
}
  function generateCallScript(item, fetchedTitle){
  const owner = item.ownerName || '';
  const title = fetchedTitle || item.tituloImovel || 'o im√≥vel';
  const zone = [item.zona, item.freguesia, item.concelho].filter(Boolean).join(' ¬∑ ');

  return (
`Introdu√ß√£o
‚ÄúBom dia/Boa tarde, falo com o(a) ${owner || 'propriet√°rio(a)'}?
Daqui fala o Rui Quelhas, Director Comercial da Garvetur Luxury Porto.‚Äù

Permiss√£o
‚ÄúEstou a ligar-lhe muito rapidamente porque vi o an√∫ncio do ${title}${zone ? ' em ' + zone : ''}. √â um bom momento para falarmos 30 segundos?‚Äù

Contexto
‚ÄúO motivo do contacto n√£o √© para lhe vender nada agora, mas porque este tipo de im√≥vel est√° exatamente dentro da procura ativa que acompanhamos nesta zona.‚Äù

Valor
‚ÄúO que costumo fazer nestes casos √© ajudar os propriet√°rios a perceber se o im√≥vel est√° corretamente posicionado desde o in√≠cio ‚Äî porque quando isso n√£o acontece, a negocia√ß√£o come√ßa a jogar contra o propriet√°rio.‚Äù

Fecho suave
‚ÄúSe fizer sentido para si, posso explicar-lhe isto melhor numa chamada curta de 10 minutos, sem qualquer compromisso. Prefere hoje ao final do dia ou amanh√£?‚Äù

Notas:
‚Ä¢ Se obje√ß√£o ‚Üí ouvir, validar, n√£o contrariar
‚Ä¢ Nunca discutir comiss√£o nesta chamada
‚Ä¢ Objetivo √© apenas marcar a conversa seguinte`
  );
}
 function generateEmail(item, fetchedTitle){
  const owner = item.ownerName || '';
  const title = fetchedTitle || item.tituloImovel || 'o seu im√≥vel';
  const zone = [item.zona, item.freguesia, item.concelho].filter(Boolean).join(' ¬∑ ');
  const price = item.precoAnuncio ? formatMoney(item.precoAnuncio) : '';

  return (
`Assunto: Enquadramento de mercado ‚Äî ${title}${zone ? ' | ' + zone : ''}

Caro(a) ${owner || 'Propriet√°rio(a)'},

O meu nome √© Rui Quelhas, Director Comercial da Garvetur Luxury Porto.

Analisei com aten√ß√£o o an√∫ncio do seu im√≥vel${zone ? ' localizado em ' + zone : ''}${price ? ', atualmente anunciado por ' + price : ''}, por corresponder exatamente ao perfil de procura ativa que acompanhamos nesta zona.

Na pr√°tica, o maior risco nas vendas diretas n√£o √© a falta de interesse, mas sim o posicionamento inicial ‚Äî quando n√£o est√° totalmente ajustado ao mercado, o im√≥vel tende a perder for√ßa negocial ao longo do tempo.

Trabalho diariamente com propriet√°rios que come√ßaram por vender por conta pr√≥pria e que me procuraram para:
‚Ä¢ validar o enquadramento real de pre√ßo,
‚Ä¢ identificar pontos de melhoria na apresenta√ß√£o,
‚Ä¢ estruturar um processo de venda seguro, com filtragem de compradores e acompanhamento jur√≠dico.

Caso considere √∫til, terei todo o gosto em partilhar consigo uma leitura objetiva do seu im√≥vel numa breve chamada de 10 minutos, sem qualquer compromisso.

Com os melhores cumprimentos,

Rui Quelhas  
Director Comercial  
Garvetur Luxury Porto`
  );
}
/* BEGIN: Follow-up 48h (WA + Email) */
function addDaysToISO(dateISO, days){
  const dt = toDateOnly(dateISO);
  if(!dt) return '';
  dt.setDate(dt.getDate() + days);
  return dt.toISOString().slice(0,10);
}

function generateWhatsappFollowup48h(item, fetchedTitle){
  const owner = item.ownerName ? item.ownerName.trim() : '';
  const greetName = owner ? (' ' + firstNameFromOwner(owner)) : '';
  const title = fetchedTitle || item.tituloImovel || (item.tipologia ? (item.tipologia + ' ' + (item.concelho||'').trim()) : 'o seu im√≥vel');
  const zone = [item.zona, item.freguesia, item.concelho].filter(Boolean).join(' ¬∑ ');
  const price = item.precoAnuncio ? formatMoney(item.precoAnuncio) : '';

  return (
`‚úÖ [GPP-FOLLOWUP-48H]
Boa tarde${greetName}.

Daqui fala o ${item.consultor || 'Rui Quelhas'} (Garvetur Luxury Porto). Volto a contactar apenas para fechar o ponto relativamente ao an√∫ncio ‚Äú${title}‚Äù${zone ? ' ('+zone+')' : ''}${price ? ' ‚Äî ' + price : ''}.

O im√≥vel continua dispon√≠vel?

Se sim, posso enviar-lhe uma leitura objetiva do enquadramento de pre√ßo e 2‚Äì3 ajustes simples para aumentar procura (leva 2 minutos por mensagem).`
  );
}

function generateEmailFollowup48h(item, fetchedTitle){
  const owner = item.ownerName || 'Propriet√°rio(a)';
  const title = fetchedTitle || item.tituloImovel || 'o seu im√≥vel';
  const zone = [item.zona, item.freguesia, item.concelho].filter(Boolean).join(' ¬∑ ');
  const price = item.precoAnuncio ? formatMoney(item.precoAnuncio) : '';

  return (
`Assunto: Seguimento ‚Äî ${title}${zone ? ' | ' + zone : ''}

Caro(a) ${owner},

Da minha parte, deixo apenas um seguimento r√°pido relativamente ao seu an√∫ncio${zone ? ' em ' + zone : ''}${price ? ' (pre√ßo: ' + price + ')' : ''}.

O im√≥vel continua dispon√≠vel?  
Se sim, posso partilhar consigo:
‚Ä¢ enquadramento objetivo de pre√ßo vs. mercado, e  
‚Ä¢ 2‚Äì3 melhorias imediatas no an√∫ncio para aumentar procura e proteger o valor.

Caso seja conveniente, podemos falar 8‚Äì10 minutos hoje ao final do dia ou amanh√£ de manh√£.

Com os melhores cumprimentos,

Rui Quelhas  
Director Comercial  
Garvetur Luxury Porto`
  );
}
/* END: Follow-up 48h (WA + Email) */
  function generateSwot(item, fetchedTitle){
    const title = fetchedTitle || item.tituloImovel || 'Im√≥vel';
    const zone = [item.zona, item.freguesia, item.concelho].filter(Boolean).join(' ¬∑ ');
    const price = item.precoAnuncio ? formatMoney(item.precoAnuncio) : '';
    const highlights = guessHighlights(item);

    const strengths = [
      (zone ? 'Localiza√ß√£o: ' + zone : null),
      (highlights.length ? ('Caracter√≠sticas: ' + highlights.join(', ')) : null),
      (price ? ('Pre√ßo anunciado: ' + price + ' (a validar vs. mercado)') : 'Pre√ßo: a validar vs. mercado'),
      'Potencial de apresenta√ß√£o/valoriza√ß√£o com marketing profissional'
    ].filter(Boolean);

    const weaknesses = [
      'Informa√ß√£o incompleta (dependente do an√∫ncio/visita)',
      'Risco de desalinhamento de pre√ßo vs. concorr√™ncia',
      'Poss√≠vel fraca qualifica√ß√£o de leads (quando vendido por particular)'
    ];

    const opportunities = [
      'Reposicionamento do an√∫ncio (copy, fotos, targeting) para acelerar procura',
      'Estrat√©gia de pre√ßo e negocia√ß√£o para maximizar valor l√≠quido',
      'Acesso a base de compradores e parceiros (network Garvetur)',
      'Cria√ß√£o de urg√™ncia/comparativos com concorr√™ncia na zona'
    ];

    const threats = [
      'Concorr√™ncia direta de im√≥veis similares (press√£o para desconto)',
      'Mudan√ßas no contexto de cr√©dito/taxa (sensibilidade do comprador)',
      'Exposi√ß√£o prolongada do an√∫ncio (efeito ‚Äúcansa√ßo‚Äù do mercado)',
      'Negocia√ß√£o direta sem mitiga√ß√£o de risco documental/jur√≠dico'
    ];

    return (
`SWOT ‚Äî ${title}${zone ? ' | ' + zone : ''}

FOR√áAS
- ${strengths.join('\n- ')}

FRAQUEZAS
- ${weaknesses.join('\n- ')}

OPORTUNIDADES
- ${opportunities.join('\n- ')}

AMEA√áAS
- ${threats.join('\n- ')}

Notas:
- Validar: tipologia real, √°reas, estado de conserva√ß√£o, orienta√ß√£o solar, condom√≠nio, documenta√ß√£o (caderneta, certid√£o, licen√ßa, CE).`
    );
  }

  async function tryFetchTitleFromLink(url){
    lastFetchedTitle = null;
    if(!url) return { ok:false, title:null, note:'Sem link.' };

    // tentativa "best effort" (pode falhar por CORS)
    try{
      const res = await fetch(url, { method:'GET', mode:'cors' });
      if(!res.ok) throw new Error('HTTP ' + res.status);
      const html = await res.text();
      const m1 = html.match(/<title[^>]*>([^<]{1,200})<\/title>/i);
      const title = m1 ? m1[1].replace(/\s+/g,' ').trim() : null;
      lastFetchedTitle = title;
      return { ok:!!title, title, note: title ? 'T√≠tulo lido do link.' : 'N√£o foi poss√≠vel extrair <title>.' };
    }catch(e){
      return { ok:false, title:null, note:'Leitura autom√°tica bloqueada pelo portal (normal). A gerar com base no registo.' };
    }
  }

  async function openKit(item){
    currentKitItem = item;
    kitBackdrop.classList.add('open');
    kitTitle.textContent = 'Kit FSBO ‚Äî ' + (item.tituloImovel || item.tipologia || 'Registo');

    kitSummary.innerHTML = '';
    kitSummary.appendChild(buildSummaryLine('Propriet.', item.ownerName || '-', null));
    kitSummary.appendChild(buildSummaryLine('M√≥vel', item.ownerPhone || '-', null));
    kitSummary.appendChild(buildSummaryLine('Email', item.ownerEmail || '-', null));
    kitSummary.appendChild(buildSummaryLine('Portal', item.portal || '-', null));
    kitSummary.appendChild(buildSummaryLine('Estado', item.estadoProspeccao || '-', null));
    kitSummary.appendChild(buildSummaryLine('Pre√ßo', item.precoAnuncio ? formatMoney(item.precoAnuncio) : '-', null));
    kitSummary.appendChild(buildSummaryLine('Zona', [item.zona,item.freguesia,item.concelho].filter(Boolean).join(' ¬∑ ') || '-', null));
    kitSummary.appendChild(buildSummaryLine('Link', item.link ? 'Abrir an√∫ncio' : '-', item.link || null));

    const fetchInfo = await tryFetchTitleFromLink(item.link || '');
    kitFetchNote.textContent = fetchInfo.note || '';

    const t = fetchInfo.title || null;
   kitWhatsappMainMessage = generateWhatsappSmart(item, t);
kitWhatsapp.value = kitWhatsappMainMessage;
    kitCall.value = generateCallScript(item, t);
    kitEmailMainMessage = generateEmail(item, t);
kitEmail.value = kitEmailMainMessage;
    kitSwot.value = generateSwot(item, t);

    // preparar bot√µes
    const phone = normalizePhone(item.ownerPhone || '');
    openWhatsappBtn.disabled = !phone;
    openWhatsappBtn.title = phone ? 'Abrir WhatsApp para este contacto' : 'Preencha o m√≥vel do propriet√°rio para abrir WhatsApp';

    openMailtoBtn.disabled = !(item.ownerEmail || '').trim();
    openMailtoBtn.title = openMailtoBtn.disabled ? 'Preencha o email do propriet√°rio' : 'Abrir app de email';

    showToast('Kit gerado');
    renderFollowupPanel();
  }

  function closeKit(){
    kitBackdrop.classList.remove('open');
    currentKitItem = null;
  }

  async function regenKit(){
    if(!currentKitItem) return;
    await openKit(currentKitItem);
  }

  async function copyText(text){
    try{
      await navigator.clipboard.writeText(text);
      showToast('Copiado');
    }catch(e){
      // fallback
      const ta = document.createElement('textarea');
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
      showToast('Copiado');
    }
  }

  /* ============ Render Cards ============ */
  function renderCards(){
       const items = state.items.slice().sort((a,b)=>{
      // 1) prioridade: pr√≥xima a√ß√£o mais pr√≥xima (inclui atrasadas no topo)
      const ka = getNextActionSortKey(a);
      const kb = getNextActionSortKey(b);
      if(ka !== kb) return ka - kb;

      // 2) desempate: data de identifica√ß√£o (mais recente primeiro)
      const da = a.dataIdentificacao || '';
      const db = b.dataIdentificacao || '';
      return (db || '').localeCompare(da || '');
    });

    const filtered = applyFilters(items);
    cardsGrid.innerHTML = '';
    emptyState.style.display = filtered.length ? 'none' : 'block';

    const estados = ["identificado","contacto-feito","follow-up","visita","proposta-enviada","angariado","descartado"];
    const labels = {
      "identificado":"Identificados",
      "contacto-feito":"Contacto",
      "follow-up":"Follow-up",
      "visita":"Visita",
      "proposta-enviada":"Proposta",
      "angariado":"Angariados",
      "descartado":"Descartados"
    };
    const contagem = {};
    estados.forEach(e=>contagem[e]=0);
    items.forEach(d=>{
      if(contagem[d.estadoProspeccao] !== undefined){
        contagem[d.estadoProspeccao]++;
      }
    });

    pipelineKpis.innerHTML = '';
    estados.forEach(e=>{
      const chip = document.createElement('div');
      chip.className = 'kpi-chip';
      chip.innerHTML = labels[e] + '<span class="value">' + contagem[e] + '</span>';
      pipelineKpis.appendChild(chip);
    });

    summaryBadges.innerHTML = '';
    const total = items.length;
    const visiveis = items.filter(d=>d.visible !== false).length;

    let b1 = document.createElement('div');
    b1.className = 'badge';
    b1.innerHTML = 'Total <strong>' + total + '</strong>';
    summaryBadges.appendChild(b1);

    let b2 = document.createElement('div');
    b2.className = 'badge';
    b2.innerHTML = 'Vis√≠veis <strong>' + visiveis + '</strong>';
    summaryBadges.appendChild(b2);

    const fil = applyFilters(items);
    const porCons = {};
    const porPortal = {};
    fil.forEach(d=>{
      if(d.consultor){ porCons[d.consultor] = (porCons[d.consultor] || 0) + 1; }
      if(d.portal){ porPortal[d.portal] = (porPortal[d.portal] || 0) + 1; }
    });

    Object.keys(porCons).sort().forEach(n=>{
      const b = document.createElement('div');
      b.className = 'badge';
      b.innerHTML = '<strong>'+n+':</strong> ' + porCons[n];
      summaryBadges.appendChild(b);
    });

    Object.keys(porPortal).sort().forEach(p=>{
      const b = document.createElement('div');
      b.className = 'badge';
      b.innerHTML = '<strong>'+p+':</strong> ' + porPortal[p];
      summaryBadges.appendChild(b);
    });

    filtered.forEach(d=>{
      const card = document.createElement('div');
            const urgencyClass = getNextActionClass(d);
      card.className = 'card' +
        (urgencyClass ? (' ' + urgencyClass) : '') +
        (d.visible === false ? ' hidden-card' : '');
      card.dataset.id = d.id;

      const title = d.tituloImovel || (d.tipologia ? d.tipologia + ' ' : '') + (d.concelho || 'FSBO');
      const subParts = [];
      if(d.portal) subParts.push(d.portal);
      if(d.concelho) subParts.push(d.concelho);
      if(d.freguesia) subParts.push(d.freguesia);
      const subtitleText = subParts.join(' ¬∑ ');

      const topRow = document.createElement('div');
      topRow.className = 'card-top-row';

      const titleBlock = document.createElement('div');
      titleBlock.className = 'card-title-block';

      const h3 = document.createElement('h3');
      h3.className = 'card-title';
      h3.textContent = title;
      titleBlock.appendChild(h3);

      const subtitle = document.createElement('div');
      subtitle.className = 'card-subtitle';
      subtitle.textContent = subtitleText;
      titleBlock.appendChild(subtitle);

      const chipsRow = document.createElement('div');
      chipsRow.className = 'chip-row';

      const estLabelMap = {
        "identificado":"Identificado",
        "contacto-feito":"Contacto feito",
        "follow-up":"Follow-up",
        "visita":"Visita",
        "proposta-enviada":"Proposta enviada",
        "angariado":"Angariado",
        "descartado":"Descartado"
      };
      const est = d.estadoProspeccao || 'identificado';
      let estClass = 'chip-primary';
      if(est === 'angariado') estClass = 'chip-green';
      else if(est === 'descartado') estClass = 'chip-red';
      else if(est === 'proposta-enviada' || est === 'visita') estClass = 'chip-yellow';

      const chipEstado = document.createElement('span');
      chipEstado.className = 'chip ' + estClass;
      chipEstado.textContent = estLabelMap[est] || est;
      chipsRow.appendChild(chipEstado);
const urg = getNextActionChip(d);
if(urg){
  const chipU = document.createElement('span');
  chipU.className = 'chip chip-urg ' + (urg.tone || '');
  chipU.textContent = urg.text;
  chipsRow.appendChild(chipU);
}
      if(d.consultor){
        const ch = document.createElement('span');
        ch.className = 'chip';
        ch.textContent = d.consultor;
        chipsRow.appendChild(ch);
      }
      if(d.tipologia){
        const ch = document.createElement('span');
        ch.className = 'chip';
        ch.textContent = d.tipologia;
        chipsRow.appendChild(ch);
      }
      if(d.precoAnuncio){
        const ch = document.createElement('span');
        ch.className = 'chip';
        ch.textContent = formatMoney(d.precoAnuncio);
        chipsRow.appendChild(ch);
      }
      if(d.portal){
        const ch = document.createElement('span');
        ch.className = 'chip';
        ch.textContent = d.portal;
        chipsRow.appendChild(ch);
      }
      if(d.refAngariacao){
        const ch = document.createElement('span');
        ch.className = 'chip chip-primary';
        ch.textContent = 'Ligado a ' + d.refAngariacao;
        chipsRow.appendChild(ch);
      }

      titleBlock.appendChild(chipsRow);
      topRow.appendChild(titleBlock);
      card.appendChild(topRow);

      // Contacto (novo)
      const hasContact = (d.ownerName || d.ownerPhone || d.ownerEmail);
      if(hasContact){
        const sec = document.createElement('div');
        sec.className = 'card-section';
        const grid = document.createElement('div');
        grid.className = 'card-mini-grid';

        if(d.ownerName){
          const row = document.createElement('div');
          row.className = 'mini-line';
          row.innerHTML = '<div class="mini-k">Nome</div><div class="mini-v">'+ escapeHtml(d.ownerName) +'</div>';
          grid.appendChild(row);
        }
        if(d.ownerPhone){
          const row = document.createElement('div');
          row.className = 'mini-line';
          row.innerHTML = '<div class="mini-k">M√≥vel</div><div class="mini-v">'+ escapeHtml(d.ownerPhone) +'</div>';
          grid.appendChild(row);
        }
        if(d.ownerEmail){
          const row = document.createElement('div');
          row.className = 'mini-line';
          row.innerHTML = '<div class="mini-k">Email</div><div class="mini-v">'+ escapeHtml(d.ownerEmail) +'</div>';
          grid.appendChild(row);
        }

        sec.appendChild(grid);
        card.appendChild(sec);
      }

      if(d.zona || d.concelho || d.freguesia){
        const sec = document.createElement('div');
        sec.className = 'card-section';
        sec.textContent = [d.zona, d.concelho, d.freguesia].filter(Boolean).join(' ¬∑ ');
        card.appendChild(sec);
      }

      if(d.observacoes){
        const sec = document.createElement('div');
        sec.className = 'card-section';
        sec.textContent = d.observacoes.length > 160 ? d.observacoes.slice(0,157)+'‚Ä¶' : d.observacoes;
        card.appendChild(sec);
      }

      const foot = document.createElement('div');
      foot.className = 'card-footer';

      const left = document.createElement('div');
      left.className = 'card-footer-left';

      const partes = [];
      if(d.dataIdentificacao) partes.push('Identificado: ' + d.dataIdentificacao);
      if(d.dataUltimaAcao) partes.push('√öltima a√ß√£o: ' + d.dataUltimaAcao);
      if(d.proximaAcaoData){
        partes.push('Pr√≥xima: ' + d.proximaAcaoData + (d.proximaAcaoTipo ? ' ('+d.proximaAcaoTipo+')' : ''));
      }
      left.textContent = partes.join(' ¬∑ ');
      foot.appendChild(left);

      const right = document.createElement('div');
      right.className = 'card-footer-right';

      const btnKit = document.createElement('button');
      btnKit.className = 'btn-xs success';
      btnKit.textContent = '‚ú® Kit FSBO';
      btnKit.title = 'Gerar WhatsApp, chamada, email e SWOT';
      btnKit.addEventListener('click', ()=>{
        openKit(d);
      });
      right.appendChild(btnKit);

      const btnEdit = document.createElement('button');
      btnEdit.className = 'btn-xs primary';
      btnEdit.textContent = 'Editar';
      btnEdit.addEventListener('click', ()=>{
        if(state.locked) return;
        openModal(d);
      });
      right.appendChild(btnEdit);

      const btnPdf = document.createElement('button');
      btnPdf.className = 'btn-xs';
      btnPdf.textContent = 'PDF';
      btnPdf.addEventListener('click', ()=> exportOnePdf(d));
      right.appendChild(btnPdf);

      if(d.link){
        const btnLink = document.createElement('button');
        btnLink.className = 'btn-xs';
        btnLink.textContent = 'Abrir an√∫ncio';
        btnLink.addEventListener('click', ()=> window.open(d.link, '_blank'));
        right.appendChild(btnLink);
      }

      const btnVis = document.createElement('button');
      btnVis.className = 'btn-xs warn';
      btnVis.textContent = d.visible === false ? 'Tornar vis√≠vel' : 'Tornar invis√≠vel';
      btnVis.addEventListener('click', ()=>{
        if(state.locked) return;
        d.visible = d.visible === false ? true : false;
        saveState();
        renderCards();
      });
      right.appendChild(btnVis);

      const btnDel = document.createElement('button');
      btnDel.className = 'btn-xs danger';
      btnDel.textContent = 'Apagar';
      btnDel.addEventListener('click', ()=>{
        if(state.locked) return;
        if(confirm('Tem a certeza que pretende apagar este registo FSBO?')){
          state.items = state.items.filter(x=>x.id !== d.id);
          saveState();
          renderCards();
        }
      });
      right.appendChild(btnDel);

      foot.appendChild(right);
      card.appendChild(foot);
      cardsGrid.appendChild(card);
    });
  }

  function escapeHtml(str){
    return String(str || '')
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#039;');
  }

  /* ============ CSV ============ */
  function escCsv(v){
    if(v == null) return '';
    const s = String(v).replace(/"/g,'""');
    return '"' + s + '"';
  }

  function exportCsv(){
    if(!state.items.length){
      alert('N√£o existem registos FSBO para exportar.');
      return;
    }

    const cols = [
      'id','consultor','portal','link',
      'ownerName','ownerPhone','ownerEmail',
      'estadoProspeccao','refAngariacao',
      'dataIdentificacao','dataPrimeiroContacto','dataUltimaAcao',
      'proximaAcaoData','proximaAcaoTipo',
      'tituloImovel','concelho','freguesia','zona',
      'natureza','tipologia','precoAnuncio',
      'observacoes','notasInternas','visible'
    ];

    let csv = cols.map(escCsv).join(';') + '\n';
    state.items.forEach(d=>{
      const row = cols.map(c=>escCsv(d[c]));
      csv += row.join(';') + '\n';
    });

    const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'fsbo_garvetur_porto_pro.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  function parseCsv(text){
    const rows = [];
    let row = [];
    let cur = '';
    let inQuotes = false;

    for(let i=0; i<text.length; i++){
      const ch = text[i];

      if(ch === '"'){
        if(inQuotes && text[i+1] === '"'){
          cur += '"';
          i++;
        }else{
          inQuotes = !inQuotes;
        }
      }else if(ch === ';' && !inQuotes){
        row.push(cur);
        cur = '';
      }else if((ch === '\n' || ch === '\r') && !inQuotes){
        if(ch === '\r' && text[i+1] === '\n') i++;
        row.push(cur);
        rows.push(row);
        row = [];
        cur = '';
      }else{
        cur += ch;
      }
    }
    if(cur.length>0 || row.length>0){
      row.push(cur);
      rows.push(row);
    }
    return rows;
  }

  function importFromCsvContent(text){
    const rows = parseCsv(text.trim());
    if(!rows.length){
      alert('Ficheiro CSV vazio ou n√£o reconhecido.');
      return;
    }

    const headerRaw = rows[0];
    const headers = headerRaw.map(h=> String(h || '').trim().replace(/^"|"$/g,''));

    const KNOWN_FIELDS = new Set([
      'id','consultor','portal','link',
      'ownerName','ownerPhone','ownerEmail',
      'estadoProspeccao','refAngariacao',
      'dataIdentificacao','dataPrimeiroContacto','dataUltimaAcao',
      'proximaAcaoData','proximaAcaoTipo',
      'tituloImovel','concelho','freguesia','zona',
      'natureza','tipologia','precoAnuncio',
      'observacoes','notasInternas','visible'
    ]);

    let imported = 0, created = 0, updated = 0;

    for(let i=1;i<rows.length;i++){
      const row = rows[i];
      if(!row || row.length===0) continue;

      const record = {};
      headers.forEach((h,idx)=>{
        if(!h) return;
        let val = row[idx] || '';
        val = String(val).trim();
        val = val.replace(/^"|"$/g,'').replace(/""/g,'"');
        if(!KNOWN_FIELDS.has(h)) return;

        if(h === 'visible'){
          const low = val.toLowerCase();
          record[h] = (low === 'true' || low === '1' || low === 'sim');
        }else{
          record[h] = val;
        }
      });

      if(Object.keys(record).length === 0) continue;

      let id = record.id;
      if(!id){
        id = 'part_' + Date.now() + '_' + i;
        record.id = id;
      }

      const idxExisting = state.items.findIndex(d=>d.id === id);
      if(idxExisting >= 0){
        const existing = state.items[idxExisting];
        const merged = Object.assign({}, existing, record, { id });
        state.items[idxExisting] = migrateItem(merged);
        updated++;
      }else{
        const novo = migrateItem(record);
        state.items.push(novo);
        created++;
      }
      imported++;
    }

    saveState();
    renderCards();

    alert(
      'Importa√ß√£o conclu√≠da.\n\n' +
      'Registos lidos: ' + imported +
      '\nNovos: ' + created +
      '\nAtualizados: ' + updated
    );
  }

  function handleImportCsv(){
    if(state.locked){
      alert('O modo de edi√ß√£o est√° bloqueado. Desbloqueie o cadeado no topo para importar dados.');
      return;
    }

    if(!confirm('Esta opera√ß√£o vai importar/atualizar registos FSBO a partir de um ficheiro CSV exportado do Garvetur Porto Pro.\n\nOs dados existentes com o mesmo ID ser√£o atualizados, os restantes ser√£o adicionados.\n\nPretende continuar?')){
      return;
    }

    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.csv,text/csv';

    input.addEventListener('change', (e)=>{
      const file = e.target.files && e.target.files[0];
      if(!file) return;

      const reader = new FileReader();
      reader.onload = (ev)=>{
        try{
          const text = ev.target.result;
          importFromCsvContent(text);
        }catch(err){
          console.error('Erro a importar CSV de FSBO', err);
          alert('Ocorreu um erro ao ler o ficheiro CSV. Verifique se foi exportado a partir do Garvetur Porto Pro.');
        }
      };
      reader.readAsText(file,'utf-8');
    });

    input.click();
  }

  /* ============ PDF (impress√£o) ============ */
  function exportKitSectionPdf(sectionKey){
  if(!currentKitItem){
    alert('Abra um registo e o Kit FSBO antes de exportar PDF.');
    return;
  }

  const t = lastFetchedTitle || currentKitItem.tituloImovel || currentKitItem.tipologia || 'FSBO';
  const zone = [currentKitItem.zona, currentKitItem.freguesia, currentKitItem.concelho].filter(Boolean).join(' ¬∑ ');
  const owner = currentKitItem.ownerName || 'Propriet√°rio(a)';
  const phone = currentKitItem.ownerPhone || '-';
  const email = currentKitItem.ownerEmail || '-';
  const portal = currentKitItem.portal || '-';
  const link = currentKitItem.link || '';

 const map = {
  whatsapp: { title:'WhatsApp', textareaId:'kitWhatsapp' },
  call:     { title:'Chamada',  textareaId:'kitCall' },
  email:    { title:'Email',    textareaId:'kitEmail' },
  swot:     { title:'SWOT',     textareaId:'kitSwot' },

  // NOVO:
  resumo:   { title:'Resumo do an√∫ncio', textareaId:'kitResumo' }
};

  const pack = map[sectionKey];
  if(!pack){
    alert('Sec√ß√£o inv√°lida.');
    return;
  }
// ‚úÖ ir buscar o conte√∫do real da textarea da sec√ß√£o
const ta = document.getElementById(pack.textareaId);
const content = (ta && typeof ta.value === 'string') ? ta.value.trim() : '';
  const w = window.open('', '_blank');
  if(!w){
    alert('O navegador bloqueou a abertura da janela de impress√£o.\n\nPermita pop-ups para este site.');
    return;
  }

  const safe = (s)=>String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

  const html = `
<!doctype html>
<html lang="pt-PT">
<head>
<meta charset="utf-8" />
<title>Kit FSBO ‚Äî ${safe(pack.title)} ‚Äî ${safe(t)}</title>
<style>
  @page { size: A4; margin: 2cm; }
  body{
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
    margin:0; padding:0;
    color:#222; background:#fff;
  }
  header{
    border-bottom:2px solid #A38B63;
    padding-bottom:8px;
    margin-bottom:12px;
    display:flex;
    justify-content:space-between;
    align-items:flex-end;
    gap:12px;
  }
  h1{
    font-size:15px;
    margin:0 0 4px;
    letter-spacing:.12em;
    text-transform:uppercase;
    color:#333;
  }
  .sub{
    font-size:11px;
    color:#777;
    letter-spacing:.14em;
    text-transform:uppercase;
  }
  .meta{
    font-size:10px;
    color:#666;
    text-align:right;
    white-space:nowrap;
  }
  .block-title{
    margin:0 0 8px;
    font-size:12px;
    letter-spacing:.12em;
    text-transform:uppercase;
    color:#A38B63;
  }
  .info{
    font-size:10px;
    color:#555;
    margin:0 0 12px;
    line-height:1.35;
  }
  pre{
    white-space:pre-wrap;
    word-wrap:break-word;
    font-size:11px;
    line-height:1.35;
    margin:0;
    padding:12px;
    border:1px solid #ddd;
    border-radius:10px;
    background:#fafafa;
  }
  .muted{ color:#777; }
</style>
</head>
<body>
  <header>
    <div>
      <h1>Garvetur Luxury Porto</h1>
      <div class="sub">Kit FSBO ‚Äî ${safe(pack.title)}</div>
    </div>
    <div class="meta">
      <div>Data: ${new Date().toLocaleDateString('pt-PT')}</div>
      <div>Consultor: ${safe(currentKitItem.consultor || '')}</div>
    </div>
  </header>

  <div class="info">
    <div><strong>Registo:</strong> ${safe(t)}${zone ? ' <span class="muted">|</span> ' + safe(zone) : ''}</div>
    <div><strong>Propriet√°rio:</strong> ${safe(owner)} <span class="muted">|</span> <strong>M√≥vel:</strong> ${safe(phone)} <span class="muted">|</span> <strong>Email:</strong> ${safe(email)}</div>
    <div><strong>Portal:</strong> ${safe(portal)}${link ? ' <span class="muted">|</span> <strong>Link:</strong> ' + safe(link) : ''}</div>
  </div>

  <div class="block-title">${safe(pack.title)}</div>
 <pre>${safe(content || '(sem conte√∫do)')}</pre>

<script>
  window.print();
<\/script>
</body>
</html>
`;

  w.document.open();
  w.document.write(html);
  w.document.close();
}
  function exportOnePdf(item){
    const w = window.open('', '_blank');
    if(!w){
      alert('O navegador bloqueou a abertura da janela de impress√£o.\n\nPermita pop-ups para este site ou use outra op√ß√£o.');
      return;
    }

    const titulo = item.tituloImovel || (item.tipologia ? item.tipologia + ' ' : '') + (item.concelho || 'FSBO');
    const ownerBlock = (item.ownerName || item.ownerPhone || item.ownerEmail) ? `
      <h2 class="section">Propriet√°rio</h2>
      <div class="line"><span class="strong">Nome:</span> ${item.ownerName || '-'}</div>
      <div class="line"><span class="strong">M√≥vel:</span> ${item.ownerPhone || '-'}</div>
      <div class="line"><span class="strong">Email:</span> ${item.ownerEmail || '-'}</div>
    ` : '';

    const html = `
<!doctype html>
<html lang="pt-PT">
<head>
<meta charset="utf-8" />
<title>Ficha de Prospe√ß√£o ‚Äî ${titulo}</title>
<style>
  @page { size: A4; margin: 2cm; }
  body{
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
    margin:0;
    padding:0;
    color:#222;
    background:#fff;
  }
  h1{
    font-size:18px;
    margin:0 0 4px;
    letter-spacing:.12em;
    text-transform:uppercase;
    color:#333;
  }
  .sub{
    font-size:11px;
    color:#777;
    letter-spacing:.18em;
    text-transform:uppercase;
  }
  header{
    border-bottom:2px solid #A38B63;
    padding-bottom:8px;
    margin-bottom:10px;
    display:flex;
    justify-content:space-between;
    align-items:flex-end;
  }
  .brand-block{ max-width:70%; }
  .logo-block{
    font-size:11px;
    color:#555;
    text-align:right;
  }
  h2.section{
    font-size:11px;
    text-transform:uppercase;
    letter-spacing:.16em;
    color:#555;
    margin:14px 0 4px;
    border-bottom:1px solid #ddd;
    padding-bottom:2px;
  }
  .line{
    font-size:10px;
    margin:2px 0;
  }
  .strong{ font-weight:600; }
  .muted{ color:#777; }
</style>
</head>
<body>
<div class="page">
  <header>
    <div class="brand-block">
      <h1>Garvetur Luxury Porto</h1>
      <div class="sub">Ficha de Prospe√ß√£o ‚Äî FSBO</div>
    </div>
    <div class="logo-block">
      <div>Data: ${new Date().toLocaleDateString('pt-PT')}</div>
      <div>Portal: ${item.portal || '-'}</div>
    </div>
  </header>

  <div class="line"><span class="strong">T√≠tulo:</span> ${titulo}</div>
  <div class="line"><span class="strong">Consultor:</span> ${item.consultor || ''}</div>
  <div class="line">
    <span class="strong">Estado prospe√ß√£o:</span> ${item.estadoProspeccao || ''} &nbsp; | &nbsp;
    <span class="strong">Ref. angaria√ß√£o:</span> ${item.refAngariacao || '-'}
  </div>
  <div class="line">
    <span class="strong">Identifica√ß√£o:</span> ${item.dataIdentificacao || '-'} &nbsp; | &nbsp;
    <span class="strong">Primeiro contacto:</span> ${item.dataPrimeiroContacto || '-'} &nbsp; | &nbsp;
    <span class="strong">√öltima a√ß√£o:</span> ${item.dataUltimaAcao || '-'}
  </div>
  <div class="line">
    <span class="strong">Pr√≥xima a√ß√£o:</span>
    ${item.proximaAcaoData || '-'} ${item.proximaAcaoTipo ? '('+item.proximaAcaoTipo+')':''}
  </div>
  ${item.link ? `<div class="line"><span class="strong">Link an√∫ncio:</span> ${item.link}</div>` : ''}

  ${ownerBlock}

  <h2 class="section">Im√≥vel & localiza√ß√£o</h2>
  <div class="line"><span class="strong">Concelho:</span> ${item.concelho || ''}</div>
  <div class="line">
    <span class="strong">Freguesia:</span> ${item.freguesia || ''} &nbsp; | &nbsp;
    <span class="strong">Zona:</span> ${item.zona || ''}
  </div>
  <div class="line">
    <span class="strong">Natureza:</span> ${item.natureza || ''} &nbsp; | &nbsp;
    <span class="strong">Tipologia:</span> ${item.tipologia || ''}
  </div>
  <div class="line">
   <span class="strong">Pre√ßo an√∫ncio:</span> ${item.precoAnuncio ? formatMoney(item.precoAnuncio) : '-'}
  </div>

  <h2 class="section">Observa√ß√µes</h2>
  <div class="line">
    ${item.observacoes ? String(item.observacoes).replace(/\\n/g,'<br>') : '<span class="muted">Sem observa√ß√µes registadas.</span>'}
  </div>

  <h2 class="section">Notas internas</h2>
  <div class="line">
    ${item.notasInternas ? String(item.notasInternas).replace(/\\n/g,'<br>') : '<span class="muted">Sem notas internas registadas.</span>'}
  </div>

</div>
<script>
  window.print();
<\/script>
</body>
</html>
    `;

    w.document.open();
    w.document.write(html);
    w.document.close();
  }

  function exportPdfAll(){
    const filtered = applyFilters(state.items);
    if(!filtered.length){
      alert('N√£o existem registos com os filtros atuais para exportar.');
      return;
    }
    exportOnePdf(filtered[0]);
    if(filtered.length>1){
      alert('Nesta fase a exporta√ß√£o em lote gera um PDF de cada vez. Para outros registos, use o bot√£o PDF em cada cart√£o.');
    }
  }

  /* ============ Backup / Restore ============ */
  function handleBackup(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw){
        alert('N√£o existem dados FSBO para fazer backup.');
        return;
      }
      const blob = new Blob([raw], { type: 'application/json;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const hoje = new Date().toISOString().slice(0,10);
      a.href = url;
      a.download = 'fsbo_backup_' + hoje + '.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      alert('Backup efetuado com sucesso.\n\nNota: Os PDFs anexados (IndexedDB) n√£o seguem neste ficheiro.');
    }catch(e){
      console.error('Erro no backup de FSBO', e);
      alert('Ocorreu um erro ao gerar o ficheiro de backup.');
    }
  }

  function handleRestore(){
    if(!confirm(
      'Esta opera√ß√£o vai restaurar dados FSBO a partir de um ficheiro de backup.\n\n' +
      'Os dados atuais ser√£o substitu√≠dos pelos do ficheiro selecionado.\n\n' +
      'Nota: PDFs anexados (IndexedDB) n√£o s√£o substitu√≠dos por esta opera√ß√£o.\n\n' +
      'Pretende continuar?'
    )){
      return;
    }

    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json,application/json';

    input.addEventListener('change', (e)=>{
      const file = e.target.files && e.target.files[0];
      if(!file) return;

      const reader = new FileReader();
      reader.onload = (ev)=>{
        try{
          const text = ev.target.result;
          const parsed = JSON.parse(text);

          let newItems = [];
          let newLocked = true;

          if(Array.isArray(parsed)){
            newItems = parsed;
          }else if(parsed && typeof parsed === 'object'){
            if(Array.isArray(parsed.items)) newItems = parsed.items;
            if(typeof parsed.locked === 'boolean') newLocked = parsed.locked;
          }

          if(!Array.isArray(newItems) || !newItems.length){
            alert('O ficheiro n√£o cont√©m registos v√°lidos FSBO para restaurar.');
            return;
          }

          state.items = newItems.map(migrateItem);
          state.locked = newLocked;
          saveState();
          updateLockUI();
          renderCards();

          alert('Restauro conclu√≠do com sucesso.\n\nTotal de registos carregados: ' + state.items.length);
        }catch(err){
          console.error('Erro ao restaurar backup de FSBO', err);
          alert('O ficheiro selecionado n√£o √© um backup v√°lido FSBO.');
        }
      };

      reader.readAsText(file, 'utf-8');
    });

    input.click();
  }

  /* ============ Events ============ */
  toggleLockBtn.addEventListener('click', ()=>{
    state.locked = !state.locked;
    updateLockUI();
    saveState();
  });

  newItemBtn.addEventListener('click', ()=>{
    if(state.locked) return;
    openModal(null);
  });

  closeModalBtn.addEventListener('click', closeModal);
  cancelModalBtn.addEventListener('click', closeModal);

  saveItemBtn.addEventListener('click', async (e)=>{
    e.preventDefault();
    if(state.locked){
      alert('O modo de edi√ß√£o est√° bloqueado. Desbloqueie o cadeado no topo para guardar altera√ß√µes.');
      return;
    }

    const data = collectFormData();
    // atualizar automaticamente a data da √∫ltima a√ß√£o
const hoje = new Date().toISOString().slice(0,10);
data.dataUltimaAcao = hoje;
$('dataUltimaAcao').value = hoje;
    const idx = state.items.findIndex(d=>d.id === data.id);

    if(idx >= 0){
      const prev = state.items[idx];
      data.visible = (typeof prev.visible === 'boolean') ? prev.visible : true;
      state.items[idx] = migrateItem(data);
    }else{
      data.visible = true;
      state.items.push(migrateItem(data));
    }

    // garantir currentEditingId para anexos
    currentEditingId = data.id;
    $('itemId').value = data.id;

    saveState();
    renderCards();
    await refreshPdfList();
    showToast('Guardado');
    closeModal();
  });

  filterApplyBtn.addEventListener('click', ()=>{
    saveFilterStateFromUI();
    renderCards();
  });

  filterClearBtn.addEventListener('click', ()=>{
    filterConsultor.value = '';
    filterPortal.value = '';
    filterEstado.value = '';
    filterSearchText.value = '';
    filterDataDe.value = '';
    filterDataAte.value = '';
    filterShowHidden.checked = false;
    filterOnlyHidden.checked = false;
    saveFilterStateFromUI();
    renderCards();
  });

  exportCsvBtn.addEventListener('click', exportCsv);
  importCsvBtn.addEventListener('click', handleImportCsv);
  exportPdfBtn.addEventListener('click', exportPdfAll);

  backupBtn.addEventListener('click', handleBackup);
  restoreBtn.addEventListener('click', handleRestore);

  addPdfBtn.addEventListener('click', handleAddPdfs);
  refreshPdfsBtn.addEventListener('click', refreshPdfList);

  // Kit modal events
  closeKitBtn.addEventListener('click', closeKit);
  closeKitBtn2.addEventListener('click', closeKit);
  regenKitBtn.addEventListener('click', regenKit);
  const pdfWhatsappBtn = $('pdfWhatsappBtn');
const pdfEmailBtn = $('pdfEmailBtn');
const pdfCallBtn = $('pdfCallBtn');
const pdfSwotBtn = $('pdfSwotBtn');

if(pdfWhatsappBtn) pdfWhatsappBtn.addEventListener('click', ()=>exportKitSectionPdf('whatsapp'));
if(pdfEmailBtn)    pdfEmailBtn.addEventListener('click', ()=>exportKitSectionPdf('email'));
if(pdfCallBtn)     pdfCallBtn.addEventListener('click', ()=>exportKitSectionPdf('call'));
if(pdfSwotBtn)     pdfSwotBtn.addEventListener('click', ()=>exportKitSectionPdf('swot'));

  copyWhatsappBtn.addEventListener('click', ()=>copyText(kitWhatsapp.value || ''));
  copyCallBtn.addEventListener('click', ()=>copyText(kitCall.value || ''));
  copyEmailBtn.addEventListener('click', ()=>copyText(kitEmail.value || ''));
  copySwotBtn.addEventListener('click', ()=>copyText(kitSwot.value || ''));

    if(genResumoBtn){
    genResumoBtn.addEventListener('click', ()=>{
      if(!currentKitItem){
        alert('Abra primeiro um registo no Kit FSBO.');
        return;
      }
      const resumo = buildKitResumo(currentKitItem);
      kitResumo.value = resumo;
      showToast('Resumo gerado');
    });
  }

  if(clearResumoBtn){
    clearResumoBtn.addEventListener('click', ()=>{
      kitResumo.value = '';
      showToast('Limpo');
    });
  }

  if(copyResumoBtn){
    copyResumoBtn.addEventListener('click', async ()=>{
      try{
        await navigator.clipboard.writeText(kitResumo.value || '');
        showToast('Copiado');
      }catch(e){
        console.error(e);
        alert('N√£o foi poss√≠vel copiar (permiss√µes do browser).');
      }
    });
  }

  if(pdfResumoBtn){
    pdfResumoBtn.addEventListener('click', ()=>{
      if(typeof exportKitSectionPdf === 'function'){
        exportKitSectionPdf('resumo');
      }else{
        alert('Fun√ß√£o de PDF n√£o encontrada no ficheiro (exportKitSectionPdf).');
      }
    });
  }
function applyObjection(objectionKey){
  if(!currentKitItem) return;
  // tenta usar o √∫ltimo t√≠tulo lido (quando dispon√≠vel)
  const t = lastFetchedTitle || null;
  kitWhatsapp.value = buildObjectionReply(objectionKey, currentKitItem, t);
  showToast('Obje√ß√£o aplicada');
}
function applyEmailObjection(key){
  if(!currentKitItem) return;
  const t = lastFetchedTitle || null;
  kitEmail.value = buildEmailObjectionReply(key, currentKitItem, t);
  showToast('Obje√ß√£o aplicada (Email)');
}

if(emailObjManyAgenciesBtn) emailObjManyAgenciesBtn.addEventListener('click', ()=>applyEmailObjection('many'));
if(emailObjCommissionBtn) emailObjCommissionBtn.addEventListener('click', ()=>applyEmailObjection('commission'));
if(emailObjExclusiveBtn) emailObjExclusiveBtn.addEventListener('click', ()=>applyEmailObjection('exclusive'));

if(emailResetBtn) emailResetBtn.addEventListener('click', ()=>{
  kitEmail.value = kitEmailMainMessage || (kitEmail.value || '');
  showToast('Email principal reposto');
});
if(objSoloBtn) objSoloBtn.addEventListener('click', ()=>applyObjection('solo'));
if(objManyAgenciesBtn) objManyAgenciesBtn.addEventListener('click', ()=>applyObjection('many'));
if(objCommissionBtn) objCommissionBtn.addEventListener('click', ()=>applyObjection('commission'));
if(objExclusiveBtn) objExclusiveBtn.addEventListener('click', ()=>applyObjection('exclusive'));

if(objResetWhatsappBtn) objResetWhatsappBtn.addEventListener('click', ()=>{
  kitWhatsapp.value = kitWhatsappMainMessage || (kitWhatsapp.value || '');
  showToast('Mensagem principal reposta');
});
  openWhatsappBtn.addEventListener('click', ()=>{
    if(!currentKitItem) return;
    const phone = normalizePhone(currentKitItem.ownerPhone || '');
    if(!phone){
      alert('Preencha o m√≥vel do propriet√°rio para abrir o WhatsApp.');
      return;
    }
    const msg = encodeURIComponent(kitWhatsapp.value || '');
    // wa.me requer sem +
    const waPhone = phone.replace(/\+/g,'');
    window.open('https://wa.me/' + waPhone + '?text=' + msg, '_blank');
  });

  openMailtoBtn.addEventListener('click', ()=>{
    if(!currentKitItem) return;
    const email = (currentKitItem.ownerEmail || '').trim();
    if(!email){
      alert('Preencha o email do propriet√°rio para abrir o email.');
      return;
    }
    const content = kitEmail.value || '';
    // extrair assunto da 1¬™ linha "Assunto:"
    let subject = 'Contactos sobre o seu im√≥vel';
    let body = content;
    const m = content.match(/^Assunto:\s*(.+)\n\n([\s\S]*)$/i);
    if(m){
      subject = m[1].trim();
      body = m[2] || '';
    }
    const url = 'mailto:' + encodeURIComponent(email) +
      '?subject=' + encodeURIComponent(subject) +
      '&body=' + encodeURIComponent(body);
    window.location.href = url;
  });
/* BEGIN: Follow-up 48h action (1 clique) */
function runFollowup48h(){
  if(!currentKitItem) return;

  // 1) gerar mensagens (usando √∫ltimo t√≠tulo lido quando existe)
  const t = lastFetchedTitle || null;

  const waMsg = generateWhatsappFollowup48h(currentKitItem, t);
  const emailMsg = generateEmailFollowup48h(currentKitItem, t);

  // 2) colocar no Kit (para ficar registado visualmente)
  kitWhatsapp.value = waMsg;
  kitEmailMainMessage = emailMsg; // opcional: passa a ser o ‚Äúprincipal‚Äù atual
  kitEmail.value = emailMsg;

  // 3) atualizar pipeline/datas no registo (48h)
  // - define dataPrimeiroContacto se n√£o existir
  // - define proximaAcaoData = +2 dias a partir de hoje
  // - define proximaAcaoTipo = follow-up
  // - define estadoProspeccao = follow-up (sem estragar o fluxo)
  const hoje = new Date().toISOString().slice(0,10);

  if(!currentKitItem.dataPrimeiroContacto){
    currentKitItem.dataPrimeiroContacto = hoje;
  }
  currentKitItem.dataUltimaAcao = hoje;
  currentKitItem.proximaAcaoData = addDaysToISO(hoje, 2);
  currentKitItem.proximaAcaoTipo = 'follow-up (WA+Email)';
  if(currentKitItem.estadoProspeccao === 'identificado' || currentKitItem.estadoProspeccao === 'contacto-feito'){
    currentKitItem.estadoProspeccao = 'follow-up';
  }

  // persistir e refrescar cards
  saveState();
  renderCards();

  // 4) abrir WhatsApp + email (tentativa em 1 clique)
  const phone = normalizePhone(currentKitItem.ownerPhone || '');
  const email = (currentKitItem.ownerEmail || '').trim();

  // WhatsApp
  if(phone){
    const msg = encodeURIComponent(waMsg || '');
    const waPhone = phone.replace(/\+/g,'');
    window.open('https://wa.me/' + waPhone + '?text=' + msg, '_blank');
  }else{
    showToast('Sem m√≥vel (WA)');
  }

  // Email (mailto)
  if(email){
    // extrair assunto + corpo do template
    let subject = 'Seguimento do seu im√≥vel';
    let body = emailMsg;

    const m = String(emailMsg || '').match(/^Assunto:\s*(.+)\n\n([\s\S]*)$/i);
    if(m){
      subject = (m[1] || '').trim();
      body = m[2] || '';
    }

    const url = 'mailto:' + encodeURIComponent(email) +
      '?subject=' + encodeURIComponent(subject) +
      '&body=' + encodeURIComponent(body);

    // abrir em nova janela (pode ser bloqueado por alguns browsers)
    const w = window.open(url, '_blank');
    if(!w){
      // fallback: abre no mesmo separador
      window.location.href = url;
    }
  }else{
    // fallback √∫til: copia email para clipboard para envio manual
    copyText(emailMsg || '');
    showToast('Sem email ‚Äî copiado');
  }

  showToast('Follow-up 48h preparado');
}

if(followup48hBtn){
  followup48hBtn.addEventListener('click', runFollowup48h);
}
/* END: Follow-up 48h action (1 clique) */
  /* =========================
   FSBO ‚Äî FOLLOW-UP ENGINE (Aditivo / Seguro)
   - Sequ√™ncia de follow-up com 1 clique
   - Registo autom√°tico em notas internas
   - Atualiza datas + pr√≥xima a√ß√£o
   ========================= */

function nowISODate(){
  return new Date().toISOString().slice(0,10);
}

function appendInternalLog(item, channel, title, details){
  // Registo com timestamp + canal + resumo (vai para notasInternas)
  const stamp = new Date().toISOString().replace('T',' ').slice(0,16);
  const lines = [];
  lines.push(`[${stamp}] ${channel} ‚Äî ${title}`);
  if(details) lines.push(details);

  const prev = item.notasInternas || '';
  item.notasInternas = (prev ? (prev + '\n') : '') + lines.join('\n') + '\n';
}

function safeSetProspeccaoForFollowup(item){
  // N√£o ‚Äúestraga‚Äù estados finais
  const est = String(item.estadoProspeccao || 'identificado');
  if(est === 'angariado' || est === 'descartado') return;
  // Se estava identificado/contacto-feito, evolui para follow-up
  if(est === 'identificado' || est === 'contacto-feito') item.estadoProspeccao = 'follow-up';
}

function updateActionFields(item, nextDays, nextTypeLabel){
  const hoje = nowISODate();
  if(!item.dataPrimeiroContacto) item.dataPrimeiroContacto = hoje;
  item.dataUltimaAcao = hoje;

  if(nextDays != null && isFinite(Number(nextDays))){
    item.proximaAcaoData = addDaysToISO(hoje, Number(nextDays));
    item.proximaAcaoTipo = nextTypeLabel || 'follow-up';
  }
}

function openWhatsappWithMessage(item, msg){
  const phone = normalizePhone(item.ownerPhone || '');
  if(!phone){
    alert('Sem m√≥vel do propriet√°rio. Preencha o campo ‚ÄúM√≥vel‚Äù para abrir WhatsApp.');
    return false;
  }
  const waPhone = phone.replace(/\+/g,'');
  const url = 'https://wa.me/' + waPhone + '?text=' + encodeURIComponent(msg || '');
  window.open(url, '_blank');
  return true;
}

function openEmailWithMessage(item, emailMsg){
  const email = (item.ownerEmail || '').trim();
  if(!email){
    // fallback: copiar para enviar manualmente
    copyText(emailMsg || '');
    showToast('Sem email ‚Äî conte√∫do copiado');
    return false;
  }

  // extrair assunto ‚ÄúAssunto: ‚Ä¶‚Äù
  let subject = 'Seguimento do seu im√≥vel';
  let body = emailMsg || '';
  const m = String(emailMsg || '').match(/^Assunto:\s*(.+)\n\n([\s\S]*)$/i);
  if(m){
    subject = (m[1] || '').trim();
    body = m[2] || '';
  }

  const url = 'mailto:' + encodeURIComponent(email) +
    '?subject=' + encodeURIComponent(subject) +
    '&body=' + encodeURIComponent(body);

  const w = window.open(url, '_blank');
  if(!w) window.location.href = url;
  return true;
}

/* Templates follow-up por etapa (curtos, execut√°veis e com pergunta) */
function tplWhatsapp(item, fetchedTitle, stageLabel){
  const owner = item.ownerName ? (' ' + firstNameFromOwner(item.ownerName)) : '';
  const title = fetchedTitle || item.tituloImovel || 'o seu im√≥vel';
  const zone = [item.zona, item.freguesia, item.concelho].filter(Boolean).join(' ¬∑ ');
  const price = item.precoAnuncio ? formatMoney(item.precoAnuncio) : '';

  // remove ‚Äútexto decorativo‚Äù, vai direto ao ponto
  return (
`‚úÖ [GPP-FOLLOWUP ${stageLabel}]
Boa tarde${owner}.

Daqui fala o ${item.consultor || 'Rui Quelhas'} (Garvetur Luxury Porto). S√≥ para fechar o ponto do an√∫ncio ‚Äú${title}‚Äù${zone ? ' ('+zone+')' : ''}${price ? ' ‚Äî ' + price : ''}.

O im√≥vel continua dispon√≠vel?

Se sim, posso enviar-lhe 2‚Äì3 ajustes objetivos para aumentar procura e proteger o valor (leva 2 minutos por mensagem).`
  );
}

function tplEmail(item, fetchedTitle, stageLabel){
  const owner = item.ownerName || 'Propriet√°rio(a)';
  const title = fetchedTitle || item.tituloImovel || 'o seu im√≥vel';
  const zone = [item.zona, item.freguesia, item.concelho].filter(Boolean).join(' ¬∑ ');
  const price = item.precoAnuncio ? formatMoney(item.precoAnuncio) : '';

  return (
`Assunto: Seguimento (${stageLabel}) ‚Äî ${title}${zone ? ' | ' + zone : ''}

Caro(a) ${owner},

Deixo apenas um seguimento r√°pido relativamente ao seu an√∫ncio${zone ? ' em ' + zone : ''}${price ? ' (pre√ßo: ' + price + ')' : ''}.

O im√≥vel continua dispon√≠vel?
Se sim, posso partilhar consigo:
‚Ä¢ enquadramento objetivo de pre√ßo vs. mercado, e
‚Ä¢ 2‚Äì3 melhorias imediatas no an√∫ncio para aumentar procura e proteger o valor.

Caso seja conveniente, podemos falar 8‚Äì10 minutos hoje ao final do dia ou amanh√£ de manh√£.

Com os melhores cumprimentos,

Rui Quelhas
Director Comercial
Garvetur Luxury Porto`
  );
}

/* Defini√ß√£o da cad√™ncia (pode ajustar depois) */
const FOLLOWUP_STEPS = [
  { key:'24h',  label:'24H',  nextDays:2,  nextType:'follow-up (24h)',  channel:'WA',   make:(it,t)=>tplWhatsapp(it,t,'24H') },
  { key:'48h',  label:'48H',  nextDays:3,  nextType:'follow-up (48h)',  channel:'WA+Email', make:(it,t)=>({
      wa: generateWhatsappFollowup48h(it,t),
      email: generateEmailFollowup48h(it,t)
    })
  },
  { key:'72h',  label:'72H',  nextDays:7,  nextType:'follow-up (72h)',  channel:'WA',   make:(it,t)=>tplWhatsapp(it,t,'72H') },
  { key:'7d',   label:'7 DIAS', nextDays:14, nextType:'follow-up (7d)', channel:'Email', make:(it,t)=>tplEmail(it,t,'7 DIAS') },
  { key:'14d',  label:'14 DIAS', nextDays:21, nextType:'follow-up (14d)', channel:'WA',  make:(it,t)=>tplWhatsapp(it,t,'14 DIAS') },
];

function runFollowupStep(stepKey){
  if(!currentKitItem) return;

  const step = FOLLOWUP_STEPS.find(s=>s.key === stepKey);
  if(!step) return;

  const t = lastFetchedTitle || null;

  // 1) gerar conte√∫do
  const pack = step.make(currentKitItem, t);

  // 2) atualizar o Kit (para ficar vis√≠vel)
  if(step.key === '48h' && pack && typeof pack === 'object'){
    kitWhatsapp.value = pack.wa || '';
    kitEmail.value = pack.email || '';
  }else{
    if(step.channel.includes('WA')) kitWhatsapp.value = String(pack || '');
    if(step.channel.includes('Email')) kitEmail.value = String(pack || '');
  }

  // 3) atualizar pipeline + registar
  safeSetProspeccaoForFollowup(currentKitItem);
  updateActionFields(currentKitItem, step.nextDays, step.nextType);

  // log interno
  appendInternalLog(
    currentKitItem,
    step.channel,
    `Follow-up ${step.label}`,
    `Pr√≥xima a√ß√£o: ${currentKitItem.proximaAcaoData || '-'} (${currentKitItem.proximaAcaoTipo || '-'})`
  );

  // persistir
  saveState();
  renderCards();

  // 4) abrir canais
  let opened = false;

  if(step.key === '48h' && pack && typeof pack === 'object'){
    if(pack.wa) opened = openWhatsappWithMessage(currentKitItem, pack.wa) || opened;
    if(pack.email) opened = openEmailWithMessage(currentKitItem, pack.email) || opened;
  }else{
    if(step.channel.includes('WA')) opened = openWhatsappWithMessage(currentKitItem, String(pack || '')) || opened;
    if(step.channel.includes('Email')) opened = openEmailWithMessage(currentKitItem, String(pack || '')) || opened;
  }

  showToast(opened ? `Follow-up ${step.label}` : `Follow-up ${step.label} preparado`);
}

/* UI: injecta bot√µes no Kit (sem alterar HTML) */
function renderFollowupPanel(){
  const box = kitWhatsapp && kitWhatsapp.closest('.kit-box');
  if(!box) return;

  // evitar duplicar
  if(document.getElementById('gppFollowupPanel')) return;

  const panel = document.createElement('div');
  panel.id = 'gppFollowupPanel';
  panel.className = 'kit-actions';
  panel.style.marginTop = '8px';

  // r√≥tulo
  const tag = document.createElement('div');
  tag.style.fontSize = '10px';
  tag.style.color = 'rgba(255,255,255,.45)';
  tag.style.letterSpacing = '.12em';
  tag.style.textTransform = 'uppercase';
  tag.style.margin = '4px 0 2px';
  tag.textContent = 'FOLLOW-UP (1 CLIQUE)';
  box.appendChild(tag);

  // bot√µes
  FOLLOWUP_STEPS.forEach(s=>{
    const b = document.createElement('button');
    b.className = 'btn btn-ghost';
    b.type = 'button';
    b.textContent = `‚è± ${s.label}`;
    b.title = `Gera + regista + agenda + abre (${s.channel})`;
    b.addEventListener('click', ()=>runFollowupStep(s.key));
    panel.appendChild(b);
  });

  box.appendChild(panel);
}
  window.addEventListener('keydown', (e)=>{
    if(e.key === 'Escape'){
      if(modalBackdrop.classList.contains('open')) closeModal();
      if(kitBackdrop.classList.contains('open')) closeKit();
    }
  });

  /* ============ Init ============ */
  initConsultores();
  loadState();
  loadFilterState();
  renderCards();
  // Auto-import via hash: #import=BASE64(JSON)
  (function checkBookmarkletImport(){
    const hash = String(window.location.hash || '');
    const m = hash.match(/(?:^#|&)import=([^&]+)/);
    if(!m) return;

    const payload = decodeImportPayload(m[1]);

    // limpar hash para n√£o repetir ao refrescar
    history.replaceState(null, '', window.location.pathname + window.location.search);

    if(payload){
      prefillFormFromPayload(payload);
    }else{
      showToast('Import inv√°lido');
    }
  })();
})();
</script>
</body>
</html>

