<!doctype html>
<html lang="pt-PT">
<head>
  <meta charset="utf-8" />
  <title>Garvetur Porto Pro — Vendas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --gold:#A38B63;
      --gold-soft:rgba(163,139,99,.35);
      --bg:#0B0B0B;
      --panel:#151515;
      --panel-soft:#1C1C1C;
      --text:#FFFFFF;
      --muted:#A0A0A0;
      --border:rgba(255,255,255,.14);
      --success:#4CAF50;
      --danger:#F25F5C;
      --radius-lg:18px;
      --radius-md:12px;
      --shadow-soft:0 18px 35px rgba(0,0,0,.6);
    }

    *{box-sizing:border-box;}
    html,body{
      margin:0;
      height:100%;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      background:radial-gradient(circle at top,#1c1c1c 0,#050505 55%,#000 100%);
      color:var(--text);
    }

    body{display:flex;flex-direction:column;}

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:12px 18px;
      border-bottom:1px solid rgba(163,139,99,.35);
      background:linear-gradient(90deg,#050505,#111,#050505);
      gap:14px;
      flex-wrap:wrap;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .brand-icon{
      width:28px;
      height:28px;
      border-radius:999px;
      border:1px solid var(--gold);
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:0 0 0 1px rgba(163,139,99,.3);
    }
    .brand h1{
      margin:0;
      font-size:17px;
      letter-spacing:.08em;
      text-transform:uppercase;
      color:var(--gold);
    }
    .brand span.sub{
      display:block;
      font-size:11px;
      color:var(--muted);
      letter-spacing:.14em;
      text-transform:uppercase;
    }

    .nav{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
    }
    .nav a{
      font-size:11px;
      padding:5px 10px;
      border-radius:999px;
      border:1px solid rgba(163,139,99,.35);
      color:var(--muted);
      text-decoration:none;
      text-transform:uppercase;
      letter-spacing:.12em;
      background:rgba(0,0,0,.4);
    }
    .nav a.active{
      background:var(--gold);
      color:#0B0B0B;
      border-color:var(--gold);
      font-weight:600;
    }

    main{
      flex:1;
      padding:16px 18px 18px;
      display:grid;
      grid-template-columns: minmax(0,1.1fr) minmax(0,1fr);
      gap:14px;
    }
    @media (max-width:960px){
      main{grid-template-columns:1fr;grid-auto-rows:auto;}
    }

    .panel{
      border-radius:var(--radius-lg);
      background:linear-gradient(145deg,#171717,#0C0C0C);
      border:1px solid var(--border);
      box-shadow:var(--shadow-soft);
      padding:12px 14px;
    }
    .panel h2{
      margin:0 0 4px;
      font-size:14px;
      letter-spacing:.16em;
      text-transform:uppercase;
      color:var(--muted);
    }
    .panel p{
      margin:2px 0 8px;
      font-size:12px;
      color:var(--muted);
    }

    .kpi-grid{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:8px;
      margin-top:4px;
    }
    @media (max-width:520px){
      .kpi-grid{grid-template-columns:1fr;}
    }
    .kpi-card{
      border-radius:var(--radius-md);
      background:var(--panel-soft);
      border:1px solid rgba(255,255,255,.08);
      padding:8px 9px;
    }
    .kpi-label{
      font-size:11px;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.12em;
    }
    .kpi-value{
      margin-top:2px;
      font-size:18px;
      font-weight:600;
      color:#fff;
    }
    .kpi-helper{
      margin-top:2px;
      font-size:11px;
      color:var(--muted);
    }
    .kpi-value.success{color:var(--success);}
    .kpi-value.danger{color:var(--danger);}

    .table-wrapper{
      margin-top:10px;
      border-radius:var(--radius-md);
      border:1px solid rgba(255,255,255,.08);
      background:#101010;
      max-height:320px;
      overflow:auto;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:11px;
    }
    thead{
      position:sticky;
      top:0;
      background:#111;
      z-index:1;
    }
    th,td{
      padding:6px 8px;
      border-bottom:1px solid rgba(255,255,255,.06);
      text-align:left;
      white-space:nowrap;
    }
    th{
      text-transform:uppercase;
      letter-spacing:.12em;
      font-size:10px;
      color:var(--muted);
    }
    tbody tr:nth-child(even){
      background:rgba(255,255,255,.02);
    }

    .tag{
      display:inline-block;
      padding:1px 6px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      font-size:10px;
      color:var(--muted);
    }
    .tag.consultor{border-color:var(--gold);color:var(--gold);}

    .hint{
      margin-top:6px;
      font-size:11px;
      color:var(--muted);
    }

    footer{
      padding:6px 14px;
      font-size:11px;
      color:var(--muted);
      border-top:1px solid rgba(163,139,99,.28);
      background:#050505;
      display:flex;
      justify-content:space-between;
      gap:8px;
      flex-wrap:wrap;
    }
  </style>
</head>
<body>
<header>
  <div class="brand">
    <div class="brand-icon">
      <svg width="18" height="18" viewBox="0 0 24 24" stroke="var(--gold)" fill="none" stroke-width="1.8">
        <circle cx="12" cy="12" r="9" />
        <path d="M8 12.5l2.5 2.5L16 9" />
      </svg>
    </div>
    <div>
      <h1>Garvetur Porto Pro — Vendas</h1>
      <span class="sub">Negócios fechados · visão de síntese</span>
    </div>
  </div>
  <nav class="nav">
    <a href="./index.html">Home</a>
    <a href="./mapa.html">Mapa</a>
    <a href="./kanban.html">Leads</a>
    <a href="./angariacoes.html">Angariações</a>
    <a href="./dashboard.html">Dashboard</a>
    <a href="./vendas.html" class="active">Vendas</a>
    <a href="./tarefas.html">Tarefas</a>
  </nav>
</header>

<main>
  <!-- Painel de KPIs (baseado em Leads + Angariações) -->
  <section class="panel">
    <h2>Resumo de Vendas</h2>
    <p>Estimativa construída automaticamente a partir de: <strong>Leads (estado “Fecho”)</strong> e <strong>Angariações aprovadas</strong>.</p>

    <div class="kpi-grid">
      <div class="kpi-card">
        <div class="kpi-label">Negócios fechados (Leads)</div>
        <div class="kpi-value" id="kpiNegociosLeads">–</div>
        <div class="kpi-helper" id="kpiNegociosLeadsValor">Valor total: –</div>
      </div>

      <div class="kpi-card">
        <div class="kpi-label">Comissão estimada (Leads)</div>
        <div class="kpi-value success" id="kpiComissaoLeads">–</div>
        <div class="kpi-helper" id="kpiComissaoLeadsMedia">Média por negócio: –</div>
      </div>

      <div class="kpi-card">
        <div class="kpi-label">Angariações aprovadas</div>
        <div class="kpi-value" id="kpiAngAprovadas">–</div>
        <div class="kpi-helper" id="kpiAngAprovadasValor">Valor pedido (soma): –</div>
      </div>

      <div class="kpi-card">
        <div class="kpi-label">Consultor mais ativo (fechos)</div>
        <div class="kpi-value" id="kpiTopConsultor">–</div>
        <div class="kpi-helper" id="kpiTopConsultorCount">Fechos: –</div>
      </div>
    </div>

    <div class="hint">⚠️ Nesta fase, o módulo é apenas de leitura, construído com os dados já gravados nos módulos <strong>Leads</strong> e <strong>Angariações</strong>.</div>
  </section>

  <!-- Tabela de fechos por consultor -->
  <section class="panel">
    <h2>Detalhe por consultor (Leads em Fecho)</h2>
    <p>Base: Leads com estado <strong>“Fecho”</strong> no módulo de Leads.</p>

    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>Consultor</th>
            <th># Fechos</th>
            <th>Negócio total (€)</th>
            <th>Comissão estimada (€)</th>
          </tr>
        </thead>
        <tbody id="tblConsultores">
          <!-- preenchido via JS -->
        </tbody>
      </table>
    </div>
    <div class="hint">Quando evoluirmos este módulo, poderemos ligar aqui dados de escritura, CPCV e origem de negócio.</div>
  </section>
</main>

<footer>
  <span>Fonte de dados: Leads (<code>gpp_leads_v5</code>) & Angariações (<code>gpp_angariacoes_v2</code>) no localStorage.</span>
  <span>Modo leitura — nenhuma escrita nova neste módulo.</span>
</footer>

<script>
(function(){
  function loadLeads(){
    try{
      const raw = localStorage.getItem('gpp_leads_v5');
      if(!raw) return [];
      const parsed = JSON.parse(raw);
      return Array.isArray(parsed)? parsed : [];
    }catch(e){
      console.error('Erro a ler leads', e);
      return [];
    }
  }
  function loadAngariacoes(){
    try{
      const raw = localStorage.getItem('gpp_angariacoes_v2');
      if(!raw) return [];
      const parsed = JSON.parse(raw);
      if(parsed && Array.isArray(parsed.deals)) return parsed.deals;
      return [];
    }catch(e){
      console.error('Erro a ler angariações', e);
      return [];
    }
  }
  function sum(arr){ return (arr||[]).reduce((a,b)=>a+(Number(b)||0),0); }

  function formatEUR(v){
    const n = Number(v||0);
    if(!isFinite(n) || n===0) return '–';
    return n.toLocaleString('pt-PT',{style:'currency',currency:'EUR',maximumFractionDigits:0});
  }

  function updateVendas(){
    const leads = loadLeads().filter(l=>l.estado === 'Fecho');
    const angs = loadAngariacoes().filter(d=>d.estadoAng === 'aprovado');

    const totalNegocio = sum(leads.map(l=>l.fecho_negocio));
    const comissoes = leads.map(l=>{
      const pct = (l.fecho_comissao_pct!=='' && l.fecho_comissao_pct!=null) ? Number(l.fecho_comissao_pct) : 0;
      const neg = Number(l.fecho_negocio||0);
      return neg * pct/100;
    });
    const totalCom = sum(comissoes);
    const mediaCom = leads.length ? totalCom / leads.length : 0;

    (document.getElementById('kpiNegociosLeads')||{}).textContent = leads.length || 0;
    (document.getElementById('kpiNegociosLeadsValor')||{}).textContent = 'Valor total: ' + formatEUR(totalNegocio);
    (document.getElementById('kpiComissaoLeads')||{}).textContent = formatEUR(totalCom);
    (document.getElementById('kpiComissaoLeadsMedia')||{}).textContent = 'Média por negócio: ' + formatEUR(mediaCom);

    const totalAng = angs.length;
    const somaPedido = sum(angs.map(d=>d.precoPedido || d.precoSugerido));
    (document.getElementById('kpiAngAprovadas')||{}).textContent = totalAng || 0;
    (document.getElementById('kpiAngAprovadasValor')||{}).textContent = 'Valor pedido (soma): ' + formatEUR(somaPedido);

    // por consultor (leads Fecho)
    const porConsultor = {};
    leads.forEach(l=>{
      const c = l.consultor || '—';
      if(!porConsultor[c]) porConsultor[c]={fechos:0,neg:0,com:0};
      porConsultor[c].fechos += 1;
      porConsultor[c].neg += Number(l.fecho_negocio||0);
      const pct = (l.fecho_comissao_pct!=='' && l.fecho_comissao_pct!=null) ? Number(l.fecho_comissao_pct) : 0;
      porConsultor[c].com += Number(l.fecho_negocio||0) * pct/100;
    });

    let topName='–', topCount='–';
    const rows=[];
    Object.keys(porConsultor).forEach(name=>{
      const d = porConsultor[name];
      if(topName==='–' || d.fechos > topCount){
        topName = name;
        topCount = d.fechos;
      }
      rows.push({name,fechos:d.fechos,neg:d.neg,com:d.com});
    });

    (document.getElementById('kpiTopConsultor')||{}).textContent = topName;
    (document.getElementById('kpiTopConsultorCount')||{}).textContent = 'Fechos: ' + (topCount==='–' ? 0 : topCount);

    const tbody = document.getElementById('tblConsultores');
    if(!tbody) return;
    tbody.innerHTML = '';
    if(!rows.length){
      const tr=document.createElement('tr');
      const td=document.createElement('td');
      td.colSpan=4;
      td.textContent='Ainda não existem leads em estado "Fecho".';
      td.style.color='var(--muted)';
      tr.appendChild(td);
      tbody.appendChild(tr);
      return;
    }
    rows.sort((a,b)=>b.fechos - a.fechos);
    rows.forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td><span class="tag consultor">${r.name}</span></td>
        <td>${r.fechos}</td>
        <td>${formatEUR(r.neg)}</td>
        <td>${formatEUR(r.com)}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  updateVendas();
  document.addEventListener('visibilitychange',()=>{
    if(!document.hidden) updateVendas();
  });
})();
</script>
</body>
</html>
