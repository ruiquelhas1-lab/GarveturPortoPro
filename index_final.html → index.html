<!doctype html>
<html lang="pt">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Garvetur Porto Pro ‚Äî Mapa de Empreendimentos</title>

<link rel="preconnect" href="https://unpkg.com" crossorigin>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<link rel="preconnect" href="https://a.tile.openstreetmap.org" crossorigin>
<link rel="preconnect" href="https://b.tile.openstreetmap.org" crossorigin>
<link rel="preconnect" href="https://c.tile.openstreetmap.org" crossorigin>

<link id="leaflet-css" rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="anonymous">

<style>
:root { --gold:#A38B63; --bg:#0E0E0E; --panel:#131313; --text:#FFFFFF; --muted:#9AA0A6; }
html,body { height:100%; margin:0; background:var(--bg); color:var(--text); font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;}
.app { display:grid; grid-template-columns:360px 1fr; grid-template-rows:64px 1fr; height:100%; }
header { grid-column:1 / span 2; display:flex; align-items:center; justify-content:space-between; padding:12px 16px; border-bottom:1px solid rgba(163,139,99,.6); background:#0E0E0E; position:sticky; top:0; z-index:10; }
header .brand { display:flex; align-items:center; gap:12px; }
header .brand h1 { font-size:18px; margin:0; color:var(--gold); }
header .actions { display:flex; align-items:center; gap:8px; }
header .btn { background:transparent; border:1px solid rgba(163,139,99,.5); color:var(--text); padding:8px 10px; border-radius:10px; cursor:pointer; }
header .btn:hover { border-color:var(--gold); }
.sidebar { background:var(--panel); border-right:1px solid rgba(163,139,99,.2); overflow:auto; }
.sidebar .section { padding:12px; border-bottom:1px solid rgba(163,139,99,.1); }
.field { display:flex; gap:8px; margin-top:8px; }
.field input { flex:1; background:#0E0E0E; color:var(--text); border:1px solid rgba(163,139,99,.4); border-radius:10px; padding:8px 10px; outline:none; }
.chips { display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; }
.chip { font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid rgba(163,139,99,.4); background:#0E0E0E; color:#ddd; cursor:pointer; }
.chip.active { background:var(--gold); color:#0E0E0E; border-color:var(--gold); }
.list { padding:8px 12px; }
.card { border:1px solid rgba(163,139,99,.3); border-radius:14px; padding:10px; margin-bottom:10px; background:#0E0E0E; }
.card .row { display:flex; justify-content:space-between; gap:8px; }
.card .name { font-weight:600; }
.card .meta { font-size:11px; color:#bbb; text-transform:uppercase; letter-spacing:.05em; }
.card .state { font-size:12px; color:#bbb; margin-top:4px; }
.card .actions { margin-top:8px; display:flex; gap:8px; flex-wrap: wrap; }
.btn-sm { font-size:12px; background:transparent; border:1px solid rgba(163,139,99,.4); color:#ddd; padding:6px 8px; border-radius:8px; cursor:pointer; }
.btn-sm.primary { background: var(--gold); color:#0E0E0E; border-color: var(--gold); }
#map { width: 100%; height: 100%; }
.leaflet-popup-content { font-size: 13px; }
.empty { padding: 12px; color:#bbb; font-size: 13px; }
.note { padding: 10px 12px; color:#c9c9c9; font-size: 12px; border-top:1px dashed rgba(163,139,99,.3); }
@media (max-width: 960px) {
  .app { grid-template-columns: 1fr; grid-template-rows: 64px 240px 1fr; }
  .sidebar { grid-row: 2; }
  #map { grid-row: 3; }
}
</style>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" style="color:var(--gold)"><circle cx="12" cy="12" r="10" stroke-width="1.5"/><path d="M8 12l2.5 2.5L16 9" stroke-width="1.8"/></svg>
        <h1>Garvetur Porto Pro ‚Äî Mapa</h1>
      </div>
      <div class="actions">
        <button id="presetBtn" class="btn" title="Define a fonte oficial e limpa a cache">Definir Fonte Oficial</button>
        <button id="reloadBtn" class="btn">Recarregar</button>
        <a id="openGeoJson" class="btn" href="#" target="_blank" rel="noreferrer">Abrir GeoJSON</a>
      </div>
    </header>

    <aside class="sidebar">
      <div class="section">
        <div style="font-size:12px; color:#999; text-transform:uppercase; letter-spacing:.06em">Fonte de dados</div>
        <div class="field"><input id="urlInput" placeholder="URL do GeoJSON" /></div>
        <div id="status" class="note">Pronto. Clique <b>Definir Fonte Oficial</b> para preencher o URL automaticamente.</div>
      </div>
      <div class="section">
        <div style="font-size:12px; color:#999; text-transform:uppercase; letter-spacing:.06em">Filtros</div>
        <div class="chips">
          <div class="chip active" data-estado="todos">Todos</div>
          <div class="chip" data-estado="em_construcao">Em constru√ß√£o</div>
          <div class="chip" data-estado="licenciado">Licenciado</div>
          <div class="chip" data-estado="concluido">Conclu√≠do</div>
        </div>
        <div class="field"><input id="searchInput" placeholder="Pesquisar: nome / concelho / promotor" /></div>
      </div>
      <div class="section">
        <div style="font-size:12px; color:#999; text-transform:uppercase; letter-spacing:.06em">Empreendimentos</div>
      </div>
      <div id="list" class="list"></div>
    </aside>

    <div id="map"></div>
  </div>

<script>
function loadLeafletCSSFallback() {
  return new Promise((resolve) => {
    const existing = document.getElementById('leaflet-css');
    if (existing) {
      existing.addEventListener('load', () => resolve(true), { once: true });
      existing.addEventListener('error', () => {
        const alt = document.createElement('link');
        alt.rel = 'stylesheet';
        alt.href = 'https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css';
        alt.crossOrigin = 'anonymous';
        document.head.appendChild(alt);
        alt.addEventListener('load', () => resolve(true), { once: true });
      }, { once: true });
      if (existing.sheet) resolve(true);
    } else {
      resolve(true);
    }
  });
}

function loadLeafletJS() {
  return new Promise((resolve, reject) => {
    if (window.L) return resolve(true);
    const primary = document.createElement('script');
    primary.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
    primary.crossOrigin = 'anonymous';
    primary.defer = true;
    primary.onload = () => resolve(true);
    primary.onerror = () => {
      const backup = document.createElement('script');
      backup.src = 'https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js';
      backup.crossOrigin = 'anonymous';
      backup.defer = true;
      backup.onload = () => resolve(true);
      backup.onerror = () => reject(new Error('Falha ao carregar Leaflet de ambos os CDNs.'));
      document.head.appendChild(backup);
    };
    document.head.appendChild(primary);
  });
}
</script>

<script>
const DEFAULT_URL = "https://ruiquelhas1-lab.github.io/Mapa-Porto/data/empreendimentos.geojson";

const urlInput = document.getElementById('urlInput');
const reloadBtn = document.getElementById('reloadBtn');
const presetBtn = document.getElementById('presetBtn');
const openGeoJson = document.getElementById('openGeoJson');
const searchInput = document.getElementById('searchInput');
const listEl = document.getElementById('list');
const chipEls = Array.from(document.querySelectorAll('.chip'));
const statusEl = document.getElementById('status');

let rawData = [];
let layerGroup;
let map;
let activeEstado = 'todos';

function setStatus(msg) {
  statusEl.innerHTML = msg;
}

function normalizeEstado(v) {
  if (!v) return '';
  const s = String(v).toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/ /g, '_');
  if (s.includes('licen')) return 'licenciado';
  if (s.includes('conclu') || s.includes('entreg')) return 'concluido';
  if (s.includes('constr')) return 'em_construcao';
  return s;
}

function renderList(data) {
  listEl.innerHTML = '';
  if (!data.length) {
    listEl.innerHTML = '<div class="empty">Sem resultados com os filtros atuais.</div>';
    return;
  }
  data.forEach(p => {
    const div = document.createElement('div');
    div.className = 'card';
    div.innerHTML = \`
      <div class="row">
        <div class="name">\${p.nome || '‚Äî'}</div>
        <div class="meta">\${p.concelho || '‚Äî'}</div>
      </div>
      <div class="state">Estado: \${normalizeEstado(p.estado) || '‚Äî'}</div>
      <div class="actions">
        <button class="btn-sm" data-action="zoom">Abrir no mapa</button>
        \${p.link ? '<a class="btn-sm" target="_blank" rel="noreferrer" href="'+p.link+'">Abrir link</a>' : ''}
      </div>
    \`;
    div.querySelector('[data-action="zoom"]').addEventListener('click', () => {
      if (p._lat && p._lng) {
        map.setView([p._lat, p._lng], 16, { animate: true });
      }
    });
    listEl.appendChild(div);
  });
}

function applyFilters() {
  const q = searchInput.value.trim().toLowerCase();
  const filtered = rawData.filter(p => {
    const e = normalizeEstado(p.estado);
    const eok = activeEstado === 'todos' || e === activeEstado;
    const sok = !q || [p.nome, p.concelho, p.promotor].some(v => String(v||'').toLowerCase().includes(q));
    return eok && sok;
  });
  renderList(filtered);

  layerGroup.clearLayers();
  filtered.forEach(p => {
    if (p._lat == null || p._lng == null) return;
    const marker = L.circleMarker([p._lat, p._lng], {
      radius: 7, color: '#A38B63', weight: 2, fillColor: '#A38B63', fillOpacity: 0.25
    });
    const html = \`
      <div style="font-weight:600; color:#111;">\${p.nome || '‚Äî'}</div>
      <div style="font-size:12px; color:#555;">\${p.concelho || '‚Äî'} ¬∑ \${normalizeEstado(p.estado) || '‚Äî'}</div>
      <div style="font-size:12px; margin-top:6px;">Promotor: \${p.promotor || '‚Äî'}</div>
      <div style="font-size:12px;">Tipologias: \${p.tipologias || '‚Äî'}</div>
      <div style="font-size:12px;">Conclus√£o: \${p.conclusao || '‚Äî'} ¬∑ Pre√ßo/m¬≤: \${p.preco_m2 || '‚Äî'}</div>
      \${p.link ? '<div style="margin-top:6px;"><a href="'+p.link+'" target="_blank" rel="noreferrer">Abrir link</a></div>' : ''}
    \`;
    marker.bindPopup(html);
    marker.addTo(layerGroup);
  });

  if (filtered.length) {
    const bounds = L.latLngBounds(filtered.map(p => [p._lat, p._lng].filter(Number.isFinite)));
    if (bounds.isValid()) map.fitBounds(bounds.pad(0.2));
  }
}

async function loadData() {
  const url = urlInput.value.trim();
  if (!url) {
    setStatus('‚ö†Ô∏è Insira um URL de GeoJSON v√°lido (ou use <b>Definir Fonte Oficial</b>).');
    return;
  }
  localStorage.setItem('gpp_geojson_url', url);
  openGeoJson.href = url;
  listEl.innerHTML = '<div class="empty">A carregar dados‚Ä¶</div>';
  setStatus('A ler dados de <code>' + url + '</code>‚Ä¶');
  try {
    const res = await fetch(url, { cache: 'no-store' });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const gj = await res.json();
    const feats = gj.features || [];
    rawData = feats.map(f => {
      const p = f.properties || {};
      const mapName = (obj, keys) => { for (const k of keys) if (obj[k] != null && obj[k] !== '') return obj[k]; return ''; };
      const nome = mapName(p, ['nome','name','titulo','t√≠tulo','projecto','projeto']);
      const concelho = mapName(p, ['concelho','municipio','munic√≠pio','city','local']);
      const estado = mapName(p, ['estado','status']);
      const promotor = mapName(p, ['promotor','developer','owner']);
      const tipologias = mapName(p, ['tipologias','typologies','types']);
      const conclusao = mapName(p, ['conclusao','conclus√£o','conclusao_prevista','completion','entrega']);
      const preco_m2 = mapName(p, ['preco_m2','preco_med_m2','preco_medio_m2','price_m2','price_per_sqm','pre√ßo_m2']);
      const notas = mapName(p, ['notas','observacoes','observa√ß√µes','notes']);
      const link = mapName(p, ['link','url','website']);

      const coords = f.geometry && f.geometry.type === 'Point' ? f.geometry.coordinates : null;
      const lng = Array.isArray(coords) ? Number(coords[0]) : NaN;
      const lat = Array.isArray(coords) ? Number(coords[1]) : NaN;

      return { nome, concelho, estado, promotor, tipologias, conclusao, preco_m2, notas, link,
        _lat: isFinite(lat) ? lat : null, _lng: isFinite(lng) ? lng : null };
    });
    setStatus('‚úÖ Dados carregados (' + rawData.length + ' registos).');
    applyFilters();
  } catch (err) {
    console.error(err);
    setStatus('‚ùå Falha ao carregar o GeoJSON. Verifique o URL e tente novamente.');
    listEl.innerHTML = '<div class="empty">Falha ao carregar o GeoJSON.</div>';
    layerGroup.clearLayers();
  }
}

function setOfficialSource() {
  localStorage.removeItem('gpp_geojson_url');
  urlInput.value = DEFAULT_URL;
  openGeoJson.href = DEFAULT_URL;
  setStatus('üîß Fonte definida para <code>' + DEFAULT_URL + '</code>. A carregar‚Ä¶');
  loadData();
}

(async function init() {
  try {
    await loadLeafletCSSFallback();
    await loadLeafletJS();
  } catch (e) {
    const s = document.getElementById('status');
    if (s) s.textContent = '‚ùå N√£o foi poss√≠vel carregar a biblioteca de mapa (Leaflet). Tente atualizar a p√°gina.';
    console.error(e);
    return;
  }

  const savedUrl = localStorage.getItem('gpp_geojson_url');
  urlInput.value = savedUrl || DEFAULT_URL;
  openGeoJson.href = urlInput.value;

  map = L.map('map', { zoomControl: true, scrollWheelZoom: true }).setView([41.15, -8.61], 11);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap' }).addTo(map);
  layerGroup = L.layerGroup().addTo(map);

  chipEls.forEach(chip => {
    chip.addEventListener('click', () => {
      chipEls.forEach(c => c.classList.remove('active'));
      chip.classList.add('active');
      activeEstado = chip.dataset.estado || 'todos';
      applyFilters();
    });
  });

  searchInput.addEventListener('input', applyFilters);
  reloadBtn.addEventListener('click', loadData);
  presetBtn.addEventListener('click', setOfficialSource);

  loadData();
})();
</script>
</body>
</html>
