<!doctype html>
<html lang="pt-PT">
<head>
  <meta charset="utf-8" />
  <title>Garvetur Porto Pro — Executivo · KPIs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --gold:#A38B63;
      --gold-soft:rgba(163,139,99,.35);
      --bg:#0B0B0B;
      --panel:#151515;
      --panel-soft:#1C1C1C;
      --text:#FFFFFF;
      --muted:#A0A0A0;
      --border:rgba(255,255,255,.14);
      --shadow-soft:0 22px 40px rgba(0,0,0,.7);
      --radius-lg:20px;
      --radius-md:14px;
      --danger:#E53935;
      --ok:#4CAF50;
    }

    *{box-sizing:border-box;}
    html,body{
      margin:0;
      height:100%;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      background:radial-gradient(circle at top,#1c1c1c 0,#050505 55%,#000 100%);
      color:var(--text);
    }

    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:12px 18px;
      border-bottom:1px solid rgba(163,139,99,.35);
      background:linear-gradient(90deg,#050505,#111,#050505);
      gap:14px;
      flex-wrap:wrap;
      position:sticky; top:0; z-index:20;
    }
    .brand{display:flex;align-items:center;gap:10px;}
    .brand-icon{
      width:30px;height:30px;border-radius:999px;border:1px solid var(--gold);
      display:flex;align-items:center;justify-content:center;
      box-shadow:0 0 0 1px rgba(163,139,99,.35);
    }
    .brand h1{
      margin:0;font-size:18px;letter-spacing:.08em;text-transform:uppercase;color:var(--gold);
    }
    .brand span.sub{
      display:block;font-size:11px;color:var(--muted);letter-spacing:.14em;text-transform:uppercase;
    }
    .badge{
      font-size:11px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(163,139,99,.45);
      color:var(--muted);
      letter-spacing:.12em;
      text-transform:uppercase;
      background:rgba(0,0,0,.35);
      white-space:nowrap;
    }
    main{padding:18px 18px 20px;max-width:1200px;margin:0 auto;}

    .hero{
      border-radius:var(--radius-lg);
      background:linear-gradient(135deg,#171717,#050505);
      border:1px solid var(--gold-soft);
      box-shadow:var(--shadow-soft);
      padding:14px 16px;
      margin-bottom:14px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .hero h2{
      margin:0 0 6px;
      font-size:16px;
      letter-spacing:.16em;
      text-transform:uppercase;
      color:#f5f5f5;
    }
    .hero p{
      margin:0;
      font-size:12px;
      color:var(--muted);
      line-height:1.55;
      max-width:820px;
    }
    .hero-actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center;}
    .btn{
      border-radius:999px;
      border:1px solid rgba(163,139,99,.45);
      background:rgba(0,0,0,.75);
      color:var(--gold);
      padding:7px 12px;
      font-size:12px;
      cursor:pointer;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:6px;
      transition:.18s transform,.18s border-color;
    }
    .btn:hover{transform:translateY(-1px);border-color:var(--gold);}
    .btn.primary{
      background:var(--gold);
      color:#0A0A0A;
      border-color:var(--gold);
      font-weight:700;
    }

    .grid{
      display:grid;
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:12px;
    }
    @media (max-width:1000px){ .grid{grid-template-columns:repeat(2,minmax(0,1fr));} }
    @media (max-width:680px){ .grid{grid-template-columns:1fr;} }

    .card{
      border-radius:var(--radius-lg);
      background:linear-gradient(145deg,#181818,#0C0C0C);
      border:1px solid rgba(255,255,255,.14);
      box-shadow:var(--shadow-soft);
      padding:12px 12px 11px;
      display:flex;
      flex-direction:column;
      gap:8px;
      position:relative;
      overflow:hidden;
      min-height:120px;
    }
    .card::before{
      content:"";
      position:absolute;
      inset:-40%;
      background:radial-gradient(circle at top left,rgba(163,139,99,.12),transparent 55%);
      opacity:0;
      transition:.25s opacity;
      pointer-events:none;
    }
    .card:hover::before{opacity:1;}
    .card h3{
      margin:0;
      font-size:12px;
      letter-spacing:.14em;
      text-transform:uppercase;
      color:var(--muted);
    }
    .big{
      font-size:22px;
      font-weight:800;
      letter-spacing:.02em;
      color:#fff;
    }
    .sub{
      font-size:11px;
      color:var(--muted);
      line-height:1.4;
    }

    .status{
      margin-top:10px;
      font-size:12px;
      color:var(--muted);
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .pill{
      display:inline-flex;
      gap:6px;
      align-items:center;
      border:1px solid var(--border);
      border-radius:999px;
      padding:4px 10px;
      background:rgba(0,0,0,.35);
      font-size:11px;
      color:var(--muted);
      white-space:nowrap;
      max-width:100%;
    }
    .pill span{max-width:72vw; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}
    .dot{width:10px;height:10px;border-radius:50%;background:#777;display:inline-block;}
    .dot.ok{background:var(--ok)}
    .dot.bad{background:var(--danger)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:11px;opacity:.9}

    .lock{
      position:fixed; inset:0; z-index:9999;
      background:radial-gradient(circle at top, rgba(0,0,0,.55), rgba(0,0,0,.92));
      display:flex; align-items:center; justify-content:center; padding:16px;
    }
    .lock-card{
      width:min(520px, 96vw);
      border-radius:18px;
      border:1px solid rgba(163,139,99,.35);
      background:linear-gradient(145deg,#111,#070707);
      box-shadow:0 22px 40px rgba(0,0,0,.75);
      padding:14px 14px 12px;
    }
    .lock-title{
      margin:0 0 6px;
      font-size:14px;
      letter-spacing:.16em;
      text-transform:uppercase;
      color:var(--gold);
    }
    .lock-sub{
      margin:0 0 10px;
      font-size:12px;
      color:var(--muted);
      line-height:1.5;
    }
    .lock-row{display:flex;gap:8px;flex-wrap:wrap;}
    .lock input{
      flex:1; min-width:200px;
      border-radius:12px;
      border:1px solid rgba(163,139,99,.28);
      background:rgba(0,0,0,.65);
      color:#fff;
      padding:10px 12px;
      outline:none;
      font-size:14px;
    }
    .lock input:focus{border-color:var(--gold); box-shadow:0 0 0 1px rgba(163,139,99,.35);}
    .lock button{
      border-radius:12px;
      border:1px solid rgba(163,139,99,.55);
      background:var(--gold);
      color:#0A0A0A;
      padding:10px 12px;
      cursor:pointer;
      font-weight:800;
    }
    .lock-err{margin-top:8px;font-size:12px;color:#ffb4b4;display:none;}
    .lock-mini{
      margin-top:10px;
      font-size:11px;
      color:rgba(255,255,255,.35);
      display:flex;
      justify-content:space-between;
      gap:8px;
      flex-wrap:wrap;
    }
    .mini-link{
      color:rgba(255,255,255,.45);
      text-decoration:none;
      border-bottom:1px dotted rgba(255,255,255,.25);
    }
    .mini-link:hover{color:#fff;border-bottom-color:#fff;}
  </style>
</head>
<body>

<div id="lock" class="lock" aria-modal="true" role="dialog" style="display:none;">
  <div class="lock-card">
    <h2 class="lock-title">Acesso Executivo</h2>
    <p class="lock-sub">Módulo reservado. Introduza a password de Admin para continuar.</p>
    <div class="lock-row">
      <input id="pw" type="password" placeholder="Password admin" autocomplete="current-password" />
      <button id="btn">Entrar</button>
    </div>
    <div id="err" class="lock-err">Password inválida.</div>
    <div class="lock-mini">
      <span>Garvetur Porto Pro</span>
      <a class="mini-link" href="./admin.html">Voltar ao Admin</a>
    </div>
  </div>
</div>

<header>
  <div class="brand">
    <div class="brand-icon">
      <svg width="18" height="18" viewBox="0 0 24 24" stroke="var(--gold)" fill="none" stroke-width="1.8">
        <circle cx="12" cy="12" r="9"></circle>
        <path d="M8 12.5l2.5 2.5L16 9"></path>
      </svg>
    </div>
    <div>
      <h1>Executivo · KPIs</h1>
      <span class="sub">Visão de Direção — Vendas, Volume e Comissões</span>
    </div>
  </div>
  <span class="badge">Privado</span>
</header>

<main>
  <section class="hero">
    <div>
      <h2>Resumo consolidado</h2>
      <p>
        Consolidado de <strong>Leads em Fecho</strong> e <strong>Angariações Aprovadas</strong>.
        Leitura via <span class="mono">/data/gpp-leads.json</span> e <span class="mono">/data/gpp-angariacoes.json</span>.
      </p>
      <div class="status" id="status"></div>
    </div>
    <div class="hero-actions">
      <a class="btn" href="./admin.html">← Admin</a>
      <button class="btn primary" id="btnReload">Recarregar</button>
    </div>
  </section>

  <section class="grid">
    <article class="card">
      <h3>Negócios (total)</h3>
      <div class="big" id="k_negocios">0</div>
      <div class="sub" id="k_split">Leads: 0 · Angariações aprovadas: 0</div>
    </article>

    <article class="card">
      <h3>Volume total</h3>
      <div class="big" id="k_volume">€ 0</div>
      <div class="sub">Leads (valor de negócio) + Angariações aprovadas (preço pedido).</div>
    </article>

    <article class="card">
      <h3>Top consultor (volume)</h3>
      <div class="big" id="k_top">—</div>
      <div class="sub" id="k_top_sub">Sem dados.</div>
    </article>

    <article class="card">
      <h3>Comissões (total)</h3>
      <div class="big" id="k_com_total">€ 0</div>
      <div class="sub">Comissão total calculada para Leads em Fecho.</div>
    </article>

    <article class="card">
      <h3>Comissões já recebidas</h3>
      <div class="big" id="k_com_recv">€ 0</div>
      <div class="sub">Parcelas com data ≤ hoje (CPCV/Escritura).</div>
    </article>

    <article class="card">
      <h3>Comissões por receber</h3>
      <div class="big" id="k_com_open">€ 0</div>
      <div class="sub">Diferença: total – recebido.</div>
    </article>
  </section>
</main>

<script>
/* ===== Proteção (mesma sessão do admin) ===== */
(function(){
  const ADMIN_PASS = '#AdminGarvetur#1997';
  const KEY  = 'gpp_admin_auth_v1';

  const lock = document.getElementById('lock');
  const pw   = document.getElementById('pw');
  const btn  = document.getElementById('btn');
  const err  = document.getElementById('err');

  function hasSession(){
    try{ return sessionStorage.getItem(KEY)==='1'; }catch(e){ return false; }
  }
  function grant(){
    try{ sessionStorage.setItem(KEY,'1'); }catch(e){}
    lock.style.display = 'none';
  }
  function deny(){
    err.style.display = 'block';
    if(pw) pw.value = '';
    pw && pw.focus();
  }
  function submit(){
    err.style.display = 'none';
    const v = (pw.value || '').trim();
    if(v === ADMIN_PASS) grant();
    else deny();
  }

  if(!hasSession()){
    lock.style.display = 'flex';
    btn.addEventListener('click', submit);
    pw.addEventListener('keydown', (e)=>{ if(e.key==='Enter') submit(); });
    setTimeout(()=>pw && pw.focus(), 60);
  }else{
    lock.style.display = 'none';
  }
})();
</script>

<script>
/* ===== Leitura robusta /data/*.json em GitHub Pages + auto-detecção de arrays ===== */
(function(){
  const statusEl = document.getElementById('status');
  const el = (id)=>document.getElementById(id);

  const k_negocios = el('k_negocios');
  const k_split    = el('k_split');
  const k_volume   = el('k_volume');
  const k_top      = el('k_top');
  const k_top_sub  = el('k_top_sub');

  const k_com_total = el('k_com_total');
  const k_com_recv  = el('k_com_recv');
  const k_com_open  = el('k_com_open');

  const btnReload = el('btnReload');
  btnReload?.addEventListener('click', ()=>location.reload());

  function pill(ok, label, value){
    const div = document.createElement('div');
    div.className = 'pill';
    div.innerHTML = `<span class="dot ${ok?'ok':'bad'}"></span><strong>${label}:</strong> <span class="mono">${String(value||'')}</span>`;
    return div;
  }

  function guessRepoName(){
    const parts = (location.pathname || '').split('/').filter(Boolean);
    return parts.length ? parts[0] : '';
  }
  function buildCandidateUrls(rel){
    const repo = guessRepoName();
    const base = location.origin;

    const list = [
      new URL('./' + rel, location.href).toString(),
      new URL('/' + rel, base).toString()
    ];
    if(location.hostname.endsWith('github.io') && repo){
      list.unshift(new URL('/' + repo + '/' + rel, base).toString());
    }
    return [...new Set(list)];
  }
  async function pickWorkingUrl(rel){
    const candidates = buildCandidateUrls(rel);
    for(const url of candidates){
      try{
        const r = await fetch(url, { method:'HEAD', cache:'no-store' });
        if(!r.ok) continue;
        const ct = (r.headers.get('content-type') || '').toLowerCase();
        if(ct.includes('text/html')) continue; // 404 do GH Pages costuma ser HTML
        return url;
      }catch{}
    }
    return candidates[0];
  }
  async function fetchJson(rel){
    const url0 = await pickWorkingUrl(rel);
    const u = new URL(url0);
    u.searchParams.set('v', String(Date.now()));
    const url = u.toString();

    const r = await fetch(url, { cache:'no-store' });
    if(!r.ok) throw new Error(`HTTP ${r.status} em ${rel}`);
    const json = await r.json();
    return { json, url };
  }

  /* ===== Helpers de parsing ===== */
  function norm(s){ return String(s||'').trim().toLowerCase(); }

  function parseNumber(v){
    if(v==null || v==='') return NaN;
    const s = String(v).replace(/\./g,'').replace(',','.');
    const n = parseFloat(s);
    return isFinite(n) ? n : NaN;
  }
  function parsePct(v){
    if(v==null || v==='') return NaN;
    const s = String(v).replace('%','').replace(',','.');
    const n = parseFloat(s);
    return isFinite(n) ? n : NaN;
  }
  function formatMoney(v){
    const n = Number(v);
    if(!isFinite(n) || n === 0) return '€ 0';
    return n.toLocaleString('pt-PT',{style:'currency',currency:'EUR',maximumFractionDigits:0});
  }
  function todayISO(){
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    return y + '-' + m + '-' + day;
  }
  function findDateWithToken(objs, token){
    const re = /^\d{4}-\d{2}-\d{2}$/;
    const tk = String(token).toLowerCase();
    for(const obj of objs){
      if(!obj || typeof obj!=='object') continue;
      for(const k of Object.keys(obj)){
        const lk = k.toLowerCase();
        if(lk.includes(tk)){
          const v = obj[k];
          if(typeof v === 'string' && re.test(v.trim())){
            return v.trim();
          }
        }
      }
    }
    return '';
  }

  function normalizeFechoEstado(v){
    const s = norm(v);
    // tolerante (Fecho / fecho / "Fecho " / etc.)
    return s === 'fecho';
  }

  function normalizeAprovado(v){
    const s = norm(v);
    return (s === 'aprovado' || s === 'aprovada' || s === 'approved');
  }

  // Procura recursiva de “array candidato” dentro do JSON
  function findArrayDeep(root, predicate){
    const seen = new Set();
    const q = [root];
    while(q.length){
      const cur = q.shift();
      if(!cur || typeof cur !== 'object') continue;
      if(seen.has(cur)) continue;
      seen.add(cur);

      if(Array.isArray(cur)){
        if(cur.length && predicate(cur)) return cur;
        // também pode conter objetos com arrays dentro
        for(const it of cur){
          if(it && typeof it === 'object') q.push(it);
        }
        continue;
      }

      for(const k of Object.keys(cur)){
        const v = cur[k];
        if(v && typeof v === 'object') q.push(v);
      }
    }
    return [];
  }

  function isLikelyLeadsArray(arr){
    // pelo menos alguns itens com “estado” e “consultor”/“fecho”
    let score = 0;
    for(const it of arr.slice(0,60)){
      if(!it || typeof it !== 'object') continue;
      const keys = Object.keys(it).map(k=>k.toLowerCase());
      if(keys.includes('estado')) score++;
      if(keys.includes('consultor')) score++;
      if(keys.some(k=>k.includes('fecho'))) score++;
      if(score >= 3) return true;
    }
    return false;
  }

  function isLikelyAngArray(arr){
    let score = 0;
    for(const it of arr.slice(0,60)){
      if(!it || typeof it !== 'object') continue;
      const keys = Object.keys(it).map(k=>k.toLowerCase());
      if(keys.some(k=>k.includes('estadoang'))) score++;
      if(keys.includes('consultor')) score++;
      if(keys.some(k=>k.includes('precopedido'))) score++;
      if(score >= 3) return true;
    }
    return false;
  }

  function extractLeads(json){
    if(Array.isArray(json)) return json;
    if(json && Array.isArray(json.leads)) return json.leads;
    if(json && Array.isArray(json.data)) return json.data;

    // fallback: procurar um array “lá dentro”
    return findArrayDeep(json, isLikelyLeadsArray);
  }

  function extractAngariacoes(json){
    // formato típico: {deals:[...]}
    if(json && Array.isArray(json.deals)) return json.deals;
    if(Array.isArray(json)) return json;
    if(json && Array.isArray(json.data)) return json.data;

    return findArrayDeep(json, isLikelyAngArray);
  }

  /* ===== Construção ===== */
  function buildNegocios(leadsArr, angArr){
    const list = [];

    // Leads em Fecho
    (Array.isArray(leadsArr) ? leadsArr : []).forEach(l=>{
      if(!l) return;
      if(!normalizeFechoEstado(l.estado)) return;

      const valorNegocio = parseNumber(l.fecho_negocio || l.valor || 0);

      const comissaoPctStr = (l.fecho_comissao_pct!=='' && l.fecho_comissao_pct!=null)
        ? String(l.fecho_comissao_pct)
        : (l.fecho && l.fecho.comissaoPct ? String(l.fecho.comissaoPct) : '');

      const comPctNum = parsePct(comissaoPctStr);
      const comissaoValorTotal = isFinite(comPctNum) ? (valorNegocio * comPctNum / 100) : 0;

      const fechoObj = l.fecho || {};
      const dataCpcv      = findDateWithToken([l, fechoObj], 'cpcv');
      const dataEscritura = findDateWithToken([l, fechoObj], 'escritura');
      const dataFecho     = dataCpcv || dataEscritura || (l.data || '');

      list.push({
        tipo:'lead',
        consultor: l.consultor || '',
        valor: isFinite(valorNegocio) ? valorNegocio : 0,
        comissaoValorTotal: comissaoValorTotal,
        comissaoPct: comissaoPctStr || '',
        dataCpcv: dataCpcv || '',
        dataEscritura: dataEscritura || '',
        data: dataFecho || ''
      });
    });

    // Angariações: apenas aprovadas
    (Array.isArray(angArr) ? angArr : []).forEach(a=>{
      if(!a) return;
      if(!normalizeAprovado(a.estadoAng)) return;

      const precoPedido = parseNumber(a.precoPedido || 0);
      list.push({
        tipo:'ang',
        consultor: a.consultor || '',
        valor: isFinite(precoPedido) ? precoPedido : 0,
        data: a.dataAngariacao || ''
      });
    });

    return list;
  }

  function computeKPIs(negocios){
    const total = negocios.length;
    const leads = negocios.filter(n=>n.tipo==='lead');
    const angs  = negocios.filter(n=>n.tipo==='ang');

    const volumeTotal = negocios.reduce((acc,n)=>acc + (n.valor||0), 0);

    const porCons = {};
    negocios.forEach(n=>{
      const c = (n.consultor||'').trim();
      if(!c) return;
      porCons[c] = (porCons[c] || 0) + (n.valor || 0);
    });
    const entries = Object.entries(porCons).sort((a,b)=>b[1]-a[1]);

    const totalComissoes = leads.reduce((acc,n)=>acc + (n.comissaoValorTotal||0), 0);

    const hoje = todayISO();
    let recebido = 0;

    leads.forEach(n=>{
      const total = n.comissaoValorTotal || 0;
      if(total <= 0) return;

      const hasCpcv = !!n.dataCpcv;
      const hasEsc  = !!n.dataEscritura;

      function add(dateStr, val){
        if(!dateStr || !val || val<=0) return;
        if(dateStr <= hoje) recebido += val;
      }

      if(hasCpcv && hasEsc){
        add(n.dataCpcv, total/2);
        add(n.dataEscritura, total/2);
      }else if(hasCpcv){
        add(n.dataCpcv, total);
      }else if(hasEsc){
        add(n.dataEscritura, total);
      }else if(n.data){
        add(n.data, total);
      }
    });

    return {
      total,
      totalLeads: leads.length,
      totalAngs: angs.length,
      volumeTotal,
      top: entries.length ? { nome: entries[0][0], vol: entries[0][1] } : null,
      comTotal: totalComissoes,
      comRecebido: recebido,
      comPorReceber: (totalComissoes - recebido)
    };
  }

  async function init(){
    statusEl.innerHTML = '';
    statusEl.appendChild(pill(true,'Ambiente', location.hostname));
    statusEl.appendChild(pill(true,'Path', location.pathname));

    let leadsRes=null, angRes=null;

    try{
      leadsRes = await fetchJson('data/gpp-leads.json');
      statusEl.appendChild(pill(true,'Leads', 'OK'));
      statusEl.appendChild(pill(true,'Leads URL', leadsRes.url));
    }catch(e){
      console.error(e);
      statusEl.appendChild(pill(false,'Leads', 'Falha'));
      statusEl.appendChild(pill(false,'Erro', String(e.message||e)));
      return;
    }

    try{
      angRes = await fetchJson('data/gpp-angariacoes.json');
      statusEl.appendChild(pill(true,'Angariações', 'OK'));
      statusEl.appendChild(pill(true,'Ang URL', angRes.url));
    }catch(e){
      console.warn(e);
      statusEl.appendChild(pill(false,'Angariações', 'Falha'));
      statusEl.appendChild(pill(false,'Ang erro', String(e.message||e)));
      angRes = { json: { deals: [] } };
    }

    const leadsArr = extractLeads(leadsRes.json);
    const angArr   = extractAngariacoes(angRes.json);

    statusEl.appendChild(pill(true,'Leads detectadas', Array.isArray(leadsArr) ? leadsArr.length : 0));
    statusEl.appendChild(pill(true,'Ang detectadas', Array.isArray(angArr) ? angArr.length : 0));

    const negocios = buildNegocios(leadsArr, angArr);
    const k = computeKPIs(negocios);

    k_negocios.textContent = String(k.total);
    k_split.textContent = `Leads: ${k.totalLeads} · Angariações aprovadas: ${k.totalAngs}`;
    k_volume.textContent = formatMoney(k.volumeTotal);

    if(!k.top){
      k_top.textContent = '—';
      k_top_sub.textContent = 'Sem dados de consultor.';
    }else{
      k_top.textContent = k.top.nome;
      k_top_sub.textContent = `${formatMoney(k.top.vol)} em volume.`;
    }

    k_com_total.textContent = formatMoney(k.comTotal);
    k_com_recv.textContent  = formatMoney(k.comRecebido);
    k_com_open.textContent  = formatMoney(k.comPorReceber);
  }

  init();
})();
</script>

</body>
</html>
