<!doctype html>
<html lang="pt-PT">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Garvetur Porto Pro â€” Visitas (Admin)</title>

<style>
:root{
  --gold:#A38B63;
  --bg:#0B0B0B;
  --panel:#151515;
  --border:rgba(255,255,255,.14);
  --text:#fff;
  --muted:#bdbdbd;
  --radius:16px;
  --slotH:46px; /* altura de cada hora no calendÃ¡rio semanal */
}

*{box-sizing:border-box}
html,body{margin:0;height:100%}
body{
  font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
  background:radial-gradient(circle at top,#1c1c1c 0,#050505 55%,#000 100%);
  color:var(--text);
}

header{
  display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;
  padding:12px 18px;
  border-bottom:1px solid rgba(163,139,99,.35);
  background:linear-gradient(90deg,#050505,#111,#050505);
}
h1{
  margin:0;
  font-size:16px;
  letter-spacing:.14em;
  text-transform:uppercase;
  color:var(--gold);
}

main{padding:18px;display:grid;grid-template-columns:360px 1fr;gap:14px}
@media(max-width:980px){main{grid-template-columns:1fr}}

.card{
  background:linear-gradient(145deg,#181818,#0C0C0C);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:14px;
  margin-bottom:14px;
}

label{font-size:12px;color:#ddd;margin-top:8px;display:block}
input,select{
  width:100%;
  margin-top:4px;
  padding:8px 10px;
  border-radius:10px;
  border:1px solid rgba(255,255,255,.18);
  background:#000;
  color:#fff;
}
input:focus,select:focus{
  outline:none;
  border-color:rgba(163,139,99,.75);
  box-shadow:0 0 0 1px rgba(163,139,99,.25);
}

button{
  border-radius:999px;
  padding:8px 12px;
  border:1px solid rgba(163,139,99,.55);
  background:#000;
  color:var(--gold);
  cursor:pointer;
  transition:.18s transform,.18s border-color;
}
button:hover{transform:translateY(-1px);border-color:var(--gold)}
button.primary{background:var(--gold);color:#000;font-weight:800}
button.ghost{background:transparent}

.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}

.tabs{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap}
.tab{
  padding:6px 12px;
  border-radius:999px;
  border:1px solid rgba(163,139,99,.4);
  cursor:pointer;
  font-size:12px;
  user-select:none;
}
.tab.active{background:var(--gold);color:#000;font-weight:800}

.kpis{display:flex;gap:10px;margin-bottom:12px;flex-wrap:wrap}
.kpi{
  border:1px solid rgba(163,139,99,.35);
  border-radius:14px;
  padding:10px 14px;
  font-size:12px;
  background:rgba(0,0,0,.25);
}
.kpi b{font-size:18px;display:block;color:#fff}

.event{
  border:1px solid rgba(255,255,255,.15);
  border-radius:14px;
  padding:10px;
  margin-bottom:8px;
  background:rgba(0,0,0,.35);
  cursor:pointer;
}
.event:hover{border-color:var(--gold)}
.event b{color:#fff}

.small{font-size:11px;color:var(--muted)}
.mini{font-size:11px;color:rgba(255,255,255,.75)}

hr.sep{border:0;border-top:1px solid rgba(255,255,255,.10);margin:12px 0}

/* ===== CalendÃ¡rio Semanal (7Ã—24) ===== */
.week-wrap{
  border:1px solid rgba(255,255,255,.14);
  border-radius:16px;
  overflow:hidden;
  background:rgba(0,0,0,.25);
}

.week-grid{
  display:grid;
  grid-template-columns:72px repeat(7, minmax(160px, 1fr));
}

.week-head{
  position:sticky;
  top:0;
  z-index:5;
  background:linear-gradient(180deg, rgba(0,0,0,.92), rgba(0,0,0,.72));
  border-bottom:1px solid rgba(255,255,255,.12);
}

.week-head .cell{
  padding:10px 10px;
  font-size:11px;
  color:rgba(255,255,255,.88);
  letter-spacing:.10em;
  text-transform:uppercase;
  border-right:1px solid rgba(255,255,255,.10);
}
.week-head .cell:first-child{
  color:rgba(255,255,255,.55);
  text-transform:none;
  letter-spacing:.06em;
}

.week-body{
  max-height:62vh;
  overflow:auto;
}

.week-body .cell{
  height:var(--slotH);
  border-right:1px solid rgba(255,255,255,.08);
  border-bottom:1px solid rgba(255,255,255,.08);
  position:relative;
}

.week-body .time{
  padding:10px 10px;
  font-size:11px;
  color:rgba(255,255,255,.55);
  background:rgba(0,0,0,.18);
}

.week-body .slot{
  background:rgba(0,0,0,.10);
}

.week-body .slot:hover{
  background:rgba(163,139,99,.06);
}

.week-col{
  position:relative;
}

.week-events-layer{
  position:absolute;
  inset:0;
  pointer-events:none;
}

.week-event{
  pointer-events:auto;
  position:absolute;
  left:6px;
  right:6px;
  border:1px solid rgba(163,139,99,.40);
  background:linear-gradient(180deg, rgba(163,139,99,.22), rgba(0,0,0,.55));
  border-radius:12px;
  padding:8px 8px 7px;
  box-shadow:0 10px 18px rgba(0,0,0,.45);
  cursor:pointer;
}
.week-event:hover{border-color:rgba(163,139,99,.95)}
.week-event .t{font-size:11px;color:#fff;font-weight:900;letter-spacing:.06em}
.week-event .d{font-size:11px;color:rgba(255,255,255,.82);margin-top:3px;line-height:1.25}
.week-event .m{font-size:10px;color:rgba(255,255,255,.65);margin-top:3px}

/* ===== Print: focar a tabela semanal exportada ===== */
@media print{
  header, aside, .tabs, .kpis, .controls, #btnPdf{ display:none !important; }
  body{ background:#fff !important; color:#111 !important; }
  main{ display:block; padding:0 !important; }
  .card{ box-shadow:none !important; background:#fff !important; border:1px solid #ddd !important; }
  .week-wrap, .week-body{ max-height:none !important; }
}
</style>
</head>

<body>

<header>
  <h1>Visitas â€” Admin</h1>
  <div class="row controls">
    <button class="ghost" id="btnPrev">â—€</button>
    <input type="date" id="refDate" style="width:auto;min-width:170px">
    <button class="ghost" id="btnNext">â–¶</button>
    <span class="mini" id="rangeLbl">â€”</span>
    <button id="btnPdf">Exportar semana (PDF)</button>
  </div>
</header>

<main>
  <!-- FORM -->
  <aside>
    <div class="card">
      <h3 style="margin:0 0 8px">Registar Visita</h3>

      <label>Consultor</label>
      <select id="consultor">
        <option>Manuel Oliveira</option>
        <option>JoÃ£o Sousa</option>
        <option>Francisco Santos</option>
        <option>RosÃ¡rio Costa</option>
        <option>Dalila Cunha</option>
        <option>Rui Quelhas</option>
      </select>

      <label>Data da visita</label>
      <input type="date" id="data">

      <label>Hora (24h)</label>
      <input type="time" id="hora">

      <label>Nome do cliente</label>
      <input id="cliente">

      <label>Ref. ImÃ³vel Garvetur</label>
      <input id="ref" placeholder="Ex.: GV-PT/1234 â€” T2+1 â€” #A12">

      <label>Partilha â€“ Nome da AgÃªncia</label>
      <input id="agencia">

      <label>Link do imÃ³vel (Partilha)</label>
      <input id="link" placeholder="https://...">

      <div class="row" style="margin-top:12px">
        <button class="primary" id="save">Guardar</button>
        <button id="reset">Limpar</button>
        <button id="del" style="display:none;border-color:rgba(255,80,80,.55);color:#ffdede">Apagar</button>
      </div>

      <div class="small" style="margin-top:10px">
        Dica: clique numa visita no calendÃ¡rio/lista para editar.
      </div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px">Filtros & Pesquisa</h3>

      <label>Filtrar por consultor</label>
      <select id="filterConsultor">
        <option value="">Todos os consultores</option>
        <option>Manuel Oliveira</option>
        <option>JoÃ£o Sousa</option>
        <option>Francisco Santos</option>
        <option>RosÃ¡rio Costa</option>
        <option>Dalila Cunha</option>
        <option>Rui Quelhas</option>
      </select>

      <label>Pesquisa global</label>
      <input id="q" placeholder="Cliente, ref, agÃªncia, link, consultor... (sem acentos)">

      <div class="row" style="margin-top:10px">
        <button class="primary" id="btnApply">Aplicar</button>
        <button id="btnClear">Limpar</button>
      </div>

      <hr class="sep">

      <div class="small">
        ExportaÃ§Ã£o PDF: apenas <b>visitas da semana visÃ­vel</b> e <b>visÃ­veis no filtro/pesquisa atuais</b>.
      </div>
    </div>
  </aside>

  <!-- CALENDÃRIO -->
  <section>
    <div class="tabs">
      <div class="tab active" data-view="month">Mensal</div>
      <div class="tab" data-view="week">Semanal (7Ã—24)</div>
      <div class="tab" data-view="day">DiÃ¡ria</div>
    </div>

    <div class="kpis" id="kpis"></div>

    <div class="card">
      <div id="calendar"></div>
    </div>
  </section>
</main>

<script>
/* ===== Storage ===== */
const LS='gpp_visitas_v1';

/* ===== State ===== */
let view='month';
let editId=null;

/* ===== Helpers ===== */
const $=id=>document.getElementById(id);
const pad2=n=>String(n).padStart(2,'0');

function norm(s){
  return String(s||'')
    .toLowerCase()
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g,'')
    .replace(/\s+/g,' ')
    .trim();
}

function load(){
  try{ return JSON.parse(localStorage.getItem(LS)||'[]'); }catch{ return []; }
}
function save(d){
  localStorage.setItem(LS, JSON.stringify(d));
}
function uid(){
  return 'V' + Math.random().toString(36).slice(2,9) + Date.now().toString(36).slice(-4);
}

function isoToday(){
  const d=new Date();
  return d.getFullYear()+'-'+pad2(d.getMonth()+1)+'-'+pad2(d.getDate());
}

function parseISO(ymd){
  const m=String(ymd||'').match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if(!m) return null;
  const dt=new Date(Date.UTC(+m[1], +m[2]-1, +m[3]));
  return isNaN(dt.getTime())?null:dt;
}

function fmtPT(ymd){
  const dt=parseISO(ymd);
  if(!dt) return ymd||'â€”';
  const local=new Date(dt.getUTCFullYear(), dt.getUTCMonth(), dt.getUTCDate());
  return local.toLocaleDateString('pt-PT');
}

function weekBoundsFromRef(refYMD){
  const dt=parseISO(refYMD) || parseISO(isoToday());
  // Monday->Sunday
  const local=new Date(dt.getUTCFullYear(), dt.getUTCMonth(), dt.getUTCDate());
  const day=local.getDay(); // 0 Sun..1 Mon
  const diffToMon = (day===0)? -6 : (1-day);
  local.setDate(local.getDate()+diffToMon);
  const start=new Date(Date.UTC(local.getFullYear(), local.getMonth(), local.getDate()));
  const end=new Date(start);
  end.setUTCDate(end.getUTCDate()+6);
  const toYMD=(d)=>d.getUTCFullYear()+'-'+pad2(d.getUTCMonth()+1)+'-'+pad2(d.getUTCDate());
  return {start, end, startYMD:toYMD(start), endYMD:toYMD(end)};
}

function addDays(ymd, n){
  const dt=parseISO(ymd); if(!dt) return ymd;
  const d=new Date(dt);
  d.setUTCDate(d.getUTCDate()+n);
  return d.getUTCFullYear()+'-'+pad2(d.getUTCMonth()+1)+'-'+pad2(d.getUTCDate());
}

function applyFilters(all){
  const f=$('filterConsultor').value;
  const q=norm($('q').value);

  return all.filter(v=>{
    if(f && v.consultor!==f) return false;
    if(q){
      const blob=norm(JSON.stringify(v));
      if(!blob.includes(q)) return false;
    }
    return true;
  });
}

function isInRange(ymd, aYMD, bYMD){
  return String(ymd||'') >= String(aYMD) && String(ymd||'') <= String(bYMD);
}

function safeHref(url){
  const s=String(url||'').trim();
  if(!s) return '';
  // mantÃ©m simples, sem validaÃ§Ãµes agressivas
  return s;
}

/* ===== Render KPIs (visÃ­veis no filtro/pesquisa) ===== */
function renderKPIs(visibleList){
  const byCons={};
  visibleList.forEach(v=>{
    byCons[v.consultor]=(byCons[v.consultor]||0)+1;
  });

  const total = visibleList.length;

  $('kpis').innerHTML =
    `<div class="kpi"><b>${total}</b>Visitas (visÃ­veis)</div>` +
    Object.entries(byCons).map(([k,v])=>`<div class="kpi"><b>${v}</b>${k}</div>`).join('');
}

/* ===== UI: carregar/editar ===== */
function startEdit(v){
  editId=v.id;
  $('consultor').value = v.consultor || $('consultor').value;
  $('data').value = v.data || '';
  $('hora').value = v.hora || '';
  $('cliente').value = v.cliente || '';
  $('ref').value = v.ref || '';
  $('agencia').value = v.agencia || '';
 const linkInput = $('link');
linkInput.value = v.link || '';

if(v.link){
  linkInput.style.cursor = 'pointer';
  linkInput.title = 'Abrir link do imÃ³vel';
  linkInput.onclick = () => {
    window.open(v.link, '_blank', 'noopener');
  };
}else{
  linkInput.onclick = null;
}
  $('del').style.display = 'inline-flex';
}

function clearEdit(){
  editId=null;
  $('data').value = isoToday();
  $('hora').value = '';
  $('cliente').value = '';
  $('ref').value = '';
  $('agencia').value = '';
  $('link').value = '';
  $('del').style.display = 'none';
}

/* ===== Month list view ===== */
function renderMonth(visibleList){
  const ref = $('refDate').value;
  const m = String(ref||isoToday()).slice(0,7); // YYYY-MM
  const list = visibleList.filter(v=>String(v.data||'').slice(0,7)===m);

  const box=document.createElement('div');
  box.innerHTML = list
    .slice()
    .sort((a,b)=>(a.data+a.hora).localeCompare(b.data+b.hora))
    .map(v=>`
      <div class="event" data-id="${v.id}">
        <b>${fmtPT(v.data)} ${v.hora || ''}</b><br>
        ${escapeHtml(v.cliente||'â€”')} Â· ${escapeHtml(v.consultor||'â€”')}<br>
        <span class="small">${escapeHtml(v.ref||'â€”')} Â· ${escapeHtml(v.agencia||'â€”')}</span>
      </div>
    `).join('') || '<div class="small">Sem visitas neste mÃªs (com o filtro/pesquisa atuais).</div>';

  box.querySelectorAll('.event').forEach(el=>{
    el.addEventListener('click', ()=>{
      const id=el.getAttribute('data-id');
      const v=load().find(x=>x.id===id);
      if(v) startEdit(v);
    });
  });

  $('calendar').innerHTML='';
  $('calendar').appendChild(box);
}

/* ===== Day view ===== */
function renderDay(visibleList){
  const day = $('refDate').value || isoToday();
  const list = visibleList
    .filter(v=>String(v.data||'')===day)
    .slice()
    .sort((a,b)=>(a.hora||'').localeCompare(b.hora||''));

  const box=document.createElement('div');
  box.innerHTML = `
    <div class="small" style="margin-bottom:10px"><b>Dia:</b> ${fmtPT(day)}</div>
    ${list.map(v=>`
      <div class="event" data-id="${v.id}">
        <b>${v.hora || 'â€”'}</b> â€” ${escapeHtml(v.cliente||'â€”')}<br>
        <span class="small">${escapeHtml(v.consultor||'â€”')} Â· ${escapeHtml(v.ref||'â€”')} Â· ${escapeHtml(v.agencia||'â€”')}</span>
      </div>
    `).join('') || '<div class="small">Sem visitas neste dia (com o filtro/pesquisa atuais).</div>'}
  `;

  box.querySelectorAll('.event').forEach(el=>{
    el.addEventListener('click', ()=>{
      const id=el.getAttribute('data-id');
      const v=load().find(x=>x.id===id);
      if(v) startEdit(v);
    });
  });

  $('calendar').innerHTML='';
  $('calendar').appendChild(box);
}

/* ===== Week grid view (7Ã—24) ===== */
function renderWeek(visibleList){
  const ref = $('refDate').value || isoToday();
  const wb = weekBoundsFromRef(ref);
  $('rangeLbl').textContent = `${fmtPT(wb.startYMD)} â†’ ${fmtPT(wb.endYMD)}`;

  // week list (for positioning)
  const weekList = visibleList
    .filter(v=>isInRange(v.data, wb.startYMD, wb.endYMD))
    .slice();

  // build shell
  const wrap=document.createElement('div');
  wrap.className='week-wrap';

  const head=document.createElement('div');
  head.className='week-grid week-head';

  const names=['Hora','Seg','Ter','Qua','Qui','Sex','SÃ¡b','Dom'];

   // header row
  names.forEach((nm, i)=>{
    const cell=document.createElement('div');
    cell.className='cell';
    if(i===0){
      // Canto superior esquerdo: nÃ£o repetir datas aqui (jÃ¡ aparecem nos dias)
      cell.innerHTML = `<div style="font-size:11px;opacity:.75">Horas</div>`;
    }else{
      const dayYMD=addDays(wb.startYMD, i-1);
      cell.innerHTML = `<div>${nm}</div><div style="opacity:.75;margin-top:2px">${fmtPT(dayYMD)}</div>`;
    }
    head.appendChild(cell);
  });

  const body=document.createElement('div');
  body.className='week-body';

  const grid=document.createElement('div');
  grid.className='week-grid';

  // create columns and a layer per day to position events
  const dayLayers=[];

  // 24 rows
  for(let h=0; h<24; h++){
    // time label cell
    const t=document.createElement('div');
    t.className='cell time';
    t.textContent = pad2(h)+':00';
    grid.appendChild(t);

    // 7 day cells
    for(let d=0; d<7; d++){
      const c=document.createElement('div');
      c.className='cell slot week-col';
      c.setAttribute('data-day', String(d)); // 0..6

      // only create one layer per column (first hour row)
      if(h===0){
        const layer=document.createElement('div');
        layer.className='week-events-layer';
        c.appendChild(layer);
        dayLayers[d]=layer;
      }
      grid.appendChild(c);
    }
  }

  body.appendChild(grid);
  wrap.appendChild(head);
  wrap.appendChild(body);

 // position events (com duraÃ§Ã£o + overlap lado-a-lado)
const slotH = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--slotH')) || 46;

// Agrupa por dia (0..6) e prepara eventos com start/end em minutos
const byDay = Array.from({length:7}, ()=>[]);
weekList.forEach(v=>{
  const dayIndex = dayIndexFromYMD(wb.startYMD, v.data);
  if(dayIndex==null || dayIndex<0 || dayIndex>6) return;

  const hm = String(v.hora||'').trim().match(/^(\d{2}):(\d{2})$/);
  if(!hm) return;

  const h = +hm[1], m = +hm[2];
  if(isNaN(h) || h<0 || h>23 || isNaN(m) || m<0 || m>59) return;

  const startMin = h*60 + m;
  const durMin = Math.max(10, parseInt(v.durMin||60, 10) || 60);
  const endMin = Math.min(24*60, startMin + durMin);

  byDay[dayIndex].push({
    v,
    startMin,
    endMin,
    lane: 0,
    lanes: 1
  });
});

// atribuir lanes para overlaps (interval partitioning simples)
function layoutDay(events){
  events.sort((a,b)=> a.startMin - b.startMin || a.endMin - b.endMin);

  const active = [];     // {endMin, lane}
  const freeLanes = [];  // lanes disponÃ­veis
  let nextLane = 0;

  const groups = [];
  let g = null;

  function closeGroup(){
    if(g){
      const lanesTotal = g.maxLane + 1;
      g.items.forEach(it => it.lanes = lanesTotal);
      groups.push(g);
      g = null;
    }
  }

  for(const e of events){
    // libertar lanes terminadas
    for(let i=active.length-1;i>=0;i--){
      if(active[i].endMin <= e.startMin){
        freeLanes.push(active[i].lane);
        active.splice(i,1);
      }
    }

    // novo grupo quando nÃ£o hÃ¡ ativos
    if(active.length===0){
      closeGroup();
      g = { items: [], maxLane: 0 };
    }

    // escolher lane
    let lane;
    if(freeLanes.length){
      lane = freeLanes.shift();
    }else{
      lane = nextLane++;
    }
    e.lane = lane;

    // atualizar grupo
    if(g){
      g.items.push(e);
      g.maxLane = Math.max(g.maxLane, lane);
    }

    active.push({ endMin: e.endMin, lane });
    active.sort((a,b)=>a.endMin-b.endMin);
  }

  closeGroup();
  return events;
}

// Render por dia com lanes (overlap)
for(let d=0; d<7; d++){
  const dayEvents = layoutDay(byDay[d]);
  const layer = dayLayers[d];
  if(!layer) continue;

  dayEvents.forEach(e=>{
    const v = e.v;

    const top = (e.startMin / 60) * slotH;
    const height = Math.max(34, ((e.endMin - e.startMin) / 60) * slotH - 10);

    const lanes = Math.max(1, e.lanes || 1);
    const lane = Math.min(lanes-1, e.lane || 0);
    const gap = 6;

    const laneWidth = (100 / lanes);
    const leftPct = laneWidth * lane;
    const rightPct = 100 - laneWidth * (lane + 1);

    const el=document.createElement('div');
    el.className='week-event';
    el.style.top = top + 'px';
    el.style.height = height + 'px';
    el.style.left = `calc(${leftPct}% + ${gap}px)`;
    el.style.right = `calc(${rightPct}% + ${gap}px)`;

 el.innerHTML = `
  <div class="t">${escapeHtml(v.hora||'â€”')} Â· ${escapeHtml(v.consultor||'â€”')}</div>
  <div class="d">${escapeHtml(v.cliente||'â€”')}</div>
  <div class="m">
    ${escapeHtml(v.ref||'â€”')} Â· ${escapeHtml(v.agencia||'â€”')} Â· ${escapeHtml(String(v.durMin||60)+' min')}
    ${v.link ? `<br><a data-open-link href="${escapeHtml(v.link)}" target="_blank"
      style="color:#A38B63;text-decoration:none;font-weight:700">Abrir imÃ³vel</a>` : ''}
  </div>
`;

/* ðŸ‘‰ PASSO 3 â€” ESTE BLOCO TEM DE FICAR AQUI */
const a = el.querySelector('a[data-open-link]');
if(a){
  a.setAttribute('rel','noopener noreferrer');
  a.addEventListener('click', (ev)=>{
    ev.stopPropagation(); // sÃ³ isto (nÃ£o editar)
    // NÃƒO usar preventDefault, NÃƒO usar window.open
  });
}
/* clique no cartÃ£o = editar */
el.addEventListener('click', (ev)=>{
  // se clicou no link, nÃ£o editar
  if(ev.target && ev.target.closest && ev.target.closest('a')) return;

  const full = load().find(x=>x.id===v.id);
  if(full) startEdit(full);
});

layer.appendChild(el);
  });
}
  // if empty
  if(weekList.length===0){
    const empty=document.createElement('div');
    empty.className='small';
    empty.style.padding='10px';
    empty.textContent='Sem visitas nesta semana (com o filtro/pesquisa atuais).';
    wrap.appendChild(empty);
  }

  $('calendar').innerHTML='';
  $('calendar').appendChild(wrap);
}

/* ===== Export Weekly PDF (visible week + current filters) ===== */
function exportWeekPDF(){
  // forÃ§a a semana atual visÃ­vel
  const ref = $('refDate').value || isoToday();
  const wb = weekBoundsFromRef(ref);

  const all = load();
  const visible = applyFilters(all);

  const weekList = visible
    .filter(v=>isInRange(v.data, wb.startYMD, wb.endYMD))
    .slice()
    .sort((a,b)=>(a.data + (a.hora||'')).localeCompare(b.data + (b.hora||'')));

  // build a print window
  const w = window.open('', '_blank');
  if(!w){ alert('O navegador bloqueou a janela de impressÃ£o. Permita popups para este site.'); return; }

  const title = `Agenda semanal â€” ${fmtPT(wb.startYMD)} a ${fmtPT(wb.endYMD)}`;
  const f = $('filterConsultor').value;
  const q = $('q').value.trim();

  const rows = weekList.map(v=>{
    const link = safeHref(v.link);
    return `
      <tr>
        <td>${escapeHtml(fmtPT(v.data))}</td>
        <td>${escapeHtml(v.hora||'â€”')}</td>
        <td>${escapeHtml(v.consultor||'â€”')}</td>
        <td>${escapeHtml(v.cliente||'â€”')}</td>
        <td>${escapeHtml(v.ref||'â€”')}</td>
        <td>${escapeHtml(v.agencia||'â€”')}</td>
        <td>${link ? `<a href="${escapeHtml(link)}">${escapeHtml(link)}</a>` : 'â€”'}</td>
      </tr>
    `;
  }).join('');

  w.document.open();
  w.document.write(`
<!doctype html>
<html lang="pt-PT">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>${escapeHtml(title)}</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:18px;color:#111}
  h1{margin:0 0 6px;font-size:18px;letter-spacing:.06em}
  .sub{color:#555;font-size:12px;margin-bottom:12px}
  table{width:100%;border-collapse:collapse;font-size:12px}
  th,td{border:1px solid #ddd;padding:8px;vertical-align:top}
  th{background:#f5f5f5;text-align:left}
  a{color:#111}
  .meta{margin-top:10px;color:#666;font-size:11px}
  @page{margin:12mm}
</style>
</head>
<body>
  <h1>${escapeHtml(title)}</h1>
  <div class="sub">Garvetur Porto Pro â€” Visitas (Admin)</div>

  <div class="meta">
    <b>Filtro consultor:</b> ${escapeHtml(f || 'â€”')} &nbsp; | &nbsp;
    <b>Pesquisa:</b> ${escapeHtml(q || 'â€”')} &nbsp; | &nbsp;
    <b>Total visitas na semana:</b> ${weekList.length}
  </div>

  <table>
    <thead>
      <tr>
        <th>Data</th>
        <th>Hora</th>
        <th>Consultor</th>
        <th>Cliente</th>
        <th>Ref. Garvetur</th>
        <th>AgÃªncia</th>
        <th>Link</th>
      </tr>
    </thead>
    <tbody>
      ${rows || `<tr><td colspan="7">Sem visitas nesta semana (com o filtro/pesquisa atuais).</td></tr>`}
    </tbody>
  </table>
</body>
</html>
  `);
  w.document.close();

  // dÃ¡ tempo para renderizar e imprime
  w.focus();
  setTimeout(()=>{ w.print(); }, 250);
}

/* ===== Utilities ===== */
function dayIndexFromYMD(startMonYMD, ymd){
  if(!startMonYMD || !ymd) return null;
  // compare by incremental days
  let cur=startMonYMD;
  for(let i=0;i<7;i++){
    if(cur===ymd) return i;
    cur=addDays(cur,1);
  }
  return null;
}

function escapeHtml(s){
  return String(s ?? '')
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'",'&#039;');
}

/* ===== Main render dispatcher ===== */
function render(){
  const all = load();
  const visible = applyFilters(all);

  // KPIs globais do filtro/pesquisa (nÃ£o dependem da vista)
  renderKPIs(visible);

  // range label atual (semana do refDate)
  const wb = weekBoundsFromRef($('refDate').value || isoToday());
  $('rangeLbl').textContent = `${fmtPT(wb.startYMD)} â†’ ${fmtPT(wb.endYMD)}`;

  if(view==='week') renderWeek(visible);
  else if(view==='day') renderDay(visible);
  else renderMonth(visible);
}

/* ===== Events: Tabs ===== */
document.querySelectorAll('.tab').forEach(t=>{
  t.addEventListener('click', ()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    view = t.getAttribute('data-view') || 'month';
    render();
  });
});

/* ===== Buttons ===== */
$('btnApply').addEventListener('click', render);
$('btnClear').addEventListener('click', ()=>{
  $('filterConsultor').value='';
  $('q').value='';
  render();
});
$('filterConsultor').addEventListener('change', render);
$('q').addEventListener('input', ()=>{
  clearTimeout(window.__tq);
  window.__tq = setTimeout(render, 140);
});

$('btnPdf').addEventListener('click', exportWeekPDF);

/* ===== Date navigation ===== */
$('refDate').addEventListener('change', render);

$('btnPrev').addEventListener('click', ()=>{
  const ref = $('refDate').value || isoToday();
  if(view==='day') $('refDate').value = addDays(ref, -1);
  else $('refDate').value = addDays(ref, -7);
  render();
});
$('btnNext').addEventListener('click', ()=>{
  const ref = $('refDate').value || isoToday();
  if(view==='day') $('refDate').value = addDays(ref, +1);
  else $('refDate').value = addDays(ref, +7);
  render();
});

/* ===== CRUD ===== */
$('save').addEventListener('click', ()=>{
  const rec={
    id: editId || uid(),
    consultor: $('consultor').value,
    data: ($('data').value || '').trim(),
    hora: ($('hora').value || '').trim(),
    cliente: ($('cliente').value || '').trim(),
    ref: ($('ref').value || '').trim(),
    agencia: ($('agencia').value || '').trim(),
    link: ($('link').value || '').trim(),
    updatedAt: new Date().toISOString(),
    createdAt: editId ? undefined : new Date().toISOString()
  };

  if(!rec.data){ alert('ObrigatÃ³rio: Data da visita.'); return; }
  if(!rec.hora){ alert('ObrigatÃ³rio: Hora da visita.'); return; }
  if(!rec.cliente){ alert('ObrigatÃ³rio: Nome do cliente.'); return; }

  let all=load().filter(v=>v.id!==rec.id);
  all.push(rec);
  save(all);

  clearEdit();
  render();
});

$('reset').addEventListener('click', clearEdit);

$('del').addEventListener('click', ()=>{
  if(!editId) return;
  if(!confirm('Confirmar: apagar esta visita?')) return;
  const all=load().filter(v=>v.id!==editId);
  save(all);
  clearEdit();
  render();
});

/* ===== Boot ===== */
(function boot(){
  $('refDate').value = isoToday();
  $('data').value = isoToday();
  render();
})();
</script>

</body>
</html>
