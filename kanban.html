<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<title>Garvetur Porto Pro — Leads (Kanban)</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<style>
  :root{--gold:#A38B63;--bg:#0E0E0E;--panel:#131313;--text:#fff;--muted:#bdbdbd;}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;}
  header{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.1);background:#0F0F0F;}
  nav a{margin-right:6px;text-decoration:none;color:#ddd;border:1px solid rgba(255,255,255,.12);padding:6px 10px;border-radius:8px;}
  nav a.active{background:var(--gold);color:#111;border-color:var(--gold);font-weight:600;}
  .actions{display:flex;gap:8px;}
  .btn{background:transparent;border:1px solid rgba(163,139,99,.5);color:#fff;padding:6px 9px;border-radius:8px;cursor:pointer;font-size:12px;}
  .wrap{display:grid;grid-template-columns:1fr;gap:12px;padding:12px;}
  .panel{background:var(--panel);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px;}
  .panel h3{margin:0 0 8px 0;font-size:13px;color:#eaeaea;border-bottom:1px solid rgba(255,255,255,.06);padding-bottom:6px;}
  label{font-size:12px;color:#ddd;display:block;margin:4px 0 2px;}
  input,select,textarea{width:100%;background:#0E0E0E;color:#fff;border:1px solid rgba(255,255,255,.18);border-radius:8px;padding:8px 10px;}
  .form-grid{
    display:grid;
    grid-template-columns:repeat(6,1fr);
    gap:8px;align-items:end
  }
  .span2{grid-column:span 2}
  .span3{grid-column:span 3}
  .span6{grid-column:span 6}
  .board{display:grid;grid-template-columns:repeat(5,1fr);gap:12px;height:calc(100vh - 280px);}
  .col{background:var(--panel);border:1px solid rgba(255,255,255,.08);border-radius:12px;display:flex;flex-direction:column;overflow:auto;}
  .col h3{margin:0;padding:10px;border-bottom:1px solid rgba(255,255,255,.06);font-size:13px;color:#eaeaea;}
  .lane{padding:10px;display:flex;flex-direction:column;gap:8px;}
  .card{background:#0E0E0E;border:1px solid rgba(255,255,255,.1);border-radius:10px;padding:8px;}
  .card .t{font-weight:600;margin-bottom:4px;}
  .card .m{font-size:12px;color:#cfcfcf;}
  .help{padding:8px 12px;color:#ddd;font-size:12px;border-top:1px dashed rgba(255,255,255,.15);}
  .hint{font-size:11px;color:#bdbdbd}
  @media(max-width:1400px){.board{grid-template-columns:repeat(4,1fr)}}
  @media(max-width:1100px){.board{grid-template-columns:repeat(3,1fr)}}
  @media(max-width:900px){
    .form-grid{grid-template-columns:1fr}
    .span2,.span3,.span6{grid-column:span 1}
    .board{grid-template-columns:1fr;height:auto;min-height:60vh;}
  }
</style>
</head>
<body>
<header>
  <div style="display:flex;align-items:center;gap:10px;">
    <strong style="color:#FFD166">Garvetur Porto Pro</strong>
    <nav>
      <a href="./index.html">Mapa</a>
      <a class="active" href="./kanban.html">Leads</a>
      <a href="./angariacoes.html">Angariações</a>
      <a href="./dashboard.html">Dashboard</a>
    </nav>
  </div>
  <div class="actions">
    <button id="seed" class="btn">Carregar dados de exemplo (10)</button>
    <button id="clear" class="btn">Limpar tudo</button>
  </div>
</header>

<div class="wrap">
  <div class="panel">
    <h3>Nova lead</h3>
    <div class="form-grid">
      <div class="span2">
        <label>Título</label>
        <input id="f_titulo" placeholder="Ex.: T3 Boavista – Investidor NL">
      </div>
      <div>
        <label>Consultor</label>
        <select id="f_consultor"></select>
      </div>
      <div>
        <label>Valor (€)</label>
        <input id="f_valor" type="number" inputmode="decimal" placeholder="Ex.: 620000">
      </div>

      <div>
        <label>Cliente</label>
        <input id="f_cliente" placeholder="Nome do cliente">
      </div>
      <div>
        <label>Contacto</label>
        <input id="f_contacto" placeholder="+351 ...">
      </div>
      <div>
        <label>Email</label>
        <input id="f_email" placeholder="email@dominio.pt">
      </div>

      <div>
        <label>Imóvel</label>
        <input id="f_imovel" placeholder="Tipologia / Ref. / Empreendimento">
      </div>
      <div>
        <label>Zona</label>
        <input id="f_zona" placeholder="Ex.: Foz, Boavista, Gaia...">
      </div>
      <div>
        <label>Capitais próprios (€)</label>
        <input id="f_capitais" type="number" inputmode="decimal" placeholder="Ex.: 200000">
      </div>

      <div>
        <label>Financiamento B.</label>
        <select id="f_finb">
          <option value="">(por definir)</option>
          <option>Sim</option>
          <option>Não</option>
          <option>Em análise</option>
        </select>
      </div>
      <div>
        <label>Perfil</label>
        <select id="f_perfil">
          <option value="">(por definir)</option>
          <option>Comprador</option>
          <option>Vendedor</option>
        </select>
      </div>
      <div>
        <label>Tipo de cliente</label>
        <select id="f_tipo">
          <option value="">(por definir)</option>
          <option>Investidor</option>
          <option>Cliente final</option>
        </select>
      </div>

      <div>
        <label>Tem casa para vender?</label>
        <select id="f_temcasa">
          <option value="">(por definir)</option>
          <option>Sim</option>
          <option>Não</option>
        </select>
      </div>
      <div>
        <label>Urgência / Planta</label>
        <select id="f_urg">
          <option value="">(por definir)</option>
          <option>Urgente</option>
          <option>Pode comprar em planta</option>
          <option>Sem urgência</option>
        </select>
      </div>
      <div>
        <label>Acompanhado por outro agente?</label>
        <select id="f_outroag">
          <option value="">(por definir)</option>
          <option>Sim</option>
          <option>Não</option>
        </select>
      </div>

      <div>
        <label>Já fez visitas?</label>
        <select id="f_visitas">
          <option value="">(por definir)</option>
          <option>Sim</option>
          <option>Não</option>
        </select>
      </div>
      <div>
        <label>1.ª habitação?</label>
        <select id="f_primeira">
          <option value="">(por definir)</option>
          <option>Sim</option>
          <option>Não</option>
        </select>
      </div>
      <div>
        <label>Uso</label>
        <select id="f_uso">
          <option value="">(por definir)</option>
          <option>Habitação própria</option>
          <option>Habitação secundária</option>
        </select>
      </div>

      <div class="span6">
        <label>Notas <span class="hint">(informação adicional, preferências, timing)</span></label>
        <textarea id="f_notas" rows="3" placeholder="Observações relevantes"></textarea>
      </div>

      <div style="display:flex;gap:8px;" class="span6">
        <button id="add" class="btn">+ Adicionar</button>
        <button id="reset" class="btn">Limpar</button>
      </div>
    </div>
  </div>

  <div class="board" id="board"></div>
  <div class="help">Dica: arraste as cards entre colunas. Duplo-clique para editar; tecla <em>Delete</em> remove.</div>
</div>

<script>
const LS_KEY = 'gpp_leads_v3';
const COLUMNS = ["Novo","Em contacto","Qualificado","Proposta","Fecho"];
const CONSULTORS = [
  "Rui Quelhas",
  "Manuel Oliveira",
  "João Sousa",
  "Francisco dos Santos",
  "Rosário Vasconcelos",
  "Armanda Meireles",
  "Audrey Lucas",
  "Outro…"
];

function load(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||'{}'); }catch(e){ return {}; } }
function save(data){ localStorage.setItem(LS_KEY, JSON.stringify(data)); }
function ensureModel(d){ COLUMNS.forEach(c=>{ if(!Array.isArray(d[c])) d[c]=[]; }); return d; }

function fillConsultorSelect(){
  const sel = document.getElementById('f_consultor');
  sel.innerHTML = CONSULTORS.map(n=>`<option value="${n}">${n}</option>`).join('');
  sel.value = CONSULTORS[0];
}

function summaryLine(c){
  const parts = [];
  if(c.consultor) parts.push(c.consultor);
  if(c.valor) parts.push(c.valor+'€');
  if(c.zona) parts.push(c.zona);
  if(c.perfil) parts.push(c.perfil);
  if(c.tipo) parts.push(c.tipo);
  return parts.join(' · ');
}

function tooltip(c){
  const rows = [
    ['Cliente', c.cliente || '—'],
    ['Contacto', c.contacto || '—'],
    ['Email', c.email || '—'],
    ['Imóvel', c.imovel || '—'],
    ['Zona', c.zona || '—'],
    ['Capitais próprios', c.capitais? c.capitais+'€' : '—'],
    ['Financiamento B.', c.finb || '—'],
    ['Perfil', c.perfil || '—'],
    ['Tipo', c.tipo || '—'],
    ['Tem casa para vender', c.temcasa || '—'],
    ['Urgência/Planta', c.urg || '—'],
    ['Acomp. por outro agente', c.outroag || '—'],
    ['Já fez visitas', c.visitas || '—'],
    ['1.ª habitação', c.primeira || '—'],
    ['Uso', c.uso || '—'],
    ['Notas', c.notas || '—']
  ];
  return rows.map(r=> `${r[0]}: ${r[1]}`).join('\n');
}

function cardEl(card, col, idx){
  const d = document.createElement('div');
  d.className='card'; d.draggable=true; d.tabIndex=0; d.title = tooltip(card);
  d.innerHTML = `<div class="t">${card.titulo || '(Sem título)'}</div>
                 <div class="m">${summaryLine(card)}</div>`;
  d.ondblclick = ()=> editCard(col, idx);
  d.onkeydown = (e)=>{ if(e.key==='Delete'){ removeCard(col, idx); } };
  return d;
}

function render(){
  const data = ensureModel(load());
  const board = document.getElementById('board');
  board.innerHTML='';
  COLUMNS.forEach(col=>{
    const el = document.createElement('div');
    el.className='col';
    el.innerHTML = `<h3>${col} (${data[col].length})</h3><div class="lane" data-col="${col}"></div>`;
    const lane = el.querySelector('.lane');
    data[col].forEach((card,i)=> lane.appendChild(cardEl(card, col, i)));
    board.appendChild(el);
  });
  enableDnD();
}

function enableDnD(){
  document.querySelectorAll('.lane .card').forEach(card=>{
    card.addEventListener('dragstart', ev=>{
      const lane = card.closest('.lane');
      const col = lane.dataset.col;
      const idx = Array.from(lane.children).indexOf(card);
      ev.dataTransfer.setData('text/plain', JSON.stringify({col, idx}));
    });
  });
  document.querySelectorAll('.lane').forEach(lane=>{
    lane.addEventListener('dragover', ev=> ev.preventDefault());
    lane.addEventListener('drop', ev=>{
      ev.preventDefault();
      const src = JSON.parse(ev.dataTransfer.getData('text/plain'));
      const dstCol = lane.dataset.col;
      const data = ensureModel(load());
      const [item] = data[src.col].splice(src.idx,1);
      data[dstCol].unshift(item);
      save(data); render();
    });
  });
}

// helpers
function getVal(id){ return document.getElementById(id).value.trim(); }
function getSel(id){ return document.getElementById(id).value; }
function isEmail(s){ return !!s && /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s); }

// CRUD
function addCard(){
  const titulo = getVal('f_titulo');
  if(!titulo) return alert('Indique um título.');

  let consultor = getSel('f_consultor');
  if(consultor === 'Outro…'){
    const alt = prompt('Nome do consultor:','');
    if(!alt) return alert('Indique o nome do consultor.');
    consultor = alt.trim();
  }

  const email = getVal('f_email');
  if(email && !isEmail(email)) return alert('Email inválido.');

  const card = {
    titulo,
    consultor,
    valor: getVal('f_valor'),
    cliente: getVal('f_cliente'),
    contacto: getVal('f_contacto'),
    email,
    imovel: getVal('f_imovel'),
    zona: getVal('f_zona'),
    capitais: getVal('f_capitais'),
    finb: getSel('f_finb'),
    perfil: getSel('f_perfil'),
    tipo: getSel('f_tipo'),
    temcasa: getSel('f_temcasa'),
    urg: getSel('f_urg'),
    outroag: getSel('f_outroag'),
    visitas: getSel('f_visitas'),
    primeira: getSel('f_primeira'),
    uso: getSel('f_uso'),
    notas: getVal('f_notas')
  };

  const data = ensureModel(load());
  data["Novo"].unshift(card);
  save(data); render(); resetForm();
}

function resetForm(){
  const ids = ['f_titulo','f_valor','f_cliente','f_contacto','f_email','f_imovel','f_zona','f_capitais','f_notas'];
  ids.forEach(id=> document.getElementById(id).value='');
  ['f_finb','f_perfil','f_tipo','f_temcasa','f_urg','f_outroag','f_visitas','f_primeira','f_uso'].forEach(id=> document.getElementById(id).value='');
  document.getElementById('f_consultor').value = CONSULTORS[0];
}

function editCard(col, idx){
  const data = ensureModel(load());
  const c = data[col][idx];

  const titulo   = prompt('Título:', c.titulo||'') ?? c.titulo;
  let consultor  = prompt('Consultor:', c.consultor||'') ?? c.consultor;
  const valor    = prompt('Valor (€):', c.valor||'') ?? c.valor;

  const cliente  = prompt('Cliente:', c.cliente||'') ?? c.cliente;
  const contacto = prompt('Contacto:', c.contacto||'') ?? c.contacto;
  const email    = prompt('Email:', c.email||'') ?? c.email;

  const imovel   = prompt('Imóvel:', c.imovel||'') ?? c.imovel;
  const zona     = prompt('Zona:', c.zona||'') ?? c.zona;
  const capitais = prompt('Capitais próprios (€):', c.capitais||'') ?? c.capitais;

  const finb     = prompt('Financiamento B. (Sim/Não/Em análise):', c.finb||'') ?? c.finb;
  const perfil   = prompt('Perfil (Comprador/Vendedor):', c.perfil||'') ?? c.perfil;
  const tipo     = prompt('Tipo (Investidor/Cliente final):', c.tipo||'') ?? c.tipo;

  const temcasa  = prompt('Tem casa para vender (Sim/Não):', c.temcasa||'') ?? c.temcasa;
  const urg      = prompt('Urgência/Planta:', c.urg||'') ?? c.urg;
  const outroag  = prompt('Acomp. por outro agente (Sim/Não):', c.outroag||'') ?? c.outroag;

  const visitas  = prompt('Já fez visitas (Sim/Não):', c.visitas||'') ?? c.visitas;
  const primeira = prompt('1.ª habitação (Sim/Não):', c.primeira||'') ?? c.primeira;
  const uso      = prompt('Uso (Hab. própria/secundária):', c.uso||'') ?? c.uso;

  const notas    = prompt('Notas:', c.notas||'') ?? c.notas;

  data[col][idx] = {titulo, consultor, valor, cliente, contacto, email, imovel, zona, capitais, finb, perfil, tipo, temcasa, urg, outroag, visitas, primeira, uso, notas};
  save(data); render();
}

function removeCard(col, idx){
  if(!confirm('Remover esta lead?')) return;
  const data = ensureModel(load());
  data[col].splice(idx,1);
  save(data); render();
}

// Seed demo (10) — com novos campos
function seedDemo(){
  if(!confirm('Carregar 10 leads de exemplo? (substitui as atuais)')) return;
  const ex = {
    "Novo": [
      {titulo:"T2 Matosinhos — Arrendamento", consultor:"Armanda Meireles", valor:"1200",
       cliente:"Daniela Lopes", contacto:"+351 9xx", email:"", imovel:"T2", zona:"Matosinhos",
       capitais:"", finb:"", perfil:"Comprador", tipo:"Cliente final", temcasa:"Não", urg:"Urgente",
       outroag:"Não", visitas:"Não", primeira:"Sim", uso:"Habitação própria", notas:"Procura perto do metro"},
      {titulo:"T3 Boavista — Venda", consultor:"Manuel Oliveira", valor:"620000",
       cliente:"Miguel Duarte", contacto:"+351 9xx", email:"", imovel:"T3", zona:"Boavista",
       capitais:"300000", finb:"Em análise", perfil:"Comprador", tipo:"Investidor", temcasa:"Não",
       urg:"Sem urgência", outroag:"Não", visitas:"Não", primeira:"Não", uso:"Habitação secundária", notas:"Rendimento mínimo 4%"}
    ],
    "Em contacto": [
      {titulo:"Terreno Gondomar — Investidor", consultor:"João Sousa", valor:"",
       cliente:"IF Capital", contacto:"+351 2xx", email:"if@cap.pt", imovel:"Terreno", zona:"Gondomar",
       capitais:"1000000", finb:"Não", perfil:"Comprador", tipo:"Investidor", temcasa:"Não",
       urg:"Sem urgência", outroag:"Não", visitas:"Não", primeira:"", uso:"", notas:"Interessa BTR"}
    ],
    "Qualificado": [
      {titulo:"T1 Cedofeita — Estudante FR", consultor:"Audrey Lucas", valor:"235000",
       cliente:"Claire M.", contacto:"+33 6xx", email:"", imovel:"T1", zona:"Cedofeita",
       capitais:"235000", finb:"Não", perfil:"Comprador", tipo:"Cliente final", temcasa:"Não",
       urg:"P. em planta", outroag:"Não", visitas:"Não", primeira:"Não", uso:"Habitação secundária", notas:"Entrada 2026"},
      {titulo:"Loja Foz — Rent Yield", consultor:"Manuel Oliveira", valor:"450000",
       cliente:"TGP Retail", contacto:"+351 2xx", email:"", imovel:"Loja", zona:"Foz",
       capitais:"450000", finb:"Não", perfil:"Comprador", tipo:"Investidor", temcasa:"Não",
       urg:"Sem urgência", outroag:"Não", visitas:"Sim", primeira:"", uso:"", notas:"Yield alvo 6%"}
    ],
    "Proposta": [
      {titulo:"T4 Gaia — 1ª habitação", consultor:"Armanda Meireles", valor:"395000",
       cliente:"Família Pires", contacto:"+351 9xx", email:"", imovel:"T4", zona:"V.N. Gaia",
       capitais:"120000", finb:"Sim", perfil:"Comprador", tipo:"Cliente final", temcasa:"Sim",
       urg:"Urgente", outroag:"Não", visitas:"Sim", primeira:"Sim", uso:"Habitação própria", notas:"Proposta enviada 05/11"},
      {titulo:"Prédio Baixa — BTR", consultor:"João Sousa", valor:"",
       cliente:"Fundo Norte", contacto:"+351 2xx", email:"", imovel:"Prédio", zona:"Baixa Porto",
       capitais:"", finb:"", perfil:"Comprador", tipo:"Investidor", temcasa:"Não",
       urg:"Sem urgência", outroag:"Não", visitas:"Não", primeira:"", uso:"", notas:"Aguardam pipeline 2026"}
    ],
    "Fecho": [
      {titulo:"T2 Antas — Chaves esta semana", consultor:"Manuel Oliveira", valor:"285000",
       cliente:"Raquel S.", contacto:"+351 9xx", email:"", imovel:"T2", zona:"Antas",
       capitais:"85000", finb:"Sim", perfil:"Comprador", tipo:"Cliente final", temcasa:"Não",
       urg:"Urgente", outroag:"Não", visitas:"Sim", primeira:"Sim", uso:"Habitação própria", notas:"Chaves 6ª feira"},
      {titulo:"T3 Leça — Proc. financiamento", consultor:"Audrey Lucas", valor:"",
       cliente:"Família P.", contacto:"+351 9xx", email:"", imovel:"T3", zona:"Leça",
       capitais:"", finb:"Em análise", perfil:"Comprador", tipo:"Cliente final", temcasa:"Não",
       urg:"Sem urgência", outroag:"Não", visitas:"Sim", primeira:"Não", uso:"Habitação secundária", notas:"Banco pediu declaração"},
      {titulo:"T0 Bonfim — Escritura 10/12", consultor:"Rui Quelhas", valor:"175000",
       cliente:"Jorge C.", contacto:"+351 9xx", email:"", imovel:"T0", zona:"Bonfim",
       capitais:"175000", finb:"Não", perfil:"Comprador", tipo:"Investidor", temcasa:"Não",
       urg:"Sem urgência", outroag:"Não", visitas:"Sim", primeira:"Não", uso:"Habitação secundária", notas:"Tudo confirmado"}
    ]
  };
  save(ex); render();
}

// Eventos
document.getElementById('add').onclick=addCard;
document.getElementById('reset').onclick=resetForm;
document.getElementById('seed').onclick=seedDemo;
document.getElementById('clear').onclick=()=>{ if(confirm('Apagar todas as leads?')){ localStorage.removeItem(LS_KEY); render(); } };

fillConsultorSelect();
render();
</script>
</body>
</html>
