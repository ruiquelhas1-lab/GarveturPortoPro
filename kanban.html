<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Garvetur Porto Pro — Leads (Kanban)</title>
<style>
  :root{--gold:#A38B63;--bg:#0E0E0E;--panel:#131313;--text:#fff;--muted:#bdbdbd;}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;}
  header{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.1);background:#0F0F0F;}
  nav a{margin-right:6px;text-decoration:none;color:#ddd;border:1px solid rgba(255,255,255,.12);padding:6px 10px;border-radius:8px;}
  nav a.active{background:var(--gold);color:#111;border-color:var(--gold);font-weight:600;}
  .actions{display:flex;gap:8px;align-items:center}
  .btn{background:transparent;border:1px solid rgba(163,139,99,.5);color:#fff;padding:6px 9px;border-radius:8px;cursor:pointer;font-size:12px;}
  .wrap{display:grid;grid-template-columns:360px 1fr;gap:12px;padding:12px;}
  .panel{background:var(--panel);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px;}
  .panel h3{margin:0 0 8px 0;font-size:13px;color:#eaeaea;border-bottom:1px solid rgba(255,255,255,.06);padding-bottom:6px;}
  label{font-size:12px;color:#ddd;display:block;margin:7px 0 2px;}
  input,select,textarea{width:100%;background:#0E0E0E;color:#fff;border:1px solid rgba(255,255,255,.18);border-radius:8px;padding:8px 10px;}
  .grid{display:grid;grid-template-columns:repeat(6,1fr);gap:10px;min-height:60vh;}

  /* Colunas com cores suaves por estado */
  .col{border-radius:12px;padding:8px;display:flex;flex-direction:column;background:#0E0E0E;border:1px solid rgba(255,255,255,.08);}
  .col[data-stage="novo"]        { box-shadow: inset 0 0 0 2px rgba(255,255,255,.04); }
  .col[data-stage="em_contacto"] { box-shadow: inset 0 0 0 2px rgba(163,139,99,.18); }
  .col[data-stage="qualificado"] { box-shadow: inset 0 0 0 2px rgba(46,204,113,.18); }
  .col[data-stage="visita"]      { box-shadow: inset 0 0 0 2px rgba(66,133,244,.22); }
  .col[data-stage="proposta"]    { box-shadow: inset 0 0 0 2px rgba(255,193,7,.20); }
  .col[data-stage="fecho"]       { box-shadow: inset 0 0 0 2px rgba(76,175,80,.22); }

  .col .h{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
  .col .h .t{font-size:12px;color:#cfcfcf;text-transform:uppercase;letter-spacing:.05em}
  .col .h .n{font-size:12px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);border-radius:999px;padding:2px 8px;color:#ddd}
  .col .h .w{font-size:11px;color:#aab2b7;margin-left:8px}

  .drop{flex:1;min-height:80px;border:1px dashed rgba(255,255,255,.12);border-radius:10px;padding:6px;overflow:auto}
  .card{background:#101010;border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:8px;margin-bottom:8px;cursor:grab}
  .card .title{font-weight:600}
  .card .meta{font-size:12px;color:#cfcfcf;margin-top:2px}
  .tag{display:inline-block;border:1px solid rgba(255,255,255,.18);border-radius:999px;padding:2px 6px;font-size:11px;margin-right:4px;color:#ddd}
  .tools{display:flex;gap:6px;margin-top:8px;flex-wrap:wrap}
  .tools .btn{padding:4px 7px;font-size:11px}

  .filters{display:grid;grid-template-columns:1fr 110px 110px 110px;gap:8px;align-items:end;margin-top:8px}
  .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin:8px 0 0 0}
  .kpi{background:#0E0E0E;border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:10px}
  .kpi .h{font-size:11px;color:#cfcfcf;text-transform:uppercase;letter-spacing:.05em;margin-bottom:6px}
  .kpi .v{font-size:18px;font-weight:700}
  .kpi .s{font-size:12px;color:#bdbdbd;margin-top:2px}
  .kpi .row{display:flex;justify-content:space-between;font-size:12px;color:#ddd;margin-top:6px}

  @media(max-width:1200px){.grid{grid-template-columns:repeat(3,1fr)} .wrap{grid-template-columns:1fr}}
  @media(max-width:700px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<header>
  <div style="display:flex;align-items:center;gap:10px;">
    <strong style="color:#FFD166">Garvetur Porto Pro</strong>
    <nav>
      <a href="./index.html">Mapa</a>
      <a class="active" href="./kanban.html">Leads</a>
      <a href="./angariacoes.html">Angariações</a>
      <a href="./dashboard.html">Dashboard</a>
    </nav>
  </div>
  <div class="actions">
    <button id="seed" class="btn">Seed (exemplo)</button>
    <button id="clear" class="btn">Limpar</button>
    <button id="export" class="btn">Exportar CSV (filtro)</button>
  </div>
</header>

<div class="wrap">
  <div class="panel">
    <h3>Nova Lead</h3>
    <label>Cliente</label><input id="cli" placeholder="Nome do cliente">
    <label>Contacto</label><input id="tel" placeholder="Telefone">
    <label>Email</label><input id="em" placeholder="email@exemplo.pt">
    <label>Imóvel</label><input id="imv" placeholder="Ex.: T2 Boavista">
    <label>Zona</label><input id="zona" placeholder="Ex.: Porto | Gaia | Matosinhos">
    <label>Origem</label>
    <select id="origem">
      <option>Promotor</option>
      <option>Referência</option>
      <option>Digital</option>
      <option>Walk-in</option>
      <option>Outro</option>
    </select>
    <label>Capitais próprios (€)</label><input id="cp" type="number" step="0.01">
    <label>Financiamento B.</label>
    <select id="fin"><option>Sim</option><option>Não</option><option>Em análise</option></select>
    <label>Comprador ou Vendedor</label>
    <select id="cv"><option>Comprador</option><option>Vendedor</option></select>
    <label>Investidor ou Cliente final</label>
    <select id="tipo"><option>Cliente final</option><option>Investidor</option></select>
    <label>Tem casa para vender?</label>
    <select id="tcv"><option>Não</option><option>Sim</option></select>
    <label>Urgência / Planta</label>
    <select id="urg"><option>Urgente</option><option>Sem urgência</option><option>Compra em planta</option></select>
    <label>Valor alvo (€)</label><input id="val" type="number" step="0.01">
    <label>1ª habitação?</label>
    <select id="h1"><option>Sim</option><option>Não</option></select>
    <label>Habitação própria ou secundária</label>
    <select id="hs"><option>Própria</option><option>Secundária</option></select>
    <label>Acompanhado por outro agente?</label>
    <select id="oa"><option>Não</option><option>Sim</option></select>
    <label>Já fez visitas?</label>
    <select id="vs"><option>Não</option><option>Sim</option></select>
    <label>Notas</label><textarea id="nt" rows="3" placeholder="Observações úteis"></textarea>
    <label>Consultor</label>
    <select id="cons">
      <option>Rui Quelhas</option>
      <option>Manuel Oliveira</option>
      <option>João Sousa</option>
      <option>Francisco dos Santos</option>
      <option>Rosário Vasconcelos</option>
      <option>Armanda Meireles</option>
      <option>Audrey Lucas</option>
    </select>
    <label>Estado inicial</label>
    <select id="est"></select>
    <div style="margin-top:8px;display:flex;gap:8px;">
      <button id="add" class="btn">Adicionar lead</button>
    </div>

    <div class="panel" style="margin-top:12px">
      <h3>Filtros</h3>
      <div class="filters">
        <input id="q" placeholder="Pesquisar: cliente / imóvel / zona / consultor / origem" />
        <input type="date" id="f_de" />
        <input type="date" id="f_ate" />
        <button id="apply" class="btn">Aplicar</button>
      </div>
    </div>
  </div>

  <div class="panel">
    <h3>Kanban</h3>
    <div id="grid" class="grid"></div>
  </div>
</div>

<script>
/* =========================
   Configuração
========================= */
const STAGES = [
  { key:'novo',          title:'Novo' },
  { key:'em_contacto',   title:'Em Contacto' },
  { key:'qualificado',   title:'Qualificado' },
  { key:'visita',        title:'Visita' },
  { key:'proposta',      title:'Proposta' },
  { key:'fecho',         title:'Fecho' }
];

const LS_KEY = 'gpp_leads_v3';
const CONSULTORS = ["Rui Quelhas","Manuel Oliveira","João Sousa","Francisco dos Santos","Rosário Vasconcelos","Armanda Meireles","Audrey Lucas"];

let Q = '';
const grid = document.getElementById('grid');
const est = document.getElementById('est');
est.innerHTML = STAGES.map(s=>`<option value="${s.key}">${s.title}</option>`).join('');

/* =========================
   Storage / Migração
========================= */
function load(){
  try {
    const raw = localStorage.getItem(LS_KEY);
    const data = raw ? JSON.parse(raw) : [];
    return migrate(data);
  } catch(e){ return []; }
}
function save(d){ localStorage.setItem(LS_KEY, JSON.stringify(d)); }

function migrate(arr){
  const valid = new Set(STAGES.map(s=>s.key));
  return (arr||[]).map(x=>{
    let s = (x.stage||'').toLowerCase();
    if (s === 'emcontacto' || s === 'em-contacto') s = 'em_contacto';
    if (!valid.has(s)) s = 'novo';
    if (!x.createdAt) x.createdAt = new Date().toISOString();
    return { ...x, stage:s };
  });
}

/* =========================
   Renderização
========================= */
function render(){
  const data = load();
  const q = Q.trim().toLowerCase();
  const byStage = {};
  STAGES.forEach(s=> byStage[s.key]=[]);

  data.forEach(item=>{
    const txt = [item.cliente,item.imovel,item.zona,item.consultor,item.origem].map(v=>String(v||'').toLowerCase()).join(' ');
    if (q && !txt.includes(q)) return;
    const st = byStage[item.stage] ? item.stage : 'novo';
    byStage[st].push(item);
  });

  grid.innerHTML = '';
  STAGES.forEach(s=>{
    const col = document.createElement('div');
    col.className = 'col';
    col.dataset.stage = s.key;
    col.innerHTML = `
      <div class="h">
        <div class="t">${s.title}</div>
        <div><span class="n" id="n_${s.key}">${byStage[s.key].length}</span></div>
      </div>
      <div class="drop" data-drop="${s.key}"></div>
    `;
    const drop = col.querySelector('.drop');
    drop.ondragover = ev => ev.preventDefault();
    drop.ondrop = ev => {
      ev.preventDefault();
      const id = ev.dataTransfer.getData('text/plain');
      moveLead(id, s.key);
    };

    (byStage[s.key]||[]).forEach(item=>{
      const card = document.createElement('div');
      card.className = 'card';
      card.draggable = true;
      card.id = item.id;
      card.ondragstart = ev => ev.dataTransfer.setData('text/plain', item.id);
      card.innerHTML = `
        <div class="title">${item.cliente || '(sem nome)'}</div>
        <div class="meta">${item.consultor||'—'} · ${item.imovel||'—'} · ${item.zona||'—'}</div>
        <div class="meta">
          ${item.origem ? `<span class="tag">${item.origem}</span>` : ''}
          <span class="tag">${item.tipo||''}</span>
          <span class="tag">${item.cv||''}</span>
          ${item.vs==='Sim' ? '<span class="tag">Fez visitas</span>' : ''}
        </div>
        <div class="tools">
          <button class="btn" data-a="next">Próximo estado</button>
          <select data-a="to" title="Mover para…">
            ${STAGES.map(st=>`<option value="${st.key}" ${st.key===item.stage?'selected':''}>${st.title}</option>`).join('')}
          </select>
          <button class="btn" data-a="apply">Aplicar</button>
          <button class="btn" data-a="edit">Editar</button>
          <button class="btn" data-a="del">Remover</button>
        </div>
      `;
      card.querySelector('[data-a="next"]').onclick = () => moveNext(item.id);
      card.querySelector('[data-a="apply"]').onclick = () => {
        const sel = card.querySelector('select[data-a="to"]');
        moveLead(item.id, sel.value);
      };
      card.querySelector('[data-a="edit"]').onclick = () => edit(item.id);
      card.querySelector('[data-a="del"]').onclick = () => del(item.id);
      drop.appendChild(card);
    });

    grid.appendChild(col);
  });
}

/* =========================
   CRUD e Movimentação
========================= */
function uid(){ return 'L'+Math.random().toString(36).slice(2,9); }

function collectForm(){
  return {
    cliente: document.getElementById('cli').value.trim(),
    tel:     document.getElementById('tel').value.trim(),
    email:   document.getElementById('em').value.trim(),
    imovel:  document.getElementById('imv').value.trim(),
    zona:    document.getElementById('zona').value.trim(),
    origem:  document.getElementById('origem').value,
    cp:      Number(document.getElementById('cp').value)||null,
    fin:     document.getElementById('fin').value,
    cv:      document.getElementById('cv').value,
    tipo:    document.getElementById('tipo').value,
    tcv:     document.getElementById('tcv').value,
    urg:     document.getElementById('urg').value,
    val:     Number(document.getElementById('val').value)||null,
    h1:      document.getElementById('h1').value,
    hs:      document.getElementById('hs').value,
    oa:      document.getElementById('oa').value,
    vs:      document.getElementById('vs').value,
    notas:   document.getElementById('nt').value.trim(),
    consultor: document.getElementById('cons').value,
    stage:   document.getElementById('est').value,
    createdAt: new Date().toISOString()
  };
}

function clearForm(){
  ['cli','tel','em','imv','zona','cp','val','nt'].forEach(id=> document.getElementById(id).value='');
  ['origem','fin','cv','tipo','tcv','urg','h1','hs','oa','vs','cons','est'].forEach(id=>{
    const el=document.getElementById(id); if(el && el.options && el.options.length) el.selectedIndex=0;
  });
}

function add(){
  const f = collectForm();
  if(!f.cliente){ alert('Indique o nome do cliente.'); return; }
  const all = load();
  all.unshift({ id:uid(), ...f });
  save(all);
  clearForm();
  render();
}

function findById(id){
  const all = load();
  const idx = all.findIndex(x=>x.id===id);
  return { all, idx, item: all[idx] };
}

function edit(id){
  const { all, idx, item } = findById(id);
  if(idx<0) return;

  const cliente = prompt('Cliente:', item.cliente)||item.cliente;
  const imovel  = prompt('Imóvel:', item.imovel||'')??item.imovel;
  const zona    = prompt('Zona:', item.zona||'')??item.zona;
  const consultor = prompt('Consultor:', item.consultor||'')??item.consultor;
  const origem = prompt('Origem (Promotor/Referência/Digital/Walk-in/Outro):', item.origem||'')??item.origem;
  const notas = prompt('Notas:', item.notas||'')??item.notas;

  all[idx] = { ...item, cliente, imovel, zona, consultor, origem, notas };
  save(all);
  render();
}

function del(id){
  if(!confirm('Remover esta lead?')) return;
  const { all, idx } = findById(id);
  if(idx<0) return;
  all.splice(idx,1);
  save(all);
  render();
}

function moveLead(id, stage){
  const { all, idx, item } = findById(id);
  if(idx<0) return;
  all[idx] = { ...item, stage };
  save(all);
  render();
}

function moveNext(id){
  const { all, idx, item } = findById(id);
  if(idx<0) return;
  const order = STAGES.map(s=>s.key);
  const i = order.indexOf(item.stage);
  const next = order[Math.min(i+1, order.length-1)];
  if (next === item.stage) return;
  all[idx] = { ...item, stage: next };
  save(all);
  render();
}

/* =========================
   Pesquisa e Filtros
========================= */
document.getElementById('apply').onclick = ()=>{
  Q = document.getElementById('q').value||'';
  render();
};

/* =========================
   Exportação CSV (filtro)
========================= */
function toCSVRow(arr){ return arr.map(v=>`"${String(v??'').replaceAll('"','""')}"`).join(','); }
function exportCSV(){
  const headers = ["ID","Cliente","Contacto","Email","Imóvel","Zona","Origem","Capitais próp.","Financiamento","Comprador/Vendedor","Tipo","Tem casa p/ vender","Urgência/Planta","Valor (€)","1ª habitação","Habitação","Outro agente","Já fez visitas","Notas","Consultor","Estado","Criado em"];
  const q = (document.getElementById('q').value||'').trim().toLowerCase();
  const data = load().filter(a=>{
    const txt = [a.cliente,a.imovel,a.zona,a.consultor,a.origem].map(v=>String(v||'').toLowerCase()).join(' ');
    return !q || txt.includes(q);
  });
  const lines = [toCSVRow(headers)];
  data.forEach(a=>{
    lines.push(toCSVRow([a.id,a.cliente,a.tel,a.email,a.imovel,a.zona,a.origem,a.cp,a.fin,a.cv,a.tipo,a.tcv,a.urg,a.val,a.h1,a.hs,a.oa,a.vs,a.notas,a.consultor,a.stage,a.createdAt]));
  });
  const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const aEl = document.createElement('a');
  aEl.href = url; aEl.download = 'leads_filtradas.csv';
  document.body.appendChild(aEl); aEl.click(); aEl.remove();
  URL.revokeObjectURL(url);
}

/* =========================
   Seed de exemplo
========================= */
function seed(){
  if(!confirm('Substituir pelas leads de exemplo?')) return;
  const now = new Date().toISOString();
  const ex = [
    {id:uid(), cliente:"Paulo Andrade", tel:"912345678", email:"paulo@ex.pt", imovel:"T2 Boavista", zona:"Porto", origem:"Digital", cp:150000, fin:"Em análise", cv:"Comprador", tipo:"Cliente final", tcv:"Não", urg:"Sem urgência", val:420000, h1:"Sim", hs:"Própria", oa:"Não", vs:"Não", notas:"Avaliar planta em Matosinhos", consultor:"Rui Quelhas", stage:"novo", createdAt:now},
    {id:uid(), cliente:"Sofia Martins", tel:"919111222", email:"sofia@ex.pt", imovel:"T3 Canidelo vista mar", zona:"V.N. Gaia", origem:"Promotor", cp:200000, fin:"Sim", cv:"Comprador", tipo:"Investidor", tcv:"Sim", urg:"Compra em planta", val:650000, h1:"Não", hs:"Secundária", oa:"Não", vs:"Não", notas:"Preferência T3 duplex", consultor:"Manuel Oliveira", stage:"em_contacto", createdAt:now},
    {id:uid(), cliente:"Miguel Costa", tel:"913222333", email:"miguel@ex.pt", imovel:"Moradia Senhora da Hora", zona:"Matosinhos", origem:"Referência", cp:300000, fin:"Não", cv:"Comprador", tipo:"Cliente final", tcv:"Não", urg:"Urgente", val:900000, h1:"Sim", hs:"Própria", oa:"Sim", vs:"Sim", notas:"Precisa vender apartamento atual", consultor:"João Sousa", stage:"qualificado", createdAt:now},
    {id:uid(), cliente:"Ana Ribeiro", tel:"914444555", email:"ana@ex.pt", imovel:"Lote Gondomar", zona:"Gondomar", origem:"Walk-in", cp:120000, fin:"Em análise", cv:"Vendedor", tipo:"Investidor", tcv:"—", urg:"Sem urgência", val:230000, h1:"—", hs:"—", oa:"Não", vs:"Sim", notas:"Aguarda visita técnica", consultor:"Armanda Meireles", stage:"visita", createdAt:now},
    {id:uid(), cliente:"Carlos Lima", tel:"915666777", email:"carlos@ex.pt", imovel:"Loja Baixa", zona:"Porto", origem:"Outro", cp:500000, fin:"Não", cv:"Vendedor", tipo:"Investidor", tcv:"—", urg:"Sem urgência", val:1200000, h1:"—", hs:"—", oa:"Não", vs:"Sim", notas:"Proposta a preparar", consultor:"Audrey Lucas", stage:"proposta", createdAt:now},
    {id:uid(), cliente:"Essence Penthouse", tel:"", email:"", imovel:"T4 Essência", zona:"Porto", origem:"Promotor", cp:null, fin:"Em análise", cv:"Comprador", tipo:"Investidor", tcv:"Não", urg:"Sem urgência", val:1400000, h1:"Não", hs:"Secundária", oa:"Não", vs:"Sim", notas:"Fecho previsto 30 dias", consultor:"Francisco dos Santos", stage:"fecho", createdAt:now}
  ];
  save(ex);
  render();
}

/* =========================
   Ligações UI
========================= */
document.getElementById('add').onclick   = add;
document.getElementById('seed').onclick  = seed;
document.getElementById('clear').onclick = ()=>{ if(confirm('Limpar todas as leads?')){ localStorage.removeItem(LS_KEY); render(); } };
document.getElementById('export').onclick= exportCSV;
document.getElementById('apply').onclick = ()=>{ Q = document.getElementById('q').value||''; render(); };

/* Primeira renderização */
render();
</script>
</body>
</html>
