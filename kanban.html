<!doctype html>
<html lang="pt-PT">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Garvetur Porto Pro â€” Leads (Kanban)</title>

  <link rel="preconnect" href="https://unpkg.com" crossorigin>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js" defer></script>

  <style>
    :root{
      --gold:#A38B63;
      --bg:#0B0B0B;
      --panel:#141414;
      --panel-soft:#181818;
      --border:rgba(255,255,255,.14);
      --text:#FFFFFF;
      --muted:#A0A0A0;
      --radius-md:14px;
      --shadow-soft:0 18px 35px rgba(0,0,0,.6);
    }
    *{box-sizing:border-box;}
    html,body{
      margin:0;
      height:100%;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      background:radial-gradient(circle at top,#1c1c1c 0,#050505 55%,#000 100%);
      color:var(--text);
    }
    body{
      display:flex;
      flex-direction:column;
    }

    .app-shell{
      display:grid;
      grid-template-rows:64px auto;
      height:100%;
    }

    /* HEADER / BRAND / NAV TABS */
    header.app-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 18px;
      border-bottom:1px solid rgba(163,139,99,.35);
      background:linear-gradient(90deg,#050505,#111,#050505);
      gap:16px;
      flex-wrap:wrap;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .brand-icon{
      width:26px;
      height:26px;
      border-radius:999px;
      border:1px solid var(--gold);
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:0 0 0 1px rgba(163,139,99,.3);
    }
    .brand h1{
      margin:0;
      font-size:17px;
      letter-spacing:.04em;
      text-transform:uppercase;
      color:var(--gold);
    }
    .brand span.sub{
      display:block;
      font-size:11px;
      color:var(--muted);
      letter-spacing:.12em;
      text-transform:uppercase;
    }

    .nav-tabs{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap:4px;
      background:rgba(0,0,0,.35);
      padding:4px;
      border-radius:999px;
      border:1px solid rgba(163,139,99,.35);
    }
    .nav-tab{
      padding:5px 10px;
      border-radius:999px;
      font-size:11px;
      text-decoration:none;
      color:var(--muted);
      letter-spacing:.12em;
      text-transform:uppercase;
      border:1px solid transparent;
      transition:.16s background,.16s color,.16s border-color,.16s transform;
    }
    .nav-tab:hover{
      color:#fff;
      border-color:rgba(163,139,99,.6);
      transform:translateY(-1px);
    }
    .nav-tab.active{
      background:var(--gold);
      color:#0A0A0A;
      border-color:var(--gold);
      font-weight:600;
    }

    /* BOTÃ•ES GENÃ‰RICOS */
    .btn{
      border-radius:10px;
      border:1px solid rgba(163,139,99,.35);
      background:rgba(12,12,12,.9);
      color:var(--text);
      padding:7px 12px;
      font-size:13px;
      display:inline-flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
      transition:.18s border-color,.18s background,.18s transform;
      white-space:nowrap;
    }
    .btn:hover{
      border-color:var(--gold);
      transform:translateY(-1px);
    }
    .btn-primary,
    .btn.primary{
      background:var(--gold);
      color:#0A0A0A;
      border-color:var(--gold);
      font-weight:600;
    }
    .btn-ghost,
    .btn.ghost{
      background:transparent;
      border-color:rgba(255,255,255,.24);
      color:var(--muted);
    }
    .btn[disabled]{
      opacity:.45;
      cursor:not-allowed;
      transform:none;
    }
    .move-select[disabled]{opacity:.45;cursor:not-allowed;}

    /* BotÃ£o pequeno */
    .btn-xs{
      border-radius:999px;
      border:1px solid rgba(163,139,99,.35);
      background:rgba(12,12,12,.9);
      color:var(--muted);
      padding:3px 8px;
      font-size:11px;
      display:inline-flex;
      align-items:center;
      gap:4px;
      cursor:pointer;
      transition:.16s border-color,.16s background,.16s transform;
    }
    .btn-xs:hover{
      border-color:var(--gold);
      transform:translateY(-1px);
    }
    .btn-xs.primary{
      border-color:var(--gold);
      color:var(--gold);
    }

    /* LAYOUT PRINCIPAL */
    .layout{
      display:grid;
      grid-template-columns:320px minmax(0,1fr);
      height:calc(100vh - 64px);
      max-height:calc(100vh - 64px);
      overflow:hidden;
    }
    @media (max-width:960px){
      .layout{
        grid-template-columns:1fr;
        grid-template-rows:auto auto;
        height:auto;
        max-height:none;
      }
    }

    .sidebar{
      background:radial-gradient(circle at top left,#141414,#060606);
      border-right:1px solid var(--border);
      padding:12px 14px;
      overflow-y:auto;
    }
    .sidebar-section{
      border-radius:var(--radius-md);
      padding:10px 11px;
      background:rgba(0,0,0,.45);
      border:1px solid rgba(163,139,99,.18);
      margin-bottom:10px;
    }
    .sidebar-section h3{
      margin:0 0 8px 0;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.16em;
      color:var(--muted);
    }

    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
      margin-bottom:10px;
    }
    .field input,
    .field select{
      background:rgba(0,0,0,.7);
      border:1px solid rgba(255,255,255,.16);
      border-radius:10px;
      color:#fff;
      padding:6px 9px;
      outline:none;
      font-size:12px;
    }
    .field input:focus,
    .field select:focus{
      border-color:var(--gold);
      box-shadow:0 0 0 1px rgba(163,139,99,.35);
    }

    .checks{
      display:flex;
      flex-direction:column;
      gap:8px;
      font-size:12px;
      color:#dcdcdc;
    }
    .checks label{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .checks input{accent-color:var(--gold);}

    .cards-area{
      padding:0;
      overflow-y:auto;
      background:radial-gradient(circle at top,#1a1a1a,#050505 55%,#000 100%);
      display:flex;
      flex-direction:column;
    }

    /* BARRA DE KPIs + TOOLBAR (igual ao mapa) */
    .kpis{
      display:flex;
      gap:8px;
      align-items:center;
      padding:6px 12px;
      background:#0F0F0F;
      border-bottom:1px solid var(--border);
      border-top:1px solid var(--border);
      flex-wrap:wrap;
    }
    .kpi{
      display:flex;
      align-items:center;
      gap:6px;
      border:1px solid var(--border);
      border-radius:10px;
      padding:6px 10px;
      font-size:12px;
      background:rgba(0,0,0,.6);
    }
    .dot{
      width:10px;
      height:10px;
      border-radius:50%;
      background:#999;
      display:inline-block;
      border:1px solid rgba(0,0,0,.2);
    }
    .dot.novo{background:#757575;}
    .dot.contacto{background:#1E88E5;}
    .dot.qualificado{background:#43A047;}
    .dot.visita{background:#FB8C00;}
    .dot.proposta{background:#8E24AA;}
    .dot.fecho{background:#A38B63;}
    .dot.perdido{background:#E53935;}

    .toolbar{
      margin-left:auto;
      display:flex;
      gap:6px;
      flex-wrap:wrap;
    }

    /* BOARD / COLUNAS / CARDS */
    .board{
      display:grid;
      grid-template-columns:repeat(7,minmax(260px,1fr));
      gap:10px;
      padding:14px 16px 18px;
    }
    @media (max-width:1400px){
      .board{grid-template-columns:repeat(3,minmax(260px,1fr));}
    }
    @media (max-width:960px){
      .board{grid-template-columns:1fr;}
    }

    .col{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:12px;
      display:flex;
      flex-direction:column;
      min-width:240px;
    }
    .col header{
      padding:8px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex;
      align-items:center;
      justify-content:space-between;
      font-size:12px;
    }
    .col header .title{
      font-weight:700;
      color:#f3f3f3;
    }
    .counter{
      font-size:11px;
      color:#cfcfcf;
    }
    .col .list{
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .card{
      background:#0E0E0E;
      border:1px solid rgba(163,139,99,.65);
      border-radius:14px;
      padding:10px;
      box-shadow:0 14px 24px rgba(0,0,0,.65);
    }
    .card .top{
      display:flex;
      justify-content:space-between;
      gap:8px;
    }
    .card .name{
      font-weight:800;
      font-size:13px;
      color:#fff;
    }
    .card .meta{
      font-size:11px;
      color:#bbb;
    }
    .card .row{
      margin-top:6px;
      font-size:12px;
      color:#ddd;
    }
    .card .actions{
      margin-top:8px;
      display:flex;
      gap:6px;
      flex-wrap:wrap;
    }
    .badge{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      font-size:11px;
    }
    .badge.light{
      border-color:#444;
      color:#ccc;
    }
    .move-select{
      background:#0E0E0E;
      border:1px solid rgba(255,255,255,.25);
      color:#ddd;
      border-radius:999px;
      padding:4px 8px;
      font-size:11px;
    }

    /* MODAL */
    .modal-backdrop{
      display:none;
      position:fixed;
      inset:0;
      z-index:10000;
      background:rgba(0,0,0,.6);
      backdrop-filter:blur(2px);
      align-items:center;
      justify-content:center;
      padding:16px;
    }
    .modal-backdrop.show{display:flex;}
    .modal{
      width:min(980px,96vw);
      background:#0F0F0F;
      border:1px solid var(--border);
      border-radius:18px;
      overflow:hidden;
      box-shadow:0 24px 45px rgba(0,0,0,.8);
    }
    .modal header{
      padding:10px 12px;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      background:linear-gradient(90deg,#050505,#111,#050505);
      font-size:13px;
    }
    .modal .content{
      padding:12px;
      max-height:72vh;
      overflow:auto;
    }

    .grid2{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    .grid3{
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:10px;
    }
    @media (max-width:900px){
      .grid2,.grid3{grid-template-columns:1fr;}
    }

    .form-field{
      display:flex;
      flex-direction:column;
      gap:6px;
      font-size:12px;
    }
    .form-field input,
    .form-field select,
    .form-field textarea{
      background:#0E0E0E;
      border:1px solid rgba(255,255,255,.16);
      border-radius:8px;
      color:#fff;
      padding:8px 10px;
      outline:none;
      font-size:12px;
    }
    .form-field input:focus,
    .form-field select:focus,
    .form-field textarea:focus{
      border-color:var(--gold);
      box-shadow:0 0 0 1px rgba(163,139,99,.28);
    }
    .form-field small{color:#9AA0A6;}

    .help{
      font-size:12px;
      color:#bdbdbd;
      margin-top:4px;
    }

    /* ESTADO PICKER */
    .state-pills{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .state-pill{
      display:flex;
      align-items:center;
      gap:6px;
      border:1px solid rgba(255,255,255,.18);
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      background:#0E0E0E;
      cursor:pointer;
    }
    .state-pill input{
      accent-color:#A38B63;
      width:14px;
      height:14px;
    }
    .state-pill.active{
      background:#1c1c1c;
      border-color:#A38B63;
    }

    /* INTERCALARES */
    .intercalares{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .intercalares .row{
      display:flex;
      gap:8px;
      align-items:center;
    }
    .intercalares .row input{flex:1;}
    .intercalares .row button{white-space:nowrap;}
    .total-line{
      margin-top:6px;
      font-size:12px;
      color:#dcdcdc;
    }

    /* BLOCO PROPOSTA & CONTRA-PROPOSTAS */
    .section-block{
      margin-top:10px;
      padding:10px 10px 12px;
      border-radius:12px;
      border:1px solid rgba(163,139,99,.35);
      background:rgba(10,10,10,.9);
    }
    .section-title-small{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.16em;
      color:var(--muted);
      margin-bottom:6px;
    }
    .field-grid-2{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:8px;
    }
    @media (max-width:900px){
      .field-grid-2{grid-template-columns:1fr;}
    }
    .contraprop-item{
      border-radius:10px;
      border:1px solid rgba(255,255,255,.14);
      padding:8px;
      margin-top:6px;
      background:#111;
    }

    /* inputs escondidos */
    #importCsvInput,
    #restoreJsonInput{
      display:none;
    }

    /* SumÃ¡rio antigo mantido apenas para compatibilidade lÃ³gica (oculto) */
    #pipelineSummary{
      display:none;
    }
  </style>
</head>
<body>
<div class="app-shell">
  <header class="app-header">
    <div class="brand">
      <div class="brand-icon">
        <svg width="16" height="16" viewBox="0 0 24 24" stroke="var(--gold)" fill="none" stroke-width="1.8">
          <circle cx="12" cy="12" r="9"></circle>
          <path d="M8 12.5l2.5 2.5L16 9"></path>
        </svg>
      </div>
      <div>
        <h1>Garvetur Porto Pro â€” Leads</h1>
        <span class="sub">Pipeline comercial e oportunidades</span>
      </div>
    </div>

    <nav class="nav-tabs">
      <a href="index.html" class="nav-tab">InÃ­cio</a>
      <a href="mapa.html" class="nav-tab">Mapa</a>
      <a href="kanban.html" class="nav-tab active">Leads</a>
      <a href="angariacoes.html" class="nav-tab">AngariaÃ§Ãµes</a>
      <a href="dashboard.html" class="nav-tab">Dashboard</a>
      <a href="vendas.html" class="nav-tab">Vendas</a>
      <a href="tarefas.html" class="nav-tab">Tarefas</a>
    </nav>
  </header>

  <div class="layout">
    <!-- LADO ESQUERDO: FILTROS -->
    <aside class="sidebar">
      <div class="sidebar-section">
        <h3>Pesquisa</h3>
        <div class="field">
          <input id="q" placeholder="Pesquisar: nome, contacto, consultor, email, ref., zona, notas">
        </div>
      </div>

      <div class="sidebar-section">
        <h3>Filtros</h3>
        <div class="field">
          <label>Consultor</label>
          <select id="f_consultor"><option value="">(Todos)</option></select>
        </div>
        <div class="field">
          <label>Estado</label>
          <select id="f_estado">
            <option value="">(Todos)</option>
            <option>Novo</option>
            <option>Em Contacto</option>
            <option>Qualificado</option>
            <option>Visita</option>
            <option>Proposta</option>
            <option>Fecho</option>
            <option>Perdido</option>
          </select>
        </div>
        <div class="field">
          <label>PerÃ­odo</label>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
            <input id="f_ini" type="date">
            <input id="f_fim" type="date">
          </div>
        </div>
        <div class="checks">
          <label><input type="checkbox" id="f_show_hidden"> Mostrar invisÃ­veis</label>
          <label><input type="checkbox" id="f_only_hidden"> SÃ³ invisÃ­veis</label>
        </div>
        <div style="display:flex;gap:8px;margin-top:10px">
          <button class="btn" id="applyFilters">Aplicar</button>
          <button class="btn btn-ghost" id="clearFilters">Limpar</button>
        </div>
      </div>
    </aside>

    <!-- DIREITA: KPIs + BOARD -->
    <main class="cards-area">
      <!-- KPIs Ã  la mapa -->
      <div class="kpis">
        <div class="kpi"><span class="dot"></span>Total: <b id="k_total">0</b></div>
        <div class="kpi"><span class="dot novo"></span>Novo: <b id="k_novo">0</b></div>
        <div class="kpi"><span class="dot contacto"></span>Em contacto: <b id="k_contacto">0</b></div>
        <div class="kpi"><span class="dot qualificado"></span>Qualificado: <b id="k_qualificado">0</b></div>
        <div class="kpi"><span class="dot visita"></span>Visita: <b id="k_visita">0</b></div>
        <div class="kpi"><span class="dot proposta"></span>Proposta: <b id="k_proposta">0</b></div>
        <div class="kpi"><span class="dot fecho"></span>Fecho: <b id="k_fecho">0</b></div>
        <div class="kpi"><span class="dot perdido"></span>Perdido: <b id="k_perdido">0</b></div>

        <div class="toolbar">
          <button class="btn primary" id="btnNew" disabled>+ Nova Lead</button>
          <button class="btn btn-ghost" id="toggleEdit"><span id="lockEmoji">ðŸ”’</span> EdiÃ§Ã£o bloqueada</button>
          <button class="btn btn-ghost" id="exportCsv">â¤“ CSV</button>
          <button class="btn btn-ghost" id="exportXlsx">â¤“ Excel</button>
          <button class="btn btn-ghost" id="importCsvBtn">â¤’ Importar CSV</button>
          <button class="btn btn-ghost" id="backupJsonBtn">â¤“ Backup</button>
          <button class="btn btn-ghost" id="restoreJsonBtn">â¤’ Restore</button>

          <input type="file" id="importCsvInput" accept=".csv" />
          <input type="file" id="restoreJsonInput" accept=".json" />
        </div>
      </div>

      <!-- Controlo antigo do sumÃ¡rio (mantido, mas invisÃ­vel) -->
      <div id="pipelineSummary"></div>

      <!-- Quadro Kanban -->
      <section class="board" id="board"></section>
    </main>
  </div>
</div>

<!-- Modal Nova/Editar Lead -->
<div id="leadModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-label="Lead">
  <div class="modal">
    <header>
      <div><strong id="modalTitle">Nova Lead</strong></div>
      <div style="display:flex;gap:8px">
        <button class="btn btn-ghost" id="cancelLead">Cancelar</button>
        <button class="btn primary" id="saveLead">Guardar</button>
      </div>
    </header>
    <div class="content">
      <div class="grid2">
        <div class="form-field"><label>Nome Cliente *</label><input id="ld_nome"></div>
        <div class="form-field">
  <label>Consultor *</label>
  <select id="ld_consultor"></select>
</div>
        <div class="form-field"><label>Contacto *</label><input id="ld_contacto" placeholder="+351 â€¦ ou 9 dÃ­gitos"></div>
        <div class="form-field"><label>Email</label><input id="ld_email" type="email"></div>

        <div class="form-field"><label>Tipo de negÃ³cio</label>
          <select id="ld_tipo_negocio">
            <option value="">â€”</option><option>Venda</option><option>Compra</option><option>Arrendamento</option><option>Permuta</option>
          </select>
        </div>
        <div class="form-field"><label>ImÃ³vel</label>
          <select id="ld_imovel">
            <option value="">â€”</option><option>Moradia</option><option>Apartamento</option><option>Loja</option><option>ArmazÃ©m</option><option>EscritÃ³rio</option><option>Terreno</option><option>Outro</option>
          </select>
        </div>

        <div class="form-field"><label>Tipologia</label>
          <select id="ld_tipologia">
            <option value="">â€”</option><option>T0</option><option>T1</option><option>T2</option><option>T3</option><option>T4</option><option>T5</option><option>&gt;T5</option>
          </select>
        </div>
        <div class="form-field"><label>Zona preferencial</label><input id="ld_zona"></div>

        <div class="form-field"><label>Capitais prÃ³prios (â‚¬)</label><input id="ld_capitais" type="number" min="0" step="1000"></div>
        <div class="form-field"><label>Valor alvo (â‚¬)</label><input id="ld_valor" type="number" min="0" step="1000"></div>

        <div class="form-field"><label>Financiamento bancÃ¡rio?</label>
          <select id="ld_financiamento"><option>NÃ£o</option><option>Sim</option></select>
        </div>
        <div class="form-field"><label>SimulaÃ§Ã£o bancÃ¡ria?</label>
          <select id="ld_simulacao"><option>NÃ£o</option><option>Sim</option></select>
        </div>

        <div class="form-field"><label>InstituiÃ§Ã£o bancÃ¡ria (se aplicÃ¡vel)</label><input id="ld_banco"></div>
        <div class="form-field"><label>Tem imÃ³vel para vender?</label>
          <select id="ld_tem_imovel"><option>NÃ£o</option><option>Sim</option></select>
        </div>

        <div class="form-field"><label>JÃ¡ estÃ¡ Ã  venda?</label>
          <select id="ld_ja_venda"><option>NÃ£o</option><option>Sim</option></select>
        </div>
        <div class="form-field"><label>Urgente?</label>
          <select id="ld_urgente"><option>NÃ£o</option><option>Sim</option></select>
        </div>

        <div class="form-field"><label>Pode comprar em planta?</label>
          <select id="ld_planta"><option>NÃ£o</option><option>Sim</option></select>
        </div>
        <div class="form-field"><label>1Âª habitaÃ§Ã£o?</label>
          <select id="ld_primeira_hab"><option>NÃ£o</option><option>Sim</option></select>
        </div>

        <div class="form-field"><label>Comprador/Vendedor</label>
          <select id="ld_papel"><option value="">â€”</option><option>Comprador</option><option>Vendedor</option></select>
        </div>
        <div class="form-field"><label>Investidor/Cliente final</label>
          <select id="ld_perfil"><option value="">â€”</option><option>Investidor</option><option>Cliente final</option></select>
        </div>

        <div class="form-field">
          <label>ClassificaÃ§Ã£o (1â€“5)</label>
          <small style="font-size:11px;color:#9AA0A6;">
            1 â€“ Lead sem interesse Â· 2 â€“ Partilha Â· 3 â€“ Sem resposta a contacto Â·
            4 â€“ InformaÃ§Ã£o s/ imÃ³vel Â· 5 â€“ Quer marcar visita
          </small>
          <select id="ld_classificacao">
            <option value="">â€”</option>
            <option>1</option>
            <option>2</option>
            <option>3</option>
            <option>4</option>
            <option>5</option>
          </select>
        </div>

        <div class="form-field"><label>Ref. Interna</label><input id="ld_ref"></div>

        <div class="form-field"><label>URL anexo</label>
          <input id="ld_url" placeholder="https://â€¦"><small>Ex.: link de documento (Drive/Dropbox/OneDrive).</small>
        </div>
        <div class="form-field"><label>Data</label><input id="ld_data" type="date"></div>

        <div class="form-field" style="grid-column:1 / span 2"><label>Notas</label><textarea id="ld_notas" rows="3"></textarea></div>
      </div>

      <!-- ESTADO (piscos rÃ¡pidos) -->
      <div class="form-field" style="margin-top:6px">
        <label>Estado (seleÃ§Ã£o rÃ¡pida)</label>
        <div class="state-pills" id="ld_estado_picker">
          <label class="state-pill"><input type="checkbox" class="cb_estado" value="Em Contacto"> Em Contacto</label>
          <label class="state-pill"><input type="checkbox" class="cb_estado" value="Qualificado"> Qualificado</label>
          <label class="state-pill"><input type="checkbox" class="cb_estado" value="Visita"> Visita</label>
          <label class="state-pill"><input type="checkbox" class="cb_estado" value="Proposta"> Proposta</label>
          <label class="state-pill"><input type="checkbox" class="cb_estado" value="Fecho"> Fecho</label>
          <label class="state-pill"><input type="checkbox" class="cb_estado" value="Perdido"> Perdido</label>
        </div>
        <div class="help">Se selecionar um estado, o cartÃ£o serÃ¡ gravado diretamente nessa coluna. Se nada selecionar, fica em <b>Novo</b>.</div>
      </div>

      <!-- BLOCO PROPOSTA & NEGOCIAÃ‡ÃƒO -->
      <div id="propostaBox" class="section-block" style="display:none">
        <div class="section-title-small">Proposta & NegociaÃ§Ã£o</div>

        <div class="field-grid-2">
          <div class="form-field">
            <label>Nome do proponente</label>
            <input id="ld_prop_nome" type="text">
          </div>
          <div class="form-field">
            <label>Contacto</label>
            <input id="ld_prop_contacto" type="text">
          </div>
        </div>

        <div class="form-field">
          <label>Email</label>
          <input id="ld_prop_email" type="text">
        </div>

        <div class="field-grid-2">
          <div class="form-field">
            <label>Valor da proposta</label>
            <input id="ld_prop_valor" type="text" placeholder="Ex.: 350.000 â‚¬">
          </div>
          <div class="form-field">
            <label>Data da proposta</label>
            <input id="ld_prop_data" type="date">
          </div>
        </div>

        <div class="form-field">
          <label>Termos da proposta</label>
          <textarea id="ld_prop_termos" rows="3" placeholder="CondiÃ§Ãµes, prazos, mobiliÃ¡rio incluÃ­do, necessidade de crÃ©dito, etc."></textarea>
        </div>

        <div class="form-field">
          <label>
            Contra-propostas
            <button type="button" class="btn-xs primary" id="btnAddContraProp" style="margin-left:6px;">+ Adicionar contra-proposta</button>
          </label>
          <div id="prop_contra_list"></div>
        </div>

        <div class="field-grid-2">
          <div class="form-field">
           <label>Data da proposta aceite</label>
<input id="ld_prop_aceite" type="date" autocomplete="off">
          </div>
        </div>
      </div>

      <!-- FECHO -->
      <div id="fechoBox" class="grid2" style="margin-top:8px; display:none">
        <div class="form-field"><label>Valor do NegÃ³cio (â‚¬)</label><input id="ld_fecho_negocio" type="number" min="0" step="1000"></div>
        <div class="form-field">
          <label>ComissÃ£o</label>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
            <select id="ld_fecho_comissao">
              <option value="">â€”</option>
              <option value="6">6%</option>
              <option value="5">5%</option>
              <option value="4">4%</option>
              <option value="3">3%</option>
              <option value="outro">Outro</option>
            </select>
            <input id="ld_fecho_comissao_outro" placeholder="Ex.: 4.5%" style="display:none">
          </div>
        </div>

        <div class="form-field"><label>Valor Sinal de Reserva (â‚¬)</label><input id="ld_fecho_sinal_reserva" type="number" min="0" step="500"></div>
        <div class="form-field"><label>Valor a dar no CPCV (â‚¬)</label><input id="ld_fecho_valor_cpcv" type="number" min="0" step="1000"></div>

        <div class="form-field" style="grid-column:1 / span 2">
          <label>Valores Intercalares (â‚¬)</label>
          <div id="intercalaresBox" class="intercalares"></div>
          <div class="total-line" id="intercalaresTotal">Total intercalares: 0 â‚¬</div>
          <button class="btn btn-ghost" type="button" id="addIntercalar">+ Adicionar intercalar</button>
        </div>

        <div class="form-field"><label>Valor a dar na Escritura (â‚¬)</label><input id="ld_fecho_valor_escritura" type="number" min="0" step="1000"></div>
        <div class="form-field"><label>Data do CPCV</label><input id="ld_fecho_cpcv_date" type="date"></div>
        <div class="form-field"><label>Data da Escritura</label><input id="ld_fecho_escritura_date" type="date"></div>

        <!-- Pagamento de ComissÃµes -->
        <div class="form-field" style="grid-column:1 / span 2">
          <label>Pagamento de ComissÃµes</label>
          <select id="ld_fecho_pagamento_tipo">
            <option value="">â€”</option>
            <option value="50_50">50% CPCV - 50% Escritura</option>
            <option value="100_escritura">100% Escritura</option>
            <option value="outro">Outro</option>
          </select>
          <input id="ld_fecho_pagamento_outro" placeholder="Descreva a regra (ex.: 30% CPCV / 70% Escritura)" style="margin-top:6px;display:none">
        </div>

        <div class="form-field" style="grid-column:1 / span 2"><label>ObservaÃ§Ãµes</label><textarea id="ld_fecho_obs" rows="3"></textarea></div>
      </div>
    </div>
  </div>
</div>

<script src="config-consultores.js?v=2"></script>
<script>
/* ===== Estado ===== */
const LS_KEY='gpp_leads_v5';
const EDIT_LS='gpp_leads_edit_mode';
const COLS=["Novo","Em Contacto","Qualificado","Visita","Proposta","Fecho","Perdido"];

// LÃª consultores a partir do config-consultores.js (CONSULTANTS_CONFIG)
const CONSULT_RESOLVE = (function(){
  try{
    if (Array.isArray(window.CONSULTANTS_CONFIG)) {
      return window.CONSULTANTS_CONFIG
        .filter(c => c && c.ativo !== false) // sÃ³ ativos
        .map(c => (c.nome || c.consultor || c.name || c.fullName || c.id || '').trim())
        .filter(Boolean);                     // remove vazios
    }
  }catch(e){
    console.warn('Kanban: erro a ler CONSULTANTS_CONFIG', e);
  }

  // Fallback de seguranÃ§a, caso algo corra mal
  return [
    "Rui Quelhas",
    "Manuel Oliveira",
    "JoÃ£o Sousa",
    "Francisco dos Santos",
    "RosÃ¡rio Vasconcelos",
    "Armanda Meireles",
    "Audrey Lucas"
  ];
})();
// storage de tarefas (partilhado com tarefas.html)
const TASKS_STORAGE_KEY = 'gpp_tarefas_v1';

// Mapa de classificaÃ§Ã£o 1â€“5 para texto amigÃ¡vel
const LEAD_CLASSIFICACAO_MAP = {
  1: "Lead sem interesse",
  2: "Partilha",
  3: "Sem resposta a contacto",
  4: "InformaÃ§Ã£o s/ imÃ³vel",
  5: "Quer marcar visita"
};

let LEADS=[];
let FILTER={ consultor:'', estado:'', ini:'', fim:'', q:'', showHidden:false, onlyHidden:false };
let PICKED_STATES = []; // etapas assinaladas (passou por)
let INTERCALAres=[];
let PROPOSTA_CONTRAS=[];
let EDIT_MODE=false;
let ACEITE_TOUCHED = false; // sÃ³ grava data aceite se o utilizador mexer no campo

const $=id=>document.getElementById(id);
const norm=s=>String(s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');

function todayISO(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0');
  return y + '-' + m + '-' + day;
}

/* ===== PersistÃªncia ===== */
function loadLS(){ try{ const x=localStorage.getItem(LS_KEY); return x? JSON.parse(x):[];}catch{return[];} }
function saveLS(){ localStorage.setItem(LS_KEY, JSON.stringify(LEADS)); }
function loadPersistedFilters(){
  try{ const raw=localStorage.getItem(LS_KEY+'_filters'); if(!raw) return;
    const f=JSON.parse(raw); FILTER=Object.assign(FILTER,f);
    $('f_consultor').value=FILTER.consultor||'';
    $('f_estado').value=FILTER.estado||'';
    $('f_ini').value=FILTER.ini||'';
    $('f_fim').value=FILTER.fim||'';
    $('q').value=FILTER.q||'';
    $('f_show_hidden').checked=!!FILTER.showHidden;
    $('f_only_hidden').checked=!!FILTER.onlyHidden;
  }catch{}
}
function persistFilters(){ localStorage.setItem(LS_KEY+'_filters', JSON.stringify(FILTER)); }

/* ===== Edit Mode ===== */
function updateEditUI(){
  const btnToggle=$('toggleEdit');
  const btnNew=$('btnNew');
  if(!btnToggle || !btnNew) return;
  if(EDIT_MODE){
    btnToggle.classList.add('primary');
    btnToggle.innerHTML='ðŸ”“ EdiÃ§Ã£o ativa';
    btnNew.disabled=false;
    btnNew.classList.add('primary');
    btnNew.classList.remove('ghost');
  }else{
    btnToggle.classList.remove('primary');
    btnToggle.innerHTML='ðŸ”’ EdiÃ§Ã£o bloqueada';
    btnNew.disabled=true;
    btnNew.classList.remove('primary');
    btnNew.classList.add('ghost');
  }
}
function setEditMode(on){
  EDIT_MODE=!!on;
  localStorage.setItem(EDIT_LS, EDIT_MODE?'1':'0');
  updateEditUI();
  renderBoard();
}

/* ===== Helpers ===== */
function badge(txt){ return `<span class="badge light">${txt||'â€”'}</span>`; }
function fmtDate(d){ if(!d) return 'â€”'; try{ const z=new Date(d); return z.toLocaleDateString('pt-PT'); }catch{return d;} }
function isEmail(e){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(e||'')); }
function isTel(t){ const s=String(t||'').replace(/\s+/g,''); return /^\+?\d{9,15}$/.test(s); }
function isHttp(u){ return /^https?:\/\//i.test(String(u||'')); }
function uid(){ return 'L'+Math.random().toString(36).slice(2,9)+Date.now().toString(36).slice(-4); }
function parsePercent(v){ if(!v) return ''; const s=String(v).replace('%','').replace(',','.'); const n=Number(s); return Number.isFinite(n)? n: ''; }
function sumIntercalares(arr){ return (arr||[]).reduce((a,b)=>a+(Number(b)||0),0); }

/* ===== Tarefas: integraÃ§Ã£o ===== */
function loadTasksState(){
  try{
    const raw = localStorage.getItem(TASKS_STORAGE_KEY);
    if(!raw) return {locked:true,tasks:[]};
    const parsed = JSON.parse(raw);
    if(!Array.isArray(parsed.tasks)) parsed.tasks = [];
    if(typeof parsed.locked!=='boolean') parsed.locked = true;
    return parsed;
  }catch(e){
    console.error('Erro ao carregar tarefas a partir do Kanban', e);
    return {locked:true,tasks:[]};
  }
}
function saveTasksState(state){
  try{
    localStorage.setItem(TASKS_STORAGE_KEY, JSON.stringify(state));
  }catch(e){
    console.error('Erro ao guardar tarefas a partir do Kanban', e);
  }
}

function createTaskFromLead(lead){
  const tasksState = loadTasksState();

  const origemRefParts = [];
  if(lead.ref_interna) origemRefParts.push(lead.ref_interna);
  if(lead.nome) origemRefParts.push(lead.nome);
  const origemRef = origemRefParts.join(' â€” ');

  const titulo = 'Follow-up lead: ' + (lead.nome || 'sem nome');

  const agora = new Date();
  const dataCriacaoISO = todayISO();
  const limite = new Date(agora);
  limite.setDate(limite.getDate() + 8);
  const dataLimiteISO = limite.toISOString().slice(0,10);

  const tarefa = {
    id: 'task_' + Date.now(),
    responsavel: lead.consultor || '',
    apoio: '',
    origemTipo: 'lead',
    origemRef: origemRef || (lead.nome || ''),
    estado: 'por_fazer',
    prioridade: 'normal',
    tipoTarefa: 'followup',
    tags: 'lead, pipeline',
    titulo: titulo,
    descricao: 'Tarefa criada a partir da lead "' + (lead.nome || '') +
      '" no Kanban em ' + new Date().toLocaleString('pt-PT') + '.',
    dataCriacao: dataCriacaoISO,
    dataLimite: dataLimiteISO,
    horaLimite: '',
    createdAtMs: Date.now()
  };

  tasksState.tasks.push(tarefa);
  saveTasksState(tasksState);

  const abrir = confirm('Tarefa criada para esta lead.\n\nQuer abrir a pÃ¡gina de Tarefas agora?');
  if(abrir){
    window.open('tarefas.html','_blank');
  }
}
function ensureEscrituraTask(lead){
  // SÃ³ aplica a leads em Fecho com data de escritura
  if(!lead || lead.estado !== 'Fecho' || !lead.fecho_escritura_date) return;

  const tasksState = loadTasksState();

  // Chave Ãºnica por lead (para nÃ£o duplicar e permitir update)
  const uniqueKey = 'escritura_' + lead.id;

  // Datas
  const escrituraDate = new Date(lead.fecho_escritura_date);
  if(isNaN(escrituraDate)) return;

  // "Criada no 1Âº dia do mÃªs" -> dataCriacao = 1Âº dia do mÃªs da escritura
  const dataCriacaoISO = new Date(escrituraDate.getFullYear(), escrituraDate.getMonth(), 1)
    .toISOString()
    .slice(0,10);

  // "Data limite = data da escritura"
  const dataLimiteISO = escrituraDate.toISOString().slice(0,10);

  const origemRef = lead.ref_interna
    ? (lead.ref_interna + ' â€” ' + (lead.nome || ''))
    : (lead.nome || '');

  const titulo = 'Escritura prevista â€” ' + (lead.nome || 'Lead');

  const descricao =
    'Lembrete automÃ¡tico: escritura prevista para ' +
    escrituraDate.toLocaleDateString('pt-PT') +
    '.\n\nTarefa criada/atualizada automaticamente a partir do Kanban.';

  // Procurar se jÃ¡ existe
  const idx = tasksState.tasks.findIndex(t => t.origemKey === uniqueKey);

  if(idx >= 0){
    // âœ… ATUALIZA (sem duplicar) â€” se a escritura mudar, refletimos jÃ¡
    const t = tasksState.tasks[idx];

    t.responsavel = lead.consultor || t.responsavel || '';
    t.origemTipo = 'lead';
    t.origemRef = origemRef || t.origemRef || '';
    t.tipoTarefa = 'escritura';
    t.tags = 'escritura,fecho';
    t.titulo = titulo;
    t.descricao = descricao;

    // Regras pedidas:
    t.dataCriacao = dataCriacaoISO;  // 1Âº dia do mÃªs da escritura
    t.dataLimite = dataLimiteISO;    // data da escritura

    // opcional: refrescar timestamp de update (nÃ£o quebra nada se nÃ£o existir)
    t.updatedAtMs = Date.now();

  }else{
    // âœ… CRIA (primeira vez)
    const tarefa = {
      id: 'task_' + Date.now(),
      origemKey: uniqueKey,
      responsavel: lead.consultor || '',
      apoio: '',
      origemTipo: 'lead',
      origemRef: origemRef,
      estado: 'por_fazer',
      prioridade: 'alta',
      tipoTarefa: 'escritura',
      tags: 'escritura,fecho',
      titulo: titulo,
      descricao: descricao,
      dataCriacao: dataCriacaoISO, // 1Âº dia do mÃªs da escritura
      dataLimite: dataLimiteISO,   // data da escritura
      horaLimite: '',
      createdAtMs: Date.now()
    };

    tasksState.tasks.push(tarefa);
  }

  saveTasksState(tasksState);
}
/* ===== Deep link vindo de Tarefas ===== */
function applyDeepLinkFromTarefas(){
  try{
    const params = new URLSearchParams(window.location.search);
    const refParam = (params.get('ref') || '').trim();
    if(!refParam) return;

    const refNorm = norm(refParam);
    if(!refNorm) return;

    let bestLead = null;
    let bestScore = 0;

    LEADS.forEach(l=>{
      const refIntNorm = norm(l.ref_interna || '');
      const nomeNorm = norm(l.nome || '');
      let score = 0;

      if(refIntNorm && (refNorm.includes(refIntNorm) || refIntNorm.includes(refNorm))){
        score += 4;
      }
      if(nomeNorm && (refNorm.includes(nomeNorm) || nomeNorm.includes(refNorm))){
        score += 2;
      }
      if(refIntNorm && nomeNorm){
        const combo = (refIntNorm + ' â€” ' + nomeNorm);
        if(combo === refNorm){
          score += 3;
        }
      }

      if(score > bestScore){
        bestScore = score;
        bestLead = l;
      }
    });

    if(!bestLead){
      console.warn('Nenhuma lead encontrada para ref:', refParam);
      alert('NÃ£o foi possÃ­vel encontrar a lead associada Ã  referÃªncia:\n' + refParam);
      return;
    }

    if(!EDIT_MODE){
      setEditMode(true);
    }

    $('saveLead').dataset.editId = bestLead.id;
    $('saveLead').dataset.editEstado = bestLead.estado;
    openModal(bestLead);

  }catch(e){
    console.error('Erro ao aplicar deep link de tarefas para Kanban', e);
  }
}

/* ===== Lateral ===== */
function buildFilters(){
  const sel=$('f_consultor');
  sel.innerHTML='<option value="">(Todos)</option>'+CONSULT_RESOLVE.map(c=>`<option>${c}</option>`).join('');
}

function initLeadConsultorSelect(){
  const sel = $('ld_consultor');
  if(!sel) return;
  sel.innerHTML = '<option value="">â€”</option>' +
    CONSULT_RESOLVE.map(nome => `<option>${nome}</option>`).join('');
}
$('applyFilters').addEventListener('click',()=>{
  FILTER.consultor=$('f_consultor').value; FILTER.estado=$('f_estado').value;
  FILTER.ini=$('f_ini').value; FILTER.fim=$('f_fim').value;
  FILTER.q=$('q').value.trim();
  FILTER.showHidden=$('f_show_hidden').checked;
  FILTER.onlyHidden=$('f_only_hidden').checked;
  persistFilters(); renderBoard();
});
$('clearFilters').addEventListener('click',()=>{
  FILTER={consultor:'',estado:'',ini:'',fim:'',q:'',showHidden:false,onlyHidden:false};
  ['f_consultor','f_estado','f_ini','f_fim','q','f_show_hidden','f_only_hidden'].forEach(id=>{
    const el=$(id);
    if(!el) return;
    if(el.type==='checkbox'){ el.checked=false; } else { el.value=''; }
  });
  persistFilters(); renderBoard();
});

// Pesquisa com debounce
let qTimer=null;
$('q').addEventListener('input',()=>{
  clearTimeout(qTimer);
  qTimer=setTimeout(()=>{ FILTER.q=$('q').value.trim(); persistFilters(); renderBoard(); }, 200);
});

/* ===== Modal ===== */
function resetFechoBox(){
  $('ld_fecho_negocio').value='';
  $('ld_fecho_comissao').value='';
  $('ld_fecho_comissao_outro').value=''; $('ld_fecho_comissao_outro').style.display='none';
  $('ld_fecho_sinal_reserva').value='';
  $('ld_fecho_valor_cpcv').value='';
  $('ld_fecho_valor_escritura').value='';
  $('ld_fecho_cpcv_date').value='';
  $('ld_fecho_escritura_date').value='';
  $('ld_fecho_obs').value='';
  $('ld_fecho_pagamento_tipo').value='';
  $('ld_fecho_pagamento_outro').value='';
  $('ld_fecho_pagamento_outro').style.display='none';
  INTERCALAres=[]; drawIntercalares();
  updateIntercalaresTotal();
}
function setFechoBox(show){ $('fechoBox').style.display = show? 'grid':'none'; }

/* PROPOSTA & CONTRA-PROPOSTAS */
function resetPropostaBox(){
  $('ld_prop_nome').value='';
  $('ld_prop_contacto').value='';
  $('ld_prop_email').value='';
  $('ld_prop_valor').value='';
  $('ld_prop_data').value='';
  $('ld_prop_termos').value='';
  $('ld_prop_aceite').value='';
  ACEITE_TOUCHED = false; // âœ… importante
  PROPOSTA_CONTRAS = [];
  drawContraPropostas();
}
function setPropostaBox(show){
  $('propostaBox').style.display = show ? 'block' : 'none';

  // Quando ativa "Proposta", NÃƒO preencher "data da proposta aceite" por defeito.
  // MantÃ©m apenas se jÃ¡ existir data guardada (ediÃ§Ã£o de lead).
  if(show){
    const inpAceite = $('ld_prop_aceite'); // id do input "Data da proposta aceite"
    if(inpAceite && !String(inpAceite.value || '').trim()){
      inpAceite.value = '';
    }
  }
}
function drawContraPropostas(){
  const container = $('prop_contra_list');
  container.innerHTML = '';
  (PROPOSTA_CONTRAS || []).forEach((item, idx)=>{
    const div = document.createElement('div');
    div.className = 'contraprop-item';
    div.innerHTML = `
      <div class="field-grid-2">
        <div class="form-field">
          <label>Data da contra-proposta</label>
          <input type="date" class="inp-contraprop-data" data-idx="${idx}" value="${item.data||''}">
        </div>
        <div class="form-field">
          <label>Valor</label>
          <input type="text" class="inp-contraprop-valor" data-idx="${idx}" value="${item.valor||''}">
        </div>
      </div>
      <div class="form-field">
        <label>Termos</label>
        <textarea class="inp-contraprop-termos" rows="2" data-idx="${idx}">${item.termos||''}</textarea>
      </div>
      <button type="button" class="btn-xs" data-del="${idx}">Remover</button>
    `;
   const inpDate = div.querySelector('.inp-contraprop-data');
inpDate.addEventListener('input', e => {
  PROPOSTA_CONTRAS[idx].data = e.target.value;
});
inpDate.addEventListener('change', e => {
  PROPOSTA_CONTRAS[idx].data = e.target.value;
});
    div.querySelector('.inp-contraprop-valor').addEventListener('input',e=>{
      PROPOSTA_CONTRAS[idx].valor = e.target.value;
    });
    div.querySelector('.inp-contraprop-termos').addEventListener('input',e=>{
      PROPOSTA_CONTRAS[idx].termos = e.target.value;
    });
    div.querySelector('[data-del]').addEventListener('click',()=>{
      PROPOSTA_CONTRAS.splice(idx,1);
      drawContraPropostas();
    });
    container.appendChild(div);
  });
}
$('btnAddContraProp').addEventListener('click', ()=>{
  PROPOSTA_CONTRAS.push({data:'',valor:'',termos:''});
  drawContraPropostas();
});

function drawIntercalares(){
  const box=$('intercalaresBox'); box.innerHTML='';
  INTERCALAres.forEach((val,idx)=>{
    const row=document.createElement('div'); row.className='row';
    row.innerHTML=`<input type="number" min="0" step="500" value="${val||''}" data-idx="${idx}"><button class="btn btn-ghost" data-del="${idx}">Remover</button>`;
    row.querySelector('input').addEventListener('input',e=>{
      const i=Number(e.target.dataset.idx); INTERCALAres[i]=e.target.value; updateIntercalaresTotal();
    });
    row.querySelector('button').addEventListener('click',()=>{ INTERCALAres.splice(idx,1); drawIntercalares(); updateIntercalaresTotal(); });
    box.appendChild(row);
  });
}
function updateIntercalaresTotal(){
  $('intercalaresTotal').textContent = 'Total intercalares: ' + sumIntercalares(INTERCALAres).toLocaleString('pt-PT') + ' â‚¬';
}
$('addIntercalar').addEventListener('click',()=>{ INTERCALAres.push(''); drawIntercalares(); updateIntercalaresTotal(); });

$('ld_fecho_comissao').addEventListener('change', (e)=>{
  const isOutro = e.target.value==='outro';
  const input=$('ld_fecho_comissao_outro');
  input.style.display = isOutro? 'block':'none';
  if(!isOutro) input.value='';
});

// Pagamento de ComissÃµes
$('ld_fecho_pagamento_tipo').addEventListener('change', (e)=>{
  const isOutro = e.target.value==='outro';
  const input = $('ld_fecho_pagamento_outro');
  input.style.display = isOutro ? 'block' : 'none';
  if(!isOutro) input.value='';
});

function getFurthestState(states, fallback){
  const arr = Array.isArray(states) ? states : [];
  let bestIdx = -1;
  let best = '';

  arr.forEach(s=>{
    const i = COLS.indexOf(s);
    if(i > bestIdx){
      bestIdx = i;
      best = s;
    }
  });

  return best || fallback || 'Novo';
}

function initStatePicker(){
  const cbs = Array.from(document.querySelectorAll('.cb_estado'));

  function readSelected(){
    return cbs.filter(cb=>cb.checked).map(cb=>cb.value);
  }

  function paint(){
    cbs.forEach(cb=>{
      cb.closest('.state-pill')?.classList.toggle('active', cb.checked);
    });
  }

  cbs.forEach(cb=>{
    cb.addEventListener('change', ()=>{
      // multi seleÃ§Ã£o: NÃƒO desmarca os outros
      PICKED_STATES = readSelected();

      // â€œside effectsâ€ (mantÃ©m as suas regras atuais)
      const furthest = getFurthestState(PICKED_STATES, $('saveLead')?.dataset?.editEstado || 'Novo');
      setFechoBox(furthest === 'Fecho');
      setPropostaBox(furthest === 'Proposta' || furthest === 'Fecho');

      paint();
    });
  });

  // paint inicial
  paint();
}

function openModal(edit=null){
  if(!EDIT_MODE){
    alert('Modo de ediÃ§Ã£o bloqueado. Clique em "ðŸ”“ EdiÃ§Ã£o ativa" para poder criar/editar leads.');
    return;
  }
  $('modalTitle').textContent = edit? 'Editar Lead' : 'Nova Lead';
  const f = (id,val='') => $(id).value = (val??'');
  const v = edit||{};
  f('ld_nome', v.nome);
  f('ld_consultor', v.consultor||'');
  f('ld_contacto', v.contacto);
  f('ld_email', v.email);
  f('ld_tipo_negocio', v.tipo_negocio);
  f('ld_imovel', v.imovel);
  f('ld_tipologia', v.tipologia);
  f('ld_zona', v.zona);
  f('ld_capitais', v.capitais);
  f('ld_valor', v.valor);
  f('ld_financiamento', v.financiamento||'NÃ£o');
  f('ld_simulacao', v.simulacao||'NÃ£o');
  f('ld_banco', v.banco);
  f('ld_tem_imovel', v.tem_imovel||'NÃ£o');
  f('ld_ja_venda', v.ja_venda||'NÃ£o');
  f('ld_urgente', v.urgente||'NÃ£o');
  f('ld_planta', v.planta||'NÃ£o');
  f('ld_primeira_hab', v.primeira_hab||'NÃ£o');
  f('ld_papel', v.papel||'');
  f('ld_perfil', v.perfil||'');
  f('ld_classificacao', v.classificacao||'');
  f('ld_ref', v.ref_interna||'');
  f('ld_url', v.url||'');
  f('ld_data', v.data||new Date().toISOString().slice(0,10));
  f('ld_notas', v.notas||'');

    // âœ… (Recomendado) Nova lead nÃ£o herda estados da anterior
  if(!edit) PICKED_STATES = [];

  initStatePicker();

  if(!edit){
    document.querySelectorAll('.cb_estado').forEach(cb=>{
      cb.checked = false;
      cb.closest('.state-pill')?.classList.remove('active');
    });
  }
  
  setFechoBox(false);
  setPropostaBox(false);

 // âœ… PrÃ©-marcar etapas jÃ¡ registadas (multi-estado)
if(edit){
  // prioridade: novo campo multi-estados
  const states =
    Array.isArray(edit.estados) ? edit.estados :
    Array.isArray(edit.estadosHistorico) ? edit.estadosHistorico :
    Array.isArray(edit.estados_history) ? edit.estados_history :
    (edit.estado ? [edit.estado] : []);

  // marcar checks
  document.querySelectorAll('.cb_estado').forEach(cb=>{
    cb.checked = states.includes(cb.value);
    cb.closest('.state-pill')?.classList.toggle('active', cb.checked);
  });

  // disparar 1 change para recalcular PICKED_STATES + efeitos (Proposta/Fecho) e garantir coerÃªncia
  const any = document.querySelector('.cb_estado:checked');
  if(any) any.dispatchEvent(new Event('change'));
}

  resetFechoBox();
  resetPropostaBox();
  // flag: esta lead jÃ¡ tem data de proposta aceite?
$('saveLead').dataset.hasAceite = (v && v.proposta && v.proposta.dataPropostaAceite) ? '1' : '0';

  if(edit && edit.estado==='Fecho'){
    $('ld_fecho_negocio').value = edit.fecho_negocio || '';
    if(edit.fecho_comissao_pct!=='' && edit.fecho_comissao_pct!=null){
      const known=['6','5','4','3'];
      const s=String(edit.fecho_comissao_pct);
      if(known.includes(s)){ $('ld_fecho_comissao').value=s; }
      else{ $('ld_fecho_comissao').value='outro'; $('ld_fecho_comissao_outro').style.display='block'; $('ld_fecho_comissao_outro').value=s+'%'; }
    }
    $('ld_fecho_sinal_reserva').value = edit.fecho_sinal_reserva || '';
    $('ld_fecho_valor_cpcv').value = edit.fecho_valor_cpcv || '';
    INTERCALAres = Array.isArray(edit.fecho_intercalares)? [...edit.fecho_intercalares] : [];
    drawIntercalares(); updateIntercalaresTotal();
    $('ld_fecho_valor_escritura').value = edit.fecho_valor_escritura || '';
    $('ld_fecho_cpcv_date').value = edit.fecho_cpcv_date || '';
    $('ld_fecho_escritura_date').value = edit.fecho_escritura_date || '';
    $('ld_fecho_obs').value = edit.fecho_obs || '';

    $('ld_fecho_pagamento_tipo').value = edit.fecho_pagamento_tipo || '';
    if(edit.fecho_pagamento_tipo === 'outro'){
      $('ld_fecho_pagamento_outro').style.display = 'block';
      $('ld_fecho_pagamento_outro').value = edit.fecho_pagamento_outro || '';
    }else{
      $('ld_fecho_pagamento_outro').style.display = 'none';
      $('ld_fecho_pagamento_outro').value = edit.fecho_pagamento_outro || '';
    }
  }

  if(edit && edit.proposta){
    const p = edit.proposta;
    $('ld_prop_nome').value = p.nomeProponente || '';
    $('ld_prop_contacto').value = p.contactoProponente || '';
    $('ld_prop_email').value = p.emailProponente || '';
    $('ld_prop_valor').value = p.valorProposta || '';
    $('ld_prop_data').value = p.dataProposta || '';
    $('ld_prop_termos').value = p.termosProposta || '';
   const aceiteEl = $('ld_prop_aceite');
aceiteEl.value = (p.dataPropostaAceite || '');

// Se nÃ£o existe data guardada, forÃ§a o campo a ficar efetivamente vazio
if(!p.dataPropostaAceite){
  aceiteEl.value = '';
  aceiteEl.defaultValue = '';
  aceiteEl.setAttribute('value','');
}
    PROPOSTA_CONTRAS = Array.isArray(p.contraPropostas) ? p.contraPropostas.map(c=>({
      data:c.data||'',
      valor:c.valor||'',
      termos:c.termos||''
    })) : [];
    drawContraPropostas();
    setPropostaBox(true);
  }

  $('leadModal').classList.add('show');
}
$('cancelLead').addEventListener('click',()=> $('leadModal').classList.remove('show'));
$('btnNew').addEventListener('click',()=> openModal());

$('saveLead').addEventListener('click',()=>{
  if(!EDIT_MODE){
    alert('Modo de ediÃ§Ã£o bloqueado. Clique em "ðŸ”“ EdiÃ§Ã£o ativa" para guardar alteraÃ§Ãµes.');
    return;
  }
  const get=id=>$(id).value.trim();
 const estadoFinal = getFurthestState(PICKED_STATES, $('saveLead').dataset.editEstado || 'Novo');
    // âœ… Lead existente (quando estÃ¡ a editar). Evita usar "edit" fora de contexto.
  const editId = ($('saveLead').dataset.editId || '').trim();
  const existing = editId ? LEADS.find(l => String(l.id) === String(editId)) : null;

  let comissaoPct = '';
  let pagamentoTipo = '';
  let pagamentoOutro = '';

  if(estadoFinal==='Fecho'){
    const cSel = $('ld_fecho_comissao').value;
    if(cSel==='outro'){ comissaoPct = parsePercent($('ld_fecho_comissao_outro').value); }
    else if(cSel){ comissaoPct = Number(cSel); }

    pagamentoTipo = $('ld_fecho_pagamento_tipo').value.trim();
    pagamentoOutro = pagamentoTipo === 'outro' ? $('ld_fecho_pagamento_outro').value.trim() : '';
  }

  const propDateISO = get('ld_prop_data'); // sÃ³ existe se o utilizador preencher

const propostaObj = {
  nomeProponente: get('ld_prop_nome'),
  contactoProponente: get('ld_prop_contacto'),
  emailProponente: get('ld_prop_email'),
  valorProposta: get('ld_prop_valor'),
  termosProposta: get('ld_prop_termos'),

  // âœ… nunca fica vazio
  dataProposta: propDateISO,

  // âœ… cada contra-proposta fica com data (se vier vazia, herda a data da proposta)
  contraPropostas: (PROPOSTA_CONTRAS || [])
    .filter(cp => cp && (cp.data || cp.valor || cp.termos))
    .map(cp => ({
      data: (cp.data && String(cp.data).trim()) ? String(cp.data).trim() : propDateISO,
      valor: cp.valor || '',
      termos: cp.termos || ''
    })),

  dataPropostaAceite: (() => {
  const raw = get('ld_prop_aceite');

  // Se o utilizador nÃ£o mexeu no campo, nÃ£o gravar nada.
  if(!ACEITE_TOUCHED){
    // Se estiver a editar e jÃ¡ existia aceite, mantÃ©m o valor anterior.
    const prevAceite = (existing && existing.proposta) ? (existing.proposta.dataPropostaAceite || '') : '';
    return prevAceite || '';
  }

  // Se mexeu, grava o que estiver (pode ser vazio se ele apagar)
  return raw || '';
})()
};
 const hasPropostaData =
  (estadoFinal === 'Proposta' || estadoFinal === 'Fecho') && (
    propostaObj.nomeProponente ||
    propostaObj.contactoProponente ||
    propostaObj.emailProponente ||
    propostaObj.valorProposta ||
    propostaObj.termosProposta ||
    propostaObj.dataPropostaAceite ||
    (propostaObj.contraPropostas && propostaObj.contraPropostas.length > 0)
  );
  const lead={
    id: $('saveLead').dataset.editId || uid(),

        estado: estadoFinal,
    // === HistÃ³rico de estados (multi-estado) ===

    // Lista Ãºnica de estados por onde a lead passou
    estados: (()=> {
      const prev = (existing && Array.isArray(existing.estados)) ? existing.estados : [];
      const curr = Array.isArray(PICKED_STATES) && PICKED_STATES.length ? PICKED_STATES : [estadoFinal];
      return Array.from(new Set([...prev, ...curr]));
    })(),

    // Log temporal: quando cada estado foi registado pela 1.Âª vez
    estadosHist: (()=> {
      const prev = (existing && existing.estadosHist && typeof existing.estadosHist === 'object')
        ? { ...existing.estadosHist }
        : {};
      const now = new Date().toISOString();

      const curr = Array.isArray(PICKED_STATES) && PICKED_STATES.length ? PICKED_STATES : [estadoFinal];
      curr.forEach(st=>{
        if(!prev[st]) prev[st] = now;
      });

      return prev;
    })(),
    
    nome: get('ld_nome'),
    consultor: get('ld_consultor'),
    contacto: get('ld_contacto'),
    email: get('ld_email'),
    tipo_negocio: get('ld_tipo_negocio'),
    imovel: get('ld_imovel'),
    tipologia: get('ld_tipologia'),
    zona: get('ld_zona'),
    capitais: get('ld_capitais'),
    valor: get('ld_valor'),
    financiamento: get('ld_financiamento'),
    simulacao: get('ld_simulacao'),
    banco: get('ld_banco'),
    tem_imovel: get('ld_tem_imovel'),
    ja_venda: get('ld_ja_venda'),
    urgente: get('ld_urgente'),
    planta: get('ld_planta'),
    primeira_hab: get('ld_primeira_hab'),
    papel: get('ld_papel'),
    perfil: get('ld_perfil'),
    classificacao: get('ld_classificacao'),
    ref_interna: get('ld_ref'),
    url: get('ld_url'),
    data: get('ld_data'),
    notas: get('ld_notas'),
    visivel: (typeof $('saveLead').dataset.editId==='string') ? undefined : true,

    fecho_negocio: estadoFinal==='Fecho' ? get('ld_fecho_negocio') : '',
    fecho_comissao_pct: estadoFinal==='Fecho' ? comissaoPct : '',
    fecho_sinal_reserva: estadoFinal==='Fecho' ? get('ld_fecho_sinal_reserva') : '',
    fecho_valor_cpcv: estadoFinal==='Fecho' ? get('ld_fecho_valor_cpcv') : '',
    fecho_intercalares: estadoFinal==='Fecho' ? [...INTERCALAres] : [],
    fecho_valor_escritura: estadoFinal==='Fecho' ? get('ld_fecho_valor_escritura') : '',
    fecho_cpcv_date: estadoFinal==='Fecho' ? get('ld_fecho_cpcv_date') : '',
    fecho_escritura_date: estadoFinal==='Fecho' ? get('ld_fecho_escritura_date') : '',
    fecho_obs: estadoFinal==='Fecho' ? get('ld_fecho_obs') : '',
    fecho_pagamento_tipo: estadoFinal==='Fecho' ? pagamentoTipo : '',
    fecho_pagamento_outro: estadoFinal==='Fecho' ? pagamentoOutro : ''
  };

  if(hasPropostaData){
    lead.proposta = propostaObj;
  }else{
    if($('saveLead').dataset.editId){
      const existing = LEADS.find(l=>l.id===$('saveLead').dataset.editId);
      if(existing) delete existing.proposta;
    }
  }

  if(lead.visivel===undefined) lead.visivel=true;

  if(!lead.nome){ alert('Indique o Nome do Cliente.'); return; }
  if(!lead.contacto && !lead.email){ alert('Indique pelo menos Contacto ou Email.'); return; }
  if(lead.email && !isEmail(lead.email)){ alert('Email invÃ¡lido.'); return; }
  if(lead.contacto && !isTel(lead.contacto)){ alert('Contacto invÃ¡lido.'); return; }
  if(lead.url && !isHttp(lead.url)){ alert('URL anexo invÃ¡lido (deve comeÃ§ar por http/https).'); return; }

  const idx=LEADS.findIndex(l=>l.id===lead.id);
  if(idx>=0) LEADS[idx]=Object.assign(LEADS[idx], lead);
  else LEADS.push(lead);

   saveLS();

  // âœ… NOVO: garante/atualiza a tarefa automÃ¡tica da Escritura (criada no 1.Âº dia do mÃªs)
  ensureEscrituraTask(lead);

  $('leadModal').classList.remove('show');
  $('saveLead').dataset.editId=''; $('saveLead').dataset.editEstado='';
  renderBoard();
});

/* ===== Render ===== */
function colTemplate(name,count){
  return `<div class="col" data-col="${name}">
    <header><span class="title">${name}</span><span class="counter">${count}</span></header>
    <div class="list" id="col_${name.replace(/\s/g,'_')}"></div>
  </div>`;
}
function fechoSummary(l){
  const parts=[];
  if(l.fecho_negocio) parts.push(`NegÃ³cio: ${Number(l.fecho_negocio).toLocaleString('pt-PT')}â‚¬`);
  if(l.fecho_comissao_pct!=='' && l.fecho_comissao_pct!=null) parts.push(`ComissÃ£o: ${l.fecho_comissao_pct}%`);
  if(l.fecho_sinal_reserva) parts.push(`Sinal: ${Number(l.fecho_sinal_reserva).toLocaleString('pt-PT')}â‚¬`);
  if(l.fecho_valor_cpcv) parts.push(`CPCV: ${Number(l.fecho_valor_cpcv).toLocaleString('pt-PT')}â‚¬`);
  if(Array.isArray(l.fecho_intercalares) && l.fecho_intercalares.length){
    const soma = sumIntercalares(l.fecho_intercalares);
    parts.push(`Interc.: ${soma.toLocaleString('pt-PT')}â‚¬`);
  }
  if(l.fecho_valor_escritura) parts.push(`Escritura: ${Number(l.fecho_valor_escritura).toLocaleString('pt-PT')}â‚¬`);
  if(l.fecho_cpcv_date) parts.push(`CPCV em ${fmtDate(l.fecho_cpcv_date)}`);
  if(l.fecho_escritura_date) parts.push(`Escritura em ${fmtDate(l.fecho_escritura_date)}`);

  if(l.fecho_pagamento_tipo){
    let label;
    switch(l.fecho_pagamento_tipo){
      case '50_50':
        label = '50% CPCV / 50% Escritura';
        break;
      case '100_escritura':
        label = '100% Escritura';
        break;
      case 'outro':
        label = l.fecho_pagamento_outro || 'Outro';
        break;
      default:
        label = l.fecho_pagamento_tipo;
    }
    parts.push(`Pag. comissÃµes: ${label}`);
  }

  return parts.join(' Â· ');
}

function propostaSummary(l){
  const p = l.proposta;
  if(!p) return '';
  const parts = [];
  if(p.valorProposta) parts.push(`Valor: ${p.valorProposta}`);
  if(p.dataProposta) parts.push(`em ${fmtDate(p.dataProposta)}`);
  if(p.dataPropostaAceite) parts.push(`Aceite em ${fmtDate(p.dataPropostaAceite)}`);
  const contraCount = Array.isArray(p.contraPropostas) ? p.contraPropostas.length : 0;
  if(contraCount) parts.push(`${contraCount} contra-propost${contraCount>1?'as':'a'}`);
  return parts.join(' Â· ');
}

function renderSummary(byEstado){
  const el = $('pipelineSummary'); // mantido por compatibilidade
  const total = byEstado.reduce((s,b)=>s+b.items.length,0);
  const counts = Object.fromEntries(byEstado.map(b=>[b.estado,b.items.length]));
  const fecho = counts['Fecho'] || 0;
  const taxaFecho = total ? (fecho/total*100).toFixed(1) : '0.0';

  if(el){
    el.textContent = ''; // mantemos invisÃ­vel, mas sem perder lÃ³gica se quiser reutilizar
  }

  // Atualizar KPIs no topo (igual mapa)
  const id = (k)=>document.getElementById(k);
  if(id('k_total'))      id('k_total').textContent      = total;
  if(id('k_novo'))       id('k_novo').textContent       = counts['Novo'] || 0;
  if(id('k_contacto'))   id('k_contacto').textContent   = counts['Em Contacto'] || 0;
  if(id('k_qualificado'))id('k_qualificado').textContent= counts['Qualificado'] || 0;
  if(id('k_visita'))     id('k_visita').textContent     = counts['Visita'] || 0;
  if(id('k_proposta'))   id('k_proposta').textContent   = counts['Proposta'] || 0;
  if(id('k_fecho'))      id('k_fecho').textContent      = counts['Fecho'] || 0;
  if(id('k_perdido'))    id('k_perdido').textContent    = counts['Perdido'] || 0;

  // Se quiser usar taxa de fecho em algum lado no futuro, jÃ¡ estÃ¡ calculada
  // console.log('Taxa de fecho:', taxaFecho+'%');
}

function renderBoard(){
  const board=$('board'); board.innerHTML='';

  const term = norm(FILTER.q||'');
  const byEstado = COLS.map(col=>{
    let arr=LEADS.filter(l=>l.estado===col);

    if(term){
      arr=arr.filter(l=>{
        const blob = [
          l.nome,
          l.consultor,
          l.contacto,
          l.email,
          l.ref_interna,
          l.zona,
          l.tipo_negocio,
          l.imovel,
          l.tipologia,
          l.notas
        ].map(x=>norm(x)).join(' ');
        return blob.includes(term);
      });
    }
    if(FILTER.consultor) arr=arr.filter(l=>l.consultor===FILTER.consultor);
    if(FILTER.estado) arr=arr.filter(l=>l.estado===FILTER.estado);
    if(FILTER.ini) arr=arr.filter(l=>!l.data || l.data>=FILTER.ini);
    if(FILTER.fim) arr=arr.filter(l=>!l.data || l.data<=FILTER.fim);
    if(!FILTER.showHidden && !FILTER.onlyHidden) arr=arr.filter(l=>l.visivel!==false);
    if(FILTER.onlyHidden) arr=arr.filter(l=>l.visivel===false);

    return {estado:col, items:arr};
  });

  byEstado.forEach(b=>{
    board.insertAdjacentHTML('beforeend', colTemplate(b.estado,b.items.length));
    const list=$('col_'+b.estado.replace(/\s/g,'_'));
    b.items.forEach(lead=>{
      const card=document.createElement('div'); card.className='card';

      const moveOptions = COLS.map(c=>`<option value="${c}" ${c===lead.estado?'disabled':''}>${c}</option>`).join('');
      const disabledAttr = EDIT_MODE ? '' : 'disabled';

      const classNum = Number(lead.classificacao || 0);
      const classDesc = LEAD_CLASSIFICACAO_MAP[classNum];
      const classLine = classNum
        ? `â­ ClassificaÃ§Ã£o: ${classNum}${classDesc ? ' - '+classDesc : ''}`
        : '';

      const propLine = lead.proposta ? propostaSummary(lead) : '';

      card.innerHTML=`
        <div class="top">
          <div>
            <div class="name">${lead.nome||'â€”'}</div>
            <div class="meta">${lead.consultor||'â€”'} ${lead.ref_interna? ' Â· '+badge('Ref: '+lead.ref_interna):''}</div>
          </div>
        </div>
        <div class="row"><b>Contacto:</b> ${lead.contacto||'â€”'}</div>
        <div class="row"><b>Email:</b> ${lead.email||'â€”'}</div>
        ${classLine ? `<div class="row">${classLine}</div>` : ''}
        <div class="row"><b>Tipo:</b> ${lead.tipo_negocio||'â€”'} Â· <b>ImÃ³vel:</b> ${lead.imovel||'â€”'} Â· <b>Tipologia:</b> ${lead.tipologia||'â€”'}</div>
        <div class="row"><b>Zona:</b> ${lead.zona||'â€”'} Â· <b>Valor:</b> ${lead.valor? Number(lead.valor).toLocaleString('pt-PT'): 'â€”'}</div>
        <div class="row"><b>Data:</b> ${fmtDate(lead.data)} ${lead.url? ' Â· <a href="'+lead.url+'" target="_blank" rel="noreferrer">URL</a>':''}</div>
        ${propLine ? `<div class="row"><b>Proposta:</b> ${propLine}</div>` : ''}
        ${lead.estado==='Fecho' ? `<div class="row">${fechoSummary(lead)}</div>` : ''}
        <div class="actions actions-main">
          <button class="btn btn-ghost" data-act="edit" ${disabledAttr}>Editar</button>
          <button class="btn btn-ghost" data-act="dup" ${disabledAttr}>Duplicar</button>
          <select class="move-select" data-id="${lead.id}" ${disabledAttr}>
            <option value="">Moverâ€¦</option>
            ${moveOptions}
          </select>
          <button class="btn" style="border-color:#cc4b4b;color:#ffdddd" data-act="del" ${disabledAttr}>Apagar</button>
          <button class="btn btn-ghost" data-act="toggle" ${disabledAttr}>${lead.visivel!==false?'Tornar invisÃ­vel':'Tornar visÃ­vel'}</button>
        </div>
        <div class="actions actions-tarefas">
          <button class="btn btn-ghost" data-act="add-task">+ Tarefa</button>
          <button class="btn btn-ghost" data-act="view-tasks">Ver Tarefas</button>
        </div>
      `;

      card.querySelector('[data-act="edit"]').addEventListener('click',()=>{
        if(!EDIT_MODE){ alert('Modo de ediÃ§Ã£o bloqueado. Ative "ðŸ”“ EdiÃ§Ã£o ativa" para editar.'); return; }
        $('saveLead').dataset.editId = lead.id;
        $('saveLead').dataset.editEstado = lead.estado;
        openModal(lead);
      });
      card.querySelector('[data-act="dup"]').addEventListener('click',()=>{
        if(!EDIT_MODE){ alert('Modo de ediÃ§Ã£o bloqueado. Ative "ðŸ”“ EdiÃ§Ã£o ativa" para duplicar.'); return; }
        const copy=Object.assign({},lead,{ id:uid(), ref_interna:(lead.ref_interna? lead.ref_interna+'-copy':''), data:new Date().toISOString().slice(0,10) });
        LEADS.push(copy); saveLS(); renderBoard();
      });

      const selMove = card.querySelector('.move-select');
      selMove.addEventListener('change', e=>{
        if(!EDIT_MODE){ e.target.value=''; alert('Modo de ediÃ§Ã£o bloqueado. Ative "ðŸ”“ EdiÃ§Ã£o ativa" para mover.'); return; }
        const target = e.target.value;
        if(!target || !COLS.includes(target)) return;
        lead.estado = target;
        saveLS(); renderBoard();
      });

      card.querySelector('[data-act="del"]').addEventListener('click',()=>{
        if(!EDIT_MODE){ alert('Modo de ediÃ§Ã£o bloqueado. Ative "ðŸ”“ EdiÃ§Ã£o ativa" para apagar.'); return; }
        if(!confirm('Eliminar esta lead?')) return;
        LEADS=LEADS.filter(x=>x.id!==lead.id); saveLS(); renderBoard();
      });
      card.querySelector('[data-act="toggle"]').addEventListener('click',()=>{
        if(!EDIT_MODE){ alert('Modo de ediÃ§Ã£o bloqueado. Ative "ðŸ”“ EdiÃ§Ã£o ativa" para alterar visibilidade.'); return; }
        lead.visivel = lead.visivel===false ? true : false;
        saveLS(); renderBoard();
      });

      card.querySelector('[data-act="add-task"]').addEventListener('click',()=>{
        createTaskFromLead(lead);
      });
      card.querySelector('[data-act="view-tasks"]').addEventListener('click',()=>{
        window.open('tarefas.html','_blank');
      });

      if(lead.visivel===false) card.style.opacity=.45;
      list.appendChild(card);
    });
  });

  Array.from(document.querySelectorAll('.col')).forEach(col=>{
    const name=col.getAttribute('data-col');
    const count=byEstado.find(x=>x.estado===name)?.items.length||0;
    col.querySelector('.counter').textContent=count;
  });

  renderSummary(byEstado);
}

/* ===== ExportaÃ§Ã£o CSV/XLSX ===== */
function filterForExport(arr){
  let out=[...arr];
  const term = norm(FILTER.q||'');
  if(term){
    out=out.filter(l=>{
      const blob=[
        l.nome,
        l.consultor,
        l.contacto,
        l.email,
        l.ref_interna,
        l.zona,
        l.tipo_negocio,
        l.imovel,
        l.tipologia,
        l.notas
      ].map(x=>norm(x)).join(' ');
      return blob.includes(term);
    });
  }
  if(FILTER.consultor) out=out.filter(l=>l.consultor===FILTER.consultor);
  if(FILTER.estado) out=out.filter(l=>l.estado===FILTER.estado);
  if(FILTER.ini) out=out.filter(l=>!l.data || l.data>=FILTER.ini);
  if(FILTER.fim) out=out.filter(l=>!l.data || l.data<=FILTER.fim);
  if(FILTER.onlyHidden) out=out.filter(l=>l.visivel===false);
  if(!FILTER.showHidden && !FILTER.onlyHidden) out=out.filter(l=>l.visivel!==false);
  return out;
}
function toCSV(rows){ return rows.map(r=>r.map(v=>`"${String(v??'').replaceAll('"','""')}"`).join(',')).join('\n'); }

$('exportCsv').addEventListener('click',()=>{
  const headers=[
    "ID","Estado","Data","Consultor","Nome","Contacto","Email","TipoNegÃ³cio",
    "ImÃ³vel","Tipologia","Zona","Capitais","Valor","Financiamento","SimulaÃ§Ã£o",
    "Banco","Comprador/Vend.","Perfil","ClassificaÃ§Ã£o","RefInterna","URL",
    "Urgente","Planta","1ÂªHab","TemImÃ³vel","JÃ¡Venda","Notas","VisÃ­vel",
    "NegÃ³cio","ComissÃ£o(%)","SinalReserva","ValorCPCV","Intercalares",
    "ValorEscritura","DataCPCV","DataEscritura","PagamentoComissoesTipo",
    "PagamentoComissoesOutro","FechoObs",
    "Prop_NomeProponente","Prop_Contacto","Prop_Email","Prop_Valor","Prop_Termos","Prop_Data","Prop_DataAceite","Prop_ContraPropostas"
  ];
  const rows = filterForExport(LEADS).map(l=>{
    const p = l.proposta || {};
    const contra = Array.isArray(p.contraPropostas)
      ? p.contraPropostas.map(cp=>`${cp.data||''} :: ${cp.valor||''} :: ${cp.termos||''}`).join(' || ')
      : '';
    return [
      l.id,l.estado,l.data||'',l.consultor||'',l.nome||'',l.contacto||'',l.email||'',
      l.tipo_negocio||'',l.imovel||'',l.tipologia||'',l.zona||'',l.capitais||'',l.valor||'',
      l.financiamento||'',l.simulacao||'',l.banco||'',l.papel||'',l.perfil||'',
      l.classificacao||'',l.ref_interna||'',l.url||'',l.urgente||'',l.planta||'',l.primeira_hab||'',
      l.tem_imovel||'',l.ja_venda||'',l.notas||'', (l.visivel!==false?'Sim':'NÃ£o'),
      l.fecho_negocio||'', (l.fecho_comissao_pct!==''&&l.fecho_comissao_pct!=null? l.fecho_comissao_pct : ''),
      l.fecho_sinal_reserva||'', l.fecho_valor_cpcv||'',
      (Array.isArray(l.fecho_intercalares)? l.fecho_intercalares.join(' | ') : ''),
      l.fecho_valor_escritura||'', l.fecho_cpcv_date||'', l.fecho_escritura_date||'',
      l.fecho_pagamento_tipo||'', l.fecho_pagamento_outro||'', l.fecho_obs||'',
      p.nomeProponente||'',p.contactoProponente||'',p.emailProponente||'',p.valorProposta||'',
      p.termosProposta||'',p.dataProposta||'',p.dataPropostaAceite||'',contra
    ];
  });
  const csv=toCSV([headers,...rows]);
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='leads.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});

$('exportXlsx').addEventListener('click',()=>{
  const data = filterForExport(LEADS).map(l=>{
    const p = l.proposta || {};
    const contra = Array.isArray(p.contraPropostas)
      ? p.contraPropostas.map(cp=>`${cp.data||''} :: ${cp.valor||''} :: ${cp.termos||''}`).join(' || ')
      : '';
    return {
      ID:l.id,
      Estado:l.estado,
      Data:l.data||'',
      Consultor:l.consultor||'',
      Nome:l.nome||'',
      Contacto:l.contacto||'',
      Email:l.email||'',
      TipoNegÃ³cio:l.tipo_negocio||'',
      ImÃ³vel:l.imovel||'',
      Tipologia:l.tipologia||'',
      Zona:l.zona||'',
      Capitais:+(l.capitais||0),
      Valor:+(l.valor||0),
      Financiamento:l.financiamento||'',
      SimulaÃ§Ã£o:l.simulacao||'',
      Banco:l.banco||'',
      "Comprador/Vend.":l.papel||'',
      Perfil:l.perfil||'',
      ClassificaÃ§Ã£o:l.classificacao||'',
      "Ref. Interna":l.ref_interna||'',
      URL:l.url||'',
      Urgente:l.urgente||'',
      Planta:l.planta||'',
      "1Âª Hab.":l.primeira_hab||'',
      "Tem ImÃ³vel":l.tem_imovel||'',
      "JÃ¡ Ã  venda":l.ja_venda||'',
      Notas:l.notas||'',
      VisÃ­vel:(l.visivel!==false?'Sim':'NÃ£o'),
      NegÃ³cio:+(l.fecho_negocio||0),
      "ComissÃ£o(%)":(l.fecho_comissao_pct!==''&&l.fecho_comissao_pct!=null? +l.fecho_comissao_pct : ''),
      SinalReserva:+(l.fecho_sinal_reserva||0),
      ValorCPCV:+(l.fecho_valor_cpcv||0),
      Intercalares:(Array.isArray(l.fecho_intercalares)? l.fecho_intercalares.join(' | ') : ''),
      ValorEscritura:+(l.fecho_valor_escritura||0),
      DataCPCV:l.fecho_cpcv_date||'',
      DataEscritura:l.fecho_escritura_date||'',
      PagamentoComissoesTipo:l.fecho_pagamento_tipo||'',
      PagamentoComissoesOutro:l.fecho_pagamento_outro||'',
      FechoObs:l.fecho_obs||'',
      "Prop_NomeProponente":p.nomeProponente||'',
      "Prop_Contacto":p.contactoProponente||'',
      "Prop_Email":p.emailProponente||'',
      "Prop_Valor":p.valorProposta||'',
      "Prop_Termos":p.termosProposta||'',
      "Prop_Data":p.dataProposta||'',
      "Prop_DataAceite":p.dataPropostaAceite||'',
      "Prop_ContraPropostas":contra
    };
  });
  const ws=XLSX.utils.json_to_sheet(data);
  const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Leads');
  XLSX.writeFile(wb, 'leads.xlsx');
});

/* ===== ImportaÃ§Ã£o CSV ===== */
$('importCsvBtn').addEventListener('click', ()=>{
  $('importCsvInput').click();
});

$('importCsvInput').addEventListener('change', (e)=>{
  const file = e.target.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = function(ev){
    try{
      const data = new Uint8Array(ev.target.result);
      const wb = XLSX.read(data, {type:'array'});
      const wsName = wb.SheetNames[0];
      const ws = wb.Sheets[wsName];
      const json = XLSX.utils.sheet_to_json(ws, {defval:''});

      if(!json.length){
        alert('O ficheiro CSV estÃ¡ vazio ou nÃ£o foi possÃ­vel ler dados.');
        return;
      }

      const importedLeads = json.map(row=>{
        const pContraStr = row["Prop_ContraPropostas"] || '';
        const contraPropostas = pContraStr
          ? pContraStr.split('||').map(chunk=>{
              const parts = chunk.split('::').map(s=>s.trim());
              if(parts.every(x=>!x)) return null;
              return {
                data: parts[0] || '',
                valor: parts[1] || '',
                termos: parts[2] || ''
              };
            }).filter(x=>x)
          : [];

        const propostaHasData =
          row["Prop_NomeProponente"] ||
          row["Prop_Contacto"] ||
          row["Prop_Email"] ||
          row["Prop_Valor"] ||
          row["Prop_Termos"] ||
          row["Prop_Data"] ||
          row["Prop_DataAceite"] ||
          (contraPropostas.length>0);

        const proposta = propostaHasData ? {
          nomeProponente: row["Prop_NomeProponente"] || '',
          contactoProponente: row["Prop_Contacto"] || '',
          emailProponente: row["Prop_Email"] || '',
          valorProposta: row["Prop_Valor"] || '',
          termosProposta: row["Prop_Termos"] || '',
          dataProposta: row["Prop_Data"] || '',
          dataPropostaAceite: row["Prop_DataAceite"] || '',
          contraPropostas
        } : undefined;

        const visivelStr = String(row["VisÃ­vel"] || '').toLowerCase();
        const visivel = visivelStr === 'nÃ£o' || visivelStr === 'nao' ? false : true;

        const interStr = row["Intercalares"] || '';
        const interArr = interStr
          ? interStr.split('|').map(s=>s.trim()).filter(s=>s!=='')
          : [];

        return {
          id: row["ID"] || uid(),
          estado: row["Estado"] || 'Novo',
          data: row["Data"] || '',
          consultor: row["Consultor"] || '',
          nome: row["Nome"] || '',
          contacto: row["Contacto"] || '',
          email: row["Email"] || '',
          tipo_negocio: row["TipoNegÃ³cio"] || '',
          imovel: row["ImÃ³vel"] || '',
          tipologia: row["Tipologia"] || '',
          zona: row["Zona"] || '',
          capitais: row["Capitais"] || '',
          valor: row["Valor"] || '',
          financiamento: row["Financiamento"] || '',
          simulacao: row["SimulaÃ§Ã£o"] || '',
          banco: row["Banco"] || '',
          papel: row["Comprador/Vend."] || '',
          perfil: row["Perfil"] || '',
          classificacao: row["ClassificaÃ§Ã£o"] || '',
          ref_interna: row["RefInterna"] || row["Ref. Interna"] || '',
          url: row["URL"] || '',
          urgente: row["Urgente"] || '',
          planta: row["Planta"] || '',
          primeira_hab: row["1ÂªHab"] || row["1Âª Hab."] || '',
          tem_imovel: row["TemImÃ³vel"] || row["Tem ImÃ³vel"] || '',
          ja_venda: row["JÃ¡Venda"] || row["JÃ¡ Ã  venda"] || '',
          notas: row["Notas"] || '',
          visivel,

          fecho_negocio: row["NegÃ³cio"] || '',
          fecho_comissao_pct: row["ComissÃ£o(%)"] !== '' ? row["ComissÃ£o(%)"] : '',
          fecho_sinal_reserva: row["SinalReserva"] || '',
          fecho_valor_cpcv: row["ValorCPCV"] || '',
          fecho_intercalares: interArr,
          fecho_valor_escritura: row["ValorEscritura"] || '',
          fecho_cpcv_date: row["DataCPCV"] || '',
          fecho_escritura_date: row["DataEscritura"] || '',
          fecho_pagamento_tipo: row["PagamentoComissoesTipo"] || '',
          fecho_pagamento_outro: row["PagamentoComissoesOutro"] || '',
          fecho_obs: row["FechoObs"] || '',
          proposta
        };
      });

      const replace = confirm(
        'Deseja SUBSTITUIR todas as leads atuais pelas do ficheiro?\n\n' +
        'OK = substituir tudo\n' +
        'Cancelar = acrescentar Ã s existentes (atualizando apenas IDs coincidentes).'
      );

      if(replace){
        LEADS = [];
      }

      importedLeads.forEach(imp=>{
        const idx = LEADS.findIndex(l=>l.id===imp.id);
        if(idx>=0){
          LEADS[idx] = imp;
        }else{
          LEADS.push(imp);
        }
      });

      saveLS();
      renderBoard();
      alert('ImportaÃ§Ã£o de CSV concluÃ­da com sucesso.');

    }catch(err){
      console.error('Erro ao importar CSV de leads', err);
      alert('Ocorreu um erro ao importar o ficheiro CSV. Verifique se foi exportado a partir desta aplicaÃ§Ã£o.');
    }finally{
      e.target.value='';
    }
  };
  reader.readAsArrayBuffer(file);
});

/* ===== BACKUP / RESTORE JSON ===== */
$('backupJsonBtn').addEventListener('click', ()=>{
  try{
    const payload = {
      version: LS_KEY,
      exportedAt: new Date().toISOString(),
      leads: LEADS,
      filters: FILTER
    };
    const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'leads-backup-'+todayISO()+'.json';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }catch(e){
    console.error('Erro ao criar backup JSON', e);
    alert('Ocorreu um erro ao gerar o backup.');
  }
});

$('restoreJsonBtn').addEventListener('click', ()=>{
  $('restoreJsonInput').click();
});

$('restoreJsonInput').addEventListener('change', (e)=>{
  const file = e.target.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = function(ev){
    try{
      const data = JSON.parse(ev.target.result);
      if(!data || !Array.isArray(data.leads)){
        alert('Ficheiro de backup invÃ¡lido.');
        return;
      }
      if(!confirm('Vai substituir todas as leads e filtros pelos dados do backup.\n\nContinuar?')) return;

      LEADS = data.leads || [];
      saveLS();

      if(data.filters){
        FILTER = Object.assign(FILTER, data.filters);
        persistFilters();
      }

      renderBoard();
      alert('Backup restaurado com sucesso.');
    }catch(err){
      console.error('Erro ao restaurar backup JSON', err);
      alert('Ocorreu um erro ao ler o ficheiro de backup.');
    }finally{
      e.target.value = '';
    }
  };
  reader.readAsText(file);
});

/* ===== Boot ===== */
(function init(){
  LEADS = loadLS();
  buildFilters();
  initLeadConsultorSelect();   // ðŸ‘‰ novo passo
  loadPersistedFilters();

  const stored = localStorage.getItem(EDIT_LS);
  EDIT_MODE = stored==='1';
  updateEditUI();

  $('toggleEdit').addEventListener('click',()=>{
    setEditMode(!EDIT_MODE);
  });

// âœ… SÃ³ consideramos "aceite" se o utilizador mexer neste campo
const aceiteEl = $('ld_prop_aceite');
if(aceiteEl){
  ['input','change'].forEach(evt=>{
    aceiteEl.addEventListener(evt, ()=>{ ACEITE_TOUCHED = true; });
  });
}
  
  renderBoard();
  applyDeepLinkFromTarefas();
})();
</script>
</body>
</html>
