<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<title>Garvetur Porto Pro — Leads (Kanban)</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<style>
  :root{--gold:#A38B63;--bg:#0E0E0E;--panel:#131313;--text:#fff;--muted:#bdbdbd;}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;}
  header{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.1);background:#0F0F0F;}
  nav a{margin-right:6px;text-decoration:none;color:#ddd;border:1px solid rgba(255,255,255,.12);padding:6px 10px;border-radius:8px;}
  nav a.active{background:var(--gold);color:#111;border-color:var(--gold);font-weight:600;}
  .actions{display:flex;gap:8px;}
  .btn{background:transparent;border:1px solid rgba(163,139,99,.5);color:#fff;padding:6px 9px;border-radius:8px;cursor:pointer;font-size:12px;}
  .wrap{display:grid;grid-template-columns:1fr;gap:12px;padding:12px;}
  .panel{background:var(--panel);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px;}
  .panel h3{margin:0 0 8px 0;font-size:13px;color:#eaeaea;border-bottom:1px solid rgba(255,255,255,.06);padding-bottom:6px;}
  .form-grid{display:grid;grid-template-columns:1.4fr 1fr 0.8fr 1fr auto;gap:8px;align-items:end}
  label{font-size:12px;color:#ddd;display:block;margin:4px 0 2px;}
  input,select{width:100%;background:#0E0E0E;color:#fff;border:1px solid rgba(255,255,255,.18);border-radius:8px;padding:8px 10px;}
  .board{display:grid;grid-template-columns:repeat(5,1fr);gap:12px;height:calc(100vh - 220px);}
  .col{background:var(--panel);border:1px solid rgba(255,255,255,.08);border-radius:12px;display:flex;flex-direction:column;overflow:auto;}
  .col h3{margin:0;padding:10px;border-bottom:1px solid rgba(255,255,255,.06);font-size:13px;color:#eaeaea;}
  .lane{padding:10px;display:flex;flex-direction:column;gap:8px;}
  .card{background:#0E0E0E;border:1px solid rgba(255,255,255,.1);border-radius:10px;padding:8px;}
  .card .t{font-weight:600;margin-bottom:4px;}
  .card .m{font-size:12px;color:#cfcfcf;}
  .help{padding:8px 12px;color:#ddd;font-size:12px;border-top:1px dashed rgba(255,255,255,.15);}
  @media(max-width:1200px){.board{grid-template-columns:repeat(3,1fr)}}
  @media(max-width:900px){
    .form-grid{grid-template-columns:1fr}
    .board{grid-template-columns:1fr;height:auto;min-height:60vh;}
  }
</style>
</head>
<body>
<header>
  <div style="display:flex;align-items:center;gap:10px;">
    <strong style="color:#FFD166">Garvetur Porto Pro</strong>
    <nav>
      <a href="./index.html">Mapa</a>
      <a class="active" href="./kanban.html">Leads</a>
      <a href="./angariacoes.html">Angariações</a>
      <a href="./dashboard.html">Dashboard</a>
    </nav>
  </div>
  <div class="actions">
    <button id="seed" class="btn">Carregar dados de exemplo (10)</button>
    <button id="clear" class="btn">Limpar tudo</button>
  </div>
</header>

<div class="wrap">
  <div class="panel">
    <h3>Nova lead</h3>
    <div class="form-grid">
      <div>
        <label>Título</label>
        <input id="f_titulo" placeholder="Ex.: T3 Boavista – Investidor NL">
      </div>
      <div>
        <label>Consultor</label>
        <select id="f_consultor"></select>
      </div>
      <div>
        <label>Valor (€)</label>
        <input id="f_valor" type="number" inputmode="decimal" placeholder="Ex.: 620000">
      </div>
      <div>
        <label>Etiquetas</label>
        <input id="f_tags" placeholder="Ex.: Internacional, Alto valor">
      </div>
      <div style="display:flex;gap:8px;">
        <button id="add" class="btn">+ Adicionar</button>
        <button id="reset" class="btn">Limpar</button>
      </div>
    </div>
  </div>

  <div class="board" id="board"></div>
  <div class="help">Dica: arraste as cards entre colunas. Duplo-clique para editar; tecla <em>Delete</em> remove.</div>
</div>

<script>
const LS_KEY = 'gpp_leads_v2';           // versão nova p/ não chocar com dados antigos
const COLUMNS = ["Novo","Em contacto","Qualificado","Proposta","Fecho"];
const CONSULTORS = [
  "Rui Quelhas",
  "Manuel Oliveira",
  "João Sousa",
  "Francisco dos Santos",
  "Rosário Vasconcelos",
  "Armanda Meireles",
  "Audrey Lucas",
  "Outro…"
];

function load(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||'{}'); }catch(e){ return {}; } }
function save(data){ localStorage.setItem(LS_KEY, JSON.stringify(data)); }
function ensureModel(d){ COLUMNS.forEach(c=>{ if(!Array.isArray(d[c])) d[c]=[]; }); return d; }

function fillConsultorSelect(){
  const sel = document.getElementById('f_consultor');
  sel.innerHTML = CONSULTORS.map(n=>`<option value="${n}">${n}</option>`).join('');
  sel.value = CONSULTORS[0];
}

function cardEl(card, col, idx){
  const d = document.createElement('div');
  d.className='card'; d.draggable=true; d.tabIndex=0;
  d.innerHTML = `<div class="t">${card.titulo || '(Sem título)'}</div>
                 <div class="m">${card.consultor||''}${card.valor? ' · '+card.valor+'€':''}${card.etiquetas? ' · '+card.etiquetas:''}</div>`;
  d.ondblclick = ()=> editCard(col, idx);
  d.onkeydown = (e)=>{ if(e.key==='Delete'){ removeCard(col, idx); } };
  return d;
}

function render(){
  const data = ensureModel(load());
  const board = document.getElementById('board');
  board.innerHTML='';
  COLUMNS.forEach(col=>{
    const el = document.createElement('div');
    el.className='col';
    el.innerHTML = `<h3>${col} (${data[col].length})</h3><div class="lane" data-col="${col}"></div>`;
    const lane = el.querySelector('.lane');
    data[col].forEach((card,i)=> lane.appendChild(cardEl(card, col, i)));
    board.appendChild(el);
  });
  enableDnD();
}

function enableDnD(){
  document.querySelectorAll('.lane .card').forEach(card=>{
    card.addEventListener('dragstart', ev=>{
      const lane = card.closest('.lane');
      const col = lane.dataset.col;
      const idx = Array.from(lane.children).indexOf(card);
      ev.dataTransfer.setData('text/plain', JSON.stringify({col, idx}));
    });
  });
  document.querySelectorAll('.lane').forEach(lane=>{
    lane.addEventListener('dragover', ev=> ev.preventDefault());
    lane.addEventListener('drop', ev=>{
      ev.preventDefault();
      const src = JSON.parse(ev.dataTransfer.getData('text/plain'));
      const dstCol = lane.dataset.col;
      const data = ensureModel(load());
      const [item] = data[src.col].splice(src.idx,1);
      data[dstCol].unshift(item);
      save(data); render();
    });
  });
}

// CRUD
function addCard(){
  const titulo = document.getElementById('f_titulo').value.trim();
  if(!titulo) return alert('Indique um título.');
  let consultor = document.getElementById('f_consultor').value;
  if(consultor === 'Outro…'){
    const alt = prompt('Nome do consultor:','');
    if(!alt) return alert('Indique o nome do consultor.');
    consultor = alt.trim();
  }
  const valor = document.getElementById('f_valor').value.trim();
  const etiquetas = document.getElementById('f_tags').value.trim();

  const data = ensureModel(load());
  data["Novo"].unshift({titulo, consultor, valor, etiquetas});
  save(data); render(); resetForm();
}

function resetForm(){
  document.getElementById('f_titulo').value='';
  document.getElementById('f_valor').value='';
  document.getElementById('f_tags').value='';
  document.getElementById('f_consultor').value = CONSULTORS[0];
}

function editCard(col, idx){
  const data = ensureModel(load());
  const c = data[col][idx];
  const titulo = prompt('Editar título:', c.titulo||'') ?? c.titulo;

  // Sugere lista mas mantém liberdade (não bloqueia)
  let consultor = prompt('Editar consultor (ex.: ' + CONSULTORS.slice(0,7).join(', ') + '):', c.consultor||'');
  if(consultor===null) consultor = c.consultor;

  const valor = prompt('Editar valor (€):', c.valor||'');
  const etiquetas = prompt('Editar etiquetas:', c.etiquetas||'');

  data[col][idx] = {titulo, consultor, valor: (valor??c.valor), etiquetas:(etiquetas??c.etiquetas)};
  save(data); render();
}

function removeCard(col, idx){
  if(!confirm('Remover esta lead?')) return;
  const data = ensureModel(load());
  data[col].splice(idx,1);
  save(data); render();
}

// Seed demo (10)
function seedDemo(){
  if(!confirm('Carregar 10 leads de exemplo? (substitui as atuais)')) return;
  const ex = {
    "Novo": [
      {titulo:"T2 Matosinhos — Arrendamento", consultor:"Armanda Meireles", valor:"1200", etiquetas:"Internacional"},
      {titulo:"T3 Boavista — Venda", consultor:"Manuel Oliveira", valor:"620000", etiquetas:"Alto valor"}
    ],
    "Em contacto": [
      {titulo:"Terreno Gondomar — Investidor", consultor:"João Sousa", valor:"", etiquetas:"Investidor"}
    ],
    "Qualificado": [
      {titulo:"T1 Cedofeita — Estudante FR", consultor:"Audrey Lucas", valor:"235000", etiquetas:"Internacional"},
      {titulo:"Loja Foz — Rent Yield", consultor:"Manuel Oliveira", valor:"450000", etiquetas:"Yield"}
    ],
    "Proposta": [
      {titulo:"T4 Gaia — 1ª habitação", consultor:"Armanda Meireles", valor:"395000", etiquetas:"Nacional"},
      {titulo:"Prédio Baixa — BTR", consultor:"João Sousa", valor:"", etiquetas:"Investidor, BTR"}
    ],
    "Fecho": [
      {titulo:"T2 Antas — Chaves esta semana", consultor:"Manuel Oliveira", valor:"285000", etiquetas:"Fecho"},
      {titulo:"T3 Leça — Proc. financiamento", consultor:"Audrey Lucas", valor:"", etiquetas:"Financiamento"},
      {titulo:"T0 Bonfim — Escritura 10/12", consultor:"Rui Quelhas", valor:"175000", etiquetas:"Fecho"}
    ]
  };
  save(ex); render();
}

// Eventos
document.getElementById('add').onclick=addCard;
document.getElementById('reset').onclick=resetForm;
document.getElementById('seed').onclick=seedDemo;
document.getElementById('clear').onclick=()=>{ if(confirm('Apagar todas as leads?')){ localStorage.removeItem(LS_KEY); render(); } };

fillConsultorSelect();
render();
</script>
</body>
</html>
