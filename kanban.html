<!doctype html>
<html lang="pt">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Garvetur Porto Pro — Leads (Kanban)</title>

<link rel="preconnect" href="https://unpkg.com" crossorigin>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>

<!-- SheetJS para exportar Excel -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js" defer></script>

<style>
:root{ --gold:#A38B63; --bg:#0E0E0E; --panel:#131313; --text:#fff; --muted:#9AA0A6; --border:rgba(255,255,255,.12)}
html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial}
a{color:#eaeaea;text-decoration:none}
.app{display:grid;grid-template-rows:56px auto 1fr;height:100%}
header{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--border);background:#0F0F0F}
.brand{display:flex;align-items:center;gap:10px}
.brand h1{font-size:16px;margin:0;color:var(--gold)}
.nav{display:flex;gap:8px}
.nav a{border:1px solid var(--border);padding:6px 10px;border-radius:8px;color:#ddd}
.nav a.active{background:var(--gold);color:#111;border-color:var(--gold);font-weight:700}

.toolbar{display:flex;gap:8px;flex-wrap:wrap;padding:8px 12px;border-bottom:1px solid var(--border);background:#0F0F0F}
.btn{background:transparent;border:1px solid rgba(163,139,99,.5);color:#fff;padding:6px 10px;border-radius:10px;cursor:pointer;font-size:12px}
.btn.primary{background:var(--gold);color:#111;border-color:var(--gold);font-weight:700}
.btn.ghost{border-color:var(--border);color:#ddd}

.board{display:grid;grid-template-columns:repeat(6,1fr);gap:10px;padding:10px;height:100%;overflow:auto}
.col{background:var(--panel);border:1px solid var(--border);border-radius:12px;display:flex;flex-direction:column;min-width:240px}
.col header{padding:10px;border-bottom:1px solid rgba(255,255,255,.08);display:flex;align-items:center;justify-content:space-between}
.col header .title{font-weight:700}
.counter{font-size:12px;color:#cfcfcf}
.col .list{padding:10px;display:flex;flex-direction:column;gap:10px}

.card{background:#0E0E0E;border:1px solid rgba(163,139,99,.25);border-radius:12px;padding:10px}
.card .top{display:flex;justify-content:space-between;gap:8px}
.card .name{font-weight:800}
.card .meta{font-size:12px;color:#bbb}
.card .row{margin-top:6px;font-size:12px;color:#ddd}
.card .actions{margin-top:8px;display:flex;gap:6px;flex-wrap:wrap}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--border);font-size:11px}
.badge.light{border-color:#444;color:#ccc}
.label{font-size:12px;color:#cfcfcf;margin:6px 0 4px}
.filters{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.filters select,.filters input{background:#0E0E0E;border:1px solid rgba(255,255,255,.16);border-radius:8px;color:#fff;padding:6px 8px;outline:none;font-size:12px}

.modal-backdrop{display:none;position:fixed;inset:0;z-index:10000;background:rgba(0,0,0,.6);backdrop-filter:blur(2px);align-items:center;justify-content:center;padding:16px}
.modal-backdrop.show{display:flex}
.modal{width:min(920px,96vw);background:#0F0F0F;border:1px solid var(--border);border-radius:12px;overflow:hidden}
.modal header{padding:10px 12px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.modal .content{padding:12px;max-height:72vh;overflow:auto}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.form-field{display:flex;flex-direction:column;gap:6px}
.form-field input,.form-field select,.form-field textarea{background:#0E0E0E;border:1px solid rgba(255,255,255,.16);border-radius:8px;color:#fff;padding:8px 10px;outline:none}
.form-field small{color:#9AA0A6}
.help{font-size:12px;color:#bdbdbd}

.state-pills{display:flex;gap:8px;flex-wrap:wrap}
.state-pill{display:flex;align-items:center;gap:6px;border:1px solid rgba(255,255,255,.18);border-radius:999px;padding:6px 10px;font-size:12px;background:#0E0E0E;cursor:pointer}
.state-pill input{accent-color:#A38B63; width:14px; height:14px}
.state-pill.active{background:#1c1c1c;border-color:#A38B63}

@media (max-width:1200px){ .board{grid-template-columns:repeat(3,1fr)} }
@media (max-width:800px){ .board{grid-template-columns:1fr} }
</style>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" style="color:var(--gold)"><circle cx="12" cy="12" r="10" stroke-width="1.5"/><path d="M8 12l2.5 2.5L16 9" stroke-width="1.8"/></svg>
        <h1>Garvetur Porto Pro — Leads</h1>
      </div>
      <div class="nav">
        <a href="./index.html">Mapa</a>
        <a class="active" href="./kanban.html">Leads</a>
        <a href="./angariacoes.html">Angariações</a>
        <a href="./dashboard.html">Dashboard</a>
      </div>
    </header>

    <div class="toolbar">
      <button class="btn primary" id="btnNew">+ Nova Lead</button>
      <div class="filters">
        <span class="label">Consultor</span>
        <select id="f_consultor"><option value="">(Todos)</option></select>
        <span class="label">Estado</span>
        <select id="f_estado">
          <option value="">(Todos)</option>
          <option>Novo</option>
          <option>Em Contacto</option>
          <option>Qualificado</option>
          <option>Visita</option>
          <option>Proposta</option>
          <option>Fecho</option>
        </select>
        <span class="label">Período</span>
        <input id="f_ini" type="date"> <input id="f_fim" type="date">
        <button class="btn" id="applyFilters">Aplicar</button>
        <button class="btn ghost" id="clearFilters">Limpar</button>
      </div>
      <div style="margin-left:auto;display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn" id="exportCsv">Exportar CSV</button>
        <button class="btn" id="exportXlsx">Exportar Excel</button>
      </div>
    </div>

    <div class="board" id="board">
      <!-- colunas -->
    </div>
  </div>

<!-- Modal Nova/Editar Lead -->
<div id="leadModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-label="Lead">
  <div class="modal">
    <header>
      <div><strong id="modalTitle">Nova Lead</strong></div>
      <div style="display:flex;gap:8px">
        <button class="btn" id="cancelLead">Cancelar</button>
        <button class="btn primary" id="saveLead">Guardar</button>
      </div>
    </header>
    <div class="content">
      <div class="grid2">
        <div class="form-field"><label>Nome Cliente *</label><input id="ld_nome"></div>
        <div class="form-field"><label>Consultor *</label>
          <select id="ld_consultor">
            <option value="">—</option>
            <option>Rui Quelhas</option>
            <option>Manuel Oliveira</option>
            <option>João Sousa</option>
            <option>Francisco dos Santos</option>
            <option>Rosário Vasconcelos</option>
            <option>Armanda Meireles</option>
            <option>Audrey Lucas</option>
          </select>
        </div>

        <div class="form-field"><label>Contacto *</label><input id="ld_contacto" placeholder="+351 … ou 9 dígitos"></div>
        <div class="form-field"><label>Email</label><input id="ld_email" type="email"></div>

        <div class="form-field"><label>Tipo de negócio</label>
          <select id="ld_tipo_negocio">
            <option value="">—</option><option>Venda</option><option>Compra</option><option>Arrendamento</option><option>Permuta</option>
          </select>
        </div>
        <div class="form-field"><label>Imóvel</label>
          <select id="ld_imovel">
            <option value="">—</option><option>Moradia</option><option>Apartamento</option><option>Loja</option><option>Armazém</option><option>Escritório</option><option>Terreno</option><option>Outro</option>
          </select>
        </div>

        <div class="form-field"><label>Tipologia</label>
          <select id="ld_tipologia">
            <option value="">—</option><option>T0</option><option>T1</option><option>T2</option><option>T3</option><option>T4</option><option>T5</option><option>&gt;T5</option>
          </select>
        </div>
        <div class="form-field"><label>Zona preferencial</label><input id="ld_zona"></div>

        <div class="form-field"><label>Capitais próprios (€)</label><input id="ld_capitais" type="number" min="0" step="1000"></div>
        <div class="form-field"><label>Valor alvo (€)</label><input id="ld_valor" type="number" min="0" step="1000"></div>

        <div class="form-field"><label>Financiamento bancário?</label>
          <select id="ld_financiamento"><option>Não</option><option>Sim</option></select>
        </div>
        <div class="form-field"><label>Simulação bancária?</label>
          <select id="ld_simulacao"><option>Não</option><option>Sim</option></select>
        </div>

        <div class="form-field"><label>Instituição bancária (se aplicável)</label><input id="ld_banco"></div>
        <div class="form-field"><label>Tem imóvel para vender?</label>
          <select id="ld_tem_imovel"><option>Não</option><option>Sim</option></select>
        </div>

        <div class="form-field"><label>Já está à venda?</label>
          <select id="ld_ja_venda"><option>Não</option><option>Sim</option></select>
        </div>
        <div class="form-field"><label>Urgente?</label>
          <select id="ld_urgente"><option>Não</option><option>Sim</option></select>
        </div>

        <div class="form-field"><label>Pode comprar em planta?</label>
          <select id="ld_planta"><option>Não</option><option>Sim</option></select>
        </div>
        <div class="form-field"><label>1ª habitação?</label>
          <select id="ld_primeira_hab"><option>Não</option><option>Sim</option></select>
        </div>

        <div class="form-field"><label>Comprador/Vendedor</label>
          <select id="ld_papel"><option value="">—</option><option>Comprador</option><option>Vendedor</option></select>
        </div>
        <div class="form-field"><label>Investidor/Cliente final</label>
          <select id="ld_perfil"><option value="">—</option><option>Investidor</option><option>Cliente final</option></select>
        </div>

        <div class="form-field"><label>Classificação (1–5)</label>
          <select id="ld_classificacao"><option value="">—</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option></select>
        </div>
        <div class="form-field"><label>Ref. Interna</label><input id="ld_ref"></div>

        <div class="form-field"><label>URL anexo</label>
          <input id="ld_url" placeholder="https://…"><small>Ex.: link de documento ou pasta (Drive/Dropbox/OneDrive).</small>
        </div>
        <div class="form-field"><label>Data</label><input id="ld_data" type="date"></div>

        <div class="form-field" style="grid-column:1 / span 2"><label>Notas</label><textarea id="ld_notas" rows="3"></textarea></div>
      </div>

      <!-- ESTADO (seleção rápida) -->
      <div class="form-field" style="margin-top:6px">
        <label>Estado (seleção rápida)</label>
        <div class="state-pills" id="ld_estado_picker">
          <label class="state-pill"><input type="checkbox" class="cb_estado" value="Em Contacto"> Em Contacto</label>
          <label class="state-pill"><input type="checkbox" class="cb_estado" value="Qualificado"> Qualificado</label>
          <label class="state-pill"><input type="checkbox" class="cb_estado" value="Visita"> Visita</label>
          <label class="state-pill"><input type="checkbox" class="cb_estado" value="Proposta"> Proposta</label>
          <label class="state-pill"><input type="checkbox" class="cb_estado" value="Fecho"> Fecho</label>
        </div>
        <div class="help">Se selecionar um estado, o cartão será gravado diretamente nessa coluna. Se nada selecionar, fica em <b>Novo</b>.</div>
      </div>

      <!-- Campos adicionais para FECHO -->
      <div id="fechoBox" class="grid2" style="margin-top:8px; display:none">
        <div class="form-field"><label>Data do CPCV</label><input id="ld_fecho_cpcv_date" type="date"></div>
        <div class="form-field"><label>Data da Escritura</label><input id="ld_fecho_escritura_date" type="date"></div>
        <div class="form-field"><label>Valor a Dar no CPCV (€)</label><input id="ld_fecho_valor_cpcv" type="number" min="0" step="1000"></div>
        <div class="form-field"><label>Valor de Sinal/Reserva (€)</label><input id="ld_fecho_sinal_reserva" type="number" min="0" step="500"></div>
        <div class="form-field" style="grid-column:1 / span 2"><label>Observações</label><textarea id="ld_fecho_obs" rows="3"></textarea></div>
      </div>
    </div>
  </div>
</div>

<script>
/* ===== Estado ===== */
const LS_KEY='gpp_leads_v3';
const COLS=["Novo","Em Contacto","Qualificado","Visita","Proposta","Fecho"];
const CONSULT_RESOLVE=["Rui Quelhas","Manuel Oliveira","João Sousa","Francisco dos Santos","Rosário Vasconcelos","Armanda Meireles","Audrey Lucas"];

let LEADS=[]; // {id, estado, ..., fecho_*}
let FILTER={ consultor:'', estado:'', ini:'', fim:'' };
let PICKED_STATE=''; // estado escolhido nos “piscos”

const $=id=>document.getElementById(id);
const norm=s=>String(s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');

/* ===== Persistência ===== */
function loadLS(){ try{ const x=localStorage.getItem(LS_KEY); return x? JSON.parse(x):[];}catch{return[];} }
function saveLS(){ localStorage.setItem(LS_KEY, JSON.stringify(LEADS)); }

/* ===== UI Helpers ===== */
function badge(txt){ return `<span class="badge light">${txt||'—'}</span>`; }
function fmtDate(d){ if(!d) return '—'; try{ const z=new Date(d); return z.toLocaleDateString('pt-PT'); }catch{return d;} }
function isEmail(e){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(e||'')); }
function isTel(t){ const s=String(t||'').replace(/\s+/g,''); return /^\+?\d{9,15}$/.test(s); }
function isHttp(u){ return /^https?:\/\//i.test(String(u||'')); }
function uid(){ return 'L'+Math.random().toString(36).slice(2,9)+Date.now().toString(36).slice(-4); }

/* ===== Filtros barra ===== */
function buildFilters(){
  const sel=$('f_consultor'); sel.innerHTML='<option value="">(Todos)</option>'+CONSULT_RESOLVE.map(c=>`<option>${c}</option>`).join('');
}
$('applyFilters').addEventListener('click',()=>{
  FILTER.consultor=$('f_consultor').value; FILTER.estado=$('f_estado').value;
  FILTER.ini=$('f_ini').value; FILTER.fim=$('f_fim').value;
  renderBoard();
});
$('clearFilters').addEventListener('click',()=>{
  FILTER={consultor:'',estado:'',ini:'',fim:''};
  ['f_consultor','f_estado','f_ini','f_fim'].forEach(id=>$(id).value='');
  renderBoard();
});

/* ===== Modal Nova Lead ===== */
function resetFechoBox(){ $('ld_fecho_cpcv_date').value=''; $('ld_fecho_escritura_date').value=''; $('ld_fecho_valor_cpcv').value=''; $('ld_fecho_sinal_reserva').value=''; $('ld_fecho_obs').value=''; }
function setFechoBox(show){ $('fechoBox').style.display = show? 'grid':'none'; }

function initStatePicker(){
  PICKED_STATE='';
  document.querySelectorAll('.cb_estado').forEach(cb=>{
    cb.checked=false;
    cb.closest('.state-pill')?.classList.remove('active');
    cb.addEventListener('change', e=>{
      // Exclusivo: desmarca os outros
      document.querySelectorAll('.cb_estado').forEach(x=>{
        if(x!==cb){ x.checked=false; x.closest('.state-pill')?.classList.remove('active'); }
      });
      if(cb.checked){
        PICKED_STATE=cb.value;
        cb.closest('.state-pill')?.classList.add('active');
      }else{
        PICKED_STATE='';
      }
      setFechoBox(PICKED_STATE==='Fecho');
    });
  });
}

function openModal(edit=null){
  $('modalTitle').textContent = edit? 'Editar Lead' : 'Nova Lead';
  const f = (id,val='') => $(id).value = (val??'');
  const v = edit||{};
  f('ld_nome', v.nome);
  f('ld_consultor', v.consultor||'');
  f('ld_contacto', v.contacto);
  f('ld_email', v.email);
  f('ld_tipo_negocio', v.tipo_negocio);
  f('ld_imovel', v.imovel);
  f('ld_tipologia', v.tipologia);
  f('ld_zona', v.zona);
  f('ld_capitais', v.capitais);
  f('ld_valor', v.valor);
  f('ld_financiamento', v.financiamento||'Não');
  f('ld_simulacao', v.simulacao||'Não');
  f('ld_banco', v.banco);
  f('ld_tem_imovel', v.tem_imovel||'Não');
  f('ld_ja_venda', v.ja_venda||'Não');
  f('ld_urgente', v.urgente||'Não');
  f('ld_planta', v.planta||'Não');
  f('ld_primeira_hab', v.primeira_hab||'Não');
  f('ld_papel', v.papel||'');
  f('ld_perfil', v.perfil||'');
  f('ld_classificacao', v.classificacao||'');
  f('ld_ref', v.ref_interna||'');
  f('ld_url', v.url||'');
  f('ld_data', v.data||new Date().toISOString().slice(0,10));
  f('ld_notas', v.notas||'');

  // picker de estado (reset + marcar se estiver a editar)
  initStatePicker();
  if(edit && COLS.includes(edit.estado) && edit.estado!=='Novo'){
    const sel = Array.from(document.querySelectorAll('.cb_estado')).find(x=>x.value===edit.estado);
    if(sel){ sel.checked=true; sel.dispatchEvent(new Event('change')); }
  } else {
    setFechoBox(false);
  }

  // preencher fecho se existir
  resetFechoBox();
  if(edit && edit.estado==='Fecho'){
    $('ld_fecho_cpcv_date').value = edit.fecho_cpcv_date || '';
    $('ld_fecho_escritura_date').value = edit.fecho_escritura_date || '';
    $('ld_fecho_valor_cpcv').value = edit.fecho_valor_cpcv || '';
    $('ld_fecho_sinal_reserva').value = edit.fecho_sinal_reserva || '';
    $('ld_fecho_obs').value = edit.fecho_obs || '';
  }

  $('leadModal').classList.add('show');
}
$('cancelLead').addEventListener('click',()=> $('leadModal').classList.remove('show'));
$('btnNew').addEventListener('click',()=> openModal());

$('saveLead').addEventListener('click',()=>{
  const get=id=>$(id).value.trim();
  // estado final (pelo picker) — se vazio, fica "Novo"
  const estadoFinal = PICKED_STATE || $('saveLead').dataset.editEstado || 'Novo';

  const lead={
    id: $('saveLead').dataset.editId || uid(),
    estado: estadoFinal,
    nome: get('ld_nome'),
    consultor: get('ld_consultor'),
    contacto: get('ld_contacto'),
    email: get('ld_email'),
    tipo_negocio: get('ld_tipo_negocio'),
    imovel: get('ld_imovel'),
    tipologia: get('ld_tipologia'),
    zona: get('ld_zona'),
    capitais: get('ld_capitais'),
    valor: get('ld_valor'),
    financiamento: get('ld_financiamento'),
    simulacao: get('ld_simulacao'),
    banco: get('ld_banco'),
    tem_imovel: get('ld_tem_imovel'),
    ja_venda: get('ld_ja_venda'),
    urgente: get('ld_urgente'),
    planta: get('ld_planta'),
    primeira_hab: get('ld_primeira_hab'),
    papel: get('ld_papel'),
    perfil: get('ld_perfil'),
    classificacao: get('ld_classificacao'),
    ref_interna: get('ld_ref'),
    url: get('ld_url'),
    data: get('ld_data'),
    notas: get('ld_notas'),
    visivel: true,

    // campos de FECHO (só guardamos se estado for Fecho)
    fecho_cpcv_date: estadoFinal==='Fecho' ? get('ld_fecho_cpcv_date') : '',
    fecho_escritura_date: estadoFinal==='Fecho' ? get('ld_fecho_escritura_date') : '',
    fecho_valor_cpcv: estadoFinal==='Fecho' ? get('ld_fecho_valor_cpcv') : '',
    fecho_sinal_reserva: estadoFinal==='Fecho' ? get('ld_fecho_sinal_reserva') : '',
    fecho_obs: estadoFinal==='Fecho' ? get('ld_fecho_obs') : ''
  };

  // Validações mínimas
  if(!lead.nome){ alert('Indique o Nome do Cliente.'); return; }
  if(!lead.contacto && !lead.email){ alert('Indique pelo menos Contacto ou Email.'); return; }
  if(lead.email && !isEmail(lead.email)){ alert('Email inválido.'); return; }
  if(lead.contacto && !isTel(lead.contacto)){ alert('Contacto inválido.'); return; }
  if(lead.url && !isHttp(lead.url)){ alert('URL anexo inválido (deve começar por http/https).'); return; }

  const idx=LEADS.findIndex(l=>l.id===lead.id);
  if(idx>=0) LEADS[idx]=Object.assign(LEADS[idx], lead);
  else LEADS.push(lead);

  saveLS();
  $('leadModal').classList.remove('show');
  $('saveLead').dataset.editId=''; $('saveLead').dataset.editEstado='';
  renderBoard();
});

/* ===== Render Board ===== */
function colTemplate(name,count){
  return `<div class="col" data-col="${name}">
    <header><span class="title">${name}</span><span class="counter">${count}</span></header>
    <div class="list" id="col_${name.replace(/\s/g,'_')}"></div>
  </div>`;
}
function fechoLine(l){
  const a = [];
  if(l.fecho_cpcv_date) a.push(`CPCV: ${fmtDate(l.fecho_cpcv_date)}`);
  if(l.fecho_escritura_date) a.push(`Escritura: ${fmtDate(l.fecho_escritura_date)}`);
  if(l.fecho_valor_cpcv) a.push(`Valor CPCV: ${Number(l.fecho_valor_cpcv).toLocaleString('pt-PT')}`);
  if(l.fecho_sinal_reserva) a.push(`Sinal/Reserva: ${Number(l.fecho_sinal_reserva).toLocaleString('pt-PT')}`);
  return a.join(' · ');
}
function renderBoard(){
  const board=$('board'); board.innerHTML='';
  const byEstado = COLS.map(col=>{
    let arr=LEADS.filter(l=>l.estado===col);
    // filtros
    if(FILTER.consultor) arr=arr.filter(l=>l.consultor===FILTER.consultor);
    if(FILTER.estado) arr=arr.filter(l=>l.estado===FILTER.estado);
    if(FILTER.ini) arr=arr.filter(l=>!l.data || l.data>=FILTER.ini);
    if(FILTER.fim) arr=arr.filter(l=>!l.data || l.data<=FILTER.fim);
    return {estado:col, items:arr};
  });

  byEstado.forEach(b=>{
    board.insertAdjacentHTML('beforeend', colTemplate(b.estado,b.items.length));
    const list=$('col_'+b.estado.replace(/\s/g,'_'));
    b.items.forEach(lead=>{
      const card=document.createElement('div'); card.className='card';
      card.innerHTML=`
        <div class="top">
          <div>
            <div class="name">${lead.nome||'—'}</div>
            <div class="meta">${lead.consultor||'—'} ${lead.ref_interna? ' · '+badge('Ref: '+lead.ref_interna):''}</div>
          </div>
          <div>${lead.classificacao? badge('★ '+lead.classificacao): ''}</div>
        </div>
        <div class="row"><b>Contacto:</b> ${lead.contacto||'—'}</div>
        <div class="row"><b>Email:</b> ${lead.email||'—'}</div>
        <div class="row"><b>Tipo:</b> ${lead.tipo_negocio||'—'} · <b>Imóvel:</b> ${lead.imovel||'—'} · <b>Tipologia:</b> ${lead.tipologia||'—'}</div>
        <div class="row"><b>Zona:</b> ${lead.zona||'—'} · <b>Valor:</b> ${lead.valor? Number(lead.valor).toLocaleString('pt-PT'): '—'}</div>
        <div class="row"><b>Data:</b> ${fmtDate(lead.data)} ${lead.url? ' · <a href="'+lead.url+'" target="_blank" rel="noreferrer">URL</a>':''}</div>
        ${lead.estado==='Fecho' ? `<div class="row">${fechoLine(lead) || ''}</div>` : ''}
        <div class="actions">
          <button class="btn" data-act="edit">Editar</button>
          <button class="btn" data-act="dup">Duplicar</button>
          <button class="btn ghost" data-act="move">Mover…</button>
          <button class="btn" style="border-color:#cc4b4b;color:#ffdddd" data-act="del">Apagar</button>
          <button class="btn" data-act="toggle">${lead.visivel!==false?'Tornar invisível':'Tornar visível'}</button>
        </div>
      `;
      // Ações
      card.querySelector('[data-act="edit"]').addEventListener('click',()=>{
        $('saveLead').dataset.editId = lead.id;
        $('saveLead').dataset.editEstado = lead.estado;
        openModal(lead);
      });
      card.querySelector('[data-act="dup"]').addEventListener('click',()=>{
        const copy=Object.assign({},lead,{ id:uid(), ref_interna:(lead.ref_interna? lead.ref_interna+'-copy':''), data:new Date().toISOString().slice(0,10) });
        LEADS.push(copy); saveLS(); renderBoard();
      });
      card.querySelector('[data-act="move"]').addEventListener('click',()=>{
        const nxt = prompt('Mover para (Novo | Em Contacto | Qualificado | Visita | Proposta | Fecho):', lead.estado);
        if(!nxt || !COLS.includes(nxt)) return;
        lead.estado=nxt; saveLS(); renderBoard();
      });
      card.querySelector('[data-act="del"]').addEventListener('click',()=>{
        if(!confirm('Eliminar esta lead?')) return;
        LEADS=LEADS.filter(x=>x.id!==lead.id); saveLS(); renderBoard();
      });
      card.querySelector('[data-act="toggle"]').addEventListener('click',()=>{
        lead.visivel = lead.visivel===false ? true : false;
        saveLS(); renderBoard();
      });

      if(lead.visivel===false) card.style.opacity=.45;
      list.appendChild(card);
    });
  });

  // atualizar contadores
  Array.from(document.querySelectorAll('.col')).forEach(col=>{
    const name=col.getAttribute('data-col');
    const count=byEstado.find(x=>x.estado===name)?.items.length||0;
    col.querySelector('.counter').textContent=count;
  });
}

/* ===== Exportação ===== */
function filterForExport(arr){
  let out=[...arr];
  if(FILTER.consultor) out=out.filter(l=>l.consultor===FILTER.consultor);
  if(FILTER.estado) out=out.filter(l=>l.estado===FILTER.estado);
  if(FILTER.ini) out=out.filter(l=>!l.data || l.data>=FILTER.ini);
  if(FILTER.fim) out=out.filter(l=>!l.data || l.data<=FILTER.fim);
  return out;
}
function toCSV(rows){ return rows.map(r=>r.map(v=>`"${String(v??'').replaceAll('"','""')}"`).join(',')).join('\n'); }

$('exportCsv').addEventListener('click',()=>{
  const headers=["ID","Estado","Data","Consultor","Nome","Contacto","Email","TipoNegócio","Imóvel","Tipologia","Zona","Capitais","Valor","Financiamento","Simulação","Banco","Comprador/Vend.","Perfil","Classificação","RefInterna","URL","Urgente","Planta","1ªHab","TemImóvel","JáVenda","Notas","Visível","Fecho_CPCV","Fecho_Escritura","Fecho_ValorCPCV","Fecho_SinalReserva","Fecho_Obs"];
  const rows = filterForExport(LEADS).map(l=>[
    l.id,l.estado,l.data||'',l.consultor||'',l.nome||'',l.contacto||'',l.email||'',
    l.tipo_negocio||'',l.imovel||'',l.tipologia||'',l.zona||'',l.capitais||'',l.valor||'',
    l.financiamento||'',l.simulacao||'',l.banco||'',l.papel||'',l.perfil||'',
    l.classificacao||'',l.ref_interna||'',l.url||'',l.urgente||'',l.planta||'',l.primeira_hab||'',
    l.tem_imovel||'',l.ja_venda||'',l.notas||'', (l.visivel!==false?'Sim':'Não'),
    l.fecho_cpcv_date||'', l.fecho_escritura_date||'', l.fecho_valor_cpcv||'', l.fecho_sinal_reserva||'', l.fecho_obs||''
  ]);
  const csv=toCSV([headers,...rows]);
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='leads.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});

$('exportXlsx').addEventListener('click',()=>{
  const data = filterForExport(LEADS).map(l=>({
    ID:l.id, Estado:l.estado, Data:l.data||'', Consultor:l.consultor||'', Nome:l.nome||'',
    Contacto:l.contacto||'', Email:l.email||'', TipoNegócio:l.tipo_negocio||'',
    Imóvel:l.imovel||'', Tipologia:l.tipologia||'', Zona:l.zona||'',
    Capitais:+(l.capitais||0), Valor:+(l.valor||0), Financiamento:l.financiamento||'',
    Simulação:l.simulacao||'', Banco:l.banco||'', "Comprador/Vend.":l.papel||'',
    Perfil:l.perfil||'', Classificação:l.classificacao||'', "Ref. Interna":l.ref_interna||'',
    URL:l.url||'', Urgente:l.urgente||'', Planta:l.planta||'', "1ª Hab.":l.primeira_hab||'',
    "Tem Imóvel":l.tem_imovel||'', "Já à venda":l.ja_venda||'', Notas:l.notas||'',
    Visível:(l.visivel!==false?'Sim':'Não'),
    Fecho_CPCV:l.fecho_cpcv_date||'',
    Fecho_Escritura:l.fecho_escritura_date||'',
    Fecho_ValorCPCV:+(l.fecho_valor_cpcv||0),
    Fecho_SinalReserva:+(l.fecho_sinal_reserva||0),
    Fecho_Obs:l.fecho_obs||''
  }));
  const ws=XLSX.utils.json_to_sheet(data);
  const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Leads');
  XLSX.writeFile(wb, 'leads.xlsx');
});

/* ===== Boot ===== */
(function init(){
  LEADS = loadLS();
  buildFilters();
  renderBoard();
})();
</script>
</body>
</html>
