<!doctype html>
<html lang="pt-PT">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Garvetur Porto Pro ‚Äî Leads (Kanban)</title>

  <link rel="preconnect" href="https://unpkg.com" crossorigin>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js" defer></script>

  <style>
    :root{
      --gold:#A38B63;
      --bg:#0B0B0B;
      --panel:#141414;
      --panel-soft:#181818;
      --border:rgba(255,255,255,.14);
      --text:#FFFFFF;
      --muted:#A0A0A0;
      --radius-md:14px;
      --shadow-soft:0 18px 35px rgba(0,0,0,.6);
    }
    *{box-sizing:border-box;}
    html,body{
      margin:0;
      height:100%;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      background:radial-gradient(circle at top,#1c1c1c 0,#050505 55%,#000 100%);
      color:var(--text);
    }
    body{
      display:flex;
      flex-direction:column;
    }

    /* >>> pequeno ajuste para o header poder ter 2 linhas sem cortar nada */
    .app-shell{
      display:grid;
      grid-template-rows:auto minmax(0,1fr);
      height:100vh;
    }
    /* <<< */

    /* HEADER / BRAND / NAV TABS */
    header.app-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 18px;
      border-bottom:1px solid rgba(163,139,99,.35);
      background:linear-gradient(90deg,#050505,#111,#050505);
      gap:16px;
      flex-wrap:wrap;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .brand-icon{
      width:26px;
      height:26px;
      border-radius:999px;
      border:1px solid var(--gold);
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:0 0 0 1px rgba(163,139,99,.3);
    }
    .brand h1{
      margin:0;
      font-size:17px;
      letter-spacing:.04em;
      text-transform:uppercase;
      color:var(--gold);
    }
    .brand span.sub{
      display:block;
      font-size:11px;
      color:var(--muted);
      letter-spacing:.12em;
      text-transform:uppercase;
    }

    .nav-tabs{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap:4px;
      background:rgba(0,0,0,.35);
      padding:4px;
      border-radius:999px;
      border:1px solid rgba(163,139,99,.35);
    }
    .nav-tab{
      padding:5px 10px;
      border-radius:999px;
      font-size:11px;
      text-decoration:none;
      color:var(--muted);
      letter-spacing:.12em;
      text-transform:uppercase;
      border:1px solid transparent;
      transition:.16s background,.16s color,.16s border-color,.16s transform;
    }
    .nav-tab:hover{
      color:#fff;
      border-color:rgba(163,139,99,.6);
      transform:translateY(-1px);
    }
    .nav-tab.active{
      background:var(--gold);
      color:#0A0AA0;
      border-color:var(--gold);
      font-weight:600;
    }

    .header-actions{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }

    .btn{
      border-radius:999px;
      border:1px solid rgba(163,139,99,.35);
      background:rgba(12,12,12,.9);
      color:var(--text);
      padding:7px 12px;
      font-size:13px;
      display:inline-flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
      transition:.18s border-color,.18s background,.18s transform;
    }
    .btn:hover{
      border-color:var(--gold);
      transform:translateY(-1px);
    }
    .btn-primary,
    .btn.primary{
      background:var(--gold);
      color:#0A0A0A;
      border-color:var(--gold);
      font-weight:600;
    }
    .btn-ghost,
    .btn.ghost{
      background:transparent;
      border-color:rgba(255,255,255,.24);
      color:var(--muted);
    }
    .btn[disabled]{
      opacity:.45;
      cursor:not-allowed;
      transform:none;
    }
    .move-select[disabled]{opacity:.45;cursor:not-allowed;}

    /* Bot√£o pequeno */
    .btn-xs{
      border-radius:999px;
      border:1px solid rgba(163,139,99,.35);
      background:rgba(12,12,12,.9);
      color:var(--muted);
      padding:3px 8px;
      font-size:11px;
      display:inline-flex;
      align-items:center;
      gap:4px;
      cursor:pointer;
      transition:.16s border-color,.16s background,.16s transform;
    }
    .btn-xs:hover{
      border-color:var(--gold);
      transform:translateY(-1px);
    }
    .btn-xs.primary{
      border-color:var(--gold);
      color:var(--gold);
    }

    /* LAYOUT PRINCIPAL */
    .layout{
      display:grid;
      grid-template-columns:320px minmax(0,1fr);
      height:100%;
      max-height:100%;
      overflow:hidden;
    }
    @media (max-width:960px){
      .layout{
        grid-template-columns:1fr;
        grid-template-rows:auto auto;
        height:auto;
        max-height:none;
      }
    }

    .sidebar{
      background:radial-gradient(circle at top left,#141414,#060606);
      border-right:1px solid var(--border);
      padding:12px 14px;
      overflow-y:auto;
    }
    .sidebar-section{
      border-radius:var(--radius-md);
      padding:10px 11px;
      background:rgba(0,0,0,.45);
      border:1px solid rgba(163,139,99,.18);
      margin-bottom:10px;
    }
    .sidebar-section h3{
      margin:0 0 8px 0;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.16em;
      color:var(--muted);
    }

    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
      margin-bottom:10px;
    }
    .field input,
    .field select{
      background:rgba(0,0,0,.7);
      border:1px solid rgba(255,255,255,.16);
      border-radius:10px;
      color:#fff;
      padding:6px 9px;
      outline:none;
      font-size:12px;
    }
    .field input:focus,
    .field select:focus{
      border-color:var(--gold);
      box-shadow:0 0 0 1px rgba(163,139,99,.35);
    }

    .checks{
      display:flex;
      flex-direction:column;
      gap:8px;
      font-size:12px;
      color:#dcdcdc;
    }
    .checks label{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .checks input{accent-color:var(--gold);}

    .cards-area{
      padding:14px 16px 18px;
      overflow-y:auto;
      background:radial-gradient(circle at top,#1a1a1a,#050505 55%,#000 100%);
      display:flex;
      flex-direction:column;
    }

    .cards-header{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      margin-bottom:6px;
      gap:10px;
    }
    .cards-header-left h2{
      margin:0;
      font-size:15px;
      letter-spacing:.16em;
      text-transform:uppercase;
      color:var(--muted);
    }
    .cards-header-left p{
      margin:2px 0 0;
      font-size:12px;
      color:var(--muted);
    }

    /* SUM√ÅRIO PIPELINE */
    .summary-bar{
      padding:6px 10px;
      font-size:12px;
      border-radius:999px;
      border:1px solid rgba(163,139,99,.35);
      background:rgba(0,0,0,.55);
      color:#ddd;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      margin-bottom:10px;
    }
    .badge-kpi{
      padding:2px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      font-size:11px;
      color:var(--muted);
      background:rgba(15,15,15,.9);
    }
    .badge-kpi.highlight{
      border-color:var(--gold);
      color:var(--gold);
      font-weight:600;
    }

    /* BOARD / COLUNAS / CARDS */
    .board{
      display:grid;
      grid-template-columns:repeat(7,minmax(260px,1fr));
      gap:10px;
    }
    @media (max-width:1400px){
      .board{grid-template-columns:repeat(3,minmax(260px,1fr));}
    }
    @media (max-width:960px){
      .board{grid-template-columns:1fr;}
    }

    .col{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:12px;
      display:flex;
      flex-direction:column;
      min-width:240px;
    }
    .col header{
      padding:8px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex;
      align-items:center;
      justify-content:space-between;
      font-size:12px;
    }
    .col header .title{
      font-weight:700;
      color:#f3f3f3;
    }
    .counter{
      font-size:11px;
      color:#cfcfcf;
    }
    .col .list{
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .card{
      background:#0E0E0E;
      border:1px solid rgba(163,139,99,.65);
      border-radius:14px;
      padding:10px;
      box-shadow:0 14px 24px rgba(0,0,0,.65);
    }
    .card .top{
      display:flex;
      justify-content:space-between;
      gap:8px;
    }
    .card .name{
      font-weight:800;
      font-size:13px;
      color:#fff;
    }
    .card .meta{
      font-size:11px;
      color:#bbb;
    }
    .card .row{
      margin-top:6px;
      font-size:12px;
      color:#ddd;
    }
    .card .actions{
      margin-top:8px;
      display:flex;
      gap:6px;
      flex-wrap:wrap;
    }
    .badge{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      font-size:11px;
    }
    .badge.light{
      border-color:#444;
      color:#ccc;
    }
    .move-select{
      background:#0E0E0E;
      border:1px solid rgba(255,255,255,.25);
      color:#ddd;
      border-radius:999px;
      padding:4px 8px;
      font-size:11px;
    }

    /* MODAL */
    .modal-backdrop{
      display:none;
      position:fixed;
      inset:0;
      z-index:10000;
      background:rgba(0,0,0,.6);
      backdrop-filter:blur(2px);
      align-items:center;
      justify-content:center;
      padding:16px;
    }
    .modal-backdrop.show{display:flex;}
    .modal{
      width:min(980px,96vw);
      background:#0F0F0F;
      border:1px solid var(--border);
      border-radius:18px;
      overflow:hidden;
      box-shadow:0 24px 45px rgba(0,0,0,.8);
    }
    .modal header{
      padding:10px 12px;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      background:linear-gradient(90deg,#050505,#111,#050505);
      font-size:13px;
    }
    .modal .content{
      padding:12px;
      max-height:72vh;
      overflow:auto;
    }

    .grid2{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    .grid3{
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:10px;
    }
    @media (max-width:900px){
      .grid2,.grid3{grid-template-columns:1fr;}
    }

    .form-field{
      display:flex;
      flex-direction:column;
      gap:6px;
      font-size:12px;
    }
    .form-field input,
    .form-field select,
    .form-field textarea{
      background:#0E0E0E;
      border:1px solid rgba(255,255,255,.16);
      border-radius:8px;
      color:#fff;
      padding:8px 10px;
      outline:none;
      font-size:12px;
    }
    .form-field input:focus,
    .form-field select:focus,
    .form-field textarea:focus{
      border-color:var(--gold);
      box-shadow:0 0 0 1px rgba(163,139,99,.28);
    }
    .form-field small{color:#9AA0A6;}

    .help{
      font-size:12px;
      color:#bdbdbd;
      margin-top:4px;
    }

    /* ESTADO PICKER */
    .state-pills{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .state-pill{
      display:flex;
      align-items:center;
      gap:6px;
      border:1px solid rgba(255,255,255,.18);
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      background:#0E0EE;
      cursor:pointer;
    }
    .state-pill input{
      accent-color:#A38B63;
      width:14px;
      height:14px;
    }
    .state-pill.active{
      background:#1c1c1c;
      border-color:#A38B63;
    }

    /* INTERCALARES */
    .intercalares{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .intercalares .row{
      display:flex;
      gap:8px;
      align-items:center;
    }
    .intercalares .row input{flex:1;}
    .intercalares .row button{white-space:nowrap;}
    .total-line{
      margin-top:6px;
      font-size:12px;
      color:#dcdcdc;
    }

    /* BLOCO PROPOSTA & CONTRA-PROPOSTAS */
    .section-block{
      margin-top:10px;
      padding:10px 10px 12px;
      border-radius:12px;
      border:1px solid rgba(163,139,99,.35);
      background:rgba(10,10,10,.9);
    }
    .section-title-small{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.16em;
      color:var(--muted);
      margin-bottom:6px;
    }
    .field-grid-2{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:8px;
    }
    @media (max-width:900px){
      .field-grid-2{grid-template-columns:1fr;}
    }
    .contraprop-item{
      border-radius:10px;
      border:1px solid rgba(255,255,255,.14);
      padding:8px;
      margin-top:6px;
      background:#111;
    }

    /* inputs file escondidos */
    #importCsvInput,
    #restoreLeadsInput{
      display:none;
    }
  </style>
</head>
<body>
<div class="app-shell">
  <header class="app-header">
    <div class="brand">
      <div class="brand-icon">
        <svg width="16" height="16" viewBox="0 0 24 24" stroke="var(--gold)" fill="none" stroke-width="1.8">
          <circle cx="12" cy="12" r="9"></circle>
          <path d="M8 12.5l2.5 2.5L16 9"></path>
        </svg>
      </div>
      <div>
        <h1>Garvetur Porto Pro ‚Äî Leads</h1>
        <span class="sub">Pipeline comercial e oportunidades</span>
      </div>
    </div>

    <nav class="nav-tabs">
      <a href="index.html" class="nav-tab">In√≠cio</a>
      <a href="mapa.html" class="nav-tab">Mapa</a>
      <a href="kanban.html" class="nav-tab active">Leads</a>
      <a href="angariacoes.html" class="nav-tab">Angaria√ß√µes</a>
      <a href="dashboard.html" class="nav-tab">Dashboard</a>
      <a href="vendas.html" class="nav-tab">Vendas</a>
      <a href="tarefas.html" class="nav-tab">Tarefas</a>
    </nav>

    <div class="header-actions">
      <button class="btn primary" id="btnNew" disabled>+ Nova Lead</button>
      <button class="btn btn-ghost" id="toggleEdit"><span id="lockEmoji">üîí</span> Edi√ß√£o bloqueada</button>
      <button class="btn btn-ghost" id="exportCsv">‚§ì CSV</button>
      <button class="btn btn-ghost" id="exportXlsx">‚§ì Excel</button>
      <button class="btn btn-ghost" id="importCsvBtn">‚§í Importar CSV</button>
      <!-- NOVOS BOT√ïES, MESMO ESTILO -->
      <button class="btn btn-ghost" id="backupLeads">‚≠≥ Backup</button>
      <button class="btn btn-ghost" id="restoreLeads">‚≠± Restore</button>
      <input type="file" id="importCsvInput" accept=".csv" />
      <input type="file" id="restoreLeadsInput" accept=".json" />
    </div>
  </header>

  <div class="layout">
    <!-- LADO ESQUERDO: FILTROS -->
    <aside class="sidebar">
      <div class="sidebar-section">
        <h3>Pesquisa</h3>
        <div class="field">
          <input id="q" placeholder="Pesquisar: nome, contacto, consultor, email, ref., zona, notas">
        </div>
      </div>

      <div class="sidebar-section">
        <h3>Filtros</h3>
        <div class="field">
          <label>Consultor</label>
          <select id="f_consultor"><option value="">(Todos)</option></select>
        </div>
        <div class="field">
          <label>Estado</label>
          <select id="f_estado">
            <option value="">(Todos)</option>
            <option>Novo</option>
            <option>Em Contacto</option>
            <option>Qualificado</option>
            <option>Visita</option>
            <option>Proposta</option>
            <option>Fecho</option>
            <option>Perdido</option>
          </select>
        </div>
        <div class="field">
          <label>Per√≠odo</label>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
            <input id="f_ini" type="date">
            <input id="f_fim" type="date">
          </div>
        </div>
        <div class="checks">
          <label><input type="checkbox" id="f_show_hidden"> Mostrar invis√≠veis</label>
          <label><input type="checkbox" id="f_only_hidden"> S√≥ invis√≠veis</label>
        </div>
        <div style="display:flex;gap:8px;margin-top:10px">
          <button class="btn" id="applyFilters">Aplicar</button>
          <button class="btn btn-ghost" id="clearFilters">Limpar</button>
        </div>
      </div>
    </aside>

    <!-- DIREITA: SUM√ÅRIO + BOARD -->
    <main class="cards-area">
      <div class="cards-header">
        <div class="cards-header-left">
          <h2>Leads</h2>
          <p>Gest√£o visual do pipeline comercial ‚Äî do primeiro contacto ao fecho.</p>
        </div>
      </div>

      <!-- Sum√°rio pipeline -->
      <div id="pipelineSummary" class="summary-bar"></div>

      <!-- Quadro Kanban -->
      <section class="board" id="board"></section>
    </main>
  </div>
</div>

<!-- Modal Nova/Editar Lead -->
<div id="leadModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-label="Lead">
  <div class="modal">
    <header>
      <div><strong id="modalTitle">Nova Lead</strong></div>
      <div style="display:flex;gap:8px">
        <button class="btn btn-ghost" id="cancelLead">Cancelar</button>
        <button class="btn primary" id="saveLead">Guardar</button>
      </div>
    </header>
    <div class="content">
      <!-- (resto do modal mant√©m-se EXACTAMENTE como no seu ficheiro) -->
      <!-- ...  (para poupar espa√ßo, omiti o conte√∫do do modal porque √© igual ao que j√° tem) -->
    </div>
  </div>
</div>

<script>
/* ===== Estado ===== */
const LS_KEY='gpp_leads_v5';
const EDIT_LS='gpp_leads_edit_mode';
const COLS=["Novo","Em Contacto","Qualificado","Visita","Proposta","Fecho","Perdido"];
const CONSULT_RESOLVE=["Rui Quelhas","Manuel Oliveira","Jo√£o Sousa","Francisco dos Santos","Ros√°rio Vasconcelos","Armanda Meireles","Audrey Lucas"];

// storage de tarefas (partilhado com tarefas.html)
const TASKS_STORAGE_KEY = 'gpp_tarefas_v1';

// Mapa de classifica√ß√£o 1‚Äì5 para texto amig√°vel
const LEAD_CLASSIFICACAO_MAP = {
  1: "Lead sem interesse",
  2: "Partilha",
  3: "Sem resposta a contacto",
  4: "Informa√ß√£o s/ im√≥vel",
  5: "Quer marcar visita"
};

let LEADS=[];
let FILTER={ consultor:'', estado:'', ini:'', fim:'', q:'', showHidden:false, onlyHidden:false };
let PICKED_STATE='';
let INTERCALAres=[];
let PROPOSTA_CONTRAS=[];
let EDIT_MODE=false;

const $=id=>document.getElementById(id);
const norm=s=>String(s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');

function todayISO(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0');
  return y + '-' + m + '-' + day;
}

/* ===== Persist√™ncia ===== */
function loadLS(){ try{ const x=localStorage.getItem(LS_KEY); return x? JSON.parse(x):[];}catch{return[];} }
function saveLS(){ localStorage.setItem(LS_KEY, JSON.stringify(LEADS)); }
function loadPersistedFilters(){
  try{ const raw=localStorage.getItem(LS_KEY+'_filters'); if(!raw) return;
    const f=JSON.parse(raw); FILTER=Object.assign(FILTER,f);
    $('f_consultor').value=FILTER.consultor||'';
    $('f_estado').value=FILTER.estado||'';
    $('f_ini').value=FILTER.ini||'';
    $('f_fim').value=FILTER.fim||'';
    $('q').value=FILTER.q||'';
    $('f_show_hidden').checked=!!FILTER.showHidden;
    $('f_only_hidden').checked=!!FILTER.onlyHidden;
  }catch{}
}
function persistFilters(){ localStorage.setItem(LS_KEY+'_filters', JSON.stringify(FILTER)); }

/* ===== Edit Mode ===== */
function updateEditUI(){
  const btnToggle=$('toggleEdit');
  const btnNew=$('btnNew');
  if(!btnToggle || !btnNew) return;
  if(EDIT_MODE){
    btnToggle.classList.add('primary');
    btnToggle.innerHTML='üîì Edi√ß√£o ativa';
    btnNew.disabled=false;
    btnNew.classList.add('primary');
    btnNew.classList.remove('ghost');
  }else{
    btnToggle.classList.remove('primary');
    btnToggle.innerHTML='üîí Edi√ß√£o bloqueada';
    btnNew.disabled=true;
    btnNew.classList.remove('primary');
    btnNew.classList.add('ghost');
  }
}
function setEditMode(on){
  EDIT_MODE=!!on;
  localStorage.setItem(EDIT_LS, EDIT_MODE?'1':'0');
  updateEditUI();
  renderBoard();
}

/* ===== Helpers ===== */
function badge(txt){ return `<span class="badge light">${txt||'‚Äî'}</span>`; }
function fmtDate(d){ if(!d) return '‚Äî'; try{ const z=new Date(d); return z.toLocaleDateString('pt-PT'); }catch{return d;} }
function isEmail(e){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(e||'')); }
function isTel(t){ const s=String(t||'').replace(/\s+/g,''); return /^\+?\d{9,15}$/.test(s); }
function isHttp(u){ return /^https?:\/\//i.test(String(u||'')); }
function uid(){ return 'L'+Math.random().toString(36).slice(2,9)+Date.now().toString(36).slice(-4); }
function parsePercent(v){ if(!v) return ''; const s=String(v).replace('%','').replace(',','.'); const n=Number(s); return Number.isFinite(n)? n: ''; }
function sumIntercalares(arr){ return (arr||[]).reduce((a,b)=>a+(Number(b)||0),0); }

/* ===== BACKUP / RESTORE ===== */
function downloadBackup(){
  const payload={
    version:1,
    exportedAt:new Date().toISOString(),
    leads:LEADS,
    filters:FILTER,
    editMode:EDIT_MODE
  };
  const json=JSON.stringify(payload,null,2);
  const blob=new Blob([json],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  const stamp=todayISO().replace(/-/g,'');
  a.href=url;
  a.download='leads-backup-'+stamp+'.json';
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function restoreFromFile(file){
  const reader=new FileReader();
  reader.onload=e=>{
    try{
      const data=JSON.parse(e.target.result);
      if(!data || !Array.isArray(data.leads)){
        alert('Ficheiro de backup inv√°lido.');
        return;
      }
      if(!confirm('Confirmar RESTORE das leads a partir deste backup?\nIsto pode substituir dados atuais.')) return;

      LEADS=data.leads;
      saveLS();

      if(data.filters){
        FILTER=Object.assign(FILTER,data.filters);
        persistFilters();
      }
      if(typeof data.editMode==='boolean'){
        EDIT_MODE=data.editMode;
        localStorage.setItem(EDIT_LS,EDIT_MODE?'1':'0');
      }
      updateEditUI();
      renderBoard();
      alert('Backup restaurado com sucesso.');
    }catch(err){
      console.error('Erro a restaurar backup',err);
      alert('N√£o foi poss√≠vel restaurar o backup. Verifique o ficheiro.');
    }finally{
      $('restoreLeadsInput').value='';
    }
  };
  reader.readAsText(file,'utf-8');
}

/* ===== Tarefas: integra√ß√£o ===== */
function loadTasksState(){
  try{
    const raw = localStorage.getItem(TASKS_STORAGE_KEY);
    if(!raw) return {locked:true,tasks:[]};
    const parsed = JSON.parse(raw);
    if(!Array.isArray(parsed.tasks)) parsed.tasks = [];
    if(typeof parsed.locked!=='boolean') parsed.locked = true;
    return parsed;
  }catch(e){
    console.error('Erro ao carregar tarefas a partir do Kanban', e);
    return {locked:true,tasks:[]};
  }
}
function saveTasksState(state){
  try{
    localStorage.setItem(TASKS_STORAGE_KEY, JSON.stringify(state));
  }catch(e){
    console.error('Erro ao guardar tarefas a partir do Kanban', e);
  }
}

function createTaskFromLead(lead){
  const tasksState = loadTasksState();

  const origemRefParts = [];
  if(lead.ref_interna) origemRefParts.push(lead.ref_interna);
  if(lead.nome) origemRefParts.push(lead.nome);
  const origemRef = origemRefParts.join(' ‚Äî ');

  const titulo = 'Follow-up lead: ' + (lead.nome || 'sem nome');

  const agora = new Date();
  const dataCriacaoISO = todayISO();
  const limite = new Date(agora);
  limite.setDate(limite.getDate() + 8);
  const dataLimiteISO = limite.toISOString().slice(0,10);

  const tarefa = {
    id: 'task_' + Date.now(),
    responsavel: lead.consultor || '',
    apoio: '',
    origemTipo: 'lead',
    origemRef: origemRef || (lead.nome || ''),
    estado: 'por_fazer',
    prioridade: 'normal',
    tipoTarefa: 'followup',
    tags: 'lead, pipeline',
    titulo: titulo,
    descricao: 'Tarefa criada a partir da lead "' + (lead.nome || '') +
      '" no Kanban em ' + new Date().toLocaleString('pt-PT') + '.',
    dataCriacao: dataCriacaoISO,
    dataLimite: dataLimiteISO,
    horaLimite: '',
    createdAtMs: Date.now()
  };

  tasksState.tasks.push(tarefa);
  saveTasksState(tasksState);

  const abrir = confirm('Tarefa criada para esta lead.\n\nQuer abrir a p√°gina de Tarefas agora?');
  if(abrir){
    window.open('tarefas.html','_blank');
  }
}

/* ===== Deep link vindo de Tarefas ===== */
function applyDeepLinkFromTarefas(){
  try{
    const params = new URLSearchParams(window.location.search);
    const refParam = (params.get('ref') || '').trim();
    if(!refParam) return;

    const refNorm = norm(refParam);
    if(!refNorm) return;

    let bestLead = null;
    let bestScore = 0;

    LEADS.forEach(l=>{
      const refIntNorm = norm(l.ref_interna || '');
      const nomeNorm = norm(l.nome || '');
      let score = 0;

      if(refIntNorm && (refNorm.includes(refIntNorm) || refIntNorm.includes(refNorm))){
        score += 4;
      }
      if(nomeNorm && (refNorm.includes(nomeNorm) || nomeNorm.includes(refNorm))){
        score += 2;
      }
      if(refIntNorm && nomeNorm){
        const combo = (refIntNorm + ' ‚Äî ' + nomeNorm);
        if(combo === refNorm){
          score += 3;
        }
      }

      if(score > bestScore){
        bestScore = score;
        bestLead = l;
      }
    });

    if(!bestLead){
      console.warn('Nenhuma lead encontrada para ref:', refParam);
      alert('N√£o foi poss√≠vel encontrar a lead associada √† refer√™ncia:\n' + refParam);
      return;
    }

    if(!EDIT_MODE){
      setEditMode(true);
    }

    $('saveLead').dataset.editId = bestLead.id;
    $('saveLead').dataset.editEstado = bestLead.estado;
    openModal(bestLead);

  }catch(e){
    console.error('Erro ao aplicar deep link de tarefas para Kanban', e);
  }
}

/* ===== Lateral ===== */
function buildFilters(){
  const sel=$('f_consultor');
  sel.innerHTML='<option value="">(Todos)</option>'+CONSULT_RESOLVE.map(c=>`<option>${c}</option>`).join('');
}
$('applyFilters').addEventListener('click',()=>{
  FILTER.consultor=$('f_consultor').value; FILTER.estado=$('f_estado').value;
  FILTER.ini=$('f_ini').value; FILTER.fim=$('f_fim').value;
  FILTER.q=$('q').value.trim();
  FILTER.showHidden=$('f_show_hidden').checked;
  FILTER.onlyHidden=$('f_only_hidden').checked;
  persistFilters(); renderBoard();
});
$('clearFilters').addEventListener('click',()=>{
  FILTER={consultor:'',estado:'',ini:'',fim:'',q:'',showHidden:false,onlyHidden:false};
  ['f_consultor','f_estado','f_ini','f_fim','q','f_show_hidden','f_only_hidden'].forEach(id=>{
    const el=$(id);
    if(!el) return;
    if(el.type==='checkbox'){ el.checked=false; } else { el.value=''; }
  });
  persistFilters(); renderBoard();
});

// Pesquisa com debounce
let qTimer=null;
$('q').addEventListener('input',()=>{
  clearTimeout(qTimer);
  qTimer=setTimeout(()=>{ FILTER.q=$('q').value.trim(); persistFilters(); renderBoard(); }, 200);
});

/* ===== Modal ===== */
function resetFechoBox(){
  $('ld_fecho_negocio').value='';
  $('ld_fecho_comissao').value='';
  $('ld_fecho_comissao_outro').value=''; $('ld_fecho_comissao_outro').style.display='none';
  $('ld_fecho_sinal_reserva').value='';
  $('ld_fecho_valor_cpcv').value='';
  $('ld_fecho_valor_escritura').value='';
  $('ld_fecho_cpcv_date').value='';
  $('ld_fecho_escritura_date').value='';
  $('ld_fecho_obs').value='';
  $('ld_fecho_pagamento_tipo').value='';
  $('ld_fecho_pagamento_outro').value='';
  $('ld_fecho_pagamento_outro').style.display='none';
  INTERCALAres=[]; drawIntercalares();
  updateIntercalaresTotal();
}
function setFechoBox(show){ $('fechoBox').style.display = show? 'grid':'none'; }

/* PROPOSTA & CONTRA-PROPOSTAS */
function resetPropostaBox(){
  $('ld_prop_nome').value='';
  $('ld_prop_contacto').value='';
  $('ld_prop_email').value='';
  $('ld_prop_valor').value='';
  $('ld_prop_data').value='';
  $('ld_prop_termos').value='';
  $('ld_prop_aceite').value='';
  PROPOSTA_CONTRAS = [];
  drawContraPropostas();
}
function setPropostaBox(show){
  $('propostaBox').style.display = show ? 'block' : 'none';
}
function drawContraPropostas(){
  const container = $('prop_contra_list');
  container.innerHTML = '';
  (PROPOSTA_CONTRAS || []).forEach((item, idx)=>{
    const div = document.createElement('div');
    div.className = 'contraprop-item';
    div.innerHTML = `
      <div class="field-grid-2">
        <div class="form-field">
          <label>Data da contra-proposta</label>
          <input type="date" class="inp-contraprop-data" data-idx="${idx}" value="${item.data||''}">
        </div>
        <div class="form-field">
          <label>Valor</label>
          <input type="text" class="inp-contraprop-valor" data-idx="${idx}" value="${item.valor||''}">
        </div>
      </div>
      <div class="form-field">
        <label>Termos</label>
        <textarea class="inp-contraprop-termos" rows="2" data-idx="${idx}">${item.termos||''}</textarea>
      </div>
      <button type="button" class="btn-xs" data-del="${idx}">Remover</button>
    `;
    div.querySelector('.inp-contraprop-data').addEventListener('input',e=>{
      PROPOSTA_CONTRAS[idx].data = e.target.value;
    });
    div.querySelector('.inp-contraprop-valor').addEventListener('input',e=>{
      PROPOSTA_CONTRAS[idx].valor = e.target.value;
    });
    div.querySelector('.inp-contraprop-termos').addEventListener('input',e=>{
      PROPOSTA_CONTRAS[idx].termos = e.target.value;
    });
    div.querySelector('[data-del]').addEventListener('click',()=>{
      PROPOSTA_CONTRAS.splice(idx,1);
      drawContraPropostas();
    });
    container.appendChild(div);
  });
}
$('btnAddContraProp').addEventListener('click', ()=>{
  PROPOSTA_CONTRAS.push({data:'',valor:'',termos:''});
  drawContraPropostas();
});

function drawIntercalares(){
  const box=$('intercalaresBox'); box.innerHTML='';
  INTERCALAres.forEach((val,idx)=>{
    const row=document.createElement('div'); row.className='row';
    row.innerHTML=`<input type="number" min="0" step="500" value="${val||''}" data-idx="${idx}"><button class="btn btn-ghost" data-del="${idx}">Remover</button>`;
    row.querySelector('input').addEventListener('input',e=>{
      const i=Number(e.target.dataset.idx); INTERCALAres[i]=e.target.value; updateIntercalaresTotal();
    });
    row.querySelector('button').addEventListener('click',()=>{ INTERCALAres.splice(idx,1); drawIntercalares(); updateIntercalaresTotal(); });
    box.appendChild(row);
  });
}
function updateIntercalaresTotal(){
  $('intercalaresTotal').textContent = 'Total intercalares: ' + sumIntercalares(INTERCALAres).toLocaleString('pt-PT') + ' ‚Ç¨';
}
$('addIntercalar').addEventListener('click',()=>{ INTERCALAres.push(''); drawIntercalares(); updateIntercalaresTotal(); });

$('ld_fecho_comissao').addEventListener('change', (e)=>{
  const isOutro = e.target.value==='outro';
  const input=$('ld_fecho_comissao_outro');
  input.style.display = isOutro? 'block':'none';
  if(!isOutro) input.value='';
});

// Pagamento de Comiss√µes
$('ld_fecho_pagamento_tipo').addEventListener('change', (e)=>{
  const isOutro = e.target.value==='outro';
  const input = $('ld_fecho_pagamento_outro');
  input.style.display = isOutro ? 'block' : 'none';
  if(!isOutro) input.value='';
});

function initStatePicker(){
  PICKED_STATE='';
  document.querySelectorAll('.cb_estado').forEach(cb=>{
    cb.checked=false;
    cb.closest('.state-pill')?.classList.remove('active');
    cb.addEventListener('change', e=>{
      document.querySelectorAll('.cb_estado').forEach(x=>{
        if(x!==cb){ x.checked=false; x.closest('.state-pill')?.classList.remove('active'); }
      });
      if(cb.checked){
        PICKED_STATE=cb.value;
        cb.closest('.state-pill')?.classList.add('active');
      }else{ PICKED_STATE=''; }
      setFechoBox(PICKED_STATE==='Fecho');
      setPropostaBox(PICKED_STATE==='Proposta' || PICKED_STATE==='Fecho');
    });
  });
}

function openModal(edit=null){
  if(!EDIT_MODE){
    alert('Modo de edi√ß√£o bloqueado. Clique em "üîì Edi√ß√£o ativa" para poder criar/editar leads.');
    return;
  }
  $('modalTitle').textContent = edit? 'Editar Lead' : 'Nova Lead';
  const f = (id,val='') => $(id).value = (val??'');
  const v = edit||{};
  f('ld_nome', v.nome);
  f('ld_consultor', v.consultor||'');
  f('ld_contacto', v.contacto);
  f('ld_email', v.email);
  f('ld_tipo_negocio', v.tipo_negocio);
  f('ld_imovel', v.imovel);
  f('ld_tipologia', v.tipologia);
  f('ld_zona', v.zona);
  f('ld_capitais', v.capitais);
  f('ld_valor', v.valor);
  f('ld_financiamento', v.financiamento||'N√£o');
  f('ld_simulacao', v.simulacao||'N√£o');
  f('ld_banco', v.banco);
  f('ld_tem_imovel', v.tem_imovel||'N√£o');
  f('ld_ja_venda', v.ja_venda||'N√£o');
  f('ld_urgente', v.urgente||'N√£o');
  f('ld_planta', v.planta||'N√£o');
  f('ld_primeira_hab', v.primeira_hab||'N√£o');
  f('ld_papel', v.papel||'');
  f('ld_perfil', v.perfil||'');
  f('ld_classificacao', v.classificacao||'');
  f('ld_ref', v.ref_interna||'');
  f('ld_url', v.url||'');
  f('ld_data', v.data||new Date().toISOString().slice(0,10));
  f('ld_notas', v.notas||'');

  initStatePicker();
  setFechoBox(false);
  setPropostaBox(false);

  if(edit && COLS.includes(edit.estado) && edit.estado!=='Novo'){
    const sel = Array.from(document.querySelectorAll('.cb_estado')).find(x=>x.value===edit.estado);
    if(sel){
      sel.checked=true;
      sel.dispatchEvent(new Event('change'));
    }
  }

  resetFechoBox();
  resetPropostaBox();

  if(edit && edit.estado==='Fecho'){
    $('ld_fecho_negocio').value = edit.fecho_negocio || '';
    if(edit.fecho_comissao_pct!=='' && edit.fecho_comissao_pct!=null){
      const known=['6','5','4','3'];
      const s=String(edit.fecho_comissao_pct);
      if(known.includes(s)){ $('ld_fecho_comissao').value=s; }
      else{ $('ld_fecho_comissao').value='outro'; $('ld_fecho_comissao_outro').style.display='block'; $('ld_fecho_comissao_outro').value=s+'%'; }
    }
    $('ld_fecho_sinal_reserva').value = edit.fecho_sinal_reserva || '';
    $('ld_fecho_valor_cpcv').value = edit.fecho_valor_cpcv || '';
    INTERCALAres = Array.isArray(edit.fecho_intercalares)? [...edit.fecho_intercalares] : [];
    drawIntercalares(); updateIntercalaresTotal();
    $('ld_fecho_valor_escritura').value = edit.fecho_valor_escritura || '';
    $('ld_fecho_cpcv_date').value = edit.fecho_cpcv_date || '';
    $('ld_fecho_escritura_date').value = edit.fecho_escritura_date || '';
    $('ld_fecho_obs').value = edit.fecho_obs || '';

    $('ld_fecho_pagamento_tipo').value = edit.fecho_pagamento_tipo || '';
    if(edit.fecho_pagamento_tipo === 'outro'){
      $('ld_fecho_pagamento_outro').style.display = 'block';
      $('ld_fecho_pagamento_outro').value = edit.fecho_pagamento_outro || '';
    }else{
      $('ld_fecho_pagamento_outro').style.display = 'none';
      $('ld_fecho_pagamento_outro').value = edit.fecho_pagamento_outro || '';
    }
  }

  if(edit && edit.proposta){
    const p = edit.proposta;
    $('ld_prop_nome').value = p.nomeProponente || '';
    $('ld_prop_contacto').value = p.contactoProponente || '';
    $('ld_prop_email').value = p.emailProponente || '';
    $('ld_prop_valor').value = p.valorProposta || '';
    $('ld_prop_data').value = p.dataProposta || '';
    $('ld_prop_termos').value = p.termosProposta || '';
    $('ld_prop_aceite').value = p.dataPropostaAceite || '';
    PROPOSTA_CONTRAS = Array.isArray(p.contraPropostas) ? p.contraPropostas.map(c=>({
      data:c.data||'',
      valor:c.valor||'',
      termos:c.termos||''
    })) : [];
    drawContraPropostas();
    setPropostaBox(true);
  }

  $('leadModal').classList.add('show');
}
$('cancelLead').addEventListener('click',()=> $('leadModal').classList.remove('show'));
$('btnNew').addEventListener('click',()=> openModal());

$('saveLead').addEventListener('click',()=>{
  if(!EDIT_MODE){
    alert('Modo de edi√ß√£o bloqueado. Clique em "üîì Edi√ß√£o ativa" para guardar altera√ß√µes.');
    return;
  }
  const get=id=>$(id).value.trim();
  const estadoFinal = PICKED_STATE || $('saveLead').dataset.editEstado || 'Novo';

  let comissaoPct = '';
  let pagamentoTipo = '';
  let pagamentoOutro = '';

  if(estadoFinal==='Fecho'){
    const cSel = $('ld_fecho_comissao').value;
    if(cSel==='outro'){ comissaoPct = parsePercent($('ld_fecho_comissao_outro').value); }
    else if(cSel){ comissaoPct = Number(cSel); }

    pagamentoTipo = $('ld_fecho_pagamento_tipo').value.trim();
    pagamentoOutro = pagamentoTipo === 'outro' ? $('ld_fecho_pagamento_outro').value.trim() : '';
  }

  const propostaObj = {
    nomeProponente: get('ld_prop_nome'),
    contactoProponente: get('ld_prop_contacto'),
    emailProponente: get('ld_prop_email'),
    valorProposta: get('ld_prop_valor'),
    termosProposta: get('ld_prop_termos'),
    dataProposta: get('ld_prop_data'),
    contraPropostas: (PROPOSTA_CONTRAS || []).filter(cp=>cp && (cp.data || cp.valor || cp.termos)),
    dataPropostaAceite: get('ld_prop_aceite')
  };
  const hasPropostaData =
    propostaObj.nomeProponente ||
    propostaObj.contactoProponente ||
    propostaObj.emailProponente ||
    propostaObj.valorProposta ||
    propostaObj.termosProposta ||
    propostaObj.dataProposta ||
    propostaObj.dataPropostaAceite ||
    (propostaObj.contraPropostas && propostaObj.contraPropostas.length>0);

  const lead={
    id: $('saveLead').dataset.editId || uid(),
    estado: estadoFinal,
    nome: get('ld_nome'),
    consultor: get('ld_consultor'),
    contacto: get('ld_contacto'),
    email: get('ld_email'),
    tipo_negocio: get('ld_tipo_negocio'),
    imovel: get('ld_imovel'),
    tipologia: get('ld_tipologia'),
    zona: get('ld_zona'),
    capitais: get('ld_capitais'),
    valor: get('ld_valor'),
    financiamento: get('ld_financiamento'),
    simulacao: get('ld_simulacao'),
    banco: get('ld_banco'),
    tem_imovel: get('ld_tem_imovel'),
    ja_venda: get('ld_ja_venda'),
    urgente: get('ld_urgente'),
    planta: get('ld_planta'),
    primeira_hab: get('ld_primeira_hab'),
    papel: get('ld_papel'),
    perfil: get('ld_perfil'),
    classificacao: get('ld_classificacao'),
    ref_interna: get('ld_ref'),
    url: get('ld_url'),
    data: get('ld_data'),
    notas: get('ld_notas'),
    visivel: (typeof $('saveLead').dataset.editId==='string') ? undefined : true,

    fecho_negocio: estadoFinal==='Fecho' ? get('ld_fecho_negocio') : '',
    fecho_comissao_pct: estadoFinal==='Fecho' ? comissaoPct : '',
    fecho_sinal_reserva: estadoFinal==='Fecho' ? get('ld_fecho_sinal_reserva') : '',
    fecho_valor_cpcv: estadoFinal==='Fecho' ? get('ld_fecho_valor_cpcv') : '',
    fecho_intercalares: estadoFinal==='Fecho' ? [...INTERCALAres] : [],
    fecho_valor_escritura: estadoFinal==='Fecho' ? get('ld_fecho_valor_escritura') : '',
    fecho_cpcv_date: estadoFinal==='Fecho' ? get('ld_fecho_cpcv_date') : '',
    fecho_escritura_date: estadoFinal==='Fecho' ? get('ld_fecho_escritura_date') : '',
    fecho_obs: estadoFinal==='Fecho' ? get('ld_fecho_obs') : '',
    fecho_pagamento_tipo: estadoFinal==='Fecho' ? pagamentoTipo : '',
    fecho_pagamento_outro: estadoFinal==='Fecho' ? pagamentoOutro : ''
  };

  if(hasPropostaData){
    lead.proposta = propostaObj;
  }else{
    if($('saveLead').dataset.editId){
      const existing = LEADS.find(l=>l.id===$('saveLead').dataset.editId);
      if(existing) delete existing.proposta;
    }
  }

  if(lead.visivel===undefined) lead.visivel=true;

  if(!lead.nome){ alert('Indique o Nome do Cliente.'); return; }
  if(!lead.contacto && !lead.email){ alert('Indique pelo menos Contacto ou Email.'); return; }
  if(lead.email && !isEmail(lead.email)){ alert('Email inv√°lido.'); return; }
  if(lead.contacto && !isTel(lead.contacto)){ alert('Contacto inv√°lido.'); return; }
  if(lead.url && !isHttp(lead.url)){ alert('URL anexo inv√°lido (deve come√ßar por http/https).'); return; }

  const idx=LEADS.findIndex(l=>l.id===lead.id);
  if(idx>=0) LEADS[idx]=Object.assign(LEADS[idx], lead);
  else LEADS.push(lead);

  saveLS();
  $('leadModal').classList.remove('show');
  $('saveLead').dataset.editId=''; $('saveLead').dataset.editEstado='';
  renderBoard();
});

/* ===== Render ===== */
function colTemplate(name,count){
  return `<div class="col" data-col="${name}">
    <header><span class="title">${name}</span><span class="counter">${count}</span></header>
    <div class="list" id="col_${name.replace(/\s/g,'_')}"></div>
  </div>`;
}
function fechoSummary(l){
  const parts=[];
  if(l.fecho_negocio) parts.push(`Neg√≥cio: ${Number(l.fecho_negocio).toLocaleString('pt-PT')}‚Ç¨`);
  if(l.fecho_comissao_pct!=='' && l.fecho_comissao_pct!=null) parts.push(`Comiss√£o: ${l.fecho_comissao_pct}%`);
  if(l.fecho_sinal_reserva) parts.push(`Sinal: ${Number(l.fecho_sinal_reserva).toLocaleString('pt-PT')}‚Ç¨`);
  if(l.fecho_valor_cpcv) parts.push(`CPCV: ${Number(l.fecho_valor_cpcv).toLocaleString('pt-PT')}‚Ç¨`);
  if(Array.isArray(l.fecho_intercalares) && l.fecho_intercalares.length){
    const soma = sumIntercalares(l.fecho_intercalares);
    parts.push(`Interc.: ${soma.toLocaleString('pt-PT')}‚Ç¨`);
  }
  if(l.fecho_valor_escritura) parts.push(`Escritura: ${Number(l.fecho_valor_escritura).toLocaleString('pt-PT')}‚Ç¨`);
  if(l.fecho_cpcv_date) parts.push(`CPCV em ${fmtDate(l.fecho_cpcv_date)}`);
  if(l.fecho_escritura_date) parts.push(`Escritura em ${fmtDate(l.fecho_escritura_date)}`);

  if(l.fecho_pagamento_tipo){
    let label;
    switch(l.fecho_pagamento_tipo){
      case '50_50':
        label = '50% CPCV / 50% Escritura';
        break;
      case '100_escritura':
        label = '100% Escritura';
        break;
      case 'outro':
        label = l.fecho_pagamento_outro || 'Outro';
        break;
      default:
        label = l.fecho_pagamento_tipo;
    }
    parts.push(`Pag. comiss√µes: ${label}`);
  }

  return parts.join(' ¬∑ ');
}

function propostaSummary(l){
  const p = l.proposta;
  if(!p) return '';
  const parts = [];
  if(p.valorProposta) parts.push(`Valor: ${p.valorProposta}`);
  if(p.dataProposta) parts.push(`em ${fmtDate(p.dataProposta)}`);
  if(p.dataPropostaAceite) parts.push(`Aceite em ${fmtDate(p.dataPropostaAceite)}`);
  const contraCount = Array.isArray(p.contraPropostas) ? p.contraPropostas.length : 0;
  if(contraCount) parts.push(`${contraCount} contra-propost${contraCount>1?'as':'a'}`);
  return parts.join(' ¬∑ ');
}

function renderSummary(byEstado){
  const el = $('pipelineSummary');
  const total = byEstado.reduce((s,b)=>s+b.items.length,0);
  if(!total){
    el.textContent='Sem leads registadas nos filtros atuais.';
    return;
  }
  const counts = Object.fromEntries(byEstado.map(b=>[b.estado,b.items.length]));
  const fecho = counts['Fecho'] || 0;
  const taxaFecho = total ? (fecho/total*100).toFixed(1) : '0.0';

  el.innerHTML = `
    <span class="badge-kpi">Total: ${total}</span>
    <span class="badge-kpi">Novo: ${counts['Novo']||0}</span>
    <span class="badge-kpi">Em Contacto: ${counts['Em Contacto']||0}</span>
    <span class="badge-kpi">Qualificado: ${counts['Qualificado']||0}</span>
    <span class="badge-kpi">Visita: ${counts['Visita']||0}</span>
    <span class="badge-kpi">Proposta: ${counts['Proposta']||0}</span>
    <span class="badge-kpi">Fecho: ${fecho}</span>
    <span class="badge-kpi">Perdido: ${counts['Perdido']||0}</span>
    <span class="badge-kpi highlight">Taxa de Fecho: ${taxaFecho}%</span>
  `;
}

function renderBoard(){
  const board=$('board'); board.innerHTML='';

  const term = norm(FILTER.q||'');
  const byEstado = COLS.map(col=>{
    let arr=LEADS.filter(l=>l.estado===col);

    if(term){
      arr=arr.filter(l=>{
        const blob = [
          l.nome,
          l.consultor,
          l.contacto,
          l.email,
          l.ref_interna,
          l.zona,
          l.tipo_negocio,
          l.imovel,
          l.tipologia,
          l.notas
        ].map(x=>norm(x)).join(' ');
        return blob.includes(term);
      });
    }
    if(FILTER.consultor) arr=arr.filter(l=>l.consultor===FILTER.consultor);
    if(FILTER.estado) arr=arr.filter(l=>l.estado===FILTER.estado);
    if(FILTER.ini) arr=arr.filter(l=>!l.data || l.data>=FILTER.ini);
    if(FILTER.fim) arr=arr.filter(l=>!l.data || l.data<=FILTER.fim);
    if(!FILTER.showHidden && !FILTER.onlyHidden) arr=arr.filter(l=>l.visivel!==false);
    if(FILTER.onlyHidden) arr=arr.filter(l=>l.visivel===false);

    return {estado:col, items:arr};
  });

  byEstado.forEach(b=>{
    board.insertAdjacentHTML('beforeend', colTemplate(b.estado,b.items.length));
    const list=$('col_'+b.estado.replace(/\s/g,'_'));
    b.items.forEach(lead=>{
      const card=document.createElement('div'); card.className='card';

      const moveOptions = COLS.map(c=>`<option value="${c}" ${c===lead.estado?'disabled':''}>${c}</option>`).join('');
      const disabledAttr = EDIT_MODE ? '' : 'disabled';

      const classNum = Number(lead.classificacao || 0);
      const classDesc = LEAD_CLASSIFICACAO_MAP[classNum];
      const classLine = classNum
        ? `‚≠ê Classifica√ß√£o: ${classNum}${classDesc ? ' - '+classDesc : ''}`
        : '';

      const propLine = lead.proposta ? propostaSummary(lead) : '';

      card.innerHTML=`
        <div class="top">
          <div>
            <div class="name">${lead.nome||'‚Äî'}</div>
            <div class="meta">${lead.consultor||'‚Äî'} ${lead.ref_interna? ' ¬∑ '+badge('Ref: '+lead.ref_interna):''}</div>
          </div>
        </div>
        <div class="row"><b>Contacto:</b> ${lead.contacto||'‚Äî'}</div>
        <div class="row"><b>Email:</b> ${lead.email||'‚Äî'}</div>
        ${classLine ? `<div class="row">${classLine}</div>` : ''}
        <div class="row"><b>Tipo:</b> ${lead.tipo_negocio||'‚Äî'} ¬∑ <b>Im√≥vel:</b> ${lead.imovel||'‚Äî'} ¬∑ <b>Tipologia:</b> ${lead.tipologia||'‚Äî'}</div>
        <div class="row"><b>Zona:</b> ${lead.zona||'‚Äî'} ¬∑ <b>Valor:</b> ${lead.valor? Number(lead.valor).toLocaleString('pt-PT'): '‚Äî'}</div>
        <div class="row"><b>Data:</b> ${fmtDate(lead.data)} ${lead.url? ' ¬∑ <a href="'+lead.url+'" target="_blank" rel="noreferrer">URL</a>':''}</div>
        ${propLine ? `<div class="row"><b>Proposta:</b> ${propLine}</div>` : ''}
        ${lead.estado==='Fecho' ? `<div class="row">${fechoSummary(lead)}</div>` : ''}
        <div class="actions actions-main">
          <button class="btn btn-ghost" data-act="edit" ${disabledAttr}>Editar</button>
          <button class="btn btn-ghost" data-act="dup" ${disabledAttr}>Duplicar</button>
          <select class="move-select" data-id="${lead.id}" ${disabledAttr}>
            <option value="">Mover‚Ä¶</option>
            ${moveOptions}
          </select>
          <button class="btn" style="border-color:#cc4b4b;color:#ffdddd" data-act="del" ${disabledAttr}>Apagar</button>
          <button class="btn btn-ghost" data-act="toggle" ${disabledAttr}>${lead.visivel!==false?'Tornar invis√≠vel':'Tornar vis√≠vel'}</button>
        </div>
        <div class="actions actions-tarefas">
          <button class="btn btn-ghost" data-act="add-task">+ Tarefa</button>
          <button class="btn btn-ghost" data-act="view-tasks">Ver Tarefas</button>
        </div>
      `;

      card.querySelector('[data-act="edit"]').addEventListener('click',()=>{
        if(!EDIT_MODE){ alert('Modo de edi√ß√£o bloqueado. Ative "üîì Edi√ß√£o ativa" para editar.'); return; }
        $('saveLead').dataset.editId = lead.id;
        $('saveLead').dataset.editEstado = lead.estado;
        openModal(lead);
      });
      card.querySelector('[data-act="dup"]').addEventListener('click',()=>{
        if(!EDIT_MODE){ alert('Modo de edi√ß√£o bloqueado. Ative "üîì Edi√ß√£o ativa" para duplicar.'); return; }
        const copy=Object.assign({},lead,{ id:uid(), ref_interna:(lead.ref_interna? lead.ref_interna+'-copy':''), data:new Date().toISOString().slice(0,10) });
        LEADS.push(copy); saveLS(); renderBoard();
      });

      const selMove = card.querySelector('.move-select');
      selMove.addEventListener('change', e=>{
        if(!EDIT_MODE){ e.target.value=''; alert('Modo de edi√ß√£o bloqueado. Ative "üîì Edi√ß√£o ativa" para mover.'); return; }
        const target = e.target.value;
        if(!target || !COLS.includes(target)) return;
        lead.estado = target;
        saveLS(); renderBoard();
      });

      card.querySelector('[data-act="del"]').addEventListener('click',()=>{
        if(!EDIT_MODE){ alert('Modo de edi√ß√£o bloqueado. Ative "üîì Edi√ß√£o ativa" para apagar.'); return; }
        if(!confirm('Eliminar esta lead?')) return;
        LEADS=LEADS.filter(x=>x.id!==lead.id); saveLS(); renderBoard();
      });
      card.querySelector('[data-act="toggle"]').addEventListener('click',()=>{
        if(!EDIT_MODE){ alert('Modo de edi√ß√£o bloqueado. Ative "üîì Edi√ß√£o ativa" para alterar visibilidade.'); return; }
        lead.visivel = lead.visivel===false ? true : false;
        saveLS(); renderBoard();
      });

      card.querySelector('[data-act="add-task"]').addEventListener('click',()=>{
        createTaskFromLead(lead);
      });
      card.querySelector('[data-act="view-tasks"]').addEventListener('click',()=>{
        window.open('tarefas.html','_blank');
      });

      if(lead.visivel===false) card.style.opacity=.45;
      list.appendChild(card);
    });
  });

  Array.from(document.querySelectorAll('.col')).forEach(col=>{
    const name=col.getAttribute('data-col');
    const count=byEstado.find(x=>x.estado===name)?.items.length||0;
    col.querySelector('.counter').textContent=count;
  });

  renderSummary(byEstado);
}

/* ===== Exporta√ß√£o ===== */
function filterForExport(arr){
  let out=[...arr];
  const term = norm(FILTER.q||'');
  if(term){
    out=out.filter(l=>{
      const blob=[
        l.nome,
        l.consultor,
        l.contacto,
        l.email,
        l.ref_interna,
        l.zona,
        l.tipo_negocio,
        l.imovel,
        l.tipologia,
        l.notas
      ].map(x=>norm(x)).join(' ');
      return blob.includes(term);
    });
  }
  if(FILTER.consultor) out=out.filter(l=>l.consultor===FILTER.consultor);
  if(FILTER.estado) out=out.filter(l=>l.estado===FILTER.estado);
  if(FILTER.ini) out=out.filter(l=>!l.data || l.data>=FILTER.ini);
  if(FILTER.fim) out=out.filter(l=>!l.data || l.data<=FILTER.fim);
  if(FILTER.onlyHidden) out=out.filter(l=>l.visivel===false);
  if(!FILTER.showHidden && !FILTER.onlyHidden) out=out.filter(l=>l.visivel!==false);
  return out;
}
function toCSV(rows){ return rows.map(r=>r.map(v=>`"${String(v??'').replaceAll('"','""')}"`).join(',')).join('\n'); }

$('exportCsv').addEventListener('click',()=>{
  const headers=[
    "ID","Estado","Data","Consultor","Nome","Contacto","Email","TipoNeg√≥cio",
    "Im√≥vel","Tipologia","Zona","Capitais","Valor","Financiamento","Simula√ß√£o",
    "Banco","Comprador/Vend.","Perfil","Classifica√ß√£o","RefInterna","URL",
    "Urgente","Planta","1¬™Hab","TemIm√≥vel","J√°Venda","Notas","Vis√≠vel",
    "Neg√≥cio","Comiss√£o(%)","SinalReserva","ValorCPCV","Intercalares",
    "ValorEscritura","DataCPCV","DataEscritura","PagamentoComissoesTipo",
    "PagamentoComissoesOutro","FechoObs",
    "Prop_NomeProponente","Prop_Contacto","Prop_Email","Prop_Valor","Prop_Termos","Prop_Data","Prop_DataAceite","Prop_ContraPropostas"
  ];
  const rows = filterForExport(LEADS).map(l=>{
    const p = l.proposta || {};
    const contra = Array.isArray(p.contraPropostas)
      ? p.contraPropostas.map(cp=>`${cp.data||''} :: ${cp.valor||''} :: ${cp.termos||''}`).join(' || ')
      : '';
    return [
      l.id,l.estado,l.data||'',l.consultor||'',l.nome||'',l.contacto||'',l.email||'',
      l.tipo_negocio||'',l.imovel||'',l.tipologia||'',l.zona||'',l.capitais||'',l.valor||'',
      l.financiamento||'',l.simulacao||'',l.banco||'',l.papel||'',l.perfil||'',
      l.classificacao||'',l.ref_interna||'',l.url||'',l.urgente||'',l.planta||'',l.primeira_hab||'',
      l.tem_imovel||'',l.ja_venda||'',l.notas||'', (l.visivel!==false?'Sim':'N√£o'),
      l.fecho_negocio||'', (l.fecho_comissao_pct!==''&&l.fecho_comissao_pct!=null? l.fecho_comissao_pct : ''),
      l.fecho_sinal_reserva||'', l.fecho_valor_cpcv||'',
      (Array.isArray(l.fecho_intercalares)? l.fecho_intercalares.join(' | ') : ''),
      l.fecho_valor_escritura||'', l.fecho_cpcv_date||'', l.fecho_escritura_date||'',
      l.fecho_pagamento_tipo||'', l.fecho_pagamento_outro||'', l.fecho_obs||'',
      p.nomeProponente||'',p.contactoProponente||'',p.emailProponente||'',p.valorProposta||'',
      p.termosProposta||'',p.dataProposta||'',p.dataPropostaAceite||'',contra
    ];
  });
  const csv=toCSV([headers,...rows]);
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='leads.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});

$('exportXlsx').addEventListener('click',()=>{
  const data = filterForExport(LEADS).map(l=>{
    const p = l.proposta || {};
    const contra = Array.isArray(p.contraPropostas)
      ? p.contraPropostas.map(cp=>`${cp.data||''} :: ${cp.valor||''} :: ${cp.termos||''}`).join(' || ')
      : '';
    return {
      ID:l.id,
      Estado:l.estado,
      Data:l.data||'',
      Consultor:l.consultor||'',
      Nome:l.nome||'',
      Contacto:l.contacto||'',
      Email:l.email||'',
      TipoNeg√≥cio:l.tipo_negocio||'',
      Im√≥vel:l.imovel||'',
      Tipologia:l.tipologia||'',
      Zona:l.zona||'',
      Capitais:+(l.capitais||0),
      Valor:+(l.valor||0),
      Financiamento:l.financiamento||'',
      Simula√ß√£o:l.simulacao||'',
      Banco:l.banco||'',
      "Comprador/Vend.":l.papel||'',
      Perfil:l.perfil||'',
      Classifica√ß√£o:l.classificacao||'',
      "Ref. Interna":l.ref_interna||'',
      URL:l.url||'',
      Urgente:l.urgente||'',
      Planta:l.planta||'',
      "1¬™ Hab.":l.primeira_hab||'',
      "Tem Im√≥vel":l.tem_imovel||'',
      "J√° √† venda":l.ja_venda||'',
      Notas:l.notas||'',
      Vis√≠vel:(l.visivel!==false?'Sim':'N√£o'),
      Neg√≥cio:+(l.fecho_negocio||0),
      "Comiss√£o(%)":(l.fecho_comissao_pct!==''&&l.fecho_comissao_pct!=null? +l.fecho_comissao_pct : ''),
      SinalReserva:+(l.fecho_sinal_reserva||0),
      ValorCPCV:+(l.fecho_valor_cpcv||0),
      Intercalares:(Array.isArray(l.fecho_intercalares)? l.fecho_intercalares.join(' | ') : ''),
      ValorEscritura:+(l.fecho_valor_escritura||0),
      DataCPCV:l.fecho_cpcv_date||'',
      DataEscritura:l.fecho_escritura_date||'',
      PagamentoComissoesTipo:l.fecho_pagamento_tipo||'',
      PagamentoComissoesOutro:l.fecho_pagamento_outro||'',
      FechoObs:l.fecho_obs||'',
      "Prop_NomeProponente":p.nomeProponente||'',
      "Prop_Contacto":p.contactoProponente||'',
      "Prop_Email":p.emailProponente||'',
      "Prop_Valor":p.valorProposta||'',
      "Prop_Termos":p.termosProposta||'',
      "Prop_Data":p.dataProposta||'',
      "Prop_DataAceite":p.dataPropostaAceite||'',
      "Prop_ContraPropostas":contra
    };
  });
  const ws=XLSX.utils.json_to_sheet(data);
  const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Leads');
  XLSX.writeFile(wb, 'leads.xlsx');
});

/* ===== Importa√ß√£o CSV ===== */
$('importCsvBtn').addEventListener('click', ()=>{
  $('importCsvInput').click();
});

$('importCsvInput').addEventListener('change', (e)=>{
  const file = e.target.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = function(ev){
    try{
      const data = new Uint8Array(ev.target.result);
      const wb = XLSX.read(data, {type:'array'});
      const wsName = wb.SheetNames[0];
      const ws = wb.Sheets[wsName];
      const json = XLSX.utils.sheet_to_json(ws, {defval:''});

      if(!json.length){
        alert('O ficheiro CSV est√° vazio ou n√£o foi poss√≠vel ler dados.');
        return;
      }

      const importedLeads = json.map(row=>{
        const pContraStr = row["Prop_ContraPropostas"] || '';
        const contraPropostas = pContraStr
          ? pContraStr.split('||').map(chunk=>{
              const parts = chunk.split('::').map(s=>s.trim());
              if(parts.every(x=>!x)) return null;
              return {
                data: parts[0] || '',
                valor: parts[1] || '',
                termos: parts[2] || ''
              };
            }).filter(x=>x)
          : [];

        const propostaHasData =
          row["Prop_NomeProponente"] ||
          row["Prop_Contacto"] ||
          row["Prop_Email"] ||
          row["Prop_Valor"] ||
          row["Prop_Termos"] ||
          row["Prop_Data"] ||
          row["Prop_DataAceite"] ||
          (contraPropostas.length>0);

        const proposta = propostaHasData ? {
          nomeProponente: row["Prop_NomeProponente"] || '',
          contactoProponente: row["Prop_Contacto"] || '',
          emailProponente: row["Prop_Email"] || '',
          valorProposta: row["Prop_Valor"] || '',
          termosProposta: row["Prop_Termos"] || '',
          dataProposta: row["Prop_Data"] || '',
          dataPropostaAceite: row["Prop_DataAceite"] || '',
          contraPropostas
        } : undefined;

        const visivelStr = String(row["Vis√≠vel"] || '').toLowerCase();
        const visivel = visivelStr === 'n√£o' || visivelStr === 'nao' ? false : true;

        const interStr = row["Intercalares"] || '';
        const interArr = interStr
          ? interStr.split('|').map(s=>s.trim()).filter(s=>s!=='')
          : [];

        return {
          id: row["ID"] || uid(),
          estado: row["Estado"] || 'Novo',
          data: row["Data"] || '',
          consultor: row["Consultor"] || '',
          nome: row["Nome"] || '',
          contacto: row["Contacto"] || '',
          email: row["Email"] || '',
          tipo_negocio: row["TipoNeg√≥cio"] || '',
          imovel: row["Im√≥vel"] || '',
          tipologia: row["Tipologia"] || '',
          zona: row["Zona"] || '',
          capitais: row["Capitais"] || '',
          valor: row["Valor"] || '',
          financiamento: row["Financiamento"] || '',
          simulacao: row["Simula√ß√£o"] || '',
          banco: row["Banco"] || '',
          papel: row["Comprador/Vend."] || '',
          perfil: row["Perfil"] || '',
          classificacao: row["Classifica√ß√£o"] || '',
          ref_interna: row["RefInterna"] || row["Ref. Interna"] || '',
          url: row["URL"] || '',
          urgente: row["Urgente"] || '',
          planta: row["Planta"] || '',
          primeira_hab: row["1¬™Hab"] || row["1¬™ Hab."] || '',
          tem_imovel: row["TemIm√≥vel"] || row["Tem Im√≥vel"] || '',
          ja_venda: row["J√°Venda"] || row["J√° √† venda"] || '',
          notas: row["Notas"] || '',
          visivel,

          fecho_negocio: row["Neg√≥cio"] || '',
          fecho_comissao_pct: row["Comiss√£o(%)"] !== '' ? row["Comiss√£o(%)"] : '',
          fecho_sinal_reserva: row["SinalReserva"] || '',
          fecho_valor_cpcv: row["ValorCPCV"] || '',
          fecho_intercalares: interArr,
          fecho_valor_escritura: row["ValorEscritura"] || '',
          fecho_cpcv_date: row["DataCPCV"] || '',
          fecho_escritura_date: row["DataEscritura"] || '',
          fecho_pagamento_tipo: row["PagamentoComissoesTipo"] || '',
          fecho_pagamento_outro: row["PagamentoComissoesOutro"] || '',
          fecho_obs: row["FechoObs"] || '',
          proposta
        };
      });

      const replace = confirm(
        'Deseja SUBSTITUIR todas as leads atuais pelas do ficheiro?\n\n' +
        'OK = substituir tudo\n' +
        'Cancelar = acrescentar √†s existentes (atualizando apenas IDs coincidentes).'
      );

      if(replace){
        LEADS = [];
      }

      importedLeads.forEach(imp=>{
        const idx = LEADS.findIndex(l=>l.id===imp.id);
        if(idx>=0){
          LEADS[idx] = imp;
        }else{
          LEADS.push(imp);
        }
      });

      saveLS();
      renderBoard();
      alert('Importa√ß√£o de CSV conclu√≠da com sucesso.');

    }catch(err){
      console.error('Erro ao importar CSV de leads', err);
      alert('Ocorreu um erro ao importar o ficheiro CSV. Verifique se foi exportado a partir desta aplica√ß√£o.');
    }finally{
      e.target.value='';
    }
  };
  reader.readAsArrayBuffer(file);
});

/* ===== BACKUP & RESTORE (JSON) ===== */

function exportLeadsBackup(){
  if(!LEADS || !LEADS.length){
    alert('N√£o existem leads para guardar em backup.');
    return;
  }
  const payload = {
    kind: LEADS_BACKUP_KIND,
    ts: new Date().toISOString(),
    version: 1,
    lsKey: LS_KEY,
    leads: LEADS
  };
  const json = JSON.stringify(payload,null,2);
  const blob = new Blob([json],{type:'application/json'});
  const d = new Date();
  const stamp = [
    d.getFullYear(),
    String(d.getMonth()+1).padStart(2,'0'),
    String(d.getDate()).padStart(2,'0'),
    '_',
    String(d.getHours()).padStart(2,'0'),
    String(d.getMinutes()).padStart(2,'0')
  ].join('');
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'gpp_leads_backup_' + stamp + '.json';
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(a.href);
}

function importLeadsBackupFromFile(file){
  const reader = new FileReader();
  reader.onload = function(ev){
    try{
      const txt = ev.target.result;
      const data = JSON.parse(txt);

      let leadsArr = null;

      if(Array.isArray(data)){
        // caso antigo: apenas array de leads
        leadsArr = data;
      }else if(data && data.kind === LEADS_BACKUP_KIND && Array.isArray(data.leads)){
        leadsArr = data.leads;
      }else{
        alert('Ficheiro de backup inv√°lido ou formato n√£o reconhecido.');
        return;
      }

      if(!leadsArr || !leadsArr.length){
        alert('O ficheiro de backup n√£o cont√©m leads.');
        return;
      }

      const replace = confirm(
        'Vai restaurar leads a partir deste backup.\n\n' +
        'OK = substituir TODAS as leads atuais pelo conte√∫do do backup\n' +
        'Cancelar = abortar sem alterar nada.'
      );
      if(!replace) return;

      LEADS = leadsArr;
      saveLS();
      renderBoard();
      alert('Backup de leads restaurado com sucesso.');

    }catch(e){
      console.error('Erro ao restaurar backup de leads', e);
      alert('N√£o foi poss√≠vel ler o ficheiro de backup. Verifique se selecionou o ficheiro correto.');
    }
  };
  reader.readAsText(file,'utf-8');
}

$('btnBackup').addEventListener('click', exportLeadsBackup);
$('btnRestore').addEventListener('click', ()=> $('restoreInput').click());
$('restoreInput').addEventListener('change', (e)=>{
  const file = e.target.files[0];
  if(!file) return;
  importLeadsBackupFromFile(file);
  e.target.value='';
});

/* ===== Boot ===== */
(function init(){
  LEADS = loadLS();
  buildFilters();
  loadPersistedFilters();

  const stored = localStorage.getItem(EDIT_LS);
  EDIT_MODE = stored==='1';
  updateEditUI();

  $('toggleEdit').addEventListener('click',()=>{
    setEditMode(!EDIT_MODE);
  });

  renderBoard();
  applyDeepLinkFromTarefas();
})();
</script>
</body>
</html>
