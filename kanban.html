<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Garvetur Porto Pro ‚Äî Leads</title>
<style>
  :root{--gold:#A38B63;--bg:#0E0E0E;--panel:#131313;--text:#fff;--muted:#A9AFB7;--ok:#2ecc71;--warn:#FFC107;--bad:#EF5350;--line:rgba(255,255,255,.08)}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  header{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--line);background:#0F0F0F;position:sticky;top:0;z-index:10}
  nav a{margin-right:6px;text-decoration:none;color:#ddd;border:1px solid var(--line);padding:6px 10px;border-radius:8px}
  nav a.active{background:var(--gold);color:#111;border-color:var(--gold);font-weight:600}
  .btn{background:transparent;border:1px solid rgba(163,139,99,.5);color:#fff;padding:6px 10px;border-radius:10px;cursor:pointer;font-size:12px}
  .btn.primary{background:var(--gold);color:#111;border-color:var(--gold);font-weight:700}
  .btn.ghost{border-color:var(--line);color:#ddd}
  .layout{display:grid;grid-template-columns:320px 1fr;gap:0;height:calc(100vh - 52px)}
  .quick{display:flex;align-items:center;gap:10px;margin-right:4px}
  .switch{position:relative;display:inline-block;width:44px;height:22px;vertical-align:middle}
  .switch input{opacity:0;width:0;height:0}
  .slider{position:absolute;cursor:pointer;inset:0;background:#3a3a3a;transition:.2s;border-radius:999px;border:1px solid var(--line)}
  .slider:before{position:absolute;content:"";height:18px;width:18px;left:2px;top:1.5px;background:#d9d9d9;transition:.2s;border-radius:50%}
  input:checked + .slider{background:var(--gold)}
  input:checked + .slider:before{transform:translateX(22px);background:#111}
  .sidebar{background:var(--panel);border-right:1px solid var(--line);position:relative;display:flex;flex-direction:column}
  .side-scroll{padding:12px;overflow:auto;flex:1}
  .side-title{font-size:12px;color:#cfcfcf;text-transform:uppercase;letter-spacing:.05em;margin:8px 0 6px}
  .group{border:1px solid var(--line);border-radius:12px;padding:10px;background:#0F0F0F;margin-bottom:10px}
  .label{font-size:12px;color:#d6d6d6;margin:0 0 6px}
  .field{display:flex;gap:8px}
  .field input,.field select{flex:1;background:#0E0E0E;border:1px solid rgba(255,255,255,.15);border-radius:10px;padding:8px 10px;color:#fff;outline:none}
  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chip{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.16);background:#0E0E0E;color:#ddd;cursor:pointer}
  .chip.active{background:var(--gold);color:#111;border-color:var(--gold);font-weight:700}
  .filters-dock{position:sticky;bottom:0;background:linear-gradient(180deg,rgba(19,19,19,.85) 0%,rgba(19,19,19,1) 24%);border-top:1px solid var(--line);padding:10px;display:grid;gap:8px;z-index:5}
  .dock-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .dock-actions{display:flex;gap:8px}
  .badge{display:inline-flex;align-items:center;gap:6px;background:#0E0E0E;border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-size:12px;color:#ddd}
  .badge .dot{width:10px;height:10px;border-radius:50%;border:1px solid var(--line);display:inline-block}
  .board{overflow:auto;padding:12px}
  .cols{display:grid;grid-template-columns:repeat(6,1fr);gap:12px;min-width:1100px}
  .col{background:var(--panel);border:1px solid var(--line);border-radius:14px;display:flex;flex-direction:column;max-height:100%}
  .col-head{padding:10px 12px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between}
  .col-title{font-size:12px;letter-spacing:.05em;text-transform:uppercase;color:#eee}
  .count{font-size:11px;color:#bbb}
  .col-body{padding:10px;overflow:auto;display:grid;gap:10px}
  .card{background:#0D0D0D;border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:10px}
  .card .name{font-weight:800;margin:0 0 6px 0;font-size:13px}
  .meta{font-size:12px;color:#cfcfcf;margin-bottom:6px}
  .meta .pill{display:inline-block;border:1px solid rgba(255,255,255,.14);padding:2px 6px;border-radius:999px;font-size:11px;margin-right:6px}
  .contact{display:grid;grid-template-columns:1fr;gap:4px;margin-top:6px;font-size:12px}
  .contact a{color:#e9e9e9;text-decoration:none;border-bottom:1px dotted rgba(255,255,255,.2)}
  .contact a:hover{color:#fff;border-bottom-color:var(--gold)}
  .tags{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
  .tag{font-size:10px;padding:4px 6px;border-radius:999px;border:1px solid rgba(255,255,255,.14);color:#ddd}
  .actions{display:flex;gap:6px;margin-top:8px}
  .iconbtn{border:1px solid rgba(255,255,255,.18);background:#101010;border-radius:8px;padding:6px 8px;cursor:pointer;font-size:12px;color:#e0e0e0}
  .iconbtn:hover{border-color:var(--gold);color:#fff}
  .icon-danger{border-color:#5f1e1e;color:#ffbbbb}
  .icon-danger:hover{border-color:#EF5350;color:#fff}
  .hidden-flag{opacity:.6}
  /* Toast */
  .toast{position:fixed;bottom:16px;right:16px;background:#111;border:1px solid rgba(255,255,255,.15);color:#fff;padding:10px 12px;border-radius:10px;opacity:0;transform:translateY(8px);transition:.2s;z-index:9999}
  .toast.show{opacity:1;transform:translateY(0)}
  @media(max-width:1200px){.layout{grid-template-columns:1fr}.cols{min-width:900px}}
</style>
</head>
<body>
<header>
  <div style="display:flex;align-items:center;gap:10px">
    <strong style="color:#FFD166">Garvetur Porto Pro</strong>
    <nav>
      <a href="./index.html">Mapa</a>
      <a class="active" href="./kanban.html">Leads</a>
      <a href="./angariacoes.html">Angaria√ß√µes</a>
      <a href="./dashboard.html">Dashboard</a>
    </nav>
  </div>
  <div style="display:flex;align-items:center;gap:10px">
    <div class="quick" title="Alterna entre s√≥ vis√≠veis e vis√≠veis + invis√≠veis">
      <label for="q_showHidden">Mostrar invis√≠veis</label>
      <label class="switch">
        <input type="checkbox" id="q_showHidden">
        <span class="slider"></span>
      </label>
    </div>
    <button id="addLead" class="btn primary" type="button">+ Nova lead</button>
    <button id="exportLeads" class="btn" type="button">Exportar CSV</button>
  </div>
</header>

<div class="layout">
  <aside class="sidebar">
    <div class="side-scroll" id="sideScroll">
      <div class="side-title">Pesquisa</div>
      <div class="group">
        <div class="label">Texto livre</div>
        <div class="field"><input id="q_text" placeholder="Cliente, im√≥vel, zona, notas..."></div>
        <div class="help">Filtra por m√∫ltiplos campos (cliente, zona, im√≥vel, notas).</div>
      </div>

      <div class="side-title">Filtros principais</div>
      <div class="group">
        <div class="label">Consultor</div>
        <div class="field">
          <select id="f_consultor">
            <option value="">(Todos)</option>
            <option>Rui Quelhas</option><option>Manuel Oliveira</option><option>Jo√£o Sousa</option>
            <option>Francisco dos Santos</option><option>Ros√°rio Vasconcelos</option><option>Armanda Meireles</option><option>Audrey Lucas</option>
          </select>
        </div>

        <div class="label" style="margin-top:8px">Visibilidade</div>
        <div class="field">
          <select id="f_vis">
            <option value="visiveis">S√≥ vis√≠veis</option>
            <option value="invisiveis">S√≥ invis√≠veis</option>
            <option value="todos">Vis√≠veis + invis√≠veis</option>
          </select>
        </div>

        <div class="label" style="margin-top:8px">Origem</div>
        <div class="field">
          <select id="f_origem">
            <option value="">(Todas)</option>
            <option>Promotor</option><option>Refer√™ncia</option><option>Digital</option><option>Walk-in</option><option>Outro</option><option>Indefinido</option>
          </select>
        </div>
      </div>

      <div class="side-title">R√°pidos</div>
      <div class="group">
        <div class="chips" id="chips_quick">
          <div class="chip" data-q="7">√öltimos 7d</div><div class="chip" data-q="30">√öltimos 30d</div><div class="chip" data-q="90">√öltimos 90d</div><div class="chip" data-q="ytd">YTD</div>
        </div>
        <div class="dock-grid" style="margin-top:8px">
          <div><div class="label">De</div><input type="date" id="f_de"></div>
          <div><div class="label">At√©</div><input type="date" id="f_ate"></div>
        </div>
      </div>

      <div class="side-title">Estado & sinaliza√ß√µes</div>
      <div class="group">
        <div class="chips" id="chips_estado">
          <div class="chip active" data-stage="">Todos</div>
          <div class="chip" data-stage="novo">Novo</div>
          <div class="chip" data-stage="em_contacto">Em Contacto</div>
          <div class="chip" data-stage="qualificado">Qualificado</div>
          <div class="chip" data-stage="visita">Visita</div>
          <div class="chip" data-stage="proposta">Proposta</div>
          <div class="chip" data-stage="fecho">Fecho</div>
        </div>
        <div class="help">Use para destacar apenas uma etapa, mantendo o quadro intacto.</div>
      </div>

      <div class="side-title">Resumo</div>
      <div class="group" id="summaryBox">
        <div class="badge"><span class="dot" style="background:#9E9E9E"></span>Novo: <b id="s_n">0</b></div>
        <div class="badge"><span class="dot" style="background:#A38B63"></span>Em Contacto: <b id="s_c">0</b></div>
        <div class="badge"><span class="dot" style="background:#2ecc71"></span>Qualificado: <b id="s_q">0</b></div>
        <div class="badge"><span class="dot" style="background:#4285F4"></span>Visita: <b id="s_v">0</b></div>
        <div class="badge"><span class="dot" style="background:#FFC107"></span>Proposta: <b id="s_p">0</b></div>
        <div class="badge"><span class="dot" style="background:#4CAF50"></span>Fecho: <b id="s_f">0</b></div>
        <div class="badge"><span class="dot" style="background:#555"></span>Invis√≠veis (filtrados): <b id="s_hidden">0</b></div>
      </div>
    </div>

    <div class="filters-dock">
      <div class="dock-grid">
        <div><div class="label">Zona</div><input id="f_zona" placeholder="Ex.: Boavista, Foz, Gaia‚Ä¶"></div>
        <div><div class="label">Im√≥vel</div><input id="f_imovel" placeholder="Ex.: T2, Moradia, Lote‚Ä¶"></div>
      </div>
      <div class="dock-actions">
        <button id="applyFilters" class="btn primary" type="button">Aplicar</button>
        <button id="clearFilters" class="btn ghost" type="button">Limpar</button>
      </div>
    </div>
  </aside>

  <main class="board">
    <div class="cols">
      <section class="col c-novo" data-col="novo"><div class="col-head"><div class="col-title">Novo</div><div class="count" id="cnt_n">0</div></div><div class="col-body" id="col_n"></div></section>
      <section class="col c-cont" data-col="em_contacto"><div class="col-head"><div class="col-title">Em Contacto</div><div class="count" id="cnt_c">0</div></div><div class="col-body" id="col_c"></div></section>
      <section class="col c-qual" data-col="qualificado"><div class="col-head"><div class="col-title">Qualificado</div><div class="count" id="cnt_q">0</div></div><div class="col-body" id="col_q"></div></section>
      <section class="col c-vis" data-col="visita"><div class="col-head"><div class="col-title">Visita</div><div class="count" id="cnt_v">0</div></div><div class="col-body" id="col_v"></div></section>
      <section class="col c-prop" data-col="proposta"><div class="col-head"><div class="col-title">Proposta</div><div class="count" id="cnt_p">0</div></div><div class="col-body" id="col_p"></div></section>
      <section class="col c-fecho" data-col="fecho"><div class="col-head"><div class="col-title">Fecho</div><div class="count" id="cnt_f">0</div></div><div class="col-body" id="col_f"></div></section>
    </div>
  </main>
</div>

<!-- MODAIS existentes (Nova lead, Editar contacto) ‚Äî mant√™m-se iguais √† sua vers√£o atual -->
<!-- ‚Ä¶ (para poupar espa√ßo aqui, mantive o conte√∫do dos modais conforme a sua √∫ltima vers√£o funcional) ‚Ä¶ -->

<!-- Toast -->
<div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
/* === Estado & utilit√°rios (mant√™m-se) === */
const LS_LEADS='gpp_leads_v3';
let F={ q:'',consultor:'',vis:'visiveis',origem:'',de:'',ate:'',stage:'',tipo:'',perfil:'',capMin:'',fb:'',zona:'',imovel:'' };
const $=sel=>document.querySelector(sel);
const el=id=>document.getElementById(id);
const txt=v=>(v==null||v==='')?'':String(v).toLowerCase();
const money=n=>isFinite(n)?Number(n).toLocaleString('pt-PT',{style:'currency',currency:'EUR'}):'‚Äî';
function loadLeads(){ try{return JSON.parse(localStorage.getItem(LS_LEADS)||'[]')}catch(e){return[]} }
function saveLeads(a){ localStorage.setItem(LS_LEADS, JSON.stringify(a)) }
function dateIn(iso,d1,d2){ if(!iso)return true; const t=Date.parse(iso); const ok1=!d1||t>=Date.parse(d1+'T00:00:00'); const ok2=!d2||t<=Date.parse(d2+'T23:59:59'); return ok1&&ok2 }
function normalizePhone(p){ return String(p||'').replace(/\s+/g,'') }
function safeMail(m){ return String(m||'').trim() }
function toast(msg){ const t=el('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1600); }

/* === Render de cart√µes (mant√©m-se; assegure que os bot√µes t√™m data-act) === */
function cardHTML(l){
  const tel=normalizePhone(l.tel||l.contacto||l.contact||l.telefone);
  const email=safeMail(l.email);
  const v=isFinite(l.val)?money(l.val):'‚Äî';
  const tags=[];
  if(l.tipo_negocio) tags.push(l.tipo_negocio);
  if(l.origem) tags.push(l.origem);
  if(l.tipo_cli) tags.push(l.tipo_cli);
  if(l.perfil) tags.push(l.perfil);
  if(l.imovel_tipo) tags.push(l.imovel_tipo);
  if(l.tipologia) tags.push(l.tipologia);
  const eyeLabel=(l.hidden===true)?'Tornar vis√≠vel':'Tornar invis√≠vel';
  const eyeIcon=(l.hidden===true)?'üëÅÔ∏è':'üö´';
  return `
    <div class="card ${l.hidden===true?'hidden-flag':''}" draggable="true" data-id="${l.id}" data-dbl="1">
      <div class="name">${l.cliente||'‚Äî'}</div>
      <div class="meta">
        <span class="pill">${l.zona||'‚Äî'}</span>
        <span class="pill">${l.consultor||'Rui Quelhas'}</span>
        <span class="pill">${v}</span>
        <span class="pill">${l.createdAt?new Date(l.createdAt).toLocaleDateString('pt-PT'):''}</span>
      </div>
      <div class="contact">
        <div><strong>Contacto:</strong> ${tel?`<a href="tel:${tel}">${tel}</a>`:'‚Äî'}</div>
        <div><strong>Email:</strong> ${email?`<a href="mailto:${email}">${email}</a>`:'‚Äî'}</div>
      </div>
      <div class="tags">${tags.map(t=>`<span class="tag">${t}</span>`).join('')}</div>
      <div class="actions">
        <button class="iconbtn" type="button" data-act="toggle" draggable="false" title="${eyeLabel}">${eyeIcon}</button>
        <button class="iconbtn icon-danger" type="button" data-act="del" draggable="false" title="Eliminar">üóëÔ∏è</button>
      </div>
    </div>`;
}

/* === Filtros, render de colunas, DnD ‚Äî mant√™m-se como j√° tinha === */
function applyFilter(l){
  const q=txt(F.q);
  if(q){ const blob=[l.cliente,l.imovel,l.zona,l.notas,l.tel,l.email].map(x=>txt(x)).join(' '); if(!blob.includes(q)) return false; }
  if(F.consultor && l.consultor!==F.consultor) return false;
  if(F.origem && String(l.origem||'')!==F.origem) return false;
  if(F.stage && (l.stage||'')!==F.stage) return false;
  if(F.zona && !String(l.zona||'').toLowerCase().includes(F.zona.toLowerCase())) return false;
  if(F.imovel && !String(l.imovel||l.imovel_tipo||'').toLowerCase().includes(F.imovel.toLowerCase())) return false;
  if(!dateIn(l.createdAt,F.de,F.ate)) return false;
  return true;
}

function render(){
  const all=loadLeads();
  const countsAll={novo:0,em_contacto:0,qualificado:0,visita:0,proposta:0,fecho:0};
  let hiddenCountFiltered=0;
  const buckets={novo:[],em_contacto:[],qualificado:[],visita:[],proposta:[],fecho:[]};

  all.forEach(l=>{
    if(!applyFilter(l)) return;
    const s=(l.stage||'novo'); if(countsAll[s]===undefined) countsAll[s]=0; countsAll[s]++;
    if(l.hidden===true) hiddenCountFiltered++;
    const showHidden=(F.vis==='invisiveis'||F.vis==='todos');
    const showVisible=(F.vis==='visiveis'||F.vis==='todos');
    const isHidden=(l.hidden===true);
    const canRender=((isHidden&&showHidden)||(!isHidden&&showVisible));
    if(!canRender) return;
    buckets[s].push(l);
  });

  el('col_n').innerHTML=buckets.novo.map(cardHTML).join('')||'<div class="ghost-drop">Sem registos‚Ä¶</div>';
  el('col_c').innerHTML=buckets.em_contacto.map(cardHTML).join('')||'<div class="ghost-drop">Sem registos‚Ä¶</div>';
  el('col_q').innerHTML=buckets.qualificado.map(cardHTML).join('')||'<div class="ghost-drop">Sem registos‚Ä¶</div>';
  el('col_v').innerHTML=buckets.visita.map(cardHTML).join('')||'<div class="ghost-drop">Sem registos‚Ä¶</div>';
  el('col_p').innerHTML=buckets.proposta.map(cardHTML).join('')||'<div class="ghost-drop">Sem registos‚Ä¶</div>';
  el('col_f').innerHTML=buckets.fecho.map(cardHTML).join('')||'<div class="ghost-drop">Sem registos‚Ä¶</div>';

  el('cnt_n').textContent=countsAll.novo||0;
  el('cnt_c').textContent=countsAll.em_contacto||0;
  el('cnt_q').textContent=countsAll.qualificado||0;
  el('cnt_v').textContent=countsAll.visita||0;
  el('cnt_p').textContent=countsAll.proposta||0;
  el('cnt_f').textContent=countsAll.fecho||0;
  el('s_hidden').textContent=hiddenCountFiltered;

  attachDnD();
}

/* === Drag & Drop ‚Äî igual √† sua vers√£o atual === */
function attachDnD(){
  document.querySelectorAll('.card').forEach(card=>{
    card.addEventListener('dragstart', e=>{ e.dataTransfer.setData('text/plain', card.dataset.id); e.dataTransfer.effectAllowed='move'; });
  });
  document.querySelectorAll('.col-body').forEach(zone=>{
    zone.addEventListener('dragover', e=>{ e.preventDefault(); e.dataTransfer.dropEffect='move'; });
    zone.addEventListener('drop', e=>{
      e.preventDefault();
      const id=e.dataTransfer.getData('text/plain');
      moveLeadToColumn(id, zone.closest('.col').dataset.col);
    });
  });
}
function moveLeadToColumn(id, stage){
  const arr=loadLeads(); const i=arr.findIndex(l=>String(l.id)===String(id));
  if(i>=0){ arr[i].stage=stage; arr[i].updatedAt=new Date().toISOString(); saveLeads(arr); render(); }
}

/* === A√ß√µes nos cart√µes (delegadas) ‚Äî NOVO === */
document.addEventListener('pointerdown', (ev)=>{
  const btn = ev.target && (ev.target.closest?.('.iconbtn'));
  if(btn){ ev.stopPropagation(); } // impede iniciar drag do cart√£o
}, {capture:true});

document.addEventListener('click', (ev)=>{
  const btn = ev.target && (ev.target.closest?.('.iconbtn'));
  if(!btn) return;
  ev.preventDefault();
  ev.stopPropagation();
  const act = btn.dataset.act;
  const card = btn.closest('.card');
  const id   = card?.dataset.id;
  if(!id) return;

  if(act==='toggle'){
    const arr=loadLeads(); const i=arr.findIndex(x=>String(x.id)===String(id));
    if(i<0) return;
    arr[i].hidden = !(arr[i].hidden===true);
    arr[i].updatedAt=new Date().toISOString();
    saveLeads(arr);
    render();
    toast(arr[i].hidden ? 'Lead marcada como invis√≠vel' : 'Lead marcada como vis√≠vel');
    return;
  }

  if(act==='del'){
    if(confirm('Eliminar esta lead? Esta a√ß√£o √© irrevers√≠vel.')){
      const arr=loadLeads().filter(x=>String(x.id)!==String(id));
      saveLeads(arr);
      render();
      toast('Lead eliminada');
    }
    return;
  }
});

/* === Nova lead / Editar contacto / filtros r√°pidos ‚Äî mantenha a sua l√≥gica existente === */
/* Garanta que chama render() no fim do init, como abaixo */
(function init(){
  if(!Array.isArray(loadLeads())) saveLeads([]);
  render();
})();
</script>
</body>
</html>
