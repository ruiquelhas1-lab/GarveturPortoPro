<!doctype html>
<html lang="pt">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Garvetur Porto Pro â€” Leads (Kanban)</title>

<link rel="preconnect" href="https://unpkg.com" crossorigin>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js" defer></script>

<style>
:root{ --gold:#A38B63; --bg:#0E0E0E; --panel:#131313; --text:#fff; --muted:#9AA0A6; --border:rgba(255,255,255,.12)}
html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial}
a{color:#eaeaea;text-decoration:none}
.app{display:grid;grid-template-rows:56px auto auto 1fr;height:100%}

/* Header + NavegaÃ§Ã£o */
header{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--border);background:#0F0F0F}
.brand{display:flex;align-items:center;gap:10px}
.brand h1{font-size:16px;margin:0;color:var(--gold)}
.nav{display:flex;gap:8px}
.nav a{border:1px solid var(--border);padding:6px 10px;border-radius:8px;color:#ddd}
.nav a.active{background:var(--gold);color:#111;border-color:var(--gold);font-weight:700}

/* Toolbar */
.toolbar{display:flex;gap:8px;flex-wrap:wrap;padding:8px 12px;border-bottom:1px solid var(--border);background:#0F0F0F}
.btn{background:transparent;border:1px solid rgba(163,139,99,.5);color:#fff;padding:6px 10px;border-radius:10px;cursor:pointer;font-size:12px}
.btn.primary{background:var(--gold);color:#111;border-color:var(--gold);font-weight:700}
.btn.ghost{border-color:var(--border);color:#ddd}
.btn[disabled]{opacity:.45;cursor:not-allowed}
.move-select[disabled]{opacity:.45;cursor:not-allowed}

/* SumÃ¡rio Pipeline */
.summary-bar{padding:6px 12px;font-size:12px;border-bottom:1px solid var(--border);background:#101010;color:#ddd;display:flex;flex-wrap:wrap;gap:8px;align-items:center}
.badge-kpi{padding:2px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.18);font-size:11px}
.badge-kpi.highlight{border-color:var(--gold);color:var(--gold);font-weight:600}

/* Layout Principal */
.main{display:grid;grid-template-columns:300px 1fr;gap:0;height:calc(100vh - 56px - 48px - 32px)}
.sidebar{background:var(--panel);border-right:1px solid var(--border);padding:12px;overflow:auto}
.sidebar h3{margin:0 0 8px 0;font-size:13px;color:#d7d7d7;text-transform:uppercase;letter-spacing:.06em}
.field{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
.field input,.field select{background:#0E0E0E;border:1px solid rgba(255,255,255,.16);border-radius:8px;color:#fff;padding:8px 10px;outline:none;font-size:12px}
.checks{display:flex;flex-direction:column;gap:8px}
.checks label{display:flex;align-items:center;gap:8px;font-size:13px;color:#dcdcdc}
.checks input{accent-color:var(--gold)}

/* Board */
.board{display:grid;grid-template-columns:repeat(6,1fr);gap:10px;padding:10px;height:100%;overflow:auto}
.col{background:var(--panel);border:1px solid var(--border);border-radius:12px;display:flex;flex-direction:column;min-width:240px}
.col header{padding:10px;border-bottom:1px solid rgba(255,255,255,.08);display:flex;align-items:center;justify-content:space-between}
.col header .title{font-weight:700}
.counter{font-size:12px;color:#cfcfcf}
.col .list{padding:10px;display:flex;flex-direction:column;gap:10px}

.card{background:#0E0E0E;border:1px solid rgba(163,139,99,.25);border-radius:12px;padding:10px}
.card .top{display:flex;justify-content:space-between;gap:8px}
.card .name{font-weight:800}
.card .meta{font-size:12px;color:#bbb}
.card .row{margin-top:6px;font-size:12px;color:#ddd}
.card .actions{margin-top:8px;display:flex;gap:6px;flex-wrap:wrap}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--border);font-size:11px}
.badge.light{border-color:#444;color:#ccc}
.move-select{background:#0E0E0E;border:1px solid rgba(255,255,255,.25);color:#ddd;border-radius:8px;padding:4px 6px;font-size:11px}

/* Modal */
.modal-backdrop{display:none;position:fixed;inset:0;z-index:10000;background:rgba(0,0,0,.6);backdrop-filter:blur(2px);align-items:center;justify-content:center;padding:16px}
.modal-backdrop.show{display:flex}
.modal{width:min(980px,96vw);background:#0F0F0F;border:1px solid var(--border);border-radius:12px;overflow:hidden}
.modal header{padding:10px 12px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.modal .content{padding:12px;max-height:72vh;overflow:auto}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.form-field{display:flex;flex-direction:column;gap:6px}
.form-field input,.form-field select,.form-field textarea{background:#0E0E0E;border:1px solid rgba(255,255,255,.16);border-radius:8px;color:#fff;padding:8px 10px;outline:none}
.form-field small{color:#9AA0A6}
.help{font-size:12px;color:#bdbdbd}

/* Estado picker */
.state-pills{display:flex;gap:8px;flex-wrap:wrap}
.state-pill{display:flex;align-items:center;gap:6px;border:1px solid rgba(255,255,255,.18);border-radius:999px;padding:6px 10px;font-size:12px;background:#0E0E0E;cursor:pointer}
.state-pill input{accent-color:#A38B63; width:14px; height:14px}
.state-pill.active{background:#1c1c1c;border-color:#A38B63}

/* Intercalares */
.intercalares{display:flex;flex-direction:column;gap:8px}
.intercalares .row{display:flex;gap:8px;align-items:center}
.intercalares .row input{flex:1}
.intercalares .row button{white-space:nowrap}
.total-line{margin-top:6px;font-size:12px;color:#dcdcdc}

/* Responsive */
@media (max-width:1400px){ .board{grid-template-columns:repeat(3,1fr)} }
@media (max-width:960px){
  .main{grid-template-columns:1fr}
  .sidebar{order:2;height:300px}
  .board{order:1}
}
</style>
</head>
<body>
  <header>
    <div class="brand">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" style="color:var(--gold)"><circle cx="12" cy="12" r="10" stroke-width="1.5"/><path d="M8 12l2.5 2.5L16 9" stroke-width="1.8"/></svg>
      <h1>Garvetur Porto Pro â€” Leads</h1>
    </div>
    <div class="nav">
      <a href="./index.html">Mapa</a>
      <a class="active" href="./kanban.html">Leads</a>
      <a href="./angariacoes.html">AngariaÃ§Ãµes</a>
      <a href="./dashboard.html">Dashboard</a>
    </div>
  </header>

  <div class="toolbar">
    <button class="btn primary" id="btnNew" disabled>+ Nova Lead</button>
    <button class="btn" id="toggleEdit"><span id="lockEmoji">ðŸ”’</span> EdiÃ§Ã£o bloqueada</button>
    <div style="margin-left:auto;display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn" id="exportCsv">Exportar CSV</button>
      <button class="btn" id="exportXlsx">Exportar Excel</button>
    </div>
  </div>

  <!-- SumÃ¡rio pipeline -->
  <div id="pipelineSummary" class="summary-bar"></div>

  <div class="main">
    <!-- Lateral Esquerda -->
    <aside class="sidebar">
      <h3>Pesquisa</h3>
      <div class="field"><input id="q" placeholder="Pesquisar: nome, consultor, email, ref., notas"></div>

      <h3>Filtros</h3>
      <div class="field">
        <label>Consultor</label>
        <select id="f_consultor"><option value="">(Todos)</option></select>
      </div>
      <div class="field">
        <label>Estado</label>
        <select id="f_estado">
          <option value="">(Todos)</option>
          <option>Novo</option>
          <option>Em Contacto</option>
          <option>Qualificado</option>
          <option>Visita</option>
          <option>Proposta</option>
          <option>Fecho</option>
        </select>
      </div>
      <div class="field">
        <label>PerÃ­odo</label>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <input id="f_ini" type="date"><input id="f_fim" type="date">
        </div>
      </div>
      <div class="checks">
        <label><input type="checkbox" id="f_show_hidden"> Mostrar invisÃ­veis</label>
        <label><input type="checkbox" id="f_only_hidden"> SÃ³ invisÃ­veis</label>
      </div>
      <div style="display:flex;gap:8px;margin-top:10px">
        <button class="btn" id="applyFilters">Aplicar</button>
        <button class="btn ghost" id="clearFilters">Limpar</button>
      </div>
    </aside>

    <!-- Quadro Kanban -->
    <section class="board" id="board"></section>
  </div>

  <!-- Modal Nova/Editar Lead -->
  <div id="leadModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-label="Lead">
    <div class="modal">
      <header>
        <div><strong id="modalTitle">Nova Lead</strong></div>
        <div style="display:flex;gap:8px">
          <button class="btn" id="cancelLead">Cancelar</button>
          <button class="btn primary" id="saveLead">Guardar</button>
        </div>
      </header>
      <div class="content">
        <div class="grid2">
          <div class="form-field"><label>Nome Cliente *</label><input id="ld_nome"></div>
          <div class="form-field"><label>Consultor *</label>
            <select id="ld_consultor">
              <option value="">â€”</option>
              <option>Rui Quelhas</option>
              <option>Manuel Oliveira</option>
              <option>JoÃ£o Sousa</option>
              <option>Francisco dos Santos</option>
              <option>RosÃ¡rio Vasconcelos</option>
              <option>Armanda Meireles</option>
              <option>Audrey Lucas</option>
            </select>
          </div>

          <div class="form-field"><label>Contacto *</label><input id="ld_contacto" placeholder="+351 â€¦ ou 9 dÃ­gitos"></div>
          <div class="form-field"><label>Email</label><input id="ld_email" type="email"></div>

          <div class="form-field"><label>Tipo de negÃ³cio</label>
            <select id="ld_tipo_negocio">
              <option value="">â€”</option><option>Venda</option><option>Compra</option><option>Arrendamento</option><option>Permuta</option>
            </select>
          </div>
          <div class="form-field"><label>ImÃ³vel</label>
            <select id="ld_imovel">
              <option value="">â€”</option><option>Moradia</option><option>Apartamento</option><option>Loja</option><option>ArmazÃ©m</option><option>EscritÃ³rio</option><option>Terreno</option><option>Outro</option>
            </select>
          </div>

          <div class="form-field"><label>Tipologia</label>
            <select id="ld_tipologia">
              <option value="">â€”</option><option>T0</option><option>T1</option><option>T2</option><option>T3</option><option>T4</option><option>T5</option><option>&gt;T5</option>
            </select>
          </div>
          <div class="form-field"><label>Zona preferencial</label><input id="ld_zona"></div>

          <div class="form-field"><label>Capitais prÃ³prios (â‚¬)</label><input id="ld_capitais" type="number" min="0" step="1000"></div>
          <div class="form-field"><label>Valor alvo (â‚¬)</label><input id="ld_valor" type="number" min="0" step="1000"></div>

          <div class="form-field"><label>Financiamento bancÃ¡rio?</label>
            <select id="ld_financiamento"><option>NÃ£o</option><option>Sim</option></select>
          </div>
          <div class="form-field"><label>SimulaÃ§Ã£o bancÃ¡ria?</label>
            <select id="ld_simulacao"><option>NÃ£o</option><option>Sim</option></select>
          </div>

          <div class="form-field"><label>InstituiÃ§Ã£o bancÃ¡ria (se aplicÃ¡vel)</label><input id="ld_banco"></div>
          <div class="form-field"><label>Tem imÃ³vel para vender?</label>
            <select id="ld_tem_imovel"><option>NÃ£o</option><option>Sim</option></select>
          </div>

          <div class="form-field"><label>JÃ¡ estÃ¡ Ã  venda?</label>
            <select id="ld_ja_venda"><option>NÃ£o</option><option>Sim</option></select>
          </div>
          <div class="form-field"><label>Urgente?</label>
            <select id="ld_urgente"><option>NÃ£o</option><option>Sim</option></select>
          </div>

          <div class="form-field"><label>Pode comprar em planta?</label>
            <select id="ld_planta"><option>NÃ£o</option><option>Sim</option></select>
          </div>
          <div class="form-field"><label>1Âª habitaÃ§Ã£o?</label>
            <select id="ld_primeira_hab"><option>NÃ£o</option><option>Sim</option></select>
          </div>

          <div class="form-field"><label>Comprador/Vendedor</label>
            <select id="ld_papel"><option value="">â€”</option><option>Comprador</option><option>Vendedor</option></select>
          </div>
          <div class="form-field"><label>Investidor/Cliente final</label>
            <select id="ld_perfil"><option value="">â€”</option><option>Investidor</option><option>Cliente final</option></select>
          </div>

          <div class="form-field"><label>ClassificaÃ§Ã£o (1â€“5)</label>
            <select id="ld_classificacao"><option value="">â€”</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option></select>
          </div>
          <div class="form-field"><label>Ref. Interna</label><input id="ld_ref"></div>

          <div class="form-field"><label>URL anexo</label>
            <input id="ld_url" placeholder="https://â€¦"><small>Ex.: link de documento (Drive/Dropbox/OneDrive).</small>
          </div>
          <div class="form-field"><label>Data</label><input id="ld_data" type="date"></div>

          <div class="form-field" style="grid-column:1 / span 2"><label>Notas</label><textarea id="ld_notas" rows="3"></textarea></div>
        </div>

        <!-- ESTADO (piscos rÃ¡pidos) -->
        <div class="form-field" style="margin-top:6px">
          <label>Estado (seleÃ§Ã£o rÃ¡pida)</label>
          <div class="state-pills" id="ld_estado_picker">
            <label class="state-pill"><input type="checkbox" class="cb_estado" value="Em Contacto"> Em Contacto</label>
            <label class="state-pill"><input type="checkbox" class="cb_estado" value="Qualificado"> Qualificado</label>
            <label class="state-pill"><input type="checkbox" class="cb_estado" value="Visita"> Visita</label>
            <label class="state-pill"><input type="checkbox" class="cb_estado" value="Proposta"> Proposta</label>
            <label class="state-pill"><input type="checkbox" class="cb_estado" value="Fecho"> Fecho</label>
          </div>
          <div class="help">Se selecionar um estado, o cartÃ£o serÃ¡ gravado diretamente nessa coluna. Se nada selecionar, fica em <b>Novo</b>.</div>
        </div>

        <!-- FECHO (ordem pedida) -->
        <div id="fechoBox" class="grid2" style="margin-top:8px; display:none">
          <div class="form-field"><label>Valor do NegÃ³cio (â‚¬)</label><input id="ld_fecho_negocio" type="number" min="0" step="1000"></div>
          <div class="form-field">
            <label>ComissÃ£o</label>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
              <select id="ld_fecho_comissao">
                <option value="">â€”</option>
                <option value="6">6%</option>
                <option value="5">5%</option>
                <option value="4">4%</option>
                <option value="3">3%</option>
                <option value="outro">Outro</option>
              </select>
              <input id="ld_fecho_comissao_outro" placeholder="Ex.: 4.5%" style="display:none">
            </div>
          </div>

          <div class="form-field"><label>Valor Sinal de Reserva (â‚¬)</label><input id="ld_fecho_sinal_reserva" type="number" min="0" step="500"></div>
          <div class="form-field"><label>Valor a dar no CPCV (â‚¬)</label><input id="ld_fecho_valor_cpcv" type="number" min="0" step="1000"></div>

          <div class="form-field" style="grid-column:1 / span 2">
            <label>Valores Intercalares (â‚¬)</label>
            <div id="intercalaresBox" class="intercalares"></div>
            <div class="total-line" id="intercalaresTotal">Total intercalares: 0 â‚¬</div>
            <button class="btn" type="button" id="addIntercalar">+ Adicionar intercalar</button>
          </div>

          <div class="form-field"><label>Valor a dar na Escritura (â‚¬)</label><input id="ld_fecho_valor_escritura" type="number" min="0" step="1000"></div>
          <div class="form-field"><label>Data do CPCV</label><input id="ld_fecho_cpcv_date" type="date"></div>
          <div class="form-field"><label>Data da Escritura</label><input id="ld_fecho_escritura_date" type="date"></div>

          <div class="form-field" style="grid-column:1 / span 2"><label>ObservaÃ§Ãµes</label><textarea id="ld_fecho_obs" rows="3"></textarea></div>
        </div>
      </div>
    </div>
  </div>

<script>
/* ===== Estado ===== */
const LS_KEY='gpp_leads_v5';
const EDIT_LS='gpp_leads_edit_mode';
const COLS=["Novo","Em Contacto","Qualificado","Visita","Proposta","Fecho"];
const CONSULT_RESOLVE=["Rui Quelhas","Manuel Oliveira","JoÃ£o Sousa","Francisco dos Santos","RosÃ¡rio Vasconcelos","Armanda Meireles","Audrey Lucas"];

let LEADS=[]; 
let FILTER={ consultor:'', estado:'', ini:'', fim:'', q:'', showHidden:false, onlyHidden:false };
let PICKED_STATE='';
let INTERCALAres=[];
let EDIT_MODE=false;

const $=id=>document.getElementById(id);
const norm=s=>String(s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');

/* ===== PersistÃªncia ===== */
function loadLS(){ try{ const x=localStorage.getItem(LS_KEY); return x? JSON.parse(x):[];}catch{return[];} }
function saveLS(){ localStorage.setItem(LS_KEY, JSON.stringify(LEADS)); }
function loadPersistedFilters(){
  try{ const raw=localStorage.getItem(LS_KEY+'_filters'); if(!raw) return;
    const f=JSON.parse(raw); FILTER=Object.assign(FILTER,f);
    $('f_consultor').value=FILTER.consultor||'';
    $('f_estado').value=FILTER.estado||'';
    $('f_ini').value=FILTER.ini||'';
    $('f_fim').value=FILTER.fim||'';
    $('q').value=FILTER.q||'';
    $('f_show_hidden').checked=!!FILTER.showHidden;
    $('f_only_hidden').checked=!!FILTER.onlyHidden;
  }catch{}
}
function persistFilters(){ localStorage.setItem(LS_KEY+'_filters', JSON.stringify(FILTER)); }

/* ===== Edit Mode ===== */
function updateEditUI(){
  const btnToggle=$('toggleEdit');
  const btnNew=$('btnNew');
  if(!btnToggle || !btnNew) return;
  if(EDIT_MODE){
    btnToggle.classList.add('primary');
    btnToggle.innerHTML='ðŸ”“ EdiÃ§Ã£o ativa';
    btnNew.disabled=false;
    btnNew.classList.add('primary');
    btnNew.classList.remove('ghost');
  }else{
    btnToggle.classList.remove('primary');
    btnToggle.innerHTML='ðŸ”’ EdiÃ§Ã£o bloqueada';
    btnNew.disabled=true;
    btnNew.classList.remove('primary');
    btnNew.classList.add('ghost');
  }
}
function setEditMode(on){
  EDIT_MODE=!!on;
  localStorage.setItem(EDIT_LS, EDIT_MODE?'1':'0');
  updateEditUI();
  renderBoard(); // para voltar a desenhar os botÃµes desabilitados ou nÃ£o
}

/* ===== Helpers ===== */
function badge(txt){ return `<span class="badge light">${txt||'â€”'}</span>`; }
function fmtDate(d){ if(!d) return 'â€”'; try{ const z=new Date(d); return z.toLocaleDateString('pt-PT'); }catch{return d;} }
function isEmail(e){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(e||'')); }
function isTel(t){ const s=String(t||'').replace(/\s+/g,''); return /^\+?\d{9,15}$/.test(s); }
function isHttp(u){ return /^https?:\/\//i.test(String(u||'')); }
function uid(){ return 'L'+Math.random().toString(36).slice(2,9)+Date.now().toString(36).slice(-4); }
function parsePercent(v){ if(!v) return ''; const s=String(v).replace('%','').replace(',','.'); const n=Number(s); return Number.isFinite(n)? n: ''; }
function sumIntercalares(arr){ return (arr||[]).reduce((a,b)=>a+(Number(b)||0),0); }

/* ===== Lateral ===== */
function buildFilters(){
  const sel=$('f_consultor'); sel.innerHTML='<option value="">(Todos)</option>'+CONSULT_RESOLVE.map(c=>`<option>${c}</option>`).join('');
}
$('applyFilters').addEventListener('click',()=>{
  FILTER.consultor=$('f_consultor').value; FILTER.estado=$('f_estado').value;
  FILTER.ini=$('f_ini').value; FILTER.fim=$('f_fim').value;
  FILTER.q=$('q').value.trim();
  FILTER.showHidden=$('f_show_hidden').checked;
  FILTER.onlyHidden=$('f_only_hidden').checked;
  persistFilters(); renderBoard();
});
$('clearFilters').addEventListener('click',()=>{
  FILTER={consultor:'',estado:'',ini:'',fim:'',q:'',showHidden:false,onlyHidden:false};
  ['f_consultor','f_estado','f_ini','f_fim','q','f_show_hidden','f_only_hidden'].forEach(id=>{
    const el=$(id); if(el.type==='checkbox'){ el.checked=false; } else { el.value=''; }
  });
  persistFilters(); renderBoard();
});

// Pesquisa com debounce
let qTimer=null;
$('q').addEventListener('input',()=>{
  clearTimeout(qTimer);
  qTimer=setTimeout(()=>{ FILTER.q=$('q').value.trim(); persistFilters(); renderBoard(); }, 200);
});

/* ===== Modal ===== */
function resetFechoBox(){
  $('ld_fecho_negocio').value='';
  $('ld_fecho_comissao').value='';
  $('ld_fecho_comissao_outro').value=''; $('ld_fecho_comissao_outro').style.display='none';
  $('ld_fecho_sinal_reserva').value='';
  $('ld_fecho_valor_cpcv').value='';
  $('ld_fecho_valor_escritura').value='';
  $('ld_fecho_cpcv_date').value='';
  $('ld_fecho_escritura_date').value='';
  $('ld_fecho_obs').value='';
  INTERCALAres=[]; drawIntercalares();
  updateIntercalaresTotal();
}
function setFechoBox(show){ $('fechoBox').style.display = show? 'grid':'none'; }
function drawIntercalares(){
  const box=$('intercalaresBox'); box.innerHTML='';
  INTERCALAres.forEach((val,idx)=>{
    const row=document.createElement('div'); row.className='row';
    row.innerHTML=`<input type="number" min="0" step="500" value="${val||''}" data-idx="${idx}"><button class="btn ghost" data-del="${idx}">Remover</button>`;
    row.querySelector('input').addEventListener('input',e=>{
      const i=Number(e.target.dataset.idx); INTERCALAres[i]=e.target.value; updateIntercalaresTotal();
    });
    row.querySelector('button').addEventListener('click',()=>{ INTERCALAres.splice(idx,1); drawIntercalares(); updateIntercalaresTotal(); });
    box.appendChild(row);
  });
}
function updateIntercalaresTotal(){
  $('intercalaresTotal').textContent = 'Total intercalares: ' + sumIntercalares(INTERCALAres).toLocaleString('pt-PT') + ' â‚¬';
}
$('addIntercalar').addEventListener('click',()=>{ INTERCALAres.push(''); drawIntercalares(); updateIntercalaresTotal(); });

$('ld_fecho_comissao').addEventListener('change', (e)=>{
  const isOutro = e.target.value==='outro';
  const input=$('ld_fecho_comissao_outro');
  input.style.display = isOutro? 'block':'none';
  if(!isOutro) input.value='';
});

function initStatePicker(){
  PICKED_STATE='';
  document.querySelectorAll('.cb_estado').forEach(cb=>{
    cb.checked=false;
    cb.closest('.state-pill')?.classList.remove('active');
    cb.addEventListener('change', e=>{
      document.querySelectorAll('.cb_estado').forEach(x=>{
        if(x!==cb){ x.checked=false; x.closest('.state-pill')?.classList.remove('active'); }
      });
      if(cb.checked){
        PICKED_STATE=cb.value;
        cb.closest('.state-pill')?.classList.add('active');
      }else{ PICKED_STATE=''; }
      setFechoBox(PICKED_STATE==='Fecho');
    });
  });
}

function openModal(edit=null){
  if(!EDIT_MODE){
    alert('Modo de ediÃ§Ã£o bloqueado. Clique em "ðŸ”“ EdiÃ§Ã£o ativa" para poder criar/editar leads.');
    return;
  }
  $('modalTitle').textContent = edit? 'Editar Lead' : 'Nova Lead';
  const f = (id,val='') => $(id).value = (val??'');
  const v = edit||{};
  f('ld_nome', v.nome);
  f('ld_consultor', v.consultor||'');
  f('ld_contacto', v.contacto);
  f('ld_email', v.email);
  f('ld_tipo_negocio', v.tipo_negocio);
  f('ld_imovel', v.imovel);
  f('ld_tipologia', v.tipologia);
  f('ld_zona', v.zona);
  f('ld_capitais', v.capitais);
  f('ld_valor', v.valor);
  f('ld_financiamento', v.financiamento||'NÃ£o');
  f('ld_simulacao', v.simulacao||'NÃ£o');
  f('ld_banco', v.banco);
  f('ld_tem_imovel', v.tem_imovel||'NÃ£o');
  f('ld_ja_venda', v.ja_venda||'NÃ£o');
  f('ld_urgente', v.urgente||'NÃ£o');
  f('ld_planta', v.planta||'NÃ£o');
  f('ld_primeira_hab', v.primeira_hab||'NÃ£o');
  f('ld_papel', v.papel||'');
  f('ld_perfil', v.perfil||'');
  f('ld_classificacao', v.classificacao||'');
  f('ld_ref', v.ref_interna||'');
  f('ld_url', v.url||'');
  f('ld_data', v.data||new Date().toISOString().slice(0,10));
  f('ld_notas', v.notas||'');

  initStatePicker();
  if(edit && COLS.includes(edit.estado) && edit.estado!=='Novo'){
    const sel = Array.from(document.querySelectorAll('.cb_estado')).find(x=>x.value===edit.estado);
    if(sel){ sel.checked=true; sel.dispatchEvent(new Event('change')); }
  } else { setFechoBox(false); }

  resetFechoBox();
  if(edit && edit.estado==='Fecho'){
    $('ld_fecho_negocio').value = edit.fecho_negocio || '';
    if(edit.fecho_comissao_pct!=='' && edit.fecho_comissao_pct!=null){
      const known=['6','5','4','3'];
      const s=String(edit.fecho_comissao_pct);
      if(known.includes(s)){ $('ld_fecho_comissao').value=s; }
      else{ $('ld_fecho_comissao').value='outro'; $('ld_fecho_comissao_outro').style.display='block'; $('ld_fecho_comissao_outro').value=s+'%'; }
    }
    $('ld_fecho_sinal_reserva').value = edit.fecho_sinal_reserva || '';
    $('ld_fecho_valor_cpcv').value = edit.fecho_valor_cpcv || '';
    INTERCALAres = Array.isArray(edit.fecho_intercalares)? [...edit.fecho_intercalares] : [];
    drawIntercalares(); updateIntercalaresTotal();
    $('ld_fecho_valor_escritura').value = edit.fecho_valor_escritura || '';
    $('ld_fecho_cpcv_date').value = edit.fecho_cpcv_date || '';
    $('ld_fecho_escritura_date').value = edit.fecho_escritura_date || '';
    $('ld_fecho_obs').value = edit.fecho_obs || '';
  }

  $('leadModal').classList.add('show');
}
$('cancelLead').addEventListener('click',()=> $('leadModal').classList.remove('show'));
$('btnNew').addEventListener('click',()=> openModal());

$('saveLead').addEventListener('click',()=>{
  if(!EDIT_MODE){
    alert('Modo de ediÃ§Ã£o bloqueado. Clique em "ðŸ”“ EdiÃ§Ã£o ativa" para guardar alteraÃ§Ãµes.');
    return;
  }
  const get=id=>$(id).value.trim();
  const estadoFinal = PICKED_STATE || $('saveLead').dataset.editEstado || 'Novo';

  let comissaoPct = '';
  if(estadoFinal==='Fecho'){
    const cSel = $('ld_fecho_comissao').value;
    if(cSel==='outro'){ comissaoPct = parsePercent($('ld_fecho_comissao_outro').value); }
    else if(cSel){ comissaoPct = Number(cSel); }
  }

  const lead={
    id: $('saveLead').dataset.editId || uid(),
    estado: estadoFinal,
    nome: get('ld_nome'),
    consultor: get('ld_consultor'),
    contacto: get('ld_contacto'),
    email: get('ld_email'),
    tipo_negocio: get('ld_tipo_negocio'),
    imovel: get('ld_imovel'),
    tipologia: get('ld_tipologia'),
    zona: get('ld_zona'),
    capitais: get('ld_capitais'),
    valor: get('ld_valor'),
    financiamento: get('ld_financiamento'),
    simulacao: get('ld_simulacao'),
    banco: get('ld_banco'),
    tem_imovel: get('ld_tem_imovel'),
    ja_venda: get('ld_ja_venda'),
    urgente: get('ld_urgente'),
    planta: get('ld_planta'),
    primeira_hab: get('ld_primeira_hab'),
    papel: get('ld_papel'),
    perfil: get('ld_perfil'),
    classificacao: get('ld_classificacao'),
    ref_interna: get('ld_ref'),
    url: get('ld_url'),
    data: get('ld_data'),
    notas: get('ld_notas'),
    visivel: (typeof $('saveLead').dataset.editId==='string') ? undefined : true,

    fecho_negocio: estadoFinal==='Fecho' ? get('ld_fecho_negocio') : '',
    fecho_comissao_pct: estadoFinal==='Fecho' ? comissaoPct : '',
    fecho_sinal_reserva: estadoFinal==='Fecho' ? get('ld_fecho_sinal_reserva') : '',
    fecho_valor_cpcv: estadoFinal==='Fecho' ? get('ld_fecho_valor_cpcv') : '',
    fecho_intercalares: estadoFinal==='Fecho' ? [...INTERCALAres] : [],
    fecho_valor_escritura: estadoFinal==='Fecho' ? get('ld_fecho_valor_escritura') : '',
    fecho_cpcv_date: estadoFinal==='Fecho' ? get('ld_fecho_cpcv_date') : '',
    fecho_escritura_date: estadoFinal==='Fecho' ? get('ld_fecho_escritura_date') : '',
    fecho_obs: estadoFinal==='Fecho' ? get('ld_fecho_obs') : ''
  };

  if(lead.visivel===undefined) lead.visivel=true;

  if(!lead.nome){ alert('Indique o Nome do Cliente.'); return; }
  if(!lead.contacto && !lead.email){ alert('Indique pelo menos Contacto ou Email.'); return; }
  if(lead.email && !isEmail(lead.email)){ alert('Email invÃ¡lido.'); return; }
  if(lead.contacto && !isTel(lead.contacto)){ alert('Contacto invÃ¡lido.'); return; }
  if(lead.url && !isHttp(lead.url)){ alert('URL anexo invÃ¡lido (deve comeÃ§ar por http/https).'); return; }

  const idx=LEADS.findIndex(l=>l.id===lead.id);
  if(idx>=0) LEADS[idx]=Object.assign(LEADS[idx], lead);
  else LEADS.push(lead);

  saveLS();
  $('leadModal').classList.remove('show');
  $('saveLead').dataset.editId=''; $('saveLead').dataset.editEstado='';
  renderBoard();
});

/* ===== Render ===== */
function colTemplate(name,count){
  return `<div class="col" data-col="${name}">
    <header><span class="title">${name}</span><span class="counter">${count}</span></header>
    <div class="list" id="col_${name.replace(/\s/g,'_')}"></div>
  </div>`;
}
function fechoSummary(l){
  const parts=[];
  if(l.fecho_negocio) parts.push(`NegÃ³cio: ${Number(l.fecho_negocio).toLocaleString('pt-PT')}â‚¬`);
  if(l.fecho_comissao_pct!=='' && l.fecho_comissao_pct!=null) parts.push(`ComissÃ£o: ${l.fecho_comissao_pct}%`);
  if(l.fecho_sinal_reserva) parts.push(`Sinal: ${Number(l.fecho_sinal_reserva).toLocaleString('pt-PT')}â‚¬`);
  if(l.fecho_valor_cpcv) parts.push(`CPCV: ${Number(l.fecho_valor_cpcv).toLocaleString('pt-PT')}â‚¬`);
  if(Array.isArray(l.fecho_intercalares) && l.fecho_intercalares.length){
    const soma = sumIntercalares(l.fecho_intercalares);
    parts.push(`Interc.: ${soma.toLocaleString('pt-PT')}â‚¬`);
  }
  if(l.fecho_valor_escritura) parts.push(`Escritura: ${Number(l.fecho_valor_escritura).toLocaleString('pt-PT')}â‚¬`);
  if(l.fecho_cpcv_date) parts.push(`CPCV em ${fmtDate(l.fecho_cpcv_date)}`);
  if(l.fecho_escritura_date) parts.push(`Escritura em ${fmtDate(l.fecho_escritura_date)}`);
  return parts.join(' Â· ');
}

function renderSummary(byEstado){
  const el = $('pipelineSummary');
  const total = byEstado.reduce((s,b)=>s+b.items.length,0);
  if(!total){
    el.textContent='Sem leads registadas nos filtros atuais.';
    return;
  }
  const counts = Object.fromEntries(byEstado.map(b=>[b.estado,b.items.length]));
  const fecho = counts['Fecho'] || 0;
  const taxaFecho = total ? (fecho/total*100).toFixed(1) : '0.0';

  el.innerHTML = `
    <span class="badge-kpi">Total: ${total}</span>
    <span class="badge-kpi">Novo: ${counts['Novo']||0}</span>
    <span class="badge-kpi">Em Contacto: ${counts['Em Contacto']||0}</span>
    <span class="badge-kpi">Qualificado: ${counts['Qualificado']||0}</span>
    <span class="badge-kpi">Visita: ${counts['Visita']||0}</span>
    <span class="badge-kpi">Proposta: ${counts['Proposta']||0}</span>
    <span class="badge-kpi">Fecho: ${fecho}</span>
    <span class="badge-kpi highlight">Taxa de Fecho: ${taxaFecho}%</span>
  `;
}

function renderBoard(){
  const board=$('board'); board.innerHTML='';

  const term = norm(FILTER.q||'');
  const byEstado = COLS.map(col=>{
    let arr=LEADS.filter(l=>l.estado===col);

    if(term){
      arr=arr.filter(l=>{
        const blob = [l.nome,l.consultor,l.email,l.ref_interna,l.notas].map(x=>norm(x)).join(' ');
        return blob.includes(term);
      });
    }
    if(FILTER.consultor) arr=arr.filter(l=>l.consultor===FILTER.consultor);
    if(FILTER.estado) arr=arr.filter(l=>l.estado===FILTER.estado);
    if(FILTER.ini) arr=arr.filter(l=>!l.data || l.data>=FILTER.ini);
    if(FILTER.fim) arr=arr.filter(l=>!l.data || l.data<=FILTER.fim);
    if(!FILTER.showHidden && !FILTER.onlyHidden) arr=arr.filter(l=>l.visivel!==false);
    if(FILTER.onlyHidden) arr=arr.filter(l=>l.visivel===false);

    return {estado:col, items:arr};
  });

  byEstado.forEach(b=>{
    board.insertAdjacentHTML('beforeend', colTemplate(b.estado,b.items.length));
    const list=$('col_'+b.estado.replace(/\s/g,'_'));
    b.items.forEach(lead=>{
      const card=document.createElement('div'); card.className='card';

      const moveOptions = COLS.map(c=>`<option value="${c}" ${c===lead.estado?'disabled':''}>${c}</option>`).join('');

      const disabledAttr = EDIT_MODE ? '' : 'disabled';

      card.innerHTML=`
        <div class="top">
          <div>
            <div class="name">${lead.nome||'â€”'}</div>
            <div class="meta">${lead.consultor||'â€”'} ${lead.ref_interna? ' Â· '+badge('Ref: '+lead.ref_interna):''}</div>
          </div>
          <div>${lead.classificacao? badge('â˜… '+lead.classificacao): ''}</div>
        </div>
        <div class="row"><b>Contacto:</b> ${lead.contacto||'â€”'}</div>
        <div class="row"><b>Email:</b> ${lead.email||'â€”'}</div>
        <div class="row"><b>Tipo:</b> ${lead.tipo_negocio||'â€”'} Â· <b>ImÃ³vel:</b> ${lead.imovel||'â€”'} Â· <b>Tipologia:</b> ${lead.tipologia||'â€”'}</div>
        <div class="row"><b>Zona:</b> ${lead.zona||'â€”'} Â· <b>Valor:</b> ${lead.valor? Number(lead.valor).toLocaleString('pt-PT'): 'â€”'}</div>
        <div class="row"><b>Data:</b> ${fmtDate(lead.data)} ${lead.url? ' Â· <a href="'+lead.url+'" target="_blank" rel="noreferrer">URL</a>':''}</div>
        ${lead.estado==='Fecho' ? `<div class="row">${fechoSummary(lead)}</div>` : ''}
        <div class="actions">
          <button class="btn" data-act="edit" ${disabledAttr}>Editar</button>
          <button class="btn" data-act="dup" ${disabledAttr}>Duplicar</button>
          <select class="move-select" data-id="${lead.id}" ${disabledAttr}>
            <option value="">Moverâ€¦</option>
            ${moveOptions}
          </select>
          <button class="btn" style="border-color:#cc4b4b;color:#ffdddd" data-act="del" ${disabledAttr}>Apagar</button>
          <button class="btn" data-act="toggle" ${disabledAttr}>${lead.visivel!==false?'Tornar invisÃ­vel':'Tornar visÃ­vel'}</button>
        </div>
      `;
      // AÃ§Ãµes
      card.querySelector('[data-act="edit"]').addEventListener('click',()=>{
        if(!EDIT_MODE){ alert('Modo de ediÃ§Ã£o bloqueado. Ative "ðŸ”“ EdiÃ§Ã£o ativa" para editar.'); return; }
        $('saveLead').dataset.editId = lead.id;
        $('saveLead').dataset.editEstado = lead.estado;
        openModal(lead);
      });
      card.querySelector('[data-act="dup"]').addEventListener('click',()=>{
        if(!EDIT_MODE){ alert('Modo de ediÃ§Ã£o bloqueado. Ative "ðŸ”“ EdiÃ§Ã£o ativa" para duplicar.'); return; }
        const copy=Object.assign({},lead,{ id:uid(), ref_interna:(lead.ref_interna? lead.ref_interna+'-copy':''), data:new Date().toISOString().slice(0,10) });
        LEADS.push(copy); saveLS(); renderBoard();
      });

      const selMove = card.querySelector('.move-select');
      selMove.addEventListener('change', e=>{
        if(!EDIT_MODE){ e.target.value=''; alert('Modo de ediÃ§Ã£o bloqueado. Ative "ðŸ”“ EdiÃ§Ã£o ativa" para mover.'); return; }
        const target = e.target.value;
        if(!target || !COLS.includes(target)) return;
        lead.estado = target;
        saveLS(); renderBoard();
      });

      card.querySelector('[data-act="del"]').addEventListener('click',()=>{
        if(!EDIT_MODE){ alert('Modo de ediÃ§Ã£o bloqueado. Ative "ðŸ”“ EdiÃ§Ã£o ativa" para apagar.'); return; }
        if(!confirm('Eliminar esta lead?')) return;
        LEADS=LEADS.filter(x=>x.id!==lead.id); saveLS(); renderBoard();
      });
      card.querySelector('[data-act="toggle"]').addEventListener('click',()=>{
        if(!EDIT_MODE){ alert('Modo de ediÃ§Ã£o bloqueado. Ative "ðŸ”“ EdiÃ§Ã£o ativa" para alterar visibilidade.'); return; }
        lead.visivel = lead.visivel===false ? true : false;
        saveLS(); renderBoard();
      });

      if(lead.visivel===false) card.style.opacity=.45;
      list.appendChild(card);
    });
  });

  // atualizar contadores
  Array.from(document.querySelectorAll('.col')).forEach(col=>{
    const name=col.getAttribute('data-col');
    const count=byEstado.find(x=>x.estado===name)?.items.length||0;
    col.querySelector('.counter').textContent=count;
  });

  // sumÃ¡rio topo
  renderSummary(byEstado);
}

/* ===== ExportaÃ§Ã£o ===== */
function filterForExport(arr){
  let out=[...arr];
  const term = norm(FILTER.q||'');
  if(term){
    out=out.filter(l=>{
      const blob=[l.nome,l.consultor,l.email,l.ref_interna,l.notas].map(x=>norm(x)).join(' ');
      return blob.includes(term);
    });
  }
  if(FILTER.consultor) out=out.filter(l=>l.consultor===FILTER.consultor);
  if(FILTER.estado) out=out.filter(l=>l.estado===FILTER.estado);
  if(FILTER.ini) out=out.filter(l=>!l.data || l.data>=FILTER.ini);
  if(FILTER.fim) out=out.filter(l=>!l.data || l.data<=FILTER.fim);
  if(FILTER.onlyHidden) out=out.filter(l=>l.visivel===false);
  if(!FILTER.showHidden && !FILTER.onlyHidden) out=out.filter(l=>l.visivel!==false);
  return out;
}
function toCSV(rows){ return rows.map(r=>r.map(v=>`"${String(v??'').replaceAll('"','""')}"`).join(',')).join('\n'); }

$('exportCsv').addEventListener('click',()=>{
  const headers=["ID","Estado","Data","Consultor","Nome","Contacto","Email","TipoNegÃ³cio","ImÃ³vel","Tipologia","Zona","Capitais","Valor","Financiamento","SimulaÃ§Ã£o","Banco","Comprador/Vend.","Perfil","ClassificaÃ§Ã£o","RefInterna","URL","Urgente","Planta","1ÂªHab","TemImÃ³vel","JÃ¡Venda","Notas","VisÃ­vel","NegÃ³cio","ComissÃ£o(%)","SinalReserva","ValorCPCV","Intercalares","ValorEscritura","DataCPCV","DataEscritura","FechoObs"];
  const rows = filterForExport(LEADS).map(l=>[
    l.id,l.estado,l.data||'',l.consultor||'',l.nome||'',l.contacto||'',l.email||'',
    l.tipo_negocio||'',l.imovel||'',l.tipologia||'',l.zona||'',l.capitais||'',l.valor||'',
    l.financiamento||'',l.simulacao||'',l.banco||'',l.papel||'',l.perfil||'',
    l.classificacao||'',l.ref_interna||'',l.url||'',l.urgente||'',l.planta||'',l.primeira_hab||'',
    l.tem_imovel||'',l.ja_venda||'',l.notas||'', (l.visivel!==false?'Sim':'NÃ£o'),
    l.fecho_negocio||'', (l.fecho_comissao_pct!==''&&l.fecho_comissao_pct!=null? l.fecho_comissao_pct : ''),
    l.fecho_sinal_reserva||'', l.fecho_valor_cpcv||'',
    (Array.isArray(l.fecho_intercalares)? l.fecho_intercalares.join(' | ') : ''),
    l.fecho_valor_escritura||'', l.fecho_cpcv_date||'', l.fecho_escritura_date||'', l.fecho_obs||''
  ]);
  const csv=toCSV([headers,...rows]);
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='leads.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});

$('exportXlsx').addEventListener('click',()=>{
  const data = filterForExport(LEADS).map(l=>({
    ID:l.id, Estado:l.estado, Data:l.data||'', Consultor:l.consultor||'', Nome:l.nome||'',
    Contacto:l.contacto||'', Email:l.email||'', TipoNegÃ³cio:l.tipo_negocio||'',
    ImÃ³vel:l.imovel||'', Tipologia:l.tipologia||'', Zona:l.zona||'',
    Capitais:+(l.capitais||0), Valor:+(l.valor||0), Financiamento:l.financiamento||'',
    SimulaÃ§Ã£o:l.simulacao||'', Banco:l.banco||'', "Comprador/Vend.":l.papel||'',
    Perfil:l.perfil||'', ClassificaÃ§Ã£o:l.classificacao||'', "Ref. Interna":l.ref_interna||'',
    URL:l.url||'', Urgente:l.urgente||'', Planta:l.planta||'', "1Âª Hab.":l.primeira_hab||'',
    "Tem ImÃ³vel":l.tem_imovel||'', "JÃ¡ Ã  venda":l.ja_venda||'', Notas:l.notas||'',
    VisÃ­vel:(l.visivel!==false?'Sim':'NÃ£o'),
    NegÃ³cio:+(l.fecho_negocio||0),
    "ComissÃ£o(%)":(l.fecho_comissao_pct!==''&&l.fecho_comissao_pct!=null? +l.fecho_comissao_pct : ''),
    SinalReserva:+(l.fecho_sinal_reserva||0),
    ValorCPCV:+(l.fecho_valor_cpcv||0),
    Intercalares:(Array.isArray(l.fecho_intercalares)? l.fecho_intercalares.join(' | ') : ''),
    ValorEscritura:+(l.fecho_valor_escritura||0),
    DataCPCV:l.fecho_cpcv_date||'',
    DataEscritura:l.fecho_escritura_date||'',
    FechoObs:l.fecho_obs||''
  }));
  const ws=XLSX.utils.json_to_sheet(data);
  const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Leads');
  XLSX.writeFile(wb, 'leads.xlsx');
});

/* ===== Boot ===== */
(function init(){
  LEADS = loadLS();
  buildFilters();
  loadPersistedFilters();

  // carregar estado de ediÃ§Ã£o (por defeito bloqueado)
  const stored = localStorage.getItem(EDIT_LS);
  EDIT_MODE = stored==='1';
  updateEditUI();

  // botÃ£o alternar ediÃ§Ã£o
  $('toggleEdit').addEventListener('click',()=>{
    setEditMode(!EDIT_MODE);
  });

  renderBoard();
})();
</script>
</body>
</html>
