<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Garvetur Porto Pro — Leads</title>
<style>
  :root{
    --gold:#A38B63; --bg:#0E0E0E; --panel:#131313; --text:#fff; --muted:#A9AFB7;
    --ok:#2ecc71; --warn:#FFC107; --bad:#EF5350; --line:rgba(255,255,255,.08);
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  header{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--line);background:#0F0F0F;position:sticky;top:0;z-index:10}
  nav a{margin-right:6px;text-decoration:none;color:#ddd;border:1px solid var(--line);padding:6px 10px;border-radius:8px}
  nav a.active{background:var(--gold);color:#111;border-color:var(--gold);font-weight:600}
  .btn{background:transparent;border:1px solid rgba(163,139,99,.5);color:#fff;padding:6px 10px;border-radius:10px;cursor:pointer;font-size:12px}
  .btn.primary{background:var(--gold);color:#111;border-color:var(--gold);font-weight:700}
  .btn.ghost{border-color:var(--line);color:#ddd}
  .layout{display:grid;grid-template-columns:320px 1fr;gap:0;height:calc(100vh - 52px)}
  /* ====== SIDEBAR ====== */
  .sidebar{background:var(--panel);border-right:1px solid var(--line);position:relative;display:flex;flex-direction:column}
  .side-scroll{padding:12px;overflow:auto;flex:1}
  .side-title{font-size:12px;color:#cfcfcf;text-transform:uppercase;letter-spacing:.05em;margin:8px 0 6px}
  .group{border:1px solid var(--line);border-radius:12px;padding:10px;background:#0F0F0F;margin-bottom:10px}
  .label{font-size:12px;color:#d6d6d6;margin:0 0 6px}
  .field{display:flex;gap:8px}
  .field input,.field select{flex:1;background:#0E0E0E;border:1px solid rgba(255,255,255,.15);border-radius:10px;padding:8px 10px;color:#fff;outline:none}
  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chip{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.16);background:#0E0E0E;color:#ddd;cursor:pointer}
  .chip.active{background:var(--gold);color:#111;border-color:var(--gold);font-weight:700}
  .help{font-size:11px;color:var(--muted);margin-top:6px}
  /* ====== DOCK DE FILTROS (FIXO AO FUNDO) ====== */
  .filters-dock{
    position:sticky; bottom:0; background:linear-gradient(180deg, rgba(19,19,19,.85) 0%, rgba(19,19,19,1) 24%);
    border-top:1px solid var(--line); padding:10px; display:grid; gap:8px; z-index:5
  }
  .dock-grid{display:grid;grid-template-columns:1fr 1fr; gap:8px}
  .dock-row{display:grid;grid-template-columns:1fr 1fr 1fr; gap:8px}
  .dock-actions{display:flex;gap:8px}
  .badge{display:inline-flex;align-items:center;gap:6px;background:#0E0E0E;border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-size:12px;color:#ddd}
  .badge .dot{width:10px;height:10px;border-radius:50%;border:1px solid var(--line);display:inline-block}
  /* ====== BOARD ====== */
  .board{overflow:auto;padding:12px}
  .cols{display:grid;grid-template-columns:repeat(6,1fr);gap:12px;min-width:1100px}
  .col{background:var(--panel);border:1px solid var(--line);border-radius:14px;display:flex;flex-direction:column;max-height:100%}
  .col-head{padding:10px 12px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between}
  .col-title{font-size:12px;letter-spacing:.05em;text-transform:uppercase;color:#eee}
  .count{font-size:11px;color:#bbb}
  .col-body{padding:10px;overflow:auto;display:grid;gap:10px}
  .card{background:#0D0D0D;border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:10px}
  .card .name{font-weight:700;margin-bottom:4px}
  .card .meta{font-size:12px;color:#cfcfcf}
  .card .tags{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
  .tag{font-size:10px;padding:4px 6px;border-radius:999px;border:1px solid rgba(255,255,255,.14);color:#ddd}
  .ghost-drop{border:1px dashed rgba(255,255,255,.18);border-radius:10px;padding:12px;text-align:center;color:#9aa0a6}
  /* cores colunas */
  .c-novo .col-head{background:#101010}
  .c-cont .col-head{background:#17130d}
  .c-qual .col-head{background:#0f1410}
  .c-vis .col-head{background:#0f1218}
  .c-prop .col-head{background:#171309}
  .c-fecho .col-head{background:#0f140f}
  /* responsivo */
  @media(max-width:1200px){ .layout{grid-template-columns:1fr} .cols{min-width:900px} }
</style>
</head>
<body>
<header>
  <div style="display:flex;align-items:center;gap:10px;">
    <strong style="color:#FFD166">Garvetur Porto Pro</strong>
    <nav>
      <a href="./index.html">Mapa</a>
      <a class="active" href="./kanban.html">Leads</a>
      <a href="./angariacoes.html">Angariações</a>
      <a href="./dashboard.html">Dashboard</a>
    </nav>
  </div>
  <div style="display:flex;gap:8px">
    <button id="addLead" class="btn primary">+ Nova lead</button>
    <button id="exportLeads" class="btn">Exportar CSV</button>
  </div>
</header>

<div class="layout">
  <!-- ================= Sidebar ================ -->
  <aside class="sidebar">
    <div class="side-scroll" id="sideScroll">
      <div class="side-title">Pesquisa</div>
      <div class="group">
        <div class="label">Texto livre</div>
        <div class="field"><input id="q_text" placeholder="Cliente, imóvel, zona, notas..." /></div>
        <div class="help">Filtra por múltiplos campos (cliente, zona, imóvel, notas).</div>
      </div>

      <div class="side-title">Filtros principais</div>
      <div class="group">
        <div class="label">Consultor</div>
        <div class="field">
          <select id="f_consultor">
            <option value="">(Todos)</option>
            <option>Rui Quelhas</option>
            <option>Manuel Oliveira</option>
            <option>João Sousa</option>
            <option>Francisco dos Santos</option>
            <option>Rosário Vasconcelos</option>
            <option>Armanda Meireles</option>
            <option>Audrey Lucas</option>
          </select>
        </div>
        <div class="label" style="margin-top:8px">Origem</div>
        <div class="field">
          <select id="f_origem">
            <option value="">(Todas)</option>
            <option>Promotor</option>
            <option>Referência</option>
            <option>Digital</option>
            <option>Walk-in</option>
            <option>Outro</option>
            <option>Indefinido</option>
          </select>
        </div>
      </div>

      <div class="side-title">Rápidos</div>
      <div class="group">
        <div class="chips" id="chips_quick">
          <div class="chip" data-q="7">Últimos 7d</div>
          <div class="chip" data-q="30">Últimos 30d</div>
          <div class="chip" data-q="90">Últimos 90d</div>
          <div class="chip" data-q="ytd">YTD</div>
        </div>
        <div class="dock-grid" style="margin-top:8px">
          <div>
            <div class="label">De</div>
            <input type="date" id="f_de">
          </div>
          <div>
            <div class="label">Até</div>
            <input type="date" id="f_ate">
          </div>
        </div>
      </div>

      <div class="side-title">Estado & sinalizações</div>
      <div class="group">
        <div class="chips" id="chips_estado">
          <div class="chip active" data-stage="">Todos</div>
          <div class="chip" data-stage="novo">Novo</div>
          <div class="chip" data-stage="em_contacto">Em Contacto</div>
          <div class="chip" data-stage="qualificado">Qualificado</div>
          <div class="chip" data-stage="visita">Visita</div>
          <div class="chip" data-stage="proposta">Proposta</div>
          <div class="chip" data-stage="fecho">Fecho</div>
        </div>
        <div class="help">Use para destacar apenas uma etapa, mantendo o quadro intacto.</div>
      </div>

      <div class="side-title">Perfil & capacidade</div>
      <div class="group">
        <div class="dock-grid">
          <div>
            <div class="label">Tipo de cliente</div>
            <select id="f_tipo">
              <option value="">(Todos)</option>
              <option value="comprador">Comprador</option>
              <option value="vendedor">Vendedor</option>
            </select>
          </div>
          <div>
            <div class="label">Perfil</div>
            <select id="f_perfil">
              <option value="">(Todos)</option>
              <option value="investidor">Investidor</option>
              <option value="cliente_final">Cliente final</option>
            </select>
          </div>
        </div>
        <div class="dock-row" style="margin-top:8px">
          <div>
            <div class="label">Capitais próprios (mín.)</div>
            <input id="f_cap_min" type="number" inputmode="decimal" placeholder="€">
          </div>
          <div>
            <div class="label">Financiamento bancário</div>
            <select id="f_fb">
              <option value="">(Todos)</option>
              <option value="sim">Sim</option>
              <option value="nao">Não</option>
            </select>
          </div>
          <div>
            <div class="label">Com visitas</div>
            <select id="f_visitas">
              <option value="">(Todas)</option>
              <option value="sim">Sim</option>
              <option value="nao">Não</option>
            </select>
          </div>
        </div>
      </div>

      <div class="side-title">Resumo</div>
      <div class="group" id="summaryBox">
        <div class="badge"><span class="dot" style="background:#9E9E9E"></span>Novo: <b id="s_n">0</b></div>
        <div class="badge"><span class="dot" style="background:#A38B63"></span>Em Contacto: <b id="s_c">0</b></div>
        <div class="badge"><span class="dot" style="background:#2ecc71"></span>Qualificado: <b id="s_q">0</b></div>
        <div class="badge"><span class="dot" style="background:#4285F4"></span>Visita: <b id="s_v">0</b></div>
        <div class="badge"><span class="dot" style="background:#FFC107"></span>Proposta: <b id="s_p">0</b></div>
        <div class="badge"><span class="dot" style="background:#4CAF50"></span>Fecho: <b id="s_f">0</b></div>
      </div>
    </div>

    <!-- ===== DOCK FIXO AO FUNDO ===== -->
    <div class="filters-dock">
      <div class="dock-grid">
        <div>
          <div class="label">Zona</div>
          <input id="f_zona" placeholder="Ex.: Boavista, Foz, Gaia…">
        </div>
        <div>
          <div class="label">Imóvel</div>
          <input id="f_imovel" placeholder="Ex.: T2, Moradia, Lote…">
        </div>
      </div>
      <div class="dock-actions">
        <button id="applyFilters" class="btn primary" title="Aplicar filtros">Aplicar</button>
        <button id="clearFilters" class="btn ghost" title="Limpar filtros">Limpar</button>
      </div>
    </div>
  </aside>

  <!-- ================= Board ================ -->
  <main class="board">
    <div class="cols">
      <section class="col c-novo" data-col="novo">
        <div class="col-head"><div class="col-title">Novo</div><div class="count" id="cnt_n">0</div></div>
        <div class="col-body" id="col_n"></div>
      </section>
      <section class="col c-cont" data-col="em_contacto">
        <div class="col-head"><div class="col-title">Em Contacto</div><div class="count" id="cnt_c">0</div></div>
        <div class="col-body" id="col_c"></div>
      </section>
      <section class="col c-qual" data-col="qualificado">
        <div class="col-head"><div class="col-title">Qualificado</div><div class="count" id="cnt_q">0</div></div>
        <div class="col-body" id="col_q"></div>
      </section>
      <section class="col c-vis" data-col="visita">
        <div class="col-head"><div class="col-title">Visita</div><div class="count" id="cnt_v">0</div></div>
        <div class="col-body" id="col_v"></div>
      </section>
      <section class="col c-prop" data-col="proposta">
        <div class="col-head"><div class="col-title">Proposta</div><div class="count" id="cnt_p">0</div></div>
        <div class="col-body" id="col_p"></div>
      </section>
      <section class="col c-fecho" data-col="fecho">
        <div class="col-head"><div class="col-title">Fecho</div><div class="count" id="cnt_f">0</div></div>
        <div class="col-body" id="col_f"></div>
      </section>
    </div>
  </main>
</div>

<script>
/* ======= STORAGE KEYS ======= */
const LS_LEADS='gpp_leads_v3';

/* ======= ESTADO DE FILTRO ======= */
let F = {
  q:'', consultor:'', origem:'', de:'', ate:'',
  stage:'', tipo:'', perfil:'', capMin:'', fb:'', visitas:'',
  zona:'', imovel:''
};

/* ======= UTIL ======= */
const $ = sel => document.querySelector(sel);
const el = id => document.getElementById(id);
const txt = v => (v==null || v==='') ? '' : String(v).toLowerCase();
const money = n => isFinite(n) ? Number(n).toLocaleString('pt-PT',{style:'currency',currency:'EUR'}) : '—';
function loadLeads(){ try{ return JSON.parse(localStorage.getItem(LS_LEADS)||'[]'); }catch(e){ return []; } }
function saveLeads(arr){ localStorage.setItem(LS_LEADS, JSON.stringify(arr)); }
function dateIn(iso,d1,d2){
  if(!iso) return true;
  const t=Date.parse(iso);
  const ok1 = !d1 || t >= Date.parse(d1+'T00:00:00');
  const ok2 = !d2 || t <= Date.parse(d2+'T23:59:59');
  return ok1 && ok2;
}

/* ======= UI: popular campos rápidos ======= */
(function initDefaultDates(){
  const today = new Date().toISOString().slice(0,10);
  const d30 = new Date(); d30.setDate(d30.getDate()-30);
  el('f_de').value = d30.toISOString().slice(0,10);
  el('f_ate').value = today;
})();

/* ======= EVENTOS: chips rápidos ======= */
document.querySelectorAll('#chips_quick .chip').forEach(ch=>{
  ch.addEventListener('click', ()=>{
    document.querySelectorAll('#chips_quick .chip').forEach(c=>c.classList.remove('active'));
    ch.classList.add('active');
    const mode = ch.dataset.q;
    const today = new Date(); const y=today.getFullYear();
    if(mode==='ytd'){ el('f_de').value = `${y}-01-01`; el('f_ate').value = ''; }
    else{
      const n = parseInt(mode,10);
      const d = new Date(); d.setDate(d.getDate()-n);
      el('f_de').value = d.toISOString().slice(0,10);
      el('f_ate').value = today.toISOString().slice(0,10);
    }
  });
});

/* ======= EVENTOS: chips de estado ======= */
document.querySelectorAll('#chips_estado .chip').forEach(ch=>{
  ch.addEventListener('click', ()=>{
    document.querySelectorAll('#chips_estado .chip').forEach(c=>c.classList.remove('active'));
    ch.classList.add('active');
    F.stage = ch.dataset.stage || '';
    render();
  });
});

/* ======= DOCK: aplicar / limpar ======= */
el('applyFilters').addEventListener('click', ()=>{
  F.q = el('q_text').value.trim();
  F.consultor = el('f_consultor').value;
  F.origem = el('f_origem').value;
  F.de = el('f_de').value; F.ate = el('f_ate').value;
  F.tipo = el('f_tipo').value;
  F.perfil = el('f_perfil').value;
  F.capMin = el('f_cap_min').value;
  F.fb = el('f_fb').value;
  F.visitas = el('f_visitas').value;
  F.zona = el('f_zona').value.trim();
  F.imovel = el('f_imovel').value.trim();
  render();
});
el('clearFilters').addEventListener('click', ()=>{
  document.querySelectorAll('.sidebar input, .sidebar select').forEach(i=>{ if(i.type==='date'){ i.value=''; } else { i.value=''; } });
  document.querySelectorAll('#chips_estado .chip').forEach(c=>c.classList.remove('active'));
  document.querySelector('#chips_estado .chip[data-stage=""]').classList.add('active');
  document.querySelectorAll('#chips_quick .chip').forEach(c=>c.classList.remove('active'));
  F = { q:'', consultor:'', origem:'', de:'', ate:'', stage:'', tipo:'', perfil:'', capMin:'', fb:'', visitas:'', zona:'', imovel:'' };
  render();
});

/* ======= CRIAR CARTÃO ======= */
function cardHTML(l){
  const tg = [];
  if(l.origem) tg.push(l.origem);
  if(l.tipo_cli) tg.push(l.tipo_cli);
  if(l.perfil) tg.push(l.perfil);
  const v = isFinite(l.val) ? money(l.val) : '—';
  return `
    <div class="card" draggable="true" data-id="${l.id}">
      <div class="name">${l.cliente || '—'}</div>
      <div class="meta">${l.zona || '—'} • ${l.consultor || '—'} • ${v}</div>
      <div class="tags">${tg.map(t=>`<span class="tag">${t}</span>`).join('')}</div>
    </div>
  `;
}

/* ======= RENDER ======= */
function applyFilter(l){
  // texto livre
  const q = txt(F.q);
  if(q){
    const blob = [l.cliente,l.imovel,l.zona,l.notas].map(x=>txt(x)).join(' ');
    if(!blob.includes(q)) return false;
  }
  // simples
  if(F.consultor && l.consultor!==F.consultor) return false;
  if(F.origem && String(l.origem||'')!==F.origem) return false;
  if(F.stage && (l.stage||'')!==F.stage) return false;
  if(F.tipo && String(l.tipo_cli||'')!==F.tipo) return false;
  if(F.perfil && String(l.perfil||'')!==F.perfil) return false;
  if(F.fb && String(l.fin_banc||'')!==F.fb) return false;
  if(F.visitas){
    const yes = (String(F.visitas)==='sim');
    const ok = String(l.visitas||'').toLowerCase()==='sim';
    if(yes && !ok) return false;
    if(!yes && ok) return false;
  }
  if(F.capMin){
    const cap = Number(l.capitais||l.capitais_proprios);
    if(isFinite(cap) && cap < Number(F.capMin)) return false;
  }
  if(F.zona && !String(l.zona||'').toLowerCase().includes(F.zona.toLowerCase())) return false;
  if(F.imovel && !String(l.imovel||'').toLowerCase().includes(F.imovel.toLowerCase())) return false;
  // datas
  if(!dateIn(l.createdAt, F.de, F.ate)) return false;
  return true;
}

function render(){
  const all = loadLeads();

  // distribuir por colunas com filtro aplicado
  const buckets = {novo:[], em_contacto:[], qualificado:[], visita:[], proposta:[], fecho:[]};
  const counts = {n:0,c:0,q:0,v:0,p:0,f:0};

  all.forEach(l=>{
    if(!applyFilter(l)) return;
    const s = (l.stage||'novo');
    if(!buckets[s]) buckets[s]=[];
    buckets[s].push(l);
  });

  // render por coluna
  el('col_n').innerHTML = buckets.novo.map(cardHTML).join('') || '<div class="ghost-drop">Sem registos…</div>';
  el('col_c').innerHTML = buckets.em_contacto.map(cardHTML).join('') || '<div class="ghost-drop">Sem registos…</div>';
  el('col_q').innerHTML = buckets.qualificado.map(cardHTML).join('') || '<div class="ghost-drop">Sem registos…</div>';
  el('col_v').innerHTML = buckets.visita.map(cardHTML).join('') || '<div class="ghost-drop">Sem registos…</div>';
  el('col_p').innerHTML = buckets.proposta.map(cardHTML).join('') || '<div class="ghost-drop">Sem registos…</div>';
  el('col_f').innerHTML = buckets.fecho.map(cardHTML).join('') || '<div class="ghost-drop">Sem registos…</div>';

  // contagens topo das colunas
  counts.n = buckets.novo.length; counts.c = buckets.em_contacto.length; counts.q = buckets.qualificado.length;
  counts.v = buckets.visita.length; counts.p = buckets.proposta.length; counts.f = buckets.fecho.length;
  el('cnt_n').textContent = counts.n; el('cnt_c').textContent = counts.c; el('cnt_q').textContent = counts.q;
  el('cnt_v').textContent = counts.v; el('cnt_p').textContent = counts.p; el('cnt_f').textContent = counts.f;

  // resumo (badges)
  el('s_n').textContent = counts.n; el('s_c').textContent = counts.c; el('s_q').textContent = counts.q;
  el('s_v').textContent = counts.v; el('s_p').textContent = counts.p; el('s_f').textContent = counts.f;

  // reativar drag
  attachDrag();
}

/* ======= DRAG & DROP ======= */
function attachDrag(){
  document.querySelectorAll('.card').forEach(card=>{
    card.addEventListener('dragstart', e=>{
      e.dataTransfer.setData('text/plain', card.dataset.id);
      e.dataTransfer.effectAllowed='move';
    });
  });
  document.querySelectorAll('.col-body').forEach(zone=>{
    zone.addEventListener('dragover', e=>{ e.preventDefault(); e.dataTransfer.dropEffect='move'; });
    zone.addEventListener('drop', e=>{
      e.preventDefault();
      const id = e.dataTransfer.getData('text/plain');
      moveLeadToColumn(id, zone.closest('.col').dataset.col);
    });
  });
}
function moveLeadToColumn(id, stage){
  const arr = loadLeads();
  const i = arr.findIndex(l=>String(l.id)===String(id));
  if(i>=0){ arr[i].stage = stage; arr[i].updatedAt = new Date().toISOString(); saveLeads(arr); render(); }
}

/* ======= NOVA LEAD (exemplo mínimo) ======= */
el('addLead').addEventListener('click', ()=>{
  const arr = loadLeads();
  const id = Date.now();
  arr.push({
    id, cliente:'Novo Cliente', consultor:'Rui Quelhas', origem:'Indefinido',
    zona:'Porto', imovel:'T2', val:250000, tipo_cli:'comprador', perfil:'cliente_final',
    capitais:50000, fin_banc:'sim', visitas:'nao',
    stage:'novo', createdAt:new Date().toISOString(), updatedAt:new Date().toISOString()
  });
  saveLeads(arr); render();
});

/* ======= EXPORT CSV ======= */
el('exportLeads').addEventListener('click', ()=>{
  const arr = loadLeads().filter(applyFilter);
  const headers = ["ID","Cliente","Consultor","Origem","Zona","Imóvel","Valor","Tipo","Perfil","Capitais","Fin.B.","Visitas","Estado","Criado em"];
  const rows = arr.map(l=>[
    l.id, l.cliente||'', l.consultor||'', l.origem||'', l.zona||'', l.imovel||'',
    isFinite(l.val)? l.val : '', l.tipo_cli||'', l.perfil||'',
    l.capitais||'', l.fin_banc||'', l.visitas||'', l.stage||'', l.createdAt||''
  ]);
  const csv = [headers, ...rows].map(r=>r.map(v=>`"${String(v??'').replaceAll('"','""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob); const a = document.createElement('a');
  a.href=url; a.download='leads_filtradas.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});

/* ======= INIT ======= */
(function init(){
  // garantir estrutura mínima no LS
  if(!Array.isArray(loadLeads())) saveLeads([]);
  render();
})();
</script>
</body>
</html>
