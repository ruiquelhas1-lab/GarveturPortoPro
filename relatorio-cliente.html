<!doctype html>
<html lang="pt-PT">
<head>
  <meta charset="utf-8" />
  <title>Garvetur Porto Pro — Relatório para Cliente (Admin)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      --gold:#A38B63;
      --gold-soft:rgba(163,139,99,.35);
      --bg:#0B0B0B;
      --panel:#121212;
      --panel-soft:#181818;
      --text:#FFFFFF;
      --muted:#A0A0A0;
      --border:rgba(255,255,255,.14);
      --danger:#E53935;
      --success:#43A047;
      --info:#1E88E5;

      --radius-lg:18px;
      --radius-md:12px;
      --shadow:0 18px 34px rgba(0,0,0,.55);
    }

    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;background:radial-gradient(circle at top,#1c1c1c 0,#050505 55%,#000 100%);color:var(--text)}
    a{color:inherit}
    .hidden{display:none !important}

    /* Shell */
    .app{
      display:grid;
      grid-template-rows:64px 1fr;
      height:100%;
      overflow:hidden;
    }

    header.app-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 16px;
      border-bottom:1px solid rgba(163,139,99,.35);
      background:linear-gradient(90deg,#050505,#111,#050505);
      position:sticky;top:0;z-index:20;
      gap:12px;
      flex-wrap:wrap;
    }
    .brand{
      display:flex;align-items:center;gap:10px;
    }
    .brand-icon{
      width:30px;height:30px;border-radius:999px;border:1px solid var(--gold);
      display:flex;align-items:center;justify-content:center;
      box-shadow:0 0 0 1px rgba(163,139,99,.35);
    }
    .brand h1{margin:0;font-size:16px;letter-spacing:.08em;text-transform:uppercase;color:var(--gold)}
    .brand .sub{display:block;font-size:11px;color:var(--muted);letter-spacing:.14em;text-transform:uppercase;margin-top:2px}

    .header-actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .badge{
      font-size:11px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(163,139,99,.45);
      color:var(--muted);
      letter-spacing:.12em;
      text-transform:uppercase;
      background:rgba(0,0,0,.35);
      white-space:nowrap;
    }
    .btn{
      border-radius:999px;
      border:1px solid var(--gold-soft);
      background:rgba(12,12,12,.92);
      color:var(--text);
      padding:8px 12px;
      font-size:13px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      cursor:pointer;
      transition:.18s border-color,.18s transform,.18s background;
      text-decoration:none;
      user-select:none;
    }
    .btn:hover{border-color:var(--gold);transform:translateY(-1px)}
    .btn.primary{background:var(--gold);color:#0A0A0A;border-color:var(--gold);font-weight:700}
    .btn.secondary{border-color:rgba(255,255,255,.18);color:var(--muted);background:transparent}

    /* Layout */
    .layout{
      display:grid;
      grid-template-columns:320px minmax(0,1fr);
      height:100%;
      overflow:hidden;
    }
    @media (max-width: 980px){
      .layout{grid-template-columns:1fr;grid-template-rows:auto 1fr}
    }

    /* Sidebar */
    aside.sidebar{
      border-right:1px solid rgba(163,139,99,.24);
      background:radial-gradient(circle at top left,#141414,#060606);
      padding:12px 12px;
      overflow:auto;
    }
    .side-card{
      background:rgba(0,0,0,.45);
      border:1px solid rgba(163,139,99,.18);
      border-radius:var(--radius-md);
      padding:10px 10px;
      margin-bottom:10px;
      box-shadow:0 12px 22px rgba(0,0,0,.35);
    }
    .side-card h3{
      margin:0 0 8px;
      font-size:11px;
      color:var(--muted);
      letter-spacing:.16em;
      text-transform:uppercase;
    }
    .field{display:flex;flex-direction:column;gap:5px;margin-bottom:10px}
    .field label{
      font-size:11px;color:var(--muted);letter-spacing:.12em;text-transform:uppercase
    }
    .input, select, textarea{
      width:100%;
      background:rgba(0,0,0,.70);
      color:var(--text);
      border:1px solid rgba(163,139,99,.22);
      border-radius:10px;
      padding:8px 10px;
      outline:none;
      font-size:13px;
    }
    textarea{min-height:84px;resize:vertical}
    .input:focus, select:focus, textarea:focus{
      border-color:var(--gold);
      box-shadow:0 0 0 1px rgba(163,139,99,.35);
    }
    .checks{display:flex;flex-direction:column;gap:8px;margin-top:6px}
    .checks label{display:flex;gap:8px;align-items:flex-start;font-size:12px;color:var(--muted);line-height:1.35}
    .checks input{accent-color:var(--gold);margin-top:2px}

    .hint{font-size:11px;color:var(--muted);line-height:1.45}
    .divider{height:1px;background:rgba(255,255,255,.10);margin:10px 0}

    /* Main */
    main.main{
      padding:14px 16px 18px;
      overflow:auto;
      background:radial-gradient(circle at top,#1a1a1a,#050505 55%,#000 100%);
    }
    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }
    .topbar h2{
      margin:0;
      font-size:14px;
      letter-spacing:.16em;
      text-transform:uppercase;
      color:var(--muted);
    }
    .topbar p{margin:2px 0 0;font-size:12px;color:var(--muted);line-height:1.45;max-width:920px}

    .panel{
      border-radius:var(--radius-lg);
      border:1px solid rgba(163,139,99,.24);
      background:rgba(3,3,3,.88);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .panel-head{
      padding:10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid rgba(255,255,255,.10);
      background:linear-gradient(90deg,#050505,#111,#050505);
      gap:10px;
      flex-wrap:wrap;
    }
    .panel-head .title{
      display:flex;align-items:center;gap:10px;
      font-weight:800;letter-spacing:.08em;text-transform:uppercase;font-size:12px;color:var(--gold);
    }
    .panel-body{padding:12px 12px 12px}
    .panel-foot{
      padding:10px 12px;
      border-top:1px solid rgba(255,255,255,.10);
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      background:rgba(0,0,0,.35);
    }

    /* Tabs (Lista vs Wizard) */
    .tabs{
      display:flex;gap:6px;flex-wrap:wrap;align-items:center;
    }
    .tab{
      border-radius:999px;
      padding:6px 10px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.35);
      font-size:12px;
      color:var(--muted);
      cursor:pointer;
      user-select:none;
    }
    .tab.active{
      border-color:var(--gold);
      color:#0A0A0A;
      background:var(--gold);
      font-weight:800;
    }

    /* Table list */
    .table-wrap{overflow:auto}
    table{
      width:100%;
      border-collapse:collapse;
      min-width:860px;
    }
    th,td{
      padding:10px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      vertical-align:top;
    }
    th{
      position:sticky;top:0;
      background:rgba(0,0,0,.55);
      color:var(--muted);
      font-size:11px;
      letter-spacing:.12em;
      text-transform:uppercase;
      z-index:2;
    }
    td{font-size:13px;color:#e9e9e9}
    .td-sub{display:block;font-size:11px;color:var(--muted);margin-top:2px}
    .pill{
      display:inline-flex;
      align-items:center;
      padding:4px 9px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      font-size:11px;
      letter-spacing:.10em;
      text-transform:uppercase;
      color:var(--muted);
      background:rgba(0,0,0,.35);
      white-space:nowrap;
    }
    .pill.ok{border-color:rgba(67,160,71,.55);color:#A5D6A7}
    .pill.warn{border-color:rgba(229,57,53,.55);color:#ffb4b4}
    .pill.info{border-color:rgba(30,136,229,.55);color:#bbdefb}
    .row-actions{display:flex;gap:6px;flex-wrap:wrap}

    .btn-xs{
      border-radius:999px;
      padding:6px 10px;
      border:1px solid rgba(163,139,99,.60);
      background:rgba(0,0,0,.70);
      color:var(--gold);
      font-size:11px;
      text-decoration:none;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      transition:.18s border-color,.18s transform,.18s background;
      user-select:none;
    }
    .btn-xs:hover{transform:translateY(-1px);border-color:var(--gold)}
    .btn-xs.primary{background:var(--gold);color:#0A0A0A;border-color:var(--gold);font-weight:800}
    .btn-xs.ghost{border-color:rgba(255,255,255,.16);color:var(--muted);background:transparent}

    /* Wizard */
    .wizard{
      display:grid;
      grid-template-columns:260px minmax(0,1fr);
      gap:12px;
      align-items:start;
    }
    @media (max-width: 980px){
      .wizard{grid-template-columns:1fr}
    }

    .steps{
      border-radius:var(--radius-lg);
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.35);
      padding:10px 10px;
      position:sticky;
      top:84px;
    }
    @media (max-width: 980px){
      .steps{position:relative;top:auto}
    }
    .steps h4{
      margin:0 0 8px;
      font-size:11px;
      color:var(--muted);
      letter-spacing:.16em;
      text-transform:uppercase;
    }
    .step{
      display:flex;gap:10px;align-items:flex-start;
      padding:8px 8px;
      border-radius:12px;
      border:1px solid transparent;
      cursor:pointer;
    }
    .step:hover{border-color:rgba(163,139,99,.22);background:rgba(163,139,99,.08)}
    .step.active{border-color:rgba(163,139,99,.45);background:rgba(163,139,99,.12)}
    .step .n{
      width:24px;height:24px;border-radius:999px;
      display:flex;align-items:center;justify-content:center;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.45);
      color:var(--muted);
      font-size:12px;
      flex-shrink:0;
    }
    .step.active .n{background:var(--gold);border-color:var(--gold);color:#0A0A0A;font-weight:900}
    .step .t{
      font-size:12px;color:#f0f0f0;font-weight:700;
      line-height:1.2;
    }
    .step .s{
      display:block;margin-top:2px;
      font-size:11px;color:var(--muted);font-weight:500;
      line-height:1.25;
    }

    .step-panel{
      border-radius:var(--radius-lg);
      border:1px solid rgba(163,139,99,.24);
      background:rgba(3,3,3,.88);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .step-head{
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;
      background:linear-gradient(90deg,#050505,#111,#050505);
    }
    .step-head .left{
      display:flex;flex-direction:column;gap:2px;
    }
    .step-head .kicker{
      font-size:11px;color:var(--muted);letter-spacing:.14em;text-transform:uppercase;
    }
    .step-head .name{
      font-size:13px;color:var(--gold);font-weight:900;letter-spacing:.06em;text-transform:uppercase;
    }
    .step-body{padding:12px 12px}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width: 980px){.grid-2{grid-template-columns:1fr}}
    .grid-3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}
    @media (max-width: 980px){.grid-3{grid-template-columns:1fr}}

    .radio-row, .toggle-row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .radio{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.35);
      border-radius:12px;
      padding:8px 10px;
      display:flex;gap:8px;align-items:flex-start;
      cursor:pointer;
      min-width:220px;
      flex:1;
    }
    .radio input{accent-color:var(--gold);margin-top:2px}
    .radio .rt{font-size:12px;font-weight:800;color:#f0f0f0}
    .radio .rs{font-size:11px;color:var(--muted);margin-top:2px;line-height:1.3}

    .section-title{
      margin:12px 0 6px;
      font-size:11px;
      color:var(--muted);
      letter-spacing:.16em;
      text-transform:uppercase;
    }

    /* Upload */
    .drop{
      border:1px dashed rgba(163,139,99,.55);
      background:rgba(163,139,99,.08);
      border-radius:16px;
      padding:12px 12px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .drop .d-left{max-width:720px}
    .drop .d-title{font-weight:900;letter-spacing:.06em;text-transform:uppercase;color:#f5f5f5;font-size:12px;margin:0 0 4px}
    .drop .d-sub{margin:0;font-size:12px;color:var(--muted);line-height:1.45}
    .drop .d-actions{display:flex;gap:8px;flex-wrap:wrap}

    /* Attachments list */
    .files{
      margin-top:10px;
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      overflow:hidden;
      background:rgba(0,0,0,.35);
    }
    .file{
      display:flex;justify-content:space-between;gap:10px;align-items:flex-start;
      padding:10px 10px;border-bottom:1px solid rgba(255,255,255,.08);
    }
    .file:last-child{border-bottom:none}
    .file .f-name{font-weight:800}
    .file .f-meta{font-size:11px;color:var(--muted);margin-top:2px}
    .file .f-actions{display:flex;gap:6px;flex-wrap:wrap}

    /* Analysis cards */
    .analysis{
      margin-top:10px;
      display:grid;
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:10px;
    }
    @media (max-width: 980px){.analysis{grid-template-columns:1fr}}
    .mini-card{
      border-radius:16px;
      border:1px solid rgba(163,139,99,.22);
      background:rgba(0,0,0,.35);
      padding:10px 10px;
    }
    .mini-card h5{
      margin:0 0 6px;
      font-size:11px;
      color:var(--muted);
      letter-spacing:.14em;
      text-transform:uppercase;
    }
    .kv{display:flex;justify-content:space-between;gap:10px;padding:4px 0;border-bottom:1px solid rgba(255,255,255,.06)}
    .kv:last-child{border-bottom:none}
    .kv span{font-size:12px;color:#e9e9e9}
    .kv b{font-size:12px;color:var(--muted);font-weight:700}

    /* Report builder */
    .switches{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:8px;
      margin-top:8px;
    }
    @media (max-width: 980px){.switches{grid-template-columns:1fr}}
    .sw{
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      background:rgba(0,0,0,.35);
      padding:10px 10px;
      display:flex;justify-content:space-between;gap:10px;align-items:center;
    }
    .sw .l{display:flex;flex-direction:column;gap:2px}
    .sw .l b{font-size:12px;color:#f5f5f5}
    .sw .l span{font-size:11px;color:var(--muted);line-height:1.3}
    .sw input{accent-color:var(--gold);transform:scale(1.05)}

    .cta-row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .status{
      font-size:11px;
      color:var(--muted);
      display:flex;gap:8px;align-items:center;flex-wrap:wrap;
    }
    .dot{width:10px;height:10px;border-radius:999px;background:rgba(255,255,255,.22);border:1px solid rgba(0,0,0,.25)}
    .dot.ok{background:rgba(67,160,71,.9)}
    .dot.warn{background:rgba(229,57,53,.9)}
    .dot.info{background:rgba(30,136,229,.9)}
  </style>
</head>

<body>
  <div class="app">
    <header class="app-header">
      <div class="brand">
        <div class="brand-icon">
          <svg width="18" height="18" viewBox="0 0 24 24" stroke="var(--gold)" fill="none" stroke-width="1.8">
            <circle cx="12" cy="12" r="9"></circle>
            <path d="M8 12.5l2.5 2.5L16 9"></path>
          </svg>
        </div>
        <div>
          <h1>Relatório para Cliente</h1>
          <span class="sub">Admin · PDF + Personalização + Exportação</span>
        </div>
      </div>

      <div class="header-actions">
        <span class="badge">Privado</span>
        <a class="btn secondary" href="./admin.html">Voltar ao Admin</a>
        <button class="btn primary" id="btnNew">+ Novo Relatório</button>
      </div>
    </header>

    <div class="layout">
      <!-- SIDEBAR -->
      <aside class="sidebar">
        <div class="side-card">
          <h3>Pesquisa & Filtros</h3>

          <div class="field">
            <label for="q">Pesquisa</label>
            <input class="input" id="q" type="text" placeholder="Cliente, zona, objetivo, estado…" />
          </div>

          <div class="field">
            <label for="fStatus">Estado</label>
            <select id="fStatus">
              <option value="">Todos</option>
              <option value="draft">Rascunho</option>
              <option value="final">Final</option>
              <option value="sent">Enviado</option>
            </select>
          </div>

          <div class="field">
            <label for="fTipo">Tipo de cliente</label>
            <select id="fTipo">
              <option value="">Todos</option>
              <option>Proprietário</option>
              <option>Investidor</option>
              <option>Promotor</option>
              <option>Comprador</option>
            </select>
          </div>

          <div class="field">
            <label for="fDataDe">Data (de / até)</label>
            <div style="display:flex;gap:6px">
              <input class="input" id="fDataDe" type="date" />
              <input class="input" id="fDataAte" type="date" />
            </div>
          </div>

          <div class="divider"></div>

          <div class="checks">
            <label><input type="checkbox" id="fConfidencial" /> Apenas confidenciais</label>
          </div>

          <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
            <button class="btn" id="btnApply">Aplicar</button>
            <button class="btn secondary" id="btnClear">Limpar</button>
          </div>

          <div class="divider"></div>
          <div class="hint">
            Este módulo cria relatórios prontos para decisão: <strong>executivo</strong> (1–2 páginas) ou <strong>completo</strong> (4–8+),
            com anexos PDF e narrativa orientada ao cliente.
          </div>
        </div>

        <div class="side-card">
          <h3>Estado do módulo</h3>
          <div class="status">
            <span class="dot ok"></span><span>UI pronta (layout)</span>
          </div>
          <div class="status" style="margin-top:8px">
            <span class="dot info"></span><span>Hooks JS por IDs (próximo passo)</span>
          </div>
          <div class="status" style="margin-top:8px">
            <span class="dot warn"></span><span>Extração PDF/Exportação (a implementar)</span>
          </div>
        </div>
      </aside>

      <!-- MAIN -->
      <main class="main">
        <div class="topbar">
          <div>
            <h2>Relatórios</h2>
            <p>Gestão central de relatórios personalizados. Pode importar estudos genéricos em PDF, extrair insights e gerar um PDF final com recomendação e plano de ação.</p>
          </div>

          <div class="tabs" aria-label="Vistas">
            <div class="tab active" id="tabList">Lista</div>
            <div class="tab" id="tabWizard">Novo / Editar</div>
          </div>
        </div>

        <!-- LISTA -->
        <section class="panel" id="viewList">
          <div class="panel-head">
            <div class="title">
              <span style="display:inline-flex;width:26px;height:26px;border-radius:999px;border:1px solid var(--gold);align-items:center;justify-content:center;">
                <svg width="16" height="16" viewBox="0 0 24 24" stroke="var(--gold)" fill="none" stroke-width="1.8">
                  <path d="M7 7h10M7 12h10M7 17h10" />
                </svg>
              </span>
              <span>Lista de relatórios</span>
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn secondary" id="btnImportTemplate">Templates</button>
              <button class="btn" id="btnExportAll">Exportações</button>
            </div>
          </div>

          <div class="panel-body">
            <div class="table-wrap">
              <table aria-label="Relatórios">
                <thead>
                  <tr>
                    <th style="min-width:260px">Cliente</th>
                    <th style="min-width:220px">Objetivo / Ativo</th>
                    <th style="min-width:160px">Data</th>
                    <th style="min-width:150px">Estado</th>
                    <th style="min-width:280px">Ações</th>
                  </tr>
                </thead>
                <tbody id="reportsTbody">
                  <!-- Exemplo (placeholder) -->
                  <tr>
                    <td>
                      <div><strong>Exemplo — Cliente</strong></div>
                      <span class="td-sub">Investidor · Idioma PT · Executivo</span>
                    </td>
                    <td>
                      <div><strong>Investir</strong></div>
                      <span class="td-sub">Zona: Foz · Tipologia: T2/T3</span>
                    </td>
                    <td>
                      <div><strong>20/12/2025</strong></div>
                      <span class="td-sub">Atualizado: 20/12/2025</span>
                    </td>
                    <td>
                      <span class="pill info">Rascunho</span>
                      <span class="td-sub">Confidencial: Sim</span>
                    </td>
                    <td>
                      <div class="row-actions">
                        <button class="btn-xs primary" data-act="open">Abrir</button>
                        <button class="btn-xs" data-act="duplicate">Duplicar</button>
                        <button class="btn-xs" data-act="export">Exportar PDF</button>
                        <button class="btn-xs ghost" data-act="delete">Remover</button>
                      </div>
                    </td>
                  </tr>
                  <!-- /placeholder -->
                </tbody>
              </table>
            </div>

            <div class="hint" style="margin-top:10px">
              Nota: nesta fase o layout já está pronto. No próximo passo ligamos esta lista ao storage (localStorage/IndexedDB) e à geração PDF.
            </div>
          </div>

          <div class="panel-foot">
            <div class="hint">Dica operacional: use “Duplicar” para criar variações (executivo vs completo) sem recomeçar do zero.</div>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn" id="btnGoWizard">Criar novo</button>
            </div>
          </div>
        </section>

        <!-- WIZARD -->
        <section class="wizard hidden" id="viewWizard">
          <!-- Steps -->
          <div class="steps">
            <h4>Passos</h4>

            <div class="step active" data-step="1">
              <div class="n">1</div>
              <div>
                <div class="t">Cliente</div>
                <span class="s">Identificação e formato</span>
              </div>
            </div>

            <div class="step" data-step="2">
              <div class="n">2</div>
              <div>
                <div class="t">Objetivo</div>
                <span class="s">Risco, horizonte e preocupações</span>
              </div>
            </div>

            <div class="step" data-step="3">
              <div class="n">3</div>
              <div>
                <div class="t">Ativo / Zona</div>
                <span class="s">Imóvel específico ou análise de zona</span>
              </div>
            </div>

            <div class="step" data-step="4">
              <div class="n">4</div>
              <div>
                <div class="t">PDF & Análise</div>
                <span class="s">Importar estudo e extrair insights</span>
              </div>
            </div>

            <div class="step" data-step="5">
              <div class="n">5</div>
              <div>
                <div class="t">Relatório</div>
                <span class="s">Estrutura, tom e exportação</span>
              </div>
            </div>

            <div class="divider"></div>

            <div class="hint">
              Para manter consistência premium, o relatório final é construído por secções (ativar/desativar),
              com <strong>recomendação</strong> e <strong>próximos passos</strong>.
            </div>
          </div>

          <!-- Step panel -->
          <div class="step-panel">
            <div class="step-head">
              <div class="left">
                <div class="kicker">Novo relatório</div>
                <div class="name" id="stepTitle">Passo 1 — Identificação do Cliente</div>
              </div>
              <div style="display:flex;gap:8px;flex-wrap:wrap">
                <button class="btn secondary" id="btnBackToList">Voltar à lista</button>
                <button class="btn" id="btnSaveDraft">Guardar rascunho</button>
              </div>
            </div>

            <div class="step-body">

              <!-- STEP 1 -->
              <div id="step1">
                <div class="grid-2">
                  <div class="field">
                    <label for="cTipo">Tipo de Cliente</label>
                    <select id="cTipo">
                      <option value="">(Selecionar)</option>
                      <option>Proprietário</option>
                      <option>Investidor</option>
                      <option>Promotor</option>
                      <option>Comprador</option>
                    </select>
                  </div>

                  <div class="field">
                    <label for="cNome">Nome do Cliente / Empresa</label>
                    <input class="input" id="cNome" type="text" placeholder="Ex.: Family Office X / Sr. Manuel Silva" />
                  </div>

                  <div class="field">
                    <label for="cTel">Contacto</label>
                    <input class="input" id="cTel" type="text" placeholder="Telefone" />
                  </div>

                  <div class="field">
                    <label for="cEmail">Email</label>
                    <input class="input" id="cEmail" type="text" placeholder="email@cliente.com" />
                  </div>
                </div>

                <div class="grid-3">
                  <div class="field">
                    <label for="cIdioma">Idioma do relatório</label>
                    <select id="cIdioma">
                      <option value="pt">Português (PT)</option>
                      <option value="en">English</option>
                    </select>
                  </div>

                  <div class="field">
                    <label for="cDetalhe">Nível de detalhe</label>
                    <select id="cDetalhe">
                      <option value="exec">Executivo (1–2 páginas)</option>
                      <option value="full">Completo (4–8 páginas)</option>
                    </select>
                  </div>

                  <div class="field">
                    <label for="cConf">Confidencial</label>
                    <select id="cConf">
                      <option value="no">Não</option>
                      <option value="yes">Sim</option>
                    </select>
                  </div>
                </div>

                <div class="field">
                  <label for="cNotas">Notas internas</label>
                  <textarea id="cNotas" placeholder="Briefing do cliente, contexto, pontos críticos…"></textarea>
                </div>
              </div>

              <!-- STEP 2 -->
              <div id="step2" class="hidden">
                <div class="grid-2">
                  <div class="field">
                    <label for="oObjetivo">Objetivo principal</label>
                    <select id="oObjetivo">
                      <option value="">(Selecionar)</option>
                      <option>Vender</option>
                      <option>Investir</option>
                      <option>Avaliar</option>
                      <option>Reposicionar</option>
                      <option>Timing</option>
                    </select>
                  </div>

                  <div class="field">
                    <label for="oHorizonte">Horizonte temporal</label>
                    <select id="oHorizonte">
                      <option value="">(Selecionar)</option>
                      <option>0–30 dias</option>
                      <option>30–90 dias</option>
                      <option>3–6 meses</option>
                      <option>6–12 meses</option>
                      <option>&gt;12 meses</option>
                    </select>
                  </div>
                </div>

                <div class="grid-2">
                  <div class="field">
                    <label for="oRisco">Perfil de risco</label>
                    <select id="oRisco">
                      <option value="">(Selecionar)</option>
                      <option>Conservador</option>
                      <option>Equilibrado</option>
                      <option>Agressivo</option>
                    </select>
                  </div>

                  <div class="field">
                    <label for="oPreocup">Preocupações (multi)</label>
                    <select id="oPreocup" multiple style="min-height:120px">
                      <option>Liquidez</option>
                      <option>Maximizar preço</option>
                      <option>Risco fiscal</option>
                      <option>Obras</option>
                      <option>Inquilino</option>
                      <option>Segurança jurídica</option>
                      <option>Prazo</option>
                      <option>Financiamento</option>
                    </select>
                    <div class="hint" style="margin-top:6px">CTRL/⌘ para selecionar múltiplas opções.</div>
                  </div>
                </div>

                <div class="field">
                  <label for="oBrief">Notas do briefing</label>
                  <textarea id="oBrief" placeholder="O que o cliente quer realmente decidir? Quais as barreiras/receios?"></textarea>
                </div>
              </div>

              <!-- STEP 3 -->
              <div id="step3" class="hidden">
                <div class="section-title">Tipo de relatório</div>
                <div class="radio-row">
                  <label class="radio">
                    <input type="radio" name="assetMode" value="imovel" checked />
                    <div>
                      <div class="rt">Imóvel específico</div>
                      <div class="rs">Selecionar um ativo concreto (Mapa/Angariações/FSBO/Manual).</div>
                    </div>
                  </label>

                  <label class="radio">
                    <input type="radio" name="assetMode" value="zona" />
                    <div>
                      <div class="rt">Zona / Tipologia</div>
                      <div class="rs">Análise por zona, segmento e intervalo de preço.</div>
                    </div>
                  </label>
                </div>

                <div id="assetImovel" style="margin-top:10px">
                  <div class="grid-2">
                    <div class="field">
                      <label for="aFonte">Fonte do ativo</label>
                      <select id="aFonte">
                        <option>Mapa</option>
                        <option>Angariações</option>
                        <option>FSBO</option>
                        <option>Manual</option>
                      </select>
                    </div>

                    <div class="field">
                      <label for="aSearch">Pesquisar ativo</label>
                      <input class="input" id="aSearch" type="text" placeholder="Pesquisar por nome/ref/zona…" />
                    </div>
                  </div>

                  <div class="grid-2">
                    <div class="field">
                      <label for="aZona">Zona (auto/preencher)</label>
                      <input class="input" id="aZona" type="text" placeholder="Ex.: Foz · Porto" />
                    </div>

                    <div class="field">
                      <label for="aTipologia">Tipologia</label>
                      <input class="input" id="aTipologia" type="text" placeholder="Ex.: T3" />
                    </div>
                  </div>

                  <div class="grid-2">
                    <div class="field">
                      <label for="aPreco">Preço pedido</label>
                      <input class="input" id="aPreco" type="text" placeholder="Ex.: 780000" />
                    </div>

                    <div class="field">
                      <label for="aObs">Observações</label>
                      <input class="input" id="aObs" type="text" placeholder="Notas rápidas do ativo (opcional)" />
                    </div>
                  </div>

                  <div class="hint">
                    Nota: aqui ligamos depois ao teu dataset (Mapa/Angariações/FSBO) para autopreencher e evitar duplicação.
                  </div>
                </div>

                <div id="assetZona" class="hidden" style="margin-top:10px">
                  <div class="grid-2">
                    <div class="field">
                      <label for="zZona">Zona</label>
                      <input class="input" id="zZona" type="text" placeholder="Ex.: Foz · Porto" />
                    </div>
                    <div class="field">
                      <label for="zTipologia">Tipologia</label>
                      <input class="input" id="zTipologia" type="text" placeholder="Ex.: T2/T3" />
                    </div>
                  </div>

                  <div class="grid-3">
                    <div class="field">
                      <label for="zSegmento">Segmento</label>
                      <select id="zSegmento">
                        <option>Novo</option>
                        <option>Usado</option>
                        <option>Reabilitado</option>
                        <option>Luxo</option>
                      </select>
                    </div>
                    <div class="field">
                      <label for="zMin">Preço alvo (mín.)</label>
                      <input class="input" id="zMin" type="text" placeholder="€" />
                    </div>
                    <div class="field">
                      <label for="zMax">Preço alvo (máx.)</label>
                      <input class="input" id="zMax" type="text" placeholder="€" />
                    </div>
                  </div>
                </div>
              </div>

              <!-- STEP 4 -->
              <div id="step4" class="hidden">
                <div class="drop" id="pdfDrop">
                  <div class="d-left">
                    <div class="d-title">Estudos de mercado (PDF)</div>
                    <p class="d-sub">
                      Carregue um PDF genérico para análise. No passo seguinte o sistema irá extrair métricas, capítulos e
                      gerar um resumo operacional (editável).
                    </p>
                    <p class="d-sub" style="margin-top:6px">
                      <strong>Recomendação:</strong> PDFs até ~15MB (dependendo do browser). Para volumes grandes, dividir por capítulos.
                    </p>
                  </div>
                  <div class="d-actions">
                    <input id="pdfFile" type="file" accept="application/pdf" class="hidden" />
                    <button class="btn primary" id="btnPickPdf">Importar PDF</button>
                    <button class="btn secondary" id="btnReprocess">Reprocessar</button>
                  </div>
                </div>

                <div class="files" id="pdfList">
                  <!-- placeholder -->
                  <div class="file">
                    <div>
                      <div class="f-name">Exemplo.pdf</div>
                      <div class="f-meta">20/12/2025 · 18 páginas · Fonte: upload</div>
                    </div>
                    <div class="f-actions">
                      <button class="btn-xs" data-act="view">Ver</button>
                      <button class="btn-xs" data-act="remove">Remover</button>
                    </div>
                  </div>
                  <!-- /placeholder -->
                </div>

                <div class="analysis">
                  <div class="mini-card">
                    <h5>Métricas detetadas</h5>
                    <div class="kv"><b>Preço médio/m²</b><span id="mPrecoM2">—</span></div>
                    <div class="kv"><b>Intervalo</b><span id="mIntervalo">—</span></div>
                    <div class="kv"><b>Tendência</b><span id="mTendencia">—</span></div>
                    <div class="kv"><b>Tempo médio</b><span id="mTempo">—</span></div>
                  </div>

                  <div class="mini-card">
                    <h5>Capítulos / Estrutura</h5>
                    <div class="hint" id="mCapitulos">Sem análise ainda. Após importação, será gerada uma estrutura (editável).</div>
                  </div>

                  <div class="mini-card">
                    <h5>Resumo operacional</h5>
                    <div class="hint">Três blocos editáveis para preparar a narrativa do relatório.</div>
                    <div class="divider"></div>
                    <div class="field" style="margin:0">
                      <label for="sumRelevante">Relevante para o cliente</label>
                      <textarea id="sumRelevante" placeholder="Pontos do PDF que interessam diretamente ao cliente…"></textarea>
                    </div>
                    <div class="field" style="margin:0">
                      <label for="sumRiscos">Riscos / alertas</label>
                      <textarea id="sumRiscos" placeholder="Riscos e condicionantes que o cliente deve considerar…"></textarea>
                    </div>
                    <div class="field" style="margin:0">
                      <label for="sumOport">Oportunidades</label>
                      <textarea id="sumOport" placeholder="Oportunidades e alavancas de valor…"></textarea>
                    </div>
                  </div>
                </div>
              </div>

              <!-- STEP 5 -->
              <div id="step5" class="hidden">
                <div class="section-title">Estrutura do relatório</div>

                <div class="switches">
                  <label class="sw"><span class="l"><b>Resumo Executivo</b><span>1 página com decisão + mensagem final.</span></span><input id="sExec" type="checkbox" checked></label>
                  <label class="sw"><span class="l"><b>Contexto do Cliente</b><span>Objetivo, preocupações e perfil.</span></span><input id="sContexto" type="checkbox" checked></label>
                  <label class="sw"><span class="l"><b>Enquadramento de Mercado</b><span>Insights do PDF + dados internos.</span></span><input id="sMercado" type="checkbox" checked></label>
                  <label class="sw"><span class="l"><b>Comparáveis</b><span>Concorrência e posicionamento (quando aplicável).</span></span><input id="sComps" type="checkbox"></label>
                  <label class="sw"><span class="l"><b>Cenários</b><span>Impacto de preço/timing/estratégia.</span></span><input id="sCenarios" type="checkbox" checked></label>
                  <label class="sw"><span class="l"><b>Recomendação Garvetur</b><span>O “o que fazer” com racional.</span></span><input id="sRecomend" type="checkbox" checked></label>
                  <label class="sw"><span class="l"><b>Plano de ação</b><span>Próximos passos, prazos, responsabilidades.</span></span><input id="sPlano" type="checkbox" checked></label>
                  <label class="sw"><span class="l"><b>Anexos</b><span>PDFs, excertos e material de suporte.</span></span><input id="sAnexos" type="checkbox" checked></label>
                </div>

                <div class="divider"></div>

                <div class="grid-2">
                  <div class="field">
                    <label for="rTom">Tom</label>
                    <select id="rTom">
                      <option>Conservador</option>
                      <option selected>Neutro</option>
                      <option>Assertivo</option>
                    </select>
                  </div>

                  <div class="field">
                    <label for="rCTA">Call-to-action final</label>
                    <select id="rCTA">
                      <option>Agendar reunião</option>
                      <option>Avaliação presencial</option>
                      <option>Ajuste de preço</option>
                      <option>Estratégia de marketing</option>
                      <option>Mandato</option>
                    </select>
                  </div>
                </div>

                <div class="field">
                  <label for="rRecomend">Recomendação final (obrigatório)</label>
                  <textarea id="rRecomend" placeholder="Mensagem final para o cliente: decisão sugerida, racional, e próximos passos."></textarea>
                </div>

                <div class="cta-row">
                  <button class="btn primary" id="btnBuildPdf">Gerar PDF</button>
                  <button class="btn" id="btnBuildExec">Gerar versão executiva</button>
                  <button class="btn secondary" id="btnDuplicate">Duplicar como template</button>
                </div>

                <div class="hint" style="margin-top:10px">
                  Nota: a geração PDF será ligada no próximo passo (JS) com o teu layout premium e rodapés (confidencial, data, marca).
                </div>
              </div>

            </div>

            <div class="panel-foot">
              <div class="hint" id="wizardHint">Preencha os campos essenciais e avance. O sistema guardará rascunho automaticamente (a ligar no JS).</div>
              <div style="display:flex;gap:8px;flex-wrap:wrap">
                <button class="btn secondary" id="btnPrev">Anterior</button>
                <button class="btn primary" id="btnNext">Seguinte</button>
              </div>
            </div>
          </div>
        </section>

      </main>
    </div>
  </div>

  <!-- PDF.js (carregamento robusto; sem integrity para evitar bloqueio por hash inválido em alguns ambientes) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.10.38/pdf.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>
(function(){
  /* ===========================
     Config / Helpers
  =========================== */
  const el = (id)=>document.getElementById(id);
  const $$ = (sel, root=document)=>Array.from(root.querySelectorAll(sel));
  const todayISO = ()=> new Date().toISOString().slice(0,10);

  function safeJSONParse(raw, fallback){
    try{ return raw ? JSON.parse(raw) : fallback; }catch{ return fallback; }
  }
  function uid(prefix='rpt'){
    return prefix + '_' + Math.random().toString(16).slice(2) + '_' + Date.now().toString(16);
  }
  function bytesToMB(b){ return (b/1024/1024).toFixed(2) + ' MB'; }
  function toPTDate(iso){
    try{
      const d = new Date(iso);
      if(isNaN(d.getTime())) return iso;
      return d.toLocaleDateString('pt-PT');
    }catch{ return iso; }
  }
  function normStr(s){ return (s||'').toString().trim(); }

  function moneyGuessToPretty(v){
    if(v==null) return '—';
    let s = String(v).replace(/\s/g,'');
    s = s.replace(/[€]/g,'');
    s = s.replace(/\./g,'').replace(/,/g,'.');
    const n = Number(s);
    if(!isFinite(n) || n<=0) return '—';
    return n.toLocaleString('pt-PT',{style:'currency',currency:'EUR',maximumFractionDigits:0});
  }

  function stripExtraSpaces(t){
    return (t||'').replace(/\s+/g,' ').trim();
  }

  /* ===========================
     Storage: Relatórios (meta)
  =========================== */
  const LS_KEY = 'gpp_relatorios_cliente_v1';

  function loadAllReports(){
    return safeJSONParse(localStorage.getItem(LS_KEY), []);
  }
  function saveAllReports(list){
    localStorage.setItem(LS_KEY, JSON.stringify(list || []));
  }
  function getReport(id){
    return loadAllReports().find(r=>r.id===id) || null;
  }
  function upsertReport(report){
    const list = loadAllReports();
    const idx = list.findIndex(r=>r.id===report.id);
    if(idx>=0) list[idx] = report;
    else list.unshift(report);
    saveAllReports(list);
  }
  function deleteReport(id){
    const list = loadAllReports().filter(r=>r.id!==id);
    saveAllReports(list);
  }

  /* ===========================
     IndexedDB: PDFs (Blobs)
  =========================== */
  const DB_NAME = 'gpp_relatorios_cliente_db_v1';
  const DB_STORE = 'pdfs';

  function openDB(){
    return new Promise((resolve, reject)=>{
      const req = indexedDB.open(DB_NAME, 1);
      req.onerror = ()=>reject(req.error);
      req.onupgradeneeded = ()=>{
        const db = req.result;
        if(!db.objectStoreNames.contains(DB_STORE)){
          db.createObjectStore(DB_STORE, { keyPath:'key' });
        }
      };
      req.onsuccess = ()=>resolve(req.result);
    });
  }

  async function idbPutPDF(key, blob, meta){
    const db = await openDB();
    return new Promise((resolve, reject)=>{
      const tx = db.transaction(DB_STORE, 'readwrite');
      tx.objectStore(DB_STORE).put({
        key,
        blob,
        meta: meta || {}
      });
      tx.oncomplete = ()=>resolve(true);
      tx.onerror = ()=>reject(tx.error);
    });
  }

  async function idbGetPDF(key){
    const db = await openDB();
    return new Promise((resolve, reject)=>{
      const tx = db.transaction(DB_STORE, 'readonly');
      const req = tx.objectStore(DB_STORE).get(key);
      req.onsuccess = ()=>resolve(req.result || null);
      req.onerror = ()=>reject(req.error);
    });
  }

  async function idbDelPDF(key){
    const db = await openDB();
    return new Promise((resolve, reject)=>{
      const tx = db.transaction(DB_STORE, 'readwrite');
      tx.objectStore(DB_STORE).delete(key);
      tx.oncomplete = ()=>resolve(true);
      tx.onerror = ()=>reject(tx.error);
    });
  }

  /* ===========================
     PDF Extraction (pdf.js) — FIX
  =========================== */
  function ensurePdfJsReady(){
    if(!window.pdfjsLib) return false;
    try{
      // worker consistente
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.10.38/pdf.worker.min.js";
    }catch{}
    return true;
  }

  async function pdfToText(fileOrBlob){
    if(!ensurePdfJsReady()) throw new Error('PDF.js não carregou.');

    const ab = await fileOrBlob.arrayBuffer();
    const loadingTask = pdfjsLib.getDocument({ data: ab });
    const pdf = await loadingTask.promise;
    const numPages = pdf.numPages;

    let allText = '';
    for(let p=1; p<=numPages; p++){
      const page = await pdf.getPage(p);
      const content = await page.getTextContent();
      const strings = content.items.map(it => it.str).filter(Boolean);
      const pageText = strings.join(' ');
      allText += '\n\n' + pageText;
    }
    return { text: stripExtraSpaces(allText), pages: numPages };
  }

  /* ===========================
     Heurísticas: Métricas / Capítulos / Resumo
  =========================== */
  function extractMetrics(text){
    const t = text || '';

    const reM2 = /(\d{1,3}(?:[ .]\d{3})*(?:,\d+)?)\s*(?:€|EUR)?\s*(?:\/|por)?\s*(?:m2|m²)/ig;
    const reRange = /(\d{1,3}(?:[ .]\d{3})*)\s*(?:-|–|a)\s*(\d{1,3}(?:[ .]\d{3})*)\s*(?:€|EUR)?\s*(?:\/|por)?\s*(?:m2|m²)/ig;

    const reTrend = /(\+|-)?\s*(\d{1,2}(?:,\d+)?)\s*%\s*(?:a\.?a\.?|yoy|YoY|ano|anual)/g;
    const reTime = /(\d{1,3})\s*(dias|dia|meses|mês|semanas|semana)/ig;

    function normNum(s){
      return Number(String(s).replace(/\s/g,'').replace(/\./g,'').replace(',','.'));
    }

    let m2Vals = [];
    let m2Range = null;

    let m;
    while((m = reRange.exec(t)) !== null){
      const a = normNum(m[1]); const b = normNum(m[2]);
      if(isFinite(a) && isFinite(b)){
        m2Range = [a,b].sort((x,y)=>x-y);
      }
    }
    while((m = reM2.exec(t)) !== null){
      const val = normNum(m[1]);
      if(isFinite(val) && val>0 && val<50000) m2Vals.push(val);
    }

    let precoM2 = '—';
    if(m2Vals.length){
      m2Vals.sort((a,b)=>a-b);
      const mid = Math.floor(m2Vals.length/2);
      const med = (m2Vals.length%2) ? m2Vals[mid] : (m2Vals[mid-1]+m2Vals[mid])/2;
      precoM2 = Math.round(med).toLocaleString('pt-PT') + ' €/m²';
    }

    let intervalo = '—';
    if(m2Range){
      intervalo = Math.round(m2Range[0]).toLocaleString('pt-PT') + '–' + Math.round(m2Range[1]).toLocaleString('pt-PT') + ' €/m²';
    }

    let tendencia = '—';
    const trends = [];
    while((m = reTrend.exec(t)) !== null){
      const sign = m[1] || '';
      const v = Number(String(m[2]).replace(',','.'));
      if(isFinite(v) && v>=0 && v<=99) trends.push((sign==='-'?'-':'+') + v.toFixed(1) + '%');
    }
    if(trends.length){
      tendencia = trends.slice(0,2).join(' · ') + ' a.a.';
    }

    let tempo = '—';
    const times = [];
    while((m = reTime.exec(t)) !== null){
      const n = Number(m[1]);
      const unit = m[2].toLowerCase();
      if(isFinite(n) && n>0){
        times.push(n + ' ' + unit);
      }
    }
    if(times.length){
      tempo = times.slice(0,2).join(' · ');
    }

    return { precoM2, intervalo, tendencia, tempo };
  }

  function detectChapters(text){
    const lines = (text||'').split('\n').map(l=>l.trim()).filter(Boolean);
    const chapters = [];
    const headingLike = (l)=>{
      if(l.length < 6 || l.length > 80) return false;
      const upperRatio = l.replace(/[^A-ZÁÀÂÃÄÉÈÊÍÌÎÓÒÔÕÖÚÙÛÇ]/g,'').length / Math.max(1,l.replace(/[^A-Za-zÁÀÂÃÄÉÈÊÍÌÎÓÒÔÕÖÚÙÛÇ]/g,'').length);
      if(upperRatio > 0.75 && l.length <= 60) return true;
      if(/^\d+(\.\d+)*\s+/.test(l)) return true;
      if(/:$/.test(l) && l.length<=60) return true;
      if(/(conclus|resumo|metodologia|oferta|procura|preç|tendênc|recomenda|riscos|mercado)/i.test(l)) return true;
      return false;
    };

    for(let i=0;i<lines.length;i++){
      const l = lines[i];
      if(headingLike(l)){
        chapters.push(l.replace(/:+$/,''));
      }
      if(chapters.length>=8) break;
    }
    return chapters;
  }

  function buildAutoSummary(text, ctx){
    const t = stripExtraSpaces(text||'');
    if(!t) return { rel:'', risk:'', opp:'' };

    const sentences = t
      .replace(/([.!?])\s+/g,'$1|')
      .split('|')
      .map(s=>s.trim())
      .filter(s=>s.length>35 && s.length<220);

    const kwBase = [];
    if(ctx?.zona) kwBase.push(ctx.zona);
    if(ctx?.tipologia) kwBase.push(ctx.tipologia);
    if(ctx?.objetivo) kwBase.push(ctx.objetivo);

    const kwsRel = ['procura','oferta','preço','preços','tendência','variação','m²','m2','transações','absorção','stock','prime','luxo','porto','foz','boavista','centro'];
    const kwsRisk = ['risco','incerteza','subida','queda','correção','negociação','taxa','juros','fiscal','licença','prazo','atraso','exposição'];
    const kwsOpp  = ['oportunidade','crescimento','valorização','escassez','pipeline','novo','reabilitação','rentabilidade','yield','procura internacional','procura externa','premium'];

    function score(s, kws){
      const low = s.toLowerCase();
      let pts = 0;
      kws.forEach(k=>{
        const kk = (k||'').toLowerCase();
        if(!kk) return;
        if(low.includes(kk)) pts += 2;
      });
      kwBase.forEach(k=>{
        const kk = (k||'').toLowerCase();
        if(!kk) return;
        if(low.includes(kk)) pts += 3;
      });
      if(/\d/.test(s)) pts += 1;
      return pts;
    }

    function pickTop(kws){
      const ranked = sentences
        .map(s=>({ s, p: score(s,kws) }))
        .filter(x=>x.p>0)
        .sort((a,b)=>b.p-a.p);
      const top = ranked.slice(0,3).map(x=>x.s);
      return top.join('\n• ').trim();
    }

    const rel = pickTop(kwsRel);
    const risk = pickTop(kwsRisk);
    const opp = pickTop(kwsOpp);

    return {
      rel: rel ? ('• ' + rel) : '',
      risk: risk ? ('• ' + risk) : '',
      opp: opp ? ('• ' + opp) : ''
    };
  }

  /* ===========================
     UI: Elementos do módulo
  =========================== */
  const q = el('q');
  const fStatus = el('fStatus');
  const fTipo = el('fTipo');
  const fDataDe = el('fDataDe');
  const fDataAte = el('fDataAte');
  const fConfidencial = el('fConfidencial');

  const btnApply = el('btnApply');
  const btnClear = el('btnClear');

  const reportsTbody = el('reportsTbody');

  const tabList = el('tabList');
  const tabWizard = el('tabWizard');
  const viewList = el('viewList');
  const viewWizard = el('viewWizard');

  const btnNew = el('btnNew');
  const btnGoWizard = el('btnGoWizard');
  const btnBackToList = el('btnBackToList');
  const btnSaveDraft = el('btnSaveDraft');

  const btnPrev = el('btnPrev');
  const btnNext = el('btnNext');

  const steps = $$('.step');
  const stepTitle = el('stepTitle');

  // Step fields
  const cTipo = el('cTipo');
  const cNome = el('cNome');
  const cTel = el('cTel');
  const cEmail = el('cEmail');
  const cIdioma = el('cIdioma');
  const cDetalhe = el('cDetalhe');
  const cConf = el('cConf');
  const cNotas = el('cNotas');

  const oObjetivo = el('oObjetivo');
  const oHorizonte = el('oHorizonte');
  const oRisco = el('oRisco');
  const oPreocup = el('oPreocup');
  const oBrief = el('oBrief');

  const aFonte = el('aFonte');
  const aSearch = el('aSearch');
  const aZona = el('aZona');
  const aTipologia = el('aTipologia');
  const aPreco = el('aPreco');
  const aObs = el('aObs');

  const zZona = el('zZona');
  const zTipologia = el('zTipologia');
  const zSegmento = el('zSegmento');
  const zMin = el('zMin');
  const zMax = el('zMax');

  const pdfDrop = el('pdfDrop');
  const pdfFile = el('pdfFile');
  const btnPickPdf = el('btnPickPdf');
  const btnReprocess = el('btnReprocess');
  const pdfList = el('pdfList');

  const mPrecoM2 = el('mPrecoM2');
  const mIntervalo = el('mIntervalo');
  const mTendencia = el('mTendencia');
  const mTempo = el('mTempo');
  const mCapitulos = el('mCapitulos');

  const sumRelevante = el('sumRelevante');
  const sumRiscos = el('sumRiscos');
  const sumOport = el('sumOport');

  const sExec = el('sExec');
  const sContexto = el('sContexto');
  const sMercado = el('sMercado');
  const sComps = el('sComps');
  const sCenarios = el('sCenarios');
  const sRecomend = el('sRecomend');
  const sPlano = el('sPlano');
  const sAnexos = el('sAnexos');

  const rTom = el('rTom');
  const rCTA = el('rCTA');
  const rRecomend = el('rRecomend');

  const btnBuildPdf = el('btnBuildPdf');
  const btnBuildExec = el('btnBuildExec');
  const btnDuplicate = el('btnDuplicate');

  // Views & steps
  const stepEls = [null, el('step1'), el('step2'), el('step3'), el('step4'), el('step5')];
  let currentStep = 1;

  let ACTIVE_REPORT_ID = null; // relatório em edição

  function setTab(which){
    const isList = which === 'list';
    tabList.classList.toggle('active', isList);
    tabWizard.classList.toggle('active', !isList);
    viewList.classList.toggle('hidden', !isList);
    viewWizard.classList.toggle('hidden', isList);
  }

  function setStep(n){
    currentStep = Math.min(5, Math.max(1, n));
    steps.forEach(s => s.classList.toggle('active', Number(s.dataset.step) === currentStep));
    stepEls.forEach((node, idx)=>{ if(node) node.classList.toggle('hidden', idx !== currentStep); });

    const titles = {
      1:'Passo 1 — Identificação do Cliente',
      2:'Passo 2 — Objetivo e Perfil de Decisão',
      3:'Passo 3 — Ativo / Zona em análise',
      4:'Passo 4 — Importar PDF & Análise',
      5:'Passo 5 — Construção do Relatório'
    };
    stepTitle.textContent = titles[currentStep] || 'Passo';
    btnPrev.disabled = currentStep === 1;
    btnNext.textContent = (currentStep === 5) ? 'Concluir' : 'Seguinte';
  }

  function getSelectedAssetMode(){
    return document.querySelector('input[name="assetMode"]:checked')?.value || 'imovel';
  }

  function collectForm(){
    const mode = getSelectedAssetMode();
    const preocup = Array.from(oPreocup?.selectedOptions || []).map(o=>o.value);

    const base = {
      id: ACTIVE_REPORT_ID || uid('rpt'),
      createdAt: null,
      updatedAt: todayISO(),
      status: 'draft',

      cliente: {
        tipo: normStr(cTipo.value),
        nome: normStr(cNome.value),
        tel: normStr(cTel.value),
        email: normStr(cEmail.value),
        idioma: normStr(cIdioma.value || 'pt'),
        detalhe: normStr(cDetalhe.value || 'exec'),
        confidencial: (cConf.value === 'yes'),
        notas: normStr(cNotas.value)
      },

      objetivo: {
        objetivo: normStr(oObjetivo.value),
        horizonte: normStr(oHorizonte.value),
        risco: normStr(oRisco.value),
        preocupacoes: preocup,
        brief: normStr(oBrief.value)
      },

      ativo: {
        mode,
        imovel: {
          fonte: normStr(aFonte.value),
          query: normStr(aSearch.value),
          zona: normStr(aZona.value),
          tipologia: normStr(aTipologia.value),
          preco: normStr(aPreco.value),
          obs: normStr(aObs.value)
        },
        zona: {
          zona: normStr(zZona.value),
          tipologia: normStr(zTipologia.value),
          segmento: normStr(zSegmento.value),
          min: normStr(zMin.value),
          max: normStr(zMax.value)
        }
      },

      pdfs: [],
      analysis: {
        metrics: { precoM2:'—', intervalo:'—', tendencia:'—', tempo:'—' },
        chapters: [],
        sum: {
          relevante: normStr(sumRelevante.value),
          riscos: normStr(sumRiscos.value),
          oportunidades: normStr(sumOport.value)
        }
      },

      report: {
        sections: {
          exec: !!sExec.checked,
          contexto: !!sContexto.checked,
          mercado: !!sMercado.checked,
          comps: !!sComps.checked,
          cenarios: !!sCenarios.checked,
          recomend: !!sRecomend.checked,
          plano: !!sPlano.checked,
          anexos: !!sAnexos.checked
        },
        tom: normStr(rTom.value),
        cta: normStr(rCTA.value),
        recomendacaoFinal: normStr(rRecomend.value)
      }
    };

    const existing = ACTIVE_REPORT_ID ? getReport(ACTIVE_REPORT_ID) : null;
    base.createdAt = existing?.createdAt || todayISO();
    base.status = existing?.status || 'draft';
    base.pdfs = existing?.pdfs || [];
    base.analysis = existing?.analysis || base.analysis;

    return base;
  }

  function fillForm(report){
    if(!report) return;

    ACTIVE_REPORT_ID = report.id;

    cTipo.value = report.cliente?.tipo || '';
    cNome.value = report.cliente?.nome || '';
    cTel.value = report.cliente?.tel || '';
    cEmail.value = report.cliente?.email || '';
    cIdioma.value = report.cliente?.idioma || 'pt';
    cDetalhe.value = report.cliente?.detalhe || 'exec';
    cConf.value = report.cliente?.confidencial ? 'yes' : 'no';
    cNotas.value = report.cliente?.notas || '';

    oObjetivo.value = report.objetivo?.objetivo || '';
    oHorizonte.value = report.objetivo?.horizonte || '';
    oRisco.value = report.objetivo?.risco || '';
    const selected = new Set(report.objetivo?.preocupacoes || []);
    Array.from(oPreocup.options).forEach(opt=> opt.selected = selected.has(opt.value));
    oBrief.value = report.objetivo?.brief || '';

    const mode = report.ativo?.mode || 'imovel';
    const radios = $$('input[name="assetMode"]');
    radios.forEach(r=>{ r.checked = (r.value === mode); });
    const assetImovel = el('assetImovel');
    const assetZona = el('assetZona');
    assetImovel.classList.toggle('hidden', mode !== 'imovel');
    assetZona.classList.toggle('hidden', mode !== 'zona');

    aFonte.value = report.ativo?.imovel?.fonte || 'Manual';
    aSearch.value = report.ativo?.imovel?.query || '';
    aZona.value = report.ativo?.imovel?.zona || '';
    aTipologia.value = report.ativo?.imovel?.tipologia || '';
    aPreco.value = report.ativo?.imovel?.preco || '';
    aObs.value = report.ativo?.imovel?.obs || '';

    zZona.value = report.ativo?.zona?.zona || '';
    zTipologia.value = report.ativo?.zona?.tipologia || '';
    zSegmento.value = report.ativo?.zona?.segmento || 'Novo';
    zMin.value = report.ativo?.zona?.min || '';
    zMax.value = report.ativo?.zona?.max || '';

    const met = report.analysis?.metrics || {};
    mPrecoM2.textContent = met.precoM2 || '—';
    mIntervalo.textContent = met.intervalo || '—';
    mTendencia.textContent = met.tendencia || '—';
    mTempo.textContent = met.tempo || '—';

    const ch = report.analysis?.chapters || [];
    mCapitulos.textContent = ch.length ? ch.map(c=>'• '+c).join('\n') : 'Sem análise ainda. Após importação, será gerada uma estrutura (editável).';
    mCapitulos.style.whiteSpace = 'pre-line';

    sumRelevante.value = report.analysis?.sum?.relevante || '';
    sumRiscos.value = report.analysis?.sum?.riscos || '';
    sumOport.value = report.analysis?.sum?.oportunidades || '';

    const sec = report.report?.sections || {};
    sExec.checked = !!sec.exec;
    sContexto.checked = !!sec.contexto;
    sMercado.checked = !!sec.mercado;
    sComps.checked = !!sec.comps;
    sCenarios.checked = !!sec.cenarios;
    sRecomend.checked = !!sec.recomend;
    sPlano.checked = !!sec.plano;
    sAnexos.checked = !!sec.anexos;

    rTom.value = report.report?.tom || 'Neutro';
    rCTA.value = report.report?.cta || 'Agendar reunião';
    rRecomend.value = report.report?.recomendacaoFinal || '';

    renderPDFList(report);
  }

  function getContextForSummary(report){
    const mode = report.ativo?.mode || 'imovel';
    if(mode==='imovel'){
      return {
        zona: report.ativo?.imovel?.zona || '',
        tipologia: report.ativo?.imovel?.tipologia || '',
        objetivo: report.objetivo?.objetivo || ''
      };
    }
    return {
      zona: report.ativo?.zona?.zona || '',
      tipologia: report.ativo?.zona?.tipologia || '',
      objetivo: report.objetivo?.objetivo || ''
    };
  }

  /* ===========================
     Lista: render + filtros
  =========================== */
  function badgeEstado(status){
    if(status==='final') return '<span class="pill ok">Final</span>';
    if(status==='sent') return '<span class="pill ok">Enviado</span>';
    return '<span class="pill info">Rascunho</span>';
  }

  function matchFilters(r){
    const txt = (q.value||'').toLowerCase().trim();
    if(txt){
      const hay = [
        r.cliente?.nome, r.cliente?.tipo,
        r.objetivo?.objetivo,
        r.ativo?.imovel?.zona, r.ativo?.zona?.zona,
        r.status
      ].filter(Boolean).join(' ').toLowerCase();
      if(!hay.includes(txt)) return false;
    }
    if(fStatus.value && r.status !== fStatus.value) return false;
    if(fTipo.value && (r.cliente?.tipo||'') !== fTipo.value) return false;

    if(fConfidencial.checked && !r.cliente?.confidencial) return false;

    const de = fDataDe.value || '';
    const ate = fDataAte.value || '';
    const dt = r.updatedAt || r.createdAt || '';
    if(de && dt && dt < de) return false;
    if(ate && dt && dt > ate) return false;

    return true;
  }

  function renderList(){
    const list = loadAllReports().filter(matchFilters);
    reportsTbody.innerHTML = '';

    if(!list.length){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td colspan="5">
          <div style="padding:10px 0;color:var(--muted);font-size:12px">
            Sem relatórios com os filtros atuais. Clique em <strong>+ Novo Relatório</strong>.
          </div>
        </td>`;
      reportsTbody.appendChild(tr);
      return;
    }

    list.forEach(r=>{
      const mode = r.ativo?.mode || 'imovel';
      const zona = mode==='imovel' ? (r.ativo?.imovel?.zona||'—') : (r.ativo?.zona?.zona||'—');
      const tip = mode==='imovel' ? (r.ativo?.imovel?.tipologia||'') : (r.ativo?.zona?.tipologia||'');
      const obj = r.objetivo?.objetivo || '—';
      const detalhe = (r.cliente?.detalhe === 'full') ? 'Completo' : 'Executivo';
      const conf = r.cliente?.confidencial ? 'Sim' : 'Não';

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>
          <div><strong>${r.cliente?.nome || '—'}</strong></div>
          <span class="td-sub">${r.cliente?.tipo || '—'} · Idioma ${((r.cliente?.idioma||'pt')==='en'?'EN':'PT')} · ${detalhe}</span>
        </td>
        <td>
          <div><strong>${obj}</strong></div>
          <span class="td-sub">Zona: ${zona}${tip ? ' · Tipologia: '+tip : ''}</span>
        </td>
        <td>
          <div><strong>${toPTDate(r.createdAt || '')}</strong></div>
          <span class="td-sub">Atualizado: ${toPTDate(r.updatedAt || '')}</span>
        </td>
        <td>
          ${badgeEstado(r.status)}
          <span class="td-sub">Confidencial: ${conf}</span>
        </td>
        <td>
          <div class="row-actions">
            <button class="btn-xs primary" data-act="open" data-id="${r.id}">Abrir</button>
            <button class="btn-xs" data-act="duplicate" data-id="${r.id}">Duplicar</button>
            <button class="btn-xs" data-act="export" data-id="${r.id}">Exportar PDF</button>
            <button class="btn-xs ghost" data-act="delete" data-id="${r.id}">Remover</button>
          </div>
        </td>
      `;
      reportsTbody.appendChild(tr);
    });
  }

  /* ===========================
     Wizard: criar/guardar
  =========================== */
  function newReport(){
    const r = collectForm();
    r.id = uid('rpt');
    r.createdAt = todayISO();
    r.updatedAt = todayISO();
    r.status = 'draft';
    upsertReport(r);
    fillForm(r);
    return r;
  }

  function saveDraft(){
    const r = collectForm();
    r.updatedAt = todayISO();
    r.status = 'draft';
    upsertReport(r);
    ACTIVE_REPORT_ID = r.id;
    renderList();
    return r;
  }

  btnNew?.addEventListener('click', ()=>{
    ACTIVE_REPORT_ID = null;
    const empty = {
      id: uid('rpt'),
      createdAt: todayISO(),
      updatedAt: todayISO(),
      status: 'draft',
      cliente:{tipo:'',nome:'',tel:'',email:'',idioma:'pt',detalhe:'exec',confidencial:false,notas:''},
      objetivo:{objetivo:'',horizonte:'',risco:'',preocupacoes:[],brief:''},
      ativo:{mode:'imovel',imovel:{fonte:'Manual',query:'',zona:'',tipologia:'',preco:'',obs:''},zona:{zona:'',tipologia:'',segmento:'Novo',min:'',max:''}},
      pdfs:[],
      analysis:{metrics:{precoM2:'—',intervalo:'—',tendencia:'—',tempo:'—'},chapters:[],sum:{relevante:'',riscos:'',oportunidades:''}},
      report:{sections:{exec:true,contexto:true,mercado:true,comps:false,cenarios:true,recomend:true,plano:true,anexos:true},tom:'Neutro',cta:'Agendar reunião',recomendacaoFinal:''}
    };
    fillForm(empty);
    setTab('wizard'); setStep(1);
  });

  btnGoWizard?.addEventListener('click', ()=>{
    ACTIVE_REPORT_ID = null;
    btnNew.click();
  });

  btnBackToList?.addEventListener('click', ()=>{
    setTab('list');
    renderList();
  });

  btnSaveDraft?.addEventListener('click', ()=>{
    saveDraft();
    alert('Rascunho guardado.');
  });

  steps.forEach(s=>{
    s.addEventListener('click', ()=>{
      saveDraft();
      setStep(Number(s.dataset.step));
    });
  });

  btnPrev?.addEventListener('click', ()=>{
    saveDraft();
    setStep(currentStep-1);
  });
  btnNext?.addEventListener('click', ()=>{
    saveDraft();
    if(currentStep < 5) setStep(currentStep+1);
    else { setTab('list'); renderList(); }
  });

  // Autosave suave
  let autosaveTimer = null;
  function scheduleAutosave(){
    clearTimeout(autosaveTimer);
    autosaveTimer = setTimeout(()=>{ if(viewWizard && !viewWizard.classList.contains('hidden')) saveDraft(); }, 600);
  }
  ['input','change','keyup'].forEach(ev=>{
    viewWizard?.addEventListener(ev, scheduleAutosave, true);
  });

  /* ===========================
     PDFs: Importar / Reprocessar / Ver / Remover — FIX
     - suporte drag & drop
     - validação + mensagens consistentes
  =========================== */
  function ensureActiveReport(){
    if(!ACTIVE_REPORT_ID){
      const r = newReport();
      ACTIVE_REPORT_ID = r.id;
      return r;
    }
    const r = getReport(ACTIVE_REPORT_ID);
    if(!r){
      const nr = newReport();
      ACTIVE_REPORT_ID = nr.id;
      return nr;
    }
    return r;
  }

  function renderPDFList(report){
    pdfList.innerHTML = '';
    const list = report?.pdfs || [];
    if(!list.length){
      const div = document.createElement('div');
      div.className = 'file';
      div.innerHTML = `
        <div>
          <div class="f-name" style="color:var(--muted);font-weight:700">Sem PDFs importados</div>
          <div class="f-meta">Importe um estudo para iniciar a extração automática.</div>
        </div>
        <div class="f-actions">
          <button class="btn-xs" disabled>Ver</button>
        </div>
      `;
      pdfList.appendChild(div);
      return;
    }

    list.forEach(p=>{
      const div = document.createElement('div');
      div.className = 'file';
      div.innerHTML = `
        <div>
          <div class="f-name">${p.name || 'PDF'}</div>
          <div class="f-meta">${toPTDate(p.addedAt || '')} · ${p.pages || '—'} páginas · ${p.sizeMB || '—'}</div>
        </div>
        <div class="f-actions">
          <button class="btn-xs" data-act="view" data-key="${p.key}">Ver</button>
          <button class="btn-xs" data-act="remove" data-key="${p.key}">Remover</button>
        </div>
      `;
      pdfList.appendChild(div);
    });
  }

  async function processPDFAndUpdateReport(file){
    const report = ensureActiveReport();

    // validações rápidas
    if(file.type !== 'application/pdf'){
      alert('Por favor selecione um ficheiro PDF.');
      return;
    }
    // “guardrail” de UX (não bloqueia tecnicamente, mas evita crashes)
    const mb = file.size / 1024 / 1024;
    if(mb > 25){
      if(!confirm(`Este PDF tem ${mb.toFixed(1)}MB. Pode falhar em alguns browsers. Pretende tentar na mesma?`)) return;
    }

    const key = uid('pdf');
    const addedAt = todayISO();

    await idbPutPDF(key, file, { name:file.name, addedAt });

    const { text, pages } = await pdfToText(file);

    const metrics = extractMetrics(text);
    const chapters = detectChapters(text);

    const ctx = getContextForSummary(report);
    const sum = buildAutoSummary(text, ctx);

    report.updatedAt = todayISO();
    report.pdfs = (report.pdfs || []);
    report.pdfs.unshift({
      key,
      name: file.name,
      size: file.size,
      sizeMB: bytesToMB(file.size),
      pages,
      addedAt,
      extractedAt: todayISO(),
      metrics,
      chapters,
      textSample: text.slice(0, 1200)
    });

    report.analysis = report.analysis || {};
    report.analysis.metrics = metrics;
    report.analysis.chapters = chapters;
    report.analysis.sum = report.analysis.sum || {relevante:'',riscos:'',oportunidades:''};

    if(!report.analysis.sum.relevante) report.analysis.sum.relevante = sum.rel;
    if(!report.analysis.sum.riscos) report.analysis.sum.riscos = sum.risk;
    if(!report.analysis.sum.oportunidades) report.analysis.sum.oportunidades = sum.opp;

    upsertReport(report);
    fillForm(report);

    alert('PDF importado e analisado com sucesso.');
  }

  function pickPdf(){
    // gesto direto (browser-friendly)
    pdfFile.value = '';
    pdfFile.click();
  }

  btnPickPdf?.addEventListener('click', (e)=>{
    e.preventDefault();
    pickPdf();
  });

  pdfFile?.addEventListener('change', async ()=>{
    const f = pdfFile.files && pdfFile.files[0];
    if(!f) return;
    try{
      btnPickPdf.disabled = true;
      btnReprocess.disabled = true;
      await processPDFAndUpdateReport(f);
    }catch(err){
      console.error(err);
      const msg = (String(err?.message||'') || '').toLowerCase();
      if(msg.includes('pdf.js não carregou')){
        alert('Falha: o motor PDF (PDF.js) não carregou. Verifique ligação à internet/CDN ou políticas de bloqueio (adblock).');
      }else{
        alert('Falha ao processar PDF. Se for digitalizado (imagem) ou muito grande, divida o PDF ou use uma versão com texto pesquisável.');
      }
    }finally{
      btnPickPdf.disabled = false;
      btnReprocess.disabled = false;
      pdfFile.value = '';
    }
  });

  // Drag & Drop no bloco #pdfDrop — FIX
  if(pdfDrop){
    const on = (name, fn)=>pdfDrop.addEventListener(name, fn, false);

    on('dragenter', (e)=>{ e.preventDefault(); e.stopPropagation(); pdfDrop.style.outline='2px solid rgba(163,139,99,.55)'; });
    on('dragover',  (e)=>{ e.preventDefault(); e.stopPropagation(); });
    on('dragleave', (e)=>{ e.preventDefault(); e.stopPropagation(); pdfDrop.style.outline='none'; });
    on('drop', async (e)=>{
      e.preventDefault(); e.stopPropagation();
      pdfDrop.style.outline='none';
      const f = e.dataTransfer?.files?.[0];
      if(!f) return;
      try{
        btnPickPdf.disabled = true;
        btnReprocess.disabled = true;
        await processPDFAndUpdateReport(f);
      }catch(err){
        console.error(err);
        alert('Falha ao processar PDF via drag&drop. Tente importar pelo botão.');
      }finally{
        btnPickPdf.disabled = false;
        btnReprocess.disabled = false;
      }
    });
  }

  pdfList?.addEventListener('click', async (e)=>{
    const b = e.target.closest('button[data-act]');
    if(!b) return;

    const report = ensureActiveReport();
    const act = b.dataset.act;
    const key = b.dataset.key;

    if(act==='remove'){
      if(!confirm('Remover este PDF do relatório?')) return;
      try{ await idbDelPDF(key); }catch{}
      report.pdfs = (report.pdfs||[]).filter(p=>p.key!==key);
      upsertReport(report);
      fillForm(report);
      return;
    }

    if(act==='view'){
      const rec = await idbGetPDF(key);
      if(!rec?.blob){
        alert('PDF não encontrado (cache/DB). Reimporte o ficheiro.');
        return;
      }
      const url = URL.createObjectURL(rec.blob);
      window.open(url, '_blank', 'noopener,noreferrer');
      setTimeout(()=>URL.revokeObjectURL(url), 15000);
      return;
    }
  });

  btnReprocess?.addEventListener('click', async ()=>{
    const report = ensureActiveReport();
    if(!report.pdfs || !report.pdfs.length){
      alert('Sem PDFs para reprocessar.');
      return;
    }
    const latest = report.pdfs[0];
    try{
      btnPickPdf.disabled = true;
      btnReprocess.disabled = true;

      const rec = await idbGetPDF(latest.key);
      if(!rec?.blob) throw new Error('PDF não encontrado em IDB');

      const { text, pages } = await pdfToText(rec.blob);

      const metrics = extractMetrics(text);
      const chapters = detectChapters(text);
      const ctx = getContextForSummary(report);
      const sum = buildAutoSummary(text, ctx);

      latest.pages = pages;
      latest.extractedAt = todayISO();
      latest.metrics = metrics;
      latest.chapters = chapters;
      latest.textSample = text.slice(0, 1200);

      report.analysis.metrics = metrics;
      report.analysis.chapters = chapters;

      report.analysis.sum.relevante = report.analysis.sum.relevante || sum.rel;
      report.analysis.sum.riscos = report.analysis.sum.riscos || sum.risk;
      report.analysis.sum.oportunidades = report.analysis.sum.oportunidades || sum.opp;

      report.updatedAt = todayISO();

      upsertReport(report);
      fillForm(report);

      alert('Reprocessamento concluído.');
    }catch(err){
      console.error(err);
      alert('Falha no reprocessamento. Reimporte o PDF se necessário.');
    }finally{
      btnPickPdf.disabled = false;
      btnReprocess.disabled = false;
    }
  });

  /* ===========================
     Exportação “PDF” — FIX (sem pop-ups)
     - imprime via IFRAME invisível (evita bloqueio de janela)
  =========================== */
  function htmlEscape(s){
    return String(s||'')
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;');
  }

  function printHTMLInFrame(html){
    const iframe = document.createElement('iframe');
    iframe.style.position = 'fixed';
    iframe.style.right = '0';
    iframe.style.bottom = '0';
    iframe.style.width = '0';
    iframe.style.height = '0';
    iframe.style.border = '0';
    iframe.style.opacity = '0';
    iframe.setAttribute('aria-hidden','true');

    document.body.appendChild(iframe);

    const cleanup = ()=>{
      try{ iframe.remove(); }catch{}
    };

    const w = iframe.contentWindow;
    const d = iframe.contentDocument || w.document;

    d.open();
    d.write(html);
    d.close();

    // Espera que fonts/layout estejam prontos, depois imprime
    const firePrint = async ()=>{
      try{
        if(d.fonts && d.fonts.ready) await d.fonts.ready;
      }catch{}
      try{
        w.focus();
        w.print();
      }catch(err){
        console.error(err);
        alert('Falha ao abrir impressão. Tente novamente.');
        cleanup();
      }
    };

    // afterprint para limpeza
    const onAfter = ()=>{
      w.removeEventListener('afterprint', onAfter);
      setTimeout(cleanup, 250);
    };
    w.addEventListener('afterprint', onAfter);

    // alguns browsers não disparam afterprint consistentemente
    setTimeout(firePrint, 250);
    setTimeout(cleanup, 60000);
  }

  function exportReportToPrintPDF(report, forceExec=false){
    const cliente = report.cliente || {};
    const obj = report.objetivo || {};
    const ativo = report.ativo || {};
    const mode = ativo.mode || 'imovel';

    const zona = mode==='imovel' ? (ativo.imovel?.zona || '—') : (ativo.zona?.zona || '—');
    const tip = mode==='imovel' ? (ativo.imovel?.tipologia || '') : (ativo.zona?.tipologia || '');
    const preco = mode==='imovel' ? moneyGuessToPretty(ativo.imovel?.preco || '') : '';
    const detalhe = forceExec ? 'exec' : (cliente.detalhe || 'exec');

    const sec = report.report?.sections || {};
    const use = (k)=> forceExec ? (k==='exec' || k==='recomend' || k==='plano' || k==='mercado' ) : !!sec[k];

    const met = report.analysis?.metrics || {};
    const ch = report.analysis?.chapters || [];
    const sum = report.analysis?.sum || {};

    const confTag = cliente.confidencial ? 'CONFIDENCIAL' : 'INTERNO';
    const title = `Relatório para Cliente — ${cliente.nome || 'Cliente'} (${toPTDate(report.updatedAt || report.createdAt)})`;

    const styles = `
      <style>
        :root{--gold:#A38B63;--muted:#666;--txt:#111}
        *{box-sizing:border-box}
        body{font-family:Arial,Helvetica,sans-serif;color:var(--txt);margin:0;background:#fff}
        .page{max-width:920px;margin:0 auto;padding:28px 34px}
        .top{display:flex;justify-content:space-between;gap:14px;align-items:flex-start}
        .brand{font-weight:800;letter-spacing:.08em;text-transform:uppercase;color:var(--gold);font-size:14px}
        .meta{font-size:12px;color:var(--muted);text-align:right;line-height:1.4}
        .h1{margin:18px 0 6px;font-size:20px;letter-spacing:.02em}
        .tag{display:inline-block;padding:4px 10px;border:1px solid #ddd;border-radius:999px;font-size:11px;color:#333;background:#fafafa}
        .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:14px}
        .card{border:1px solid #eee;border-radius:14px;padding:12px 12px}
        .card h3{margin:0 0 8px;font-size:12px;text-transform:uppercase;letter-spacing:.12em;color:#444}
        .kv{display:flex;justify-content:space-between;gap:10px;padding:6px 0;border-bottom:1px solid #f0f0f0;font-size:13px}
        .kv:last-child{border-bottom:none}
        .kv b{color:#555;font-weight:700}
        .sec{margin-top:16px}
        .sec h2{margin:0 0 8px;font-size:13px;text-transform:uppercase;letter-spacing:.14em;color:#444}
        .p{font-size:13px;line-height:1.55;color:#222;margin:0 0 8px}
        ul{margin:6px 0 0 18px}
        li{margin:4px 0;font-size:13px;line-height:1.45}
        .foot{margin-top:18px;padding-top:10px;border-top:1px solid #eee;font-size:11px;color:#777;display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
        @media print{
          .page{padding:18px 24px}
        }
      </style>
    `;

    function blockResumoExec(){
      const rec = (report.report?.recomendacaoFinal || '').trim() || '(preencher recomendação final)';
      return `
        <div class="sec">
          <h2>Resumo Executivo</h2>
          <p class="p"><strong>Objetivo:</strong> ${htmlEscape(obj.objetivo || '—')} · <strong>Zona:</strong> ${htmlEscape(zona)} ${tip?('· <strong>Tipologia:</strong> '+htmlEscape(tip)) : ''} ${preco?('· <strong>Preço:</strong> '+htmlEscape(preco)) : ''}</p>
          <p class="p">${htmlEscape(rec).replace(/\n/g,'<br>')}</p>
        </div>
      `;
    }

    function blockContexto(){
      const preocup = (obj.preocupacoes||[]).length ? (obj.preocupacoes.join(', ')) : '—';
      return `
        <div class="sec">
          <h2>Contexto do Cliente</h2>
          <div class="grid">
            <div class="card">
              <h3>Briefing</h3>
              <div class="kv"><b>Tipo</b><span>${htmlEscape(cliente.tipo||'—')}</span></div>
              <div class="kv"><b>Horizonte</b><span>${htmlEscape(obj.horizonte||'—')}</span></div>
              <div class="kv"><b>Risco</b><span>${htmlEscape(obj.risco||'—')}</span></div>
              <div class="kv"><b>Preocupações</b><span>${htmlEscape(preocup)}</span></div>
            </div>
            <div class="card">
              <h3>Notas</h3>
              <p class="p">${htmlEscape(obj.brief||cliente.notas||'—').replace(/\n/g,'<br>')}</p>
            </div>
          </div>
        </div>
      `;
    }

    function blockMercado(){
      const caps = ch.length ? ('<ul>' + ch.slice(0,8).map(c=>`<li>${htmlEscape(c)}</li>`).join('') + '</ul>') : '<p class="p">Sem capítulos detetados (importe um PDF para análise).</p>';
      return `
        <div class="sec">
          <h2>Enquadramento de Mercado</h2>
          <div class="grid">
            <div class="card">
              <h3>Métricas (do PDF)</h3>
              <div class="kv"><b>Preço médio/m²</b><span>${htmlEscape(met.precoM2||'—')}</span></div>
              <div class="kv"><b>Intervalo</b><span>${htmlEscape(met.intervalo||'—')}</span></div>
              <div class="kv"><b>Tendência</b><span>${htmlEscape(met.tendencia||'—')}</span></div>
              <div class="kv"><b>Tempo médio</b><span>${htmlEscape(met.tempo||'—')}</span></div>
            </div>
            <div class="card">
              <h3>Estrutura / Capítulos</h3>
              ${caps}
            </div>
          </div>

          <div class="grid" style="margin-top:12px">
            <div class="card">
              <h3>Relevante para o cliente</h3>
              <p class="p">${htmlEscape(sum.relevante||'—').replace(/\n/g,'<br>')}</p>
            </div>
            <div class="card">
              <h3>Riscos / Alertas</h3>
              <p class="p">${htmlEscape(sum.riscos||'—').replace(/\n/g,'<br>')}</p>
            </div>
          </div>

          <div class="card" style="margin-top:12px">
            <h3>Oportunidades</h3>
            <p class="p">${htmlEscape(sum.oportunidades||'—').replace(/\n/g,'<br>')}</p>
          </div>
        </div>
      `;
    }

    function blockCenarios(){
      return `
        <div class="sec">
          <h2>Cenários</h2>
          <p class="p">Sugestão (placeholder): aqui ligamos no próximo sprint a simulação de cenários (preço vs timing vs estratégia), com base nos teus dados internos.</p>
        </div>
      `;
    }

    function blockPlano(){
      const cta = report.report?.cta || 'Agendar reunião';
      return `
        <div class="sec">
          <h2>Próximos passos</h2>
          <ul>
            <li>Validar objetivo e critérios de decisão do cliente (10–15 min).</li>
            <li>Confirmar dados do ativo/zona e recolher informação crítica (documentos, comparáveis, restrições).</li>
            <li>Alinhar estratégia e calendarização (marketing, posicionamento, negociação).</li>
            <li><strong>CTA final:</strong> ${htmlEscape(cta)}.</li>
          </ul>
        </div>
      `;
    }

    const html = `
      <!doctype html>
      <html>
        <head>
          <meta charset="utf-8">
          <title>${htmlEscape(title)}</title>
          ${styles}
        </head>
        <body>
          <div class="page">
            <div class="top">
              <div>
                <div class="brand">Garvetur Luxury Porto</div>
                <div class="h1">Relatório para Cliente</div>
                <span class="tag">${htmlEscape(confTag)}</span>
              </div>
              <div class="meta">
                <div><strong>Cliente:</strong> ${htmlEscape(cliente.nome||'—')}</div>
                <div><strong>Data:</strong> ${htmlEscape(toPTDate(report.updatedAt||report.createdAt||todayISO()))}</div>
                <div><strong>Formato:</strong> ${detalhe==='full'?'Completo':'Executivo'}</div>
              </div>
            </div>

            ${use('exec') ? blockResumoExec() : ''}
            ${use('contexto') ? blockContexto() : ''}
            ${use('mercado') ? blockMercado() : ''}
            ${use('cenarios') ? blockCenarios() : ''}
            ${use('plano') ? blockPlano() : ''}

            <div class="foot">
              <span>${htmlEscape(confTag)} · Uso interno / cliente · Não distribuir sem autorização.</span>
              <span>Gerado em ${htmlEscape(toPTDate(todayISO()))}</span>
            </div>
          </div>
        </body>
      </html>
    `;

    printHTMLInFrame(html);
  }

  /* ===========================
     List Actions + Export
  =========================== */
  reportsTbody.addEventListener('click', async (e)=>{
    const btn = e.target.closest('button[data-act]');
    if(!btn) return;
    const act = btn.dataset.act;
    const id = btn.dataset.id;

    if(act==='open'){
      const r = getReport(id);
      if(!r) return;
      fillForm(r);
      setTab('wizard');
      setStep(1);
      return;
    }

    if(act==='duplicate'){
      const r = getReport(id);
      if(!r) return;
      const copy = JSON.parse(JSON.stringify(r));
      copy.id = uid('rpt');
      copy.createdAt = todayISO();
      copy.updatedAt = todayISO();
      copy.status = 'draft';
      upsertReport(copy);
      renderList();
      return;
    }

    if(act==='delete'){
      if(!confirm('Remover este relatório? (esta ação não pode ser desfeita)')) return;
      const r = getReport(id);
      if(r?.pdfs?.length){
        for(const p of r.pdfs){
          if(p.key) { try{ await idbDelPDF(p.key); }catch{} }
        }
      }
      deleteReport(id);
      renderList();
      return;
    }

    if(act==='export'){
      const r = getReport(id);
      if(!r) return;
      exportReportToPrintPDF(r, false);
      return;
    }
  });

  btnApply?.addEventListener('click', renderList);
  btnClear?.addEventListener('click', ()=>{
    q.value = '';
    fStatus.value = '';
    fTipo.value = '';
    fDataDe.value = '';
    fDataAte.value = '';
    fConfidencial.checked = false;
    renderList();
  });

  /* ===========================
     Export Buttons
  =========================== */
  btnBuildPdf?.addEventListener('click', ()=>{
    const r = saveDraft();
    exportReportToPrintPDF(r, false);
  });

  btnBuildExec?.addEventListener('click', ()=>{
    const r = saveDraft();
    exportReportToPrintPDF(r, true);
  });

  btnDuplicate?.addEventListener('click', ()=>{
    const r = saveDraft();
    const copy = JSON.parse(JSON.stringify(r));
    copy.id = uid('rpt');
    copy.createdAt = todayISO();
    copy.updatedAt = todayISO();
    copy.status = 'draft';
    upsertReport(copy);
    renderList();
    alert('Template duplicado. Pode abrir a cópia na lista.');
  });

  /* ===========================
     Tabs + init
  =========================== */
  tabList?.addEventListener('click', ()=>setTab('list'));
  tabWizard?.addEventListener('click', ()=>setTab('wizard'));

  // Toggle imovel vs zona
  const assetImovel = el('assetImovel');
  const assetZona = el('assetZona');
  Array.from(document.querySelectorAll('input[name="assetMode"]')).forEach(r=>{
    r.addEventListener('change', ()=>{
      const v = document.querySelector('input[name="assetMode"]:checked')?.value;
      assetImovel.classList.toggle('hidden', v !== 'imovel');
      assetZona.classList.toggle('hidden', v !== 'zona');
    });
  });

  setTab('list');
  setStep(1);
  renderList();

})();
</script>
</body>
</html>
