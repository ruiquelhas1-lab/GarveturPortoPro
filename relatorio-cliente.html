<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Garvetur Porto Pro — Relatório Cliente (Admin) v11 — Fase 2.2 (PDF Final Premium)</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root{
      --bg:#0b0e12;
      --card:#101622;
      --card2:#0f141d;
      --text:#e9eef7;
      --muted:#a9b4c7;
      --line:#22304a;
      --gold:#A38B63;
      --danger:#ff5b5b;
      --ok:#4ade80;
      --warn:#fbbf24;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius:18px;
      --radius2:14px;
      --pad:14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f6f7fb;
        --card:#ffffff;
        --card2:#fafbff;
        --text:#121826;
        --muted:#5b6476;
        --line:#e6e9f2;
        --shadow: 0 12px 30px rgba(12,18,38,.12);
      }
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--sans);
      background: radial-gradient(1200px 600px at 20% -10%, rgba(163,139,99,.25), transparent 50%),
                  radial-gradient(900px 500px at 90% 0%, rgba(80,140,255,.18), transparent 55%),
                  var(--bg);
      color:var(--text);
      min-height:100vh;
    }
    header{
      position:sticky; top:0; z-index:20;
      backdrop-filter: blur(10px);
      background: color-mix(in srgb, var(--bg) 82%, transparent);
      border-bottom:1px solid var(--line);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:14px 16px}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand{display:flex;align-items:center;gap:12px}
    .mark{
      width:36px;height:36px;border-radius:12px;
      background: linear-gradient(135deg, rgba(163,139,99,.95), rgba(163,139,99,.35));
      box-shadow: 0 10px 18px rgba(163,139,99,.18);
      border:1px solid color-mix(in srgb, var(--gold) 60%, var(--line));
    }
    .brand h1{font-size:15px;margin:0;letter-spacing:.2px}
    .brand .sub{font-size:12px;color:var(--muted);margin-top:2px}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      font-size:12px; padding:7px 10px;border-radius:999px;
      border:1px solid var(--line); background:color-mix(in srgb, var(--card) 75%, transparent);
      color:var(--muted);
    }
    .pill b{color:var(--text);font-weight:600}
    nav{
      margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;
    }
    .tab{
      border:1px solid var(--line);
      background: color-mix(in srgb, var(--card) 70%, transparent);
      color:var(--muted);
      padding:10px 12px;border-radius:999px;
      cursor:pointer; user-select:none;
      transition: transform .06s ease, background .15s ease, color .15s ease, border-color .15s ease;
      font-size:13px;
    }
    .tab:hover{transform: translateY(-1px)}
    .tab.active{
      color:var(--text);
      border-color: color-mix(in srgb, var(--gold) 55%, var(--line));
      background: linear-gradient(180deg, color-mix(in srgb, var(--gold) 20%, var(--card)),
                                        color-mix(in srgb, var(--card) 85%, transparent));
    }

    main{padding:18px 0 28px}
    .grid{display:grid;grid-template-columns: 380px 1fr;gap:16px}
    @media (max-width: 980px){.grid{grid-template-columns:1fr}}

    .card{
      border:1px solid var(--line);
      background: linear-gradient(180deg, color-mix(in srgb, var(--card) 92%, transparent), var(--card2));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--line);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .card .hd h2{margin:0;font-size:14px;letter-spacing:.2px}
    .card .hd .meta{font-size:12px;color:var(--muted)}
    .card .bd{padding:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .row > *{flex: 1 1 auto}
    .btn{
      appearance:none; border:1px solid var(--line);
      background: color-mix(in srgb, var(--card) 86%, transparent);
      color:var(--text);
      padding:10px 12px;border-radius:12px;
      cursor:pointer; font-size:13px;
      transition: transform .06s ease, filter .15s ease, border-color .15s ease;
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      min-height:40px;
    }
    .btn:hover{transform: translateY(-1px); filter: brightness(1.03)}
    .btn:active{transform: translateY(0px)}
    .btn.primary{
      border-color: color-mix(in srgb, var(--gold) 55%, var(--line));
      background: linear-gradient(180deg, color-mix(in srgb, var(--gold) 25%, var(--card)),
                                        color-mix(in srgb, var(--card) 85%, transparent));
    }
    .btn.danger{border-color: color-mix(in srgb, var(--danger) 50%, var(--line))}
    .btn.ghost{background:transparent}
    .btn[disabled]{opacity:.55; cursor:not-allowed; transform:none}
    .input, textarea, select{
      width:100%;
      border:1px solid var(--line);
      background: color-mix(in srgb, var(--card) 80%, transparent);
      color:var(--text);
      border-radius:12px;
      padding:10px 11px;
      outline:none;
      font-size:13px;
      min-height:40px;
    }
    textarea{min-height:110px; resize:vertical}
    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px 2px}
    .field{margin-bottom:12px}
    .small{font-size:12px;color:var(--muted)}
    .kpi{display:flex;gap:10px;flex-wrap:wrap}
    .kpi .box{
      flex: 1 1 140px;
      padding:10px 12px; border:1px solid var(--line); border-radius:14px;
      background: color-mix(in srgb, var(--card) 70%, transparent);
    }
    .kpi .box .v{font-size:16px;font-weight:700;letter-spacing:.2px}
    .kpi .box .t{font-size:12px;color:var(--muted);margin-top:2px}
    .list{display:flex;flex-direction:column;gap:10px}
    .item{
      padding:12px;
      border:1px solid var(--line);
      background: color-mix(in srgb, var(--card) 70%, transparent);
      border-radius: var(--radius2);
      cursor:pointer;
      transition: transform .06s ease, border-color .15s ease;
    }
    .item:hover{transform: translateY(-1px)}
    .item.active{border-color: color-mix(in srgb, var(--gold) 55%, var(--line))}
    .item .title{font-size:13px;font-weight:700;margin:0 0 4px}
    .item .meta{font-size:12px;color:var(--muted);display:flex;justify-content:space-between;gap:10px}
    .badge{
      display:inline-flex;align-items:center;gap:8px;
      padding:5px 8px;border-radius:999px;
      border:1px solid var(--line);
      font-size:12px;color:var(--muted);
      background: color-mix(in srgb, var(--card) 78%, transparent);
      white-space:nowrap;
    }
    .badge.gold{border-color: color-mix(in srgb, var(--gold) 55%, var(--line)); color: color-mix(in srgb, var(--gold) 75%, var(--text))}
    .badge.ok{border-color: color-mix(in srgb, var(--ok) 45%, var(--line)); color: color-mix(in srgb, var(--ok) 70%, var(--text))}
    .badge.warn{border-color: color-mix(in srgb, var(--warn) 55%, var(--line)); color: color-mix(in srgb, var(--warn) 70%, var(--text))}

    /* Wizard */
    .wizard{display:flex;flex-direction:column;gap:12px}
    .steps{
      display:flex;gap:8px;flex-wrap:wrap;
      padding:12px 14px;border-bottom:1px solid var(--line);
      background: color-mix(in srgb, var(--card) 72%, transparent);
    }
    .step{
      display:inline-flex;align-items:center;gap:10px;
      padding:10px 12px;border-radius:14px;border:1px solid var(--line);
      background: color-mix(in srgb, var(--card) 80%, transparent);
      color:var(--muted); font-size:13px; cursor:pointer;
      user-select:none;
    }
    .step .n{
      width:22px;height:22px;border-radius:999px;
      display:inline-flex;align-items:center;justify-content:center;
      border:1px solid var(--line);
      font-family:var(--mono);font-size:12px;
      color:var(--muted);
    }
    .step.active{
      color:var(--text);
      border-color: color-mix(in srgb, var(--gold) 55%, var(--line));
      background: linear-gradient(180deg, color-mix(in srgb, var(--gold) 16%, var(--card)),
                                        color-mix(in srgb, var(--card) 88%, transparent));
    }
    .step.active .n{border-color: color-mix(in srgb, var(--gold) 55%, var(--line)); color:var(--text)}
    .panel{padding:14px}
    .panel h3{margin:0 0 10px;font-size:14px}
    .split{display:grid;grid-template-columns: 1fr 1fr; gap:12px}
    @media (max-width: 980px){.split{grid-template-columns:1fr}}

    /* Step 5 centered container */
    .step5center{
      display:flex;
      justify-content:center;
      padding: 10px 0 0;
    }
    .step5box{
      width:min(900px, 100%);
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: linear-gradient(180deg, color-mix(in srgb, var(--card) 92%, transparent), var(--card2));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .step5box .hd{padding:14px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center;gap:10px}
    .step5box .bd{padding:14px}
    .hr{height:1px;background:var(--line);margin:12px 0}
    .note{
      border:1px dashed color-mix(in srgb, var(--gold) 40%, var(--line));
      background: color-mix(in srgb, var(--gold) 10%, transparent);
      padding:10px 12px;border-radius:14px;
      color:var(--muted);
      font-size:12px;
    }

    /* Modal */
    .modalBack{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center;
      z-index:50;
      padding:18px;
    }
    .modal{
      width:min(1000px, 100%);
      height:min(760px, 100%);
      border-radius: 18px;
      background: var(--card);
      border:1px solid var(--line);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex; flex-direction:column;
    }
    .modal .mh{
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .modal .mh h4{margin:0;font-size:14px}
    .modal .mb{
      flex:1; background: color-mix(in srgb, var(--bg) 60%, transparent);
    }
    .modal iframe{width:100%;height:100%;border:0;background:white}
    .toast{
      position:fixed; right:16px; bottom:16px;
      max-width: 420px;
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: color-mix(in srgb, var(--card) 88%, transparent);
      box-shadow: var(--shadow);
      display:none;
      z-index:60;
      font-size:13px;
      color:var(--text);
    }
    .toast .mut{color:var(--muted);font-size:12px;margin-top:3px}
    .muted{color:var(--muted)}
    .right{justify-content:flex-end}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="mark" aria-hidden="true"></div>
        <div>
          <h1>Garvetur Luxury Porto — Relatório Cliente (Admin)</h1>
          <div class="sub">v11 · Fase 2.2 — PDF Final Premium (estável, assistido, sem parsing automático de PDF)</div>
        </div>
      </div>
      <div class="pill"><span>Estado:</span> <b id="statePill">Pronto</b></div>
    </div>
    <nav>
      <div class="tab active" data-tab="relatorios">Relatórios</div>
      <div class="tab" data-tab="leads">Leads</div>
      <div class="tab" data-tab="fsbo">FSBO</div>
      <div class="tab" data-tab="angariacoes">Angariações</div>
      <div class="tab" data-tab="config">Configuração</div>
    </nav>
  </div>
</header>

<main class="wrap">
  <div id="view-relatorios" class="grid">
    <!-- Left: list -->
    <section class="card">
      <div class="hd">
        <div>
          <h2>Lista de Relatórios</h2>
          <div class="meta">Selecione um relatório para abrir o wizard.</div>
        </div>
        <span class="badge gold" id="countReports">0</span>
      </div>
      <div class="bd">
        <div class="row" style="margin-bottom:12px">
          <button class="btn primary" id="btnNew">+ Novo Relatório</button>
          <button class="btn" id="btnDup" title="Duplicar o relatório selecionado">Duplicar</button>
          <button class="btn danger" id="btnDel" title="Eliminar o relatório selecionado">Eliminar</button>
        </div>
        <div class="field">
          <label>Pesquisa</label>
          <input class="input" id="search" placeholder="Nome do cliente / consultor / estado…" />
        </div>
        <div class="kpi" style="margin-bottom:12px">
          <div class="box"><div class="v" id="kpiDraft">0</div><div class="t">Em rascunho</div></div>
          <div class="box"><div class="v" id="kpiReady">0</div><div class="t">Prontos p/ PDF</div></div>
          <div class="box"><div class="v" id="kpiPdf">0</div><div class="t">PDF gerado</div></div>
        </div>
        <div id="list" class="list"></div>
        <div class="hr"></div>
        <div class="note">
          <b>Nota de estabilidade:</b> Nesta Fase 2.2 o PDF pode ser anexado como referência visual, mas não é interpretado automaticamente no browser (evita bloqueios).
        </div>
      </div>
    </section>

    <!-- Right: wizard -->
    <section class="card">
      <div class="hd">
        <div>
          <h2>Wizard do Relatório</h2>
          <div class="meta" id="wizMeta">Selecione um relatório à esquerda.</div>
        </div>
        <span class="badge" id="wizBadge">—</span>
      </div>
      <div class="wizard">
        <div class="steps" id="stepsBar" aria-label="Passos do wizard">
          <div class="step active" data-step="1"><span class="n">1</span>Cliente</div>
          <div class="step" data-step="2"><span class="n">2</span>Contexto</div>
          <div class="step" data-step="3"><span class="n">3</span>Inputs Consultor</div>
          <div class="step" data-step="4"><span class="n">4</span>Estudo / PDF</div>
          <div class="step" data-step="5"><span class="n">5</span>PDF Final Premium</div>
        </div>

        <div class="panel" id="panel-1"></div>
        <div class="panel" id="panel-2" style="display:none"></div>
        <div class="panel" id="panel-3" style="display:none"></div>
        <div class="panel" id="panel-4" style="display:none"></div>
        <div class="panel" id="panel-5" style="display:none"></div>
      </div>
    </section>
  </div>

  <!-- Placeholder views -->
  <div id="view-leads" style="display:none">
    <section class="card">
      <div class="hd"><h2>Leads</h2><div class="meta">Módulo estável (placeholder). Integração completa poderá ser feita sem afetar a Fase 2.2.</div></div>
      <div class="bd">
        <div class="note">Este separador mantém o espaço funcional, mas o foco desta entrega é o fecho do módulo <b>Relatório Cliente</b> com <b>PDF Final Premium</b>.</div>
      </div>
    </section>
  </div>

  <div id="view-fsbo" style="display:none">
    <section class="card">
      <div class="hd"><h2>FSBO</h2><div class="meta">Módulo estável (placeholder).</div></div>
      <div class="bd"><div class="note">Placeholder funcional.</div></div>
    </section>
  </div>

  <div id="view-angariacoes" style="display:none">
    <section class="card">
      <div class="hd"><h2>Angariações</h2><div class="meta">Módulo estável (placeholder).</div></div>
      <div class="bd"><div class="note">Placeholder funcional.</div></div>
    </section>
  </div>

  <div id="view-config" style="display:none">
    <section class="card">
      <div class="hd"><h2>Configuração</h2><div class="meta">Definições locais do utilizador (guardadas no browser).</div></div>
      <div class="bd">
        <div class="split">
          <div>
            <div class="field">
              <label>Assinatura (nome do consultor)</label>
              <input class="input" id="cfgSignature" placeholder="Ex.: Rui Quelhas" />
            </div>
            <div class="field">
              <label>Email do consultor</label>
              <input class="input" id="cfgEmail" placeholder="ex.: rui@garvetur.pt" />
            </div>
            <button class="btn primary" id="cfgSave">Guardar</button>
          </div>
          <div>
            <div class="note">
              <b>Recomendação:</b> Configure aqui o nome e email do consultor para preencher automaticamente o PDF.
              <div class="muted" style="margin-top:6px">Estes dados ficam apenas no seu browser (localStorage).</div>
            </div>
            <div class="hr"></div>
            <button class="btn danger" id="cfgReset">Repor dados locais (perigoso)</button>
          </div>
        </div>
      </div>
    </section>
  </div>
</main>

<!-- Modal PDF Preview -->
<div class="modalBack" id="pdfModalBack" role="dialog" aria-modal="true" aria-label="Pré-visualização do PDF">
  <div class="modal">
    <div class="mh">
      <h4>Pré-visualização — PDF Final Premium</h4>
      <div class="row right" style="gap:8px;flex-wrap:nowrap">
        <button class="btn" id="btnPdfDownload">Download</button>
        <button class="btn ghost" id="btnPdfClose">Fechar</button>
      </div>
    </div>
    <div class="mb"><iframe id="pdfFrame" title="PDF preview"></iframe></div>
  </div>
</div>

<div class="toast" id="toast">
  <div id="toastMsg">—</div>
  <div class="mut" id="toastSub">—</div>
</div>

<!-- jsPDF (client-side PDF generation) -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" crossorigin="anonymous"></script>

<script>
/* =========================
   Storage & IndexedDB (PDF attachment)
   ========================= */
const LS_KEY = "glp_reports_v11_phase2_2";
const LS_CFG = "glp_config_v11";
const DB_NAME = "glp_reports_db";
const DB_STORE = "pdfs";
const DB_VER = 1;

function nowISO(){ return new Date().toISOString(); }
function uid(){ return "r_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16); }

function toast(msg, sub=""){
  const t = document.getElementById("toast");
  document.getElementById("toastMsg").textContent = msg;
  document.getElementById("toastSub").textContent = sub || "";
  t.style.display = "block";
  clearTimeout(toast._tm);
  toast._tm = setTimeout(()=> t.style.display="none", 3200);
}

function setStatePill(text, kind=""){
  const el = document.getElementById("statePill");
  el.textContent = text;
  el.style.color = kind==="ok" ? "var(--ok)" : (kind==="warn" ? "var(--warn)" : "");
}

function loadCfg(){
  try{ return JSON.parse(localStorage.getItem(LS_CFG) || "{}"); }catch(e){ return {}; }
}
function saveCfg(cfg){
  localStorage.setItem(LS_CFG, JSON.stringify(cfg||{}));
}

function loadData(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return [];
    const data = JSON.parse(raw);
    if(Array.isArray(data)) return data;
    return [];
  }catch(e){ return []; }
}
function saveData(data){
  localStorage.setItem(LS_KEY, JSON.stringify(data));
}

/* IndexedDB minimal wrapper */
function idbOpen(){
  return new Promise((resolve, reject)=>{
    const req = indexedDB.open(DB_NAME, DB_VER);
    req.onupgradeneeded = (ev)=>{
      const db = req.result;
      if(!db.objectStoreNames.contains(DB_STORE)){
        db.createObjectStore(DB_STORE);
      }
    };
    req.onsuccess = ()=> resolve(req.result);
    req.onerror = ()=> reject(req.error);
  });
}
async function idbSet(key, value){
  const db = await idbOpen();
  return new Promise((resolve, reject)=>{
    const tx = db.transaction(DB_STORE, "readwrite");
    tx.objectStore(DB_STORE).put(value, key);
    tx.oncomplete = ()=>{ db.close(); resolve(true); };
    tx.onerror = ()=>{ db.close(); reject(tx.error); };
  });
}
async function idbGet(key){
  const db = await idbOpen();
  return new Promise((resolve, reject)=>{
    const tx = db.transaction(DB_STORE, "readonly");
    const req = tx.objectStore(DB_STORE).get(key);
    req.onsuccess = ()=>{ const v = req.result; db.close(); resolve(v); };
    req.onerror = ()=>{ db.close(); reject(req.error); };
  });
}
async function idbDel(key){
  const db = await idbOpen();
  return new Promise((resolve, reject)=>{
    const tx = db.transaction(DB_STORE, "readwrite");
    tx.objectStore(DB_STORE).delete(key);
    tx.oncomplete = ()=>{ db.close(); resolve(true); };
    tx.onerror = ()=>{ db.close(); reject(tx.error); };
  });
}

/* =========================
   App State
   ========================= */
let reports = loadData();
let activeId = null;
let activeStep = 1;
let lastPdfBlob = null;
let lastPdfFilename = null;

function seedIfEmpty(){
  if(reports.length) return;
  reports = [{
    id: uid(),
    createdAt: nowISO(),
    updatedAt: nowISO(),
    status: "RASCUNHO", // RASCUNHO | PRONTO | PDF_GERADO
    client: {
      nome: "Cliente Exemplo",
      email: "cliente@exemplo.com",
      telefone: "+351 9XX XXX XXX",
      perfil: "Investidor / Residencial",
      objetivo: "Compra",
      zona: "Porto / Foz / Boavista",
      budget: "—",
      prazo: "—"
    },
    contexto: {
      origem: "Contacto direto / Referência",
      notas: "Resumo do contexto e do enquadramento do cliente."
    },
    consultor: {
      nome: "",
      email: "",
      inputs: "Registe aqui os inputs do consultor (necessidades, objeções, critérios, preferências)."
    },
    estudo: {
      modo: "IGNORAR", // COLAR | PDF | IGNORAR
      textoColado: "",
      estruturado: { titulos:[], blocos:[], insights:[] },
      pdfKey: null,
      pdfName: null
    },
    recomendacao: {
      analise: "Análise & Recomendação Garvetur (tom formal / executivo).",
      proximosPassos: "Próximos passos sugeridos (ex.: shortlist, visitas, negociação, documentação)."
    },
    pdf: {
      lastGeneratedAt: null,
      lastFilename: null
    }
  }];
  saveData(reports);
}
seedIfEmpty();

/* =========================
   UI helpers
   ========================= */
const $ = (s, r=document)=> r.querySelector(s);
const $$ = (s, r=document)=> Array.from(r.querySelectorAll(s));

function fmtDate(iso){
  try{
    const d = new Date(iso);
    return d.toLocaleString("pt-PT", { year:"numeric", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit"});
  }catch(e){ return "—"; }
}

function calcKpi(){
  const draft = reports.filter(r=>r.status==="RASCUNHO").length;
  const ready = reports.filter(r=>r.status==="PRONTO").length;
  const pdf = reports.filter(r=>r.status==="PDF_GERADO").length;
  $("#kpiDraft").textContent = draft;
  $("#kpiReady").textContent = ready;
  $("#kpiPdf").textContent = pdf;
  $("#countReports").textContent = reports.length;
}

function badgeForStatus(st){
  if(st==="PDF_GERADO") return `<span class="badge ok">PDF gerado</span>`;
  if(st==="PRONTO") return `<span class="badge warn">Pronto p/ PDF</span>`;
  return `<span class="badge">Rascunho</span>`;
}

/* =========================
   Tabs (no blocking)
   ========================= */
$$(".tab").forEach(t=>{
  t.addEventListener("click", ()=>{
    $$(".tab").forEach(x=>x.classList.remove("active"));
    t.classList.add("active");
    const tab = t.dataset.tab;
    ["relatorios","leads","fsbo","angariacoes","config"].forEach(k=>{
      const v = document.getElementById("view-"+k);
      if(v) v.style.display = (k===tab) ? "" : "none";
    });
  });
});

/* =========================
   List rendering
   ========================= */
function renderList(){
  const q = ($("#search").value || "").toLowerCase().trim();
  const list = $("#list");
  list.innerHTML = "";
  const filtered = reports
    .slice()
    .sort((a,b)=> (b.updatedAt||"").localeCompare(a.updatedAt||""))
    .filter(r=>{
      const hay = [
        r.client?.nome, r.consultor?.nome, r.status,
        r.client?.zona, r.client?.perfil, r.client?.objetivo
      ].join(" ").toLowerCase();
      return !q || hay.includes(q);
    });

  if(!filtered.length){
    list.innerHTML = `<div class="note">Sem resultados. Crie um novo relatório ou altere a pesquisa.</div>`;
    calcKpi();
    return;
  }

  for(const r of filtered){
    const div = document.createElement("div");
    div.className = "item" + (r.id===activeId ? " active" : "");
    const metaLeft = `${r.client?.perfil || "—"} · ${r.client?.objetivo || "—"} · ${r.client?.zona || "—"}`;
    const metaRight = fmtDate(r.updatedAt || r.createdAt);
    div.innerHTML = `
      <div class="title">${escapeHtml(r.client?.nome || "Sem nome")}</div>
      <div class="meta">
        <span>${escapeHtml(metaLeft)}</span>
        <span>${metaRight}</span>
      </div>
      <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:space-between">
        ${badgeForStatus(r.status)}
        <span class="badge gold">ID: <span style="font-family:var(--mono)">${r.id.slice(0,8)}</span></span>
      </div>
    `;
    div.addEventListener("click", ()=>{
      activeId = r.id;
      activeStep = 1;
      renderList();
      renderWizard();
    });
    list.appendChild(div);
  }
  calcKpi();
}

function escapeHtml(s){
  return (s||"").replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
}

$("#search").addEventListener("input", renderList);

/* =========================
   CRUD buttons
   ========================= */
$("#btnNew").addEventListener("click", ()=>{
  const cfg = loadCfg();
  const r = {
    id: uid(),
    createdAt: nowISO(),
    updatedAt: nowISO(),
    status:"RASCUNHO",
    client:{ nome:"Novo Cliente", email:"", telefone:"", perfil:"", objetivo:"", zona:"", budget:"", prazo:"" },
    contexto:{ origem:"", notas:"" },
    consultor:{ nome: cfg.signature||"", email: cfg.email||"", inputs:"" },
    estudo:{ modo:"IGNORAR", textoColado:"", estruturado:{titulos:[],blocos:[],insights:[]}, pdfKey:null, pdfName:null },
    recomendacao:{ analise:"", proximosPassos:"" },
    pdf:{ lastGeneratedAt:null, lastFilename:null }
  };
  reports.unshift(r);
  activeId = r.id;
  activeStep = 1;
  saveData(reports);
  renderList();
  renderWizard();
  toast("Relatório criado", "Pode avançar no wizard e gerar o PDF no passo 5.");
});

$("#btnDup").addEventListener("click", ()=>{
  const r = getActive();
  if(!r){ toast("Selecione um relatório", "Nada foi duplicado."); return; }
  const copy = JSON.parse(JSON.stringify(r));
  copy.id = uid();
  copy.createdAt = nowISO();
  copy.updatedAt = nowISO();
  copy.status = "RASCUNHO";
  copy.pdf = { lastGeneratedAt:null, lastFilename:null };
  // PDF attachment: keep reference, but new key to avoid accidental overwrite
  if(copy.estudo?.pdfKey){
    copy.estudo.pdfKey = null;
    copy.estudo.pdfName = null;
  }
  reports.unshift(copy);
  activeId = copy.id;
  activeStep = 1;
  saveData(reports);
  renderList();
  renderWizard();
  toast("Relatório duplicado", "O anexo PDF não foi copiado por segurança.");
});

$("#btnDel").addEventListener("click", async ()=>{
  const r = getActive();
  if(!r){ toast("Selecione um relatório", "Nada foi eliminado."); return; }
  const ok = confirm("Confirma a eliminação deste relatório? Esta ação é irreversível.");
  if(!ok) return;
  // delete attached PDF from IndexedDB if any
  if(r.estudo?.pdfKey){
    try{ await idbDel(r.estudo.pdfKey); }catch(e){}
  }
  reports = reports.filter(x=>x.id!==r.id);
  if(activeId===r.id) activeId = reports[0]?.id || null;
  saveData(reports);
  renderList();
  renderWizard();
  toast("Relatório eliminado", "Dados removidos do storage local.");
});

function getActive(){
  return reports.find(r=>r.id===activeId) || null;
}
function patchActive(patcher){
  const idx = reports.findIndex(r=>r.id===activeId);
  if(idx<0) return;
  const r = reports[idx];
  patcher(r);
  r.updatedAt = nowISO();
  reports[idx] = r;
  saveData(reports);
  renderList();
  renderWizardMetaOnly();
}

function renderWizardMetaOnly(){
  const r = getActive();
  if(!r){
    $("#wizMeta").textContent = "Selecione um relatório à esquerda.";
    $("#wizBadge").textContent = "—";
    return;
  }
  $("#wizMeta").textContent = `${r.client?.nome || "Sem nome"} · atualizado em ${fmtDate(r.updatedAt)}`;
  $("#wizBadge").textContent = r.status || "—";
}

/* =========================
   Wizard navigation
   ========================= */
$("#stepsBar").addEventListener("click", (ev)=>{
  const stepEl = ev.target.closest(".step");
  if(!stepEl) return;
  if(!getActive()){ toast("Selecione um relatório", "Depois use os passos do wizard."); return; }
  activeStep = Number(stepEl.dataset.step || 1);
  renderWizard();
});

function setActiveStepUI(){
  $$(".step").forEach(s=>{
    s.classList.toggle("active", Number(s.dataset.step)===activeStep);
  });
  for(let i=1;i<=5;i++){
    const p = document.getElementById("panel-"+i);
    if(p) p.style.display = (i===activeStep) ? "" : "none";
  }
}

/* =========================
   Panels content
   ========================= */
function renderWizard(){
  setActiveStepUI();
  const r = getActive();
  renderWizardMetaOnly();

  if(!r){
    // show empty panels minimal
    for(let i=1;i<=5;i++){
      const p = $("#panel-"+i);
      p.innerHTML = `<div class="note">Selecione um relatório na lista para começar.</div>`;
    }
    return;
  }

  renderPanel1(r);
  renderPanel2(r);
  renderPanel3(r);
  renderPanel4(r);
  renderPanel5(r);

  // update readiness
  computeReadiness(r);
}

function computeReadiness(r){
  // Minimal criteria to be PRONTO:
  const hasClient = (r.client?.nome || "").trim().length>=2;
  const hasConsultor = (r.consultor?.nome || "").trim().length>=2;
  const hasRecomendacao = (r.recomendacao?.analise || "").trim().length>=10;
  const ready = hasClient && hasConsultor && hasRecomendacao;
  const newStatus = (r.status==="PDF_GERADO") ? "PDF_GERADO" : (ready ? "PRONTO" : "RASCUNHO");
  if(newStatus !== r.status){
    r.status = newStatus;
    r.updatedAt = nowISO();
    saveData(reports);
    renderList();
    renderWizardMetaOnly();
  }
}

function renderPanel1(r){
  const p = $("#panel-1");
  p.innerHTML = `
    <h3>1) Cliente</h3>
    <div class="split">
      <div>
        <div class="field"><label>Nome do cliente</label><input class="input" id="c_nome" value="${escapeHtml(r.client?.nome||"")}" /></div>
        <div class="field"><label>Email</label><input class="input" id="c_email" value="${escapeHtml(r.client?.email||"")}" /></div>
        <div class="field"><label>Telefone</label><input class="input" id="c_tel" value="${escapeHtml(r.client?.telefone||"")}" /></div>
        <div class="field"><label>Perfil</label><input class="input" id="c_perfil" placeholder="Ex.: Investidor / Residencial / Corporate" value="${escapeHtml(r.client?.perfil||"")}" /></div>
      </div>
      <div>
        <div class="field"><label>Objetivo</label>
          <select id="c_obj" class="input">
            ${["","Compra","Venda","Arrendamento","Investimento"].map(v=>`<option ${((r.client?.objetivo||"")==v)?"selected":""}>${v}</option>`).join("")}
          </select>
        </div>
        <div class="field"><label>Zona / Localização</label><input class="input" id="c_zona" value="${escapeHtml(r.client?.zona||"")}" /></div>
        <div class="field"><label>Budget (opcional)</label><input class="input" id="c_budget" value="${escapeHtml(r.client?.budget||"")}" /></div>
        <div class="field"><label>Prazo (opcional)</label><input class="input" id="c_prazo" value="${escapeHtml(r.client?.prazo||"")}" /></div>
      </div>
    </div>
    <div class="row right">
      <button class="btn primary" id="p1_next">Seguinte →</button>
    </div>
  `;
  $("#p1_next").onclick = ()=>{ activeStep=2; renderWizard(); };
  // Bind
  const bind = (id, path)=>{
    const el = document.getElementById(id);
    el.addEventListener("input", ()=>{
      patchActive(rep=>{
        const [a,b] = path.split(".");
        rep[a][b] = el.value;
      });
    });
  };
  bind("c_nome","client.nome");
  bind("c_email","client.email");
  bind("c_tel","client.telefone");
  bind("c_perfil","client.perfil");
  $("#c_obj").addEventListener("change", ()=> patchActive(rep=> rep.client.objetivo = $("#c_obj").value ));
  bind("c_zona","client.zona");
  bind("c_budget","client.budget");
  bind("c_prazo","client.prazo");
}

function renderPanel2(r){
  const p = $("#panel-2");
  p.innerHTML = `
    <h3>2) Contexto</h3>
    <div class="split">
      <div>
        <div class="field">
          <label>Origem do contacto</label>
          <input class="input" id="ctx_origem" placeholder="Ex.: Referência / Campanha / Walk-in / Parceiro" value="${escapeHtml(r.contexto?.origem||"")}" />
        </div>
        <div class="field">
          <label>Notas de enquadramento</label>
          <textarea id="ctx_notas" class="input" placeholder="Resumo objetivo do contexto.">${escapeHtml(r.contexto?.notas||"")}</textarea>
        </div>
      </div>
      <div>
        <div class="note">
          O objetivo é garantir um relatório <b>executivo</b> e orientado a decisão: contexto, critérios e proposta Garvetur.
          <div class="muted" style="margin-top:6px">Evite excesso de texto; foque o essencial e os próximos passos.</div>
        </div>
      </div>
    </div>
    <div class="row" style="justify-content:space-between">
      <button class="btn" id="p2_prev">← Anterior</button>
      <button class="btn primary" id="p2_next">Seguinte →</button>
    </div>
  `;
  $("#p2_prev").onclick = ()=>{ activeStep=1; renderWizard(); };
  $("#p2_next").onclick = ()=>{ activeStep=3; renderWizard(); };
  $("#ctx_origem").addEventListener("input", ()=> patchActive(rep=> rep.contexto.origem = $("#ctx_origem").value ));
  $("#ctx_notas").addEventListener("input", ()=> patchActive(rep=> rep.contexto.notas = $("#ctx_notas").value ));
}

function renderPanel3(r){
  const p = $("#panel-3");
  p.innerHTML = `
    <h3>3) Inputs do Consultor</h3>
    <div class="split">
      <div>
        <div class="field"><label>Consultor</label><input class="input" id="co_nome" placeholder="Nome do consultor" value="${escapeHtml(r.consultor?.nome||"")}" /></div>
        <div class="field"><label>Email do consultor</label><input class="input" id="co_email" placeholder="Email" value="${escapeHtml(r.consultor?.email||"")}" /></div>
        <div class="field">
          <label>Inputs (necessidades, preferências, objeções)</label>
          <textarea id="co_inputs" class="input" placeholder="Registe inputs de forma clara e objetiva.">${escapeHtml(r.consultor?.inputs||"")}</textarea>
        </div>
      </div>
      <div>
        <div class="field">
          <label>Análise & Recomendação Garvetur</label>
          <textarea id="rec_analise" class="input" placeholder="Posicionamento profissional Garvetur, com tom formal e executivo.">${escapeHtml(r.recomendacao?.analise||"")}</textarea>
        </div>
        <div class="field">
          <label>Próximos passos</label>
          <textarea id="rec_passos" class="input" placeholder="Ex.: shortlist, visitas, validação financeira, proposta, documentação.">${escapeHtml(r.recomendacao?.proximosPassos||"")}</textarea>
        </div>
      </div>
    </div>
    <div class="row" style="justify-content:space-between">
      <button class="btn" id="p3_prev">← Anterior</button>
      <button class="btn primary" id="p3_next">Seguinte →</button>
    </div>
  `;
  $("#p3_prev").onclick = ()=>{ activeStep=2; renderWizard(); };
  $("#p3_next").onclick = ()=>{ activeStep=4; renderWizard(); };
  $("#co_nome").addEventListener("input", ()=> patchActive(rep=> rep.consultor.nome = $("#co_nome").value ));
  $("#co_email").addEventListener("input", ()=> patchActive(rep=> rep.consultor.email = $("#co_email").value ));
  $("#co_inputs").addEventListener("input", ()=> patchActive(rep=> rep.consultor.inputs = $("#co_inputs").value ));
  $("#rec_analise").addEventListener("input", ()=> patchActive(rep=> rep.recomendacao.analise = $("#rec_analise").value ));
  $("#rec_passos").addEventListener("input", ()=> patchActive(rep=> rep.recomendacao.proximosPassos = $("#rec_passos").value ));
}

function renderPanel4(r){
  const p = $("#panel-4");
  const modo = r.estudo?.modo || "IGNORAR";
  const hasStruct = (r.estudo?.estruturado?.titulos?.length || 0) + (r.estudo?.estruturado?.insights?.length || 0) > 0;
  p.innerHTML = `
    <h3>4) Estudo / PDF (assistido e estável)</h3>
    <div class="note" style="margin-bottom:12px">
      Nesta Fase 2.2 <b>não existe leitura automática de PDF</b> no browser (evita bloqueios). Pode colar texto, anexar PDF apenas como referência visual, ou ignorar o estudo.
    </div>

    <div class="field">
      <label>Modo</label>
      <select id="st_modo" class="input">
        <option value="COLAR" ${modo==="COLAR"?"selected":""}>a) Colar texto do estudo / relatório</option>
        <option value="PDF" ${modo==="PDF"?"selected":""}>b) Upload PDF (anexo visual)</option>
        <option value="IGNORAR" ${modo==="IGNORAR"?"selected":""}>c) Ignorar estudo</option>
      </select>
    </div>

    <div id="mode_COLAR" style="display:${modo==="COLAR"?"":"none"}">
      <div class="field">
        <label>Texto do estudo (colar)</label>
        <textarea id="st_texto" class="input" placeholder="Cole aqui o texto do estudo / relatório.">${escapeHtml(r.estudo?.textoColado||"")}</textarea>
      </div>
      <div class="row" style="margin-bottom:10px">
        <button class="btn primary" id="btnEstruturar">Estruturar conteúdo</button>
        <span class="badge ${hasStruct?"ok":""}">${hasStruct?"Estruturado":"Por estruturar"}</span>
      </div>
      <div class="split">
        <div>
          <div class="field">
            <label>Títulos / subtítulos</label>
            <textarea id="st_titulos" class="input" placeholder="(gerado)">${escapeHtml((r.estudo?.estruturado?.titulos||[]).join("\n"))}</textarea>
          </div>
          <div class="field">
            <label>Blocos relevantes</label>
            <textarea id="st_blocos" class="input" placeholder="(gerado)">${escapeHtml((r.estudo?.estruturado?.blocos||[]).join("\n\n"))}</textarea>
          </div>
        </div>
        <div>
          <div class="field">
            <label>Insights-chave (bullet points)</label>
            <textarea id="st_insights" class="input" placeholder="(gerado)">${escapeHtml((r.estudo?.estruturado?.insights||[]).map(x=>"• "+x).join("\n"))}</textarea>
          </div>
          <div class="note">
            Pode editar o conteúdo gerado antes de avançar para o PDF. O objetivo é obter uma síntese objetiva e executiva.
          </div>
        </div>
      </div>
    </div>

    <div id="mode_PDF" style="display:${modo==="PDF"?"":"none"}">
      <div class="field">
        <label>Anexar PDF (referência visual)</label>
        <input type="file" id="pdfFile" class="input" accept="application/pdf" />
        <div class="small" style="margin-top:8px">
          PDF atual: <b>${escapeHtml(r.estudo?.pdfName||"—")}</b>
        </div>
      </div>
      <div class="row">
        <button class="btn" id="btnAbrirAnexo" ${r.estudo?.pdfKey ? "" : "disabled"}>Abrir anexo</button>
        <button class="btn danger" id="btnRemoverAnexo" ${r.estudo?.pdfKey ? "" : "disabled"}>Remover anexo</button>
      </div>
      <div class="hr"></div>
      <div class="note">
        <b>Importante:</b> o PDF é guardado localmente (IndexedDB) e fica acessível no passo 5 como referência. Não é interpretado automaticamente.
      </div>
    </div>

    <div id="mode_IGNORAR" style="display:${modo==="IGNORAR"?"":"none"}">
      <div class="note">
        O relatório seguirá apenas com o histórico/contexto do cliente, inputs do consultor e recomendação Garvetur.
      </div>
    </div>

    <div class="row" style="justify-content:space-between; margin-top:12px">
      <button class="btn" id="p4_prev">← Anterior</button>
      <button class="btn primary" id="p4_next">Seguinte →</button>
    </div>
  `;

  $("#p4_prev").onclick = ()=>{ activeStep=3; renderWizard(); };
  $("#p4_next").onclick = ()=>{ activeStep=5; renderWizard(); };

  $("#st_modo").addEventListener("change", ()=>{
    const v = $("#st_modo").value;
    patchActive(rep=> rep.estudo.modo = v);
    renderWizard(); // safe, deterministic
  });

  // COLAR mode bindings
  if(modo==="COLAR"){
    $("#st_texto").addEventListener("input", ()=> patchActive(rep=> rep.estudo.textoColado = $("#st_texto").value ));
    $("#btnEstruturar").addEventListener("click", ()=>{
      const text = ($("#st_texto").value || "").trim();
      if(!text){ toast("Sem texto", "Cole o texto do estudo e volte a tentar."); return; }
      const out = structureText(text);
      patchActive(rep=> rep.estudo.estruturado = out);
      toast("Conteúdo estruturado", "Pode editar antes de avançar para o PDF.");
      // re-render panel 4 to reflect
      renderWizard();
      activeStep = 4;
      setActiveStepUI();
    });

    // allow manual edits to structured fields
    $("#st_titulos").addEventListener("input", ()=>{
      const lines = ($("#st_titulos").value||"").split("\n").map(s=>s.trim()).filter(Boolean);
      patchActive(rep=> rep.estudo.estruturado.titulos = lines);
    });
    $("#st_blocos").addEventListener("input", ()=>{
      const blocks = ($("#st_blocos").value||"").split(/\n\s*\n/).map(s=>s.trim()).filter(Boolean);
      patchActive(rep=> rep.estudo.estruturado.blocos = blocks);
    });
    $("#st_insights").addEventListener("input", ()=>{
      const lines = ($("#st_insights").value||"").split("\n")
        .map(s=>s.replace(/^•\s*/,"").trim()).filter(Boolean);
      patchActive(rep=> rep.estudo.estruturado.insights = lines);
    });
  }

  // PDF mode bindings
  if(modo==="PDF"){
    const input = $("#pdfFile");
    input.addEventListener("change", async ()=>{
      const file = input.files && input.files[0];
      if(!file) return;
      if(file.type !== "application/pdf"){
        toast("Ficheiro inválido", "Selecione um PDF.");
        input.value = "";
        return;
      }
      setStatePill("A guardar PDF…","warn");
      try{
        const buf = await file.arrayBuffer();
        const key = "pdf_" + activeId;
        await idbSet(key, { name: file.name, type: file.type, buf });
        patchActive(rep=>{
          rep.estudo.pdfKey = key;
          rep.estudo.pdfName = file.name;
        });
        toast("PDF anexado", "Ficará disponível no passo 5.");
      }catch(e){
        console.error(e);
        toast("Falha ao guardar PDF", "Verifique permissões do browser.");
      }finally{
        setStatePill("Pronto","ok");
        renderWizard();
        activeStep = 4;
        setActiveStepUI();
      }
    });

    $("#btnAbrirAnexo").addEventListener("click", async ()=>{
      const key = r.estudo?.pdfKey;
      if(!key) return;
      try{
        const rec = await idbGet(key);
        if(!rec?.buf){ toast("Anexo indisponível", "Não foi possível carregar do storage."); return; }
        const blob = new Blob([rec.buf], {type:"application/pdf"});
        const url = URL.createObjectURL(blob);
        window.open(url, "_blank", "noopener,noreferrer");
      }catch(e){
        console.error(e);
        toast("Erro ao abrir", "Não foi possível abrir o anexo.");
      }
    });

    $("#btnRemoverAnexo").addEventListener("click", async ()=>{
      const ok = confirm("Remover anexo PDF deste relatório?");
      if(!ok) return;
      const key = r.estudo?.pdfKey;
      if(key){
        try{ await idbDel(key); }catch(e){}
      }
      patchActive(rep=>{
        rep.estudo.pdfKey = null;
        rep.estudo.pdfName = null;
      });
      toast("Anexo removido", "O relatório mantém-se intacto.");
      renderWizard();
      activeStep = 4;
      setActiveStepUI();
    });
  }
}

function structureText(text){
  // Heurística simples, determinística e rápida (evita qualquer bloqueio)
  const lines = text.split("\n").map(l=>l.trim()).filter(Boolean);
  const titulos = [];
  const blocos = [];
  const insights = [];
  let current = [];

  const pushBlock = ()=>{
    if(current.length){
      const block = current.join(" ");
      if(block.length>30) blocos.push(block);
      current = [];
    }
  };

  for(const l of lines){
    const isTitle = (
      l.length<=70 &&
      (l.toUpperCase()===l && /[A-ZÁÉÍÓÚÂÊÔÃÕÇ]/.test(l)) ||
      /^[0-9]+\.\s+/.test(l) ||
      /:$/.test(l)
    );
    if(isTitle){
      pushBlock();
      const t = l.replace(/:$/,"").replace(/^[0-9]+\.\s+/,"").trim();
      if(t && !titulos.includes(t)) titulos.push(t);
      continue;
    }
    current.push(l);
    // extract bullet-ish insights
    const bullet = l.replace(/^[-•]\s*/,"").trim();
    if(/^[-•]/.test(l) && bullet.length>=12) insights.push(bullet);
  }
  pushBlock();

  // fallback insights: pick top 5 sentences containing numbers / % / € / keywords
  if(insights.length<3){
    const sentences = text
      .replace(/\s+/g," ")
      .split(/(?<=[\.\!\?])\s+/)
      .map(s=>s.trim()).filter(Boolean);
    const scored = sentences.map(s=>{
      let score = 0;
      if(/[0-9]/.test(s)) score += 2;
      if(/%|€|eur|m2|m²|IMT|IMI|taxa|rentabilidade|yield/i.test(s)) score += 2;
      if(/procura|oferta|tendênc|valoriz|risco|oportunidade|conclus|recomend/i.test(s)) score += 1;
      score += Math.min(2, Math.floor(s.length/120));
      return {s, score};
    }).sort((a,b)=>b.score-a.score);
    for(const it of scored.slice(0,5)){
      if(it.s.length>=40) insights.push(it.s.replace(/\s+/g," ").trim());
    }
  }

  return {
    titulos: titulos.slice(0,12),
    blocos: blocos.slice(0,10),
    insights: insights.slice(0,10)
  };
}

/* =========================
   Step 5 — PDF Final Premium
   ========================= */
function renderPanel5(r){
  const p = $("#panel-5");
  const hasAttach = !!r.estudo?.pdfKey;
  const modo = r.estudo?.modo || "IGNORAR";
  const hasStudy = (modo==="COLAR" && ((r.estudo?.textoColado||"").trim().length>0 || (r.estudo?.estruturado?.insights||[]).length>0)) || (modo==="PDF" && hasAttach);

  p.innerHTML = `
    <div class="step5center">
      <div class="step5box">
        <div class="hd">
          <div>
            <h3 style="margin:0;font-size:14px">5) PDF Final Premium</h3>
            <div class="meta">Geração local com jsPDF (estável). Pré-visualização e download imediato.</div>
          </div>
          <span class="badge ${r.status==="PRONTO"||r.status==="PDF_GERADO"?"ok":"warn"}">${r.status==="RASCUNHO"?"Em rascunho":"Pronto"}</span>
        </div>
        <div class="bd">
          <div class="split">
            <div>
              <div class="note">
                <b>Estrutura:</b> Capa · Enquadramento · Síntese do Estudo (se existir) · Recomendação Garvetur · Próximos Passos.
                <div class="muted" style="margin-top:6px">Separação visual: “Dados do Estudo” vs “Análise & Recomendação Garvetur”.</div>
              </div>
              <div class="hr"></div>
              <div class="field">
                <label>Título do relatório</label>
                <input id="pdf_title" class="input" value="${escapeHtml(`Relatório Cliente — ${r.client?.nome||"Cliente"}`)}" />
              </div>
              <div class="field">
                <label>Subtítulo (opcional)</label>
                <input id="pdf_sub" class="input" placeholder="Ex.: Porto · Mercado Residencial · Q4 2025" value="${escapeHtml("")}" />
              </div>
              <div class="field">
                <label>Nota executiva (opcional)</label>
                <textarea id="pdf_exec" class="input" placeholder="Mensagem curta e alinhada com a decisão do cliente (1-3 linhas)."></textarea>
              </div>
              <div class="row">
                <button class="btn" id="btnOpenAttachment" ${hasAttach ? "" : "disabled"}>Abrir anexo (PDF)</button>
                <span class="badge">${hasStudy ? "Síntese do estudo: ativa" : "Síntese do estudo: não incluída"}</span>
              </div>
            </div>

            <div>
              <div class="field">
                <label>Pré-visualização (checklist)</label>
                <div class="note" style="margin-bottom:10px">
                  <div>• Cliente: <b>${escapeHtml(r.client?.nome||"—")}</b></div>
                  <div>• Consultor: <b>${escapeHtml(r.consultor?.nome||"—")}</b></div>
                  <div>• Estudo: <b>${modo==="IGNORAR"?"Ignorado":(modo==="PDF"?"PDF anexo":"Texto colado")}</b></div>
                  <div>• Último PDF: <b>${escapeHtml(r.pdf?.lastFilename||"—")}</b></div>
                </div>
              </div>

              <div class="row" style="gap:10px">
                <button class="btn primary" id="btnGenPdf">Gerar PDF Premium</button>
                <button class="btn" id="btnMarkReady" title="Forçar 'Pronto' (não gera PDF)">Marcar como Pronto</button>
              </div>
              <div class="hr"></div>
              <div class="note">
                <b>Entrega cliente-ready:</b> a geração é local e imediata. Se o relatório estiver incompleto, o PDF ainda pode ser gerado, mas ficará sinalizado (recomendado preencher Cliente + Consultor + Recomendação).
              </div>
            </div>
          </div>

          <div class="row" style="justify-content:space-between; margin-top:12px">
            <button class="btn" id="p5_prev">← Anterior</button>
            <button class="btn" id="p5_go1">Voltar ao passo 1</button>
          </div>
        </div>
      </div>
    </div>
  `;

  $("#p5_prev").onclick = ()=>{ activeStep=4; renderWizard(); };
  $("#p5_go1").onclick = ()=>{ activeStep=1; renderWizard(); };

  $("#btnMarkReady").onclick = ()=>{
    patchActive(rep=> rep.status = "PRONTO");
    toast("Estado atualizado", "Relatório marcado como PRONTO.");
  };

  $("#btnOpenAttachment").onclick = async ()=>{
    const key = r.estudo?.pdfKey;
    if(!key) return;
    try{
      const rec = await idbGet(key);
      if(!rec?.buf){ toast("Anexo indisponível", "Não foi possível carregar do storage."); return; }
      const blob = new Blob([rec.buf], {type:"application/pdf"});
      const url = URL.createObjectURL(blob);
      window.open(url, "_blank", "noopener,noreferrer");
    }catch(e){
      console.error(e);
      toast("Erro ao abrir", "Não foi possível abrir o anexo.");
    }
  };

  $("#btnGenPdf").onclick = async ()=>{
    try{
      setStatePill("A gerar PDF…","warn");
      const title = ($("#pdf_title").value||"Relatório Cliente").trim();
      const subtitle = ($("#pdf_sub").value||"").trim();
      const execNote = ($("#pdf_exec").value||"").trim();

      const blob = await buildPdfPremium(r, {title, subtitle, execNote});
      const fname = safeFilename(`${title} — Garvetur Luxury Porto.pdf`);
      lastPdfBlob = blob;
      lastPdfFilename = fname;

      patchActive(rep=>{
        rep.status = "PDF_GERADO";
        rep.pdf.lastGeneratedAt = nowISO();
        rep.pdf.lastFilename = fname;
      });

      openPdfModal(blob, fname);
      toast("PDF gerado", "Pré-visualização aberta. Pode fazer download.");
      setStatePill("Pronto","ok");
    }catch(e){
      console.error(e);
      toast("Falha ao gerar PDF", "Verifique a consola do browser para detalhes.");
      setStatePill("Erro","warn");
    }
  };
}

function safeFilename(name){
  return (name||"relatorio.pdf")
    .replace(/[\\\/:*?"<>|]/g,"-")
    .replace(/\s+/g," ")
    .trim();
}

async function buildPdfPremium(r, opts){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit:"pt", format:"a4" });
  const W = doc.internal.pageSize.getWidth();
  const H = doc.internal.pageSize.getHeight();
  const margin = 52;

  // Helpers
  const line = (y)=>{
    doc.setDrawColor(180);
    doc.setLineWidth(0.6);
    doc.line(margin, y, W-margin, y);
  };
  const heading = (txt, y)=>{
    doc.setFont("helvetica","bold");
    doc.setFontSize(14);
    doc.text(txt, margin, y);
  };
  const para = (txt, y, maxW=W-2*margin, size=11, leading=15)=>{
    doc.setFont("helvetica","normal");
    doc.setFontSize(size);
    const lines = doc.splitTextToSize((txt||"").replace(/\s+/g," ").trim(), maxW);
    doc.text(lines, margin, y);
    return y + lines.length*leading;
  };
  const boxTitle = (txt, y)=>{
    doc.setFont("helvetica","bold");
    doc.setFontSize(11);
    doc.text(txt, margin, y);
    return y + 10;
  };
  const small = (txt, x, y)=>{
    doc.setFont("helvetica","normal"); doc.setFontSize(9);
    doc.setTextColor(90);
    doc.text(txt, x, y);
    doc.setTextColor(0);
  };

  // ---------- Page 1: Cover
  doc.setFillColor(245,245,245);
  doc.rect(0,0,W,H,"F");
  doc.setFillColor(255,255,255);
  doc.roundedRect(margin, 92, W-2*margin, H-184, 14, 14, "F");

  doc.setTextColor(0);
  doc.setFont("helvetica","bold");
  doc.setFontSize(18);
  doc.text("Garvetur Luxury Porto", margin+22, 140);
  doc.setFontSize(12);
  doc.setFont("helvetica","normal");
  doc.setTextColor(60);
  doc.text("Relatório Cliente — PDF Final Premium", margin+22, 164);

  doc.setTextColor(0);
  doc.setFont("helvetica","bold");
  doc.setFontSize(20);
  doc.text(opts.title || "Relatório Cliente", margin+22, 220);

  doc.setFont("helvetica","normal");
  doc.setFontSize(12);
  doc.setTextColor(60);
  if(opts.subtitle){
    doc.text(opts.subtitle, margin+22, 246);
  }

  // Key client block
  doc.setTextColor(0);
  doc.setFont("helvetica","bold"); doc.setFontSize(12);
  doc.text("Cliente", margin+22, 302);
  doc.setFont("helvetica","normal"); doc.setTextColor(40); doc.setFontSize(11);
  const c = r.client||{};
  const co = r.consultor||{};
  const leftX = margin+22;
  let y = 324;
  const rows = [
    ["Nome", c.nome||"—"],
    ["Email", c.email||"—"],
    ["Telefone", c.telefone||"—"],
    ["Perfil", c.perfil||"—"],
    ["Objetivo", c.objetivo||"—"],
    ["Zona", c.zona||"—"],
    ["Budget", c.budget||"—"],
    ["Prazo", c.prazo||"—"]
  ];
  for(const [k,v] of rows){
    doc.setFont("helvetica","bold"); doc.text(`${k}:`, leftX, y);
    doc.setFont("helvetica","normal"); doc.text(String(v), leftX+72, y);
    y += 16;
    if(y>520){ break; }
  }

  // Executive note
  if(opts.execNote){
    doc.setTextColor(0);
    doc.setFont("helvetica","bold"); doc.setFontSize(12);
    doc.text("Nota Executiva", margin+22, 560);
    doc.setTextColor(40);
    doc.setFont("helvetica","normal"); doc.setFontSize(11);
    const lines = doc.splitTextToSize(opts.execNote, W-2*margin-44);
    doc.text(lines, margin+22, 582);
  }

  // Footer
  const dt = new Date();
  doc.setTextColor(90);
  doc.setFontSize(9);
  doc.text(`Gerado em ${dt.toLocaleDateString("pt-PT")} · Consultor: ${co.nome||"—"} · ${co.email||""}`, margin, H-28);

  // ---------- Page 2: Enquadramento
  doc.addPage();
  y = 76;
  heading("Enquadramento do Cliente", y); y += 18;
  line(y); y += 18;
  y = para((r.contexto?.notas||"").trim() || "—", y);

  y += 10;
  heading("Inputs do Consultor", Math.min(y+10, H-120));
  y += 30;
  y = para((r.consultor?.inputs||"").trim() || "—", y);

  small("Documento interno — utilização profissional", margin, H-26);

  // ---------- Page 3: Síntese do estudo (se existir)
  const modo = r.estudo?.modo || "IGNORAR";
  const hasAttach = !!r.estudo?.pdfKey;
  const hasStudy = (modo==="COLAR" && ((r.estudo?.textoColado||"").trim().length>0 || (r.estudo?.estruturado?.insights||[]).length>0)) || (modo==="PDF" && hasAttach);

  if(hasStudy){
    doc.addPage();
    y = 76;
    heading("Dados do Estudo — Síntese Objetiva", y); y += 18;
    line(y); y += 18;

    if(modo==="PDF" && hasAttach){
      doc.setFont("helvetica","normal"); doc.setFontSize(11);
      doc.text("Fonte: PDF anexado (referência visual).", margin, y); y += 18;
      doc.setTextColor(60); doc.setFontSize(10);
      doc.text(`Ficheiro: ${r.estudo?.pdfName || "—"}`, margin, y); y += 16;
      doc.setTextColor(0);
      y += 10;
      y = para("Nota: nesta fase não existe leitura automática do PDF no browser. Caso pretenda, a equipa pode transcrever os principais pontos no modo 'Colar texto' para uma síntese mais completa.", y);
    } else {
      const st = r.estudo?.estruturado || { titulos:[], blocos:[], insights:[] };
      const tit = st.titulos || [];
      const ins = st.insights || [];
      const bl = st.blocos || [];

      if(tit.length){
        boxTitle("Tópicos", y); y += 6;
        doc.setFont("helvetica","normal"); doc.setFontSize(11);
        const joined = tit.map(t=>"• "+t).join("\n");
        const lines = doc.splitTextToSize(joined, W-2*margin);
        doc.text(lines, margin, y);
        y += lines.length*15 + 10;
      }

      if(ins.length){
        boxTitle("Insights-chave", y); y += 6;
        const joined = ins.map(t=>"• "+t).join("\n");
        const lines = doc.splitTextToSize(joined, W-2*margin);
        doc.setFont("helvetica","normal"); doc.setFontSize(11);
        doc.text(lines, margin, y);
        y += lines.length*15 + 10;
      }

      if(bl.length){
        boxTitle("Resumo", y); y += 6;
        for(const b of bl.slice(0,3)){
          y = para(b, y);
          y += 8;
          if(y>H-120){ break; }
        }
      }
    }
    small("Secção separada: Dados do Estudo", margin, H-26);
  }

  // ---------- Final: Recomendação Garvetur
  doc.addPage();
  y = 76;
  heading("Análise & Recomendação Garvetur", y); y += 18;
  line(y); y += 18;
  y = para((r.recomendacao?.analise||"").trim() || "—", y);

  y += 10;
  heading("Próximos Passos", y); y += 22;
  const passos = (r.recomendacao?.proximosPassos||"").trim();
  if(passos){
    y = para(passos, y);
  }else{
    y = para("—", y);
  }

  // Footer
  doc.setTextColor(90);
  doc.setFontSize(9);
  doc.text("Garvetur Luxury Porto — Documento de apoio à decisão (cliente-ready)", margin, H-26);
  doc.setTextColor(0);

  // Produce Blob
  const arr = doc.output("arraybuffer");
  return new Blob([arr], { type:"application/pdf" });
}

/* =========================
   PDF Modal
   ========================= */
function openPdfModal(blob, filename){
  const back = $("#pdfModalBack");
  const frame = $("#pdfFrame");
  const url = URL.createObjectURL(blob);
  frame.src = url;
  back.style.display = "flex";

  $("#btnPdfClose").onclick = ()=>{
    back.style.display = "none";
    // Keep last blob for download; do not revoke immediately to avoid blank iframe
  };
  $("#btnPdfDownload").onclick = ()=>{
    if(!lastPdfBlob) return;
    const a = document.createElement("a");
    a.href = URL.createObjectURL(lastPdfBlob);
    a.download = lastPdfFilename || filename || "relatorio.pdf";
    document.body.appendChild(a);
    a.click();
    a.remove();
  };
  back.addEventListener("click", (ev)=>{
    if(ev.target === back){
      back.style.display = "none";
    }
  }, { once:true });
}

/* =========================
   Config view
   ========================= */
function renderConfig(){
  const cfg = loadCfg();
  $("#cfgSignature").value = cfg.signature || "";
  $("#cfgEmail").value = cfg.email || "";
  $("#cfgSave").onclick = ()=>{
    const n = ($("#cfgSignature").value||"").trim();
    const e = ($("#cfgEmail").value||"").trim();
    saveCfg({ signature:n, email:e });
    toast("Configuração guardada", "Será aplicada nos novos relatórios.");
  };
  $("#cfgReset").onclick = async ()=>{
    const ok = confirm("Isto irá eliminar TODOS os relatórios guardados localmente e anexos PDF. Confirma?");
    if(!ok) return;
    localStorage.removeItem(LS_KEY);
    localStorage.removeItem(LS_CFG);
    // best-effort clear DB store
    try{
      const db = await idbOpen();
      const tx = db.transaction(DB_STORE,"readwrite");
      tx.objectStore(DB_STORE).clear();
      tx.oncomplete = ()=> db.close();
      tx.onerror = ()=> db.close();
    }catch(e){}
    reports = [];
    activeId = null;
    seedIfEmpty();
    reports = loadData();
    renderList();
    renderWizard();
    renderConfig();
    toast("Reposição concluída", "Dados locais foram limpos.");
  };
}

/* =========================
   Init
   ========================= */
function init(){
  renderList();
  if(!activeId) activeId = reports[0]?.id || null;
  renderWizard();
  renderConfig();
  setStatePill("Pronto","ok");
}
init();
</script>
</body>
</html>
