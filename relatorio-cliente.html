



<!doctype html>
<html lang="pt-PT">
<head>
  <meta charset="utf-8" />
  <title>Garvetur Porto Pro ‚Äî Relat√≥rio para Cliente (Admin)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      --gold:#A38B63;
      --gold-soft:rgba(163,139,99,.35);
      --bg:#0B0B0B;
      --panel:#121212;
      --panel-soft:#181818;
      --text:#FFFFFF;
      --muted:#A0A0A0;
      --border:rgba(255,255,255,.14);
      --danger:#E53935;
      --success:#43A047;
      --info:#1E88E5;

      --radius-lg:18px;
      --radius-md:12px;
      --shadow:0 18px 34px rgba(0,0,0,.55);
    }

    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;background:radial-gradient(circle at top,#1c1c1c 0,#050505 55%,#000 100%);color:var(--text)}
    a{color:inherit}
    .hidden{display:none !important}

    /* Shell */
    .app{
      display:grid;
      grid-template-rows:64px 1fr;
      height:100%;
      overflow:hidden;
    }

    header.app-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 16px;
      border-bottom:1px solid rgba(163,139,99,.35);
      background:linear-gradient(90deg,#050505,#111,#050505);
      position:sticky;top:0;z-index:20;
      gap:12px;
      flex-wrap:wrap;
    }
    .brand{
      display:flex;align-items:center;gap:10px;
    }
    .brand-icon{
      width:30px;height:30px;border-radius:999px;border:1px solid var(--gold);
      display:flex;align-items:center;justify-content:center;
      box-shadow:0 0 0 1px rgba(163,139,99,.35);
    }
    .brand h1{margin:0;font-size:16px;letter-spacing:.08em;text-transform:uppercase;color:var(--gold)}
    .brand .sub{display:block;font-size:11px;color:var(--muted);letter-spacing:.14em;text-transform:uppercase;margin-top:2px}

    .header-actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .badge{
      font-size:11px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(163,139,99,.45);
      color:var(--muted);
      letter-spacing:.12em;
      text-transform:uppercase;
      background:rgba(0,0,0,.35);
      white-space:nowrap;
    }
    .btn{
      border-radius:999px;
      border:1px solid var(--gold-soft);
      background:rgba(12,12,12,.92);
      color:var(--text);
      padding:8px 12px;
      font-size:13px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      cursor:pointer;
      transition:.18s border-color,.18s transform,.18s background;
      text-decoration:none;
      user-select:none;
    }
    .btn:hover{border-color:var(--gold);transform:translateY(-1px)}
    .btn.primary{background:var(--gold);color:#0A0A0A;border-color:var(--gold);font-weight:700}
    .btn.secondary{border-color:rgba(255,255,255,.18);color:var(--muted);background:transparent}

    /* Layout */
    .layout{
      display:grid;
      grid-template-columns:320px minmax(0,1fr);
      height:100%;
      overflow:hidden;
    }
    @media (max-width: 980px){
      .layout{grid-template-columns:1fr;grid-template-rows:auto 1fr}
    }

    /* Sidebar */
    aside.sidebar{
      border-right:1px solid rgba(163,139,99,.24);
      background:radial-gradient(circle at top left,#141414,#060606);
      padding:12px 12px;
      overflow:auto;
    }
    .side-card{
      background:rgba(0,0,0,.45);
      border:1px solid rgba(163,139,99,.18);
      border-radius:var(--radius-md);
      padding:10px 10px;
      margin-bottom:10px;
      box-shadow:0 12px 22px rgba(0,0,0,.35);
    }
    .side-card h3{
      margin:0 0 8px;
      font-size:11px;
      color:var(--muted);
      letter-spacing:.16em;
      text-transform:uppercase;
    }
    .field{display:flex;flex-direction:column;gap:5px;margin-bottom:10px}
    .field label{
      font-size:11px;color:var(--muted);letter-spacing:.12em;text-transform:uppercase
    }
    .input, select, textarea{
      width:100%;
      background:rgba(0,0,0,.70);
      color:var(--text);
      border:1px solid rgba(163,139,99,.22);
      border-radius:10px;
      padding:8px 10px;
      outline:none;
      font-size:13px;
    }
    textarea{min-height:84px;resize:vertical}
    .input:focus, select:focus, textarea:focus{
      border-color:var(--gold);
      box-shadow:0 0 0 1px rgba(163,139,99,.35);
    }
    .checks{display:flex;flex-direction:column;gap:8px;margin-top:6px}
    .checks label{display:flex;gap:8px;align-items:flex-start;font-size:12px;color:var(--muted);line-height:1.35}
    .checks input{accent-color:var(--gold);margin-top:2px}

    .hint{font-size:11px;color:var(--muted);line-height:1.45}
    .divider{height:1px;background:rgba(255,255,255,.10);margin:10px 0}

    /* Main */
    main.main{
      padding:14px 16px 18px;
      overflow:auto;
      background:radial-gradient(circle at top,#1a1a1a,#050505 55%,#000 100%);
    }
    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }
    .topbar h2{
      margin:0;
      font-size:14px;
      letter-spacing:.16em;
      text-transform:uppercase;
      color:var(--muted);
    }
    .topbar p{margin:2px 0 0;font-size:12px;color:var(--muted);line-height:1.45;max-width:920px}

    .panel{
      border-radius:var(--radius-lg);
      border:1px solid rgba(163,139,99,.24);
      background:rgba(3,3,3,.88);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .panel-head{
      padding:10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid rgba(255,255,255,.10);
      background:linear-gradient(90deg,#050505,#111,#050505);
      gap:10px;
      flex-wrap:wrap;
    }
    .panel-head .title{
      display:flex;align-items:center;gap:10px;
      font-weight:800;letter-spacing:.08em;text-transform:uppercase;font-size:12px;color:var(--gold);
    }
    .panel-body{padding:12px 12px 12px}
    .panel-foot{
      padding:10px 12px;
      border-top:1px solid rgba(255,255,255,.10);
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      background:rgba(0,0,0,.35);
    }

    /* Tabs (Lista vs Wizard) */
    .tabs{
      display:flex;gap:6px;flex-wrap:wrap;align-items:center;
    }
    .tab{
      border-radius:999px;
      padding:6px 10px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.35);
      font-size:12px;
      color:var(--muted);
      cursor:pointer;
      user-select:none;
    }
    .tab.active{
      border-color:var(--gold);
      color:#0A0A0A;
      background:var(--gold);
      font-weight:800;
    }

    /* Table list */
    .table-wrap{overflow:auto}
    table{
      width:100%;
      border-collapse:collapse;
      min-width:860px;
    }
    th,td{
      padding:10px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      vertical-align:top;
    }
    th{
      position:sticky;top:0;
      background:rgba(0,0,0,.55);
      color:var(--muted);
      font-size:11px;
      letter-spacing:.12em;
      text-transform:uppercase;
      z-index:2;
    }
    td{font-size:13px;color:#e9e9e9}
    .td-sub{display:block;font-size:11px;color:var(--muted);margin-top:2px}
    .pill{
      display:inline-flex;
      align-items:center;
      padding:4px 9px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      font-size:11px;
      letter-spacing:.10em;
      text-transform:uppercase;
      color:var(--muted);
      background:rgba(0,0,0,.35);
      white-space:nowrap;
    }
    .pill.ok{border-color:rgba(67,160,71,.55);color:#A5D6A7}
    .pill.warn{border-color:rgba(229,57,53,.55);color:#ffb4b4}
    .pill.info{border-color:rgba(30,136,229,.55);color:#bbdefb}
    .row-actions{display:flex;gap:6px;flex-wrap:wrap}

    .btn-xs{
      border-radius:999px;
      padding:6px 10px;
      border:1px solid rgba(163,139,99,.60);
      background:rgba(0,0,0,.70);
      color:var(--gold);
      font-size:11px;
      text-decoration:none;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      transition:.18s border-color,.18s transform,.18s background;
      user-select:none;
    }
    .btn-xs:hover{transform:translateY(-1px);border-color:var(--gold)}
    .btn-xs.primary{background:var(--gold);color:#0A0A0A;border-color:var(--gold);font-weight:800}
    .btn-xs.ghost{border-color:rgba(255,255,255,.16);color:var(--muted);background:transparent}

    /* Wizard */
    .wizard{
      display:grid;
      grid-template-columns:260px minmax(0,1fr);
      gap:12px;
      align-items:start;
    }
    @media (max-width: 980px){
      .wizard{grid-template-columns:1fr}
    }

    /* Step 5 em destaque (centrado) */
    .wizard.step5-full{
      grid-template-columns:260px 1fr;
    }
    .wizard.step5-full .steps{
      display:block;
    }
    .wizard.step5-full .step-panel{
      max-width:1100px;
      margin:0 auto;
    }

    .steps{
      border-radius:var(--radius-lg);
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.35);
      padding:10px 10px;
      position:sticky;
      top:84px;
    }
    @media (max-width: 980px){
      .steps{position:relative;top:auto}
    }
    .steps h4{
      margin:0 0 8px;
      font-size:11px;
      color:var(--muted);
      letter-spacing:.16em;
      text-transform:uppercase;
    }
    .step{
      display:flex;gap:10px;align-items:flex-start;
      padding:8px 8px;
      border-radius:12px;
      border:1px solid transparent;
      cursor:pointer;
    }
    .step:hover{border-color:rgba(163,139,99,.22);background:rgba(163,139,99,.08)}
    .step.active{border-color:rgba(163,139,99,.45);background:rgba(163,139,99,.12)}
    .step .n{
      width:24px;height:24px;border-radius:999px;
      display:flex;align-items:center;justify-content:center;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.45);
      color:var(--muted);
      font-size:12px;
      flex-shrink:0;
    }
    .step.active .n{background:var(--gold);border-color:var(--gold);color:#0A0A0A;font-weight:900}
    .step .t{
      font-size:12px;color:#f0f0f0;font-weight:700;
      line-height:1.2;
    }
    .step .s{
      display:block;margin-top:2px;
      font-size:11px;color:var(--muted);font-weight:500;
      line-height:1.25;
    }

    .step-panel{
      border-radius:var(--radius-lg);
      border:1px solid rgba(163,139,99,.24);
      background:rgba(3,3,3,.88);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .step-head{
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;
      background:linear-gradient(90deg,#050505,#111,#050505);
    }
    .step-head .left{
      display:flex;flex-direction:column;gap:2px;
    }
    .step-head .kicker{
      font-size:11px;color:var(--muted);letter-spacing:.14em;text-transform:uppercase;
    }
    .step-head .name{
      font-size:13px;color:var(--gold);font-weight:900;letter-spacing:.06em;text-transform:uppercase;
    }
    .step-body{padding:12px 12px}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width: 980px){.grid-2{grid-template-columns:1fr}}
    .grid-3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}
    @media (max-width: 980px){.grid-3{grid-template-columns:1fr}}

    .radio-row, .toggle-row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .radio{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.35);
      border-radius:12px;
      padding:8px 10px;
      display:flex;gap:8px;align-items:flex-start;
      cursor:pointer;
      min-width:220px;
      flex:1;
    }
    .radio input{accent-color:var(--gold);margin-top:2px}
    .radio .rt{font-size:12px;font-weight:800;color:#f0f0f0}
    .radio .rs{font-size:11px;color:var(--muted);margin-top:2px;line-height:1.3}

    .section-title{
      margin:12px 0 6px;
      font-size:11px;
      color:var(--muted);
      letter-spacing:.16em;
      text-transform:uppercase;
    }

    /* Upload */
    .drop{
      border:1px dashed rgba(163,139,99,.55);
      background:rgba(163,139,99,.08);
      border-radius:16px;
      padding:12px 12px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .drop .d-left{max-width:720px}
    .drop .d-title{font-weight:900;letter-spacing:.06em;text-transform:uppercase;color:#f5f5f5;font-size:12px;margin:0 0 4px}
    .drop .d-sub{margin:0;font-size:12px;color:var(--muted);line-height:1.45}
    .drop .d-actions{display:flex;gap:8px;flex-wrap:wrap}

    /* Attachments list */
    .files{
      margin-top:10px;
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      overflow:hidden;
      background:rgba(0,0,0,.35);
    }
    .file{
      display:flex;justify-content:space-between;gap:10px;align-items:flex-start;
      padding:10px 10px;border-bottom:1px solid rgba(255,255,255,.08);
    }
    .file:last-child{border-bottom:none}
    .file .f-name{font-weight:800}
    .file .f-meta{font-size:11px;color:var(--muted);margin-top:2px}
    .file .f-actions{display:flex;gap:6px;flex-wrap:wrap}

    /* Analysis cards */
    .analysis{
      margin-top:10px;
      display:grid;
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:10px;
    }
    @media (max-width: 980px){.analysis{grid-template-columns:1fr}}
    .mini-card{
      border-radius:16px;
      border:1px solid rgba(163,139,99,.22);
      background:rgba(0,0,0,.35);
      padding:10px 10px;
    }
    .mini-card h5{
      margin:0 0 6px;
      font-size:11px;
      color:var(--muted);
      letter-spacing:.14em;
      text-transform:uppercase;
    }
    .kv{display:flex;justify-content:space-between;gap:10px;padding:4px 0;border-bottom:1px solid rgba(255,255,255,.06)}
    .kv:last-child{border-bottom:none}
    .kv span{font-size:12px;color:#e9e9e9}
    .kv b{font-size:12px;color:var(--muted);font-weight:700}

    /* Report builder */
    .switches{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:8px;
      margin-top:8px;
    }
    @media (max-width: 980px){.switches{grid-template-columns:1fr}}
    .sw{
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      background:rgba(0,0,0,.35);
      padding:10px 10px;
      display:flex;justify-content:space-between;gap:10px;align-items:center;
    }
    .sw .l{display:flex;flex-direction:column;gap:2px}
    .sw .l b{font-size:12px;color:#f5f5f5}
    .sw .l span{font-size:11px;color:var(--muted);line-height:1.3}
    .sw input{accent-color:var(--gold);transform:scale(1.05)}

    .cta-row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .status{
      font-size:11px;
      color:var(--muted);
      display:flex;gap:8px;align-items:center;flex-wrap:wrap;
    }
    .dot{width:10px;height:10px;border-radius:999px;background:rgba(255,255,255,.22);border:1px solid rgba(0,0,0,.25)}
    .dot.ok{background:rgba(67,160,71,.9)}
    .dot.warn{background:rgba(229,57,53,.9)}
    .dot.info{background:rgba(30,136,229,.9)}
    /* Passo 3 ‚Äî Observa√ß√µes mais leg√≠vel */
#step3 #aObs{
  min-height:140px;
  line-height:1.45;
}

/* =========================
   PASSO 4 ‚Äî EXTRA√á√ÉO ASSISTIDA (MODO FOCO)
========================= */

/* Textarea maior por defeito */
#pdfAssistText{
  width: 100%;
  min-height: 320px;
  height: 48vh;
  resize: vertical;
  line-height: 1.45;
}

/* Quando em modo foco */
.analysis.assist-focus{
  grid-template-columns: 1fr;
}

/* Esconder outros cart√µes */
.analysis.assist-focus .mini-card{
  display: none;
}

/* Mostrar apenas o cart√£o da extra√ß√£o */
.analysis.assist-focus .mini-card.assist-card{
  display: block;
  grid-column: 1 / -1;
}

    /* =========================
   OCULTAR NOTAS INTERNAS
   (campo interno ‚Äì n√£o aparece no UI nem no PDF)
========================= */

#step1 label[for="cNotas"],
#step1 #cNotas {
  display: none !important;
}
    
  </style>
</head>

<body>
  <div class="app">
    <header class="app-header">
      <div class="brand">
        <div class="brand-icon">
          <svg width="18" height="18" viewBox="0 0 24 24" stroke="var(--gold)" fill="none" stroke-width="1.8">
            <circle cx="12" cy="12" r="9"></circle>
            <path d="M8 12.5l2.5 2.5L16 9"></path>
          </svg>
        </div>
        <div>
          <h1>Relat√≥rio para Cliente</h1>
          <span class="sub">Admin ¬∑ PDF + Personaliza√ß√£o + Exporta√ß√£o</span>
        </div>
      </div>

      <div class="header-actions">
        <span class="badge">Privado</span>
        <a class="btn secondary" href="./admin.html">Voltar ao Admin</a>
        <button class="btn primary" id="btnNew">+ Novo Relat√≥rio</button>
        <button class="btn" id="btnManual">üìò Manual Estrat√©gico</button>
        <button class="btn" id="btnRelatorioPremium">üìÑ Relat√≥rio Premium</button>
      </div>
    </header>

    <div class="layout">
      <!-- SIDEBAR -->
      <aside class="sidebar">
        <div class="side-card">
          <h3>Pesquisa & Filtros</h3>

          <div class="field">
            <label for="q">Pesquisa</label>
            <input class="input" id="q" type="text" placeholder="Cliente, zona, objetivo, estado‚Ä¶" />
          </div>

          <div class="field">
            <label for="fStatus">Estado</label>
            <select id="fStatus">
              <option value="">Todos</option>
              <option value="draft">Rascunho</option>
              <option value="final">Final</option>
              <option value="sent">Enviado</option>
            </select>
          </div>

          <div class="field">
            <label for="fTipo">Tipo de cliente</label>
            <select id="fTipo">
              <option value="">Todos</option>
              <option>Propriet√°rio</option>
              <option>Investidor</option>
              <option>Promotor</option>
              <option>Comprador</option>
            </select>
          </div>

          <div class="field">
            <label for="fDataDe">Data (de / at√©)</label>
            <div style="display:flex;gap:6px">
              <input class="input" id="fDataDe" type="date" />
              <input class="input" id="fDataAte" type="date" />
            </div>
          </div>

          <div class="divider"></div>

          <div class="checks">
            <label><input type="checkbox" id="fConfidencial" /> Apenas confidenciais</label>
          </div>

          <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
            <button class="btn" id="btnApply">Aplicar</button>
            <button class="btn secondary" id="btnClear">Limpar</button>
          </div>

          <div class="divider"></div>
          <div class="hint">
            Este m√≥dulo cria relat√≥rios prontos para decis√£o: <strong>executivo</strong> (1‚Äì2 p√°ginas) ou <strong>completo</strong> (4‚Äì8+),
            com anexos PDF e narrativa orientada ao cliente.
          </div>
        </div>

        <div class="side-card">
          <h3>Estado do m√≥dulo</h3>
          <div class="status">
            <span class="dot ok"></span><span>UI pronta (layout)</span>
          </div>
          <div class="status" style="margin-top:8px">
            <span class="dot info"></span><span>Liga√ß√£o a m√≥dulos (FSBO | Leads | Angaria√ß√µes)</span>
          </div>
          <div class="status" style="margin-top:8px">
            <span class="dot warn"></span><span>Extra√ß√£o PDF/Exporta√ß√£o (adiada)</span>
          </div>
        </div>
      </aside>

      <!-- MAIN -->
      <main class="main">
        <div class="topbar">
          <div>
            <h2>Relat√≥rios</h2>
            <p>Gest√£o central de relat√≥rios personalizados. Pode importar estudos gen√©ricos em PDF, extrair insights e gerar um PDF final com recomenda√ß√£o e plano de a√ß√£o.</p>
          </div>

          <div class="tabs" aria-label="Vistas">
            <div class="tab active" id="tabList">Lista</div>
            <div class="tab" id="tabWizard">Novo / Editar</div>
          </div>
        </div>

        <!-- LISTA -->
        <section class="panel" id="viewList">
          <div class="panel-head">
            <div class="title">
              <span style="display:inline-flex;width:26px;height:26px;border-radius:999px;border:1px solid var(--gold);align-items:center;justify-content:center;">
                <svg width="16" height="16" viewBox="0 0 24 24" stroke="var(--gold)" fill="none" stroke-width="1.8">
                  <path d="M7 7h10M7 12h10M7 17h10" />
                </svg>
              </span>
              <span>Lista de relat√≥rios</span>
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn secondary" id="btnImportTemplate">Templates</button>
              <button class="btn" id="btnExportAll">Exporta√ß√µes</button>
            </div>
          </div>

          <div class="panel-body">
            <div class="table-wrap">
              <table aria-label="Relat√≥rios">
                <thead>
                  <tr>
                    <th style="min-width:260px">Cliente</th>
                    <th style="min-width:220px">Objetivo / Ativo</th>
                    <th style="min-width:160px">Data</th>
                    <th style="min-width:150px">Estado</th>
                    <th style="min-width:280px">A√ß√µes</th>
                  </tr>
                </thead>
                <tbody id="reportsTbody">
                  <!-- Placeholder -->
                </tbody>
              </table>
            </div>

            <div class="hint" style="margin-top:10px">
              Nota: esta fase foca a <strong>liga√ß√£o aos m√≥dulos</strong> (FSBO | Leads | Angaria√ß√µes) para auto-preenchimento.
            </div>
          </div>

          <div class="panel-foot">
            <div class="hint">Dica operacional: ao escrever nome/telem√≥vel/email, o sistema tenta reconhecer o cliente e preencher automaticamente.</div>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn" id="btnGoWizard">Criar novo</button>
            </div>
          </div>
        </section>

        <!-- WIZARD -->
        <section class="wizard hidden" id="viewWizard">
          <!-- Steps -->
          <div class="steps">
            <h4>Passos</h4>

            <div class="step active" data-step="1">
              <div class="n">1</div>
              <div>
                <div class="t">Cliente</div>
                <span class="s">Identifica√ß√£o e formato</span>
              </div>
            </div>

            <div class="step" data-step="2">
              <div class="n">2</div>
              <div>
                <div class="t">Objetivo</div>
                <span class="s">Risco, horizonte e preocupa√ß√µes</span>
              </div>
            </div>

            <div class="step" data-step="3">
              <div class="n">3</div>
              <div>
                <div class="t">Ativo / Zona</div>
                <span class="s">Im√≥vel espec√≠fico ou an√°lise de zona</span>
              </div>
            </div>

            <div class="step" data-step="4">
              <div class="n">4</div>
              <div>
                <div class="t">PDF & An√°lise</div>
                <span class="s">(adiado)</span>
              </div>
            </div>

            <div class="step" data-step="5">
              <div class="n">5</div>
              <div>
                <div class="t">Relat√≥rio</div>
                <span class="s">Estrutura, tom e exporta√ß√£o</span>
              </div>
            </div>

            <div class="divider"></div>

            <div class="hint">
              Nesta fase: <strong>auto-importa√ß√£o de dados</strong> a partir dos m√≥dulos existentes,
              para acelerar onboarding do relat√≥rio e aumentar contexto do cliente.
            </div>
          </div>

          <!-- Step panel -->
          <div class="step-panel">
            <div class="step-head">
              <div class="left">
                <div class="kicker">Novo relat√≥rio</div>
                <div class="name" id="stepTitle">Passo 1 ‚Äî Identifica√ß√£o do Cliente</div>
              </div>
              <div style="display:flex;gap:8px;flex-wrap:wrap">
                <button class="btn secondary" id="btnBackToList">Voltar √† lista</button>
                <button class="btn" id="btnSaveDraft">Guardar rascunho</button>
              </div>
            </div>

            <div class="step-body">

              <!-- STEP 1 -->
              <div id="step1">
                <div class="grid-2">
                  <div class="field">
                    <label for="cTipo">Tipo de Cliente</label>
                    <select id="cTipo">
                      <option value="">(Selecionar)</option>
                      <option>Propriet√°rio</option>
                      <option>Investidor</option>
                      <option>Promotor</option>
                      <option>Comprador</option>
                    </select>
                  </div>

                  <div class="field">
                    <label for="cNome">Nome do Cliente / Empresa</label>
                    <input class="input" id="cNome" type="text" placeholder="Ex.: Family Office X / Sr. Manuel Silva" />
                  </div>

                  <div class="field">
                    <label for="cTel">Contacto</label>
                    <input class="input" id="cTel" type="text" placeholder="Telefone/telem√≥vel" />
                  </div>

                  <div class="field">
                    <label for="cEmail">Email</label>
                    <input class="input" id="cEmail" type="text" placeholder="email@cliente.com" />
                  </div>
                </div>

                <div class="hint" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:6px 0 10px">
                  <span id="autoImportBadge" class="pill info hidden">Importa√ß√£o autom√°tica</span>
                  <span id="autoImportText">Escreva nome/telem√≥vel/email para tentar reconhecer o cliente nos m√≥dulos <strong>FSBO</strong>, <strong>Leads</strong> e <strong>Angaria√ß√µes</strong>.</span>
                  <button class="btn secondary" type="button" id="btnResetCliente" style="padding:6px 10px;font-size:12px">Limpar</button>
                </div>

                <div class="grid-3">
                  <div class="field">
                    <label for="cIdioma">Idioma do relat√≥rio</label>
                    <select id="cIdioma">
                      <option value="pt">Portugu√™s (PT)</option>
                      <option value="en">English</option>
                    </select>
                  </div>

                  <div class="field">
                    <label for="cDetalhe">N√≠vel de detalhe</label>
                    <select id="cDetalhe">
                      <option value="exec">Executivo (1‚Äì2 p√°ginas)</option>
                      <option value="full">Completo (4‚Äì8 p√°ginas)</option>
                    </select>
                  </div>

                  <div class="field">
                    <label for="cConf">Confidencial</label>
                    <select id="cConf">
                      <option value="no">N√£o</option>
                      <option value="yes">Sim</option>
                    </select>
                  </div>
                </div>
                
<!-- Notas internas (mantidas para compatibilidade JS, mas ocultas) -->
<div class="field hidden" id="fieldNotasInternas">
  <label for="cNotas">Notas internas</label>
  <textarea id="cNotas" placeholder="Briefing do cliente, contexto, pontos cr√≠ticos‚Ä¶"></textarea>
</div>
               
              </div>

              <!-- STEP 2 -->
              <div id="step2" class="hidden">
                <div class="grid-2">
                  <div class="field">
                    <label for="oObjetivo">Objetivo principal</label>
                    <select id="oObjetivo">
                      <option value="">(Selecionar)</option>
                      <option>Vender</option>
                      <option>Investir</option>
                      <option>Avaliar</option>
                      <option>Reposicionar</option>
                      <option>Timing</option>
                    </select>
                  </div>

                  <div class="field">
                    <label for="oHorizonte">Horizonte temporal</label>
                    <select id="oHorizonte">
                      <option value="">(Selecionar)</option>
                      <option>0‚Äì30 dias</option>
                      <option>30‚Äì90 dias</option>
                      <option>3‚Äì6 meses</option>
                      <option>6‚Äì12 meses</option>
                      <option>&gt;12 meses</option>
                    </select>
                  </div>
                </div>

                <div class="grid-2">
                  <div class="field">
                    <label for="oRisco">Perfil de risco</label>
                    <select id="oRisco">
                      <option value="">(Selecionar)</option>
                      <option>Conservador</option>
                      <option>Equilibrado</option>
                      <option>Agressivo</option>
                    </select>
                  </div>

                  <div class="field">
                    <label for="oPreocup">Preocupa√ß√µes (multi)</label>
                    <select id="oPreocup" multiple style="min-height:120px">
                      <option>Liquidez</option>
                      <option>Maximizar pre√ßo</option>
                      <option>Risco fiscal</option>
                      <option>Obras</option>
                      <option>Inquilino</option>
                      <option>Seguran√ßa jur√≠dica</option>
                      <option>Prazo</option>
                      <option>Financiamento</option>
                    </select>
                    <div class="hint" style="margin-top:6px">CTRL/‚åò para selecionar m√∫ltiplas op√ß√µes.</div>
                  </div>
                </div>

                <div class="field">
                  <label for="oBrief">Notas do briefing</label>
                  <textarea id="oBrief" placeholder="O que o cliente quer realmente decidir? Quais as barreiras/receios?"></textarea>
                </div>
              </div>

              <!-- STEP 3 -->
              <div id="step3" class="hidden">
                <div class="section-title">Tipo de relat√≥rio</div>
                <div class="radio-row">
                  <label class="radio">
                    <input type="radio" name="assetMode" value="imovel" checked />
                    <div>
                      <div class="rt">Im√≥vel espec√≠fico</div>
                      <div class="rs">Selecionar um ativo concreto (Mapa/Angaria√ß√µes/FSBO/Manual).</div>
                    </div>
                  </label>

                  <label class="radio">
                    <input type="radio" name="assetMode" value="zona" />
                    <div>
                      <div class="rt">Zona / Tipologia</div>
                      <div class="rs">An√°lise por zona, segmento e intervalo de pre√ßo.</div>
                    </div>
                  </label>
                </div>

                <div id="assetImovel" style="margin-top:10px">
                  <div class="grid-2">
                    <div class="field">
                      <label for="aFonte">Fonte do ativo</label>
                      <select id="aFonte">
                        <option>Mapa</option>
                                                <option>Leads</option>
<option>Angaria√ß√µes</option>
                        <option>FSBO</option>
                        <option>Manual</option>
                      </select>
                    </div>

                    <div class="field">
                      <label for="aSearch">Pesquisar ativo</label>
                      <input class="input" id="aSearch" type="text" placeholder="Pesquisar por nome/ref/zona‚Ä¶" />
                    </div>
                  </div>

                  <div class="grid-2">
                    <div class="field">
                      <label for="aZona">Zona (auto/preencher)</label>
                      <input class="input" id="aZona" type="text" placeholder="Ex.: Foz ¬∑ Porto" />
                    </div>

                    <div class="field">
                      <label for="aTipologia">Tipologia</label>
                      <input class="input" id="aTipologia" type="text" placeholder="Ex.: T3" />
                    </div>
                  </div>

                  <div class="grid-2">
                    <div class="field">
                      <label for="aPreco">Pre√ßo pedido</label>
                      <input class="input" id="aPreco" type="text" placeholder="Ex.: 780000" />
                    </div>

                   <div class="field">
  <label for="aObs">Observa√ß√µes</label>
  <textarea id="aObs" placeholder="Resumo do an√∫ncio (FSBO/KIT) ou notas do ativo‚Ä¶"></textarea>
</div>
                  </div>

                  <div class="hint">
                    Nota: aqui ligamos depois ao teu dataset (Mapa/Angaria√ß√µes/FSBO) para autopreencher e evitar duplica√ß√£o.
                  </div>
                </div>

                <div id="assetZona" class="hidden" style="margin-top:10px">
                  <div class="grid-2">
                    <div class="field">
                      <label for="zZona">Zona</label>
                      <input class="input" id="zZona" type="text" placeholder="Ex.: Foz ¬∑ Porto" />
                    </div>
                    <div class="field">
                      <label for="zTipologia">Tipologia</label>
                      <input class="input" id="zTipologia" type="text" placeholder="Ex.: T2/T3" />
                    </div>
                  </div>

                  <div class="grid-3">
                    <div class="field">
                      <label for="zSegmento">Segmento</label>
                      <select id="zSegmento">
                        <option>Novo</option>
                        <option>Usado</option>
                        <option>Reabilitado</option>
                        <option>Luxo</option>
                      </select>
                    </div>
                    <div class="field">
                      <label for="zMin">Pre√ßo alvo (m√≠n.)</label>
                      <input class="input" id="zMin" type="text" placeholder="‚Ç¨" />
                    </div>
                    <div class="field">
                      <label for="zMax">Pre√ßo alvo (m√°x.)</label>
                      <input class="input" id="zMax" type="text" placeholder="‚Ç¨" />
                    </div>
                  </div>
                </div>
              </div>

<!-- STEP 4 (adiado) -->
<div id="step4" class="hidden">

  <div class="drop" id="pdfDrop">
    <div class="d-left">
      <p class="d-title">PDF ‚Äî Anexos do relat√≥rio</p>
      <p class="d-sub">
        Adicione PDFs (estudos, plantas, relat√≥rios externos). Ficam ligados ao relat√≥rio e podem ser abertos/transferidos localmente.
        <br><span class="hint">Nota: os ficheiros s√£o guardados no seu browser (sem servidor). Para ficheiros grandes, √© usada uma base de dados local (IndexedDB).</span>
      </p>
    </div>
    <div class="d-actions">
      <input id="pdfInput" type="file" accept="application/pdf" multiple class="hidden" />
      <button class="btn primary" id="btnAddPdf">+ Adicionar PDF</button>
      <button class="btn secondary" id="btnClearPdfs">Limpar PDFs</button>
    </div>
  </div>

  <div class="files" id="pdfList" aria-label="Lista de PDFs" style="margin-top:12px">
    <!-- preenchido por JS -->
  </div>

  <div class="analysis" style="margin-top:12px">
    <div class="mini-card">
      <h5>Estado</h5>
      <div class="kv"><b>Anexos</b><span id="pdfCount">0</span></div>
      <div class="kv"><b>Armazenamento</b><span id="pdfStoreMode">‚Äî</span></div>
      <div class="kv"><b>√öltima a√ß√£o</b><span id="pdfLastAction">‚Äî</span></div>
    </div>

    <div class="mini-card assist-card">
      <h5>Extra√ß√£o assistida</h5>
      <div class="hint">
        Sem PDF.js: cole aqui texto relevante do estudo (copiado do PDF) e o sistema estrutura em
        <strong>cap√≠tulos</strong>, <strong>insights</strong> e <strong>palavras-chave</strong>,
        para integra√ß√£o direta no PDF final.
      </div>
      <div class="divider" style="margin:10px 0"></div>
      <div class="field" style="margin-bottom:8px">
        <label for="pdfAssistText">Texto do estudo (colar)</label>
        <textarea id="pdfAssistText" placeholder="Cole aqui texto do PDF (ex.: resumo, conclus√µes, indicadores, p√°ginas relevantes)‚Ä¶"></textarea>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn primary" id="btnAssistExtract">Estruturar (cap√≠tulos + insights)</button>
        <button class="btn secondary" id="btnAssistClear">Limpar</button>
      </div>
      <div id="assistStatus" class="hint" style="margin-top:8px">‚Äî</div>
    </div>

    <div class="mini-card">
      <h5>Boas pr√°ticas</h5>
      <div class="hint">
        Use PDFs com nomes claros (ex.: ‚ÄúEstudo_Mercado_Foz_2025.pdf‚Äù). Evite anexos duplicados para manter o relat√≥rio leve.
      </div>
    </div>
  </div>

  <div class="panel" style="margin-top:12px" id="assistPreviewPanel">
    <div class="panel-head">
      <div class="title">
        <span style="display:inline-flex;width:26px;height:26px;border-radius:999px;border:1px solid var(--gold);align-items:center;justify-content:center;">
          <svg width="16" height="16" viewBox="0 0 24 24" stroke="var(--gold)" fill="none" stroke-width="1.8">
            <path d="M4 6h16M4 12h16M4 18h10" />
          </svg>
        </span>
        <span>Pr√©-visualiza√ß√£o da extra√ß√£o</span>
      </div>
      <div class="hint" style="margin:0">Guardado no relat√≥rio atual</div>
    </div>

    <div class="panel-body">
      <div id="assistPreview" class="hint">
        Sem extra√ß√£o ainda. Cole texto e clique em <strong>Estruturar</strong>.
      </div>
    </div>
  </div>

</div>

              <!-- STEP 5 -->
              <div id="step5" class="hidden">
                <div class="section-title">Estrutura do relat√≥rio</div>

                <div class="switches">
                  <label class="sw"><span class="l"><b>Resumo Executivo</b><span>1 p√°gina com decis√£o + mensagem final.</span></span><input id="sExec" type="checkbox" checked></label>
                  <label class="sw"><span class="l"><b>Contexto do Cliente</b><span>Objetivo, preocupa√ß√µes e perfil.</span></span><input id="sContexto" type="checkbox" checked></label>
                  <label class="sw"><span class="l"><b>Enquadramento de Mercado</b><span>Insights (a ligar mais tarde).</span></span><input id="sMercado" type="checkbox" checked></label>
                  <label class="sw"><span class="l"><b>Compar√°veis</b><span>Concorr√™ncia e posicionamento (quando aplic√°vel).</span></span><input id="sComps" type="checkbox"></label>
                  <label class="sw"><span class="l"><b>Cen√°rios</b><span>Impacto de pre√ßo/timing/estrat√©gia.</span></span><input id="sCenarios" type="checkbox" checked></label>
                  <label class="sw"><span class="l"><b>Recomenda√ß√£o Garvetur</b><span>O ‚Äúo que fazer‚Äù com racional.</span></span><input id="sRecomend" type="checkbox" checked></label>
                  <label class="sw"><span class="l"><b>Plano de a√ß√£o</b><span>Pr√≥ximos passos, prazos, responsabilidades.</span></span><input id="sPlano" type="checkbox" checked></label>
                  <label class="sw"><span class="l"><b>Anexos</b><span>(a ligar depois).</span></span><input id="sAnexos" type="checkbox" checked></label>
                </div>

                <div class="divider"></div>

                <div class="grid-2">
                  <div class="field">
                    <label for="rTom">Tom</label>
                    <select id="rTom">
                      <option>Conservador</option>
                      <option selected>Neutro</option>
                      <option>Assertivo</option>
                    </select>
                  </div>

                  <div class="field">
                    <label for="rCTA">Call-to-action final</label>
                    <select id="rCTA">
                      <option>Agendar reuni√£o</option>
                      <option>Avalia√ß√£o presencial</option>
                      <option>Ajuste de pre√ßo</option>
                      <option>Estrat√©gia de marketing</option>
                      <option>Mandato</option>
                    </select>
                  </div>
                </div>

                <div class="field">
                  <label for="rRecomend">Recomenda√ß√£o final (obrigat√≥rio)</label>
                  <textarea id="rRecomend" placeholder="Mensagem final para o cliente: decis√£o sugerida, racional, e pr√≥ximos passos."></textarea>
                </div>

                <!-- Templates oficiais (Sprint 1) -->
<div class="panel" style="margin-top:12px">
  <div class="panel-head">
    <div class="title">
      <span style="display:inline-flex;width:26px;height:26px;border-radius:999px;border:1px solid var(--gold);align-items:center;justify-content:center;">
        <svg width="16" height="16" viewBox="0 0 24 24" stroke="var(--gold)" fill="none" stroke-width="1.8">
          <path d="M4 6h16M4 12h16M4 18h10" />
        </svg>
      </span>
      <span>Templates oficiais (Garvetur Luxury Porto)</span>
    </div>
    <div class="hint" style="margin:0">Aplica√ß√£o r√°pida ao ‚ÄúTom‚Äù e √† ‚ÄúRecomenda√ß√£o‚Äù</div>
  </div>

  <div class="panel-body">
    <div class="grid2" style="gap:10px">
      <div class="field">
        <label>Tom do relat√≥rio</label>
        <select id="tplTom">
          <option value="assertivo">Assertivo (decis√£o clara)</option>
          <option value="prudente">Prudente (consultivo/risco controlado)</option>
        </select>
      </div>

      <div class="field">
        <label>Estilo de Recomenda√ß√£o Garvetur</label>
        <select id="tplRec">
          <option value="decisiva">Decisiva (orientada √† a√ß√£o)</option>
          <option value="consultiva">Consultiva (orientada a valida√ß√£o)</option>
        </select>
      </div>
    </div>

    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">
      <button class="btn primary" id="btnApplyTemplates">Aplicar templates</button>
      <button class="btn secondary" id="btnResetTemplates">Repor (manual)</button>
      <div class="hint" id="tplStatus" style="margin-left:auto">‚Äî</div>
    </div>
  </div>
</div>
<!-- /Templates oficiais (Sprint 1) -->

                <div class="cta-row">
  <button class="btn primary" id="btnBuildPdf">Gerar PDF</button>
  <button class="btn" id="btnBuildPremium">‚≠ê Gerar PDF Premium</button>
  <button class="btn" id="btnBuildExec">Gerar vers√£o executiva</button>
  <button class="btn secondary" id="btnDuplicate">Duplicar como template</button>
</div>

                <div class="hint" style="margin-top:10px">
                  Nota: a gera√ß√£o PDF √© local (impress√£o) com pr√©‚Äëvisualiza√ß√£o. Para guardar em PDF, use ‚ÄúImprimir / Guardar em PDF‚Äù no modal.
                </div>
              </div>

            </div>

            <div class="panel-foot">
              <div class="hint" id="wizardHint">Preencha os campos essenciais e avance. O sistema guarda rascunho automaticamente.</div>
              <div style="display:flex;gap:8px;flex-wrap:wrap">
                <button class="btn secondary" id="btnPrev">Anterior</button>
                <button class="btn primary" id="btnNext">Seguinte</button>
              </div>
            </div>
          </div>
        </section>

      </main>
    </div>
  </div>


<!-- PDF Preview Modal -->
<div id="pdfModal" class="hidden" aria-hidden="true" style="position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,.70);display:flex;align-items:center;justify-content:center;padding:18px">
  <div style="width:min(1100px,96vw);height:min(86vh,860px);background:#0b0b0b;border:1px solid rgba(163,139,99,.35);border-radius:18px;box-shadow:0 22px 44px rgba(0,0,0,.65);overflow:hidden;display:flex;flex-direction:column">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.10);background:linear-gradient(90deg,#050505,#111,#050505);flex-wrap:wrap">
      <div style="display:flex;flex-direction:column;gap:2px">
        <div style="font-size:11px;color:rgba(255,255,255,.65);letter-spacing:.14em;text-transform:uppercase">Pr√©-visualiza√ß√£o PDF</div>
        <div id="pdfModalTitle" style="font-size:12px;color:#A38B63;font-weight:900;letter-spacing:.06em;text-transform:uppercase">Documento</div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn" id="pdfModalDownload">Download</button>
        <button class="btn secondary" id="pdfModalClose">Fechar</button>
      </div>
    </div>
    <div style="flex:1;min-height:0;background:#000">
      <iframe id="pdfModalFrame" title="PDF" style="width:100%;height:100%;border:0;background:#000"></iframe>
    </div>
    <div style="padding:10px 12px;border-top:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.35)">
      <div class="hint">Se o seu navegador bloquear a abertura em nova aba, utilize esta pr√©-visualiza√ß√£o. Para melhor exporta√ß√£o em ‚ÄúImprimir para PDF‚Äù, desative ‚ÄúCabe√ßalhos e rodap√©s‚Äù nas op√ß√µes de impress√£o.</div>
    </div>
  </div>
</div>
  <!-- Manual Modal (Produto Interno Premium) -->
<div id="manualModal" class="hidden" aria-hidden="true"
     style="position:fixed;inset:0;z-index:10010;background:rgba(0,0,0,.72);display:flex;align-items:center;justify-content:center;padding:18px">

  <div style="width:min(1100px,96vw);height:min(86vh,860px);background:#0b0b0b;border:1px solid rgba(163,139,99,.35);
              border-radius:18px;box-shadow:0 22px 44px rgba(0,0,0,.65);overflow:hidden;display:flex;flex-direction:column">

    <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.10);
                background:linear-gradient(90deg,#050505,#111,#050505);flex-wrap:wrap">

      <div style="display:flex;flex-direction:column;gap:2px">
        <div style="font-size:11px;color:rgba(255,255,255,.65);letter-spacing:.14em;text-transform:uppercase">
          Manual Interno Premium
        </div>
        <div id="manualModalTitle" style="font-size:12px;color:#A38B63;font-weight:900;letter-spacing:.06em;text-transform:uppercase">
          Playbook de Relat√≥rio ‚Äî Garvetur Luxury
        </div>
      </div>

      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn" id="manualModalPrint">Imprimir / Guardar em PDF</button>
        <button class="btn secondary" id="manualModalClose">Fechar</button>
      </div>
    </div>

    <div style="flex:1;min-height:0;background:#000">
      <iframe id="manualModalFrame" title="Manual"
              style="width:100%;height:100%;border:0;background:#000"></iframe>
    </div>

    <div style="padding:10px 12px;border-top:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.35)">
      <div class="hint">
        Este manual √© um documento interno. Recomenda-se n√£o partilhar fora da Garvetur Luxury. Para exporta√ß√£o, use ‚ÄúImprimir / Guardar em PDF‚Äù.
      </div>
    </div>

  </div>
</div>

  <!-- MODAL ‚Äî RELAT√ìRIO PREMIUM -->
<div id="premiumModal" class="hidden" aria-hidden="true"
     style="position:fixed; inset:0; z-index:10011; display:flex; align-items:center; justify-content:center; padding:18px; background:rgba(0,0,0,.72);">

  <div style="width:min(1100px, 96vw); height:min(86vh, 860px); background:#0b0b0b; border:1px solid rgba(163,139,99,.35);
              border-radius:18px; overflow:hidden; box-shadow:0 22px 44px rgba(0,0,0,.65); display:flex; flex-direction:column;">

    <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.10);
                background:linear-gradient(90deg,#050505,#111,#050505);flex-wrap:wrap">
      <div style="display:flex;flex-direction:column;gap:2px">
        <div style="font-size:11px;color:rgba(255,255,255,.65);letter-spacing:.14em;text-transform:uppercase">
          Biblioteca Interna
        </div>
        <div id="premiumModalTitle" style="font-size:12px;color:#A38B63;font-weight:900;letter-spacing:.06em;text-transform:uppercase">
          Relat√≥rio Premium ‚Äî Garvetur Luxury
        </div>
      </div>

      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn" id="premiumModalPrint">Imprimir / Guardar em PDF</button>
        <button class="btn secondary" id="premiumModalClose">Fechar</button>
      </div>
    </div>

    <div style="flex:1;min-height:0;background:#000">
      <iframe id="premiumModalFrame" title="Relat√≥rio Premium"
              style="width:100%;height:100%;border:0;background:#000"></iframe>
    </div>

    <div style="padding:10px 12px;border-top:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.35)">
      <div class="hint">
        Documento interno de refer√™ncia editorial. Para exporta√ß√£o, use ‚ÄúImprimir / Guardar em PDF‚Äù.
      </div>
    </div>

  </div>
</div>

<script>
(function(){
  /* ===========================
     Helpers
  =========================== */
  const el = (id)=>document.getElementById(id);
  const $$ = (sel, root=document)=>Array.from(root.querySelectorAll(sel));
  const todayISO = ()=> new Date().toISOString().slice(0,10);

  function safeJSONParse(raw, fallback){
    try{ return raw ? JSON.parse(raw) : fallback; }catch{ return fallback; }
  }
  function uid(prefix='rpt'){
    return prefix + '_' + Math.random().toString(16).slice(2) + '_' + Date.now().toString(16);
  }
  function toPTDate(iso){
    try{
      const d = new Date(iso);
      if(isNaN(d.getTime())) return iso;
      return d.toLocaleDateString('pt-PT');
    }catch{ return iso; }
  }
  function normStr(s){ return (s||'').toString().trim(); }

  function htmlEscape(s){
    return String(s||'')
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;');
  }

  function stripAccents(s){
    try{
      return (s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'');
    }catch{
      return (s||'');
    }
  }
  function normEmail(s){ return (s||'').toString().trim().toLowerCase(); }
  function normPhone(s){
    const d = (s||'').toString().replace(/\D/g,'');
    // PT typical last 9 digits
    return d.length>9 ? d.slice(-9) : d;
  }
  function normName(s){
    return stripAccents((s||'').toString().trim().toLowerCase()).replace(/\s+/g,' ');
  }

  /* ===========================
     Storage: Relat√≥rios (meta)
  =========================== */
  const LS_KEY = 'gpp_relatorios_cliente_v1';

  function loadAllReports(){ return safeJSONParse(localStorage.getItem(LS_KEY), []); }
  function saveAllReports(list){ localStorage.setItem(LS_KEY, JSON.stringify(list || [])); }
  function getReport(id){ return loadAllReports().find(r=>r.id===id) || null; }
  function upsertReport(report){
    const list = loadAllReports();
    const idx = list.findIndex(r=>r.id===report.id);
    if(idx>=0) list[idx] = report;
    else list.unshift(report);
    saveAllReports(list);
  }
  function deleteReport(id){
    const list = loadAllReports().filter(r=>r.id!==id);
    saveAllReports(list);
  }

      /* ===========================
     Cross-module import (FSBO | Leads | Angaria√ß√µes)
     Objetivo:
     - N√ÉO depender de keys fixas.
     - Varre TODO o localStorage (JSON) e extrai ‚Äúcontactos‚Äù (nome/telem√≥vel/email).
     - Prioridade de pesquisa: 1) Nome 2) Telefone 3) Email
     Nota:
     - Apenas autopreenche campos vazios (n√£o sobrep√µe o que j√° escreveu).
     - Mant√©m tudo local (browser), sem servidor.
  =========================== */

  // Campos (sin√≥nimos) mais comuns encontrados nos m√≥dulos
  const CONTACT_FIELD_MAP = {
    name:   ['nome', 'name', 'cliente', 'client', 'proprietario', 'propriet√°rio', 'owner', 'contacto', 'contato', 'titular', 'empresa', 'company', 'lead', 'leadName', 'nomeProp', 'ownerName', 'leadNome', 'clienteNome', 'nomeCliente', 'contactName'],
    phone:  ['telemovel', 'telem√≥vel', 'telefone', 'tel', 'phone', 'mobile', 'contactoTel', 'contactTel', 'whatsapp', 'telProp', 'telefoneProp', 'telemovelProp', 'telem√≥velProp', 'ownerPhone', 'ownerMobile', 'contactPhone', 'contactMobile', 'clienteTel', 'clienteTelefone'],
    email:  ['email', 'e-mail', 'mail', 'contactoEmail', 'contactEmail', 'emailProp', 'ownerEmail', 'clienteEmail']
  };
  const ASSET_FIELD_MAP = {
    zona: ['zona','localizacao','localiza√ß√£o','area','√°rea','bairro','district','concelho','freguesia','cidade','city','location','morada','endereco','endere√ßo','address'],
    tipologia: ['tipologia','typology','tipo','tipoImovel','tipoIm√≥vel','tipo_imovel','quartos','bedrooms','tipologiasEmp','tipologias'],
    preco: ['preco','pre√ßo','valor','price','precoPedido','preco_pedido','precoAnuncio','preco_anuncio','asking','askingPrice','valorPedido','valor_pedido'],
    obs: ['obs','observacoes','observa√ß√µes','notas','notes','descricao','descri√ß√£o','comentarios','coment√°rios','remarks','observacao','observa√ß√£o','obsInternas','obsCliente','resumo','resumoAnuncio','resumo_anuncio','resumoDoAnuncio','resumo_do_anuncio','anuncioResumo','anuncio_resumo','kitResumo','kit_resumo','resumoKit','resumo_kit','textoAnuncio','texto_anuncio','descricaoAnuncio','descricao_anuncio','descricaoPublica','descricao_publica','publicDescricao','public_description'],
    resumo: ['resumo','resumoAnuncio','resumo_anuncio','resumoDoAnuncio','resumo_do_anuncio','anuncioResumo','anuncio_resumo','kitResumo','kit_resumo','resumoKit','resumo_kit'],
    ref: ['ref','referencia','refer√™ncia','id','codigo','c√≥digo','code','reference','refInterna'],
    titulo: ['titulo','t√≠tulo','nomeImovel','nomeEmp','tituloImovel','title','empreendimento','imovel','im√≥vel','nome','designacao','designa√ß√£o']
  };


  function onlyDigits(s){ return (s||'').toString().replace(/\D+/g,''); }
  function normEmail(s){ return (s||'').toString().trim().toLowerCase(); }
  function normName(s){
    return (s||'')
      .toString()
      .trim()
      .toLowerCase()
      .normalize('NFD').replace(/[\u0300-\u036f]/g,'') // remove acentos
      .replace(/\s+/g,' ');
  }

  function pickFirstString(o, keys){
    for(const k of keys){
      if(o && typeof o === 'object' && k in o){
        const v = o[k];
        if(typeof v === 'string' && v.trim()) return v.trim();
        if(typeof v === 'number' && isFinite(v)) return String(v);
      }
    }
    return '';
  }

  function buildContactFromObject(obj, sourceKey){
    if(!obj || typeof obj !== 'object') return null;

    // tenta detectar campos diretos
    const nome = pickFirstString(obj, CONTACT_FIELD_MAP.name);
    const tel  = pickFirstString(obj, CONTACT_FIELD_MAP.phone);
    const mail = pickFirstString(obj, CONTACT_FIELD_MAP.email);

    // tamb√©m tenta dentro de subobjetos t√≠picos
    const subCandidates = [
  'cliente','contacto','contato','owner','proprietario','propriet√°rio','lead','dados','pessoa','person','empresa',
  // IMPORTANTES p/ FSBO / an√∫ncios:
  'kit','anuncio','an√∫ncio','imovel','im√≥vel','ativo','asset','property'
];
    let nome2='', tel2='', mail2='';
    for(const s of subCandidates){
      const sub = obj[s];
      if(sub && typeof sub === 'object'){
        nome2 = nome2 || pickFirstString(sub, CONTACT_FIELD_MAP.name);
        tel2  = tel2  || pickFirstString(sub, CONTACT_FIELD_MAP.phone);
        mail2 = mail2 || pickFirstString(sub, CONTACT_FIELD_MAP.email);
      }
    }

    const finalName = (nome || nome2 || '').trim();
    const finalPhone = (tel || tel2 || '').trim();
    const finalEmail = (mail || mail2 || '').trim();

    // tenta extrair campos de ativo (zona/tipologia/pre√ßo/obs) quando existirem
    const zona1 = pickFirstString(obj, ASSET_FIELD_MAP.zona);
    const tip1  = pickFirstString(obj, ASSET_FIELD_MAP.tipologia);
    const preco1= pickFirstString(obj, ASSET_FIELD_MAP.preco);
    const obs1  = pickFirstString(obj, ASSET_FIELD_MAP.obs);
    const resumo1 = pickFirstString(obj, ASSET_FIELD_MAP.resumo);
    const ref1  = pickFirstString(obj, ASSET_FIELD_MAP.ref);
    const tit1  = pickFirstString(obj, ASSET_FIELD_MAP.titulo);

    let zona2='', tip2='', preco2='', obs2='', resumo2='', ref2='', tit2='';
    for(const s of subCandidates){
      const sub = obj[s];
      if(sub && typeof sub === 'object'){
        zona2 = zona2 || pickFirstString(sub, ASSET_FIELD_MAP.zona);
        tip2  = tip2  || pickFirstString(sub, ASSET_FIELD_MAP.tipologia);
        preco2= preco2|| pickFirstString(sub, ASSET_FIELD_MAP.preco);
        obs2  = obs2  || pickFirstString(sub, ASSET_FIELD_MAP.obs);
        resumo2 = resumo2 || pickFirstString(sub, ASSET_FIELD_MAP.resumo);
        ref2  = ref2  || pickFirstString(sub, ASSET_FIELD_MAP.ref);
        tit2  = tit2  || pickFirstString(sub, ASSET_FIELD_MAP.titulo);
      }
    }

    const asset = {
      zona: (zona1 || zona2 || '').trim(),
      tipologia: (tip1 || tip2 || '').trim(),
      preco: (preco1 || preco2 || '').trim(),
      obs: (obs1 || obs2 || '').trim(),
      resumo: (resumo1 || resumo2 || '').trim(),
      ref: (ref1 || ref2 || '').trim(),
      titulo: (tit1 || tit2 || '').trim()
    };

    if(!finalName && !finalPhone && !finalEmail) return null;

    return {
      nameRaw: finalName,
      phoneRaw: finalPhone,
      emailRaw: finalEmail,
      name: normName(finalName),
      phone: onlyDigits(finalPhone),
      email: normEmail(finalEmail),
      sourceKey: sourceKey || '',
      asset,
      // campos extra √∫teis (se existirem)
      notes: pickFirstString(obj, ['notas','notes','obs','observacoes','observa√ß√µes','descricao','descri√ß√£o','comentarios','coment√°rios']) || ''
    };
  }

  function extractContactsDeep(value, sourceKey, out, depth=0){
    if(depth > 4) return; // limite para evitar varreduras pesadas
    if(value == null) return;

    if(Array.isArray(value)){
      for(const item of value){
        if(out.length > 2500) break;
        extractContactsDeep(item, sourceKey, out, depth+1);
      }
      return;
    }

    if(typeof value === 'object'){
      const c = buildContactFromObject(value, sourceKey);
      if(c) out.push(c);

      const likelyCollections = ['items','data','rows','list','cards','leads','clientes','contacts','contactos','contatos','registos','records'];
      for(const k of likelyCollections){
        if(value[k] != null){
          extractContactsDeep(value[k], sourceKey, out, depth+1);
        }
      }

      const keys = Object.keys(value);
      for(let i=0;i<Math.min(keys.length, 24);i++){
        const k = keys[i];
        const v = value[k];
        if(v && typeof v === 'object'){
          extractContactsDeep(v, sourceKey, out, depth+1);
        }
      }
    }
  }

  // Cache simples para n√£o varrer sempre
  let CONTACT_INDEX_CACHE = null;
  let CONTACT_INDEX_CACHE_AT = 0;

  function scanLocalStorageForContacts(){
    const now = Date.now();
    if(CONTACT_INDEX_CACHE && (now - CONTACT_INDEX_CACHE_AT) < 2500){
      return CONTACT_INDEX_CACHE;
    }

    const contacts = [];
    const seen = new Set(); // dedupe por (name|phone|email)

    for(let i=0;i<localStorage.length;i++){
      const k = localStorage.key(i);
      if(!k) continue;

      // evita varrer o pr√≥prio m√≥dulo de relat√≥rios e chaves √≥bvias
      if(k === LS_KEY) continue;
      if(k.startsWith('gpp_relatorios_cliente_')) continue;

      const raw = localStorage.getItem(k);
      if(!raw || raw.length < 2) continue;
      if(raw.length > 6_000_000) continue;

      let parsed = null;
      try{ parsed = JSON.parse(raw); }catch{ continue; }

      extractContactsDeep(parsed, k, contacts, 0);
      if(contacts.length > 2500) break;
    }

    const cleaned = [];
    for(const c of contacts){
      const sig = `${c.name}|${c.phone}|${c.email}`;
      if(seen.has(sig)) continue;

      const hasSomething = (c.name && c.name.length >= 3) || (c.phone && c.phone.length >= 7) || (c.email && c.email.includes('@'));
      if(!hasSomething) continue;

      seen.add(sig);
      cleaned.push(c);
      if(cleaned.length > 2000) break;
    }

    CONTACT_INDEX_CACHE = cleaned;
    CONTACT_INDEX_CACHE_AT = now;
    return cleaned;
  }

  function pickBestByCompleteness(list){
    if(!list || !list.length) return null;
    const score = (c)=>(c.name?2:0) + (c.phone?2:0) + (c.email?2:0) + (c.notes?1:0);
    return list.slice().sort((a,b)=>score(b)-score(a))[0] || null;
  }

function findContactPriority({name, phone, email}){
  const idx = scanLocalStorageForContacts();

  const nameN  = normName(name);
  const phoneN = onlyDigits(phone);
  const emailN = normEmail(email);

  // 1) Nome
  if(nameN && nameN.length >= 3){
    const exact = idx.filter(c=>c.name && c.name === nameN);
    if(exact.length) return pickBestByCompleteness(exact);

    const includes = idx.filter(c=>c.name && (c.name.includes(nameN) || nameN.includes(c.name)));
    if(includes.length) return pickBestByCompleteness(includes);
  }

  // 2) Telefone
  if(phoneN && phoneN.length >= 7){
    const byPhone = idx.filter(c=>c.phone && (c.phone === phoneN || c.phone.endsWith(phoneN) || phoneN.endsWith(c.phone)));
    if(byPhone.length) return pickBestByCompleteness(byPhone);
  }

  // 3) Email
  if(emailN && emailN.includes('@')){
    const byEmail = idx.filter(c=>c.email && c.email === emailN);
    if(byEmail.length) return pickBestByCompleteness(byEmail);
  }

  return null;
}

// Lista de correspond√™ncias (para escolha quando existir ambiguidade)
function findContactsPriorityList({name, phone, email}, maxResults=8){
  const idx = scanLocalStorageForContacts();
  const nameN  = normName(name);
  const phoneN = onlyDigits(phone);
  const emailN = normEmail(email);

  const scored = [];

  for(const c of idx){
    let score = 0;

    if(nameN && c.name){
      if(c.name === nameN) score += 30;
      else if(c.name.includes(nameN) || nameN.includes(c.name)) score += 18;
    }

    if(phoneN && c.phone){
      if(c.phone === phoneN || c.phone.endsWith(phoneN) || phoneN.endsWith(c.phone)) score += 20;
    }

    if(emailN && c.email){
      if(c.email === emailN) score += 12;
    }

    // b√≥nus por completude
    score += (c.name?3:0) + (c.phone?3:0) + (c.email?3:0) + (c.notes?1:0);

    if(score>0) scored.push({ ...c, _score: score });
  }

  scored.sort((a,b)=> b._score - a._score);
  return scored.slice(0, maxResults);
}

function showContactChooser(matches, onPick){
  const overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.65);z-index:9999;display:flex;align-items:center;justify-content:center;padding:14px;';
  overlay.innerHTML = `
    <div style="max-width:760px;width:100%;background:#0f0f0f;border:1px solid rgba(163,139,99,.35);border-radius:16px;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.7)">
      <div style="padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.10);display:flex;justify-content:space-between;gap:10px;align-items:center">
        <div style="font-weight:900;letter-spacing:.06em;text-transform:uppercase;color:#A38B63;font-size:12px">Selecionar registo para importar</div>
        <button id="gppCloseChooser" class="btn secondary" style="padding:6px 10px;font-size:12px">Cancelar</button>
      </div>
      <div style="max-height:60vh;overflow:auto">
        ${matches.map((m,i)=>`
          <div data-i="${i}" style="padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.08);cursor:pointer">
            <div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start;flex-wrap:wrap">
              <div>
                <div style="font-weight:800;color:#fff">${htmlEscape(m.nameRaw || '‚Äî')}</div>
                <div style="color:#aaa;font-size:12px;margin-top:3px">${htmlEscape(m.phoneRaw || '‚Äî')} ¬∑ ${htmlEscape(m.emailRaw || '‚Äî')}</div>
              </div>
              <div style="text-align:right;color:#aaa;font-size:12px">
                <div>${htmlEscape(sourceLabelFromKey(m.sourceKey))}</div>
                <div style="opacity:.8">score: ${m._score}</div>
              </div>
            </div>
          </div>
        `).join('')}
      </div>
    </div>
  `;
  document.body.appendChild(overlay);

  const close = ()=>{ try{ overlay.remove(); }catch{} };
  overlay.addEventListener('click', (e)=>{
    if(e.target === overlay) return close();
    if(e.target.closest('#gppCloseChooser')) return close();
    const row = e.target.closest('[data-i]');
    if(row){
      const pick = matches[Number(row.dataset.i)];
      close();
      onPick && onPick(pick);
    }
  });
}

  function sourceLabelFromKey(k){
    const s = (k||'').toLowerCase();
    if(s.includes('fsbo') || s.includes('particul')) return 'FSBO';
    if(s.includes('lead') || s.includes('kanban')) return 'Leads';
    if(s.includes('angaria') || s.includes('listing')) return 'Angaria√ß√µes';
    return k || 'localStorage';
  }

  // Compatibilidade com vers√µes anteriores do m√≥dulo (UI existente)
  function findBestContact({ nome, tel, email }){
    const hit = findContactPriority({ name: nome, phone: tel, email });
    if(!hit) return null;
    return {
      nome: hit.nameRaw || '',
      tel: hit.phoneRaw || '',
      email: hit.emailRaw || '',
      sourceKey: hit.sourceKey || '',
      source: sourceLabelFromKey(hit.sourceKey),
      raw: hit,
      id: null
    };
  }

  function initCrossModuleImport(){
    const iNome  = el('cNome');
    const iTel   = el('cTel');
    const iEmail = el('cEmail');
    const iNotas = el('cNotas');

    if(!iNome || !iTel || !iEmail) return;

    function ensureAutoHint(){
      let node = document.getElementById('autoImportHint');
      if(node) return node;

      const emailField = iEmail.closest('.field');
      if(!emailField) return null;

      node = document.createElement('div');
      node.id = 'autoImportHint';
      node.className = 'hint';
      node.style.marginTop = '6px';
      node.textContent = 'Auto-importa√ß√£o: pronta (procura em FSBO | Leads | Angaria√ß√µes quando existir hist√≥rico).';
      emailField.appendChild(node);
      return node;
    }

    function showMsg(msg, type='info'){
      const node = ensureAutoHint();
      if(!node) return;
      node.textContent = msg;
      node.style.color = (type==='ok') ? '#A5D6A7' : (type==='warn' ? '#ffb4b4' : 'var(--muted)');
    }

    function applyContact(contact){
      if(!contact) return false;
      let changed = false;

      if(!normStr(iNome.value) && contact.nameRaw){
        iNome.value = contact.nameRaw;
        changed = true;
      }
      if(!normStr(iTel.value) && contact.phoneRaw){
        iTel.value = contact.phoneRaw;
        changed = true;
      }
      if(!normStr(iEmail.value) && contact.emailRaw){
        iEmail.value = contact.emailRaw;
        changed = true;
      }

      const note = (contact.notes || '').trim();
      if(note && iNotas && !normStr(iNotas.value).includes(note)){
        iNotas.value = (normStr(iNotas.value) ? (iNotas.value.trim() + "\n") : '') + `Importado do hist√≥rico: ${note}`;
        changed = true;
      }

      if(changed && typeof scheduleAutosave === 'function'){
        scheduleAutosave();
      }
      return changed;
    }

    let timer = null;
    function schedule(){
      clearTimeout(timer);
      timer = setTimeout(()=>{
        const query = { name: normStr(iNome.value), phone: normStr(iTel.value), email: normStr(iEmail.value) };
        const hit = findContactPriority(query);

        if(hit){
          const changed = applyContact(hit);
          showMsg(
            changed ? `Auto-importa√ß√£o: dados carregados do hist√≥rico (${hit.sourceKey}).`
                    : `Auto-importa√ß√£o: encontrado no hist√≥rico (${hit.sourceKey}).`,
            'ok'
          );
        }else{
          showMsg('Auto-importa√ß√£o: sem correspond√™ncia (pode inserir manualmente).','info');
        }
      }, 450);
    }

    [iNome, iTel, iEmail].forEach(inp=>{
      inp.addEventListener('input', schedule);
      inp.addEventListener('change', schedule);
      inp.addEventListener('blur', schedule);
    });

    window.addEventListener('storage', ()=>{
      CONTACT_INDEX_CACHE = null;
      CONTACT_INDEX_CACHE_AT = 0;
    });

    // primeira verifica√ß√£o (se j√° vierem campos preenchidos)
    schedule();
  }


  /* ===========================
     UI Elements
  =========================== */
  const q = el('q');
  const fStatus = el('fStatus');
  const fTipo = el('fTipo');
  const fDataDe = el('fDataDe');
  const fDataAte = el('fDataAte');
  const fConfidencial = el('fConfidencial');

  const btnApply = el('btnApply');
  const btnClear = el('btnClear');

  const reportsTbody = el('reportsTbody');

  const tabList = el('tabList');
  const tabWizard = el('tabWizard');
  const viewList = el('viewList');
  const viewWizard = el('viewWizard');

  const btnNew = el('btnNew');
  const btnGoWizard = el('btnGoWizard');
  const btnBackToList = el('btnBackToList');
  const btnSaveDraft = el('btnSaveDraft');

  const btnPrev = el('btnPrev');
  const btnNext = el('btnNext');

  const steps = $$('.step');
  const stepTitle = el('stepTitle');

  // Step fields
  const cTipo = el('cTipo');
  const cNome = el('cNome');
  const cTel = el('cTel');
  const cEmail = el('cEmail');
  const cIdioma = el('cIdioma');
  const cDetalhe = el('cDetalhe');
  const cConf = el('cConf');
  const cNotas = el('cNotas');

  const autoImportBadge = el('autoImportBadge');
  const autoImportText = el('autoImportText');

  const oObjetivo = el('oObjetivo');
  const oHorizonte = el('oHorizonte');
  const oRisco = el('oRisco');
  const oPreocup = el('oPreocup');
  const oBrief = el('oBrief');

  const aFonte = el('aFonte');
  const aSearch = el('aSearch');
  const aZona = el('aZona');
  const aTipologia = el('aTipologia');
  const aPreco = el('aPreco');
  const aObs = el('aObs');

  const zZona = el('zZona');
  const zTipologia = el('zTipologia');
  const zSegmento = el('zSegmento');
  const zMin = el('zMin');
  const zMax = el('zMax');

  const sExec = el('sExec');
  const sContexto = el('sContexto');
  const sMercado = el('sMercado');
  const sComps = el('sComps');
  const sCenarios = el('sCenarios');
  const sRecomend = el('sRecomend');
  const sPlano = el('sPlano');
  const sAnexos = el('sAnexos');

  const rTom = el('rTom');
  const rCTA = el('rCTA');
  const rRecomend = el('rRecomend');

  const btnBuildPdf = el('btnBuildPdf');
  const btnBuildExec = el('btnBuildExec');
  const btnDuplicate = el('btnDuplicate');
  const btnBuildPremium = el('btnBuildPremium');

  // ===========================
// Sprint 1 ‚Äî Templates Oficiais
// ===========================
const tplTom = el('tplTom');
const tplRec = el('tplRec');
const btnApplyTemplates = el('btnApplyTemplates');
const btnResetTemplates = el('btnResetTemplates');
const tplStatus = el('tplStatus');

    /* ===========================
     Manual Interno (Modal)
     - Modal independente do pdfModal (IDs e handlers pr√≥prios)
     - Abre um "manual" em HTML dentro de iframe (n√£o precisa de servidor)
  =========================== */

  const btnManual = el('btnManual');

  const manualModal = document.getElementById('manualModal');
  const manualModalFrame = document.getElementById('manualModalFrame');
  const manualModalClose = document.getElementById('manualModalClose');
  const manualModalPrint = document.getElementById('manualModalPrint');
  const manualModalTitle = document.getElementById('manualModalTitle');

  function buildManualHTML(){
    // Manual v1 (base). Depois evolu√≠mos para o Manual final, com checklist, templates e guidelines.
    return `
      <!doctype html>
      <html lang="pt-PT">
      <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Manual Interno ‚Äî Relat√≥rio Premium</title>
        <style>
          :root{--gold:#A38B63;--muted:#666;--txt:#111;}
          *{box-sizing:border-box}
          body{font-family:Arial,Helvetica,sans-serif;margin:0;background:#fff;color:var(--txt)}
          .page{max-width:980px;margin:0 auto;padding:26px 32px}
          .top{display:flex;justify-content:space-between;gap:12px;align-items:flex-start;flex-wrap:wrap}
          .brand{font-weight:900;letter-spacing:.08em;text-transform:uppercase;color:var(--gold);font-size:14px}
          .sub{margin-top:4px;color:var(--muted);font-size:12px;line-height:1.4}
          h1{margin:14px 0 6px;font-size:22px}
          h2{margin:18px 0 8px;font-size:13px;letter-spacing:.12em;text-transform:uppercase;color:#444}
          p{margin:0 0 10px;font-size:13px;line-height:1.55}
          .card{border:1px solid #eee;border-radius:14px;padding:12px 12px;margin-top:10px}
          ul{margin:8px 0 0 18px}
          li{margin:4px 0;font-size:13px;line-height:1.45}
          .pill{display:inline-block;border:1px solid #ddd;border-radius:999px;padding:4px 10px;font-size:11px;background:#fafafa}
          .foot{margin-top:18px;padding-top:10px;border-top:1px solid #eee;font-size:11px;color:#777;display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
        </style>
      </head>
      <body>
        <div class="page">
          <div class="top">
            <div>
              <div class="brand">Garvetur Luxury Porto</div>
              <div class="sub">Manual interno premium para produ√ß√£o do Relat√≥rio de An√°lise & Decis√£o.</div>
            </div>
            <div class="pill">Vers√£o: Manual v1</div>
          </div>

          <h1>Playbook ‚Äî Relat√≥rio √önico, Singular e Decisor</h1>

          <h2>Objetivo do documento</h2>
          <p>Garantir consist√™ncia, qualidade e diferencia√ß√£o: o cliente deve ‚Äúrever-se‚Äù no relat√≥rio do princ√≠pio ao fim, com narrativa orientada √† decis√£o e recomenda√ß√£o clara.</p>

          <h2>Checklist operacional (m√≠nimo obrigat√≥rio)</h2>
          <div class="card">
            <ul>
              <li>Cliente identificado (tipo, contexto, crit√©rios de decis√£o).</li>
              <li>Objetivo claro (horizonte, risco, preocupa√ß√µes).</li>
              <li>Ativo/Zona validado (dados essenciais preenchidos).</li>
              <li>Se existir estudo externo: anexar PDF e fazer extra√ß√£o assistida (texto colado) com cap√≠tulos/insights.</li>
              <li>Recomenda√ß√£o final escrita (clara, objetiva, com pr√≥ximos passos).</li>
            </ul>
          </div>

          <h2>Estrutura recomendada do relat√≥rio (padr√£o Garvetur Luxury)</h2>
          <div class="card">
            <ul>
              <li><strong>Resumo Executivo:</strong> decis√£o recomendada + racional em linguagem simples.</li>
              <li><strong>Contexto do Cliente:</strong> o ‚Äúporqu√™‚Äù (objetivo, receios, crit√©rios).</li>
              <li><strong>Enquadramento/mercado:</strong> 3‚Äì6 pontos que importam para a decis√£o.</li>
              <li><strong>Cen√°rios:</strong> pre√ßo/timing/estrat√©gia (impacto e trade-offs).</li>
              <li><strong>Recomenda√ß√£o Garvetur:</strong> o ‚Äúo que fazer‚Äù e ‚Äúcomo fazer‚Äù.</li>
              <li><strong>Plano de a√ß√£o:</strong> passos, prazos, responsabilidades.</li>
              <li><strong>Anexos:</strong> PDFs e s√≠ntese do estudo (extra√ß√£o assistida).</li>
            </ul>
          </div>

${forceExec ? `` : `
            <div class="sec">
              <h2>Pr√≥ximos passos</h2>
              <ul>
                <li>Validar objetivo e crit√©rios de decis√£o do cliente (10‚Äì15 min).</li>
                <li>Confirmar informa√ß√£o cr√≠tica j√° existente nos m√≥dulos (FSBO | Leads | Angaria√ß√µes).</li>
                <li>Alinhar estrat√©gia e calendariza√ß√£o.</li>
                <li><strong>CTA final:</strong> ${htmlEscape(report.report?.cta || 'Agendar reuni√£o')}.</li>
              </ul>
            </div>
` }

            <div class="foot">
            <span>Documento interno ¬∑ N√£o distribuir sem autoriza√ß√£o.</span>
            <span>Gerado localmente no browser</span>
          </div>
        </div>
      </body>
      </html>
    `;
  }

function openManualModal(){
  if(!manualModal || !manualModalFrame) return;

  // Carrega o manual externo (ficheiro ao mesmo n√≠vel do relatorio-cliente.html)
  manualModalFrame.removeAttribute('srcdoc'); // importante: desliga o modo srcdoc
  manualModalFrame.src = './manual.html';

  if(manualModalTitle) manualModalTitle.textContent = 'PLAYBOOK DE RELAT√ìRIO ‚Äî GARVETUR LUXURY';

  manualModal.classList.remove('hidden');
  manualModal.setAttribute('aria-hidden','false');

  // Imprimir / Guardar em PDF (imprime o conte√∫do do iframe)
  if(manualModalPrint){
    manualModalPrint.onclick = ()=>{
      try{
        const w = manualModalFrame.contentWindow;
        if(!w){ alert('N√£o foi poss√≠vel iniciar a impress√£o.'); return; }
        w.focus();
        w.print();
      }catch(e){
        console.error(e);
        alert('Falha ao abrir a impress√£o. Verifique permiss√µes do navegador.');
      }
    };
  }
}

  function closeManualModal(){
    if(!manualModal) return;
    manualModal.classList.add('hidden');
    manualModal.setAttribute('aria-hidden','true');
    if(manualModalFrame) manualModalFrame.src = 'about:blank';
  }

  btnManual?.addEventListener('click', openManualModal);
  manualModalClose?.addEventListener('click', closeManualModal);
  manualModal?.addEventListener('click', (e)=>{ if(e.target === manualModal) closeManualModal(); });

 // ESC fecha o manual, mas sem interferir com o pdfModal:
window.addEventListener('keydown', (e)=>{
  if(e.key === 'Escape'){
    if(manualModal && !manualModal.classList.contains('hidden')) closeManualModal();
  }
});

/* ===========================
   Relat√≥rio Premium (Modal)
=========================== */
const btnRelatorioPremium = el('btnRelatorioPremium');

const premiumModal = document.getElementById('premiumModal');
const premiumModalFrame = document.getElementById('premiumModalFrame');
const premiumModalClose = document.getElementById('premiumModalClose');
const premiumModalPrint = document.getElementById('premiumModalPrint');
const premiumModalTitle = document.getElementById('premiumModalTitle');

function openPremiumModal(){
  if(!premiumModal || !premiumModalFrame) return;

  premiumModalFrame.removeAttribute('srcdoc');
  premiumModalFrame.src = './relatorio-premium.html';

  if(premiumModalTitle) premiumModalTitle.textContent = 'RELAT√ìRIO PREMIUM ‚Äî GARVETUR LUXURY';

  premiumModal.classList.remove('hidden');
  premiumModal.setAttribute('aria-hidden','false');

  if(premiumModalPrint){
    premiumModalPrint.onclick = ()=>{
      try{
        const w = premiumModalFrame.contentWindow;
        if(!w){ alert('N√£o foi poss√≠vel iniciar a impress√£o.'); return; }
        w.focus();
        w.print();
      }catch(e){
        console.error(e);
        alert('Falha ao abrir a impress√£o. Verifique permiss√µes do navegador.');
      }
    };
  }
}

function closePremiumModal(){
  if(!premiumModal) return;
  premiumModal.classList.add('hidden');
  premiumModal.setAttribute('aria-hidden','true');
  if(premiumModalFrame) premiumModalFrame.src = 'about:blank';
}

btnRelatorioPremium?.addEventListener('click', openPremiumModal);
premiumModalClose?.addEventListener('click', closePremiumModal);
premiumModal?.addEventListener('click', (e)=>{ if(e.target === premiumModal) closePremiumModal(); });

window.addEventListener('keydown', (e)=>{
  if(e.key === 'Escape'){
    if(premiumModal && !premiumModal.classList.contains('hidden')) closePremiumModal();
  }
    
  });

  // Views & steps
  const stepEls = [null, el('step1'), el('step2'), el('step3'), el('step4'), el('step5')];
  let currentStep = 1;
  let ACTIVE_REPORT_ID = null; // relat√≥rio em edi√ß√£o
  let PDF_READY = false;

  function setTab(which){
    const isList = which === 'list';
    tabList.classList.toggle('active', isList);
    tabWizard.classList.toggle('active', !isList);
    viewList.classList.toggle('hidden', !isList);
    viewWizard.classList.toggle('hidden', isList);
  }

  function setStep(n){
    currentStep = Math.min(5, Math.max(1, n));
    // Passo 5: modo centrado (oculta lista de passos para dar espa√ßo ao relat√≥rio)
    try{ viewWizard.classList.toggle('step5-full', currentStep === 5); }catch(e){}
    steps.forEach(s => s.classList.toggle('active', Number(s.dataset.step) === currentStep));
    stepEls.forEach((node, idx)=>{ if(node) node.classList.toggle('hidden', idx !== currentStep); });

    const titles = {
      1:'Passo 1 ‚Äî Identifica√ß√£o do Cliente',
      2:'Passo 2 ‚Äî Objetivo e Perfil de Decis√£o',
      3:'Passo 3 ‚Äî Ativo / Zona em an√°lise',
      4:'Passo 4 ‚Äî PDF (adiado)',
      5:'Passo 5 ‚Äî Constru√ß√£o do Relat√≥rio'
    };
    stepTitle.textContent = titles[currentStep] || 'Passo';
    // inicializar PDFs quando entra no passo 4 (1x)
if(currentStep === 4 && !PDF_READY){
  PDF_READY = true;
  try{ initPdfPhase2(); }catch(e){ console.warn('PDF init falhou', e); }
}
    /* ===========================
   PASSO 4 ‚Äî Extra√ß√£o Assistida (Modo Foco)
=========================== */
try{
  const analysisPanel = document.querySelector('.analysis');
  if(analysisPanel){
    analysisPanel.classList.toggle('assist-focus', currentStep === 4);
  }
}catch(e){}
    btnPrev.disabled = false;
    btnPrev.textContent = (currentStep === 1) ? 'Voltar' : 'Anterior';
    btnNext.textContent = (currentStep === 5) ? 'Concluir' : 'Seguinte';

    // ao entrar no Passo 3, tentar carregar dados do ativo a partir do hist√≥rico (se ainda vazio)
    if(currentStep === 3){
      try{
        const emptyAsset = (!normStr(aZona?.value) && !normStr(aTipologia?.value) && !normStr(aPreco?.value) && !normStr(aObs?.value));
        if(emptyAsset){
          // se ainda estiver em Manual/Mapa e o cliente j√° foi reconhecido, assumir a fonte mais prov√°vel
          if(aFonte && ['Manual','Mapa',''].includes(normStr(aFonte.value))){
            const r0 = (ACTIVE_REPORT_ID ? getReport(ACTIVE_REPORT_ID) : null);
            const src0 = r0?.cliente?.importedFrom?.source || '';
            if(['Angaria√ß√µes','FSBO','Leads'].includes(src0)) aFonte.value = src0;
          }
          // tentar preencher (se houver correspond√™ncia em qualquer m√≥dulo)
          tryAutoFillAssetFromModules();
        }
      }catch(e){}
    }
  }

  function getSelectedAssetMode(){
    return document.querySelector('input[name="assetMode"]:checked')?.value || 'imovel';
  }

  function collectForm(){
    const mode = getSelectedAssetMode();
    const preocup = Array.from(oPreocup?.selectedOptions || []).map(o=>o.value);

    const base = {
      id: ACTIVE_REPORT_ID || uid('rpt'),
      createdAt: null,
      updatedAt: todayISO(),
      status: 'draft',

      cliente: {
        tipo: normStr(cTipo.value),
        nome: normStr(cNome.value),
        tel: normStr(cTel.value),
        email: normStr(cEmail.value),
        idioma: normStr(cIdioma.value || 'pt'),
        detalhe: normStr(cDetalhe.value || 'exec'),
        confidencial: (cConf.value === 'yes'),
        notas: normStr(cNotas.value),
        importedFrom: null
      },

      objetivo: {
        objetivo: normStr(oObjetivo.value),
        horizonte: normStr(oHorizonte.value),
        risco: normStr(oRisco.value),
        preocupacoes: preocup,
        brief: normStr(oBrief.value)
      },

      ativo: {
        mode,
        imovel: {
          fonte: normStr(aFonte.value),
          query: normStr(aSearch.value),
          zona: normStr(aZona.value),
          tipologia: normStr(aTipologia.value),
          preco: normStr(aPreco.value),
          obs: normStr(aObs.value)
        },
        zona: {
          zona: normStr(zZona.value),
          tipologia: normStr(zTipologia.value),
          segmento: normStr(zSegmento.value),
          min: normStr(zMin.value),
          max: normStr(zMax.value)
        }
      },

      pdfs: [],
      analysis: {
        metrics: { precoM2:'‚Äî', intervalo:'‚Äî', tendencia:'‚Äî', tempo:'‚Äî' },
        chapters: [],
        sum: { relevante:'', riscos:'', oportunidades:'' }
      },

      report: {
        sections: {
          exec: !!sExec.checked,
          contexto: !!sContexto.checked,
          mercado: !!sMercado.checked,
          comps: !!sComps.checked,
          cenarios: !!sCenarios.checked,
          recomend: !!sRecomend.checked,
          plano: !!sPlano.checked,
          anexos: !!sAnexos.checked
        },
        tom: normStr(rTom.value),
        cta: normStr(rCTA.value),
        recomendacaoFinal: normStr(rRecomend.value)
      }
    };

    const existing = ACTIVE_REPORT_ID ? getReport(ACTIVE_REPORT_ID) : null;
    base.createdAt = existing?.createdAt || todayISO();
    base.status = existing?.status || 'draft';
    base.pdfs = existing?.pdfs || [];
    base.analysis = existing?.analysis || base.analysis;
    base.cliente.importedFrom = existing?.cliente?.importedFrom || null;

    return base;
  }

  function fillForm(report){
    if(!report) return;

    ACTIVE_REPORT_ID = report.id;

    cTipo.value = report.cliente?.tipo || '';
    cNome.value = report.cliente?.nome || '';
    cTel.value = report.cliente?.tel || '';
    cEmail.value = report.cliente?.email || '';
    cIdioma.value = report.cliente?.idioma || 'pt';
    cDetalhe.value = report.cliente?.detalhe || 'exec';
    cConf.value = report.cliente?.confidencial ? 'yes' : 'no';
    cNotas.value = report.cliente?.notas || '';

    const imp = report.cliente?.importedFrom;
    setAutoImportUI(imp);

    oObjetivo.value = report.objetivo?.objetivo || '';
    oHorizonte.value = report.objetivo?.horizonte || '';
    oRisco.value = report.objetivo?.risco || '';
    const selected = new Set(report.objetivo?.preocupacoes || []);
    Array.from(oPreocup.options).forEach(opt=> opt.selected = selected.has(opt.value));
    oBrief.value = report.objetivo?.brief || '';

    const mode = report.ativo?.mode || 'imovel';
    const radios = $$('input[name="assetMode"]');
    radios.forEach(r=>{ r.checked = (r.value === mode); });
    const assetImovel = el('assetImovel');
    const assetZona = el('assetZona');
    assetImovel.classList.toggle('hidden', mode !== 'imovel');
    assetZona.classList.toggle('hidden', mode !== 'zona');

    aFonte.value = report.ativo?.imovel?.fonte || 'Manual';
    aSearch.value = report.ativo?.imovel?.query || '';
    aZona.value = report.ativo?.imovel?.zona || '';
    aTipologia.value = report.ativo?.imovel?.tipologia || '';
    aPreco.value = report.ativo?.imovel?.preco || '';
    aObs.value = report.ativo?.imovel?.obs || '';

    zZona.value = report.ativo?.zona?.zona || '';
    zTipologia.value = report.ativo?.zona?.tipologia || '';
    zSegmento.value = report.ativo?.zona?.segmento || 'Novo';
    zMin.value = report.ativo?.zona?.min || '';
    zMax.value = report.ativo?.zona?.max || '';

    const sec = report.report?.sections || {};
    sExec.checked = !!sec.exec;
    sContexto.checked = !!sec.contexto;
    sMercado.checked = !!sec.mercado;
    sComps.checked = !!sec.comps;
    sCenarios.checked = !!sec.cenarios;
    sRecomend.checked = !!sec.recomend;
    sPlano.checked = !!sec.plano;
    sAnexos.checked = !!sec.anexos;

    rTom.value = report.report?.tom || 'Neutro';
    rCTA.value = report.report?.cta || 'Agendar reuni√£o';
    rRecomend.value = report.report?.recomendacaoFinal || '';

    // PDFs (Fase 2)
    try{ renderPdfList(); }catch(e){}

    // Extra√ß√£o assistida (Fase 2.1)
    try{ renderAssistPreviewFromReport(report); }catch(e){}
  }

  /* ===========================
     Auto-import UI & logic
  =========================== */
  function setAutoImportUI(importedFrom){
    if(!autoImportBadge || !autoImportText) return;

    if(importedFrom?.source){
      autoImportBadge.classList.remove('hidden');
      autoImportBadge.className = 'pill ok';
      autoImportBadge.textContent = 'Importado: ' + importedFrom.source;
      const extra = [];
      if(importedFrom.matchBy) extra.push('match: ' + importedFrom.matchBy);
      if(importedFrom.at) extra.push('em ' + toPTDate(importedFrom.at));
      autoImportText.innerHTML = `Dados reconhecidos automaticamente (${extra.join(' ¬∑ ') || '‚Äî'}). Se necess√°rio, pode editar manualmente.`;
    }else{
      autoImportBadge.classList.add('hidden');
      autoImportBadge.className = 'pill info hidden';
      autoImportBadge.textContent = 'Importa√ß√£o autom√°tica';
      autoImportText.innerHTML = `Escreva nome/telem√≥vel/email para tentar reconhecer o cliente nos m√≥dulos <strong>FSBO</strong>, <strong>Leads</strong> e <strong>Angaria√ß√µes</strong>.`;
    }
  }

  
    /* ===========================
     Auto-fill Ativo/Zona a partir do registo reconhecido
     - Preenche apenas se os campos estiverem vazios
     - Tenta tamb√©m definir a fonte automaticamente (Angaria√ß√µes | FSBO | Leads)
  =========================== */
  function applyAssetFromHit(hit){
    if(!hit || !hit.asset) return false;

    // fonte autom√°tica (apenas se ainda n√£o estiver definida numa fonte expl√≠cita)
    try{
      const src = sourceLabelFromKey(hit.sourceKey);
      if(aFonte && src && (normStr(aFonte.value)==='' || ['Manual','Mapa'].includes(normStr(aFonte.value)))){
        if(['Angaria√ß√µes','FSBO','Leads'].includes(src)) aFonte.value = src;
      }
    }catch(e){}

    let changed = false;
    const zona = (hit.asset.zona || '').trim();
    const tip  = (hit.asset.tipologia || '').trim();
    const preco= (hit.asset.preco || '').trim();
   const obs  = (hit.asset.obs || '').trim();
const resumo = (hit.asset.resumo || '').trim();
const srcLabel = sourceLabelFromKey(hit.sourceKey);

// Regra de neg√≥cio: se for FSBO e existir resumo (do KIT), Observa√ß√µes deve ser ESSE texto.
const obsFinal = (srcLabel === 'FSBO' && resumo) ? resumo : obs;

// Preenche/atualiza Observa√ß√µes:
// - se estiver vazio, preenche
// - se for FSBO e houver resumo, substitui mesmo que j√° tenha algo curto (para garantir o texto ‚Äúigual ao KIT‚Äù)
if(aObs && obsFinal){
  const cur = normStr(aObs.value);
  const shouldOverrideFSBO = (srcLabel === 'FSBO' && resumo && (cur.length < 40 || cur === obs));
  if(!cur || shouldOverrideFSBO){
    aObs.value = obsFinal;
    changed = true;
  }
}
    const titulo = (hit.asset.titulo || '').trim();
    const ref = (hit.asset.ref || '').trim();

    if(aZona && !normStr(aZona.value) && zona){ aZona.value = zona; changed = true; }
    if(aTipologia && !normStr(aTipologia.value) && tip){ aTipologia.value = tip; changed = true; }
    if(aPreco && !normStr(aPreco.value) && preco){ aPreco.value = preco; changed = true; }
    if(aObs && !normStr(aObs.value) && obsFinal){ aObs.value = obsFinal; changed = true; }

    // se houver t√≠tulo/ref e aSearch estiver vazio, preenche como contexto
    if(aSearch && !normStr(aSearch.value)){
      const ctx = [ref, titulo].filter(Boolean).join(' ¬∑ ').trim();
      if(ctx){ aSearch.value = ctx; changed = true; }
    }

    if(changed && typeof scheduleAutosave === 'function') scheduleAutosave();
    return changed;
  }

  function findAssetCandidatesBySource(sourceLabel, query){
    const idx = scanLocalStorageForContacts();
    const src = (sourceLabel || '').toLowerCase();

    // filtra por fonte (se definida) e por exist√™ncia de dados de ativo
    let list = idx.filter(c=>{
      const lab = sourceLabelFromKey(c.sourceKey).toLowerCase();
      const okSrc = !src || lab === src;
      const hasAsset = c.asset && (c.asset.zona || c.asset.tipologia || c.asset.preco || c.asset.obs || c.asset.titulo || c.asset.ref);
      return okSrc && hasAsset;
    });

    // restringe por cliente (nome/tel/email) com a mesma prioridade
    const hit = findContactPriority(query);
    if(hit){
      const n = hit.name, p = hit.phone, e = hit.email;
      list = list.filter(c=>{
        if(n && c.name && c.name===n) return true;
        if(p && c.phone && (c.phone===p || c.phone.endsWith(p) || p.endsWith(c.phone))) return true;
        if(e && c.email && c.email===e) return true;
        return false;
      });
    }

    // se houver texto em aSearch, tenta filtrar por refer√™ncia/t√≠tulo/zona
    const qtxt = normStr(aSearch?.value || '');
    if(qtxt){
      const qn = normName(qtxt);
      const qd = (qtxt||'').toString().replace(/\D/g,'');
      const qe = normEmail(qtxt);
      list = list.filter(c=>{
        const hay = [c.asset?.ref, c.asset?.titulo, c.asset?.zona, c.asset?.tipologia, c.asset?.preco, c.asset?.obs].filter(Boolean).join(' ');
        const hn = normName(hay);
        if(qd && hay.replace(/\D/g,'').includes(qd)) return true;
        if(qe && hay.toLowerCase().includes(qe)) return true;
        return hn.includes(qn);
      });
    }

    // ordena por completude
    const score = (c)=>(c.asset?.zona?2:0)+(c.asset?.tipologia?2:0)+(c.asset?.preco?2:0)+(c.asset?.obs?1:0)+(c.asset?.titulo?1:0)+(c.asset?.ref?1:0);
    return list.sort((a,b)=>score(b)-score(a)).slice(0,20);
  }

  function showAssetChooser(matches){
    const wrap = document.createElement('div');
    wrap.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.62);z-index:9999;display:flex;align-items:center;justify-content:center;padding:14px;';
    wrap.innerHTML = `
      <div style="background:#0f0f0f;border:1px solid rgba(163,139,99,.35);border-radius:16px;max-width:720px;width:100%;padding:14px;box-shadow:0 18px 40px rgba(0,0,0,.6)">
        <div style="display:flex;justify-content:space-between;gap:10px;align-items:center;flex-wrap:wrap">
          <div style="font-weight:900;letter-spacing:.08em;text-transform:uppercase;color:#A38B63;font-size:12px">Selecionar Ativo</div>
          <button class="btn secondary" id="assetChooserClose">Fechar</button>
        </div>
        <div style="margin-top:10px;max-height:60vh;overflow:auto;border-top:1px solid rgba(255,255,255,.08)">
          ${matches.map((m,i)=>`
            <div data-i="${i}" style="padding:10px 6px;border-bottom:1px solid rgba(255,255,255,.08);cursor:pointer">
              <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap">
                <div><strong>${htmlEscape(m.asset?.titulo || m.asset?.ref || 'Ativo')}</strong></div>
                <div style="color:rgba(255,255,255,.65);font-size:12px">${htmlEscape(sourceLabelFromKey(m.sourceKey))}</div>
              </div>
              <div style="margin-top:4px;color:rgba(255,255,255,.75);font-size:12px">
                ${htmlEscape(m.asset?.zona || '‚Äî')}${m.asset?.tipologia ? (' ¬∑ ' + htmlEscape(m.asset.tipologia)) : ''}${m.asset?.preco ? (' ¬∑ ' + htmlEscape(m.asset.preco)) : ''}
              </div>
              ${m.asset?.obs ? `<div style="margin-top:4px;color:rgba(255,255,255,.55);font-size:11px">${htmlEscape(m.asset.obs).slice(0,220)}</div>` : ''}
            </div>
          `).join('')}
        </div>
      </div>
    `;
    document.body.appendChild(wrap);

    wrap.addEventListener('click', (e)=>{
      if(e.target && e.target.id==='assetChooserClose'){ wrap.remove(); return; }
      const row = e.target.closest('[data-i]');
      if(!row) return;
      const i = Number(row.dataset.i);
      const chosen = matches[i];
      applyAssetFromHit(chosen);
      wrap.remove();
    });
  }

  function tryAutoFillAssetFromModules(){
    const src = normStr(aFonte?.value || '');
    const query = { name: normStr(cNome?.value), phone: normStr(cTel?.value), email: normStr(cEmail?.value) };

    const useSrc = (['Angaria√ß√µes','FSBO','Leads'].includes(src)) ? src : '';
    const matches = findAssetCandidatesBySource(useSrc, query);

    if(!matches.length) return false;
    if(matches.length === 1){
      return applyAssetFromHit(matches[0]);
    }
    showAssetChooser(matches);
    return true;
  }

function tryAutoImport(){
  const nome = cNome.value;
  const tel  = cTel.value;
  const email = cEmail.value;

  const matches = findContactsPriorityList({ name: nome, phone: tel, email }, 8);
  if(!matches.length){
    return false;
  }

  const applyPick = (pick)=>{
    const found = {
      nome: pick.nameRaw || '',
      tel: pick.phoneRaw || '',
      email: pick.emailRaw || '',
      sourceKey: pick.sourceKey || '',
      source: sourceLabelFromKey(pick.sourceKey),
      raw: pick,
      id: null
    };

    // evitar sobre-escrita agressiva: s√≥ preenche campos vazios
    const current = collectForm();
    const before = {
      nome: current.cliente.nome,
      tel: current.cliente.tel,
      email: current.cliente.email,
      tipo: current.cliente.tipo
    };

    const fNome  = normStr(found.nome);
    const fTel   = normStr(found.tel);
    const fEmail = normStr(found.email);

    // infer√™ncia do campo que deu match
    let matchBy = 'nome';
    if(email && fEmail && normEmail(email) === normEmail(fEmail)) matchBy = 'email';
    else if(tel && fTel && normPhone(tel) === normPhone(fTel)) matchBy = 'telem√≥vel';
    else if(nome && fNome) matchBy = 'nome';

    if(!before.nome && fNome) cNome.value = fNome;
    if(!before.tel && fTel) cTel.value = fTel;
    if(!before.email && fEmail) cEmail.value = fEmail;

   // tipo: s√≥ se ainda n√£o foi selecionado (e apenas se a fun√ß√£o existir)
if(!before.tipo && typeof suggestTipoFromSource === 'function'){
  const suggested = suggestTipoFromSource(found.source, found.raw);
  if(suggested) cTipo.value = suggested;
}

    // notas: acrescentar linha, sem duplicar
    const stamp = `[Importado de ${found.source} ¬∑ match: ${matchBy} ¬∑ ${toPTDate(todayISO())}]`;
    const notes = (cNotas.value || '').trim();
    if(!notes.includes(stamp)){
      cNotas.value = (notes ? (notes + '\n') : '') + stamp;
    }

    // tentar autopreencher Passo 3 (ativo/zona) a partir do mesmo registo
    try{ applyAssetFromHit(found.raw); }catch(e){}

    // guardar estado ‚Äúimportado de‚Äù
    const r = saveDraftSilent();
    r.cliente.importedFrom = { source: found.source, matchBy, at: todayISO(), sourceKey: found.sourceKey, sourceId: found.id };
    upsertReport(r);
    setAutoImportUI(r.cliente.importedFrom);
  };

  // Se houver 1 match, aplica direto; se houver v√°rios, abre chooser
  if(matches.length === 1){
    applyPick(matches[0]);
    return true;
  }

  showContactChooser(matches, applyPick);
  return true;
}

  // Guarda sem alertas (para autosave e auto-import)
  function saveDraftSilent(){
    const r = collectForm();
    r.updatedAt = todayISO();
    r.status = 'draft';
    upsertReport(r);
    ACTIVE_REPORT_ID = r.id;
    return r;
  }

  let importTimer = null;
  function scheduleAutoImport(){
    clearTimeout(importTimer);
    importTimer = setTimeout(()=> {
      // s√≥ tentar quando estamos no wizard e no passo 1
      if(viewWizard && !viewWizard.classList.contains('hidden')) tryAutoImport();
    }, 420);
  }

  // tentativas ao escrever (debounce)
[cNome, cTel, cEmail].forEach(inp=>{
  if(!inp) return;
  inp.addEventListener('input', scheduleAutoImport);
  inp.addEventListener('blur', scheduleAutoImport);
});

// Bot√£o "Limpar" (registar 1x)
const btnResetCliente = el('btnResetCliente');
btnResetCliente?.addEventListener('click', ()=>{
  if(!confirm('Limpar dados do cliente?')) return;
  cNome.value=''; cTel.value=''; cEmail.value='';
  if(cNotas) cNotas.value='';
  const r = saveDraftSilent();
  if(r && r.cliente) r.cliente.importedFrom = null;
  upsertReport(r);
  setAutoImportUI(null);
});
  

  /* ===========================
     Lista: render + filtros
  =========================== */
  function badgeEstado(status){
    if(status==='final') return '<span class="pill ok">Final</span>';
    if(status==='sent') return '<span class="pill ok">Enviado</span>';
    return '<span class="pill info">Rascunho</span>';
  }

  function matchFilters(r){
    const txt = (q.value||'').toLowerCase().trim();
    if(txt){
      const hay = [
        r.cliente?.nome, r.cliente?.tipo,
        r.objetivo?.objetivo,
        r.ativo?.imovel?.zona, r.ativo?.zona?.zona,
        r.status
      ].filter(Boolean).join(' ').toLowerCase();
      if(!hay.includes(txt)) return false;
    }
    if(fStatus.value && r.status !== fStatus.value) return false;
    if(fTipo.value && (r.cliente?.tipo||'') !== fTipo.value) return false;

    if(fConfidencial.checked && !r.cliente?.confidencial) return false;

    const de = fDataDe.value || '';
    const ate = fDataAte.value || '';
    const dt = r.updatedAt || r.createdAt || '';
    if(de && dt && dt < de) return false;
    if(ate && dt && dt > ate) return false;

    return true;
  }

  function renderList(){
    const list = loadAllReports().filter(matchFilters);
    reportsTbody.innerHTML = '';

    if(!list.length){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td colspan="5">
          <div style="padding:10px 0;color:var(--muted);font-size:12px">
            Sem relat√≥rios com os filtros atuais. Clique em <strong>+ Novo Relat√≥rio</strong>.
          </div>
        </td>`;
      reportsTbody.appendChild(tr);
      return;
    }

    list.forEach(r=>{
      const mode = r.ativo?.mode || 'imovel';
      const zona = mode==='imovel' ? (r.ativo?.imovel?.zona||'‚Äî') : (r.ativo?.zona?.zona||'‚Äî');
      const tip = mode==='imovel' ? (r.ativo?.imovel?.tipologia||'') : (r.ativo?.zona?.tipologia||'');
      const obj = r.objetivo?.objetivo || '‚Äî';
      const detalhe = (r.cliente?.detalhe === 'full') ? 'Completo' : 'Executivo';
      const conf = r.cliente?.confidencial ? 'Sim' : 'N√£o';
      const imp = r.cliente?.importedFrom?.source ? (' ¬∑ Importado: ' + r.cliente.importedFrom.source) : '';

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>
          <div><strong>${htmlEscape(r.cliente?.nome || '‚Äî')}</strong></div>
          <span class="td-sub">${htmlEscape(r.cliente?.tipo || '‚Äî')} ¬∑ Idioma ${((r.cliente?.idioma||'pt')==='en'?'EN':'PT')} ¬∑ ${detalhe}${imp}</span>
        </td>
        <td>
          <div><strong>${htmlEscape(obj)}</strong></div>
          <span class="td-sub">Zona: ${htmlEscape(zona)}${tip ? ' ¬∑ Tipologia: '+htmlEscape(tip) : ''}</span>
        </td>
        <td>
          <div><strong>${htmlEscape(toPTDate(r.createdAt || ''))}</strong></div>
          <span class="td-sub">Atualizado: ${htmlEscape(toPTDate(r.updatedAt || ''))}</span>
        </td>
        <td>
          ${badgeEstado(r.status)}
          <span class="td-sub">Confidencial: ${conf}</span>
        </td>
        <td>
          <div class="row-actions">
            <button class="btn-xs primary" data-act="open" data-id="${r.id}">Abrir</button>
            <button class="btn-xs" data-act="duplicate" data-id="${r.id}">Duplicar</button>
           <button class="btn-xs" data-act="export" data-id="${r.id}">Exportar PDF</button>
<button class="btn-xs" data-act="exportPremium" data-id="${r.id}">Exportar Premium</button>
            <button class="btn-xs ghost" data-act="delete" data-id="${r.id}">Remover</button>
          </div>
        </td>
      `;
      reportsTbody.appendChild(tr);
    });
  }

  /* ===========================
     Wizard: criar/guardar
  =========================== */
  function saveDraft(){
    const r = collectForm();
    r.updatedAt = todayISO();
    r.status = 'draft';
    upsertReport(r);
    ACTIVE_REPORT_ID = r.id;
    renderList();
    return r;
  }

  btnNew?.addEventListener('click', ()=>{
    ACTIVE_REPORT_ID = null;
    const empty = {
      id: uid('rpt'),
      createdAt: todayISO(),
      updatedAt: todayISO(),
      status: 'draft',
      cliente:{tipo:'',nome:'',tel:'',email:'',idioma:'pt',detalhe:'exec',confidencial:false,notas:'', importedFrom:null},
      objetivo:{objetivo:'',horizonte:'',risco:'',preocupacoes:[],brief:''},
      ativo:{mode:'imovel',imovel:{fonte:'Manual',query:'',zona:'',tipologia:'',preco:'',obs:''},zona:{zona:'',tipologia:'',segmento:'Novo',min:'',max:''}},
      pdfs:[],
      analysis:{metrics:{precoM2:'‚Äî',intervalo:'‚Äî',tendencia:'‚Äî',tempo:'‚Äî'},chapters:[],sum:{relevante:'',riscos:'',oportunidades:''}},
      report:{sections:{exec:true,contexto:true,mercado:true,comps:false,cenarios:true,recomend:true,plano:true,anexos:true},tom:'Neutro',cta:'Agendar reuni√£o',recomendacaoFinal:''}
    };
    fillForm(empty);
    try{ renderAssistPreviewFromReport(empty); }catch(e){}
    setTab('wizard'); setStep(1);
    setAutoImportUI(null);
  });

  btnGoWizard?.addEventListener('click', ()=>{
    ACTIVE_REPORT_ID = null;
    btnNew.click();
  });

  btnBackToList?.addEventListener('click', ()=>{
    setTab('list');
    renderList();
  });

  btnSaveDraft?.addEventListener('click', ()=>{
    saveDraft();
    alert('Rascunho guardado.');
  });

  steps.forEach(s=>{
    s.addEventListener('click', ()=>{
      saveDraft();
      setStep(Number(s.dataset.step));
    });
  });

  btnPrev?.addEventListener('click', ()=>{
    if(currentStep === 1){
      saveDraft();
      setTab('list');
      renderList();
      return;
    }
    saveDraft();
    setStep(currentStep-1);
  });
  btnNext?.addEventListener('click', ()=>{
    saveDraft();
    if(currentStep < 5) setStep(currentStep+1);
    else { setTab('list'); renderList(); }
  });

  // Autosave suave
  let autosaveTimer = null;
  function scheduleAutosave(){
    clearTimeout(autosaveTimer);
    autosaveTimer = setTimeout(()=>{ if(viewWizard && !viewWizard.classList.contains('hidden')) saveDraftSilent(); }, 650);
  }
  ['input','change','keyup'].forEach(ev=>{
    viewWizard?.addEventListener(ev, scheduleAutosave, true);
  });


  /* ===========================
     PDFs (Fase 2) ‚Äî anexos por relat√≥rio
     - Guarda metadados no pr√≥prio relat√≥rio (localStorage)
     - Guarda o ficheiro (Blob) em IndexedDB para evitar limites do localStorage
  =========================== */

  const pdfDrop = el('pdfDrop');
  const pdfInput = el('pdfInput');
  const btnAddPdf = el('btnAddPdf');
  const btnClearPdfs = el('btnClearPdfs');
  const pdfList = el('pdfList');
  const pdfCount = el('pdfCount');
  const pdfStoreMode = el('pdfStoreMode');
  const pdfLastAction = el('pdfLastAction');


  const PDF_DB = 'gpp_pdf_store_v1';
  const PDF_STORE = 'pdfs';
  let pdfDb = null;
  let pdfStorageMode = 'IndexedDB';

  function setPdfStatus({count=null, mode=null, action=null}={}){
    if(pdfCount && count!=null) pdfCount.textContent = String(count);
    if(pdfStoreMode && mode) pdfStoreMode.textContent = mode;
    if(pdfLastAction && action) pdfLastAction.textContent = action;
  }

  /* ===========================
     Fase 2.1 ‚Äî Extra√ß√£o Assistida (sem PDF.js)
     Como funciona:
     - O utilizador abre o PDF no visor do browser e copia/cola texto relevante.
     - O m√≥dulo estrutura automaticamente: cap√≠tulos, par√°grafos, insights e palavras‚Äëchave.
     - Esta estrutura entra diretamente no relat√≥rio final (sec√ß√£o ‚ÄúDados do Estudo‚Äù).
  =========================== */

  const pdfAssistText = el('pdfAssistText');
  const btnAssistParse = el('btnAssistExtract');
  const btnAssistClear = el('btnAssistClear');
  const assistPreview = el('assistPreview');
  const assistStats = el('assistStatus');

  const STOPWORDS_PT = new Set([
    'a','o','os','as','um','uma','uns','umas','de','da','do','das','dos','e','ou','em','no','na','nos','nas',
    'por','para','com','sem','ao','aos','√†','√†s','que','quem','quando','onde','como','mais','menos','muito','muita',
    'muitos','muitas','j√°','ainda','entre','at√©','sobre','sob','se','ser','s√£o','foi','foram','√©','era','eram',
    'ter','tem','t√™m','tinha','tinham','h√°','haver','num','numa','nuns','numas','este','esta','estes','estas',
    'isso','isto','aquele','aquela','aqueles','aquelas','mesmo','mesma','mesmos','mesmas','tamb√©m','assim','pelo','pela',
    'pelos','pelas','seu','sua','seus','suas','lhe','lhes','me','te','nos','vos','eles','elas','eu','tu','ele','ela'
  ]);

  function clampLen(s, n){ s = String(s||''); return s.length>n ? (s.slice(0,n-1)+'‚Ä¶') : s; }

  function splitLines(txt){
    return String(txt||'')
      .replace(/\r\n/g,'\n')
      .replace(/\r/g,'\n')
      .split('\n')
      .map(l=>l.replace(/\s+/g,' ').trim());
  }

  function isHeading(line){
    if(!line) return false;
    if(line.length < 4) return false;
    if(line.length > 86) return false;
    // padr√µes t√≠picos: "1." "1.1" "I." "CAP√çTULO" "RESUMO EXECUTIVO" "CONCLUS√ïES:" etc.
    if(/^\d{1,2}(?:[\.|\)]\d{1,2})*[\.|\)]\s+/.test(line)) return true;
    if(/^[IVX]{1,6}[\.|\)]\s+/.test(line)) return true;
    if(/:\s*$/.test(line) && line.length < 70) return true;
    const letters = line.replace(/[^A-Za-z√Ä-√ø]/g,'');
    const uppers  = line.replace(/[^A-Z√Ä-√ù]/g,'');
    if(letters.length >= 6 && uppers.length/Math.max(1,letters.length) > 0.78) return true;
    return false;
  }

  function tokenize(txt){
    return String(txt||'')
      .toLowerCase()
      .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
      .replace(/[^a-z0-9\s-]/g,' ')
      .split(/\s+/)
      .map(w=>w.trim())
      .filter(w=>w && w.length>=4 && !STOPWORDS_PT.has(w));
  }

  function buildKeywords(text, topN=12){
    const freq = new Map();
    tokenize(text).forEach(w=>freq.set(w,(freq.get(w)||0)+1));
    return Array.from(freq.entries())
      .sort((a,b)=>b[1]-a[1])
      .slice(0, topN)
      .map(([w,c])=>({w,c}));
  }

  function assistedExtract(rawText){
    const lines = splitLines(rawText).filter(Boolean);
    const chapters = [];
    let current = null;
    let bodyBuf = [];

    function flush(){
      if(!current) return;
      const body = bodyBuf.join('\n').trim();
      const paras = body ? body.split(/\n{2,}|\n(?=\S)/).map(p=>p.trim()).filter(Boolean) : [];
      const textAll = [current.title, ...paras].join('\n');
      const kw = buildKeywords(textAll, 10);
      const insights = paras
        .filter(p=>p.length>=80)
        .slice(0, 6)
        .map(p=>clampLen(p, 220));
      current.paragraphs = paras;
      current.insights = insights;
      current.keywords = kw;
      chapters.push(current);
      current = null;
      bodyBuf = [];
    }

    for(const line of lines){
      if(isHeading(line)){
        flush();
        current = { title: line.replace(/:\s*$/,'').trim(), paragraphs:[], insights:[], keywords:[] };
      }else{
        if(!current) current = { title: 'S√≠ntese do Estudo', paragraphs:[], insights:[], keywords:[] };
        bodyBuf.push(line);
      }
    }
    flush();

    // agregados
    const allText = chapters.map(c=>[c.title,...(c.paragraphs||[])].join('\n')).join('\n');
    const globalKw = buildKeywords(allText, 18);
    return { chapters, keywords: globalKw };
  }

  function renderAssistPreviewFromReport(report){
    if(!assistPreview || !assistStats) return;
    const ch = report?.analysis?.chapters || [];
    const kw = report?.analysis?.keywords || [];
    if(!ch.length){
      assistPreview.innerHTML = '<span style="color:var(--muted)">Ainda sem extra√ß√£o assistida. Cole o texto e clique em ‚ÄúEstruturar (cap√≠tulos + insights)‚Äù.</span>';
      assistStats.textContent = '‚Äî';
      return;
    }

    assistStats.textContent = `${ch.length} cap√≠tulo(s) ¬∑ ${kw.length} palavra(s)-chave`;
    const html = ch.map((c,idx)=>{
      const bullets = (c.insights||[]).slice(0,4).map(i=>`<li>${htmlEscape(i)}</li>`).join('');
      const kws = (c.keywords||[]).slice(0,6).map(k=>`<span class="pill" style="margin-right:6px">${htmlEscape(k.w)}<span style="opacity:.7"> (${k.c})</span></span>`).join('');
      return `
        <div style="padding:10px 10px;border:1px solid rgba(255,255,255,.08);border-radius:14px;background:rgba(0,0,0,.25);margin-top:10px">
          <div style="display:flex;justify-content:space-between;gap:10px;align-items:flex-start;flex-wrap:wrap">
            <div style="font-weight:900;color:var(--gold);text-transform:uppercase;letter-spacing:.06em;font-size:12px">${idx+1}. ${htmlEscape(c.title||'Cap√≠tulo')}</div>
          </div>
          ${kws ? `<div style="margin-top:8px">${kws}</div>` : ''}
          ${bullets ? `<ul style="margin:8px 0 0 18px;color:#e9e9e9">${bullets}</ul>` : '<div style="margin-top:8px;color:var(--muted);font-size:12px">(Sem insights autom√°ticos ‚Äî pode editar o texto e voltar a gerar.)</div>'}
        </div>
      `;
    }).join('');
    assistPreview.innerHTML = html;
  }

  function saveAssistExtractionToReport(extraction){
    const r = saveDraftSilent();
    r.analysis = r.analysis || {};
    r.analysis.chapters = extraction.chapters || [];
    r.analysis.keywords = extraction.keywords || [];
    // um resumo simples para o relat√≥rio final
    const topKw = (r.analysis.keywords||[]).slice(0,10).map(k=>k.w);
    r.analysis.sum = r.analysis.sum || {};
    r.analysis.sum.relevante = topKw.length ? ('Palavras‚Äëchave: ' + topKw.join(', ')) : (r.analysis.sum.relevante || '');
    upsertReport(r);
    renderAssistPreviewFromReport(r);
    setPdfStatus({ action: 'Extra√ß√£o assistida guardada no relat√≥rio.' });
  }

  const GARVETUR_OFFICIAL_TEMPLATES_V1 = {
  tom: {
    assertivo: {
      value: "Assertivo",
      hint: "Decis√£o clara, linguagem direta, foco em execu√ß√£o."
    },
    prudente: {
      value: "Prudente",
      hint: "Consultivo, valida√ß√µes expl√≠citas, gest√£o de risco e alternativas."
    }
  },
  recomendacao: {
    decisiva: (ctx)=>`DECIS√ÉO RECOMENDADA
Com base nos crit√©rios e na evid√™ncia reunida, a recomenda√ß√£o √© avan√ßar com uma decis√£o objetiva nas pr√≥ximas 48‚Äì72 horas, para proteger posicionamento e timing.

O QUE FAZER AGORA (EXECU√á√ÉO)
1) Validar crit√©rios finais e or√ßamento (10‚Äì15 min).
2) Confirmar disponibilidade/condi√ß√µes do ativo e documenta√ß√£o cr√≠tica.
3) Definir estrat√©gia (proposta / negocia√ß√£o) e calendariza√ß√£o.
4) Agendar reuni√£o de alinhamento e fecho.

NOTA GARVETUR
A execu√ß√£o disciplinada (timing + posicionamento) √© o fator que mais influencia o resultado.`,

    consultiva: (ctx)=>`RECOMENDA√á√ÉO GARVETUR (CONSULTIVA)
A recomenda√ß√£o √© avan√ßar para uma valida√ß√£o estruturada antes da decis√£o final, garantindo conforto e controlo de risco.

VALIDA√á√ïES (PR√ìXIMOS PASSOS)
1) Confirmar prioridades e crit√©rios (10‚Äì15 min).
2) Rever dados cr√≠ticos do caso (ativo/zona/condi√ß√µes).
3) Comparar 2‚Äì3 cen√°rios e respetivos trade-offs (pre√ßo, timing, estrat√©gia).
4) Definir o plano de a√ß√£o e s√≥ depois formalizar decis√£o.

NOTA GARVETUR
O objetivo √© decidir com clareza, sem precipita√ß√£o, mas com ritmo e m√©todo.`
  }
};

function applyOfficialTemplates(){
  if(!rTom || !rRecomend) return;

  const kTom = (tplTom && tplTom.value) ? tplTom.value : "assertivo";
  const kRec = (tplRec && tplRec.value) ? tplRec.value : "decisiva";

  // 1) Tom
  const t = GARVETUR_OFFICIAL_TEMPLATES_V1.tom[kTom] || GARVETUR_OFFICIAL_TEMPLATES_V1.tom.assertivo;
  rTom.value = t.value;

  // 2) Recomenda√ß√£o
  // ctx fica preparado para Sprint 2 (personaliza√ß√£o com nome/zona/objetivo)
  const ctx = {};
  const recFn = GARVETUR_OFFICIAL_TEMPLATES_V1.recomendacao[kRec] || GARVETUR_OFFICIAL_TEMPLATES_V1.recomendacao.decisiva;
  rRecomend.value = recFn(ctx);

  if(tplStatus) tplStatus.textContent = `Aplicado: Tom ${t.value} ¬∑ Recomenda√ß√£o ${kRec.toUpperCase()}`;
}

function resetTemplatesUI(){
  if(tplTom) tplTom.value = "assertivo";
  if(tplRec) tplRec.value = "decisiva";
  if(tplStatus) tplStatus.textContent = "‚Äî";
}

  btnAssistParse?.addEventListener('click', ()=>{
    try{
      const txt = (pdfAssistText?.value || '').trim();
      if(!txt){ alert('Cole primeiro o texto relevante do estudo (PDF) para estruturar.'); return; }
      const extraction = assistedExtract(txt);
      if(!extraction.chapters?.length){ alert('N√£o foi poss√≠vel identificar conte√∫do. Confirme o texto colado e tente novamente.'); return; }
      saveAssistExtractionToReport(extraction);
      alert('Extra√ß√£o assistida conclu√≠da e integrada no relat√≥rio.');
    }catch(err){
      console.error(err);
      alert('Falha na extra√ß√£o assistida. Verifique o texto colado e tente novamente.');
    }
  });

  btnAssistClear?.addEventListener('click', ()=>{
    if(!confirm('Limpar o texto colado?')) return;
    if(pdfAssistText) pdfAssistText.value = '';
  });

  function openPdfDb(){
    return new Promise((resolve, reject)=>{
      if(!('indexedDB' in window)){
        pdfStorageMode = 'LocalStorage (limitado)';
        resolve(null);
        return;
      }
      const req = indexedDB.open(PDF_DB, 1);
      req.onupgradeneeded = (ev)=>{
        const db = req.result;
        if(!db.objectStoreNames.contains(PDF_STORE)){
          db.createObjectStore(PDF_STORE, { keyPath: 'id' });
        }
      };
      req.onsuccess = ()=>{
        pdfDb = req.result;
        pdfDb.onversionchange = ()=>{ try{ pdfDb.close(); }catch{} };
        resolve(pdfDb);
      };
      req.onerror = ()=> reject(req.error);
    });
  }

  function idbPutPdf(id, blob){
    if(!pdfDb) return Promise.resolve(false);
    return new Promise((resolve, reject)=>{
      const tx = pdfDb.transaction(PDF_STORE,'readwrite');
      tx.oncomplete = ()=>resolve(true);
      tx.onerror = ()=>reject(tx.error);
      tx.objectStore(PDF_STORE).put({ id, blob, updatedAt: Date.now() });
    });
  }

  function idbGetPdf(id){
    if(!pdfDb) return Promise.resolve(null);
    return new Promise((resolve, reject)=>{
      const tx = pdfDb.transaction(PDF_STORE,'readonly');
      const req = tx.objectStore(PDF_STORE).get(id);
      req.onsuccess = ()=> resolve(req.result?.blob || null);
      req.onerror = ()=> reject(req.error);
    });
  }

  function idbDelPdf(id){
    if(!pdfDb) return Promise.resolve(false);
    return new Promise((resolve, reject)=>{
      const tx = pdfDb.transaction(PDF_STORE,'readwrite');
      tx.oncomplete = ()=>resolve(true);
      tx.onerror = ()=>reject(tx.error);
      tx.objectStore(PDF_STORE).delete(id);
    });
  }

  // Fallback base64 (apenas ficheiros pequenos)
  function blobToDataURL(blob){
    return new Promise((resolve, reject)=>{
      const r = new FileReader();
      r.onload = ()=>resolve(r.result);
      r.onerror = ()=>reject(r.error);
      r.readAsDataURL(blob);
    });
  }

  async function storePdfBlob(pdfId, file){
    // preferir IndexedDB
    try{
      if(pdfDb){
        await idbPutPdf(pdfId, file);
        pdfStorageMode = 'IndexedDB';
        return { store: 'idb', ok: true };
      }
    }catch(e){
      console.warn('IndexedDB falhou, fallback localStorage', e);
    }

    // fallback: base64 para ficheiros pequenos
    try{
      const MAX = 1_500_000; // ~1.5MB (base64 cresce)
      if(file.size > MAX) return { store: 'none', ok:false, reason:'Ficheiro demasiado grande para fallback.' };
      const dataUrl = await blobToDataURL(file);
      localStorage.setItem('gpp_pdf_b64_'+pdfId, dataUrl);
      pdfStorageMode = 'LocalStorage (base64)';
      return { store: 'lsb64', ok:true };
    }catch(e){
      return { store: 'none', ok:false, reason:String(e||'erro') };
    }
  }

  async function loadPdfBlob(pdfId){
    // idb
    if(pdfDb){
      const b = await idbGetPdf(pdfId);
      if(b) return b;
    }
    // fallback base64
    const b64 = localStorage.getItem('gpp_pdf_b64_'+pdfId);
    if(b64 && b64.startsWith('data:application/pdf')){
      const res = await fetch(b64);
      return await res.blob();
    }
    return null;
  }

  function getActiveReportSafe(){
    // garante que existe um rascunho para anexar PDFs
    if(!ACTIVE_REPORT_ID){
      const r = saveDraftSilent();
      ACTIVE_REPORT_ID = r.id;
      return r;
    }
    const r = getReport(ACTIVE_REPORT_ID) || saveDraftSilent();
    return r;
  }

  function renderPdfList(){
    if(!pdfList) return;
    const r = ACTIVE_REPORT_ID ? getReport(ACTIVE_REPORT_ID) : null;
    const pdfs = r?.pdfs || [];
    setPdfStatus({count: pdfs.length, mode: pdfStorageMode});

    if(!pdfs.length){
      pdfList.innerHTML = `
        <div class="file">
          <div>
            <div class="f-name">Sem anexos</div>
            <div class="f-meta">Adicione PDFs para manter o dossi√™ do cliente completo.</div>
          </div>
        </div>`;
      return;
    }

    pdfList.innerHTML = '';
    pdfs
      .slice()
      .sort((a,b)=>(b.addedAt||0)-(a.addedAt||0))
      .forEach(p=>{
        const row = document.createElement('div');
        row.className = 'file';
        row.innerHTML = `
          <div>
            <div class="f-name">${htmlEscape(p.name||'PDF')}</div>
            <div class="f-meta">
              ${(p.size?Math.round(p.size/1024)+' KB':'‚Äî')} ¬∑ Adicionado: ${htmlEscape(toPTDate(p.addedAtISO || todayISO()))}
              ${p.source ? ' ¬∑ Fonte: '+htmlEscape(p.source) : ''}
            </div>
          </div>
          <div class="f-actions">
            <button class="btn-xs" data-pdf-act="open" data-pdf-id="${p.id}">Abrir</button>
            <button class="btn-xs" data-pdf-act="download" data-pdf-id="${p.id}">Download</button>
            <button class="btn-xs ghost" data-pdf-act="remove" data-pdf-id="${p.id}">Remover</button>
          </div>
        `;
        pdfList.appendChild(row);
      });
  }

  async function addPdfFiles(fileList){
    const files = Array.from(fileList || []).filter(f=>f && f.type === 'application/pdf');
    if(!files.length){
      setPdfStatus({action:'Nenhum PDF v√°lido selecionado.'});
      return;
    }

    const r = getActiveReportSafe();
    r.pdfs = Array.isArray(r.pdfs) ? r.pdfs : [];

    for(const file of files){
      const pdfId = uid('pdf');
      const storeRes = await storePdfBlob(pdfId, file);
      if(!storeRes.ok){
        alert(`N√£o foi poss√≠vel guardar "${file.name}". ${storeRes.reason || ''}`.trim());
        continue;
      }

      // evitar duplicados por nome+size (heur√≠stica simples)
      const exists = r.pdfs.some(x => (x.name===file.name && x.size===file.size));
      if(exists) continue;

      r.pdfs.push({
        id: pdfId,
        name: file.name,
        size: file.size,
        type: file.type,
        addedAt: Date.now(),
        addedAtISO: todayISO(),
        store: storeRes.store
      });
    }

    r.updatedAt = todayISO();
    upsertReport(r);
    ACTIVE_REPORT_ID = r.id;

    setPdfStatus({action:'PDF(s) adicionados.'});
    renderPdfList();
  }

  // Modal de pr√©-visualiza√ß√£o (evita bloqueio de popups)
  const pdfModal = document.getElementById('pdfModal');
  const pdfModalFrame = document.getElementById('pdfModalFrame');
  const pdfModalClose = document.getElementById('pdfModalClose');
  const pdfModalDownload = document.getElementById('pdfModalDownload');
  const pdfModalTitle = document.getElementById('pdfModalTitle');
  let pdfModalUrl = null;
  let pdfModalMeta = null;

  // Abrir pr√©-visualiza√ß√£o do relat√≥rio (HTML) no modal, com impress√£o segura
  function openReportPreview(html, title='Documento'){
    if(!pdfModal || !pdfModalFrame) return;

    // limpar qualquer src anterior
    try{ pdfModalFrame.removeAttribute('src'); }catch{}
    try{ pdfModalFrame.srcdoc = html; }catch{ pdfModalFrame.src = 'about:blank'; }

    pdfModalTitle.textContent = String(title||'Documento').toUpperCase();
    pdfModal.classList.remove('hidden');
    pdfModal.setAttribute('aria-hidden','false');

    // Bot√£o principal: imprimir/guardar em PDF
    if(pdfModalDownload){
      pdfModalDownload.textContent = 'Imprimir / Guardar em PDF';
      pdfModalDownload.onclick = ()=>{
        try{
          const w = pdfModalFrame.contentWindow;
          if(!w){ alert('N√£o foi poss√≠vel iniciar a impress√£o.'); return; }
          w.focus();
          w.print();
        }catch(e){
          console.error(e);
          alert('Falha ao abrir a impress√£o. Verifique permiss√µes de popups/impress√£o.');
        }
      };
    }
  }


  function closePdfModal(){
    if(!pdfModal) return;
    pdfModal.classList.add('hidden');
    pdfModal.setAttribute('aria-hidden','true');
    
    if(pdfModalFrame){
  try{ pdfModalFrame.removeAttribute('srcdoc'); }catch{}
  pdfModalFrame.src = 'about:blank';
}
    if(pdfModalUrl){
      try{ URL.revokeObjectURL(pdfModalUrl); }catch{}
      pdfModalUrl = null;
    }
    pdfModalMeta = null;
  }
  pdfModalClose?.addEventListener('click', closePdfModal);
  pdfModal?.addEventListener('click', (e)=>{ if(e.target === pdfModal) closePdfModal(); });
  window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closePdfModal(); });

  async function openPdf(pdfId, download=false){
    const blob = await loadPdfBlob(pdfId);
    if(!blob){
      alert('N√£o foi poss√≠vel abrir este PDF (n√£o encontrado no armazenamento local).');
      return;
    }
    const r = getReport(ACTIVE_REPORT_ID);
    const meta = (r?.pdfs||[]).find(x=>x.id===pdfId) || null;

    const url = URL.createObjectURL(blob);

    // download direto (sem popup)
    if(download){
      const a = document.createElement('a');
      a.href = url;
      a.download = meta?.name || 'documento.pdf';
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 3000);
      return;
    }

    // Abrir no modal (default) ‚Äî n√£o √© bloqueado por popups
    if(pdfModal && pdfModalFrame){
      if(pdfModalUrl){
        try{ URL.revokeObjectURL(pdfModalUrl); }catch{}
        pdfModalUrl = null;
      }
     pdfModalUrl = url;
pdfModalMeta = meta;
pdfModalTitle.textContent = (meta?.name || 'Documento').toUpperCase();

// garantir que n√£o fica preso ao srcdoc do preview HTML
try{ pdfModalFrame.removeAttribute('srcdoc'); }catch{}

pdfModalFrame.src = url;

pdfModal.classList.remove('hidden');
pdfModal.setAttribute('aria-hidden','false');

      // preparar bot√£o download
      pdfModalDownload.onclick = ()=> openPdf(pdfId, true);
      
      pdfModalDownload.textContent = 'Download';return;
    }

    // fallback: tentar nova aba sem await (melhor toler√¢ncia a bloqueios)
    const w = window.open('about:blank', '_blank', 'noopener');
    if(!w){
      alert('O seu navegador bloqueou a abertura em nova aba. Utilize a op√ß√£o Download.');
      setTimeout(()=>URL.revokeObjectURL(url), 3000);
      return;
    }
    try{ w.location.href = url; }catch{}
    setTimeout(()=>URL.revokeObjectURL(url), 30_000);
  }

    
async function removePdf(pdfId){
    const r = getReport(ACTIVE_REPORT_ID);
    if(!r) return;
    const meta = (r.pdfs||[]).find(x=>x.id===pdfId);
    if(!confirm(`Remover o PDF "${meta?.name || 'anexo'}"?`)) return;

    // limpar blobs
    try{ await idbDelPdf(pdfId); }catch{}
    try{ localStorage.removeItem('gpp_pdf_b64_'+pdfId); }catch{}

    r.pdfs = (r.pdfs||[]).filter(x=>x.id!==pdfId);
    r.updatedAt = todayISO();
    upsertReport(r);

    setPdfStatus({action:'PDF removido.'});
    renderPdfList();
  }

  async function clearAllPdfs(){
    const r = getReport(ACTIVE_REPORT_ID);
    if(!r || !(r.pdfs||[]).length) return;
    if(!confirm('Remover TODOS os PDFs deste relat√≥rio?')) return;

    for(const p of (r.pdfs||[])){
      try{ await idbDelPdf(p.id); }catch{}
      try{ localStorage.removeItem('gpp_pdf_b64_'+p.id); }catch{}
    }

    r.pdfs = [];
    r.updatedAt = todayISO();
    upsertReport(r);

    setPdfStatus({action:'PDFs removidos.'});
    renderPdfList();
  }

  function wirePdfUI(){
    if(btnAddPdf && pdfInput){
      btnAddPdf.addEventListener('click', ()=> pdfInput.click());
      pdfInput.addEventListener('change', (e)=>{
        addPdfFiles(e.target.files);
        pdfInput.value = '';
      });
    }
    if(btnClearPdfs) btnClearPdfs.addEventListener('click', clearAllPdfs);

    if(pdfDrop){
      pdfDrop.addEventListener('dragover', (e)=>{ e.preventDefault(); pdfDrop.style.borderColor = 'var(--gold)'; });
      pdfDrop.addEventListener('dragleave', ()=>{ pdfDrop.style.borderColor = 'rgba(163,139,99,.55)'; });
      pdfDrop.addEventListener('drop', (e)=>{
        e.preventDefault();
        pdfDrop.style.borderColor = 'rgba(163,139,99,.55)';
        addPdfFiles(e.dataTransfer.files);
      });
    }

    if(pdfList){
      pdfList.addEventListener('click', (e)=>{
        const b = e.target.closest('button[data-pdf-act]');
        if(!b) return;
        const act = b.dataset.pdfAct;
        const id = b.dataset.pdfId;
        if(act==='open') openPdf(id, false);
        if(act==='download') openPdf(id, true);
        if(act==='remove') removePdf(id);
      });
    }
  }

  async function initPdfPhase2(){
    try{
      await openPdfDb();
    }catch(e){
      console.warn('IndexedDB indispon√≠vel', e);
      pdfDb = null;
      pdfStorageMode = 'LocalStorage (limitado)';
    }
    wirePdfUI();
    renderPdfList();
    setPdfStatus({mode: pdfStorageMode, action:'Pronto.'});
  }

  /* ===========================
     Exporta√ß√£o ‚ÄúPDF‚Äù (impress√£o)
  =========================== */
  function printHTMLInFrame(html){
    const iframe = document.createElement('iframe');
    iframe.style.position = 'fixed';
    iframe.style.right = '0';
    iframe.style.bottom = '0';
    iframe.style.width = '0';
    iframe.style.height = '0';
    iframe.style.border = '0';
    iframe.style.opacity = '0';
    iframe.setAttribute('aria-hidden','true');
    document.body.appendChild(iframe);

    const cleanup = ()=>{ try{ iframe.remove(); }catch{} };

    const w = iframe.contentWindow;
    const d = iframe.contentDocument || w.document;

    d.open(); d.write(html); d.close();

    const firePrint = async ()=>{
      try{ if(d.fonts && d.fonts.ready) await d.fonts.ready; }catch{}
      try{ w.focus(); w.print(); }catch(err){ console.error(err); alert('Falha ao abrir impress√£o.'); cleanup(); }
    };
    const onAfter = ()=>{ w.removeEventListener('afterprint', onAfter); setTimeout(cleanup, 250); };
    w.addEventListener('afterprint', onAfter);

    setTimeout(firePrint, 250);
    setTimeout(cleanup, 60000);
  }

  function exportReportToPrintPDF(report, forceExec=false){
    const cliente = report.cliente || {};
    const obj = report.objetivo || {};
    const ativo = report.ativo || {};
    const mode = ativo.mode || 'imovel';

    const zona = mode==='imovel' ? (ativo.imovel?.zona || '‚Äî') : (ativo.zona?.zona || '‚Äî');
    const tip = mode==='imovel' ? (ativo.imovel?.tipologia || '') : (ativo.zona?.tipologia || '');
    const detalhe = forceExec ? 'exec' : (cliente.detalhe || 'exec');
    const confTag = 'CONFIDENCIAL';
    const title = `${forceExec ? 'Relat√≥rio Executivo' : 'Relat√≥rio'} ‚Äî ${cliente.nome || 'Cliente'} (${toPTDate(report.updatedAt || report.createdAt)})`;

    const styles = `
      <style>
        :root{--gold:#A38B63;--muted:#666;--txt:#111}
        *{box-sizing:border-box}
        body{font-family:Arial,Helvetica,sans-serif;color:var(--txt);margin:0;background:#fff}
        .page{max-width:920px;margin:0 auto;padding:28px 34px}
        .top{display:flex;justify-content:space-between;gap:14px;align-items:flex-start}
        .brand{font-weight:800;letter-spacing:.08em;text-transform:uppercase;color:var(--gold);font-size:14px}
        .meta{font-size:12px;color:var(--muted);text-align:right;line-height:1.4}
        .h1{margin:18px 0 6px;font-size:20px;letter-spacing:.02em}
        .tag{display:inline-block;padding:4px 10px;border:1px solid #ddd;border-radius:999px;font-size:11px;color:#333;background:#fafafa}
        .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:14px}
        .card{border:1px solid #eee;border-radius:14px;padding:12px 12px}
        .card h3{margin:0 0 8px;font-size:12px;text-transform:uppercase;letter-spacing:.12em;color:#444}
        .kv{display:flex;justify-content:space-between;gap:10px;padding:6px 0;border-bottom:1px solid #f0f0f0;font-size:13px}
        .kv:last-child{border-bottom:none}
        .kv b{color:#555;font-weight:700}
        .sec{margin-top:16px}
        .sec h2{margin:0 0 8px;font-size:13px;text-transform:uppercase;letter-spacing:.14em;color:#444}
        .p{font-size:13px;line-height:1.55;color:#222;margin:0 0 8px}
        ul{margin:6px 0 0 18px}
        li{margin:4px 0;font-size:13px;line-height:1.45}
        .foot{margin-top:18px;padding-top:10px;border-top:1px solid #eee;font-size:11px;color:#777;display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
        /* ===== Premium print polish ===== */
@media print{
  @page { margin: 14mm 14mm; }
  .page{ max-width: none; padding: 0; }
  .no-print{ display:none !important; }
}

.h1{ font-size:22px; margin:16px 0 6px; }
.tag{ font-weight:700; }

.callout{
  border:1px solid #e6e0d6;
  background:#fbfaf8;
  border-radius:14px;
  padding:12px 12px;
  margin-top:10px;
}
.callout h3{
  margin:0 0 6px;
  font-size:12px;
  letter-spacing:.12em;
  text-transform:uppercase;
  color:#444;
}
.bullets{ margin:6px 0 0 18px; }
.bullets li{ margin:5px 0; }

.hr{ height:1px; background:#eee; margin:14px 0; }

/* Page number (simples e compat√≠vel) */
@media print{
  body{ counter-reset: page; }
  .pagenum:after{ content: counter(page); }
}
      
/* Sprint 2.7 ‚Äî Consist√™ncia tipogr√°fica */
.lead{font-size:13px;line-height:1.55;color:#222;margin:0 0 8px;font-family:Arial,Helvetica,sans-serif}
.kws{margin-top:10px}
.badge{display:inline-block;padding:4px 10px;border:1px solid #ddd;border-radius:999px;font-size:11px;color:#333;background:#fafafa;font-weight:700}
.rule{height:1px;background:#eee;margin:14px 0}
</style>
    `;

    const rec = (report.report?.recomendacaoFinal || '').trim() || '(preencher recomenda√ß√£o final)';

    const safe = (s)=> htmlEscape(String(s||''));

    
    // ===== Sprint 2.7 (cliente) ‚Äî Executivo: raz√µes/riscos (sem mexer em bot√µes) =====
    const cta = (report.report?.cta || 'Agendar reuni√£o');
    
    const resumoExec = (report.report?.sumExec || '').trim();
    const resumoFinal = (resumoExec || rec || '').trim();
    
    function toBullets(text, max=3){
      const t = String(text||'').replace(/\r/g,'').trim();
      if(!t) return [];
      const lines = t.split('\n').map(x=>x.trim()).filter(Boolean);
      const bullets = [];
      for(const ln of lines){
        const clean = ln.replace(/^[-‚Ä¢\u2022]+\s*/,'').trim();
        if(clean.length >= 18) bullets.push(clean);
        if(bullets.length >= max) break;
      }
      return bullets;
    }
    
    const recText = (rec || '').trim();
    const recBullets = toBullets(recText, 3);
    
    const execRazoes = recBullets.length ? recBullets : [
      "Alinhamento entre objetivo, timing e posicionamento do ativo/zona.",
      "Mitiga√ß√£o de risco atrav√©s de execu√ß√£o por marcos (controlo semanal).",
      "Decis√£o baseada em crit√©rios objetivos, reduzindo indecis√£o e custo de oportunidade."
    ];
    
    const execRiscos = [
      "Perda de janela de mercado/aten√ß√£o se a decis√£o for adiada.",
      "Desalinhamento entre expectativa e mercado ‚Äî corrigir cedo via valida√ß√£o."
    ];
    

    // Dados do estudo (Fase 2.1 ‚Äî extra√ß√£o assistida)
    const chapters = Array.isArray(report.analysis?.chapters) ? report.analysis.chapters : [];
    const studySummary = report.analysis?.sum || {};

    
    const logoDataURI = 'data:image/jpeg;base64,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';
    const assinaturaDataURI = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAATkAAABwCAYAAABlwQfhAAAACXBIWXMAABcSAAAXEgFnn9JSAAAE4GlUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4gPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgOS4xLWMwMDEgNzkuYThkNDc1MzQ5LCAyMDIzLzAzLzIzLTEzOjA1OjQ1ICAgICAgICAiPiA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPiA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtbG5zOmRjPSJodHRwOi8vcHVybC5vcmcvZGMvZWxlbWVudHMvMS4xLyIgeG1sbnM6cGhvdG9zaG9wPSJodHRwOi8vbnMuYWRvYmUuY29tL3Bob3Rvc2hvcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RFdnQ9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZUV2ZW50IyIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgMjQuNyAoTWFjaW50b3NoKSIgeG1wOkNyZWF0ZURhdGU9IjIwMjQtMTItMTFUMTA6NTg6NThaIiB4bXA6TW9kaWZ5RGF0ZT0iMjAyNC0xMi0xOVQxNDoxODowNFoiIHhtcDpNZXRhZGF0YURhdGU9IjIwMjQtMTItMTlUMTQ6MTg6MDRaIiBkYzpmb3JtYXQ9ImltYWdlL3BuZyIgcGhvdG9zaG9wOkNvbG9yTW9kZT0iMyIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDoyZDRhNGZiZS00MTkyLTQ2ZmItYTA3Ny1lOGY3YzMwMjUyNzMiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6MmQ0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';
    
    // ===== Sprint 2.7 (cliente) ‚Äî Executivo orientado ao cliente =====
    const confTagExec = 'CONFIDENCIAL';
    
    // Intro (m√°x ~10 linhas)
    const introGarvetur = `A Garvetur Luxury Porto √© a unidade premium do Grupo Garvetur no Norte de Portugal, especializada em consultoria imobili√°ria para clientes exigentes, nacionais e internacionais. Combinamos conhecimento local detalhado do Grande Porto com acesso a uma rede nacional consolidada, assegurando acompanhamento completo do in√≠cio ao fecho da decis√£o. A nossa abordagem √© orientada a valor: an√°lise de contexto, leitura de mercado, rigor documental e execu√ß√£o com marcos claros. Este relat√≥rio sintetiza os principais pontos de decis√£o e prop√µe o pr√≥ximo passo recomendado.`;
    
    // Curadoria m√≠nima (sem anexo)
// - Prioridade: usar a extra√ß√£o assistida do Passo 4 (chapters[].insights)
// - Fallback: usar sum (relevante/riscos/oportunidades) se existir
const curFromChapters = (()=>{
  const all = [];
  for(const ch of (chapters||[])){
    const ins = Array.isArray(ch?.insights) ? ch.insights : [];
    for(const i of ins){
      const s = String(i||'').trim();
      if(s && s.length >= 40) all.push(s);
    }
  }
  // dedupe simples
  const seen = new Set();
  const uniq = [];
  for(const s of all){
    const k = s.toLowerCase().slice(0,140);
    if(seen.has(k)) continue;
    seen.add(k);
    uniq.push(s);
  }
  const top = uniq.slice(0, 6);
  const implicacoes = top.length ? [
    "Clarificar crit√©rios de decis√£o e validar o cen√°rio dominante (evita indecis√£o prolongada).",
    "Definir um plano curto com marcos (timing, proposta e valida√ß√£o) para reduzir risco de execu√ß√£o."
  ] : [];
  return { top, implicacoes };
})();

const hasCuradoriaMin = (
  (studySummary && (studySummary.relevante || studySummary.riscos || studySummary.oportunidades)) ||
  (curFromChapters.top && curFromChapters.top.length)
);

const curadoriaMinHTML = hasCuradoriaMin ? `
      <div class="sec">
        <h2>Estudo de Mercado</h2>
        <div class="callout">
          <p class="p"><strong>Insights principais</strong></p>
          ${curFromChapters.top?.length ? `
            <ul class="bullets">
              ${curFromChapters.top.map(x=>`<li>${safe(x)}</li>`).join('')}
            </ul>
          ` : `<p class="p">Sem insights autom√°ticos suficientes. (Sugest√£o: cole mais texto no Passo 4 ou refine o excerto.)</p>`}

          ${(studySummary?.riscos || studySummary?.oportunidades) ? `
            <div class="hr"></div>
            ${studySummary.riscos ? `<p class="p"><strong>Riscos:</strong> ${safe(studySummary.riscos).split(String.fromCharCode(10)).join('<br>')}</p>` : ``}
            ${studySummary.oportunidades ? `<p class="p"><strong>Oportunidades:</strong> ${safe(studySummary.oportunidades).split(String.fromCharCode(10)).join('<br>')}</p>` : ``}
          ` : ``}
        </div>
      </div>
    ` : ``;

// Implica√ß√µes (linguagem para cliente)
    const implicacoesCliente = `
      <div class="sec">
        <h2>Implica√ß√µes para a sua decis√£o</h2>
        <div class="callout">
          <p class="p">
            A informa√ß√£o analisada aponta para uma decis√£o que deve ser tomada com crit√©rios objetivos e um plano de execu√ß√£o claro.
            O ponto-chave √© reduzir incerteza (e custo de oportunidade) atrav√©s de valida√ß√£o r√°pida de pressupostos e calendariza√ß√£o.
          </p>
        </div>
      </div>
    `;
    
    // Porque faz sentido + riscos (executivo)
    const porqueFazSentido = `
      <div class="sec">
        <h2>Porque faz sentido agora</h2>
    
        <div class="grid" style="margin-top:12px">
          <div class="card">
            <h3>Raz√µes principais</h3>
            <ul>
              ${execRazoes.map(x=>`<li>${safe(x)}</li>`).join('')}
            </ul>
          </div>
          <div class="card">
            <h3>Riscos a vigiar</h3>
            <ul>
              ${execRiscos.map(x=>`<li>${safe(x)}</li>`).join('')}
            </ul>
          </div>
        </div>
      </div>
    `;
    
    
    const porqueGarveturHTML = `
      <div class="sec">
        <h2>Porqu√™ trabalhar com a Garvetur</h2>
        <div class="card">
          <p class="p"><em>(A preencher ‚Äî texto editorial a definir; responder√° √†s principais obje√ß√µes e consolidar√° confian√ßa.)</em></p>
        </div>
      </div>
    `;

    const proximosPassosHTML = `
      <div class="sec">
        <h2>Pr√≥ximos passos</h2>
        <ul>
          <li>Validar objetivo e crit√©rios de decis√£o (10‚Äì15 min).</li>
          <li>Confirmar dados cr√≠ticos e eventuais conflitos (FSBO | Leads | Angaria√ß√µes).</li>
          <li>Alinhar estrat√©gia, proposta e calendariza√ß√£o.</li>
          <li><strong>Pr√≥xima a√ß√£o:</strong> ${safe(cta)}.</li>
        </ul>
      </div>
    `;
// Decis√£o recomendada (fecho)
    const decisaoRecomendada = `
      <div class="sec">
        <h2>Decis√£o recomendada</h2>
        <div class="callout">
          <p class="p">${safe(resumoFinal || rec || '(a preencher)').replace(/\n/g,'<br>')}</p>
          <div class="hr"></div>
          <p class="p"><strong>Pr√≥ximo passo recomendado:</strong> ${safe(cta)}</p>
        </div>
      </div>
    `;
    
    // Assinatura / contactos (footer)
    const assinaturaHTML = `
      <div class="foot" style="align-items:flex-start">
        <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
          <img src="${assinaturaDataURI}" alt="Assinatura" style="height:34px;opacity:.95"/>
          <div style="line-height:1.35">
            <div style="font-weight:900;color:#111">Rui Quelhas</div>
            <div style="font-size:11.5px;color:#111">Diretor Comercial ¬∑ Garvetur Luxury Porto</div>
            <div style="font-size:11px;color:#666;margin-top:2px">M. 00351 915 169 010 ¬∑ 969 031 692</div>
            <div style="font-size:11px;color:#666">E. manager.porto@garveturluxury.com ¬∑ AMI 1427</div>
          </div>
        </div>
        <div style="text-align:right;font-size:11px;color:#666;line-height:1.45">
          <div><strong>${htmlEscape(confTag)}</strong> ‚Äî Documento preparado para o destinat√°rio identificado.</div>
        </div>
      </div>
    `;// Template executivo final (ordem pedida)
    const htmlExec = `
      <!doctype html>
      <html lang="pt-PT">
        <head>
          <meta charset="utf-8">
          <title>${htmlEscape(title)}</title>
          ${styles}
        </head>
        <body>
          <div class="page">
            <div class="top">
              <div>
                <div class="brand">Garvetur Luxury Porto</div>
                <div class="h1">Relat√≥rio Executivo</div>
                <span class="tag">${htmlEscape(confTag)}</span>
              </div>
              <div class="meta">
                <div><strong>Cliente:</strong> ${htmlEscape(cliente.nome||'‚Äî')}</div>
                <div><strong>Contacto:</strong> ${htmlEscape(cliente.tel||'‚Äî')} ¬∑ ${htmlEscape(cliente.email||'‚Äî')}</div>
                <div><strong>Data:</strong> ${htmlEscape(toPTDate(report.updatedAt||report.createdAt||todayISO()))}</div>
              </div>
            </div>

            ${introGarvetur}
            ${curadoriaMinHTML}
            ${implicacoesCliente}
            ${porqueFazSentido}
            ${porqueGarveturHTML}
            ${proximosPassosHTML}
            ${assinaturaHTML}

            <div class="foot">
              <span>${htmlEscape(confTag)} ¬∑ Documento confidencial.</span>
              <span>Gerado em ${htmlEscape(toPTDate(todayISO()))}</span>
            </div>
          </div>
        </body>
      </html>
    `;function buildCuradoriaExecutiva(chapters, studySummary){
  // 1) recolhe insights j√° calculados pela extra√ß√£o assistida
  const all = [];
  for(const ch of (chapters||[])){
    for(const ins of (ch.insights||[])){
      const s = String(ins||'').trim();
      if(s && s.length >= 40) all.push(s);
    }
  }

  // 1b) fallback: usa s√≠ntese do estudo (Passo 4) quando n√£o existirem cap√≠tulos/insights
  if(!all.length && studySummary && typeof studySummary === 'object'){
    const parts = [studySummary.relevante, studySummary.riscos, studySummary.oportunidades]
      .map(x=>String(x||'').trim())
      .filter(Boolean);
    const joined = parts.join(' ');
    // dividir em frases curtas √∫teis
    const sentences = joined
      .split(/[\.\!\?]\s+/)
      .map(s=>s.trim())
      .filter(s=>s.length >= 40);
    for(const s of sentences) all.push(s);
  }

  // 2) dedupe simples
  const seen = new Set();
  const uniq = [];
  for(const s of all){
    const k = s.toLowerCase().slice(0,120);
    if(seen.has(k)) continue;
    seen.add(k);
    uniq.push(s);
  }

  // 3) escolhe top (executivo = curto e forte)
  const top = uniq.slice(0, 8);

  // 4) Implica√ß√µes (heur√≠stica simples, mas √∫til)
  const implicacoes = [];
  if(top.length){
    implicacoes.push("O estudo suporta uma decis√£o com base em sinais consistentes ‚Äî evitar indecis√£o prolongada.");
    implicacoes.push("A estrat√©gia deve privilegiar clareza de proposta e execu√ß√£o (timing + narrativa + pre√ßo/condi√ß√µes).");
    implicacoes.push("Risco principal: perder janela de mercado/aten√ß√£o ‚Äî resposta recomendada: plano com marcos e controlo semanal.");
  }

  return { topInsights: top, implicacoes };
}

   const cur = buildCuradoriaExecutiva(chapters, studySummary);

const hasStudy = !!(chapters.length || (studySummary?.relevante || studySummary?.riscos || studySummary?.oportunidades));

const studyHTML = hasStudy ? `
  <div class="sec">
    <h2>Curadoria do Estudo (executivo)</h2>

    <div class="callout">
      <h3>Insights que importam para a decis√£o</h3>
      ${cur.topInsights?.length ? `
        <ul class="bullets">
          ${cur.topInsights.map(x=>`<li>${safe(x)}</li>`).join('')}
        </ul>
      ` : `<p class="p">Sem insights autom√°ticos suficientes. (Sugest√£o: cole mais texto no Passo 4 ou refine o excerto.)</p>`}
    </div>

    <div class="callout">
      <h3>Implica√ß√µes para a sua decis√£o</h3>
      <ul class="bullets">
        ${cur.implicacoes.map(x=>`<li>${safe(x)}</li>`).join('')}
      </ul>
    </div>
  </div>
` : ``;

    const html = `
      <!doctype html>
      <html>
        <head>
          <meta charset="utf-8">
          <title>${htmlEscape(title)}</title>
          ${styles}
        </head>
        <body>
          <div class="page">
            <div class="top">
              <div>
                <div class="brand">Garvetur Luxury Porto</div>
                <div class="h1">${forceExec ? "Relat√≥rio Executivo ‚Äî An√°lise &amp; Decis√£o" : "Relat√≥rio"}</div>
                <span class="tag">${htmlEscape(confTag)}</span>
              </div>
              <div class="meta">
                <div><strong>Cliente:</strong> ${htmlEscape(cliente.nome||'‚Äî')}</div>
                <div><strong>Contacto:</strong> ${htmlEscape(cliente.tel||'‚Äî')} ¬∑ ${htmlEscape(cliente.email||'‚Äî')}</div>
                <div><strong>Data:</strong> ${htmlEscape(toPTDate(report.updatedAt||report.createdAt||todayISO()))}</div>
                <div><strong>Formato:</strong> ${detalhe==='full'?'Completo':'Executivo'}</div>
              </div>
            </div>
${forceExec ? `<div class="sec">
              <h2>Garvetur Luxury Porto</h2>
              <p class="p">
                A Garvetur Luxury Porto √© a unidade premium do Grupo Garvetur no Norte, dedicada a opera√ß√µes residenciais e de investimento
                com abordagem consultiva e foco em resultados. Trabalhamos com uma metodologia estruturada: diagn√≥stico, curadoria de informa√ß√£o,
                posicionamento e execu√ß√£o, garantindo rigor na an√°lise e clareza na decis√£o.
                <br>Atuamos com rede nacional e capacidade de mobilizar procura qualificada, combinando conhecimento local do Grande Porto
                com vis√£o de mercado e disciplina comercial.
                <br>Este relat√≥rio sintetiza os elementos essenciais para apoiar a sua decis√£o, com recomenda√ß√µes pr√°ticas e pr√≥ximos passos objetivos.
              </p>
            </div>` : ``}

<div class="sec">
  <h2>Resumo Executivo</h2>
  <p class="p"><strong>Objetivo:</strong> ${htmlEscape(obj.objetivo || '‚Äî')} ¬∑ <strong>Zona:</strong> ${htmlEscape(zona)} ${tip?('¬∑ <strong>Tipologia:</strong> '+htmlEscape(tip)) : ''}</p>

  <div class="callout">
    <h3>Decis√£o recomendada</h3>
    <p class="p">${htmlEscape(rec).replace(/\n/g,'<br>')}</p>
    <div class="hr"></div>
    <p class="p"><strong>Pr√≥ximo passo recomendado:</strong> ${htmlEscape(report.report?.cta || 'Agendar reuni√£o')} ‚Äî 15 a 20 minutos para validar crit√©rios, cen√°rio e calendariza√ß√£o.</p>
  </div>

  <div class="grid" style="margin-top:12px">
    <div class="card">
      <h3>Porque faz sentido (executivo)</h3>
      <ul class="bullets">
        <li>Alinhamento entre objetivo, horizonte de decis√£o e posicionamento do ativo/zona.</li>
        <li>Redu√ß√£o de incerteza com execu√ß√£o por marcos e controlo semanal (evita indecis√£o prolongada).</li>
        <li>Capacidade de otimizar resultado via proposta clara, timing e condi√ß√µes.</li>
      </ul>
    </div>
    <div class="card">
      <h3>Riscos a vigiar</h3>
      <ul class="bullets">
        <li>Perda de janela de mercado/aten√ß√£o se a decis√£o for adiada.</li>
        <li>Desalinhamento entre expectativa e realidade de mercado ‚Äî corrigir cedo com valida√ß√£o.</li>
        <li>Competi√ß√£o e volatilidade no curto prazo ‚Äî requer disciplina de pre√ßo/condi√ß√µes e narrativa.</li>
      </ul>
    </div>
  </div>
</div>

              </div>
            </div>

            ${studyHTML}
            <div class="foot">
              <span>CONFIDENCIAL ¬∑ Documento para o Cliente ¬∑ N√£o distribuir sem autoriza√ß√£o.</span>
              <span>Gerado em ${htmlEscape(toPTDate(todayISO()))}</span>
            </div>
          </div>
        </body>
      </html>
    `;

    if(forceExec) return htmlExec;

    return html;
  }

  function exportReportToPremiumHTML(report, opts={}){
  const cliente = report.cliente || {};
  const obj = report.objetivo || {};
  const ativo = report.ativo || {};
  const mode = ativo.mode || 'imovel';

  const zona = mode==='imovel' ? (ativo.imovel?.zona || '‚Äî') : (ativo.zona?.zona || '‚Äî');
  const tip  = mode==='imovel' ? (ativo.imovel?.tipologia || '') : (ativo.zona?.tipologia || '');
  const fonte = mode==='imovel' ? (ativo.imovel?.fonte || '‚Äî') : 'Zona';
  const detalhe = (cliente.detalhe === 'full') ? 'Completo' : 'Executivo';
  const confTag = cliente.confidencial ? 'CONFIDENCIAL' : 'INTERNO';

  const safe = (s)=> htmlEscape(String(s||''));
  const ptDate = (iso)=> safe(toPTDate(iso || todayISO()));
  const title = `Relat√≥rio Premium ‚Äî ${cliente.nome || 'Cliente'} ‚Äî ${ptDate(report.updatedAt || report.createdAt)}`;

  const rec = (report.report?.recomendacaoFinal || '').trim() || '(preencher recomenda√ß√£o final)';
  const cta = (report.report?.cta || 'Agendar reuni√£o');
   // ===== Sprint 2.4 ‚Äî Resumo Executivo curto (anti-repeti√ß√£o) =====
const resumoExec = (report.report?.sumExec || '').trim();
const resumoFinal = resumoExec
  ? takeFirstSentences(resumoExec, 280)
  : takeFirstSentences(rec, 260);

// pequenos ‚Äúsinais‚Äù de leitura
const badgeConf = cliente.confidencial ? 'CONFIDENCIAL' : 'INTERNO';
const badgeFonte = (mode==='imovel' ? (ativo.imovel?.fonte || '‚Äî') : 'Zona');
const badgeZona  = zona || '‚Äî';
    const SHOW_NOTAS_INTERNAS = false; // manter false para ocultar no Premium
const notasInternasHTML =
  (SHOW_NOTAS_INTERNAS && (cliente.notas || '').trim())
    ? `
      <div class="card" style="margin-top:12px">
        <h3>Notas internas</h3>
        <p class="p">${safe(cliente.notas || '‚Äî').replace(/\n/g,'<br>')}</p>
      </div>
    `
    : '';
  // preocupa√ß√µes
  const preocup = Array.isArray(obj.preocupacoes) ? obj.preocupacoes.filter(Boolean) : [];

  // Step 3 (ativo)
  const preco = mode==='imovel' ? (ativo.imovel?.preco || '') : '';
  const obs = mode==='imovel' ? (ativo.imovel?.obs || '') : '';

  // Extra√ß√£o assistida (Fase 2.1)
  const chapters = Array.isArray(report.analysis?.chapters) ? report.analysis.chapters : [];
  const keywords = Array.isArray(report.analysis?.keywords) ? report.analysis.keywords : [];
  const topKw = keywords.slice(0,12).map(k=>k?.w).filter(Boolean);

  const hasStudy = chapters.length > 0;
    // ===== Sprint 2.4 ‚Äî Editorial fino (helpers) =====
function splitLines(txt){
  return String(txt||'').split('\n').map(s=>s.trim()).filter(Boolean);
}

function takeFirstSentences(txt, maxChars=260){
  const s = String(txt||'').replace(/\s+/g,' ').trim();
  if(!s) return '';
  if(s.length <= maxChars) return s;
  // tenta cortar por frase
  const cut = s.slice(0, maxChars);
  const lastDot = Math.max(cut.lastIndexOf('.'), cut.lastIndexOf('!'), cut.lastIndexOf('?'));
  return (lastDot > 120) ? cut.slice(0,lastDot+1) : (cut.trim() + '‚Ä¶');
}

// Recomenda√ß√£o ‚Äúclean‚Äù: remove linhas que come√ßam por "S√≠ntese:" ou repetem o primeiro par√°grafo
function sanitizeRecommendation(rec, resumo){
  const lines = splitLines(rec);
  const resumoN = String(resumo||'').toLowerCase().trim();
  const out = [];

  for(const ln of lines){
    const l = ln.toLowerCase().trim();
    if(l.startsWith('s√≠ntese:')) continue;
    if(resumoN && resumoN.length > 20 && l.includes(resumoN.slice(0, Math.min(80, resumoN.length)))) continue;
    out.push(ln);
  }
  return out.join('\n').trim();
}

// Extrai bullets a partir do texto do consultor (se existirem linhas com "- " ou "‚Ä¢ ")
function extractBullets(rec, max=3){
  const lines = splitLines(rec);
  const bullets = [];
  for(const ln of lines){
    const m = ln.match(/^(\-|\‚Ä¢)\s+(.*)$/);
    if(m && m[2]){
      bullets.push(m[2].trim());
      if(bullets.length >= max) break;
    }
  }
  return bullets;
}
    /* ===========================
   Sprint 2.3 ‚Äî Curadoria do Estudo (m√≠nimo e seguro)
=========================== */
function buildCuradoriaMin(chapters){
  const all = [];
  for(const ch of (chapters || [])){
    const ins = Array.isArray(ch.insights) ? ch.insights : [];
    for(const i of ins){
      const s = String(i || '').trim();
      if(s && s.length >= 30) all.push(s);
    }
  }

  // dedupe simples (evita repeti√ß√µes)
  const seen = new Set();
  const uniq = [];
  for(const s of all){
    const k = s.toLowerCase().slice(0, 140);
    if(seen.has(k)) continue;
    seen.add(k);
    uniq.push(s);
  }

  return {
    top: uniq.slice(0, 7) // curto e premium
  };
}

const curMin = buildCuradoriaMin(chapters);

const blocoEstudoMin = hasStudy ? `
  <div class="sec">
    <h2>Curadoria do Estudo (m√≠nimo)</h2>

    <div class="callout">
      <h3>Insights que importam para a decis√£o</h3>
      ${curMin.top.length ? `
        <ul class="bullets">
          ${curMin.top.map(x=>`<li>${safe(x)}</li>`).join('')}
        </ul>
      ` : `<p class="p">Sem insights suficientes. Sugest√£o: cole mais texto no Passo 4.</p>`}
    </div>

    ${topKw.length ? `
      <div class="kws">
        <h3 style="margin:12px 0 8px;font-size:12px;letter-spacing:.14em;text-transform:uppercase;color:#444">Palavras-chave</h3>
        ${topKw.map(w=>`<span class="kw">${safe(w)}</span>`).join('')}
      </div>
    ` : ``}

    <div class="hr"></div>

    <div class="card" style="padding:14px">
      <h3>Cap√≠tulos (s√≠ntese)</h3>
      ${chapters.slice(0,10).map((ch, idx)=>{
        const t = safe(ch.title || `Cap√≠tulo ${idx+1}`);
        return `
          <div style="padding:8px 0;border-bottom:1px solid #f0f0f0">
            <div style="font-weight:800">${idx+1}. ${t}</div>
          </div>
        `;
      }).join('')}
    </div>
  </div>
` : ``;

  const premiumStyles = `
  <style>
    :root{
      --gold:#A38B63;
      --ink:#121212;
      --muted:#6f6f6f;
      --paper:#ffffff;
      --line:#e9e9e9;
      --soft:#f7f6f4;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--paper);color:var(--ink);font-family:Arial,Helvetica,sans-serif}
    .doc{max-width:980px;margin:0 auto;padding:30px 42px}
    .brandline{display:flex;justify-content:space-between;align-items:flex-start;gap:14px;flex-wrap:wrap}
    .brand{
      font-weight:900;letter-spacing:.10em;text-transform:uppercase;
      color:var(--gold);font-size:13px;line-height:1.2
    }
    .meta{font-size:12px;color:var(--muted);text-align:right;line-height:1.45}
    .tag{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:5px 10px;font-size:11px;background:#fafafa;color:#333}
    .hero{margin-top:18px;padding:18px 18px;border:1px solid var(--line);border-radius:18px;background:linear-gradient(180deg,#fff, var(--soft))}
    .h1{margin:0;font-size:26px;letter-spacing:.02em;line-height:1.15}
    .sub{margin-top:8px;color:var(--muted);font-size:13px;line-height:1.6}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:14px}
    .card{border:1px solid var(--line);border-radius:16px;padding:12px 12px;background:#fff}
    .card h3{margin:0 0 8px;font-size:12px;letter-spacing:.14em;text-transform:uppercase;color:#444}
    .kv{display:flex;justify-content:space-between;gap:10px;padding:7px 0;border-bottom:1px solid #f1f1f1;font-size:13px}
    .kv:last-child{border-bottom:none}
    .kv b{font-size:12px;color:var(--muted);font-weight:800;letter-spacing:.02em}
    .sec{margin-top:22px}
    .sec h2{margin:0 0 12px;font-size:12px;letter-spacing:.18em;text-transform:uppercase;color:#444}
    .p{margin:0 0 10px;font-size:13.5px;line-height:1.7;color:#222}
    .list{margin:8px 0 0 18px}
    .list li{margin:5px 0;font-size:13px;line-height:1.55}
    .kws{margin-top:10px}
    .kw{display:inline-block;margin:0 6px 6px 0;border:1px solid var(--line);border-radius:999px;padding:5px 10px;font-size:11px;background:#fafafa;color:#333}
    .divider{height:1px;background:var(--line);margin:16px 0}
    .goldbar{height:3px;background:var(--gold);border-radius:999px;margin-top:10px;opacity:.9}
    .foot{
      margin-top:18px;padding-top:10px;border-top:1px solid var(--line);
      font-size:11px;color:#777;display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap
    }

    /* Impress√£o */
    @media print{
      .doc{padding:0 10mm}
      .hero{break-inside:avoid}
      .card{break-inside:avoid}
      .sec{break-inside:avoid-page}
    }
/* Bloco 2.2 ‚Äî Ritmo e hierarquia */
.lead{font-size:14.2px;line-height:1.75;color:#1e1e1e;margin:0}
.rule{height:1px;background:var(--line);margin:16px 0}
.kpi{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
.kpi .card{padding:14px}
.badge{
  display:inline-flex;align-items:center;gap:8px;
  border:1px solid var(--line);border-radius:999px;padding:6px 12px;
  font-size:11px;background:#fafafa;color:#333
}
.callout{
  border:1px solid var(--line);
  border-left:4px solid var(--gold);
  border-radius:16px;
  padding:12px 12px;
  background:linear-gradient(180deg,#fff,var(--soft));
}
.callout h3{margin:0 0 8px;font-size:12px;letter-spacing:.14em;text-transform:uppercase;color:#444}
.small{font-size:12px;color:var(--muted);line-height:1.55}
/* Sprint 2.3 ‚Äî Curadoria (m√≠nimo) */
.callout{
  border:1px solid var(--line);
  border-left:4px solid var(--gold);
  border-radius:16px;
  padding:12px 12px;
  background:linear-gradient(180deg,#fff,var(--soft));
}
.callout h3{
  margin:0 0 8px;
  font-size:12px;
  letter-spacing:.14em;
  text-transform:uppercase;
  color:#444;
}
.bullets{ margin:6px 0 0 18px; }
.bullets li{ margin:5px 0; line-height:1.55; }
.hr{ height:1px; background:var(--line); margin:14px 0; }
    
  </style>`;

  const blocoContexto = `
    <div class="sec">
      <h2>Contexto do Cliente</h2>
      <div class="grid">
        <div class="card">
          <h3>Cliente</h3>
          <div class="kv"><b>Tipo</b><span>${safe(cliente.tipo || '‚Äî')}</span></div>
          <div class="kv"><b>Contacto</b><span>${safe(cliente.tel || '‚Äî')}</span></div>
          <div class="kv"><b>Email</b><span>${safe(cliente.email || '‚Äî')}</span></div>
          <div class="kv"><b>Formato</b><span>${safe(detalhe)}</span></div>
        </div>
        <div class="card">
          <h3>Decis√£o</h3>
          <div class="kv"><b>Objetivo</b><span>${safe(obj.objetivo || '‚Äî')}</span></div>
          <div class="kv"><b>Horizonte</b><span>${safe(obj.horizonte || '‚Äî')}</span></div>
          <div class="kv"><b>Risco</b><span>${safe(obj.risco || '‚Äî')}</span></div>
          <div class="kv"><b>Preocupa√ß√µes</b><span>${preocup.length ? safe(preocup.join(', ')) : '‚Äî'}</span></div>
        </div>
      </div>
     
    </div>
  `;

  const blocoAtivo = `
    <div class="sec">
      <h2>Ativo / Zona em an√°lise</h2>
      <div class="grid">
        <div class="card">
          <h3>Resumo</h3>
          <div class="kv"><b>Modo</b><span>${mode==='imovel' ? 'Im√≥vel espec√≠fico' : 'Zona / Tipologia'}</span></div>
          <div class="kv"><b>Fonte</b><span>${safe(fonte)}</span></div>
          <div class="kv"><b>Zona</b><span>${safe(zona)}</span></div>
          ${tip ? `<div class="kv"><b>Tipologia</b><span>${safe(tip)}</span></div>` : ``}
          ${preco ? `<div class="kv"><b>Pre√ßo pedido</b><span>${safe(preco)}</span></div>` : ``}
        </div>
        <div class="card">
          <h3>Observa√ß√µes</h3>
          <p class="p">${safe(obs || '‚Äî').replace(/\\n/g,'<br>')}</p>
        </div>
      </div>
    </div>
  `;

  const blocoEstudo = hasStudy ? `
    <div class="sec">
      <h2>Dados do Estudo (extra√ß√£o assistida)</h2>
      <div class="card">
        <h3>S√≠ntese</h3>
        <p class="p">Conte√∫do estruturado a partir de texto colado (PDF/estudo). Esta sec√ß√£o suporta a decis√£o; a recomenda√ß√£o Garvetur est√° abaixo.</p>
        ${topKw.length ? `<div class="kws">${topKw.map(w=>`<span class="kw">${safe(w)}</span>`).join('')}</div>` : ``}
      </div>

      <div class="card" style="margin-top:12px">
        <h3>Cap√≠tulos & insights</h3>
        ${chapters.slice(0,10).map((ch, i)=>{
          const t = safe(ch?.title || `Cap√≠tulo ${i+1}`);
          const ins = Array.isArray(ch?.insights) ? ch.insights.filter(Boolean).slice(0,4) : [];
          const fallback = Array.isArray(ch?.paragraphs) ? ch.paragraphs.filter(Boolean).slice(0,1) : [];
          return `
            <div style="padding:10px 0;border-bottom:1px solid #f1f1f1">
              <div style="font-weight:900;color:#333">${i+1}. ${t}</div>
              ${ins.length ? `<ul class="list">${ins.map(x=>`<li>${safe(x)}</li>`).join('')}</ul>` : (fallback.length ? `<p class="p">${safe(fallback[0])}</p>` : `<p class="p" style="color:var(--muted)">(Sem insights autom√°ticos.)</p>`)}
            </div>
          `;
        }).join('')}
      </div>
    </div>
  ` : `
    <div class="sec">
      <h2>Dados do Estudo</h2>
      <div class="card">
        <h3>Nota</h3>
        <p class="p" style="color:var(--muted)">Sem extra√ß√£o assistida associada a este relat√≥rio. (Opcional) Adicione texto no Passo 4 para estruturar cap√≠tulos/insights.</p>
      </div>
    </div>
  `;

// ===== Sprint 2.4 ‚Äî Recomenda√ß√£o Garvetur estruturada =====
const recClean = sanitizeRecommendation(rec, resumoFinal);
const bullets = extractBullets(recClean, 3);

const posicao = recClean ? takeFirstSentences(recClean, 220) : '(preencher recomenda√ß√£o final)';

const razoes = bullets.length ? bullets : [
  "Alinhamento entre objetivo, horizonte e posicionamento do ativo/zona.",
  "Rela√ß√£o risco/retorno favor√°vel face √†s alternativas dispon√≠veis no momento.",
  "Capacidade de execu√ß√£o com plano e marcos claros (reduz indecis√£o e desgaste)."
];

const riscosVigiar = [
  "Volatilidade de procura/competi√ß√£o no curto prazo (exige disciplina de timing e proposta).",
  "Desalinhamento entre expectativa e condi√ß√µes do mercado (corrigir cedo via valida√ß√£o)."
];

const blocoRecomendacao = `
  <div class="sec">
    <h2>Recomenda√ß√£o Garvetur</h2>

    <div class="callout">
      <h3>Posi√ß√£o</h3>
      <p class="p">${safe(posicao).replace(/\n/g,'<br>')}</p>
      <div class="small">Nota: recomenda-se decis√£o com base em crit√©rios objetivos e execu√ß√£o calendarizada.</div>
    </div>

    <div class="kpi">
      <div class="card">
        <h3>Raz√µes principais</h3>
        <ul class="list">
          ${razoes.map(x=>`<li>${safe(x)}</li>`).join('')}
        </ul>
      </div>
      <div class="card">
        <h3>Riscos a vigiar</h3>
        <ul class="list">
          ${riscosVigiar.map(x=>`<li>${safe(x)}</li>`).join('')}
        </ul>
      </div>
    </div>

    <div class="rule"></div>

    <div class="callout">
      <h3>A√ß√£o recomendada (pr√≥ximo passo)</h3>
      <p class="p"><strong>${safe(cta)}</strong> ‚Äî 15 a 20 minutos para validar crit√©rios, cen√°rio e calendariza√ß√£o.</p>
      <div class="small">A Garvetur assume acompanhamento e controlo semanal at√© √† decis√£o.</div>
    </div>
  </div>
`;

  const blocoProximosPassos = `
    <div class="sec">
      <h2>Plano de a√ß√£o</h2>
      <div class="card">
        <h3>Pr√≥ximos passos</h3>
        <ul class="list">
          <li>Validar crit√©rios de decis√£o e prioridade (10‚Äì15 min).</li>
          <li>Confirmar dados cr√≠ticos existentes nos m√≥dulos (FSBO | Leads | Angaria√ß√µes).</li>
          <li>Definir estrat√©gia e calendariza√ß√£o operacional.</li>
          <li><strong>Fecho:</strong> ${safe(cta)}.</li>
        </ul>
      </div>
    </div>
  `;

  const html = `
  <!doctype html>
  <html lang="pt-PT">
    <head>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <title>${safe(title)}</title>
      ${premiumStyles}
    </head>
    <body>
      <div class="doc">
        <div class="brandline">
          <div>
            <div class="brand">Garvetur Luxury Porto</div>
            <div style="margin-top:6px">
              <span class="tag">${safe(confTag)}</span>
            </div>
          </div>
          <div class="meta">
            <div><strong>Cliente:</strong> ${safe(cliente.nome || '‚Äî')}</div>
            <div><strong>Data:</strong> ${ptDate(report.updatedAt || report.createdAt)}</div>
            <div><strong>Idioma:</strong> ${(cliente.idioma||'pt')==='en' ? 'EN' : 'PT'}</div>
          </div>
        </div>

        <div class="hero">
          <div class="h1">Relat√≥rio Premium ‚Äî An√°lise & Decis√£o</div>
          <div class="sub">
            Documento orientado √† decis√£o, com narrativa executiva e recomenda√ß√£o final.
            <br><strong>Objetivo:</strong> ${safe(obj.objetivo || '‚Äî')} ¬∑ <strong>Zona:</strong> ${safe(zona)} ${tip ? ('¬∑ <strong>Tipologia:</strong> '+safe(tip)) : ''}
          </div>
          <div class="goldbar"></div>
        </div>
        
${resumoFinal ? `
  <div class="sec">
    <h2>Resumo Executivo</h2>
    <div class="callout">
      <h3>Leitura r√°pida</h3>
      <p class="lead">${safe(resumoFinal).replace(/\n/g,'<br>')}</p>
      <div class="kws" style="margin-top:12px">
        <span class="badge">Fonte: ${safe(badgeFonte)}</span>
        <span class="badge">Zona: ${safe(badgeZona)}</span>
        <span class="badge">${safe(badgeConf)}</span>
      </div>
    </div>
  </div>
  <div class="rule"></div>
` : ``}
        ${blocoContexto}
        ${blocoAtivo}
        ${blocoEstudoMin}
        ${blocoRecomendacao}
        ${blocoProximosPassos}

        <div class="foot">
          <span>${safe(confTag)} ¬∑ Uso interno/cliente ¬∑ N√£o distribuir sem autoriza√ß√£o.</span>
          <span>Gerado em ${ptDate(todayISO())}</span>
        </div>
      </div>
    </body>
  </html>
  `;
  return html;
}

  /* ===========================
     List Actions + Export
  =========================== */
  if(reportsTbody){
  reportsTbody.addEventListener('click', async (e)=>{
      const btn = e.target.closest('button[data-act]');
      if(!btn) return;
      const act = btn.dataset.act;
      const id = btn.dataset.id;
  
      if(act==='open'){
        const r = getReport(id);
        if(!r) return;
        fillForm(r);
        setTab('wizard');
        setStep(1);
        return;
      }
  
      if(act==='duplicate'){
        const r = getReport(id);
        if(!r) return;
        const copy = JSON.parse(JSON.stringify(r));
        copy.id = uid('rpt');
        copy.createdAt = todayISO();
        copy.updatedAt = todayISO();
        copy.status = 'draft';
        upsertReport(copy);
        renderList();
        return;
      }

    if(act==='exportPremium'){
  const r = getReport(id);
  if(!r) return;
  const html = exportReportToPremiumHTML(r, {});
  openReportPreview(html, `Relat√≥rio Premium ‚Äî ${r?.cliente?.nome || 'Cliente'}`);
  return;
}
  
      if(act==='delete'){
        if(!confirm('Remover este relat√≥rio? (esta a√ß√£o n√£o pode ser desfeita)')) return;
        deleteReport(id);
        renderList();
        return;
      }
  
     if(act==='export'){
  try{
    const r = getReport(id);
    if(!r) return;
    const html = exportReportToPrintPDF(r, false);
    openReportPreview(html, `Relat√≥rio ‚Äî ${r?.cliente?.nome || 'Cliente'}`);
    return;
  }catch(err){
    console.error(err);
    alert('Erro ao exportar Relat√≥rio (PDF).\n' + (err?.message || err));
    return;
  }
}
    });
}


  btnApply?.addEventListener('click', renderList);
  btnClear?.addEventListener('click', ()=>{
    q.value = '';
    fStatus.value = '';
    fTipo.value = '';
    fDataDe.value = '';
    fDataAte.value = '';
    fConfidencial.checked = false;
    renderList();
  });

  /* ===========================
     Export Buttons
  =========================== */
  btnBuildPdf?.addEventListener('click', ()=>{
  try{
    const r = saveDraft();
    const html = exportReportToPrintPDF(r, false);
    openReportPreview(html, `Relat√≥rio ‚Äî ${r?.cliente?.nome || 'Cliente'}`);
  }catch(err){
    console.error(err);
    alert('Erro ao gerar Relat√≥rio (PDF). Se o problema persistir, copie e volte a colar o ficheiro est√°vel e avise-me do texto deste erro:\n' + (err?.message || err));
  }
});

btnBuildExec?.addEventListener('click', ()=>{
  try{
    const r = saveDraft();
    const html = exportReportToPrintPDF(r, true);
    openReportPreview(html, `Relat√≥rio Executivo ‚Äî ${r?.cliente?.nome || 'Cliente'}`);
  }catch(err){
    console.error(err);
    alert('Erro ao gerar Relat√≥rio Executivo. Se o problema persistir, copie e volte a colar o ficheiro est√°vel e avise-me do texto deste erro:\n' + (err?.message || err));
  }
});

btnBuildPremium?.addEventListener('click', ()=>{
  const r = saveDraft();
  const html = exportReportToPremiumHTML(r, {});
  openReportPreview(html, `Relat√≥rio Premium ‚Äî ${r?.cliente?.nome || 'Cliente'}`);
});

  if(btnApplyTemplates){
  btnApplyTemplates.addEventListener('click', ()=>{
    applyOfficialTemplates();
    // opcional: guardar j√° no draft para n√£o se perder
    try{ saveDraftSilent(); }catch{}
  });
}

if(btnResetTemplates){
  btnResetTemplates.addEventListener('click', ()=>{
    resetTemplatesUI();
  });
}

  btnDuplicate?.addEventListener('click', ()=>{
    const r = saveDraft();
    const copy = JSON.parse(JSON.stringify(r));
    copy.id = uid('rpt');
    copy.createdAt = todayISO();
    copy.updatedAt = todayISO();
    copy.status = 'draft';
    upsertReport(copy);
    renderList();
    alert('Template duplicado. Pode abrir a c√≥pia na lista.');
  });

  
/* ===========================
     Tabs + init
  =========================== */
  tabList?.addEventListener('click', ()=>{
  setTab('list');
  renderList(); // garante que a lista ‚Äúvolta a aparecer‚Äù e fica atualizada
});
  tabWizard?.addEventListener('click', ()=>{
    setTab('wizard');
    // inicializar importa√ß√£o cruzada apenas quando entra no wizard (evita bloqueios na lista)
    try{ initCrossModuleImport(); }catch(e){ console.warn('Auto-import indispon√≠vel', e); }
  });

  // Toggle imovel vs zona
  const assetImovel = el('assetImovel');
  const assetZona = el('assetZona');
  Array.from(document.querySelectorAll('input[name="assetMode"]')).forEach(r=>{
    r.addEventListener('change', ()=>{
      const v = document.querySelector('input[name="assetMode"]:checked')?.value;
      if(assetImovel) assetImovel.classList.toggle('hidden', v !== 'imovel');
      if(assetZona) assetZona.classList.toggle('hidden', v !== 'zona');
    });
  });

  function safeInit(){
    try{
      setTab('list');
      setStep(1);
      renderList();
      // N√ÉO iniciar scan localStorage aqui; s√≥ quando necess√°rio (wizard/passo 1)
    }catch(err){
      console.error('Falha no arranque do m√≥dulo:', err);
      alert('O m√≥dulo iniciou com erro. Abra a Consola (F12) para ver o detalhe e partilhe o erro.');
    }
  }

  safeInit();

})();</script>
</body>
</html>
