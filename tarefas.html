<!doctype html>
<html lang="pt-PT">
<head>
  <meta charset="utf-8" />
  <title>Garvetur Porto Pro ‚Äî Tarefas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --gold:#A38B63;
      --gold-soft:rgba(163,139,99,.35);
      --bg:#0B0B0B;
      --panel:#121212;
      --panel-soft:#181818;
      --text:#FFFFFF;
      --muted:#A0A0A0;
      --danger:#F25F5C;
      --success:#4CAF50;
      --warning:#FFC857;
      --border:rgba(255,255,255,.16);
      --radius-md:14px;
      --radius-lg:18px;
      --shadow-soft:0 18px 35px rgba(0,0,0,.6);
    }
    *{box-sizing:border-box;}
    html,body{
      margin:0;
      height:100%;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      background:radial-gradient(circle at top,#1c1c1c 0,#050505 55%,#000 100%);
      color:var(--text);
    }
    body{
      display:flex;
      flex-direction:column;
    }
    .app-shell{
      display:grid;
      grid-template-rows:64px auto;
      height:100%;
    }

    header.app-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 18px;
      border-bottom:1px solid rgba(163,139,99,.35);
      background:linear-gradient(90deg,#050505,#111,#050505);
      gap:16px;
      flex-wrap:wrap;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .brand-icon{
      width:26px;
      height:26px;
      border-radius:999px;
      border:1px solid var(--gold);
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:0 0 0 1px rgba(163,139,99,.3);
    }
    .brand h1{
      margin:0;
      font-size:17px;
      letter-spacing:.04em;
      text-transform:uppercase;
      color:var(--gold);
    }
    .brand span.sub{
      display:block;
      font-size:11px;
      color:var(--muted);
      letter-spacing:.12em;
      text-transform:uppercase;
    }

    .nav-tabs{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap:4px;
      background:rgba(0,0,0,.35);
      padding:4px;
      border-radius:999px;
      border:1px solid rgba(163,139,99,.35);
    }
    .nav-tab{
      padding:5px 10px;
      border-radius:999px;
      font-size:11px;
      text-decoration:none;
      color:var(--muted);
      letter-spacing:.12em;
      text-transform:uppercase;
      border:1px solid transparent;
      transition:.16s background,.16s color,.16s border-color,.16s transform;
    }
    .nav-tab:hover{
      color:#fff;
      border-color:rgba(163,139,99,.6);
      transform:translateY(-1px);
    }
    .nav-tab.active{
      background:var(--gold);
      color:#0A0A0A;
      border-color:var(--gold);
      font-weight:600;
    }

    .header-actions{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }

    .btn{
      border-radius:999px;
      border:1px solid var(--gold-soft);
      background:rgba(12,12,12,.9);
      color:var(--text);
      padding:7px 12px;
      font-size:13px;
      display:inline-flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
      transition:.18s border-color,.18s background,.18s transform;
    }
    .btn.primary{
      background:var(--gold);
      color:#0A0A0A;
      border-color:var(--gold);
      font-weight:600;
    }
    .btn.ghost{
      background:transparent;
      border-color:rgba(255,255,255,.24);
      color:var(--muted);
    }
    .btn[disabled]{
      opacity:.45;
      cursor:not-allowed;
      transform:none;
    }
    .btn:hover:not([disabled]){
      border-color:var(--gold);
      transform:translateY(-1px);
    }

    .pill-lock{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:12px;
      padding:4px 9px;
      border-radius:999px;
      background:rgba(0,0,0,.45);
      border:1px solid rgba(255,255,255,.14);
      color:var(--muted);
    }
    .pill-lock span.state{
      font-weight:500;
      color:var(--gold);
    }
    .pill-lock button{
      all:unset;
      cursor:pointer;
      padding:2px 6px;
      border-radius:999px;
      background:rgba(255,255,255,.05);
    }

    .layout{
      display:grid;
      grid-template-columns:320px minmax(0,1fr);
      height:calc(100vh - 64px);
      max-height:calc(100vh - 64px);
      overflow:hidden;
    }
    @media (max-width:960px){
      .layout{
        grid-template-columns:1fr;
        grid-template-rows:auto auto;
        height:auto;
        max-height:none;
      }
    }

    .sidebar{
      background:radial-gradient(circle at top left,#141414,#060606);
      border-right:1px solid rgba(163,139,99,.24);
      padding:12px 14px;
      overflow-y:auto;
    }
    .sidebar-section{
      border-radius:var(--radius-md);
      padding:10px 11px;
      background:rgba(0,0,0,.45);
      border:1px solid rgba(163,139,99,.18);
      margin-bottom:10px;
    }
    .sidebar-section h3{
      margin:0 0 6px;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.16em;
      color:var(--muted);
    }
    .sidebar-section p{
      margin:2px 0 4px;
      font-size:12px;
      color:var(--muted);
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:4px;
      margin-bottom:8px;
    }
    .field-row{
      display:flex;
      gap:6px;
    }
    label.field-label{
      font-size:11px;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.12em;
    }
    input[type="text"],
    input[type="date"],
    select{
      background:rgba(0,0,0,.7);
      border-radius:10px;
      border:1px solid rgba(255,255,255,.16);
      color:#fff;
      padding:6px 8px;
      font-size:12px;
      outline:none;
      width:100%;
    }
    input:focus,select:focus{
      border-color:var(--gold);
      box-shadow:0 0 0 1px rgba(163,139,99,.35);
    }

    .cards-area{
      padding:14px 16px 18px;
      overflow-y:auto;
      background:radial-gradient(circle at top,#1a1a1a,#050505 55%,#000 100%);
      display:flex;
      flex-direction:column;
    }
    .cards-header{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      margin-bottom:8px;
      gap:10px;
    }
    .cards-header-left h2{
      margin:0;
      font-size:15px;
      letter-spacing:.16em;
      text-transform:uppercase;
      color:var(--muted);
    }
    .cards-header-left p{
      margin:2px 0 0;
      font-size:12px;
      color:var(--muted);
    }
    .summary-bar{
      padding:6px 10px;
      font-size:12px;
      border-radius:999px;
      border:1px solid rgba(163,139,99,.35);
      background:rgba(0,0,0,.55);
      color:#ddd;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      margin-bottom:8px;
    }
    .badge-kpi{
      padding:2px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      font-size:11px;
      color:var(--muted);
      background:rgba(15,15,15,.9);
    }
    .badge-kpi.highlight{
      border-color:var(--gold);
      color:var(--gold);
      font-weight:600;
    }

    .cards-grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(320px,1fr));
      gap:10px;
      margin-top:4px;
    }
    .card{
      border-radius:var(--radius-lg);
      border:1px solid rgba(163,139,99,.3);
      background:radial-gradient(circle at top left,#181818,#070707);
      box-shadow:var(--shadow-soft);
      padding:9px 10px;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .card.dim{
      opacity:.5;
      border-style:dashed;
    }
    .card-top{
      display:flex;
      justify-content:space-between;
      gap:8px;
    }
    .card-title-block{
      flex:1;
      min-width:0;
    }
    .card-title{
      margin:0;
      font-size:14px;
      font-weight:600;
      color:#fff;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .card-sub{
      margin:1px 0 0;
      font-size:11px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:4px;
      margin-top:3px;
    }
    .chip{
      border-radius:999px;
      padding:2px 7px;
      font-size:10px;
      border:1px solid rgba(163,139,99,.35);
      background:rgba(10,10,10,.9);
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.08em;
    }
    .chip.estado_por_fazer{border-color:rgba(255,255,255,.25);}
    .chip.estado_em_progresso{border-color:rgba(255,200,87,.85);color:#FFE082;}
    .chip.estado_concluida{border-color:rgba(76,175,80,.85);color:#A5D6A7;}
    .chip.estado_cancelada{border-color:rgba(242,95,92,.9);color:#FFABAB;}
    .chip.prio_alta{border-color:rgba(242,95,92,.9);color:#FFABAB;}
    .chip.prio_baixa{border-color:rgba(163,139,99,.4);color:#B0BEC5;}

    .card-body{
      font-size:12px;
      color:#ddd;
      margin-top:4px;
    }
    .card-body small{
      color:var(--muted);
    }
    .card-footer{
      margin-top:6px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:4px;
      font-size:11px;
      color:var(--muted);
    }
    .card-footer-right{
      display:flex;
      flex-wrap:wrap;
      gap:4px;
      justify-content:flex-end;
    }
    .btn-xs{
      border-radius:999px;
      padding:3px 7px;
      border:1px solid rgba(163,139,99,.35);
      background:rgba(5,5,5,.9);
      color:var(--muted);
      font-size:10px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:4px;
    }
    .btn-xs.primary{
      border-color:var(--gold);
      color:var(--gold);
    }
    .btn-xs.danger{
      border-color:var(--danger);
      color:#FFB3B0;
    }

    .empty{
      font-size:12px;
      color:var(--muted);
      margin-top:10px;
    }

    /* Modal */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.7);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:40;
    }
    .modal-backdrop.show{display:flex;}
    .modal{
      width:min(720px,96vw);
      max-height:90vh;
      background:radial-gradient(circle at top,#151515,#050505);
      border-radius:22px;
      border:1px solid rgba(163,139,99,.5);
      box-shadow:0 24px 45px rgba(0,0,0,.8);
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }
    .modal-header{
      padding:10px 14px 8px;
      border-bottom:1px solid rgba(163,139,99,.25);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background:linear-gradient(90deg,#050505,#111,#050505);
    }
    .modal-header h2{
      margin:0;
      font-size:14px;
      letter-spacing:.12em;
      text-transform:uppercase;
      color:var(--gold);
    }
    .modal-body{
      padding:10px 14px 12px;
      overflow-y:auto;
      font-size:12px;
    }
    .modal-footer{
      padding:8px 14px 10px;
      border-top:1px solid rgba(163,139,99,.25);
      display:flex;
      justify-content:space-between;
      gap:8px;
      background:#050505;
      font-size:11px;
      color:var(--muted);
    }
    .form-grid{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:8px 10px;
    }
    @media (max-width:720px){
      .form-grid{grid-template-columns:1fr;}
    }
    textarea{
      width:100%;
      min-height:70px;
      resize:vertical;
      background:#0E0E0E;
      border:1px solid rgba(255,255,255,.16);
      border-radius:10px;
      color:#fff;
      padding:6px 8px;
      font-size:12px;
      outline:none;
    }
    textarea:focus{
      border-color:var(--gold);
      box-shadow:0 0 0 1px rgba(163,139,99,.35);
    }
    .hint{font-size:11px;color:var(--muted);}
  </style>
</head>
<body>
<div class="app-shell">
  <header class="app-header">
    <div class="brand">
      <div class="brand-icon">
        <svg width="16" height="16" viewBox="0 0 24 24" stroke="var(--gold)" fill="none" stroke-width="1.8">
          <circle cx="12" cy="12" r="9"></circle>
          <path d="M8 12.5l2.5 2.5L16 9"></path>
        </svg>
      </div>
      <div>
        <h1>Garvetur Porto Pro ‚Äî Tarefas</h1>
        <span class="sub">Follow-up comercial & operacional</span>
      </div>
    </div>

    <nav class="nav-tabs">
      <a href="index.html" class="nav-tab">In√≠cio</a>
      <a href="mapa.html" class="nav-tab">Mapa</a>
      <a href="kanban.html" class="nav-tab">Leads</a>
      <a href="angariacoes.html" class="nav-tab">Angaria√ß√µes</a>
      <a href="dashboard.html" class="nav-tab">Dashboard</a>
      <a href="vendas.html" class="nav-tab">Vendas</a>
      <a href="tarefas.html" class="nav-tab active">Tarefas</a>
    </nav>

    <div class="header-actions">
      <div class="pill-lock" id="lockPill">
        <span>Modo</span>
        <span class="state" id="lockStateLabel">Bloqueado</span>
        <button id="toggleLockBtn" title="Alternar entre edi√ß√£o bloqueada e ativa">üîí</button>
      </div>
      <button class="btn ghost" id="exportCsvBtn">‚§ì CSV</button>
      <button class="btn primary" id="newTaskBtn">+ Nova tarefa</button>
    </div>
  </header>

  <div class="layout">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="sidebar-section">
        <h3>Filtros</h3>
        <div class="field">
          <label class="field-label" for="f_q">Pesquisa</label>
          <input id="f_q" type="text" placeholder="T√≠tulo, respons√°vel, origem, tags, notas‚Ä¶">
        </div>
        <div class="field">
          <label class="field-label" for="f_responsavel">Respons√°vel</label>
          <select id="f_responsavel">
            <option value="">(Todos)</option>
            <option>Rui Quelhas</option>
            <option>Manuel Oliveira</option>
            <option>Jo√£o Sousa</option>
            <option>Francisco dos Santos</option>
            <option>Ros√°rio Vasconcelos</option>
            <option>Armanda Meireles</option>
            <option>Audrey Lucas</option>
          </select>
        </div>
        <div class="field-row">
          <div class="field">
            <label class="field-label" for="f_estado">Estado</label>
            <select id="f_estado">
              <option value="">(Todos)</option>
              <option value="por_fazer">Por fazer</option>
              <option value="em_progresso">Em progresso</option>
              <option value="concluida">Conclu√≠da</option>
              <option value="cancelada">Cancelada</option>
            </select>
          </div>
          <div class="field">
            <label class="field-label" for="f_prioridade">Prioridade</label>
            <select id="f_prioridade">
              <option value="">(Todas)</option>
              <option value="baixa">Baixa</option>
              <option value="normal">Normal</option>
              <option value="alta">Alta</option>
            </select>
          </div>
        </div>
        <div class="field-row">
          <div class="field">
            <label class="field-label" for="f_de">Prazo de</label>
            <input id="f_de" type="date">
          </div>
          <div class="field">
            <label class="field-label" for="f_ate">Prazo at√©</label>
            <input id="f_ate" type="date">
          </div>
        </div>
        <div class="field">
          <label class="field-label" for="f_origem">Origem</label>
          <select id="f_origem">
            <option value="">(Todas)</option>
            <option value="lead">Lead</option>
            <option value="angariacao">Angaria√ß√£o</option>
            <option value="manual">Manual/Outros</option>
          </select>
        </div>
        <div class="field-row" style="margin-top:6px;">
          <button class="btn" id="applyFiltersBtn" style="flex:1;">Aplicar</button>
          <button class="btn ghost" id="clearFiltersBtn" style="flex:1;">Limpar</button>
        </div>
      </div>

      <div class="sidebar-section">
        <h3>Notas</h3>
        <p>As tarefas s√£o guardadas apenas neste navegador (<strong>localStorage</strong>).</p>
        <p>Quando o cadeado est√° em <strong>Bloqueado</strong>, n√£o h√° risco de apagar ou alterar tarefas por engano.</p>
        <p>Quando est√° em <strong>Edi√ß√£o ativa</strong>, pode criar, editar, concluir e eliminar tarefas.</p>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="cards-area">
      <div class="cards-header">
        <div class="cards-header-left">
          <h2>Tarefas</h2>
          <p>Follow-up estruturado de Leads, Angaria√ß√µes e tarefas internas.</p>
        </div>
      </div>

      <div id="summaryBar" class="summary-bar"></div>

      <div id="cardsGrid" class="cards-grid"></div>
      <div id="emptyState" class="empty" style="display:none;">
        N√£o existem tarefas com os filtros atuais.
      </div>
    </main>
  </div>
</div>

<!-- MODAL TAREFA -->
<div class="modal-backdrop" id="taskModalBackdrop">
  <div class="modal">
    <div class="modal-header">
      <h2 id="modalTitle">Nova tarefa</h2>
      <button class="btn ghost" id="closeModalBtn">‚úï</button>
    </div>
    <div class="modal-body">
      <form id="taskForm">
        <input type="hidden" id="t_id">
        <div class="form-grid">
          <div class="field">
            <label class="field-label" for="t_titulo">T√≠tulo *</label>
            <input id="t_titulo" type="text" placeholder="Ex.: Follow-up lead Jo√£o ‚Äî enviar proposta">
          </div>
          <div class="field">
            <label class="field-label" for="t_responsavel">Respons√°vel *</label>
            <select id="t_responsavel">
              <option value="">‚Äî</option>
              <option>Rui Quelhas</option>
              <option>Manuel Oliveira</option>
              <option>Jo√£o Sousa</option>
              <option>Francisco dos Santos</option>
              <option>Ros√°rio Vasconcelos</option>
              <option>Armanda Meireles</option>
              <option>Audrey Lucas</option>
            </select>
          </div>
          <div class="field">
            <label class="field-label" for="t_apoio">Apoio</label>
            <input id="t_apoio" type="text" placeholder="Ex.: apoio coordenador / colega">
          </div>
          <div class="field">
            <label class="field-label" for="t_estado">Estado</label>
            <select id="t_estado">
              <option value="por_fazer">Por fazer</option>
              <option value="em_progresso">Em progresso</option>
              <option value="concluida">Conclu√≠da</option>
              <option value="cancelada">Cancelada</option>
            </select>
          </div>
          <div class="field">
            <label class="field-label" for="t_prioridade">Prioridade</label>
            <select id="t_prioridade">
              <option value="normal">Normal</option>
              <option value="alta">Alta</option>
              <option value="baixa">Baixa</option>
            </select>
          </div>
          <div class="field">
            <label class="field-label" for="t_tipo">Tipo de tarefa</label>
            <input id="t_tipo" type="text" placeholder="Ex.: followup, visita, reuni√£o, interno‚Ä¶">
          </div>
          <div class="field">
            <label class="field-label" for="t_dataCriacao">Data cria√ß√£o</label>
            <input id="t_dataCriacao" type="date">
          </div>
          <div class="field">
            <label class="field-label" for="t_dataLimite">Data limite</label>
            <input id="t_dataLimite" type="date">
          </div>
          <div class="field">
            <label class="field-label" for="t_horaLimite">Hora limite</label>
            <input id="t_horaLimite" type="text" placeholder="Ex.: 15:00">
          </div>
          <div class="field">
            <label class="field-label" for="t_tags">Tags</label>
            <input id="t_tags" type="text" placeholder="Ex.: lead, followup, The View">
          </div>
          <div class="field">
            <label class="field-label" for="t_origemTipo">Origem</label>
            <select id="t_origemTipo">
              <option value="">‚Äî</option>
              <option value="lead">Lead</option>
              <option value="angariacao">Angaria√ß√£o</option>
              <option value="manual">Manual/Outros</option>
            </select>
          </div>
          <div class="field">
            <label class="field-label" for="t_origemRef">Origem Ref.</label>
            <input id="t_origemRef" type="text" placeholder="Ex.: Ref interna, nome lead, nome empreendimento">
          </div>
        </div>
        <div class="field" style="margin-top:6px;">
          <label class="field-label" for="t_descricao">Descri√ß√£o</label>
          <textarea id="t_descricao" placeholder="Notas √∫teis para a execu√ß√£o da tarefa."></textarea>
        </div>
        <p class="hint">Se a tarefa tiver origem em Lead ou Angaria√ß√£o criada noutro m√≥dulo, o campo <strong>Origem</strong> ser√° preenchido automaticamente (origemTipo/origemRef).</p>
      </form>
    </div>
    <div class="modal-footer">
      <span>Dados guardados em localStorage (chave <code>gpp_tarefas_v1</code>).</span>
      <div>
        <button class="btn ghost" id="cancelModalBtn">Cancelar</button>
        <button class="btn primary" id="saveTaskBtn">Guardar</button>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  const TASKS_STORAGE_KEY = 'gpp_tarefas_v1';

  function loadTasksState(){
    try{
      const raw = localStorage.getItem(TASKS_STORAGE_KEY);
      if(!raw) return {locked:true,tasks:[]};
      const parsed = JSON.parse(raw);
      if(!Array.isArray(parsed.tasks)) parsed.tasks = [];
      if(typeof parsed.locked!=='boolean') parsed.locked = true;
      return parsed;
    }catch(e){
      console.error('Erro ao carregar tarefas', e);
      return {locked:true,tasks:[]};
    }
  }
  function saveTasksState(state){
    try{
      localStorage.setItem(TASKS_STORAGE_KEY, JSON.stringify(state));
    }catch(e){
      console.error('Erro ao guardar tarefas', e);
    }
  }

  function $(id){ return document.getElementById(id); }
  function todayISO(){
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    return y + '-' + m + '-' + day;
  }

  let state = loadTasksState();
  let FILTER = {q:'',responsavel:'',estado:'',prioridade:'',de:'',ate:'',origem:''};

  const lockStateLabel = $('lockStateLabel');
  const toggleLockBtn = $('toggleLockBtn');
  const newTaskBtn = $('newTaskBtn');
  const exportCsvBtn = $('exportCsvBtn');

  const f_q = $('f_q');
  const f_responsavel = $('f_responsavel');
  const f_estado = $('f_estado');
  const f_prioridade = $('f_prioridade');
  const f_de = $('f_de');
  const f_ate = $('f_ate');
  const f_origem = $('f_origem');
  const applyFiltersBtn = $('applyFiltersBtn');
  const clearFiltersBtn = $('clearFiltersBtn');

  const cardsGrid = $('cardsGrid');
  const emptyState = $('emptyState');
  const summaryBar = $('summaryBar');

  const taskModalBackdrop = $('taskModalBackdrop');
  const modalTitle = $('modalTitle');
  const closeModalBtn = $('closeModalBtn');
  const cancelModalBtn = $('cancelModalBtn');
  const saveTaskBtn = $('saveTaskBtn');

  const t_id = $('t_id');
  const t_titulo = $('t_titulo');
  const t_responsavel = $('t_responsavel');
  const t_apoio = $('t_apoio');
  const t_estado = $('t_estado');
  const t_prioridade = $('t_prioridade');
  const t_tipo = $('t_tipo');
  const t_dataCriacao = $('t_dataCriacao');
  const t_dataLimite = $('t_dataLimite');
  const t_horaLimite = $('t_horaLimite');
  const t_tags = $('t_tags');
  const t_origemTipo = $('t_origemTipo');
  const t_origemRef = $('t_origemRef');
  const t_descricao = $('t_descricao');

  function updateLockUI(){
    if(state.locked){
      lockStateLabel.textContent = 'Bloqueado';
      toggleLockBtn.textContent = 'üîí';
      newTaskBtn.disabled = true;
    }else{
      lockStateLabel.textContent = 'Edi√ß√£o ativa';
      toggleLockBtn.textContent = 'üîì';
      newTaskBtn.disabled = false;
    }
  }

  function norm(s){
    return String(s||'').toLowerCase()
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g,'');
  }

  function openModal(task){
    if(task){
      modalTitle.textContent = 'Editar tarefa';
      t_id.value = task.id || '';
      t_titulo.value = task.titulo || '';
      t_responsavel.value = task.responsavel || '';
      t_apoio.value = task.apoio || '';
      t_estado.value = task.estado || 'por_fazer';
      t_prioridade.value = task.prioridade || 'normal';
      t_tipo.value = task.tipoTarefa || '';
      t_dataCriacao.value = task.dataCriacao || todayISO();
      t_dataLimite.value = task.dataLimite || '';
      t_horaLimite.value = task.horaLimite || '';
      t_tags.value = task.tags || '';
      t_origemTipo.value = task.origemTipo || '';
      t_origemRef.value = task.origemRef || '';
      t_descricao.value = task.descricao || '';
    }else{
      modalTitle.textContent = 'Nova tarefa';
      t_id.value = '';
      t_titulo.value = '';
      t_responsavel.value = '';
      t_apoio.value = '';
      t_estado.value = 'por_fazer';
      t_prioridade.value = 'normal';
      t_tipo.value = '';
      t_dataCriacao.value = todayISO();
      t_dataLimite.value = '';
      t_horaLimite.value = '';
      t_tags.value = '';
      t_origemTipo.value = 'manual';
      t_origemRef.value = '';
      t_descricao.value = '';
    }
    taskModalBackdrop.classList.add('show');
  }

  function closeModal(){
    taskModalBackdrop.classList.remove('show');
  }

  function collectForm(){
    const id = t_id.value || ('task_' + Date.now());
    const existing = state.tasks.find(t=>t.id===id) || {};
    const nowMs = existing.createdAtMs || Date.now();

    const tarefa = Object.assign({}, existing, {
      id,
      titulo: t_titulo.value.trim(),
      responsavel: t_responsavel.value.trim(),
      apoio: t_apoio.value.trim(),
      estado: t_estado.value || 'por_fazer',
      prioridade: t_prioridade.value || 'normal',
      tipoTarefa: t_tipo.value.trim(),
      dataCriacao: t_dataCriacao.value || todayISO(),
      dataLimite: t_dataLimite.value || '',
      horaLimite: t_horaLimite.value.trim(),
      tags: t_tags.value.trim(),
      origemTipo: t_origemTipo.value || '',
      origemRef: t_origemRef.value.trim(),
      descricao: t_descricao.value.trim(),
      createdAtMs: nowMs
    });
    return tarefa;
  }

  function applyFilters(tasks){
    let arr = tasks.slice();
    const tq = norm(FILTER.q||'');
    if(tq){
      arr = arr.filter(t=>{
        const blob = [
          t.titulo,
          t.responsavel,
          t.apoio,
          t.origemTipo,
          t.origemRef,
          t.tags,
          t.descricao
        ].map(norm).join(' ');
        return blob.includes(tq);
      });
    }
    if(FILTER.responsavel){
      arr = arr.filter(t=>t.responsavel === FILTER.responsavel);
    }
    if(FILTER.estado){
      arr = arr.filter(t=>t.estado === FILTER.estado);
    }
    if(FILTER.prioridade){
      arr = arr.filter(t=>t.prioridade === FILTER.prioridade);
    }
    if(FILTER.origem){
      if(FILTER.origem === 'manual'){
        arr = arr.filter(t=>!t.origemTipo || t.origemTipo==='manual');
      }else{
        arr = arr.filter(t=>t.origemTipo === FILTER.origem);
      }
    }
    if(FILTER.de){
      arr = arr.filter(t=>!t.dataLimite || t.dataLimite >= FILTER.de);
    }
    if(FILTER.ate){
      arr = arr.filter(t=>!t.dataLimite || t.dataLimite <= FILTER.ate);
    }
    return arr;
  }

  function renderSummary(all, filtered){
    const total = all.length;
    const visiveis = filtered.length;
    const porEstado = {por_fazer:0,em_progresso:0,concluida:0,cancelada:0};
    all.forEach(t=>{
      if(porEstado[t.estado]!==undefined) porEstado[t.estado]++;
    });

    summaryBar.innerHTML = '';
    const spanTotal = document.createElement('span');
    spanTotal.className='badge-kpi';
    spanTotal.textContent = 'Total: ' + total;
    summaryBar.appendChild(spanTotal);

    const spanVis = document.createElement('span');
    spanVis.className='badge-kpi';
    spanVis.textContent = 'Vis√≠veis (filtros): ' + visiveis;
    summaryBar.appendChild(spanVis);

    const mapLbl = {
      por_fazer:'Por fazer',
      em_progresso:'Em progresso',
      concluida:'Conclu√≠da',
      cancelada:'Cancelada'
    };
    Object.keys(porEstado).forEach(k=>{
      const s = document.createElement('span');
      s.className='badge-kpi';
      s.textContent = mapLbl[k]+': '+porEstado[k];
      summaryBar.appendChild(s);
    });

    const concl = porEstado.concluida;
    const pend = total ? (total - concl - porEstado.cancelada) : 0;
    const taxa = total ? ((concl/total)*100).toFixed(1) : '0.0';
    const hl = document.createElement('span');
    hl.className='badge-kpi highlight';
    hl.textContent = 'Taxa conclus√£o (excl. canceladas): ' + taxa + '%';
    summaryBar.appendChild(hl);
  }

  function classEstadoChip(estado){
    switch(estado){
      case 'por_fazer': return 'chip estado_por_fazer';
      case 'em_progresso': return 'chip estado_em_progresso';
      case 'concluida': return 'chip estado_concluida';
      case 'cancelada': return 'chip estado_cancelada';
      default: return 'chip';
    }
  }
  function labelEstado(estado){
    return ({
      por_fazer:'Por fazer',
      em_progresso:'Em progresso',
      concluida:'Conclu√≠da',
      cancelada:'Cancelada'
    }[estado] || '‚Äî');
  }
  function labelPrioridade(p){
    return ({
      baixa:'Baixa',
      normal:'Normal',
      alta:'Alta'
    }[p] || '‚Äî');
  }

  function openFichaOriginal(tarefa){
    if(tarefa.origemTipo === 'lead'){
      // Lead ‚ûú abre Kanban
      window.open('kanban.html','_blank');
      return;
    }
    if(tarefa.origemTipo === 'angariacao'){
      // Angaria√ß√£o ‚ûú abre Angaria√ß√µes
      window.open('angariacoes.html','_blank');
      return;
    }
    alert('Esta tarefa n√£o tem ficha original associada.');
  }

  function renderTasks(){
    const all = state.tasks
      .slice()
      .sort((a,b)=>(a.createdAtMs||0)-(b.createdAtMs||0));

    const filtered = applyFilters(all);
    cardsGrid.innerHTML = '';

    if(!filtered.length){
      emptyState.style.display='block';
    }else{
      emptyState.style.display='none';
    }

    renderSummary(all, filtered);

    filtered.forEach(t=>{
      const card = document.createElement('div');
      card.className = 'card' + (t.estado==='concluida' || t.estado==='cancelada' ? ' dim' : '');

      const top = document.createElement('div');
      top.className='card-top';

      const tb = document.createElement('div');
      tb.className='card-title-block';

      const title = document.createElement('h3');
      title.className='card-title';
      title.textContent = t.titulo || '(Sem t√≠tulo)';
      tb.appendChild(title);

      const sub = document.createElement('div');
      sub.className='card-sub';
      const partes = [];
      if(t.responsavel) partes.push('Resp.: '+t.responsavel);
      if(t.origemTipo){
        partes.push('Origem: '+(t.origemTipo==='lead' ? 'Lead' : t.origemTipo==='angariacao' ? 'Angaria√ß√£o' : 'Manual'));
      }
      if(t.origemRef) partes.push(t.origemRef);
      sub.textContent = partes.join(' ¬∑ ');
      tb.appendChild(sub);

      const chips = document.createElement('div');
      chips.className='chips';

      const chEst = document.createElement('span');
      chEst.className = classEstadoChip(t.estado);
      chEst.textContent = labelEstado(t.estado);
      chips.appendChild(chEst);

      const chPri = document.createElement('span');
      chPri.className='chip ' + (t.prioridade==='alta' ? 'prio_alta' : t.prioridade==='baixa' ? 'prio_baixa' : '');
      chPri.textContent = 'Prioridade: '+labelPrioridade(t.prioridade);
      chips.appendChild(chPri);

      if(t.tipoTarefa){
        const chTipo = document.createElement('span');
        chTipo.className='chip';
        chTipo.textContent = t.tipoTarefa;
        chips.appendChild(chTipo);
      }
      if(t.tags){
        const chTags = document.createElement('span');
        chTags.className='chip';
        chTags.textContent = t.tags;
        chips.appendChild(chTags);
      }

      tb.appendChild(chips);
      top.appendChild(tb);
      card.appendChild(top);

      if(t.descricao){
        const body = document.createElement('div');
        body.className='card-body';
        body.textContent = t.descricao;
        card.appendChild(body);
      }

      const footer = document.createElement('div');
      footer.className='card-footer';

      const left = document.createElement('div');
      const linhas = [];
      if(t.dataCriacao) linhas.push('Criada: '+t.dataCriacao);
      if(t.dataLimite) linhas.push('Prazo: '+t.dataLimite+(t.horaLimite? ' '+t.horaLimite:''));
      left.textContent = linhas.join(' ¬∑ ');
      footer.appendChild(left);

      const right = document.createElement('div');
      right.className='card-footer-right';

      const btnEditar = document.createElement('button');
      btnEditar.className='btn-xs primary';
      btnEditar.textContent='Editar';
      btnEditar.addEventListener('click',()=>{
        if(state.locked){
          alert('Modo de edi√ß√£o bloqueado. Desbloqueie o cadeado para editar tarefas.');
          return;
        }
        openModal(t);
      });
      right.appendChild(btnEditar);

      const btnConcluir = document.createElement('button');
      btnConcluir.className='btn-xs';
      btnConcluir.textContent = t.estado==='concluida' ? 'Reabrir' : 'Concluir';
      btnConcluir.addEventListener('click',()=>{
        if(state.locked){
          alert('Modo de edi√ß√£o bloqueado. Desbloqueie o cadeado para alterar o estado.');
          return;
        }
        t.estado = (t.estado==='concluida' ? 'por_fazer' : 'concluida');
        saveTasksState(state);
        renderTasks();
      });
      right.appendChild(btnConcluir);

      const btnVer = document.createElement('button');
      btnVer.className='btn-xs';
      btnVer.textContent='Ver ficha original';
      btnVer.addEventListener('click',()=>{
        openFichaOriginal(t);
      });
      right.appendChild(btnVer);

      const btnDel = document.createElement('button');
      btnDel.className='btn-xs danger';
      btnDel.textContent='Apagar';
      btnDel.addEventListener('click',()=>{
        if(state.locked){
          alert('Modo de edi√ß√£o bloqueado. Desbloqueie o cadeado para apagar tarefas.');
          return;
        }
        if(confirm('Tem a certeza que pretende apagar esta tarefa?')){
          state.tasks = state.tasks.filter(x=>x.id!==t.id);
          saveTasksState(state);
          renderTasks();
        }
      });
      right.appendChild(btnDel);

      footer.appendChild(right);
      card.appendChild(footer);

      cardsGrid.appendChild(card);
    });
  }

  function exportCsv(){
    if(!state.tasks.length){
      alert('N√£o existem tarefas para exportar.');
      return;
    }
    const cols = [
      'id','titulo','responsavel','apoio','estado','prioridade','tipoTarefa',
      'dataCriacao','dataLimite','horaLimite','tags','origemTipo','origemRef','descricao','createdAtMs'
    ];
    function esc(v){
      if(v==null) return '';
      const s = String(v).replace(/"/g,'""');
      return '"' + s + '"';
    }
    let csv = cols.map(esc).join(';') + '\n';
    state.tasks.forEach(t=>{
      const row = cols.map(c=>esc(t[c]));
      csv += row.join(';') + '\n';
    });
    const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href=url;
    a.download='tarefas_garvetur_porto_pro.csv';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  // Eventos
  toggleLockBtn.addEventListener('click',()=>{
    state.locked = !state.locked;
    saveTasksState(state);
    updateLockUI();
  });

  newTaskBtn.addEventListener('click',()=>{
    if(state.locked){
      alert('Modo de edi√ß√£o bloqueado. Desbloqueie o cadeado para criar tarefas.');
      return;
    }
    openModal(null);
  });

  closeModalBtn.addEventListener('click', closeModal);
  cancelModalBtn.addEventListener('click', closeModal);

  saveTaskBtn.addEventListener('click',(e)=>{
    e.preventDefault();
    if(state.locked){
      alert('Modo de edi√ß√£o bloqueado. Desbloqueie o cadeado para guardar altera√ß√µes.');
      return;
    }
    const task = collectForm();
    if(!task.titulo){
      alert('Indique um t√≠tulo para a tarefa.');
      return;
    }
    if(!task.responsavel){
      alert('Indique o respons√°vel pela tarefa.');
      return;
    }
    const idx = state.tasks.findIndex(t=>t.id===task.id);
    if(idx>=0){
      state.tasks[idx] = task;
    }else{
      state.tasks.push(task);
    }
    saveTasksState(state);
    closeModal();
    renderTasks();
  });

  // Filtros
  applyFiltersBtn.addEventListener('click',()=>{
    FILTER.q = f_q.value.trim();
    FILTER.responsavel = f_responsavel.value;
    FILTER.estado = f_estado.value;
    FILTER.prioridade = f_prioridade.value;
    FILTER.de = f_de.value;
    FILTER.ate = f_ate.value;
    FILTER.origem = f_origem.value;
    renderTasks();
  });
  clearFiltersBtn.addEventListener('click',()=>{
    FILTER = {q:'',responsavel:'',estado:'',prioridade:'',de:'',ate:'',origem:''};
    f_q.value='';
    f_responsavel.value='';
    f_estado.value='';
    f_prioridade.value='';
    f_de.value='';
    f_ate.value='';
    f_origem.value='';
    renderTasks();
  });

  let qTimer=null;
  f_q.addEventListener('input',()=>{
    clearTimeout(qTimer);
    qTimer=setTimeout(()=>{
      FILTER.q = f_q.value.trim();
      renderTasks();
    },200);
  });

  exportCsvBtn.addEventListener('click', exportCsv);

  window.addEventListener('keydown',e=>{
    if(e.key==='Escape' && taskModalBackdrop.classList.contains('show')){
      closeModal();
    }
  });

  // Boot
  updateLockUI();
  renderTasks();
})();
</script>
</body>
</html>
