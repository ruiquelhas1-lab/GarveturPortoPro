<!doctype html>
<html lang="pt-PT">
<head>
  <meta charset="utf-8" />
  <title>Garvetur Porto Pro ‚Äî Tarefas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --gold:#A38B63;
      --gold-soft:rgba(163,139,99,.35);
      --bg:#0B0B0B;
      --panel:#141414;
      --panel-soft:#181818;
      --border:rgba(255,255,255,.14);
      --text:#FFFFFF;
      --muted:#A0A0A0;
      --danger:#F25F5C;
      --success:#4CAF50;
      --warning:#FFC857;
      --radius-lg:18px;
      --radius-md:14px;
      --shadow-soft:0 18px 35px rgba(0,0,0,.6);
    }
    *{box-sizing:border-box;}
    html,body{
      margin:0;
      height:100%;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      background:radial-gradient(circle at top,#1c1c1c 0,#050505 55%,#000 100%);
      color:var(--text);
    }
    body{display:flex;flex-direction:column;}
    .app-shell{display:grid;grid-template-rows:64px auto;height:100%;}

    header.app-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 18px;
      border-bottom:1px solid rgba(163,139,99,.35);
      background:linear-gradient(90deg,#050505,#111,#050505);
      gap:16px;
      flex-wrap:wrap;
      position:sticky;
      top:0;
      z-index:20;
    }
    .brand{display:flex;align-items:center;gap:10px;}
    .brand-icon{
      width:26px;height:26px;border-radius:999px;
      border:1px solid var(--gold);
      display:flex;align-items:center;justify-content:center;
      box-shadow:0 0 0 1px rgba(163,139,99,.3);
    }
    .brand h1{
      margin:0;font-size:17px;letter-spacing:.04em;
      text-transform:uppercase;color:var(--gold);
    }
    .brand span.sub{
      display:block;font-size:11px;color:var(--muted);
      letter-spacing:.12em;text-transform:uppercase;
    }
    .nav-tabs{
      display:flex;flex-wrap:wrap;align-items:center;gap:4px;
      background:rgba(0,0,0,.35);padding:4px;
      border-radius:999px;border:1px solid rgba(163,139,99,.35);
    }
    .nav-tab{
      padding:5px 10px;border-radius:999px;font-size:11px;
      text-decoration:none;color:var(--muted);
      letter-spacing:.12em;text-transform:uppercase;
      border:1px solid transparent;
      transition:.16s background,.16s color,.16s border-color,.16s transform;
    }
    .nav-tab:hover{
      color:#fff;border-color:rgba(163,139,99,.6);
      transform:translateY(-1px);
    }
    .nav-tab.active{
      background:var(--gold);color:#0A0A0A;
      border-color:var(--gold);font-weight:600;
    }
    .header-actions{
      display:flex;align-items:center;gap:8px;flex-wrap:wrap;
    }
    .btn{
      border-radius:999px;border:1px solid var(--gold-soft);
      background:rgba(12,12,12,.9);color:var(--text);
      padding:7px 12px;font-size:13px;display:inline-flex;
      align-items:center;gap:6px;cursor:pointer;
      transition:.18s border-color,.18s background,.18s transform;
    }
    .btn-primary{
      background:var(--gold);
      color:#0A0A0A;
      border-color:var(--gold);
      font-weight:500;
    }
    .btn-ghost{
      background:transparent;
    }
    .btn-icon{
      width:32px;
      height:32px;
      padding:0;
      border-radius:999px;
      justify-content:center;
    }
    .btn:hover{border-color:var(--gold);transform:translateY(-1px);}
    .btn:disabled{
      opacity:.45;
      cursor:not-allowed;
      transform:none;
    }

    .pill-lock{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:12px;
      padding:4px 9px;
      border-radius:999px;
      background:rgba(0,0,0,.45);
      border:1px solid rgba(255,255,255,.14);
      color:var(--muted);
    }
    .pill-lock span.state{
      font-weight:500;
      color:var(--gold);
    }
    .pill-lock button{
      all:unset;
      cursor:pointer;
      padding:2px 6px;
      border-radius:999px;
      background:rgba(255,255,255,.05);
    }

    .layout{
      display:grid;
      grid-template-columns:320px minmax(0,1fr);
      height:calc(100vh - 64px);
      max-height:calc(100vh - 64px);
      overflow:hidden;
    }
    @media (max-width: 960px){
      .layout{
        grid-template-columns:1fr;
        grid-template-rows:auto auto;
        height:auto;
        max-height:none;
      }
      .sidebar{
        max-height:none;
      }
    }

    .sidebar{
      border-right:1px solid rgba(163,139,99,.24);
      background:radial-gradient(circle at top left,#141414,#060606);
      padding:12px 14px;
      overflow-y:auto;
    }
    .sidebar-section{
      border-radius:var(--radius-md);
      padding:10px 11px;
      background:rgba(0,0,0,.45);
      border:1px solid rgba(163,139,99,.18);
      margin-bottom:10px;
    }
    .sidebar-section h3{
      margin:0 0 6px;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.16em;
      color:var(--muted);
    }
    .sidebar-section p{
      margin:2px 0 6px;
      font-size:12px;
      color:var(--muted);
    }

    .field{
      display:flex;
      flex-direction:column;
      gap:4px;
      margin-bottom:8px;
    }
    .field-row{
      display:flex;
      gap:6px;
    }
    label.field-label{
      font-size:11px;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.12em;
    }
    input[type="text"],
    input[type="number"],
    input[type="date"],
    input[type="time"],
    input[type="email"],
    select,
    textarea{
      background:rgba(0,0,0,.7);
      color:var(--text);
      border-radius:10px;
      border:1px solid rgba(163,139,99,.22);
      padding:6px 8px;
      font-size:13px;
      outline:none;
      width:100%;
    }
    input:focus, select:focus, textarea:focus{
      border-color:var(--gold);
      box-shadow:0 0 0 1px rgba(163,139,99,.35);
    }
    textarea{
      resize:vertical;
      min-height:60px;
    }

    .filters-badges{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:4px;
    }
    .badge{
      font-size:11px;
      border-radius:999px;
      padding:3px 7px;
      border:1px solid rgba(163,139,99,.35);
      background:rgba(8,8,8,.8);
      color:var(--muted);
    }
    .badge strong{color:var(--gold);}

    .toggle-line{
      display:flex;
      align-items:center;
      justify-content:space-between;
      font-size:12px;
      margin-top:4px;
    }
    .toggle-line span{
      color:var(--muted);
    }

    .cards-area{
      padding:14px 16px 18px;
      overflow-y:auto;
      background:radial-gradient(circle at top,#1a1a1a,#050505 55%,#000 100%);
    }

    .cards-header{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      margin-bottom:8px;
      gap:10px;
    }
    .cards-header-left h2{
      margin:0;
      font-size:15px;
      letter-spacing:.16em;
      text-transform:uppercase;
      color:var(--muted);
    }
    .cards-header-left p{
      margin:2px 0 0;
      font-size:12px;
      color:var(--muted);
    }
    .pipeline-kpis{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:4px;
    }
    .kpi-chip{
      border-radius:999px;
      padding:4px 9px;
      border:1px solid rgba(163,139,99,.32);
      font-size:11px;
      color:var(--muted);
      background:rgba(8,8,8,.9);
    }
    .kpi-chip span.value{
      color:var(--gold);
      font-weight:600;
      margin-left:4px;
    }

    .origin-banner{
      margin-bottom:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--gold-soft);
      background:rgba(163,139,99,.12);
      font-size:12px;
      color:var(--muted);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      flex-wrap:wrap;
    }
    .origin-banner strong{
      color:var(--gold);
    }
    .origin-banner button{
      border-radius:999px;
      border:1px solid rgba(163,139,99,.4);
      background:rgba(0,0,0,.6);
      color:var(--muted);
      padding:3px 8px;
      font-size:11px;
      cursor:pointer;
    }
    .origin-banner button:hover{
      border-color:var(--gold);
      color:#fff;
    }

    .cards-grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(320px,1fr));
      gap:10px;
    }

    .card{
      border-radius:var(--radius-lg);
      border:1px solid rgba(163,139,99,.3);
      padding:10px 11px 9px;
      background:radial-gradient(circle at top left,#181818,#070707);
      box-shadow:var(--shadow-soft);
      display:flex;
      flex-direction:column;
      gap:6px;
      position:relative;
    }
    .card.completed{
      opacity:.6;
      border-style:dashed;
    }

    .card-top-row{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:8px;
    }
    .card-title-block{
      flex:1;
      min-width:0;
    }
    .card-title{
      margin:0;
      font-size:14px;
      font-weight:600;
      color:#fff;
      text-overflow:ellipsis;
      white-space:nowrap;
      overflow:hidden;
    }
    .card-subtitle{
      margin:1px 0 0;
      font-size:11px;
      color:var(--muted);
      text-overflow:ellipsis;
      white-space:nowrap;
      overflow:hidden;
    }

    .chip-row{
      display:flex;
      flex-wrap:wrap;
      gap:4px;
      margin-top:4px;
    }
    .chip{
      border-radius:999px;
      padding:2px 7px;
      font-size:10px;
      border:1px solid rgba(163,139,99,.4);
      background:#1E1E1E;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.08em;
    }
    .chip-primary{
      border-color:var(--gold);
      color:var(--gold);
    }
    .chip-green{
      border-color:rgba(76,175,80,.7);
      color:#A5D6A7;
    }
    .chip-red{
      border-color:rgba(242,95,92,.8);
      color:#FFABAB;
    }
    .chip-yellow{
      border-color:rgba(255,200,87,.8);
      color:#FFE082;
    }

    .card-section{
      border-top:1px solid rgba(163,139,99,.18);
      padding-top:4px;
      margin-top:2px;
      font-size:12px;
      color:var(--muted);
    }
    .card-section strong{
      color:#f5f5f5;
      font-weight:500;
    }

    .card-footer{
      margin-top:6px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:6px;
      font-size:11px;
      color:var(--muted);
    }
    .card-footer-left{
      display:flex;
      flex-wrap:wrap;
      gap:4px;
      align-items:center;
    }
    .card-footer-right{
      display:flex;
      flex-wrap:wrap;
      gap:4px;
      justify-content:flex-end;
    }

    .btn-xs{
      border-radius:999px;
      padding:3px 7px;
      border:1px solid rgba(163,139,99,.35);
      background:rgba(5,5,5,.9);
      color:var(--muted);
      font-size:10px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:4px;
    }
    .btn-xs.primary{
      border-color:var(--gold);
      color:var(--gold);
    }
    .btn-xs.danger{
      border-color:var(--danger);
      color:#FFB3B0;
    }

    .empty{
      font-size:12px;
      color:var(--muted);
      padding:16px 4px;
    }

    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.7);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:40;
    }
    .modal-backdrop.open{
      display:flex;
    }
    .modal{
      width:min(900px,96vw);
      max-height:90vh;
      background:radial-gradient(circle at top,#151515,#050505);
      border-radius:22px;
      border:1px solid rgba(163,139,99,.5);
      box-shadow:0 24px 45px rgba(0,0,0,.8);
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }
    .modal-header{
      padding:10px 16px 8px;
      border-bottom:1px solid rgba(163,139,99,.25);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background:linear-gradient(90deg,#050505,#111,#050505);
    }
    .modal-header h2{
      margin:0;
      font-size:15px;
      letter-spacing:.12em;
      text-transform:uppercase;
      color:var(--gold);
    }
    .modal-body{
      padding:10px 14px 12px;
      overflow-y:auto;
    }
    .form-grid{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:10px;
    }
    @media (max-width: 900px){
      .form-grid{
        grid-template-columns:1fr;
      }
    }
    .form-section{
      border-radius:var(--radius-md);
      border:1px solid rgba(163,139,99,.22);
      background:rgba(0,0,0,.55);
      padding:8px 9px;
    }
    .form-section h3{
      margin:0 0 6px;
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.14em;
      color:var(--muted);
    }
    .form-section small{
      font-size:11px;
      color:var(--muted);
    }

    .modal-footer{
      padding:8px 14px 10px;
      border-top:1px solid rgba(163,139,99,.25);
      display:flex;
      justify-content:space-between;
      gap:8px;
      background:#050505;
    }
    .modal-footer-left{
      font-size:11px;
      color:var(--muted);
    }

    .switch{
      position:relative;
      display:inline-block;
      width:34px;
      height:18px;
    }
    .switch input{
      opacity:0;
      width:0;
      height:0;
    }
    .slider{
      position:absolute;
      cursor:pointer;
      inset:0;
      background-color:#444;
      transition:.2s;
      border-radius:34px;
    }
    .slider:before{
      position:absolute;
      content:"";
      height:14px;
      width:14px;
      left:3px;
      bottom:2px;
      background-color:white;
      transition:.2s;
      border-radius:50%;
    }
    .switch input:checked + .slider{
      background-color:var(--gold);
    }
    .switch input:checked + .slider:before{
      transform:translateX(14px);
    }

    /* Modal Ficha Original ‚Äì ajustes suaves */
    .ficha-grid{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:10px;
    }
    @media (max-width: 900px){
      .ficha-grid{
        grid-template-columns:1fr;
      }
    }
    .ficha-section-title{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.14em;
      color:var(--muted);
      margin-bottom:4px;
    }
    .ficha-extra-block{
      margin-top:8px;
      border-radius:var(--radius-md);
      border:1px solid rgba(163,139,99,.22);
      background:rgba(0,0,0,.6);
      padding:8px 9px;
      font-size:12px;
      color:var(--muted);
    }
    .ficha-extra-block summary{
      cursor:pointer;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.14em;
      color:var(--gold);
      margin-bottom:4px;
    }
    .ficha-extra-block ul{
      padding-left:18px;
      margin:6px 0 0;
      font-size:12px;
    }
    .ficha-pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:11px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid rgba(163,139,99,.35);
      background:rgba(0,0,0,.6);
      color:var(--muted);
    }
  </style>
</head>
<body>
<div class="app-shell">
  <header class="app-header">
    <div class="brand">
      <div class="brand-icon">
        <svg width="16" height="16" viewBox="0 0 24 24" stroke="var(--gold)" fill="none" stroke-width="1.8">
          <circle cx="12" cy="12" r="9"></circle>
          <path d="M8 12.5l2.5 2.5L16 9"></path>
        </svg>
      </div>
      <div>
        <h1>Garvetur Porto Pro ‚Äî Tarefas</h1>
        <span class="sub">Follow-up, compromissos e rotina comercial</span>
      </div>
    </div>

    <nav class="nav-tabs">
      <a href="index.html" class="nav-tab">In√≠cio</a>
      <a href="mapa.html" class="nav-tab">Mapa</a>
      <a href="kanban.html" class="nav-tab">Leads</a>
      <a href="angariacoes.html" class="nav-tab">Angaria√ß√µes</a>
      <a href="dashboard.html" class="nav-tab">Dashboard</a>
      <a href="vendas.html" class="nav-tab">Vendas</a>
      <a href="tarefas.html" class="nav-tab active">Tarefas</a>
    </nav>

    <div class="header-actions">
      <div class="pill-lock" id="lockPill">
        <span>Modo</span>
        <span class="state" id="lockStateLabel">Bloqueado</span>
        <button id="toggleLockBtn" title="Alternar entre edi√ß√£o bloqueada e ativa">
          üîí
        </button>
      </div>
      <button class="btn btn-ghost" id="exportCsvBtn" title="Exportar tarefas para CSV">‚§ì CSV</button>
      <button class="btn btn-ghost" id="exportPdfBtn" title="Imprimir / PDF (lista atual)">‚§ì PDF</button>
      <button class="btn btn-primary" id="newTaskBtn">+ Nova Tarefa</button>
    </div>
  </header>

  <div class="layout">
    <aside class="sidebar">
      <div class="sidebar-section">
        <h3>Filtros</h3>
        <div class="field">
          <label class="field-label" for="filterResponsavel">Respons√°vel</label>
          <select id="filterResponsavel">
            <option value="">Todos</option>
          </select>
        </div>
        <div class="field-row">
          <div class="field">
            <label class="field-label" for="filterEstado">Estado</label>
            <select id="filterEstado">
              <option value="">Todos</option>
              <option value="por_fazer">Por fazer</option>
              <option value="em_curso">Em curso</option>
              <option value="concluida">Conclu√≠da</option>
              <option value="adiada">Adiada</option>
              <option value="cancelada">Cancelada</option>
            </select>
          </div>
          <div class="field">
            <label class="field-label" for="filterPrioridade">Prioridade</label>
            <select id="filterPrioridade">
              <option value="">Todas</option>
              <option value="baixa">Baixa</option>
              <option value="normal">Normal</option>
              <option value="alta">Alta</option>
              <option value="critica">Cr√≠tica</option>
            </select>
          </div>
        </div>
        <div class="field-row">
          <div class="field">
            <label class="field-label" for="filterDataDe">De (data limite)</label>
            <input type="date" id="filterDataDe" />
          </div>
          <div class="field">
            <label class="field-label" for="filterDataAte">At√© (data limite)</label>
            <input type="date" id="filterDataAte" />
          </div>
        </div>
        <div class="toggle-line">
          <span>Mostrar conclu√≠das</span>
          <label class="switch">
            <input type="checkbox" id="filterShowCompleted">
            <span class="slider"></span>
          </label>
        </div>
        <button class="btn" id="applyFiltersBtn" style="margin-top:6px;width:100%;">Aplicar filtros</button>
        <button class="btn" id="clearFiltersBtn" style="margin-top:4px;width:100%;background:transparent;border-color:rgba(255,255,255,.2);">Limpar</button>
        <p style="margin-top:6px;">Use os filtros para organizar o dia, reuni√µes de pipeline e follow-up por consultor.</p>
      </div>

      <div class="sidebar-section">
        <h3>Resumo r√°pido</h3>
        <div class="filters-badges" id="summaryBadges"></div>
      </div>

      <div class="sidebar-section">
        <h3>Notas</h3>
        <p>Quando o cadeado est√° em <strong>Bloqueado</strong>, n√£o h√° risco de alterar tarefas por engano.</p>
        <p>Quando est√° <strong>Edi√ß√£o ativa</strong>, pode criar, editar, concluir e apagar tarefas.</p>
      </div>
    </aside>

    <main class="cards-area">
      <div class="cards-header">
        <div class="cards-header-left">
          <h2>Tarefas</h2>
          <p>Vis√£o das a√ß√µes comerciais: chamadas, visitas, follow-ups e compromissos ligados ao neg√≥cio.</p>
          <div class="pipeline-kpis" id="pipelineKpis"></div>
        </div>
      </div>

      <div id="originFilterBanner" class="origin-banner" style="display:none;">
        <div>
          üîó <strong id="originFilterLabel"></strong>
        </div>
        <button type="button" id="clearOriginFilterBtn">Limpar filtro de origem</button>
      </div>

      <div id="cardsGrid" class="cards-grid"></div>
      <div id="emptyState" class="empty" style="display:none;">
        Ainda n√£o existem tarefas registadas com os filtros atuais.
      </div>
    </main>
  </div>
</div>

<!-- MODAL TAREFA -->
<div class="modal-backdrop" id="modalBackdrop">
  <div class="modal">
    <div class="modal-header">
      <h2 id="modalTitle">Nova Tarefa</h2>
      <button class="btn btn-icon btn-ghost" id="closeModalBtn" title="Fechar">‚úï</button>
    </div>
    <div class="modal-body">
      <form id="taskForm">
        <input type="hidden" id="taskId" />
        <div class="form-grid">
          <div class="form-section">
            <h3>Envolvidos & Origem</h3>
            <div class="field-row">
              <div class="field">
                <label class="field-label" for="responsavel">Respons√°vel</label>
                <select id="responsavel"></select>
              </div>
              <div class="field">
                <label class="field-label" for="apoio">Apoio / Gestor</label>
                <select id="apoio"></select>
              </div>
            </div>

            <div class="field-row">
              <div class="field">
                <label class="field-label" for="origemTipo">Origem</label>
                <select id="origemTipo">
                  <option value="">‚Äî</option>
                  <option value="lead">Lead</option>
                  <option value="angariacao">Angaria√ß√£o</option>
                  <option value="venda">Venda</option>
                  <option value="interna">Interna</option>
                </select>
              </div>
              <div class="field">
                <label class="field-label" for="origemRef">Ref. associada</label>
                <input type="text" id="origemRef" placeholder="Ex.: Ref. Interna da lead, nome cliente..." />
              </div>
            </div>

            <div class="field-row">
              <div class="field">
                <label class="field-label" for="estado">Estado</label>
                <select id="estado">
                  <option value="por_fazer">Por fazer</option>
                  <option value="em_curso">Em curso</option>
                  <option value="concluida">Conclu√≠da</option>
                  <option value="adiada">Adiada</option>
                  <option value="cancelada">Cancelada</option>
                </select>
              </div>
              <div class="field">
                <label class="field-label" for="prioridade">Prioridade</label>
                <select id="prioridade">
                  <option value="baixa">Baixa</option>
                  <option value="normal" selected>Normal</option>
                  <option value="alta">Alta</option>
                  <option value="critica">Cr√≠tica</option>
                </select>
              </div>
            </div>

            <div class="field">
              <label class="field-label" for="tipoTarefa">Tipo de tarefa</label>
              <select id="tipoTarefa">
                <option value="chamada">Chamada telef√≥nica</option>
                <option value="email">Email</option>
                <option value="visita">Visita</option>
                <option value="reuniao">Reuni√£o</option>
                <option value="followup">Follow-up</option>
                <option value="outro">Outro</option>
              </select>
            </div>

            <div class="field">
              <label class="field-label" for="tags">Tags / etiquetas</label>
              <input type="text" id="tags" placeholder="Ex.: empreendimento X, frio, urgente" />
            </div>
          </div>

          <div class="form-section">
            <h3>Detalhes & Datas</h3>

            <div class="field">
              <label class="field-label" for="titulo">T√≠tulo</label>
              <input type="text" id="titulo" placeholder="Ex.: Agendar visita com propriet√°rios" />
            </div>

            <div class="field">
              <label class="field-label" for="descricao">Descri√ß√£o</label>
              <textarea id="descricao" placeholder="Notas r√°pidas sobre o objetivo da tarefa, contexto, acordo com o cliente..."></textarea>
            </div>

            <div class="field-row">
              <div class="field">
                <label class="field-label" for="dataCriacao">Data cria√ß√£o</label>
                <input type="date" id="dataCriacao" />
              </div>
              <div class="field">
                <label class="field-label" for="dataLimite">Data limite</label>
                <input type="date" id="dataLimite" />
              </div>
            </div>

            <div class="field-row">
              <div class="field">
                <label class="field-label" for="horaLimite">Hora</label>
                <input type="time" id="horaLimite" />
              </div>
              <div class="field">
                <label class="field-label">&nbsp;</label>
                <small>Use a data limite e hora para organizar visitas, chamadas e follow-ups do dia.</small>
              </div>
            </div>
          </div>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <div class="modal-footer-left">
        Dados guardados apenas neste navegador (localStorage). Use exporta√ß√µes para backup/partilha.
      </div>
      <div>
        <button class="btn btn-ghost" id="cancelModalBtn">Cancelar</button>
        <button class="btn btn-primary" id="saveTaskBtn">Guardar</button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL FICHA ORIGINAL (Lead) -->
<div class="modal-backdrop" id="fichaModalBackdrop">
  <div class="modal">
    <div class="modal-header">
      <h2 id="fichaModalTitle">Ficha Original</h2>
      <button class="btn btn-icon btn-ghost" id="closeFichaModalBtn" title="Fechar">‚úï</button>
    </div>
    <div class="modal-body">
      <form id="fichaForm">
        <input type="hidden" id="fichaOrigemTipo" />
        <input type="hidden" id="fichaLeadId" />
        <div class="ficha-grid">
          <div class="form-section">
            <div class="ficha-section-title">Identifica√ß√£o</div>
            <div class="field">
              <label class="field-label" for="fichaNome">Nome cliente</label>
              <input type="text" id="fichaNome" />
            </div>
            <div class="field-row">
              <div class="field">
                <label class="field-label" for="fichaConsultor">Consultor</label>
                <input type="text" id="fichaConsultor" />
              </div>
              <div class="field">
                <label class="field-label" for="fichaEstado">Estado</label>
                <select id="fichaEstado">
                  <option value="Novo">Novo</option>
                  <option value="Em Contacto">Em Contacto</option>
                  <option value="Qualificado">Qualificado</option>
                  <option value="Visita">Visita</option>
                  <option value="Proposta">Proposta</option>
                  <option value="Fecho">Fecho</option>
                  <option value="Perdido">Perdido</option>
                </select>
              </div>
            </div>
            <div class="field-row">
              <div class="field">
                <label class="field-label" for="fichaContacto">Contacto</label>
                <input type="text" id="fichaContacto" />
              </div>
              <div class="field">
                <label class="field-label" for="fichaEmail">Email</label>
                <input type="email" id="fichaEmail" />
              </div>
            </div>
            <div class="field">
              <label class="field-label" for="fichaRefInterna">Ref. Interna</label>
              <input type="text" id="fichaRefInterna" />
            </div>
            <div class="field-row">
              <div class="field">
                <label class="field-label" for="fichaData">Data</label>
                <input type="date" id="fichaData" />
              </div>
              <div class="field">
                <label class="field-label" for="fichaUrl">URL anexo</label>
                <input type="text" id="fichaUrl" placeholder="https://‚Ä¶" />
              </div>
            </div>
          </div>

          <div class="form-section">
            <div class="ficha-section-title">Neg√≥cio & Perfil</div>
            <div class="field-row">
              <div class="field">
                <label class="field-label" for="fichaTipoNegocio">Tipo de neg√≥cio</label>
                <input type="text" id="fichaTipoNegocio" placeholder="Compra, venda, arrendamento‚Ä¶" />
              </div>
              <div class="field">
                <label class="field-label" for="fichaImovel">Im√≥vel / Tipologia</label>
                <input type="text" id="fichaImovel" placeholder="Apartamento T2, Moradia T4‚Ä¶" />
              </div>
            </div>
            <div class="field-row">
              <div class="field">
                <label class="field-label" for="fichaZona">Zona preferencial</label>
                <input type="text" id="fichaZona" />
              </div>
              <div class="field">
                <label class="field-label" for="fichaValor">Valor alvo (‚Ç¨)</label>
                <input type="number" id="fichaValor" min="0" step="1000" />
              </div>
            </div>
            <div class="field-row">
              <div class="field">
                <label class="field-label" for="fichaPapel">Comprador / Vendedor</label>
                <input type="text" id="fichaPapel" />
              </div>
              <div class="field">
                <label class="field-label" for="fichaPerfil">Investidor / Cliente final</label>
                <input type="text" id="fichaPerfil" />
              </div>
            </div>
            <div class="field">
              <label class="field-label" for="fichaNotas">Notas</label>
              <textarea id="fichaNotas" rows="3"></textarea>
            </div>
          </div>
        </div>
      </form>

      <div class="ficha-extra-block">
        <details>
          <summary>Hist√≥rico de tarefas associadas</summary>
          <ul id="fichaTarefasLista"></ul>
        </details>
      </div>

      <div class="ficha-extra-block">
        <details>
          <summary>Notas internas & contexto</summary>
          <p style="margin-top:4px;">
            Use este espa√ßo na ficha original (campo Notas) para consolidar informa√ß√£o relevante de todas as intera√ß√µes:
            visitas realizadas, propostas feitas, feedback do cliente, obje√ß√µes e pr√≥ximos passos.
          </p>
        </details>
      </div>

      <div class="ficha-extra-block">
        <details>
          <summary>Alerta inteligente</summary>
          <p id="fichaAlertaTexto" style="margin-top:4px;"></p>
        </details>
      </div>
    </div>
    <div class="modal-footer">
      <div class="modal-footer-left" id="fichaMeta">
        Ficha ligada ao m√≥dulo original (Leads). Altera√ß√µes gravam diretamente na lead.
      </div>
      <div>
        <button class="btn btn-ghost" id="cancelFichaModalBtn">Cancelar</button>
        <button class="btn btn-primary" id="saveFichaModalBtn">Guardar altera√ß√µes</button>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  const STORAGE_KEY = 'gpp_tarefas_v1';
  const FILTERS_STORAGE_KEY = 'gpp_tarefas_filters_v1';
  const GLOBAL_FILTERS_KEY = 'gpp_global_filters_v1';

  // Leads (kanban) ‚Äì chave real
  const LEADS_LS_KEY = 'gpp_leads_v5';

  const CONSULTOR_OPTIONS = [
    "Rui Quelhas",
    "Manuel Oliveira",
    "Jo√£o Sousa",
    "Francisco dos Santos",
    "Ros√°rio Vasconcelos",
    "Armanda Meireles",
    "Audrey Lucas",
    "Outro"
  ];

  function $(id){ return document.getElementById(id); }

  const lockStateLabel = $('lockStateLabel');
  const toggleLockBtn = $('toggleLockBtn');
  const newTaskBtn = $('newTaskBtn');
  const exportCsvBtn = $('exportCsvBtn');
  const exportPdfBtn = $('exportPdfBtn');
  const cardsGrid = $('cardsGrid');
  const emptyState = $('emptyState');
  const pipelineKpis = $('pipelineKpis');
  const summaryBadges = $('summaryBadges');

  const filterResponsavel = $('filterResponsavel');
  const filterEstado = $('filterEstado');
  const filterPrioridade = $('filterPrioridade');
  const filterDataDe = $('filterDataDe');
  const filterDataAte = $('filterDataAte');
  const filterShowCompleted = $('filterShowCompleted');
  const applyFiltersBtn = $('applyFiltersBtn');
  const clearFiltersBtn = $('clearFiltersBtn');

  const originFilterBanner = $('originFilterBanner');
  const originFilterLabel = $('originFilterLabel');
  const clearOriginFilterBtn = $('clearOriginFilterBtn');

  const modalBackdrop = $('modalBackdrop');
  const modalTitle = $('modalTitle');
  const closeModalBtn = $('closeModalBtn');
  const cancelModalBtn = $('cancelModalBtn');
  const saveTaskBtn = $('saveTaskBtn');
  const taskForm = $('taskForm');

  const responsavelSelect = $('responsavel');
  const apoioSelect = $('apoio');

  // Modal Ficha Original
  const fichaModalBackdrop = $('fichaModalBackdrop');
  const fichaModalTitle = $('fichaModalTitle');
  const closeFichaModalBtn = $('closeFichaModalBtn');
  const cancelFichaModalBtn = $('cancelFichaModalBtn');
  const saveFichaModalBtn = $('saveFichaModalBtn');

  const fichaOrigemTipo = $('fichaOrigemTipo');
  const fichaLeadId = $('fichaLeadId');
  const fichaNome = $('fichaNome');
  const fichaConsultor = $('fichaConsultor');
  const fichaEstado = $('fichaEstado');
  const fichaContacto = $('fichaContacto');
  const fichaEmail = $('fichaEmail');
  const fichaRefInterna = $('fichaRefInterna');
  const fichaData = $('fichaData');
  const fichaUrl = $('fichaUrl');
  const fichaTipoNegocio = $('fichaTipoNegocio');
  const fichaImovel = $('fichaImovel');
  const fichaZona = $('fichaZona');
  const fichaValor = $('fichaValor');
  const fichaPapel = $('fichaPapel');
  const fichaPerfil = $('fichaPerfil');
  const fichaNotas = $('fichaNotas');
  const fichaTarefasLista = $('fichaTarefasLista');
  const fichaAlertaTexto = $('fichaAlertaTexto');
  const fichaMeta = $('fichaMeta');

  let state = {
    locked:true,
    tasks:[]
  };

  let FILTERS = {
    responsavel:'',
    estado:'',
    prioridade:'',
    de:'',
    ate:'',
    showCompleted:false,
    origemTipo:'',
    origemRef:''
  };

  let currentFicha = null; // { tipo:'lead', leadIndex:0, leadId:'...' }

  function todayISO(){
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    return y + '-' + m + '-' + day;
  }

  function loadState(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(raw){
        const parsed = JSON.parse(raw);
        if(Array.isArray(parsed.tasks)){
          state.tasks = parsed.tasks;
        }
        state.locked = parsed.locked !== false;
      }
    }catch(e){
      console.error('Erro ao carregar storage tarefas', e);
    }
    updateLockUI();
  }

  function saveState(){
    try{
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }catch(e){
      console.error('Erro ao guardar storage tarefas', e);
    }
  }

  function loadFiltersFromStorage(){
    try{
      const raw = localStorage.getItem(FILTERS_STORAGE_KEY);
      if(!raw) return;
      const parsed = JSON.parse(raw);
      if(parsed && typeof parsed === 'object'){
        FILTERS = Object.assign({}, FILTERS, parsed);
      }
    }catch(e){
      console.error('Erro a carregar filtros de tarefas', e);
    }
  }

  function loadGlobalFiltersFallback(){
    if(FILTERS.responsavel || FILTERS.de || FILTERS.ate) return;
    try{
      const raw = localStorage.getItem(GLOBAL_FILTERS_KEY);
      if(!raw) return;
      const g = JSON.parse(raw) || {};
      if(!FILTERS.responsavel && g.consultor) FILTERS.responsavel = g.consultor;
      if(!FILTERS.de && g.de) FILTERS.de = g.de;
      if(!FILTERS.ate && g.ate) FILTERS.ate = g.ate;
    }catch(e){
      console.error('Erro a carregar filtros globais', e);
    }
  }

  function applyUrlContext(){
    try{
      const params = new URLSearchParams(window.location.search);
      const origem = (params.get('origem') || '').trim();
      const ref    = (params.get('ref') || '').trim();
      const consultor = (params.get('consultor') || '').trim();
      const nova   = (params.get('nova') || '').trim();

      if(consultor && !FILTERS.responsavel){
        FILTERS.responsavel = consultor;
      }

      if(origem || ref){
        FILTERS.origemTipo = origem || '';
        FILTERS.origemRef  = ref || '';
      }

      if(nova === '1'){
        if(state.locked){
          setTimeout(()=>{
            alert('Para criar uma nova tarefa associada, ative "Edi√ß√£o ativa" (cadeado no topo).');
          }, 300);
        }else{
          openModal(null);
          if(origem){
            $('origemTipo').value = origem;
          }
          if(ref){
            $('origemRef').value = ref;
          }
          if(consultor){
            responsavelSelect.value = consultor;
          }
        }
      }
    }catch(e){
      console.error('Erro a interpretar par√¢metros da URL em tarefas', e);
    }
  }

  function applyFiltersToControls(){
    filterResponsavel.value = FILTERS.responsavel || '';
    filterEstado.value = FILTERS.estado || '';
    filterPrioridade.value = FILTERS.prioridade || '';
    filterDataDe.value = FILTERS.de || '';
    filterDataAte.value = FILTERS.ate || '';
    filterShowCompleted.checked = !!FILTERS.showCompleted;
  }

  function updateFiltersFromControls(){
    FILTERS.responsavel = filterResponsavel.value || '';
    FILTERS.estado = filterEstado.value || '';
    FILTERS.prioridade = filterPrioridade.value || '';
    FILTERS.de = filterDataDe.value || '';
    FILTERS.ate = filterDataAte.value || '';
    FILTERS.showCompleted = filterShowCompleted.checked;
  }

  function saveFiltersToStorage(){
    try{
      localStorage.setItem(FILTERS_STORAGE_KEY, JSON.stringify(FILTERS));
    }catch(e){
      console.error('Erro a guardar filtros de tarefas', e);
    }
  }

  function syncGlobalFiltersFromTasks(){
    const g = {
      consultor: FILTERS.responsavel || '',
      de: FILTERS.de || '',
      ate: FILTERS.ate || ''
    };
    try{
      localStorage.setItem(GLOBAL_FILTERS_KEY, JSON.stringify(g));
    }catch(e){
      console.error('Erro a guardar filtros globais', e);
    }
  }

  function clearFilters(){
    FILTERS = {
      responsavel:'',
      estado:'',
      prioridade:'',
      de:'',
      ate:'',
      showCompleted:false,
      origemTipo:'',
      origemRef:''
    };
    applyFiltersToControls();
    saveFiltersToStorage();
    syncGlobalFiltersFromTasks();
  }

  function updateLockUI(){
    if(state.locked){
      lockStateLabel.textContent = 'Bloqueado';
      toggleLockBtn.textContent = 'üîí';
      newTaskBtn.disabled = true;
    }else{
      lockStateLabel.textContent = 'Edi√ß√£o ativa';
      toggleLockBtn.textContent = 'üîì';
      newTaskBtn.disabled = false;
    }
  }

  function initConsultores(){
    CONSULTOR_OPTIONS.forEach(name=>{
      const opt1 = document.createElement('option');
      opt1.value = name;
      opt1.textContent = name;
      responsavelSelect.appendChild(opt1);

      const opt2 = document.createElement('option');
      opt2.value = name;
      opt2.textContent = name;
      apoioSelect.appendChild(opt2);

      const opt3 = document.createElement('option');
      opt3.value = name;
      opt3.textContent = name;
      filterResponsavel.appendChild(opt3);
    });
  }

  function openModal(task){
    modalBackdrop.classList.add('open');
    if(task){
      modalTitle.textContent = 'Editar Tarefa';
      $('taskId').value = task.id || '';
      responsavelSelect.value = task.responsavel || '';
      apoioSelect.value = task.apoio || '';
      $('origemTipo').value = task.origemTipo || '';
      $('origemRef').value = task.origemRef || '';
      $('estado').value = task.estado || 'por_fazer';
      $('prioridade').value = task.prioridade || 'normal';
      $('tipoTarefa').value = task.tipoTarefa || 'chamada';
      $('tags').value = task.tags || '';
      $('titulo').value = task.titulo || '';
      $('descricao').value = task.descricao || '';
      $('dataCriacao').value = task.dataCriacao || '';
      $('dataLimite').value = task.dataLimite || '';
      $('horaLimite').value = task.horaLimite || '';
    }else{
      modalTitle.textContent = 'Nova Tarefa';
      taskForm.reset();
      $('taskId').value = '';
      $('dataCriacao').value = todayISO();
    }
  }

  function closeModal(){
    modalBackdrop.classList.remove('open');
  }

  function collectFormData(){
    const id = $('taskId').value || 'task_' + Date.now();

    let dataCriacao = $('dataCriacao').value;
    if(!dataCriacao){
      dataCriacao = todayISO();
    }

    const data = {
      id,
      responsavel: responsavelSelect.value || '',
      apoio: apoioSelect.value || '',
      origemTipo: $('origemTipo').value || '',
      origemRef: $('origemRef').value || '',
      estado: $('estado').value || 'por_fazer',
      prioridade: $('prioridade').value || 'normal',
      tipoTarefa: $('tipoTarefa').value || 'chamada',
      tags: $('tags').value || '',
      titulo: $('titulo').value || '',
      descricao: $('descricao').value || '',
      dataCriacao: dataCriacao,
      dataLimite: $('dataLimite').value || '',
      horaLimite: $('horaLimite').value || '',
      createdAtMs: Date.now()
    };

    return data;
  }

  function applyFilters(tasks){
    const resp = FILTERS.responsavel || '';
    const est = FILTERS.estado || '';
    const prio = FILTERS.prioridade || '';
    const from = FILTERS.de || '';
    const to = FILTERS.ate || '';
    const showCompleted = !!FILTERS.showCompleted;
    const oTipo = FILTERS.origemTipo || '';
    const oRef = FILTERS.origemRef || '';

    return tasks.filter(t=>{
      if(resp && t.responsavel !== resp) return false;
      if(est && t.estado !== est) return false;
      if(prio && t.prioridade !== prio) return false;

      if(!showCompleted && (t.estado === 'concluida' || t.estado === 'cancelada')){
        return false;
      }

      if(from && t.dataLimite && t.dataLimite < from) return false;
      if(to && t.dataLimite && t.dataLimite > to) return false;

      if(oTipo && t.origemTipo !== oTipo) return false;
      if(oRef){
        const tref = (t.origemRef || '').toLowerCase();
        if(!tref.includes(oRef.toLowerCase())) return false;
      }

      return true;
    });
  }

  function estadoLabel(e){
    return {
      por_fazer:'Por fazer',
      em_curso:'Em curso',
      concluida:'Conclu√≠da',
      adiada:'Adiada',
      cancelada:'Cancelada'
    }[e] || '‚Äî';
  }

  function prioridadeLabel(p){
    return {
      baixa:'Baixa',
      normal:'Normal',
      alta:'Alta',
      critica:'Cr√≠tica'
    }[p] || '‚Äî';
  }

  function tipoLabel(t){
    return {
      chamada:'Chamada',
      email:'Email',
      visita:'Visita',
      reuniao:'Reuni√£o',
      followup:'Follow-up',
      outro:'Outro'
    }[t] || '‚Äî';
  }

  function origemLabel(tipo){
    return {
      lead:'Lead',
      angariacao:'Angaria√ß√£o',
      venda:'Venda',
      interna:'Interna'
    }[tipo] || '';
  }

  function prioridadeClass(p){
    if(p === 'critica') return 'chip-red';
    if(p === 'alta') return 'chip-yellow';
    if(p === 'baixa') return 'chip';
    return 'chip-primary';
  }

  function estadoClass(e){
    if(e === 'concluida') return 'chip-green';
    if(e === 'adiada' || e === 'cancelada') return 'chip-red';
    if(e === 'em_curso') return 'chip-yellow';
    return 'chip-primary';
  }

  function renderOriginBanner(){
    if(FILTERS.origemTipo || FILTERS.origemRef){
      const parts = [];
      if(FILTERS.origemTipo){
        parts.push('Origem: ' + origemLabel(FILTERS.origemTipo));
      }
      if(FILTERS.origemRef){
        parts.push('Ref.: ' + FILTERS.origemRef);
      }
      originFilterLabel.textContent = parts.join(' ¬∑ ');
      originFilterBanner.style.display = 'flex';
    }else{
      originFilterBanner.style.display = 'none';
    }
  }

  function renderCards(){
    const tasks = state.tasks.slice().sort((a,b)=>{
      const da = a.dataLimite || '';
      const db = b.dataLimite || '';
      if(da && db){
        return da.localeCompare(db);
      }
      if(da && !db) return -1;
      if(!da && db) return 1;
      return (a.createdAtMs || 0) - (b.createdAtMs || 0);
    });

    const filtered = applyFilters(tasks);
    cardsGrid.innerHTML = '';

    renderOriginBanner();

    if(!filtered.length){
      emptyState.style.display = 'block';
    }else{
      emptyState.style.display = 'none';
    }

    let total = tasks.length;
    let porEstado = {por_fazer:0,em_curso:0,concluida:0,adiada:0,cancelada:0};
    tasks.forEach(t=>{
      if(porEstado[t.estado] !== undefined) porEstado[t.estado]++;
    });

    summaryBadges.innerHTML = '';
    const badge1 = document.createElement('div');
    badge1.className = 'badge';
    badge1.innerHTML = 'Total tarefas <strong>' + total + '</strong>';
    summaryBadges.appendChild(badge1);

    const badge2 = document.createElement('div');
    const abertas = tasks.filter(t=>t.estado!=='concluida' && t.estado!=='cancelada').length;
    badge2.className = 'badge';
    badge2.innerHTML = 'Em aberto <strong>' + abertas + '</strong>';
    summaryBadges.appendChild(badge2);

    const fil = filtered;
    const porRespFiltrado = {};
    fil.forEach(t=>{
      if(!t.responsavel) return;
      porRespFiltrado[t.responsavel] = (porRespFiltrado[t.responsavel]||0)+1;
    });
    Object.keys(porRespFiltrado).sort().forEach(n=>{
      const b = document.createElement('div');
      b.className = 'badge';
      b.innerHTML = '<strong>'+n+':</strong> ' + porRespFiltrado[n];
      summaryBadges.appendChild(b);
    });

    pipelineKpis.innerHTML = '';
    const estadosOrdem = ['por_fazer','em_curso','concluida','adiada','cancelada'];
    estadosOrdem.forEach(k=>{
      const chip = document.createElement('div');
      chip.className = 'kpi-chip';
      chip.innerHTML = estadoLabel(k) + '<span class="value">'+porEstado[k]+'</span>';
      pipelineKpis.appendChild(chip);
    });

    filtered.forEach(t=>{
      const card = document.createElement('div');
      card.className = 'card' + ((t.estado === 'concluida' || t.estado === 'cancelada') ? ' completed':'');
      card.dataset.id = t.id;

      const topRow = document.createElement('div');
      topRow.className = 'card-top-row';

      const titleBlock = document.createElement('div');
      titleBlock.className = 'card-title-block';

      const h3 = document.createElement('h3');
      h3.className = 'card-title';
      h3.textContent = t.titulo || '(Sem t√≠tulo)';
      titleBlock.appendChild(h3);

      const subtitle = document.createElement('div');
      subtitle.className = 'card-subtitle';
      const linhaSub = [
        t.responsavel || '',
        prioridadeLabel(t.prioridade),
        estadoLabel(t.estado)
      ].filter(Boolean).join(' ¬∑ ');
      subtitle.textContent = linhaSub;
      titleBlock.appendChild(subtitle);

      const chipsRow = document.createElement('div');
      chipsRow.className = 'chip-row';

      const chipEst = document.createElement('span');
      chipEst.className = 'chip ' + estadoClass(t.estado);
      chipEst.textContent = estadoLabel(t.estado);
      chipsRow.appendChild(chipEst);

      const chipPrio = document.createElement('span');
      chipPrio.className = 'chip ' + prioridadeClass(t.prioridade);
      chipPrio.textContent = prioridadeLabel(t.prioridade);
      chipsRow.appendChild(chipPrio);

      if(t.tipoTarefa){
        const ch = document.createElement('span');
        ch.className = 'chip';
        ch.textContent = tipoLabel(t.tipoTarefa);
        chipsRow.appendChild(ch);
      }

      if(t.origemTipo){
        const ch = document.createElement('span');
        ch.className = 'chip';
        ch.textContent = origemLabel(t.origemTipo);
        chipsRow.appendChild(ch);
      }

      if(t.tags){
        const ch = document.createElement('span');
        ch.className = 'chip';
        ch.textContent = t.tags;
        chipsRow.appendChild(ch);
      }

      titleBlock.appendChild(chipsRow);
      topRow.appendChild(titleBlock);
      card.appendChild(topRow);

      if(t.origemTipo || t.origemRef){
        const sec = document.createElement('div');
        sec.className = 'card-section';
        const span = document.createElement('span');
        const parts = [];
        if(t.origemTipo) parts.push(origemLabel(t.origemTipo));
        if(t.origemRef) parts.push(t.origemRef);
        span.innerHTML = '<strong>Origem:</strong> ' + parts.join(' ¬∑ ');
        sec.appendChild(span);
        card.appendChild(sec);
      }

      if(t.dataCriacao || t.dataLimite || t.horaLimite){
        const sec = document.createElement('div');
        sec.className = 'card-section';
        const span = document.createElement('span');
        const parts = [];
        if(t.dataCriacao) parts.push('Criada em ' + t.dataCriacao);
        if(t.dataLimite) parts.push('Limite ' + t.dataLimite + (t.horaLimite ? ' ' + t.horaLimite : ''));
        span.innerHTML = parts.join(' ¬∑ ');
        sec.appendChild(span);
        card.appendChild(sec);
      }

      if(t.descricao){
        const sec = document.createElement('div');
        sec.className = 'card-section';
        const span = document.createElement('span');
        let txt = t.descricao;
        if(txt.length > 180){
          txt = txt.slice(0,177) + '‚Ä¶';
        }
        span.textContent = txt;
        sec.appendChild(span);
        card.appendChild(sec);
      }

      const foot = document.createElement('div');
      foot.className = 'card-footer';
      const left = document.createElement('div');
      left.className = 'card-footer-left';

      const partes = [];
      if(t.responsavel) partes.push(t.responsavel);
      if(t.apoio && t.apoio !== t.responsavel) partes.push('Apoio: ' + t.apoio);
      left.textContent = partes.join(' ¬∑ ');
      foot.appendChild(left);

      const right = document.createElement('div');
      right.className = 'card-footer-right';

      const btnDone = document.createElement('button');
      btnDone.className = 'btn-xs primary';
      btnDone.textContent = (t.estado === 'concluida') ? 'Reabrir' : 'Concluir';
      btnDone.addEventListener('click',()=>{
        if(state.locked) return;
        if(t.estado === 'concluida'){
          t.estado = 'por_fazer';
        }else{
          t.estado = 'concluida';
        }
        saveState();
        renderCards();
      });
      right.appendChild(btnDone);

      const btnEdit = document.createElement('button');
      btnEdit.className = 'btn-xs';
      btnEdit.textContent = 'Editar';
      btnEdit.addEventListener('click',()=>{
        if(state.locked) return;
        openModal(t);
      });
      right.appendChild(btnEdit);

      const btnView = document.createElement('button');
      btnView.className = 'btn-xs';
      btnView.textContent = 'Ver ficha original';
      btnView.addEventListener('click',()=>{
        openFichaOriginalFromTask(t);
      });
      right.appendChild(btnView);

      const btnDel = document.createElement('button');
      btnDel.className = 'btn-xs danger';
      btnDel.textContent = 'Apagar';
      btnDel.addEventListener('click',()=>{
        if(state.locked) return;
        if(confirm('Tem a certeza que pretende apagar esta tarefa?')){
          state.tasks = state.tasks.filter(x=>x.id !== t.id);
          saveState();
          renderCards();
        }
      });
      right.appendChild(btnDel);

      foot.appendChild(right);
      card.appendChild(foot);

      cardsGrid.appendChild(card);
    });
  }

  function exportCsv(){
    if(!state.tasks.length){
      alert('N√£o existem tarefas para exportar.');
      return;
    }

    const cols = [
      'id','titulo','descricao','responsavel','apoio',
      'origemTipo','origemRef',
      'estado','prioridade','tipoTarefa',
      'tags','dataCriacao','dataLimite','horaLimite'
    ];

    function esc(v){
      if(v==null) return '';
      const s = String(v).replace(/"/g,'""');
      return '"' + s + '"';
    }

    let csv = cols.map(esc).join(';') + '\n';
    state.tasks.forEach(t=>{
      const row = cols.map(c=>esc(t[c]));
      csv += row.join(';') + '\n';
    });

    const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'tarefas_garvetur_porto_pro.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  function exportPdfList(){
    const filtered = applyFilters(state.tasks);
    if(!filtered.length){
      alert('N√£o existem tarefas com os filtros atuais para exportar.');
      return;
    }

    const w = window.open('', '_blank');
    if(!w){
      alert('O navegador bloqueou a abertura da janela de impress√£o.\n\nPor favor permita pop-ups para este site ou use a op√ß√£o de imprimir diretamente no browser.');
      return;
    }

    let rowsHtml = '';
    filtered.forEach(t=>{
      rowsHtml += `
      <tr>
        <td>${t.dataLimite || ''} ${t.horaLimite || ''}</td>
        <td>${t.titulo || ''}</td>
        <td>${t.responsavel || ''}</td>
        <td>${estadoLabel(t.estado)}</td>
        <td>${prioridadeLabel(t.prioridade)}</td>
        <td>${tipoLabel(t.tipoTarefa)}</td>
      </tr>`;
    });

    const html = `
<!doctype html>
<html lang="pt-PT">
<head>
<meta charset="utf-8" />
<title>Lista de Tarefas ‚Äî Garvetur Porto Pro</title>
<style>
  @page { size: A4; margin: 1.5cm; }
  body{
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
    margin:0;
    padding:0;
    color:#222;
    background:#fff;
  }
  h1{
    font-size:18px;
    margin:0 0 4px;
    letter-spacing:.12em;
    text-transform:uppercase;
    color:#333;
  }
  .sub{
    font-size:11px;
    color:#777;
    letter-spacing:.18em;
    text-transform:uppercase;
  }
  header{
    border-bottom:2px solid #A38B63;
    padding-bottom:6px;
    margin-bottom:10px;
    display:flex;
    justify-content:space-between;
    align-items:flex-end;
  }
  .brand-block{
    max-width:70%;
  }
  .info-block{
    font-size:11px;
    color:#555;
    text-align:right;
  }
  table{
    width:100%;
    border-collapse:collapse;
    font-size:10px;
    margin-top:6px;
  }
  th,td{
    border-bottom:1px solid #ddd;
    padding:4px 3px;
    text-align:left;
  }
  th{
    background:#f5f5f5;
    font-weight:600;
  }
  tbody tr:nth-child(even){
    background:#fafafa;
  }
</style>
</head>
<body>
  <header>
    <div class="brand-block">
      <h1>Garvetur Porto Pro</h1>
      <div class="sub">Lista de tarefas</div>
    </div>
    <div class="info-block">
      <div>Data emiss√£o: ${new Date().toLocaleDateString('pt-PT')}</div>
      <div>Total tarefas: ${filtered.length}</div>
    </div>
  </header>

  <table>
    <thead>
      <tr>
        <th style="width:16%;">Data / Hora</th>
        <th style="width:32%;">Tarefa</th>
        <th style="width:18%;">Respons√°vel</th>
        <th style="width:14%;">Estado</th>
        <th style="width:10%;">Prioridade</th>
        <th style="width:10%;">Tipo</th>
      </tr>
    </thead>
    <tbody>
      ${rowsHtml}
    </tbody>
  </table>

<script>
  window.print();
<\/script>
</body>
</html>
    `;

    w.document.open();
    w.document.write(html);
    w.document.close();
  }

  // ===== FICHA ORIGINAL (LEAD) =====

  function loadLeadsArray(){
    try{
      const raw = localStorage.getItem(LEADS_LS_KEY);
      if(!raw) return [];
      const arr = JSON.parse(raw);
      return Array.isArray(arr) ? arr : [];
    }catch(e){
      console.error('Erro a ler leads do localStorage', e);
      return [];
    }
  }

  function saveLeadsArray(leads){
    try{
      localStorage.setItem(LEADS_LS_KEY, JSON.stringify(leads));
    }catch(e){
      console.error('Erro a guardar leads no localStorage', e);
    }
  }

  function findLeadForTask(task, leads){
    if(!task || !task.origemRef) return null;
    const raw = (task.origemRef || '').trim();
    if(!raw) return null;

    const parts = raw.split('‚Äî');
    const refPart = parts[0].trim();
    const namePart = parts.slice(1).join('‚Äî').trim();

    let lead = leads.find(l=> (l.ref_interna || '').trim() === raw);
    if(!lead && refPart){
      lead = leads.find(l=> (l.ref_interna || '').trim() === refPart);
    }
    if(!lead && namePart){
      const ln = (namePart || '').toLowerCase();
      lead = leads.find(l=> (l.nome || '').toLowerCase() === ln);
    }
    if(!lead){
      const lowRaw = raw.toLowerCase();
      lead = leads.find(l=>{
        const blob = [
          l.ref_interna || '',
          l.nome || '',
          l.contacto || '',
          l.email || ''
        ].join(' ').toLowerCase();
        return blob.includes(lowRaw);
      });
    }
    return lead || null;
  }

  function openFichaOriginalFromTask(task){
    const tipo = task.origemTipo || 'lead';

    if(tipo !== 'lead'){
      alert('Neste momento, a ficha original est√° dispon√≠vel apenas para origem "Lead".');
      return;
    }

    const leads = loadLeadsArray();
    if(!leads.length){
      alert('N√£o foi poss√≠vel encontrar a ficha original no armazenamento local.\n\nAinda n√£o existem leads gravadas (gpp_leads_v5).');
      return;
    }

    const lead = findLeadForTask(task, leads);
    if(!lead){
      alert('N√£o foi poss√≠vel encontrar a ficha original no armazenamento local.\n\nVerifique se a refer√™ncia coincide exatamente com a usada em Leads (Ref. Interna ou nome do cliente).');
      return;
    }

    currentFicha = {
      tipo:'lead',
      leadId: lead.id,
      leadIndex: leads.findIndex(l=>l.id === lead.id)
    };

    fichaOrigemTipo.value = 'lead';
    fichaLeadId.value = lead.id || '';

    fichaNome.value = lead.nome || '';
    fichaConsultor.value = lead.consultor || '';
    fichaEstado.value = lead.estado || 'Novo';
    fichaContacto.value = lead.contacto || '';
    fichaEmail.value = lead.email || '';
    fichaRefInterna.value = lead.ref_interna || '';
    fichaData.value = lead.data || '';
    fichaUrl.value = lead.url || '';
    fichaTipoNegocio.value = lead.tipo_negocio || '';
    fichaImovel.value = ((lead.imovel || '') + (lead.tipologia ? ' ' + lead.tipologia : '')).trim();
    fichaZona.value = lead.zona || '';
    fichaValor.value = lead.valor || '';
    fichaPapel.value = lead.papel || '';
    fichaPerfil.value = lead.perfil || '';
    fichaNotas.value = lead.notas || '';

    renderFichaHistoricoTarefas(lead);
    renderFichaAlerta(lead);

    fichaModalTitle.textContent = 'Ficha original ‚Äî Lead';
    fichaMeta.textContent = 'Ligado √† lead com Ref. Interna "' + (lead.ref_interna || '‚Äî') + '". Altera√ß√µes gravam diretamente no m√≥dulo de Leads.';
    fichaModalBackdrop.classList.add('open');
  }

  function closeFichaModal(){
    fichaModalBackdrop.classList.remove('open');
    currentFicha = null;
  }

  function renderFichaHistoricoTarefas(lead){
    fichaTarefasLista.innerHTML = '';
    const ref = (lead.ref_interna || '').toLowerCase();
    const nome = (lead.nome || '').toLowerCase();

    const relacionados = (state.tasks || []).filter(t=>{
      const oref = (t.origemRef || '').toLowerCase();
      if(ref && oref.includes(ref)) return true;
      if(nome && oref.includes(nome)) return true;
      if(t.origemTipo === 'lead' && !t.origemRef && nome){
        const titulo = (t.titulo || '').toLowerCase();
        return titulo.includes(nome);
      }
      return false;
    });

    if(!relacionados.length){
      const li = document.createElement('li');
      li.textContent = 'Nenhuma tarefa associada encontrada com base na refer√™ncia / nome desta lead.';
      fichaTarefasLista.appendChild(li);
      return;
    }

    relacionados
      .sort((a,b)=>(a.dataLimite||'').localeCompare(b.dataLimite||''))
      .forEach(t=>{
        const li = document.createElement('li');
        const partes = [];
        if(t.dataLimite) partes.push(t.dataLimite + (t.horaLimite ? ' ' + t.horaLimite : ''));
        if(t.titulo) partes.push(t.titulo);
        if(t.responsavel) partes.push('Resp.: ' + t.responsavel);
        partes.push('Estado: ' + estadoLabel(t.estado));
        li.textContent = partes.join(' ¬∑ ');
        fichaTarefasLista.appendChild(li);
      });
  }

  function renderFichaAlerta(lead){
    const urgente = (lead.urgente || '').toLowerCase() === 'sim';
    const temFin = (lead.financiamento || '').toLowerCase() === 'sim';
    const classif = Number(lead.classificacao || 0) || 0;

    const mensagens = [];

    if(urgente){
      mensagens.push('‚ö° Lead marcada como URGENTE ‚Äî priorizar contactos e propostas.');
    }
    if(classif >= 4){
      mensagens.push('‚≠ê Classifica√ß√£o ' + classif + ' ‚Äî lead com elevado potencial. Garantir plano claro de follow-up.');
    }
    if(temFin && (lead.simulacao || '').toLowerCase() !== 'sim'){
      mensagens.push('üè¶ Cliente indica financiamento banc√°rio, mas sem simula√ß√£o marcada. Pode ser oportunidade para intermedia√ß√£o de cr√©dito.');
    }

    if(!mensagens.length){
      fichaAlertaTexto.textContent = 'Sem alertas espec√≠ficos. Use esta √°rea para identificar riscos ou oportunidades especiais ligados a esta lead.';
    }else{
      fichaAlertaTexto.innerHTML = mensagens.join('<br>');
    }
  }

  function saveFichaOriginal(){
    if(!currentFicha || currentFicha.tipo !== 'lead'){
      closeFichaModal();
      return;
    }

    const leads = loadLeadsArray();
    if(!leads.length){
      alert('N√£o foi poss√≠vel guardar ‚Äî n√£o foram encontradas leads no armazenamento local.');
      return;
    }

    const idx = leads.findIndex(l=>l.id === currentFicha.leadId);
    if(idx < 0){
      alert('N√£o foi poss√≠vel guardar ‚Äî a lead deixou de existir no armazenamento local.');
      return;
    }

    const lead = leads[idx];

    lead.nome = fichaNome.value.trim();
    lead.consultor = fichaConsultor.value.trim();
    lead.estado = fichaEstado.value || 'Novo';
    lead.contacto = fichaContacto.value.trim();
    lead.email = fichaEmail.value.trim();
    lead.ref_interna = fichaRefInterna.value.trim();
    lead.data = fichaData.value.trim();
    lead.url = fichaUrl.value.trim();
    lead.tipo_negocio = fichaTipoNegocio.value.trim();
    lead.imovel = fichaImovel.value.trim();
    lead.zona = fichaZona.value.trim();
    lead.valor = fichaValor.value.trim();
    lead.papel = fichaPapel.value.trim();
    lead.perfil = fichaPerfil.value.trim();
    lead.notas = fichaNotas.value.trim();

    leads[idx] = lead;
    saveLeadsArray(leads);

    alert('Altera√ß√µes guardadas na ficha original da lead.');
    closeFichaModal();
  }

  // Eventos
  toggleLockBtn.addEventListener('click',()=>{
    state.locked = !state.locked;
    updateLockUI();
    saveState();
  });

  newTaskBtn.addEventListener('click',()=>{
    if(state.locked) return;
    openModal(null);
  });

  closeModalBtn.addEventListener('click', closeModal);
  cancelModalBtn.addEventListener('click', closeModal);

  applyFiltersBtn.addEventListener('click', ()=>{
    updateFiltersFromControls();
    saveFiltersToStorage();
    syncGlobalFiltersFromTasks();
    renderCards();
  });

  clearFiltersBtn.addEventListener('click', ()=>{
    clearFilters();
    renderCards();
  });

  clearOriginFilterBtn.addEventListener('click', ()=>{
    FILTERS.origemTipo = '';
    FILTERS.origemRef  = '';
    saveFiltersToStorage();
    renderCards();
  });

  saveTaskBtn.addEventListener('click',(e)=>{
    e.preventDefault();
    if(state.locked){
      alert('O modo de edi√ß√£o est√° bloqueado. Desbloqueie o cadeado no topo para guardar altera√ß√µes.');
      return;
    }
    const data = collectFormData();
    const idx = state.tasks.findIndex(t=>t.id === data.id);
    if(idx>=0){
      state.tasks[idx] = data;
    }else{
      state.tasks.push(data);
    }
    saveState();
    renderCards();
    closeModal();
  });

  exportCsvBtn.addEventListener('click', exportCsv);
  exportPdfBtn.addEventListener('click', exportPdfList);

  window.addEventListener('keydown',(e)=>{
    if(e.key==='Escape'){
      if(modalBackdrop.classList.contains('open')){
        closeModal();
      }else if(fichaModalBackdrop.classList.contains('open')){
        closeFichaModal();
      }
    }
  });

  // Eventos ficha original
  closeFichaModalBtn.addEventListener('click', closeFichaModal);
  cancelFichaModalBtn.addEventListener('click', closeFichaModal);
  saveFichaModalBtn.addEventListener('click',(e)=>{
    e.preventDefault();
    saveFichaOriginal();
  });

  // Init
  initConsultores();
  loadState();
  loadFiltersFromStorage();
  loadGlobalFiltersFallback();
  applyUrlContext();
  applyFiltersToControls();
  renderCards();

})();
</script>
</body>
</html>
