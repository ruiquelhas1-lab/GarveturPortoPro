
<!doctype html>
<html lang="pt-PT">
<head>
<meta charset="utf-8" />
<title>Garvetur Porto Pro ‚Äî Tarefas</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
:root{
 --gold:#A38B63;
 --gold-soft:rgba(163,139,99,.35);
 --bg:#0B0B0B;
 --panel:#141414;
 --panel-soft:#181818;
 --border:rgba(255,255,255,.12);
 --text:#FFFFFF;
 --muted:#A0A0A0;
 --danger:#F25F5C;
 --success:#4CAF50;
 --warning:#FFC857;
 --radius-lg:20px;
 --radius-md:14px;
 --shadow-soft:0 18px 35px rgba(0,0,0,.55);
}

/* Reset + Base */
*{box-sizing:border-box;}
html,body{margin:0;padding:0;height:100%;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;background:radial-gradient(circle at top,#1c1c1c,#050505 55%,#000);color:var(--text);}
body{display:flex;flex-direction:column;}
.app-shell{display:grid;grid-template-rows:64px auto;height:100%;}

/* HEADER */
header.app-header{
 display:flex;align-items:center;justify-content:space-between;
 padding:10px 18px;
 border-bottom:1px solid rgba(163,139,99,.35);
 background:linear-gradient(90deg,#050505,#111,#050505);
 gap:16px;flex-wrap:wrap;
 position:sticky;top:0;z-index:20;
}
.brand{display:flex;align-items:center;gap:10px;}
.brand-icon{
 width:26px;height:26px;border-radius:999px;border:1px solid var(--gold);
 display:flex;align-items:center;justify-content:center;
 box-shadow:0 0 0 1px rgba(163,139,99,.3);
}
.brand h1{margin:0;font-size:17px;letter-spacing:.04em;text-transform:uppercase;color:var(--gold);}
.brand span.sub{display:block;font-size:11px;color:var(--muted);letter-spacing:.12em;text-transform:uppercase;}

/* NAV TABS */
.nav-tabs{
 display:flex;flex-wrap:wrap;align-items:center;gap:4px;
 background:rgba(0,0,0,.35);padding:4px;
 border-radius:999px;border:1px solid rgba(163,139,99,.35);
}
.nav-tab{
 padding:5px 10px;border-radius:999px;font-size:11px;text-decoration:none;
 color:var(--muted);letter-spacing:.12em;text-transform:uppercase;border:1px solid transparent;
 transition:.16s background,.16s color,.16s border-color,.16s transform;
}
.nav-tab:hover{color:#fff;border-color:rgba(163,139,99,.6);transform:translateY(-1px);}
.nav-tab.active{background:var(--gold);color:#0A0A0A;border-color:var(--gold);font-weight:600;}

/* HEADER ACTIONS */
.header-actions{display:flex;align-items:center;gap:8px;flex-wrap:wrap;}
.btn{
 border-radius:999px;border:1px solid var(--gold-soft);
 background:rgba(12,12,12,.9);color:var(--text);
 padding:7px 12px;font-size:13px;display:inline-flex;align-items:center;gap:6px;
 cursor:pointer;transition:.18s border-color,.18s background,.18s transform;
}
.btn:hover{border-color:var(--gold);transform:translateY(-1px);}
.btn-primary{background:var(--gold);color:#0A0A0A;border-color:var(--gold);font-weight:500;}
.btn-ghost{background:transparent;}
.btn-icon{width:34px;height:34px;padding:0;border-radius:999px;justify-content:center;}
.btn:disabled{opacity:.45;cursor:not-allowed;transform:none;}

.pill-lock{
 display:inline-flex;align-items:center;gap:6px;font-size:12px;
 padding:4px 9px;border-radius:999px;background:rgba(0,0,0,.45);
 border:1px solid rgba(255,255,255,.14);color:var(--muted);
}
.pill-lock span.state{font-weight:500;color:var(--gold);}
.pill-lock button{all:unset;cursor:pointer;padding:2px 6px;border-radius:999px;background:rgba(255,255,255,.05);}

/* LAYOUT */
.layout{
 display:grid;grid-template-columns:320px minmax(0,1fr);
 height:calc(100vh - 64px);max-height:calc(100vh - 64px);overflow:hidden;
}
@media(max-width:960px){
 .layout{grid-template-columns:1fr;grid-template-rows:auto auto;height:auto;max-height:none;}
}

/* SIDEBAR */
.sidebar{
 border-right:1px solid rgba(163,139,99,.24);
 background:radial-gradient(circle at top left,#141414,#060606);
 padding:12px 14px;overflow-y:auto;
}
.sidebar-section{
 border-radius:var(--radius-md);padding:10px 11px;background:rgba(0,0,0,.45);
 border:1px solid rgba(163,139,99,.18);margin-bottom:10px;
}
.sidebar-section h3{
 margin:0 0 6px;font-size:11px;text-transform:uppercase;
 letter-spacing:.16em;color:var(--muted);
}
.sidebar-section p{margin:2px 0 6px;font-size:12px;color:var(--muted);}

.field{display:flex;flex-direction:column;gap:4px;margin-bottom:8px;}
.field-row{display:flex;gap:6px;}
label.field-label{
 font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.12em;
}
input,select,textarea{
 background:rgba(0,0,0,.7);color:var(--text);border-radius:10px;border:1px solid rgba(163,139,99,.22);
 padding:6px 8px;font-size:13px;outline:none;width:100%;
}
input:focus,select:focus,textarea:focus{border-color:var(--gold);box-shadow:0 0 0 1px rgba(163,139,99,.35);}
textarea{resize:vertical;min-height:60px;}

.filters-badges{display:flex;flex-wrap:wrap;gap:6px;margin-top:4px;}
.badge{
 font-size:11px;border-radius:999px;padding:3px 7px;border:1px solid rgba(163,139,99,.35);
 background:rgba(8,8,8,.9);color:var(--muted);
}
.badge strong{color:var(--gold);}

/* SWITCH */
.toggle-line{display:flex;align-items:center;justify-content:space-between;font-size:12px;margin-top:4px;}
.switch{position:relative;display:inline-block;width:34px;height:18px;}
.switch input{opacity:0;width:0;height:0;}
.slider{
 position:absolute;cursor:pointer;inset:0;background:#444;transition:.2s;border-radius:34px;
}
.slider:before{
 position:absolute;content:"";height:14px;width:14px;left:3px;bottom:2px;
 background:white;transition:.2s;border-radius:50%;
}
.switch input:checked + .slider{background:var(--gold);}
.switch input:checked + .slider:before{transform:translateX(14px);}

/* MAIN AREA ‚Äî CARDS */
.cards-area{
 padding:14px 16px 18px;overflow-y:auto;
 background:radial-gradient(circle at top,#1a1a1a,#050505 55%,#000 100%);
}
.cards-header{display:flex;align-items:flex-end;justify-content:space-between;margin-bottom:8px;gap:10px;}
.cards-header-left h2{
 margin:0;font-size:15px;letter-spacing:.16em;text-transform:uppercase;color:var(--muted);
}
.cards-header-left p{margin:2px 0 0;font-size:12px;color:var(--muted);}
.pipeline-kpis{display:flex;flex-wrap:wrap;gap:8px;margin-top:4px;}
.kpi-chip{
 border-radius:999px;padding:4px 9px;border:1px solid rgba(163,139,99,.32);
 font-size:11px;color:var(--muted);background:rgba(8,8,8,.9);
}
.kpi-chip span.value{color:var(--gold);font-weight:600;margin-left:4px;}

.origin-banner{
 margin-bottom:8px;padding:6px 10px;border-radius:999px;
 border:1px solid var(--gold-soft);background:rgba(163,139,99,.12);
 font-size:12px;color:var(--muted);display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap;
}
.origin-banner strong{color:var(--gold);}
.origin-banner button{
 border-radius:999px;border:1px solid rgba(163,139,99,.4);
 background:rgba(0,0,0,.6);color:var(--muted);padding:3px 8px;
 font-size:11px;cursor:pointer;
}
.origin-banner button:hover{border-color:var(--gold);color:#fff;}

.cards-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:10px;}
.card{
 border-radius:var(--radius-lg);border:1px solid rgba(163,139,99,.3);
 padding:10px 11px 9px;background:radial-gradient(circle at top left,#181818,#070707);
 box-shadow:var(--shadow-soft);display:flex;flex-direction:column;gap:6px;position:relative;
}
.card.completed{opacity:.6;border-style:dashed;}

.card-title{margin:0;font-size:14px;font-weight:600;color:#fff;white-space:nowrap;text-overflow:ellipsis;overflow:hidden;}
.card-subtitle{margin:1px 0 0;font-size:11px;color:var(--muted);white-space:nowrap;text-overflow:ellipsis;overflow:hidden;}
.chip-row{display:flex;flex-wrap:wrap;gap:4px;margin-top:4px;}
.chip{
 border-radius:999px;padding:2px 7px;font-size:10px;
 border:1px solid rgba(163,139,99,.4);background:#1E1E1E;color:var(--muted);
 text-transform:uppercase;letter-spacing:.08em;
}
.chip-primary{border-color:var(--gold);color:var(--gold);}
.chip-green{border-color:rgba(76,175,80,.7);color:#A5D6A7;}
.chip-red{border-color:rgba(242,95,92,.8);color:#FFABAB;}
.chip-yellow{border-color:rgba(255,200,87,.8);color:#FFE082;}

.card-section{
 border-top:1px solid rgba(163,139,99,.18);
 padding-top:4px;margin-top:2px;font-size:12px;color:var(--muted);
}
.card-section strong{color:#f5f5f5;font-weight:500;}

.card-footer{margin-top:6px;display:flex;align-items:center;justify-content:space-between;gap:6px;font-size:11px;color:var(--muted);}
.card-footer-left{display:flex;flex-wrap:wrap;gap:4px;align-items:center;}
.card-footer-right{display:flex;flex-wrap:wrap;gap:4px;justify-content:flex-end;}

.btn-xs{
 border-radius:999px;padding:3px 7px;border:1px solid rgba(163,139,99,.35);
 background:rgba(5,5,5,.9);color:var(--muted);font-size:10px;cursor:pointer;display:inline-flex;align-items:center;gap:4px;
}
.btn-xs.primary{border-color:var(--gold);color:var(--gold);}
.btn-xs.danger{border-color:var(--danger);color:#FFB3B0;}

.empty{font-size:12px;color:var(--muted);padding:16px 4px;text-align:center;}

/* MODAL ‚Äî BASE */
.modal-backdrop{
 position:fixed;inset:0;background:rgba(0,0,0,.75);
 display:none;align-items:center;justify-content:center;z-index:40;
}
.modal-backdrop.open{display:flex;}
/* MODAL ‚Äî CONTAINER */
.modal{
 width:820px;max-width:95%;max-height:88vh;
 background:radial-gradient(circle at top left,#1b1b1b,#0c0c0c);
 border:1px solid rgba(163,139,99,.35);
 border-radius:var(--radius-lg);
 box-shadow:0 22px 45px rgba(0,0,0,.65);
 display:flex;flex-direction:column;overflow:hidden;
}

/* MODAL HEADER */
.modal-header{
 padding:12px 16px;
 border-bottom:1px solid rgba(163,139,99,.25);
 display:flex;align-items:center;justify-content:space-between;gap:10px;
 background:rgba(0,0,0,.45);
}
.modal-header h2{
 margin:0;font-size:15px;letter-spacing:.14em;text-transform:uppercase;color:var(--gold);
}
.modal-close{
 cursor:pointer;border:none;background:transparent;color:var(--muted);
 font-size:20px;line-height:1;padding:2px 8px;
}
.modal-close:hover{color:#fff;}

/* MODAL BODY */
.modal-body{
 padding:14px 16px;overflow-y:auto;
 display:flex;flex-direction:column;gap:14px;
}

/* SEC√á√ÉO DO MODAL */
.modal-section{
 background:rgba(0,0,0,.35);
 border:1px solid rgba(163,139,99,.22);
 border-radius:var(--radius-md);
 padding:12px 14px;
}
.modal-section h3{
 margin:0 0 8px;font-size:13px;letter-spacing:.12em;
 text-transform:uppercase;color:var(--muted);
 display:flex;align-items:center;justify-content:space-between;
}

/* Colaps√°veis */
.collapse-toggle{
 cursor:pointer;font-size:12px;color:var(--gold);text-decoration:underline;
}
.collapse-content{margin-top:6px;}
.collapse-content.hidden{display:none;}

/* Tabela de hist√≥rico */
.history-table{
 width:100%;border-collapse:collapse;font-size:12px;margin-top:6px;
}
.history-table th, .history-table td{
 padding:6px 4px;border-bottom:1px solid rgba(255,255,255,.08);text-align:left;
}
.history-table th{color:var(--gold);font-weight:500;text-transform:uppercase;font-size:11px;}

/* Timeline */
.timeline{
 border-left:2px solid var(--gold-soft);
 margin-top:10px;padding-left:14px;
 display:flex;flex-direction:column;gap:12px;
}
.timeline-item{position:relative;}
.timeline-item::before{
 content:'';position:absolute;left:-10px;top:4px;
 width:8px;height:8px;border-radius:50%;background:var(--gold);
}
.timeline-item strong{color:#fff;}
.timeline-item small{color:var(--muted);display:block;margin-top:2px;}

/* Notas */
.note-box{
 margin-top:6px;border-radius:var(--radius-md);padding:8px 10px;
 background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);
}
.add-note-btn{
 margin-top:8px;font-size:12px;color:var(--gold);cursor:pointer;
 text-decoration:underline;
}
.add-note-area{
 margin-top:6px;display:flex;flex-direction:column;gap:6px;
}
.add-note-area textarea{
 min-height:60px;resize:vertical;
}
.add-note-area button{
 align-self:flex-end;border-radius:999px;padding:6px 12px;
 background:var(--gold);border:none;color:#000;font-size:12px;cursor:pointer;
}

/* MODAL FOOTER */
.modal-footer{
 padding:12px 16px;border-top:1px solid rgba(163,139,99,.25);
 display:flex;justify-content:flex-end;gap:8px;
 background:rgba(0,0,0,.45);
}
.modal-footer .btn-small{
 border-radius:999px;padding:6px 14px;border:1px solid rgba(163,139,99,.3);
 background:rgba(0,0,0,.6);color:var(--muted);font-size:12px;cursor:pointer;
}
.modal-footer .btn-small:hover{border-color:var(--gold);color:#fff;}
.modal-footer .btn-save{
 background:var(--gold);border-color:var(--gold);color:#000;font-weight:600;
}
</style>
</head>

<body>
<div class="app-shell">

<!-- HEADER -->
<header class="app-header">
 <div class="brand">
  <div class="brand-icon">
   <svg width="16" height="16" viewBox="0 0 24 24" stroke="var(--gold)" fill="none" stroke-width="1.8">
     <circle cx="12" cy="12" r="9"></circle>
     <path d="M8 12.5l2.5 2.5L16 9"></path>
   </svg>
  </div>
  <div>
   <h1>Garvetur Porto Pro ‚Äî Tarefas</h1>
   <span class="sub">Gest√£o Operacional</span>
  </div>
 </div>

 <nav class="nav-tabs">
   <a href="index.html" class="nav-tab">In√≠cio</a>
   <a href="mapa.html" class="nav-tab">Mapa</a>
   <a href="kanban.html" class="nav-tab">Leads</a>
   <a href="angariacoes.html" class="nav-tab">Angaria√ß√µes</a>
   <a href="dashboard.html" class="nav-tab">Dashboard</a>
   <a href="vendas.html" class="nav-tab">Vendas</a>
   <a href="tarefas.html" class="nav-tab active">Tarefas</a>
 </nav>

 <div class="header-actions">
   <div class="pill-lock">
     <svg width="13" height="13" viewBox="0 0 24 24" stroke="var(--gold)" fill="none" stroke-width="2">
       <rect x="6" y="11" width="12" height="9" rx="2"></rect>
       <path d="M8 11V8a4 4 0 118 0v3"></path>
     </svg>
     <span class="state" id="lockStateLabel">Bloqueado</span>
     <button id="toggleLockBtn">Alternar</button>
   </div>
   <button id="newTaskBtn" class="btn btn-primary" disabled>NOVA TAREFA</button>
 </div>
</header>
<!-- LAYOUT PRINCIPAL -->
<div class="layout">

<!-- ===== SIDEBAR (FILTROS) ===== -->
<aside class="sidebar">
  <div class="sidebar-section">
    <h3>Filtros</h3>

    <div class="field">
      <label class="field-label">Respons√°vel</label>
      <select id="filterResponsavel">
        <option value="">Todos</option>
      </select>
    </div>

    <div class="field-row">
      <div class="field">
        <label class="field-label">Estado</label>
        <select id="filterEstado">
          <option value="">Todos</option>
          <option value="por_fazer">Por fazer</option>
          <option value="em_curso">Em curso</option>
          <option value="concluida">Conclu√≠da</option>
          <option value="adiada">Adiada</option>
          <option value="cancelada">Cancelada</option>
        </select>
      </div>

      <div class="field">
        <label class="field-label">Prioridade</label>
        <select id="filterPrioridade">
          <option value="">Todas</option>
          <option value="baixa">Baixa</option>
          <option value="normal">Normal</option>
          <option value="alta">Alta</option>
          <option value="critica">Cr√≠tica</option>
        </select>
      </div>
    </div>

    <div class="field-row">
      <div class="field">
        <label class="field-label">De (data limite)</label>
        <input type="date" id="filterDataDe">
      </div>

      <div class="field">
        <label class="field-label">At√© (data limite)</label>
        <input type="date" id="filterDataAte">
      </div>
    </div>

    <div class="toggle-line">
      <span>Mostrar conclu√≠das</span>
      <label class="switch">
        <input type="checkbox" id="filterShowCompleted">
        <span class="slider"></span>
      </label>
    </div>

    <button id="applyFiltersBtn" class="btn" style="margin-top:8px;width:100%;">Aplicar Filtros</button>
    <button id="clearFiltersBtn" class="btn" style="margin-top:4px;width:100%;background:transparent;border-color:rgba(255,255,255,.2);">Limpar</button>

  </div>

  <div class="sidebar-section">
    <h3>Resumo</h3>
    <div id="summaryBadges" class="filters-badges"></div>
  </div>

  <div class="sidebar-section">
    <h3>Nota</h3>
    <p>Com o cadeado bloqueado n√£o √© poss√≠vel editar tarefas.</p>
    <p>Desbloqueie para criar, editar e apagar.</p>
  </div>
</aside>


<!-- ===== √ÅREA DOS CART√ïES ===== -->
<main class="cards-area">

  <div class="cards-header">
    <div class="cards-header-left">
      <h2>Tarefas</h2>
      <p>Follow-up comercial, visitas e compromissos</p>
      <div id="pipelineKpis" class="pipeline-kpis"></div>
    </div>
  </div>

  <!-- Banner quando vem de Leads / Vendas -->
  <div id="originFilterBanner" class="origin-banner" style="display:none;">
    <div>üîó <strong id="originFilterLabel"></strong></div>
    <button id="clearOriginFilterBtn">Limpar filtro</button>
  </div>

  <div id="cardsGrid" class="cards-grid"></div>
  <div id="emptyState" class="empty" style="display:none;">N√£o existem tarefas com estes filtros.</div>

</main>

</div> <!-- /layout -->
<!-- ======================== -->
<!--  SCRIPT FINAL COMPLETO   -->
<!-- ======================== -->

<script>
(function(){

/* ===========================================================
   CONFIGURA√á√ÉO
   =========================================================== */
const STORAGE_KEY = "gpp_tarefas_v1";
const FILTERS_KEY = "gpp_tarefas_filters_v1";
const GLOBAL_FILTERS_KEY = "gpp_global_filters_v1";

function $(id){ return document.getElementById(id); }

/* Campos principais */
const cardsGrid = $("cardsGrid");
const emptyState = $("emptyState");
const pipelineKpis = $("pipelineKpis");
const summaryBadges = $("summaryBadges");
const originFilterBanner = $("originFilterBanner");
const originFilterLabel = $("originFilterLabel");

/* Bot√µes */
const newTaskBtn = $("newTaskBtn");
const toggleLockBtn = $("toggleLockBtn");
const lockStateLabel = $("lockStateLabel");

const exportCsvBtn = $("exportCsvBtn");
const exportPdfBtn = $("exportPdfBtn");

const applyFiltersBtn = $("applyFiltersBtn");
const clearFiltersBtn = $("clearFiltersBtn");
const clearOriginFilterBtn = $("clearOriginFilterBtn");

/* Modal */
const modalBackdrop = $("modalBackdrop");
const modalTitle = $("modalTitle");
const closeModalBtn = $("closeModalBtn");
const cancelModalBtn = $("cancelModalBtn");
const saveTaskBtn = $("saveTaskBtn");

/* Form fields */
const taskForm = $("taskForm");
const responsavelSelect = $("responsavel");
const apoioSelect = $("apoio");

/* Filtros */
const filterResponsavel = $("filterResponsavel");
const filterEstado = $("filterEstado");
const filterPrioridade = $("filterPrioridade");
const filterDataDe = $("filterDataDe");
const filterDataAte = $("filterDataAte");
const filterShowCompleted = $("filterShowCompleted");

/* Consultores padr√£o */
const CONSULTOR_OPTIONS = [
  "Rui Quelhas",
  "Manuel Oliveira",
  "Jo√£o Sousa",
  "Francisco dos Santos",
  "Ros√°rio Vasconcelos",
  "Armanda Meireles",
  "Audrey Lucas",
  "Outro"
];

/* Estado global */
let state = {
  locked: true,
  tasks: []
};

let FILTERS = {
  responsavel: "",
  estado: "",
  prioridade: "",
  de: "",
  ate: "",
  showCompleted: false,
  origemTipo: "",
  origemRef: ""
};

/* ===========================================================
   FUN√á√ïES BASE
   =========================================================== */

function todayISO(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${dd}`;
}

function addDays(dateStr, n){
  const d = new Date(dateStr);
  d.setDate(d.getDate() + n);
  return d.toISOString().slice(0,10);
}

/* ===========================================================
   STORAGE
   =========================================================== */
function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw){
      const parsed = JSON.parse(raw);
      if(Array.isArray(parsed.tasks)) state.tasks = parsed.tasks;
      if(typeof parsed.locked === "boolean") state.locked = parsed.locked;
    }
  }catch(err){ console.error(err); }
  updateLockUI();
}

function saveState(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

function loadFilters(){
  try{
    const raw = localStorage.getItem(FILTERS_KEY);
    if(raw){
      const parsed = JSON.parse(raw);
      FILTERS = Object.assign(FILTERS, parsed);
    }
  }catch(err){ console.error(err); }
}

function saveFilters(){
  localStorage.setItem(FILTERS_KEY, JSON.stringify(FILTERS));
}

function syncGlobalFilters(){
  const g = {
    consultor: FILTERS.responsavel || "",
    de: FILTERS.de || "",
    ate: FILTERS.ate || ""
  };
  localStorage.setItem(GLOBAL_FILTERS_KEY, JSON.stringify(g));
}

/* ===========================================================
   UI ‚Äî LOCK STATE
   =========================================================== */
function updateLockUI(){
  if(state.locked){
    lockStateLabel.textContent = "Bloqueado";
    toggleLockBtn.textContent = "üîí";
    newTaskBtn.disabled = true;
  } else {
    lockStateLabel.textContent = "Edi√ß√£o ativa";
    toggleLockBtn.textContent = "üîì";
    newTaskBtn.disabled = false;
  }
}

/* ===========================================================
   CONSULTORES
   =========================================================== */
function initConsultores(){
  CONSULTOR_OPTIONS.forEach(c=>{
    const opt1 = document.createElement("option");
    opt1.value = c; opt1.textContent = c;
    responsavelSelect.appendChild(opt1);

    const opt2 = document.createElement("option");
    opt2.value = c; opt2.textContent = c;
    apoioSelect.appendChild(opt2);

    const opt3 = document.createElement("option");
    opt3.value = c; opt3.textContent = c;
    filterResponsavel.appendChild(opt3);
  });
}

/* ===========================================================
   FILTROS ‚Äî APLICAR
   =========================================================== */
function applyFilterControls(){
  filterResponsavel.value = FILTERS.responsavel;
  filterEstado.value = FILTERS.estado;
  filterPrioridade.value = FILTERS.prioridade;
  filterDataDe.value = FILTERS.de;
  filterDataAte.value = FILTERS.ate;
  filterShowCompleted.checked = FILTERS.showCompleted;
}

function updateFiltersFromControls(){
  FILTERS.responsavel = filterResponsavel.value;
  FILTERS.estado = filterEstado.value;
  FILTERS.prioridade = filterPrioridade.value;
  FILTERS.de = filterDataDe.value;
  FILTERS.ate = filterDataAte.value;
  FILTERS.showCompleted = filterShowCompleted.checked;
}

function clearAllFilters(){
  FILTERS = {
    responsavel:"",
    estado:"",
    prioridade:"",
    de:"",
    ate:"",
    showCompleted:false,
    origemTipo:"",
    origemRef:""
  };
  applyFilterControls();
  saveFilters();
}

/* ===========================================================
   RENDER VIA FILTROS
   =========================================================== */
function applyFiltersToTasks(tasks){
  return tasks.filter(t=>{
    if(FILTERS.responsavel && t.responsavel !== FILTERS.responsavel) return false;
    if(FILTERS.estado && t.estado !== FILTERS.estado) return false;
    if(FILTERS.prioridade && t.prioridade !== FILTERS.prioridade) return false;

    if(!FILTERS.showCompleted && (t.estado==="concluida" || t.estado==="cancelada"))
      return false;

    if(FILTERS.de && t.dataLimite && t.dataLimite < FILTERS.de) return false;
    if(FILTERS.ate && t.dataLimite && t.dataLimite > FILTERS.ate) return false;

    if(FILTERS.origemTipo && t.origemTipo !== FILTERS.origemTipo) return false;

    if(FILTERS.origemRef){
      const r = (t.origemRef || "").toLowerCase();
      if(!r.includes(FILTERS.origemRef.toLowerCase())) return false;
    }

    return true;
  });
}

/* ===========================================================
   RENDER CARDS (VISUAL PREMIUM ORIGINAL)
   =========================================================== */
function estadoLabel(x){
  return {
    por_fazer:"Por fazer",
    em_curso:"Em curso",
    concluida:"Conclu√≠da",
    adiada:"Adiada",
    cancelada:"Cancelada"
  }[x] || x;
}

function prioridadeLabel(x){
  return {
    baixa:"Baixa",
    normal:"Normal",
    alta:"Alta",
    critica:"Cr√≠tica"
  }[x] || x;
}

function tipoLabel(x){
  return {
    chamada:"Chamada",
    email:"Email",
    visita:"Visita",
    reuniao:"Reuni√£o",
    followup:"Follow-up",
    outro:"Outro"
  }[x] || x;
}

function origemLabel(x){
  return {
    lead:"Lead",
    angariacao:"Angaria√ß√£o",
    venda:"Venda",
    interna:"Interna"
  }[x] || x;
}

function renderCards(){
  const tasks = [...state.tasks];

  /* Ordenar por Data limite (urg√™ncia) */
  tasks.sort((a,b)=>{
    if(a.dataLimite && b.dataLimite){
      return a.dataLimite.localeCompare(b.dataLimite);
    }
    if(a.dataLimite) return -1;
    if(b.dataLimite) return 1;
    return (a.createdAtMs||0) - (b.createdAtMs||0);
  });

  const filtered = applyFiltersToTasks(tasks);

  cardsGrid.innerHTML = "";
  emptyState.style.display = filtered.length ? "none" : "block";

  /* KPIs */
  const estados = {por_fazer:0,em_curso:0,concluida:0,adiada:0,cancelada:0};
  state.tasks.forEach(t=>{
    if(estados[t.estado] !== undefined) estados[t.estado]++;
  });

  pipelineKpis.innerHTML = "";
  Object.keys(estados).forEach(k=>{
    const div = document.createElement("div");
    div.className = "kpi-chip";
    div.innerHTML = estadoLabel(k) + `<span class="value">${estados[k]}</span>`;
    pipelineKpis.appendChild(div);
  });

  /* Badges resumo */
  summaryBadges.innerHTML = "";
  const b1 = document.createElement("div");
  b1.className = "badge";
  b1.innerHTML = `Total tarefas <strong>${state.tasks.length}</strong>`;
  summaryBadges.appendChild(b1);

  const abertas = state.tasks.filter(t=>t.estado!=="concluida" && t.estado!=="cancelada").length;
  const b2 = document.createElement("div");
  b2.className = "badge";
  b2.innerHTML = `Em aberto <strong>${abertas}</strong>`;
  summaryBadges.appendChild(b2);

  /* Cart√µes */
  filtered.forEach(t=>{
    const card = document.createElement("div");
    card.className = "card";
    if(t.estado==="concluida" || t.estado==="cancelada"){
      card.classList.add("completed");
    }

    /* URG√äNCIA ‚Üí cor do painel conforme data */
    if(t.dataLimite){
      const hoje = todayISO();
      const diff = (new Date(t.dataLimite) - new Date(hoje)) / (1000*60*60*24);
      if(diff < 0){
        card.style.borderColor = "rgba(255,0,0,.6)";
        card.style.boxShadow = "0 0 12px rgba(255,0,0,.4)";
      }
      else if(diff <= 2){
        card.style.borderColor = "rgba(255,80,80,.5)";
      }
      else if(diff <= 5){
        card.style.borderColor = "rgba(255,200,87,.5)";
      }
    }

    /* ----- T√çTULO ----- */
    const top = document.createElement("div");
    top.className = "card-top-row";

    const titleBlock = document.createElement("div");
    titleBlock.className = "card-title-block";

    const h3 = document.createElement("h3");
    h3.className = "card-title";
    h3.textContent = t.titulo || "(Sem t√≠tulo)";
    titleBlock.appendChild(h3);

    const subtitle = document.createElement("div");
    subtitle.className = "card-subtitle";
    subtitle.textContent = [
      t.responsavel || "",
      prioridadeLabel(t.prioridade),
      estadoLabel(t.estado)
    ].filter(Boolean).join(" ¬∑ ");
    titleBlock.appendChild(subtitle);

    const chips = document.createElement("div");
    chips.className = "chip-row";

    const c1 = document.createElement("span");
    c1.className = "chip";
    c1.textContent = estadoLabel(t.estado);
    chips.appendChild(c1);

    const c2 = document.createElement("span");
    c2.className = "chip";
    c2.textContent = prioridadeLabel(t.prioridade);
    chips.appendChild(c2);

    if(t.tipoTarefa){
      const c3 = document.createElement("span");
      c3.className = "chip";
      c3.textContent = tipoLabel(t.tipoTarefa);
      chips.appendChild(c3);
    }

    if(t.origemTipo){
      const c4 = document.createElement("span");
      c4.className = "chip";
      c4.textContent = origemLabel(t.origemTipo);
      chips.appendChild(c4);
    }

    titleBlock.appendChild(chips);
    top.appendChild(titleBlock);
    card.appendChild(top);

    /* ORIGEM */
    if(t.origemTipo || t.origemRef){
      const sec = document.createElement("div");
      sec.className = "card-section";
      sec.innerHTML = `<strong>Origem:</strong> ${origemLabel(t.origemTipo)} ¬∑ ${t.origemRef || ""}`;
      card.appendChild(sec);
    }

    /* DATAS */
    const secDat = document.createElement("div");
    secDat.className = "card-section";
    secDat.textContent =
      `Criada: ${t.dataCriacao || ""} ¬∑ Limite: ${t.dataLimite || ""} ${t.horaLimite || ""}`;
    card.appendChild(secDat);

    /* DESCRI√á√ÉO */
    if(t.descricao){
      const secDesc = document.createElement("div");
      secDesc.className = "card-section";
      secDesc.textContent = t.descricao.length > 160 ? t.descricao.slice(0,157)+"‚Ä¶" : t.descricao;
      card.appendChild(secDesc);
    }

    /* FOOTER (A√ß√µes) */
    const foot = document.createElement("div");
    foot.className = "card-footer";

    const left = document.createElement("div");
    left.className = "card-footer-left";
    left.textContent = t.responsavel;
    foot.appendChild(left);

    const right = document.createElement("div");
    right.className = "card-footer-right";

    /* Ver ficha original + Editar + Apagar */
    const btnView = document.createElement("button");
    btnView.className = "btn-xs";
    btnView.textContent = "Ver ficha original";
    btnView.addEventListener("click",()=>openModal(t));
    right.appendChild(btnView);

    const btnEdit = document.createElement("button");
    btnEdit.className = "btn-xs";
    btnEdit.textContent = "Editar";
    btnEdit.addEventListener("click",()=>openModal(t));
    right.appendChild(btnEdit);

    const btnDel = document.createElement("button");
    btnDel.className = "btn-xs danger";
    btnDel.textContent = "Apagar";
    btnDel.addEventListener("click",()=>{
      if(state.locked) return;
      if(confirm("Apagar esta tarefa?")){
        state.tasks = state.tasks.filter(x=>x.id !== t.id);
        saveState();
        renderCards();
      }
    });
    right.appendChild(btnDel);

    foot.appendChild(right);
    card.appendChild(foot);

    cardsGrid.appendChild(card);
  });
}

/* ===========================================================
   MODAL
   =========================================================== */
function openModal(task){
  modalBackdrop.classList.add("open");

  if(task){
    modalTitle.textContent = "Editar Tarefa";
    $("taskId").value = task.id;
    $("titulo").value = task.titulo || "";
    $("descricao").value = task.descricao || "";
    $("tags").value = task.tags || "";
    $("estado").value = task.estado || "";
    $("prioridade").value = task.prioridade || "";
    $("tipoTarefa").value = task.tipoTarefa || "";
    $("origemTipo").value = task.origemTipo || "";
    $("origemRef").value = task.origemRef || "";
    $("dataCriacao").value = task.dataCriacao || todayISO();
    $("dataLimite").value = task.dataLimite || addDays(todayISO(),8);
    $("horaLimite").value = task.horaLimite || "";

    responsavelSelect.value = task.responsavel || "";
    apoioSelect.value = task.apoio || "";
  }
  else{
    modalTitle.textContent = "Nova Tarefa";
    taskForm.reset();
    $("taskId").value = "";
    $("dataCriacao").value = todayISO();
    $("dataLimite").value = addDays(todayISO(),8);
  }
}

function closeModal(){
  modalBackdrop.classList.remove("open");
}

/* ===========================================================
   GUARDAR TAREFA
   =========================================================== */
function saveTask(){
  if(state.locked){
    alert("Desbloqueie o cadeado para editar.");
    return;
  }

  const id = $("taskId").value || ("task_"+Date.now());

  const data = {
    id,
    titulo: $("titulo").value,
    descricao: $("descricao").value,
    tags: $("tags").value,
    estado: $("estado").value,
    prioridade: $("prioridade").value,
    tipoTarefa: $("tipoTarefa").value,
    origemTipo: $("origemTipo").value,
    origemRef: $("origemRef").value,
    dataCriacao: $("dataCriacao").value || todayISO(),
    dataLimite: $("dataLimite").value,
    horaLimite: $("horaLimite").value,
    responsavel: responsavelSelect.value,
    apoio: apoioSelect.value,
    createdAtMs: Date.now()
  };

  /* Validar datas */
  if(data.dataLimite < data.dataCriacao){
    alert("A data limite n√£o pode ser inferior √† data de cria√ß√£o.");
    return;
  }

  const idx = state.tasks.findIndex(x=>x.id === id);
  if(idx >= 0){
    state.tasks[idx] = data;
  } else {
    state.tasks.push(data);
  }

  saveState();
  closeModal();
  renderCards();
}

/* ===========================================================
   EXPORTAR CSV
   =========================================================== */
function exportCsv(){
  if(!state.tasks.length){
    alert("Sem tarefas.");
    return;
  }

  const cols = [
    "id","titulo","descricao","responsavel","apoio",
    "origemTipo","origemRef","estado","prioridade",
    "tipoTarefa","tags","dataCriacao","dataLimite","horaLimite"
  ];

  let csv = cols.join(";") + "\n";

  state.tasks.forEach(t=>{
    csv += cols.map(c => `"${(t[c]||"").replace(/"/g,'""')}"`).join(";") + "\n";
  });

  const blob = new Blob([csv],{type:"text/csv"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "tarefas.csv";
  a.click();
  URL.revokeObjectURL(url);
}

/* ===========================================================
   EXPORTAR PDF (SIMPLIFICADO)
   =========================================================== */
function exportPdfList(){
  window.print();
}

/* ===========================================================
   EVENTOS
   =========================================================== */

toggleLockBtn.addEventListener("click",()=>{
  state.locked = !state.locked;
  updateLockUI();
  saveState();
});

newTaskBtn.addEventListener("click",()=>openModal(null));
closeModalBtn.addEventListener("click",closeModal);
cancelModalBtn.addEventListener("click",closeModal);
saveTaskBtn.addEventListener("click",(e)=>{
  e.preventDefault();
  saveTask();
});

applyFiltersBtn.addEventListener("click",()=>{
  updateFiltersFromControls();
  saveFilters();
  syncGlobalFilters();
  renderCards();
});

clearFiltersBtn.addEventListener("click",()=>{
  clearAllFilters();
  syncGlobalFilters();
  renderCards();
});

clearOriginFilterBtn.addEventListener("click",()=>{
  FILTERS.origemTipo = "";
  FILTERS.origemRef = "";
  saveFilters();
  renderCards();
});

exportCsvBtn.addEventListener("click",exportCsv);
exportPdfBtn.addEventListener("click",exportPdfList);

/* ===========================================================
   LOAD INICIAL
   =========================================================== */

initConsultores();
loadState();
loadFilters();
applyFilterControls();
renderCards();

})();
</script>

</body>
</html>
