

<!doctype html>
<html lang="pt-PT">
<head>
  <meta charset="utf-8" />
  <title>Garvetur Porto Pro ‚Äî Tarefas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      --gold:#A38B63;
      --gold-soft:rgba(163,139,99,.35);
      --bg:#0B0B0B;
      --panel:#141414;
      --panel-soft:#181818;
      --border:rgba(255,255,255,.14);
      --text:#FFFFFF;
      --muted:#A0A0A0;
      --danger:#F25F5C;
      --success:#4CAF50;
      --warning:#FFC857;
      --radius-lg:18px;
      --radius-md:14px;
      --shadow-soft:0 18px 35px rgba(0,0,0,.6);
    }

    *{box-sizing:border-box;}
    html,body{
      margin:0;
      height:100%;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      background:radial-gradient(circle at top,#1c1c1c 0,#050505 55%,#000 100%);
      color:var(--text);
    }

    body{display:flex;flex-direction:column;}
    .app-shell{display:grid;grid-template-rows:64px auto;height:100%;}

    /* ---------------------- BARRA SUPERIOR ---------------------- */

    header.app-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 18px;
      border-bottom:1px solid rgba(163,139,99,.35);
      background:linear-gradient(90deg,#050505,#111,#050505);
      gap:16px;
      flex-wrap:wrap;
      position:sticky;
      top:0;
      z-index:20;
    }

    .brand{display:flex;align-items:center;gap:10px;}

    .brand-icon{
      width:28px;height:28px;border-radius:999px;
      border:1px solid var(--gold);
      display:flex;align-items:center;justify-content:center;
      box-shadow:0 0 0 1px rgba(163,139,99,.3);
    }

    .brand h1{
      margin:0;font-size:17px;letter-spacing:.04em;
      text-transform:uppercase;color:var(--gold);
    }

    .brand span.sub{
      display:block;font-size:11px;color:var(--muted);
      letter-spacing:.12em;text-transform:uppercase;
    }

    /* ---------------------- NAVEGA√á√ÉO ---------------------- */

    .nav-tabs{
      display:flex;flex-wrap:wrap;align-items:center;gap:4px;
      background:rgba(0,0,0,.35);padding:4px;
      border-radius:999px;border:1px solid rgba(163,139,99,.35);
    }

    .nav-tab{
      padding:6px 12px;border-radius:999px;font-size:11px;
      text-decoration:none;color:var(--muted);
      letter-spacing:.12em;text-transform:uppercase;
      border:1px solid transparent;
      transition:.16s background,.16s color,.16s border-color,.16s transform;
    }

    .nav-tab:hover{
      color:#fff;border-color:rgba(163,139,99,.6);
      transform:translateY(-1px);
    }

    .nav-tab.active{
      background:var(--gold);color:#0A0A0A;
      border-color:var(--gold);font-weight:600;
    }

    /* ---------------------- BOT√ïES SUPERIORES ---------------------- */

    .header-actions{
      display:flex;align-items:center;gap:8px;flex-wrap:wrap;
    }

    .btn{
      border-radius:999px;border:1px solid var(--gold-soft);
      background:rgba(12,12,12,.9);color:var(--text);
      padding:7px 12px;font-size:13px;display:inline-flex;
      align-items:center;gap:6px;cursor:pointer;
      transition:.18s border-color,.18s background,.18s transform;
    }

    .btn-primary{
      background:var(--gold);
      color:#0A0A0A;
      border-color:var(--gold);
      font-weight:500;
    }

    .btn-ghost{
      background:transparent;
    }

    .btn:hover{border-color:var(--gold);transform:translateY(-1px);}
    .btn:disabled{
      opacity:.45;
      cursor:not-allowed;
      transform:none;
    }

    .btn-icon{
      width:32px;height:32px;padding:0;
      border-radius:999px;justify-content:center;
    }

    /* ---------------------- SIDEBAR ---------------------- */

    .layout{
      display:grid;
      grid-template-columns:320px minmax(0,1fr);
      height:calc(100vh - 64px);
      max-height:calc(100vh - 64px);
      overflow:hidden;
    }

    @media (max-width: 960px){
      .layout{
        grid-template-columns:1fr;
        grid-template-rows:auto auto;
        height:auto;max-height:none;
      }
    }

    .sidebar{
      border-right:1px solid rgba(163,139,99,.24);
      background:radial-gradient(circle at top left,#141414,#060606);
      padding:12px 14px;
      overflow-y:auto;
    }

    .sidebar-section{
      border-radius:var(--radius-md);
      padding:10px 11px;
      background:rgba(0,0,0,.45);
      border:1px solid rgba(163,139,99,.18);
      margin-bottom:10px;
    }

    .sidebar-section h3{
      margin:0 0 6px;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.16em;
      color:var(--muted);
    }

    .sidebar-section p{
      margin:2px 0 6px;
      font-size:12px;
      color:var(--muted);
    }

    /* ---------------------- CAMPOS / INPUTS ---------------------- */

    .field{display:flex;flex-direction:column;gap:4px;margin-bottom:8px;}

    .field-row{display:flex;gap:6px;}

    label.field-label{
      font-size:11px;color:var(--muted);
      text-transform:uppercase;letter-spacing:.12em;
    }

    input[type="text"],
    input[type="number"],
    input[type="date"],
    input[type="time"],
    input[type="email"],
    select,
    textarea{
      background:rgba(0,0,0,.7);
      color:var(--text);
      border-radius:10px;
      border:1px solid rgba(163,139,99,.22);
      padding:6px 8px;
      font-size:13px;
      outline:none;width:100%;
    }

    input:focus, select:focus, textarea:focus{
      border-color:var(--gold);
      box-shadow:0 0 0 1px rgba(163,139,99,.35);
    }

    textarea{
      resize:vertical;
      min-height:60px;
    }

    .toggle-line{
      display:flex;align-items:center;justify-content:space-between;
      font-size:12px;margin-top:4px;
    }

    .toggle-line span{color:var(--muted);}

    /* ---------------------- √ÅREA DE CART√ïES ---------------------- */

    .cards-area{
      padding:14px 16px 18px;
      overflow-y:auto;
      background:radial-gradient(circle at top,#1a1a1a,#050505 55%,#000 100%);
    }

  </style>
</head>
<body>
<div class="app-shell">

  <!-- ===================== BARRA SUPERIOR ===================== -->
  <header class="app-header">

    <div class="brand">
      <div class="brand-icon">
        <svg width="16" height="16" viewBox="0 0 24 24" stroke="var(--gold)" fill="none" stroke-width="1.8">
          <circle cx="12" cy="12" r="9"></circle>
          <path d="M8 12.5l2.5 2.5L16 9"></path>
        </svg>
      </div>
      <div>
        <h1>Garvetur Porto Pro ‚Äî Tarefas</h1>
        <span class="sub">Follow-up, compromissos e rotina comercial</span>
      </div>
    </div>

    <!-- ===================== MENU DE NAVEGA√á√ÉO COMPLETO ===================== -->
    <nav class="nav-tabs">
      <a href="index.html" class="nav-tab">In√≠cio</a>
      <a href="mapa.html" class="nav-tab">Mapa</a>
      <a href="kanban.html" class="nav-tab">Leads</a>
      <a href="angariacoes.html" class="nav-tab">Angaria√ß√µes</a>
      <a href="dashboard.html" class="nav-tab">Dashboard</a>
      <a href="vendas.html" class="nav-tab">Vendas</a>
      <a href="tarefas.html" class="nav-tab active">Tarefas</a>
    </nav>

    <!-- ===================== A√á√ïES (CADEADO, EXPORTA√á√ïES, + NOVA TAREFA) ===================== -->
    <div class="header-actions">
      <div class="pill-lock" id="lockPill">
        <span>Modo</span>
        <span class="state" id="lockStateLabel">Bloqueado</span>
        <button id="toggleLockBtn" title="Alternar edi√ß√£o">üîí</button>
      </div>

      <button class="btn btn-ghost" id="exportCsvBtn" title="Exportar CSV">‚§ì CSV</button>
      <button class="btn btn-ghost" id="exportPdfBtn" title="Imprimir / PDF">‚§ì PDF</button>
      <button class="btn btn-primary" id="newTaskBtn">+ Nova Tarefa</button>
    </div>

  </header>

  <!-- ===================== LAYOUT (SIDEBAR + CONTE√öDO) ===================== -->

  <div class="layout">

    <!-- ===================== SIDEBAR (Filtros + Resumo) ===================== -->

    <aside class="sidebar">

      <div class="sidebar-section">
        <h3>Filtros</h3>

        <div class="field">
          <label class="field-label" for="filterResponsavel">Respons√°vel</label>
          <select id="filterResponsavel">
            <option value="">Todos</option>
          </select>
        </div>

        <div class="field-row">
          <div class="field">
            <label class="field-label" for="filterEstado">Estado</label>
            <select id="filterEstado">
              <option value="">Todos</option>
              <option value="por_fazer">Por fazer</option>
              <option value="em_curso">Em curso</option>
              <option value="concluida">Conclu√≠da</option>
              <option value="adiada">Adiada</option>
              <option value="cancelada">Cancelada</option>
            </select>
          </div>

          <div class="field">
            <label class="field-label" for="filterPrioridade">Prioridade</label>
            <select id="filterPrioridade">
              <option value="">Todas</option>
              <option value="baixa">Baixa</option>
              <option value="normal">Normal</option>
              <option value="alta">Alta</option>
              <option value="critica">Cr√≠tica</option>
            </select>
          </div>
        </div>

        <div class="field-row">
          <div class="field">
            <label class="field-label" for="filterDataDe">De (data limite)</label>
            <input type="date" id="filterDataDe">
          </div>
          <div class="field">
            <label class="field-label" for="filterDataAte">At√© (data limite)</label>
            <input type="date" id="filterDataAte">
          </div>
        </div>

        <div class="toggle-line">
          <span>Mostrar conclu√≠das</span>
          <label class="switch">
            <input type="checkbox" id="filterShowCompleted">
            <span class="slider"></span>
          </label>
        </div>

        <button class="btn" id="applyFiltersBtn" style="margin-top:6px;width:100%;">Aplicar filtros</button>
        <button class="btn" id="clearFiltersBtn" style="
          margin-top:4px;width:100%;
          background:transparent;border-color:rgba(255,255,255,.2);
        ">Limpar</button>

        <p style="margin-top:6px;">Use os filtros para organizar o dia, visitas, chamadas e follow-up.</p>
      </div>

      <!-- Resumo r√°pido -->
      <div class="sidebar-section">
        <h3>Resumo r√°pido</h3>
        <div class="filters-badges" id="summaryBadges"></div>
      </div>

      <div class="sidebar-section">
        <h3>Notas</h3>
        <p>Quando o cadeado est√° em <strong>Bloqueado</strong>, n√£o pode alterar tarefas.</p>
        <p>Ative <strong>Edi√ß√£o ativa</strong> para criar/editar tarefas.</p>
      </div>
    </aside>
    <!-- ===================== √ÅREA PRINCIPAL (Cards, KPI, Banner de origem) ===================== -->

    <main class="cards-area">

      <div class="cards-header">
        <div class="cards-header-left">
          <h2>Tarefas</h2>
          <p>Vis√£o das a√ß√µes comerciais: chamadas, visitas, follow-ups e compromissos ligados ao neg√≥cio.</p>
          <div class="pipeline-kpis" id="pipelineKpis"></div>
        </div>
      </div>

      <!-- Banner de origem (quando tarefas foram abertas via Leads/Vendas) -->
      <div id="originFilterBanner" class="origin-banner" style="display:none;">
        <div>
          üîó <strong id="originFilterLabel"></strong>
        </div>
        <button type="button" id="clearOriginFilterBtn">Limpar filtro de origem</button>
      </div>

      <!-- Grid dos cart√µes -->
      <div id="cardsGrid" class="cards-grid"></div>

      <!-- Estado vazio -->
      <div id="emptyState" class="empty" style="display:none;">
        Ainda n√£o existem tarefas registadas com os filtros atuais.
      </div>

    </main>
  </div> <!-- fecha layout -->


  <!-- ===================== MODAL BASE DE TAREFA ===================== -->

  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal">

      <div class="modal-header">
        <h2 id="modalTitle">Nova Tarefa</h2>
        <button class="btn btn-icon btn-ghost" id="closeModalBtn" title="Fechar">‚úï</button>
      </div>

      <div class="modal-body">
        <form id="taskForm">
          <input type="hidden" id="taskId" />

          <div class="form-grid">

            <!-- ===================== COLUNA 1 ‚Äî Envolvidos & Origem ===================== -->
            <div class="form-section">
              <h3>Envolvidos & Origem</h3>

              <div class="field-row">
                <div class="field">
                  <label class="field-label" for="responsavel">Respons√°vel</label>
                  <select id="responsavel"></select>
                </div>

                <div class="field">
                  <label class="field-label" for="apoio">Apoio / Gestor</label>
                  <select id="apoio"></select>
                </div>
              </div>

              <div class="field-row">

                <div class="field">
                  <label class="field-label" for="origemTipo">Origem</label>
                  <select id="origemTipo">
                    <option value="">‚Äî</option>
                    <option value="lead">Lead</option>
                    <option value="angariacao">Angaria√ß√£o</option>
                    <option value="venda">Venda</option>
                    <option value="interna">Interna</option>
                  </select>
                </div>

                <div class="field">
                  <label class="field-label" for="origemRef">Ref. associada</label>
                  <input type="text" id="origemRef" placeholder="Ex.: REF-123 / Nome cliente" />
                </div>

              </div>

              <div class="field-row">

                <div class="field">
                  <label class="field-label" for="estado">Estado</label>
                  <select id="estado">
                    <option value="por_fazer">Por fazer</option>
                    <option value="em_curso">Em curso</option>
                    <option value="concluida">Conclu√≠da</option>
                    <option value="adiada">Adiada</option>
                    <option value="cancelada">Cancelada</option>
                  </select>
                </div>

                <div class="field">
                  <label class="field-label" for="prioridade">Prioridade</label>
                  <select id="prioridade">
                    <option value="baixa">Baixa</option>
                    <option value="normal" selected>Normal</option>
                    <option value="alta">Alta</option>
                    <option value="critica">Cr√≠tica</option>
                  </select>
                </div>

              </div>

              <div class="field">
                <label class="field-label" for="tipoTarefa">Tipo de tarefa</label>
                <select id="tipoTarefa">
                  <option value="chamada">Chamada telef√≥nica</option>
                  <option value="email">Email</option>
                  <option value="visita">Visita</option>
                  <option value="reuniao">Reuni√£o</option>
                  <option value="followup">Follow-up</option>
                  <option value="outro">Outro</option>
                </select>
              </div>

              <div class="field">
                <label class="field-label" for="tags">Tags / etiquetas</label>
                <input type="text" id="tags" placeholder="Ex.: empreend. X, frio, urgente" />
              </div>

            </div>

            <!-- ===================== COLUNA 2 ‚Äî Detalhes & Datas ===================== -->
            <div class="form-section">
              <h3>Detalhes & Datas</h3>

              <div class="field">
                <label class="field-label" for="titulo">T√≠tulo</label>
                <input type="text" id="titulo" placeholder="Ex.: Agendar visita com propriet√°rios" />
              </div>

              <div class="field">
                <label class="field-label" for="descricao">Descri√ß√£o</label>
                <textarea id="descricao" placeholder="Notas sobre a tarefa, contexto, alinhamento com cliente..."></textarea>
              </div>

              <div class="field-row">
                <div class="field">
                  <label class="field-label" for="dataCriacao">Data cria√ß√£o</label>
                  <input type="date" id="dataCriacao" />
                </div>
                <div class="field">
                  <label class="field-label" for="dataLimite">Data limite</label>
                  <input type="date" id="dataLimite" />
                </div>
              </div>

              <div class="field-row">
                <div class="field">
                  <label class="field-label" for="horaLimite">Hora</label>
                  <input type="time" id="horaLimite" />
                </div>

                <div class="field">
                  <label class="field-label">&nbsp;</label>
                  <small>Use data/hora para organizar visitas e follow-up.</small>
                </div>
              </div>

            </div>

          </div> <!-- fecha form-grid -->
        </form>
      </div>

      <div class="modal-footer">
        <div class="modal-footer-left">
          Dados guardados apenas neste dispositivo (localStorage).
        </div>
        <div>
          <button class="btn btn-ghost" id="cancelModalBtn">Cancelar</button>
          <button class="btn btn-primary" id="saveTaskBtn">Guardar</button>
        </div>
      </div>

    </div> <!-- fecha modal -->
  </div> <!-- fecha modal-backdrop -->
  <!-- ===================== MODAL FICHA ORIGINAL (Lead / Angaria√ß√£o / Venda) ===================== -->

  <div class="modal-backdrop" id="recordModalBackdrop" style="display:none;">
    <div class="modal">

      <div class="modal-header">
        <div>
          <h2 id="recordModalTitle">Ficha original</h2>
          <div id="recordModalSubtitle" style="font-size:11px;color:var(--muted);margin-top:2px;"></div>
        </div>
        <button class="btn btn-icon btn-ghost" id="closeRecordModalBtn" title="Fechar">‚úï</button>
      </div>

      <div class="modal-body">
        <div class="form-grid">

          <!-- COLUNA ESQUERDA: Ficha original (edi√ß√£o gen√©rica) -->
          <div class="form-section">
            <h3>Ficha original</h3>
            <small>Campos provenientes da Lead / Angaria√ß√£o / Venda. Edit√°veis e guardados na origem.</small>

            <div id="recordMainInfo" style="margin-top:6px;margin-bottom:6px;font-size:12px;color:var(--muted);"></div>

            <div id="recordFields" style="display:flex;flex-direction:column;gap:6px;font-size:12px;"></div>
          </div>

          <!-- COLUNA DIREITA: Contexto 360¬∫ (Hist√≥rico + Timeline + Notas) -->
          <div class="form-section">
            <h3>Contexto 360¬∫</h3>
            <small>Hist√≥rico de tarefas, timeline e notas internas sobre este cliente / im√≥vel / promotor.</small>

            <!-- Alertas / avisos r√°pidos -->
            <div id="recordAlerts" style="margin-top:6px;font-size:12px;color:var(--muted);"></div>

            <!-- Sec√ß√£o Hist√≥rico de Tarefas (colapsada por defeito) -->
            <div style="margin-top:10px;">
              <button type="button" class="btn btn-ghost" id="toggleTasksSectionBtn" style="padding:4px 10px;font-size:11px;">
                ‚ñ∂ Hist√≥rico de tarefas
              </button>
              <div id="recordTasksSection" style="margin-top:6px;display:none;">
                <div id="recordTasksList" style="font-size:12px;color:var(--muted);display:flex;flex-direction:column;gap:4px;"></div>
              </div>
            </div>

            <!-- Sec√ß√£o Timeline & Notas (colapsada por defeito) -->
            <div style="margin-top:12px;">
              <button type="button" class="btn btn-ghost" id="toggleTimelineSectionBtn" style="padding:4px 10px;font-size:11px;">
                ‚ñ∂ Timeline & notas
              </button>
              <div id="recordTimelineSection" style="margin-top:6px;display:none;">
                <div id="recordTimeline" style="font-size:12px;color:var(--muted);display:flex;flex-direction:column;gap:6px;"></div>

                <div style="margin-top:8px;">
                  <textarea id="recordNewNote" placeholder="Adicionar nota interna (n√£o cria tarefa)..." style="width:100%;min-height:60px;background:rgba(0,0,0,.7);color:var(--text);border-radius:10px;border:1px solid rgba(163,139,99,.22);padding:6px 8px;font-size:12px;"></textarea>
                  <button type="button" class="btn btn-primary" id="addRecordNoteBtn" style="margin-top:4px;font-size:12px;">
                    <span style="font-size:11px;color:var(--gold);">‚óè</span> Adicionar nota
                  </button>
                </div>
              </div>
            </div>

          </div>

        </div>
      </div>

      <div class="modal-footer">
        <div class="modal-footer-left">
          Edi√ß√£o aplicada √† ficha de origem (Leads / Angaria√ß√µes) e notas guardadas apenas neste dispositivo.
        </div>
        <div>
          <button class="btn btn-ghost" id="saveRecordBtn">Guardar ficha</button>
        </div>
      </div>

    </div>
  </div>

  <!-- ===================== SCRIPT PRINCIPAL ===================== -->

  <script>
  (function(){

    // ========= CONSTANTES DE STORAGE =========
    const STORAGE_KEY           = 'gpp_tarefas_v1';
    const FILTERS_STORAGE_KEY   = 'gpp_tarefas_filters_v1';
    const GLOBAL_FILTERS_KEY    = 'gpp_global_filters_v1';
    const STORAGE_LEADS         = 'gpp_leads_v5';
    const STORAGE_ANG           = 'gpp_angariacoes_v2';
    const TIMELINE_STORAGE_KEY  = 'gpp_timeline_v1';
    const SESSION_ALERT_KEY     = 'gpp_tarefas_alertas_sessao_v1';

    const CONSULTOR_OPTIONS = [
      "Rui Quelhas",
      "Manuel Oliveira",
      "Jo√£o Sousa",
      "Francisco dos Santos",
      "Ros√°rio Vasconcelos",
      "Armanda Meireles",
      "Audrey Lucas",
      "Outro"
    ];

    function $(id){ return document.getElementById(id); }

    // ========= ELEMENTOS DOM PRINCIPAIS =========
    const lockStateLabel   = $('lockStateLabel');
    const toggleLockBtn    = $('toggleLockBtn');
    const newTaskBtn       = $('newTaskBtn');
    const exportCsvBtn     = $('exportCsvBtn');
    const exportPdfBtn     = $('exportPdfBtn');
    const cardsGrid        = $('cardsGrid');
    const emptyState       = $('emptyState');
    const pipelineKpis     = $('pipelineKpis');
    const summaryBadges    = $('summaryBadges');

    const filterResponsavel   = $('filterResponsavel');
    const filterEstado        = $('filterEstado');
    const filterPrioridade    = $('filterPrioridade');
    const filterDataDe        = $('filterDataDe');
    const filterDataAte       = $('filterDataAte');
    const filterShowCompleted = $('filterShowCompleted');
    const applyFiltersBtn     = $('applyFiltersBtn');
    const clearFiltersBtn     = $('clearFiltersBtn');

    const originFilterBanner  = $('originFilterBanner');
    const originFilterLabel   = $('originFilterLabel');
    const clearOriginFilterBtn= $('clearOriginFilterBtn');

    const modalBackdrop   = $('modalBackdrop');
    const modalTitle      = $('modalTitle');
    const closeModalBtn   = $('closeModalBtn');
    const cancelModalBtn  = $('cancelModalBtn');
    const saveTaskBtn     = $('saveTaskBtn');
    const taskForm        = $('taskForm');

    const responsavelSelect = $('responsavel');
    const apoioSelect       = $('apoio');

    // Modal Ficha Original
    const recordModalBackdrop   = $('recordModalBackdrop');
    const recordModalTitle      = $('recordModalTitle');
    const recordModalSubtitle   = $('recordModalSubtitle');
    const recordMainInfo        = $('recordMainInfo');
    const recordFields          = $('recordFields');
    const recordAlerts          = $('recordAlerts');
    const recordTasksSection    = $('recordTasksSection');
    const recordTasksList       = $('recordTasksList');
    const recordTimelineSection = $('recordTimelineSection');
    const recordTimeline        = $('recordTimeline');
    const recordNewNote         = $('recordNewNote');
    const addRecordNoteBtn      = $('addRecordNoteBtn');
    const toggleTasksSectionBtn = $('toggleTasksSectionBtn');
    const toggleTimelineSectionBtn = $('toggleTimelineSectionBtn');
    const closeRecordModalBtn   = $('closeRecordModalBtn');
    const saveRecordBtn         = $('saveRecordBtn');

    // ========= ESTADO =========
    let state = {
      locked: true,
      tasks: []
    };

    // Filtros (inclui origem escondida)
    let FILTERS = {
      responsavel: '',
      estado: '',
      prioridade: '',
      de: '',
      ate: '',
      showCompleted: false,
      origemTipo: '',
      origemRef: ''
    };

    let allLeads = [];
    let allDeals = [];
    let angRaw   = null;   // objeto bruto de angaria√ß√µes (para re-gravar)

    let timelineStore = {};
    let alertedMap    = loadAlertedMap();

    let currentRecordContext = null; // { tipo, task, record, index, key, clienteNome, promotorNome }

    // ========= HELPERS DE DATA =========
    function todayISO(){
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return y + '-' + m + '-' + day;
    }

    function addDaysToISO(iso, days){
      if(!iso) return '';
      const d = new Date(iso + 'T00:00:00');
      if(isNaN(d)) return iso;
      d.setDate(d.getDate() + days);
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return y + '-' + m + '-' + day;
    }

    function daysFromToday(iso){
      if(!iso) return null;
      const today = new Date();
      today.setHours(0,0,0,0);
      const d = new Date(iso + 'T00:00:00');
      if(isNaN(d)) return null;
      const diffMs = d.getTime() - today.getTime();
      return Math.round(diffMs / (24*60*60*1000));
    }

    // ========= STORAGE AUX =========
    function loadState(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(raw){
          const parsed = JSON.parse(raw);
          if(Array.isArray(parsed.tasks)){
            state.tasks = parsed.tasks;
          }
          state.locked = parsed.locked !== false;
        }
      }catch(e){
        console.error('Erro ao carregar storage tarefas', e);
      }
      updateLockUI();
    }

    function saveState(){
      try{
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      }catch(e){
        console.error('Erro ao guardar storage tarefas', e);
      }
    }

    function loadFiltersFromStorage(){
      try{
        const raw = localStorage.getItem(FILTERS_STORAGE_KEY);
        if(!raw) return;
        const parsed = JSON.parse(raw);
        if(parsed && typeof parsed === 'object'){
          FILTERS = Object.assign({}, FILTERS, parsed);
        }
      }catch(e){
        console.error('Erro a carregar filtros de tarefas', e);
      }
    }

    function saveFiltersToStorage(){
      try{
        localStorage.setItem(FILTERS_STORAGE_KEY, JSON.stringify(FILTERS));
      }catch(e){
        console.error('Erro a guardar filtros de tarefas', e);
      }
    }

    function loadGlobalFiltersFallback(){
      if(FILTERS.responsavel || FILTERS.de || FILTERS.ate) return;
      try{
        const raw = localStorage.getItem(GLOBAL_FILTERS_KEY);
        if(!raw) return;
        const g = JSON.parse(raw) || {};
        if(!FILTERS.responsavel && g.consultor) FILTERS.responsavel = g.consultor;
        if(!FILTERS.de && g.de) FILTERS.de = g.de;
        if(!FILTERS.ate && g.ate) FILTERS.ate = g.ate;
      }catch(e){
        console.error('Erro a carregar filtros globais', e);
      }
    }

    function syncGlobalFiltersFromTasks(){
      const g = {
        consultor: FILTERS.responsavel || '',
        de: FILTERS.de || '',
        ate: FILTERS.ate || ''
      };
      try{
        localStorage.setItem(GLOBAL_FILTERS_KEY, JSON.stringify(g));
      }catch(e){
        console.error('Erro a guardar filtros globais', e);
      }
    }

    function applyFiltersToControls(){
      filterResponsavel.value   = FILTERS.responsavel || '';
      filterEstado.value        = FILTERS.estado || '';
      filterPrioridade.value    = FILTERS.prioridade || '';
      filterDataDe.value        = FILTERS.de || '';
      filterDataAte.value       = FILTERS.ate || '';
      filterShowCompleted.checked = !!FILTERS.showCompleted;
    }

    function updateFiltersFromControls(){
      FILTERS.responsavel   = filterResponsavel.value || '';
      FILTERS.estado        = filterEstado.value || '';
      FILTERS.prioridade    = filterPrioridade.value || '';
      FILTERS.de            = filterDataDe.value || '';
      FILTERS.ate           = filterDataAte.value || '';
      FILTERS.showCompleted = filterShowCompleted.checked;
    }

    function clearFilters(){
      FILTERS = {
        responsavel:'',
        estado:'',
        prioridade:'',
        de:'',
        ate:'',
        showCompleted:false,
        origemTipo:'',
        origemRef:''
      };
      applyFiltersToControls();
      saveFiltersToStorage();
      syncGlobalFiltersFromTasks();
    }

    // ========= ALERTAS EM SESS√ÉO =========
    function loadAlertedMap(){
      try{
        const raw = sessionStorage.getItem(SESSION_ALERT_KEY);
        if(!raw) return {};
        const obj = JSON.parse(raw);
        return obj && typeof obj === 'object' ? obj : {};
      }catch(e){
        return {};
      }
    }
    function saveAlertedMap(){
      try{
        sessionStorage.setItem(SESSION_ALERT_KEY, JSON.stringify(alertedMap));
      }catch(e){}
    }

    // ========= LEADS & ANGARIA√á√ïES =========
    function loadLeads(){
      try{
        const raw = localStorage.getItem(STORAGE_LEADS);
        const parsed = raw ? JSON.parse(raw) : [];
        allLeads = Array.isArray(parsed) ? parsed : [];
      }catch(e){
        console.error('Erro a ler leads:', e);
        allLeads = [];
      }
    }

    function loadDeals(){
      try{
        const raw = localStorage.getItem(STORAGE_ANG);
        const parsed = raw ? JSON.parse(raw) : {};
        angRaw   = parsed && typeof parsed === 'object' ? parsed : {};
        allDeals = Array.isArray(angRaw.deals) ? angRaw.deals : [];
      }catch(e){
        console.error('Erro a ler angaria√ß√µes:', e);
        angRaw = {};
        allDeals = [];
      }
    }

    // Timeline (notas internas s√≥)
    function loadTimelineStore(){
      try{
        const raw = localStorage.getItem(TIMELINE_STORAGE_KEY);
        const parsed = raw ? JSON.parse(raw) : {};
        timelineStore = (parsed && typeof parsed === 'object') ? parsed : {};
      }catch(e){
        timelineStore = {};
      }
    }
    function saveTimelineStore(){
      try{
        localStorage.setItem(TIMELINE_STORAGE_KEY, JSON.stringify(timelineStore));
      }catch(e){}
    }

    // ========= CONSULTOR / LOCK =========
    function initConsultores(){
      CONSULTOR_OPTIONS.forEach(name=>{
        const opt1 = document.createElement('option');
        opt1.value = name; opt1.textContent = name;
        responsavelSelect.appendChild(opt1);

        const opt2 = document.createElement('option');
        opt2.value = name; opt2.textContent = name;
        apoioSelect.appendChild(opt2);

        const opt3 = document.createElement('option');
        opt3.value = name; opt3.textContent = name;
        filterResponsavel.appendChild(opt3);
      });
    }

    function updateLockUI(){
      if(state.locked){
        lockStateLabel.textContent = 'Bloqueado';
        toggleLockBtn.textContent  = 'üîí';
        newTaskBtn.disabled = true;
      }else{
        lockStateLabel.textContent = 'Edi√ß√£o ativa';
        toggleLockBtn.textContent  = 'üîì';
        newTaskBtn.disabled = false;
      }
    }

    // ========= CONTEXTO URL (vindo de Leads / Angaria√ß√µes / Vendas) =========
    function applyUrlContext(){
      try{
        const params    = new URLSearchParams(window.location.search);
        const origem    = (params.get('origem') || '').trim();
        const ref       = (params.get('ref') || '').trim();
        const consultor = (params.get('consultor') || '').trim();
        const nova      = (params.get('nova') || '').trim(); // "1" => abrir modal de nova tarefa

        if(consultor && !FILTERS.responsavel){
          FILTERS.responsavel = consultor;
        }

        if(origem || ref){
          FILTERS.origemTipo = origem || '';
          FILTERS.origemRef  = ref || '';
        }

        // Se veio "nova tarefa" pedida a partir de outro m√≥dulo
        if(nova === '1'){
          if(state.locked){
            setTimeout(()=>{
              alert('Para criar uma nova tarefa associada, ative "Edi√ß√£o ativa" (cadeado no topo).');
            }, 300);
          }else{
            openModal(null);
            if(origem) $('origemTipo').value = origem;
            if(ref)    $('origemRef').value  = ref;
            if(consultor) responsavelSelect.value = consultor;
          }
        }
      }catch(e){
        console.error('Erro a interpretar par√¢metros da URL em tarefas', e);
      }
    }

    // ========= LABELS / CLASSES =========
    function estadoLabel(e){
      return {
        por_fazer:'Por fazer',
        em_curso:'Em curso',
        concluida:'Conclu√≠da',
        adiada:'Adiada',
        cancelada:'Cancelada'
      }[e] || '‚Äî';
    }
    function prioridadeLabel(p){
      return {
        baixa:'Baixa',
        normal:'Normal',
        alta:'Alta',
        critica:'Cr√≠tica'
      }[p] || '‚Äî';
    }
    function tipoLabel(t){
      return {
        chamada:'Chamada',
        email:'Email',
        visita:'Visita',
        reuniao:'Reuni√£o',
        followup:'Follow-up',
        outro:'Outro'
      }[t] || '‚Äî';
    }
    function origemLabel(tipo){
      return {
        lead:'Lead',
        angariacao:'Angaria√ß√£o',
        venda:'Venda',
        interna:'Interna'
      }[tipo] || '';
    }

    function prioridadeClass(p){
      if(p === 'critica') return 'chip-red';
      if(p === 'alta')    return 'chip-yellow';
      if(p === 'baixa')   return 'chip';
      return 'chip-primary';
    }
    function estadoClass(e){
      if(e === 'concluida')                return 'chip-green';
      if(e === 'adiada' || e === 'cancelada') return 'chip-red';
      if(e === 'em_curso')                 return 'chip-yellow';
      return 'chip-primary';
    }

    // ========= URG√äNCIA DAS TAREFAS =========
    function getUrgencyMeta(task){
      if(!task || !task.dataLimite) return {score:9999, level:'none'};
      if(task.estado === 'concluida' || task.estado === 'cancelada'){
        return {score:9999, level:'done'};
      }
      const d = daysFromToday(task.dataLimite);
      if(d === null) return {score:9999, level:'none'};

      let level = 'low';
      if(d < 0) level = 'overdue';
      else if(d === 0) level = 'due';
      else if(d <= 2) level = 'high';
      else if(d <= 5) level = 'medium';
      else level = 'low';

      return {score: d, level};
    }

    function applyUrgencyStyles(card, meta){
      if(!meta) return;
      if(meta.level === 'none' || meta.level === 'done') return;

      if(meta.level === 'overdue'){
        card.style.borderColor = 'rgba(242,95,92,0.9)';
        card.style.boxShadow   = '0 0 0 1px rgba(242,95,92,0.5), 0 18px 40px rgba(0,0,0,0.9)';
        card.style.background  = 'radial-gradient(circle at top left,#3b1111,#070707)';
      }else if(meta.level === 'due'){
        card.style.borderColor = 'rgba(242,95,92,0.8)';
        card.style.boxShadow   = '0 0 0 1px rgba(242,95,92,0.35), 0 18px 35px rgba(0,0,0,0.85)';
        card.style.background  = 'radial-gradient(circle at top left,#361616,#070707)';
      }else if(meta.level === 'high'){
        card.style.borderColor = 'rgba(255,200,87,0.9)';
        card.style.boxShadow   = '0 0 0 1px rgba(255,200,87,0.35), 0 18px 30px rgba(0,0,0,0.8)';
        card.style.background  = 'radial-gradient(circle at top left,#3b2b11,#070707)';
      }else if(meta.level === 'medium'){
        card.style.borderColor = 'rgba(163,139,99,0.9)';
        card.style.boxShadow   = '0 0 0 1px rgba(163,139,99,0.35), 0 18px 30px rgba(0,0,0,0.75)';
      }
    }

    // ========= FILTROS =========
    function applyFilters(tasks){
      const resp          = FILTERS.responsavel || '';
      const est           = FILTERS.estado || '';
      const prio          = FILTERS.prioridade || '';
      const from          = FILTERS.de || '';
      const to            = FILTERS.ate || '';
      const showCompleted = !!FILTERS.showCompleted;
      const oTipo         = FILTERS.origemTipo || '';
      const oRef          = (FILTERS.origemRef || '').toLowerCase();

      return tasks.filter(t=>{
        if(resp && t.responsavel !== resp) return false;
        if(est  && t.estado      !== est)  return false;
        if(prio && t.prioridade  !== prio) return false;

        if(!showCompleted && (t.estado === 'concluida' || t.estado === 'cancelada')){
          return false;
        }

        if(from && t.dataLimite && t.dataLimite < from) return false;
        if(to   && t.dataLimite && t.dataLimite > to)   return false;

        if(oTipo && t.origemTipo !== oTipo) return false;
        if(oRef){
          const tref = (t.origemRef || '').toLowerCase();
          if(!tref.includes(oRef)) return false;
        }

        return true;
      });
    }

    function renderOriginBanner(){
      if(FILTERS.origemTipo || FILTERS.origemRef){
        const parts = [];
        if(FILTERS.origemTipo){
          parts.push('Origem: ' + origemLabel(FILTERS.origemTipo));
        }
        if(FILTERS.origemRef){
          parts.push('Ref.: ' + FILTERS.origemRef);
        }
        originFilterLabel.textContent = parts.join(' ¬∑ ');
        originFilterBanner.style.display = 'flex';
      }else{
        originFilterBanner.style.display = 'none';
      }
    }

    // ========= MODAL TAREFA =========
    function openModal(task){
      modalBackdrop.classList.add('open');

      if(task){
        modalTitle.textContent = 'Editar Tarefa';
        $('taskId').value      = task.id || '';
        responsavelSelect.value= task.responsavel || '';
        apoioSelect.value      = task.apoio || '';
        $('origemTipo').value  = task.origemTipo || '';
        $('origemRef').value   = task.origemRef || '';
        $('estado').value      = task.estado || 'por_fazer';
        $('prioridade').value  = task.prioridade || 'normal';
        $('tipoTarefa').value  = task.tipoTarefa || 'chamada';
        $('tags').value        = task.tags || '';
        $('titulo').value      = task.titulo || '';
        $('descricao').value   = task.descricao || '';
        $('dataCriacao').value = task.dataCriacao || '';
        $('dataLimite').value  = task.dataLimite || '';
        $('horaLimite').value  = task.horaLimite || '';
      }else{
        modalTitle.textContent = 'Nova Tarefa';
        taskForm.reset();
        $('taskId').value      = '';
        const hoje = todayISO();
        $('dataCriacao').value = hoje;
        // Por defeito: data limite = hoje + 8 dias
        $('dataLimite').value  = addDaysToISO(hoje, 8);
      }
    }

    function closeModal(){
      modalBackdrop.classList.remove('open');
    }

    function ensureDeadlineValid(dataCriacao, dataLimite){
      if(!dataCriacao || !dataLimite) return true;
      return dataLimite > dataCriacao;
    }

    function collectFormData(){
      const id = $('taskId').value || 'task_' + Date.now();

      let dataCriacao = $('dataCriacao').value;
      if(!dataCriacao){
        dataCriacao = todayISO();
      }
      let dataLimite = $('dataLimite').value;
      if(dataLimite && !ensureDeadlineValid(dataCriacao, dataLimite)){
        alert('A data limite deve ser posterior √† data de cria√ß√£o.');
        return null;
      }

      const data = {
        id,
        responsavel:  responsavelSelect.value || '',
        apoio:        apoioSelect.value || '',
        origemTipo:   $('origemTipo').value || '',
        origemRef:    $('origemRef').value || '',
        estado:       $('estado').value || 'por_fazer',
        prioridade:   $('prioridade').value || 'normal',
        tipoTarefa:   $('tipoTarefa').value || 'chamada',
        tags:         $('tags').value || '',
        titulo:       $('titulo').value || '',
        descricao:    $('descricao').value || '',
        dataCriacao:  dataCriacao,
        dataLimite:   dataLimite || '',
        horaLimite:   $('horaLimite').value || '',
        createdAtMs:  Date.now()
      };

      return data;
    }

    // ========= RECORD / FICHA ORIGINAL (MODAL PREMIUM) =========

    function guessClienteNome(record){
      if(!record || typeof record !== 'object') return '';
      return record.nomeCliente || record.nome || record.cliente || record.proprietario || '';
    }

    function guessPromotorNome(record){
      if(!record || typeof record !== 'object') return '';
      return record.promotor || record.promoter || record.empresa || record.entidade || '';
    }

    function buildRecordKey(task, record){
      const tipo = task.origemTipo || 'interno';
      if(record){
        if(record.id)   return tipo + ':' + String(record.id);
        if(record.ref)  return tipo + ':' + String(record.ref);
        if(record.codigo) return tipo + ':' + String(record.codigo);
      }
      if(task.origemRef){
        return tipo + ':' + task.origemRef.toLowerCase();
      }
      return tipo + ':sem_ref';
    }

    function findRecordContext(task){
      if(!task || !task.origemTipo) return null;
      const tipo = task.origemTipo;
      const ref  = (task.origemRef || '').toLowerCase();

      if(!ref) return null;

      if(tipo === 'lead'){
        let idx = -1;
        for(let i=0;i<allLeads.length;i++){
          const l = allLeads[i] || {};
          const cands = [
            l.ref, l.referencia, l.codigo, l.codigoInterno,
            l.nome, l.nomeCliente, l.cliente
          ];
          if(cands.some(v=>{
            if(!v) return false;
            const s = String(v).toLowerCase();
            return ref.includes(s) || s.includes(ref);
          })){
            idx = i; break;
          }
        }
        if(idx === -1) return null;
        const record = allLeads[idx];
        return {
          tipo: 'lead',
          task,
          record,
          index: idx,
          key: buildRecordKey(task, record),
          clienteNome: guessClienteNome(record),
          promotorNome: guessPromotorNome(record)
        };
      }

      if(tipo === 'angariacao'){
        let idx = -1;
        for(let i=0;i<allDeals.length;i++){
          const d = allDeals[i] || {};
          const cands = [
            d.ref, d.referencia, d.codigo, d.codigoInterno,
            d.imovel, d.nomeImovel, d.emp, d.empreendimento
          ];
          if(cands.some(v=>{
            if(!v) return false;
            const s = String(v).toLowerCase();
            return ref.includes(s) || s.includes(ref);
          })){
            idx = i; break;
          }
        }
        if(idx === -1) return null;
        const record = allDeals[idx];
        return {
          tipo: 'angariacao',
          task,
          record,
          index: idx,
          key: buildRecordKey(task, record),
          clienteNome: guessClienteNome(record),
          promotorNome: guessPromotorNome(record)
        };
      }

      // Para venda / interna, mantemos gen√©rico
      return {
        tipo: tipo,
        task,
        record: null,
        index: -1,
        key: buildRecordKey(task, null),
        clienteNome: '',
        promotorNome: ''
      };
    }

    function isTaskRelatedToContext(task, ctx){
      if(!task || !ctx) return false;
      if(task.id === ctx.task.id) return true;
      if(task.origemTipo !== ctx.tipo) return false;

      const baseRef   = (ctx.task.origemRef || '').toLowerCase();
      const otherRef  = (task.origemRef || '').toLowerCase();
      const cliente   = (ctx.clienteNome || '').toLowerCase();
      const promotor  = (ctx.promotorNome || '').toLowerCase();

      if(baseRef && otherRef && (baseRef.includes(otherRef) || otherRef.includes(baseRef))){
        return true;
      }
      if(cliente && otherRef.includes(cliente)) return true;
      if(promotor && otherRef.includes(promotor)) return true;

      return false;
    }

    function openRecordModalForTask(task){
      if(!task || !task.origemTipo){
        alert('Esta tarefa n√£o est√° ligada a uma Lead / Angaria√ß√£o / Venda.');
        return;
      }

      const ctx = findRecordContext(task);
      if(!ctx){
        alert('N√£o foi poss√≠vel localizar a ficha original associada a esta tarefa.');
        return;
      }

      currentRecordContext = ctx;

      // Cabe√ßalho
      const tipoLabel = origemLabel(ctx.tipo) || ctx.tipo;
      recordModalTitle.textContent = 'Ficha ' + tipoLabel;

      const subParts = [];
      if(ctx.task.origemRef) subParts.push(ctx.task.origemRef);
      if(ctx.clienteNome)    subParts.push('Cliente: ' + ctx.clienteNome);
      if(ctx.promotorNome)   subParts.push('Promotor: ' + ctx.promotorNome);
      recordModalSubtitle.textContent = subParts.join(' ¬∑ ');

      // Info principal
      recordMainInfo.innerHTML = '';
      const infoLines = [];
      if(ctx.clienteNome) infoLines.push('<strong>Cliente:</strong> ' + ctx.clienteNome);
      if(ctx.promotorNome)infoLines.push('<strong>Promotor:</strong> ' + ctx.promotorNome);
      if(ctx.tipo === 'lead' && ctx.record && ctx.record.estado){
        infoLines.push('<strong>Estado lead:</strong> ' + ctx.record.estado);
      }
      if(ctx.tipo === 'angariacao' && ctx.record && ctx.record.estadoAng){
        infoLines.push('<strong>Estado angaria√ß√£o:</strong> ' + ctx.record.estadoAng);
      }
      if(!infoLines.length) infoLines.push('Ficha ligada √† origem: ' + tipoLabel + '.');
      recordMainInfo.innerHTML = infoLines.join('<br>');

      // Campos edit√°veis da ficha
      renderRecordFields(ctx);

      // Alertas / consist√™ncia simples
      renderRecordAlerts(ctx);

      // Hist√≥rico de tarefas relacionadas
      renderRecordTasks(ctx);

      // Timeline + notas
      renderRecordTimeline(ctx);

      // Sec√ß√µes colapsadas por defeito
      recordTasksSection.style.display    = 'none';
      recordTimelineSection.style.display = 'none';

      recordModalBackdrop.style.display = 'flex';
    }

    function closeRecordModal(){
      recordModalBackdrop.style.display = 'none';
      currentRecordContext = null;
    }

    function renderRecordFields(ctx){
      recordFields.innerHTML = '';

      const record = ctx.record;
      if(!record || typeof record !== 'object'){
        const span = document.createElement('div');
        span.style.fontSize = '12px';
        span.style.color    = 'var(--muted)';
        span.textContent    = 'Ficha sem campos estruturados dispon√≠veis (registo gen√©rico).';
        recordFields.appendChild(span);
        return;
      }

      const keys = Object.keys(record).filter(k=>!['createdAtMs','updatedAtMs'].includes(k));

      keys.forEach(key=>{
        const val = record[key];
        if(typeof val === 'object') return; // simplifica√ß√£o

        const wrapper = document.createElement('div');
        wrapper.className = 'field';

        const lbl = document.createElement('label');
        lbl.className = 'field-label';
        lbl.textContent = key;
        wrapper.appendChild(lbl);

        const inp = document.createElement('input');
        inp.type  = 'text';
        inp.value = (val === null || val === undefined) ? '' : String(val);
        inp.setAttribute('data-field', key);
        wrapper.appendChild(inp);

        recordFields.appendChild(wrapper);
      });
    }

    function renderRecordAlerts(ctx){
      recordAlerts.innerHTML = '';

      const msgs = [];

      if(ctx.tipo === 'lead' && ctx.record){
        if(!ctx.record.imovel && !ctx.record.imovelRef && !ctx.record.tipologia){
          msgs.push('Lead sem im√≥vel/tipologia associada ‚Äî completar informa√ß√£o para avan√ßar no pipeline.');
        }
        if(!ctx.record.telefone && !ctx.record.telemovel && !ctx.record.email){
          msgs.push('Dados de contacto em falta ‚Äî dif√≠cil prosseguir follow-up.');
        }
      }

      if(ctx.tipo === 'angariacao' && ctx.record){
        if(!ctx.record.precoPedido){
          msgs.push('Angaria√ß√£o sem pre√ßo definido ‚Äî aten√ß√£o ao posicionamento no mercado.');
        }
        if(!ctx.record.comissao && !ctx.record.comissaoOutro){
          msgs.push('Comiss√£o n√£o definida ‚Äî rever condi√ß√µes com o propriet√°rio/promotor.');
        }
      }

      if(!msgs.length){
        const span = document.createElement('div');
        span.textContent = 'Sem alertas cr√≠ticos nesta ficha.';
        span.style.fontSize = '12px';
        span.style.color    = 'var(--muted)';
        recordAlerts.appendChild(span);
        return;
      }

      msgs.forEach(m=>{
        const div = document.createElement('div');
        div.style.fontSize = '12px';
        div.style.color    = 'var(--muted)';
        div.textContent    = '‚ö† ' + m;
        recordAlerts.appendChild(div);
      });
    }

    function renderRecordTasks(ctx){
      recordTasksList.innerHTML = '';

      const related = state.tasks.filter(t=> isTaskRelatedToContext(t, ctx));

      if(!related.length){
        const div = document.createElement('div');
        div.textContent = 'Sem tarefas associadas a esta ficha.';
        recordTasksList.appendChild(div);
        return;
      }

      related.sort((a,b)=>{
        // mais recentes primeiro
        const da = a.dataCriacao || '';
        const db = b.dataCriacao || '';
        if(da && db) return db.localeCompare(da);
        return (b.createdAtMs||0) - (a.createdAtMs||0);
      });

      related.forEach(t=>{
        const row = document.createElement('div');
        row.style.display        = 'flex';
        row.style.justifyContent = 'space-between';
        row.style.gap            = '6px';
        row.style.alignItems     = 'center';

        const left = document.createElement('div');
        left.style.flex = '1';
        left.style.minWidth = '0';
        left.innerHTML = '<strong>'+(t.titulo || '(Sem t√≠tulo)')+'</strong><br><span style="font-size:11px;color:var(--muted);">'+
          (t.dataLimite || t.dataCriacao || '')+' ¬∑ '+estadoLabel(t.estado)+' ¬∑ '+prioridadeLabel(t.prioridade)+'</span>';

        const btn = document.createElement('button');
        btn.className = 'btn-xs';
        btn.innerHTML = 'Abrir tarefa';
        btn.addEventListener('click', ()=>{
          if(state.locked){
            alert('Ative "Edi√ß√£o ativa" para editar tarefas.');
            return;
          }
          openModal(t);
        });

        row.appendChild(left);
        row.appendChild(btn);
        recordTasksList.appendChild(row);
      });
    }

    function renderRecordTimeline(ctx){
      recordTimeline.innerHTML = '';

      const events = [];

      // Evento base: cria√ß√£o da lead/angaria√ß√£o se houver data
      if(ctx.tipo === 'lead' && ctx.record && ctx.record.data){
        events.push({
          type: 'evento',
          when: ctx.record.data,
          label: 'Lead criada',
          detail: ''
        });
      }
      if(ctx.tipo === 'angariacao' && ctx.record && ctx.record.dataAngariacao){
        events.push({
          type: 'evento',
          when: ctx.record.dataAngariacao,
          label: 'Angaria√ß√£o criada',
          detail: ''
        });
      }

      // Eventos de tarefas
      const related = state.tasks.filter(t=> isTaskRelatedToContext(t, ctx));
      related.forEach(t=>{
        const when = t.dataCriacao || t.dataLimite || '';
        events.push({
          type: 'tarefa',
          when,
          label: 'Tarefa: ' + (t.titulo || '(Sem t√≠tulo)'),
          detail: estadoLabel(t.estado)+' ¬∑ '+prioridadeLabel(t.prioridade)
        });
      });

      // Notas internas do timelineStore
      const key = ctx.key;
      const notes = timelineStore[key] || [];
      notes.forEach(n=>{
        events.push({
          type: 'nota',
          when: (n.when || '').substring(0,10),
          label: 'Nota interna',
          detail: n.text || ''
        });
      });

      // Ordenar por data ascendente
      events.sort((a,b)=>{
        const da = a.when || '';
        const db = b.when || '';
        return da.localeCompare(db);
      });

      if(!events.length){
        const div = document.createElement('div');
        div.textContent = 'Sem eventos registados na timeline.';
        recordTimeline.appendChild(div);
        return;
      }

      events.forEach(ev=>{
        const item = document.createElement('div');
        item.style.padding      = '4px 6px';
        item.style.borderRadius = '10px';
        item.style.border       = '1px solid rgba(163,139,99,0.25)';
        item.style.cursor       = 'pointer';

        const header = document.createElement('div');
        header.style.fontSize = '11px';
        header.style.color    = 'var(--muted)';
        const icon = '<span style="color:var(--gold);font-size:11px;">‚óè</span>';
        header.innerHTML = icon + ' ' + (ev.when || '‚Äî') + ' ¬∑ ' + ev.label;

        const body = document.createElement('div');
        body.style.fontSize = '12px';
        body.style.color    = '#f5f5f5';
        body.textContent    = ev.detail || '';

        item.appendChild(header);
        if(ev.detail){
          item.appendChild(body);
        }

        item.addEventListener('click', ()=>{
          const txt = (ev.when || '') + ' ‚Äî ' + ev.label + (ev.detail ? '\n\n' + ev.detail : '');
          alert(txt);
        });

        recordTimeline.appendChild(item);
      });
    }

    function addNoteToCurrentRecord(){
      if(!currentRecordContext) return;
      const text = (recordNewNote.value || '').trim();
      if(!text){
        alert('Escreva uma nota antes de adicionar.');
        return;
      }
      const key = currentRecordContext.key;
      if(!timelineStore[key]) timelineStore[key] = [];
      timelineStore[key].push({
        type:'nota',
        when: new Date().toISOString(),
        text
      });
      saveTimelineStore();
      recordNewNote.value = '';
      renderRecordTimeline(currentRecordContext);
    }

    function saveCurrentRecordEdits(){
      if(!currentRecordContext) return;

      const ctx    = currentRecordContext;
      const record = ctx.record;
      if(!record || typeof record !== 'object'){
        alert('Ficha de origem gen√©rica ‚Äî nada para guardar.');
        return;
      }

      // Recolher inputs
      const inputs = recordFields.querySelectorAll('input[data-field]');
      inputs.forEach(inp=>{
        const field = inp.getAttribute('data-field');
        if(!field) return;
        record[field] = inp.value;
      });

      if(ctx.tipo === 'lead'){
        if(ctx.index >=0 && ctx.index < allLeads.length){
          allLeads[ctx.index] = record;
          try{
            localStorage.setItem(STORAGE_LEADS, JSON.stringify(allLeads));
          }catch(e){
            console.error('Erro a gravar leads', e);
          }
        }
      }else if(ctx.tipo === 'angariacao'){
        if(!angRaw || typeof angRaw !== 'object'){
          angRaw = {};
        }
        if(!Array.isArray(angRaw.deals)){
          angRaw.deals = allDeals;
        }
        if(ctx.index >=0 && ctx.index < allDeals.length){
          allDeals[ctx.index] = record;
        }
        try{
          localStorage.setItem(STORAGE_ANG, JSON.stringify(angRaw));
        }catch(e){
          console.error('Erro a gravar angaria√ß√µes', e);
        }
      }

      alert('Ficha de origem atualizada com sucesso.');
    }

    // ========= RENDERIZA√á√ÉO DOS CART√ïES =========
    function renderCards(){
      // ordenar por urg√™ncia + data
      const tasks = state.tasks.slice().sort((a,b)=>{
        const ua = getUrgencyMeta(a);
        const ub = getUrgencyMeta(b);
        if(ua.score !== ub.score) return ua.score - ub.score;

        const da = a.dataLimite || '';
        const db = b.dataLimite || '';
        if(da && db) return da.localeCompare(db);
        if(da && !db) return -1;
        if(!da && db) return 1;
        return (a.createdAtMs || 0) - (b.createdAtMs || 0);
      });

      const filtered = applyFilters(tasks);
      cardsGrid.innerHTML = '';

      renderOriginBanner();

      if(!filtered.length){
        emptyState.style.display = 'block';
      }else{
        emptyState.style.display = 'none';
      }

      // KPIs gerais
      let total = tasks.length;
      let porEstado = {por_fazer:0,em_curso:0,concluida:0,adiada:0,cancelada:0};
      tasks.forEach(t=>{
        if(porEstado[t.estado] !== undefined) porEstado[t.estado]++;
      });

      summaryBadges.innerHTML = '';
      const badge1 = document.createElement('div');
      badge1.className = 'badge';
      badge1.innerHTML = 'Total tarefas <strong>'+ total +'</strong>';
      summaryBadges.appendChild(badge1);

      const badge2 = document.createElement('div');
      const abertas = tasks.filter(t=>t.estado!=='concluida' && t.estado!=='cancelada').length;
      badge2.className = 'badge';
      badge2.innerHTML = 'Em aberto <strong>'+ abertas +'</strong>';
      summaryBadges.appendChild(badge2);

      const porRespFiltrado = {};
      filtered.forEach(t=>{
        if(!t.responsavel) return;
        porRespFiltrado[t.responsavel] = (porRespFiltrado[t.responsavel] || 0) + 1;
      });
      Object.keys(porRespFiltrado).sort().forEach(n=>{
        const b = document.createElement('div');
        b.className = 'badge';
        b.innerHTML = '<strong>'+n+':</strong> ' + porRespFiltrado[n];
        summaryBadges.appendChild(b);
      });

      pipelineKpis.innerHTML = '';
      ['por_fazer','em_curso','concluida','adiada','cancelada'].forEach(k=>{
        const chip = document.createElement('div');
        chip.className = 'kpi-chip';
        chip.innerHTML = estadoLabel(k) + '<span class="value">'+porEstado[k]+'</span>';
        pipelineKpis.appendChild(chip);
      });

      // Notifica√ß√µes para tarefas no limite / em atraso
      const alertsToShow = [];

      filtered.forEach(t=>{
        const card = document.createElement('div');
        card.className = 'card' + ((t.estado === 'concluida' || t.estado === 'cancelada') ? ' completed':'');
        card.dataset.id = t.id;

        const urgency = getUrgencyMeta(t);
        applyUrgencyStyles(card, urgency);

        // Selo de atraso / limite
        if(urgency.level === 'overdue' || urgency.level === 'due'){
          const badgeTop = document.createElement('div');
          badgeTop.className = 'chip chip-red';
          badgeTop.textContent = urgency.level === 'overdue' ? '‚ö† Em atraso' : '‚ö† Data limite hoje';
          badgeTop.style.marginBottom = '4px';
          card.appendChild(badgeTop);

          if(!alertedMap[t.id]){
            alertsToShow.push(t.titulo || '(Sem t√≠tulo)');
            alertedMap[t.id] = true;
          }
        }

        const topRow = document.createElement('div');
        topRow.className = 'card-top-row';

        const titleBlock = document.createElement('div');
        titleBlock.className = 'card-title-block';

        const h3 = document.createElement('h3');
        h3.className = 'card-title';
        h3.textContent = t.titulo || '(Sem t√≠tulo)';
        titleBlock.appendChild(h3);

        const subtitle = document.createElement('div');
        subtitle.className = 'card-subtitle';
        const linhaSub = [
          t.responsavel || '',
          prioridadeLabel(t.prioridade),
          estadoLabel(t.estado)
        ].filter(Boolean).join(' ¬∑ ');
        subtitle.textContent = linhaSub;
        titleBlock.appendChild(subtitle);

        const chipsRow = document.createElement('div');
        chipsRow.className = 'chip-row';

        const chipEst = document.createElement('span');
        chipEst.className = 'chip ' + estadoClass(t.estado);
        chipEst.textContent = estadoLabel(t.estado);
        chipsRow.appendChild(chipEst);

        const chipPrio = document.createElement('span');
        chipPrio.className = 'chip ' + prioridadeClass(t.prioridade);
        chipPrio.textContent = prioridadeLabel(t.prioridade);
        chipsRow.appendChild(chipPrio);

        if(t.tipoTarefa){
          const ch = document.createElement('span');
          ch.className = 'chip';
          ch.textContent = tipoLabel(t.tipoTarefa);
          chipsRow.appendChild(ch);
        }

        if(t.origemTipo){
          const ch = document.createElement('span');
          ch.className = 'chip';
          ch.textContent = origemLabel(t.origemTipo);
          chipsRow.appendChild(ch);
        }

        if(t.tags){
          const ch = document.createElement('span');
          ch.className = 'chip';
          ch.textContent = t.tags;
          chipsRow.appendChild(ch);
        }

        titleBlock.appendChild(chipsRow);
        topRow.appendChild(titleBlock);
        card.appendChild(topRow);

        // Origem
        if(t.origemTipo || t.origemRef){
          const sec = document.createElement('div');
          sec.className = 'card-section';
          const span = document.createElement('span');
          const parts = [];
          if(t.origemTipo) parts.push(origemLabel(t.origemTipo));
          if(t.origemRef)  parts.push(t.origemRef);
          span.innerHTML = '<strong>Origem:</strong> ' + parts.join(' ¬∑ ');
          sec.appendChild(span);
          card.appendChild(sec);
        }

        // Datas
        if(t.dataCriacao || t.dataLimite || t.horaLimite){
          const sec = document.createElement('div');
          sec.className = 'card-section';
          const span = document.createElement('span');
          const parts = [];
          if(t.dataCriacao) parts.push('Criada em ' + t.dataCriacao);
          if(t.dataLimite) parts.push('Limite ' + t.dataLimite + (t.horaLimite ? ' ' + t.horaLimite : ''));
          span.innerHTML = parts.join(' ¬∑ ');
          sec.appendChild(span);
          card.appendChild(sec);
        }

        // Descri√ß√£o (resumo)
        if(t.descricao){
          const sec = document.createElement('div');
          sec.className = 'card-section';
          const span = document.createElement('span');
          let txt = t.descricao;
          if(txt.length > 180){
            txt = txt.slice(0,177) + '‚Ä¶';
          }
          span.textContent = txt;
          sec.appendChild(span);
          card.appendChild(sec);
        }

        const foot = document.createElement('div');
        foot.className = 'card-footer';

        const left = document.createElement('div');
        left.className = 'card-footer-left';

        const partes = [];
        if(t.responsavel) partes.push(t.responsavel);
        if(t.apoio && t.apoio !== t.responsavel) partes.push('Apoio: ' + t.apoio);
        left.textContent = partes.join(' ¬∑ ');
        foot.appendChild(left);

        const right = document.createElement('div');
        right.className = 'card-footer-right';

        // Bot√£o Concluir/Reabrir
        const btnDone = document.createElement('button');
        btnDone.className = 'btn-xs primary';
        btnDone.textContent = (t.estado === 'concluida') ? 'Reabrir' : 'Concluir';
        btnDone.addEventListener('click',()=>{
          if(state.locked) return;
          if(t.estado === 'concluida'){
            t.estado = 'por_fazer';
          }else{
            t.estado = 'concluida';
          }
          saveState();
          renderCards();
        });
        right.appendChild(btnDone);

        // Bot√£o Ver ficha original (se houver origem)
        if(t.origemTipo && t.origemTipo !== 'interna'){
          const btnView = document.createElement('button');
          btnView.className = 'btn-xs';
          btnView.innerHTML = '<span style="font-size:11px;color:var(--gold);">‚óè</span> Ver ficha original';
          btnView.addEventListener('click',()=>{
            openRecordModalForTask(t);
          });
          right.appendChild(btnView);
        }

        // Bot√£o Editar
        const btnEdit = document.createElement('button');
        btnEdit.className = 'btn-xs';
        btnEdit.textContent = 'Editar';
        btnEdit.addEventListener('click',()=>{
          if(state.locked) return;
          openModal(t);
        });
        right.appendChild(btnEdit);

        // Bot√£o Apagar
        const btnDel = document.createElement('button');
        btnDel.className = 'btn-xs danger';
        btnDel.textContent = 'Apagar';
        btnDel.addEventListener('click',()=>{
          if(state.locked) return;
          if(confirm('Tem a certeza que pretende apagar esta tarefa?')){
            state.tasks = state.tasks.filter(x=>x.id !== t.id);
            saveState();
            renderCards();
          }
        });
        right.appendChild(btnDel);

        foot.appendChild(right);
        card.appendChild(foot);

        cardsGrid.appendChild(card);
      });

      if(alertsToShow.length){
        saveAlertedMap();
        alert('Tem tarefas no limite ou em atraso:\n\n' + alertsToShow.map(t=>'- ' + t).join('\n'));
      }
    }

    // ========= EXPORTA√á√ïES =========
    function exportCsv(){
      if(!state.tasks.length){
        alert('N√£o existem tarefas para exportar.');
        return;
      }

      const cols = [
        'id','titulo','descricao','responsavel','apoio',
        'origemTipo','origemRef',
        'estado','prioridade','tipoTarefa',
        'tags','dataCriacao','dataLimite','horaLimite'
      ];

      function esc(v){
        if(v==null) return '';
        const s = String(v).replace(/"/g,'""');
        return '"' + s + '"';
      }

      let csv = cols.map(esc).join(';') + '\n';
      state.tasks.forEach(t=>{
        const row = cols.map(c=>esc(t[c]));
        csv += row.join(';') + '\n';
      });

      const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const url  = URL.createObjectURL(blob);
      const a    = document.createElement('a');
      a.href     = url;
      a.download = 'tarefas_garvetur_porto_pro.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function exportPdfList(){
      const filtered = applyFilters(state.tasks);
      if(!filtered.length){
        alert('N√£o existem tarefas com os filtros atuais para exportar.');
        return;
      }

      const w = window.open('', '_blank');
      if(!w){
        alert('O navegador bloqueou a abertura da janela de impress√£o.\n\nPor favor permita pop-ups para este site ou use a op√ß√£o de imprimir diretamente no browser.');
        return;
      }

      let rowsHtml = '';
      filtered.forEach(t=>{
        rowsHtml += `
        <tr>
          <td>${t.dataLimite || ''} ${t.horaLimite || ''}</td>
          <td>${t.titulo || ''}</td>
          <td>${t.responsavel || ''}</td>
          <td>${estadoLabel(t.estado)}</td>
          <td>${prioridadeLabel(t.prioridade)}</td>
          <td>${tipoLabel(t.tipoTarefa)}</td>
        </tr>`;
      });

      const html = `
<!doctype html>
<html lang="pt-PT">
<head>
<meta charset="utf-8" />
<title>Lista de Tarefas ‚Äî Garvetur Porto Pro</title>
<style>
  @page { size: A4; margin: 1.5cm; }
  body{
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
    margin:0;
    padding:0;
    color:#222;
    background:#fff;
  }
  h1{
    font-size:18px;
    margin:0 0 4px;
    letter-spacing:.12em;
    text-transform:uppercase;
    color:#333;
  }
  .sub{
    font-size:11px;
    color:#777;
    letter-spacing:.18em;
    text-transform:uppercase;
  }
  header{
    border-bottom:2px solid #A38B63;
    padding-bottom:6px;
    margin-bottom:10px;
    display:flex;
    justify-content:space-between;
    align-items:flex-end;
  }
  .brand-block{
    max-width:70%;
  }
  .info-block{
    font-size:11px;
    color:#555;
    text-align:right;
  }
  table{
    width:100%;
    border-collapse:collapse;
    font-size:10px;
    margin-top:6px;
  }
  th,td{
    border-bottom:1px solid #ddd;
    padding:4px 3px;
    text-align:left;
  }
  th{
    background:#f5f5f5;
    font-weight:600;
  }
  tbody tr:nth-child(even){
    background:#fafafa;
  }
</style>
</head>
<body>
  <header>
    <div class="brand-block">
      <h1>Garvetur Porto Pro</h1>
      <div class="sub">Lista de tarefas</div>
    </div>
    <div class="info-block">
      <div>Data emiss√£o: ${new Date().toLocaleDateString('pt-PT')}</div>
      <div>Total tarefas: ${filtered.length}</div>
    </div>
  </header>

  <table>
    <thead>
      <tr>
        <th style="width:16%;">Data / Hora</th>
        <th style="width:32%;">Tarefa</th>
        <th style="width:18%;">Respons√°vel</th>
        <th style="width:14%;">Estado</th>
        <th style="width:10%;">Prioridade</th>
        <th style="width:10%;">Tipo</th>
      </tr>
    </thead>
    <tbody>
      ${rowsHtml}
    </tbody>
  </table>

<script>
  window.print();
<\/script>
</body>
</html>
      `;

      w.document.open();
      w.document.write(html);
      w.document.close();
    }

    // ========= EVENTOS =========
    toggleLockBtn.addEventListener('click',()=>{
      state.locked = !state.locked;
      updateLockUI();
      saveState();
    });

    newTaskBtn.addEventListener('click',()=>{
      if(state.locked) return;
      openModal(null);
    });

    closeModalBtn.addEventListener('click', closeModal);
    cancelModalBtn.addEventListener('click', closeModal);

    applyFiltersBtn.addEventListener('click', ()=>{
      updateFiltersFromControls();
      saveFiltersToStorage();
      syncGlobalFiltersFromTasks();
      renderCards();
    });

    clearFiltersBtn.addEventListener('click', ()=>{
      clearFilters();
      renderCards();
    });

    clearOriginFilterBtn.addEventListener('click', ()=>{
      FILTERS.origemTipo = '';
      FILTERS.origemRef  = '';
      saveFiltersToStorage();
      renderCards();
    });

    saveTaskBtn.addEventListener('click',(e)=>{
      e.preventDefault();
      if(state.locked){
        alert('O modo de edi√ß√£o est√° bloqueado. Desbloqueie o cadeado no topo para guardar altera√ß√µes.');
        return;
      }
      const data = collectFormData();
      if(!data) return;
      const idx = state.tasks.findIndex(t=>t.id === data.id);
      if(idx>=0){
        state.tasks[idx] = data;
      }else{
        state.tasks.push(data);
      }
      saveState();
      renderCards();
      closeModal();
    });

    exportCsvBtn.addEventListener('click', exportCsv);
    exportPdfBtn.addEventListener('click', exportPdfList);

    window.addEventListener('keydown',(e)=>{
      if(e.key==='Escape'){
        if(modalBackdrop.classList.contains('open')){
          closeModal();
        }else if(recordModalBackdrop.style.display === 'flex'){
          closeRecordModal();
        }
      }
    });

    // Modal ficha original
    closeRecordModalBtn.addEventListener('click', closeRecordModal);
    addRecordNoteBtn.addEventListener('click', addNoteToCurrentRecord);
    saveRecordBtn.addEventListener('click', saveCurrentRecordEdits);

    toggleTasksSectionBtn.addEventListener('click', ()=>{
      const isOpen = recordTasksSection.style.display === 'block';
      recordTasksSection.style.display = isOpen ? 'none' : 'block';
      toggleTasksSectionBtn.textContent = (isOpen ? '‚ñ∂' : '‚ñº') + ' Hist√≥rico de tarefas';
    });

    toggleTimelineSectionBtn.addEventListener('click', ()=>{
      const isOpen = recordTimelineSection.style.display === 'block';
      recordTimelineSection.style.display = isOpen ? 'none' : 'block';
      toggleTimelineSectionBtn.textContent = (isOpen ? '‚ñ∂' : '‚ñº') + ' Timeline & notas';
    });

    // ========= INIT =========
    initConsultores();
    loadState();
    loadFiltersFromStorage();
    loadGlobalFiltersFallback();
    loadLeads();
    loadDeals();
    loadTimelineStore();
    applyUrlContext();
    applyFiltersToControls();
    renderCards();

  })();
  </script>

</body>
</html>

