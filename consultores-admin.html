<!doctype html>
<html lang="pt-PT">
<head>
  <meta charset="utf-8" />
  <title>Garvetur Porto Pro — Consultores</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --gold:#A38B63;
      --gold-soft:rgba(163,139,99,.35);
      --bg:#0B0B0B;
      --panel:#151515;
      --panel-soft:#1C1C1C;
      --text:#FFFFFF;
      --muted:#A0A0A0;
      --border:rgba(255,255,255,.14);
      --shadow-soft:0 22px 40px rgba(0,0,0,.7);
      --radius-lg:20px;
      --radius-md:14px;
      --radius-sm:10px;
      --danger:#F25F5C;
      --success:#4CAF50;
    }

    *{box-sizing:border-box;}
    html,body{
      margin:0;
      height:100%;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      background:radial-gradient(circle at top,#1c1c1c 0,#050505 55%,#000 100%);
      color:var(--text);
    }
    body{display:flex;flex-direction:column;}

    header{
      display:flex;align-items:center;justify-content:space-between;
      padding:12px 18px;border-bottom:1px solid rgba(163,139,99,.35);
      background:linear-gradient(90deg,#050505,#111,#050505);
      gap:14px;flex-wrap:wrap;
    }
    .brand{display:flex;align-items:center;gap:10px;}
    .brand-icon{
      width:30px;height:30px;border-radius:999px;border:1px solid var(--gold);
      display:flex;align-items:center;justify-content:center;
      box-shadow:0 0 0 1px rgba(163,139,99,.35);
    }
    .brand h1{margin:0;font-size:18px;letter-spacing:.08em;text-transform:uppercase;color:var(--gold);}
    .brand span.sub{display:block;font-size:11px;color:var(--muted);letter-spacing:.14em;text-transform:uppercase;}

    .header-actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center;}

    .btn{
      border-radius:999px;border:1px solid rgba(163,139,99,.5);
      background:rgba(0,0,0,.7);color:var(--gold);
      padding:6px 11px;font-size:12px;display:inline-flex;align-items:center;gap:5px;
      cursor:pointer;text-decoration:none;
      transition:.18s background,.18s color,.18s border-color,.18s transform;
    }
    .btn span.icon{font-size:13px;}
    .btn-primary{background:var(--gold);color:#0A0A0A;border-color:var(--gold);font-weight:600;}
    .btn-ghost{border-color:rgba(255,255,255,.18);color:var(--muted);}
    .btn:hover{transform:translateY(-1px);border-color:var(--gold);color:#fff;}
    .btn:disabled{opacity:.45;cursor:not-allowed;transform:none;}

    main{flex:1;padding:18px 18px 20px;display:flex;flex-direction:column;gap:14px;}

    .hero{
      border-radius:var(--radius-lg);
      background:linear-gradient(135deg,#171717,#050505);
      border:1px solid var(--gold-soft);
      box-shadow:var(--shadow-soft);
      padding:14px 16px;
      display:flex;flex-wrap:wrap;gap:14px;align-items:flex-start;justify-content:space-between;
    }
    .hero-text{max-width:520px;}
    .hero-title{margin:0 0 4px;font-size:18px;letter-spacing:.16em;text-transform:uppercase;color:#f5f5f5;}
    .hero-sub{margin:0 0 8px;font-size:12px;color:var(--muted);}
    .hero-tags{display:flex;flex-wrap:wrap;gap:6px;margin-top:4px;}
    .hero-tag{
      font-size:10px;padding:3px 7px;border-radius:999px;border:1px solid rgba(163,139,99,.45);
      text-transform:uppercase;letter-spacing:.12em;color:var(--muted);background:rgba(0,0,0,.5);
    }
    .hero-mini{display:flex;flex-direction:column;gap:6px;min-width:220px;}
    .mini-kpi{
      border-radius:var(--radius-md);background:var(--panel-soft);border:1px solid rgba(255,255,255,.08);
      padding:8px 10px;font-size:12px;
    }
    .mini-kpi-label{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.12em;}
    .mini-kpi-value{margin-top:2px;font-size:16px;font-weight:600;color:#fff;}

    .card{
      border-radius:var(--radius-lg);
      background:linear-gradient(145deg,#181818,#0C0C0C);
      border:1px solid rgba(255,255,255,.16);
      box-shadow:var(--shadow-soft);
      padding:12px 12px 11px;
      display:flex;flex-direction:column;gap:8px;
      position:relative;overflow:hidden;
    }
    .card::before{
      content:"";position:absolute;inset:-40%;
      background:radial-gradient(circle at top left,rgba(163,139,99,.12),transparent 55%);
      opacity:0;transition:.25s opacity;pointer-events:none;
    }
    .card:hover::before{opacity:1;}
    .card-header{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;}
    .card-title{margin:0;font-size:14px;text-transform:uppercase;letter-spacing:.14em;color:#f0f0f0;}
    .card-subtitle{font-size:11px;color:var(--muted);margin-top:2px;}
    .card-actions{display:flex;gap:6px;flex-wrap:wrap;}
    .hint{font-size:11px;color:var(--muted);}

    .table-wrapper{
      border-radius:var(--radius-md);
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.5);
      overflow:hidden;
    }
    table{width:100%;border-collapse:collapse;font-size:13px;}
    thead{background:rgba(10,10,10,.95);}
    th,td{padding:7px 10px;border-bottom:1px solid rgba(255,255,255,.06);vertical-align:middle;}
    th{
      text-align:left;font-size:11px;text-transform:uppercase;letter-spacing:.12em;color:var(--muted);
      white-space:nowrap;
    }
    tbody tr:nth-child(even){background:rgba(255,255,255,.02);}
    tbody tr:hover{background:rgba(163,139,99,.12);}

    .col-nome{width:28%;}
    .col-estado{width:12%;white-space:nowrap;}
    .col-chave{
      width:16%;white-space:nowrap;
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      font-size:12px;
    }
    .col-date{width:14%;white-space:nowrap;}
    .col-lic{width:10%;white-space:nowrap;}
    .col-acoes{width:20%;}

    .pill-ativo,.pill-inativo,.pill-lic-active,.pill-lic-revoked{
      display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:999px;font-size:11px;
      background:rgba(0,0,0,.7);white-space:nowrap;
    }
    .pill-ativo{border:1px solid rgba(76,175,80,.8);color:#A5D6A7;}
    .pill-inativo{border:1px solid rgba(242,95,92,.8);color:#FFB3B0;}
    .pill-lic-active{border:1px solid rgba(76,175,80,.65);color:#A5D6A7;}
    .pill-lic-revoked{border:1px solid rgba(242,95,92,.7);color:#FFB3B0;}

    .btn-xs{
      border-radius:999px;padding:3px 8px;border:1px solid rgba(163,139,99,.5);
      background:rgba(0,0,0,.7);color:var(--muted);font-size:11px;cursor:pointer;
      display:inline-flex;align-items:center;gap:4px;text-decoration:none;
      transition:.18s background,.18s color,.18s border-color,.18s transform;
      white-space:nowrap;
    }
    .btn-xs.primary{background:var(--gold);color:#0A0A0A;border-color:var(--gold);font-weight:600;}
    .btn-xs.danger{border-color:var(--danger);color:#FFB3B0;}
    .btn-xs:hover{transform:translateY(-1px);border-color:var(--gold);color:#fff;}

    .mini-input{
      width:140px;max-width:100%;
      background:rgba(0,0,0,.8);color:var(--text);
      border-radius:10px;border:1px solid rgba(163,139,99,.32);
      padding:4px 6px;font-size:12px;outline:none;
    }
    .mini-input:focus{border-color:var(--gold);box-shadow:0 0 0 1px rgba(163,139,99,.35);}

    footer{
      padding:6px 14px 10px;font-size:11px;color:var(--muted);
      border-top:1px solid rgba(163,139,99,.28);background:#050505;
      display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap;
    }

    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.75);display:none;align-items:center;justify-content:center;z-index:40;}
    .modal-backdrop.open{display:flex;}
    .modal{
      width:min(460px,94vw);
      background:radial-gradient(circle at top,#151515,#050505);
      border-radius:22px;border:1px solid rgba(163,139,99,.55);
      box-shadow:0 24px 45px rgba(0,0,0,.85);
      overflow:hidden;display:flex;flex-direction:column;
    }
    .modal-header{
      padding:9px 14px 8px;border-bottom:1px solid rgba(163,139,99,.28);
      display:flex;justify-content:space-between;align-items:center;gap:8px;
      background:linear-gradient(90deg,#050505,#111,#050505);
    }
    .modal-header h2{margin:0;font-size:14px;letter-spacing:.14em;text-transform:uppercase;color:var(--gold);}
    .modal-body{padding:10px 14px 8px;font-size:13px;}
    .modal-footer{
      padding:8px 14px 10px;border-top:1px solid rgba(163,139,99,.26);
      display:flex;justify-content:space-between;gap:8px;background:#050505;align-items:center;
    }
    .modal-footer-left{font-size:11px;color:var(--muted);}
    .field{display:flex;flex-direction:column;gap:4px;margin-bottom:10px;}
    .field-label{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.12em;}
    input[type="text"], input[type="date"], select{
      background:rgba(0,0,0,.8);color:var(--text);
      border-radius:var(--radius-sm);border:1px solid rgba(163,139,99,.32);
      padding:6px 8px;font-size:13px;outline:none;width:100%;
    }
    input:focus, select:focus{border-color:var(--gold);box-shadow:0 0 0 1px rgba(163,139,99,.35);}
    .chk{display:flex;align-items:center;gap:6px;font-size:13px;color:var(--muted);margin-top:2px;}
    .chk input{width:auto;accent-color:var(--gold);}

    @media (max-width:900px){
      .col-chave{width:auto;}
      .mini-input{width:120px;}
    }
  </style>
</head>
<body>
<header>
  <div class="brand">
    <div class="brand-icon">
      <svg width="18" height="18" viewBox="0 0 24 24" stroke="var(--gold)" fill="none" stroke-width="1.8">
        <circle cx="12" cy="12" r="9"></circle>
        <path d="M8 12.5l2.5 2.5L16 9"></path>
      </svg>
    </div>
    <div>
      <h1>Garvetur Porto Pro</h1>
      <span class="sub">Administração de consultores · Configuração global</span>
    </div>
  </div>

  <div class="header-actions">
    <a href="./index.html" class="btn btn-ghost" title="Voltar ao cockpit">
      <span class="icon">⟵</span><span>Voltar ao Cockpit</span>
    </a>
  </div>
</header>

<main>
  <section class="hero">
    <div class="hero-text">
      <h2 class="hero-title">Configuração de Consultores</h2>
      <p class="hero-sub">
        Gestão centralizada da lista de consultores ativos da Garvetur Luxury Porto.
        As alterações aqui feitas são usadas por <strong>Leads</strong>, <strong>Angariações</strong> e
        <strong>Tarefas</strong> (após atualizar a página desses módulos).
      </p>
      <div class="hero-tags">
        <span class="hero-tag">Lista única de consultores</span>
        <span class="hero-tag">Ativo / Inativo</span>
        <span class="hero-tag">Exportar / Importar JSON</span>
        <span class="hero-tag">Licenças (local)</span>
      </div>
    </div>
    <div class="hero-mini">
      <div class="mini-kpi">
        <div class="mini-kpi-label">Total de consultores</div>
        <div class="mini-kpi-value" id="kpiTotal">—</div>
      </div>
      <div class="mini-kpi">
        <div class="mini-kpi-label">Ativos</div>
        <div class="mini-kpi-value" id="kpiAtivos">—</div>
      </div>
      <div class="mini-kpi">
        <div class="mini-kpi-label">Estado</div>
        <div class="mini-kpi-value">Configuração local</div>
      </div>
    </div>
  </section>

  <section class="card">
    <div class="card-header">
      <div>
        <h3 class="card-title">Lista de Consultores</h3>
        <div class="card-subtitle">
          Utilize este painel para adicionar, editar, ativar/desativar ou remover consultores.
          <br>
          Licenças: atribuição de chave, datas e estado (ACTIVE / REVOKED).
        </div>
      </div>
      <div class="card-actions">
        <button class="btn btn-ghost" id="exportBtn" type="button"><span class="icon">⤓</span><span>Exportar JSON</span></button>
        <button class="btn btn-ghost" id="importBtn" type="button"><span class="icon">⤒</span><span>Importar JSON</span></button>
        <button class="btn btn-primary" id="newConsultorBtn" type="button"><span class="icon">＋</span><span>Novo Consultor</span></button>
      </div>
    </div>

    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th class="col-nome">Consultor</th>
            <th class="col-estado">Estado</th>
            <th class="col-chave">Chave</th>
            <th class="col-date">Data entrega</th>
            <th class="col-date">Data ativação</th>
            <th class="col-lic">Licença</th>
            <th class="col-acoes">Ações</th>
          </tr>
        </thead>
        <tbody id="consultoresTableBody"></tbody>
      </table>
    </div>

    <div class="hint">
      Nota: A lista “base” continua a ser guardada na configuração global (<code>config-consultores.js</code>) para alimentar os outros módulos.
      <br>
      Os campos de <strong>licença</strong> ficam guardados à parte (localStorage) e não interferem com os selects/filtros do resto da app.
    </div>
  </section>
</main>

<footer>
  <span>Garvetur Porto Pro — módulo de administração de consultores (ambiente local).</span>
  <span>Esta configuração alimenta os filtros e selects de consultores noutros módulos.</span>
</footer>

<script src="config-consultores.js"></script>
<script>
(function(){
  const tbody = document.getElementById('consultoresTableBody');
  const kpiTotal = document.getElementById('kpiTotal');
  const kpiAtivos = document.getElementById('kpiAtivos');
  const newBtn = document.getElementById('newConsultorBtn');
  const exportBtn = document.getElementById('exportBtn');
  const importBtn = document.getElementById('importBtn');

  const STORAGE_KEY = 'gpp_consultores_v1';
  const STORAGE_KEY_LIC = 'gpp_consultores_lic_v1';

  const LICENSE_BY_PERSON = [
    { name: "Manuel Oliveira",  key: "GPP-PORTO-001" },
    { name: "João Sousa",       key: "GPP-PORTO-002" },
    { name: "Francisco Santos", key: "GPP-PORTO-003" },
    { name: "Rosário Costa",    key: "GPP-PORTO-004" },
    { name: "Dalila Cunha",     key: "GPP-PORTO-005" },
    { name: "Rui Quelhas",      key: "GPP-PORTO-006" }
  ];

  const DEFAULT_LIST = [
    { nome:"Rui Quelhas", ativo:true },
    { nome:"Manuel Oliveira", ativo:true },
    { nome:"João Sousa", ativo:true },
    { nome:"Francisco dos Santos", ativo:true },
    { nome:"Rosário Vasconcelos", ativo:true },
    { nome:"Armanda Meireles", ativo:true },
    { nome:"Audrey Lucas", ativo:true },
    { nome:"Dalila Cunha", ativo:true },
    { nome:"Outro", ativo:true }
  ];

  function normStr(s){
    return String(s||'')
      .toLowerCase()
      .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
      .replace(/[^\p{L}\p{N}\s]/gu,' ')
      .replace(/\s+/g,' ')
      .trim();
  }

  function bestLicenseKeyForName(nome){
    const n = normStr(nome);
    if(!n) return '';
    for(const item of LICENSE_BY_PERSON){
      const t = normStr(item.name);
      const parts = t.split(' ').filter(Boolean);
      let ok = 0;
      for(const p of parts){
        if(p.length >= 3 && n.includes(p)) ok++;
      }
      if(ok >= Math.min(2, parts.length)) return item.key;
    }
    return '';
  }

  function normalizarLista(lista){
    if (!Array.isArray(lista)) return [];
    return lista
      .map((c, idx) => {
        if (typeof c === 'string') {
          return { id: 'c_' + idx + '_' + Date.now(), nome: c, ativo: true };
        }
        if (c && typeof c === 'object') {
          return { id: c.id || ('c_' + idx + '_' + Date.now()), nome: c.nome || c.name || '', ativo: c.ativo !== false };
        }
        return null;
      })
      .filter(c => c && c.nome);
  }

  function loadFromConfig(){
    try{
      if (window.GPPConsultores && typeof window.GPPConsultores.getAll === 'function') {
        const lista = window.GPPConsultores.getAll();
        const norm = normalizarLista(lista);
        if (norm.length) return norm;
      }
      if (Array.isArray(window.CONSULTANTS_CONFIG)) {
        const norm2 = normalizarLista(window.CONSULTANTS_CONFIG);
        if (norm2.length) return norm2;
      }
      return normalizarLista(DEFAULT_LIST);
    }catch(e){
      console.error('Erro a carregar consultores da config central', e);
      return normalizarLista(DEFAULT_LIST);
    }
  }

  let consultores = loadFromConfig();

  let licData = {};
  try{ licData = JSON.parse(localStorage.getItem(STORAGE_KEY_LIC) || '{}') || {}; }catch(e){ licData = {}; }

  function mergeLicenseFields(){
    consultores = consultores.map(c=>{
      const saved = licData[c.id] || licData[normStr(c.nome)] || null;
      const preKey = bestLicenseKeyForName(c.nome);
      return Object.assign({}, c, {
        license_key: (saved && saved.license_key) ? String(saved.license_key) : (c.license_key ? String(c.license_key) : preKey),
        data_entrega: (saved && saved.data_entrega) ? String(saved.data_entrega) : (c.data_entrega ? String(c.data_entrega) : ''),
        data_ativacao: (saved && saved.data_ativacao) ? String(saved.data_ativacao) : (c.data_ativacao ? String(c.data_ativacao) : ''),
        license_status: (saved && saved.license_status) ? String(saved.license_status) : (c.license_status ? String(c.license_status) : 'ACTIVE')
      });
    });
  }
  mergeLicenseFields();

  function atualizarKPIs(){
    kpiTotal.textContent = String(consultores.length);
    kpiAtivos.textContent = String(consultores.filter(c => c.ativo).length);
  }

  function persistir(){
    const plainBase = consultores.map(c => ({ id:c.id, nome:c.nome, ativo:!!c.ativo }));

    const lic = {};
    consultores.forEach(c=>{
      lic[c.id] = {
        license_key: c.license_key || '',
        data_entrega: c.data_entrega || '',
        data_ativacao: c.data_ativacao || '',
        license_status: String(c.license_status || 'ACTIVE').toUpperCase() === 'REVOKED' ? 'REVOKED' : 'ACTIVE'
      };
      lic[normStr(c.nome)] = lic[c.id];
    });
    try{ localStorage.setItem(STORAGE_KEY_LIC, JSON.stringify(lic)); }catch(e){ console.error('Erro ao gravar licenças', e); }

    if (window.GPPConsultores && typeof window.GPPConsultores.saveAll === 'function') {
      try{ window.GPPConsultores.saveAll(plainBase); }catch(e){ console.error('Erro ao chamar GPPConsultores.saveAll', e); }
    }else{
      try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(plainBase)); }catch(e){ console.error('Erro ao gravar consultores', e); }
      window.CONSULTANTS_CONFIG = plainBase;
    }

    renderTabela();
  }

  function pillLicense(status){
    const st = String(status || 'ACTIVE').toUpperCase();
    if(st === 'REVOKED'){
      return '<span class="pill-lic-revoked"><span>●</span><span>REVOKED</span></span>';
    }
    return '<span class="pill-lic-active"><span>●</span><span>ACTIVE</span></span>';
  }

  function renderTabela(){
    tbody.innerHTML = '';
    if (!consultores.length){
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.colSpan = 7;
      td.style.textAlign = 'center';
      td.style.padding = '10px';
      td.style.color = '#A0A0A0';
      td.textContent = 'Ainda não existem consultores configurados.';
      tr.appendChild(td);
      tbody.appendChild(tr);
      atualizarKPIs();
      return;
    }

    consultores.forEach(c=>{
      const tr = document.createElement('tr');

      const tdNome = document.createElement('td');
      tdNome.className = 'col-nome';
      tdNome.textContent = c.nome;
      tr.appendChild(tdNome);

      const tdEstado = document.createElement('td');
      tdEstado.className = 'col-estado';
      tdEstado.innerHTML = c.ativo
        ? '<span class="pill-ativo"><span>●</span><span>Ativo</span></span>'
        : '<span class="pill-inativo"><span>●</span><span>Inativo</span></span>';
      tr.appendChild(tdEstado);

      const tdKey = document.createElement('td');
      tdKey.className = 'col-chave';
      tdKey.textContent = c.license_key || '—';
      tr.appendChild(tdKey);

      const tdEntrega = document.createElement('td');
      tdEntrega.className = 'col-date';
      const inEntrega = document.createElement('input');
      inEntrega.type = 'date';
      inEntrega.className = 'mini-input';
      inEntrega.value = c.data_entrega || '';
      inEntrega.addEventListener('change', ()=>{ c.data_entrega = inEntrega.value || ''; persistir(); });
      tdEntrega.appendChild(inEntrega);
      tr.appendChild(tdEntrega);

      const tdAtiv = document.createElement('td');
      tdAtiv.className = 'col-date';
      const inAtiv = document.createElement('input');
      inAtiv.type = 'date';
      inAtiv.className = 'mini-input';
      inAtiv.value = c.data_ativacao || '';
      inAtiv.addEventListener('change', ()=>{ c.data_ativacao = inAtiv.value || ''; persistir(); });
      tdAtiv.appendChild(inAtiv);
      tr.appendChild(tdAtiv);

      const tdLic = document.createElement('td');
      tdLic.className = 'col-lic';
      tdLic.innerHTML = pillLicense(c.license_status);
      tr.appendChild(tdLic);

      const tdAcoes = document.createElement('td');
      tdAcoes.className = 'col-acoes';

      const btnEditar = document.createElement('button');
      btnEditar.type = 'button';
      btnEditar.className = 'btn-xs primary';
      btnEditar.textContent = 'Editar';
      btnEditar.addEventListener('click', ()=>abrirModal(c));

      const btnToggle = document.createElement('button');
      btnToggle.type = 'button';
      btnToggle.className = 'btn-xs';
      btnToggle.textContent = c.ativo ? 'Desativar' : 'Ativar';
      btnToggle.addEventListener('click', ()=>{ c.ativo = !c.ativo; persistir(); });

      const btnRev = document.createElement('button');
      btnRev.type = 'button';
      btnRev.className = 'btn-xs danger';
      const curr = String(c.license_status||'ACTIVE').toUpperCase();
      btnRev.textContent = (curr === 'REVOKED') ? 'Reativar licença' : 'Revogar licença';
      btnRev.addEventListener('click', ()=>{
        const current = String(c.license_status||'ACTIVE').toUpperCase();
        const next = (current === 'REVOKED') ? 'ACTIVE' : 'REVOKED';
        if(next === 'REVOKED' && !confirm('Tem a certeza que pretende marcar esta licença como REVOKED (revogada)?')) return;
        c.license_status = next;
        persistir();
      });

      const btnRemover = document.createElement('button');
      btnRemover.type = 'button';
      btnRemover.className = 'btn-xs danger';
      btnRemover.textContent = 'Remover';
      btnRemover.addEventListener('click', ()=>{
        if(!confirm('Tem a certeza que pretende remover este consultor da lista?')) return;
        consultores = consultores.filter(x => x.id !== c.id);
        persistir();
      });

      tdAcoes.appendChild(btnEditar);
      tdAcoes.appendChild(document.createTextNode(' '));
      tdAcoes.appendChild(btnToggle);
      tdAcoes.appendChild(document.createTextNode(' '));
      tdAcoes.appendChild(btnRev);
      tdAcoes.appendChild(document.createTextNode(' '));
      tdAcoes.appendChild(btnRemover);

      tr.appendChild(tdAcoes);
      tbody.appendChild(tr);
    });

    atualizarKPIs();
  }

  // MODAL
  const modalBackdrop = document.createElement('div');
  modalBackdrop.className = 'modal-backdrop';
  modalBackdrop.innerHTML = `
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-header">
        <h2 id="modalTitle">Novo Consultor</h2>
        <button type="button" id="closeModalBtn" class="btn btn-ghost" style="padding:3px 8px;font-size:11px;">✕</button>
      </div>
      <div class="modal-body">
        <form id="consultorForm">
          <input type="hidden" id="consultorId" />
          <div class="field">
            <label class="field-label" for="consultorNome">Nome do consultor</label>
            <input type="text" id="consultorNome" placeholder="Ex.: João Silva" autocomplete="off" />
          </div>
          <div class="field">
            <label class="field-label">Estado</label>
            <label class="chk">
              <input type="checkbox" id="consultorAtivo" checked />
              <span>Ativo (aparece em filtros e selects nos outros módulos)</span>
            </label>
          </div>

          <div class="field">
            <label class="field-label" for="licenseKey">Chave (licença)</label>
            <input type="text" id="licenseKey" placeholder="Ex.: GPP-PORTO-007" autocomplete="off" />
          </div>
          <div class="field">
            <label class="field-label" for="dataEntrega">Data de entrega</label>
            <input type="date" id="dataEntrega" />
          </div>
          <div class="field">
            <label class="field-label" for="dataAtivacao">Data de ativação</label>
            <input type="date" id="dataAtivacao" />
          </div>
          <div class="field">
            <label class="field-label" for="licenseStatus">Estado da licença</label>
            <select id="licenseStatus">
              <option value="ACTIVE">ACTIVE</option>
              <option value="REVOKED">REVOKED</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <div class="modal-footer-left">As alterações são guardadas na configuração global de consultores.</div>
        <div>
          <button class="btn btn-ghost" type="button" id="cancelModalBtn">Cancelar</button>
          <button class="btn btn-primary" type="button" id="saveConsultorBtn">Guardar</button>
        </div>
      </div>
    </div>
  `;
  document.body.appendChild(modalBackdrop);

  const modalTitle = modalBackdrop.querySelector('#modalTitle');
  const closeModalBtn = modalBackdrop.querySelector('#closeModalBtn');
  const cancelModalBtn = modalBackdrop.querySelector('#cancelModalBtn');
  const saveConsultorBtn = modalBackdrop.querySelector('#saveConsultorBtn');

  const consultorIdInput = modalBackdrop.querySelector('#consultorId');
  const consultorNomeInput = modalBackdrop.querySelector('#consultorNome');
  const consultorAtivoInput = modalBackdrop.querySelector('#consultorAtivo');
  const licenseKeyInput = modalBackdrop.querySelector('#licenseKey');
  const dataEntregaInput = modalBackdrop.querySelector('#dataEntrega');
  const dataAtivacaoInput = modalBackdrop.querySelector('#dataAtivacao');
  const licenseStatusInput = modalBackdrop.querySelector('#licenseStatus');

  function abrirModal(consultor){
    if(consultor){
      modalTitle.textContent = 'Editar Consultor';
      consultorIdInput.value = consultor.id;
      consultorNomeInput.value = consultor.nome || '';
      consultorAtivoInput.checked = !!consultor.ativo;

      licenseKeyInput.value = consultor.license_key || '';
      dataEntregaInput.value = consultor.data_entrega || '';
      dataAtivacaoInput.value = consultor.data_ativacao || '';
      licenseStatusInput.value = String(consultor.license_status || 'ACTIVE').toUpperCase()==='REVOKED' ? 'REVOKED' : 'ACTIVE';
    }else{
      modalTitle.textContent = 'Novo Consultor';
      consultorIdInput.value = '';
      consultorNomeInput.value = '';
      consultorAtivoInput.checked = true;

      licenseKeyInput.value = '';
      dataEntregaInput.value = '';
      dataAtivacaoInput.value = '';
      licenseStatusInput.value = 'ACTIVE';
    }
    modalBackdrop.classList.add('open');
    setTimeout(()=>consultorNomeInput.focus(), 50);
  }

  function fecharModal(){ modalBackdrop.classList.remove('open'); }

  function guardarConsultor(){
    const id = consultorIdInput.value;
    const nome = (consultorNomeInput.value || '').trim();
    const ativo = consultorAtivoInput.checked;

    const lkey = (licenseKeyInput.value || '').trim();
    const dent = dataEntregaInput.value || '';
    const datv = dataAtivacaoInput.value || '';
    const lstat = String(licenseStatusInput.value || 'ACTIVE').toUpperCase()==='REVOKED' ? 'REVOKED' : 'ACTIVE';

    if(!nome){
      alert('Indique o nome do consultor.');
      consultorNomeInput.focus();
      return;
    }

    if(id){
      const idx = consultores.findIndex(c => c.id === id);
      if(idx >= 0){
        consultores[idx].nome = nome;
        consultores[idx].ativo = ativo;

        if(lkey) consultores[idx].license_key = lkey;
        if(!consultores[idx].license_key) consultores[idx].license_key = bestLicenseKeyForName(nome);

        consultores[idx].data_entrega = dent;
        consultores[idx].data_ativacao = datv;
        consultores[idx].license_status = lstat;
      }
    }else{
      consultores.push({
        id: 'c_' + Date.now() + '_' + Math.floor(Math.random()*1000),
        nome, ativo,
        license_key: lkey || bestLicenseKeyForName(nome) || '',
        data_entrega: dent,
        data_ativacao: datv,
        license_status: lstat
      });
    }

    persistir();
    fecharModal();
  }

  closeModalBtn.addEventListener('click', fecharModal);
  cancelModalBtn.addEventListener('click', fecharModal);
  saveConsultorBtn.addEventListener('click', guardarConsultor);
  modalBackdrop.addEventListener('click', (e)=>{ if(e.target===modalBackdrop) fecharModal(); });
  window.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && modalBackdrop.classList.contains('open')) fecharModal(); });

  newBtn.addEventListener('click', ()=>abrirModal(null));

  exportBtn.addEventListener('click', ()=>{
    if(!consultores.length){ alert('Não existem consultores para exportar.'); return; }
    const plain = consultores.map(c=>({
      id:c.id, nome:c.nome, ativo:!!c.ativo,
      license_key:c.license_key||'',
      data_entrega:c.data_entrega||'',
      data_ativacao:c.data_ativacao||'',
      license_status:String(c.license_status||'ACTIVE').toUpperCase()==='REVOKED' ? 'REVOKED' : 'ACTIVE'
    }));
    const blob = new Blob([JSON.stringify(plain,null,2)], { type: 'application/json;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    const hoje = new Date().toISOString().slice(0,10);
    a.href = url;
    a.download = 'consultores_garvetur_porto_pro_' + hoje + '.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  });

  importBtn.addEventListener('click', ()=>{
    if (!confirm(
      'Esta operação vai substituir a lista atual de consultores pelo ficheiro selecionado.\n\n' +
      'Os módulos que usam consultores (Leads, Angariações, Tarefas) passarão a usar esta nova lista ' +
      'após atualizar a página.\n\nPretende continuar?'
    )) return;

    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json,application/json';

    input.addEventListener('change', (e)=>{
      const file = e.target.files && e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (ev)=>{
        try{
          const parsed = JSON.parse(ev.target.result);
          const norm = normalizarLista(parsed);
          if(!norm.length){ alert('O ficheiro não contém uma lista válida de consultores.'); return; }

          consultores = norm.map((c, idx)=>{
            const src = Array.isArray(parsed) ? parsed[idx] : null;
            return Object.assign({}, c, {
              license_key: (src && src.license_key) ? String(src.license_key) : (bestLicenseKeyForName(c.nome) || ''),
              data_entrega: (src && src.data_entrega) ? String(src.data_entrega) : '',
              data_ativacao: (src && src.data_ativacao) ? String(src.data_ativacao) : '',
              license_status: (src && src.license_status) ? String(src.license_status) : 'ACTIVE'
            });
          });

          persistir();
          alert('Lista de consultores atualizada com sucesso.');
        }catch(err){
          console.error('Erro a importar consultores', err);
          alert('Não foi possível ler o ficheiro de consultores. Verifique se é um JSON válido.');
        }
      };
      reader.readAsText(file, 'utf-8');
    });

    input.click();
  });

  // Arranque: grava chaves pré-atribuídas sem apagar o que já existia
  persistir();

})();
</script>
</body>
</html>
