<!doctype html>
<html lang="pt">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Garvetur Porto Pro ‚Äî Angaria√ß√µes</title>

<link rel="preconnect" href="https://unpkg.com" crossorigin>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>

<style>
:root{
  --gold:#A38B63;
  --bg:#0E0E0E;
  --panel:#131313;
  --text:#FFFFFF;
  --muted:#9AA0A6;
  --border:rgba(255,255,255,.12);
}
html,body{
  height:100%;
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;
}
a{color:#eaeaea;text-decoration:none}

/* Layout base */
.app{display:grid;grid-template-rows:56px auto auto 1fr;height:100%}

/* Header */
header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:10px 12px;
  border-bottom:1px solid var(--border);
  background:#0F0F0F;
}
.brand{display:flex;align-items:center;gap:10px}
.brand h1{font-size:16px;margin:0;color:var(--gold)}
.nav{display:flex;gap:8px}
.nav a{
  border:1px solid var(--border);
  padding:6px 10px;
  border-radius:8px;
  color:#ddd;
}
.nav a.active{
  background:var(--gold);
  color:#111;
  border-color:var(--gold);
  font-weight:700;
}

/* Toolbar */
.toolbar{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  padding:8px 12px;
  border-bottom:1px solid var(--border);
  background:#0F0F0F;
}
.btn{
  background:transparent;
  border:1px solid rgba(163,139,99,.5);
  color:#fff;
  padding:6px 10px;
  border-radius:10px;
  cursor:pointer;
  font-size:12px;
}
.btn.primary{background:var(--gold);color:#111;border-color:var(--gold);font-weight:700}
.btn.ghost{border-color:var(--border);color:#ddd}
.btn[disabled]{opacity:.45;cursor:not-allowed}

/* KPI Bar */
.kpi-bar{
  padding:6px 12px;
  border-bottom:1px solid var(--border);
  font-size:12px;
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  align-items:center;
  background:#101010;
}
.kpi-badge{
  padding:2px 8px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.18);
}
.kpi-badge.highlight{
  border-color:var(--gold);
  color:var(--gold);
  font-weight:600;
}

/* Main */
.main{
  display:grid;
  grid-template-columns:300px 1fr;
  height:calc(100vh - 56px - 48px - 32px);
}
.sidebar{
  background:var(--panel);
  border-right:1px solid var(--border);
  padding:12px;
  overflow:auto;
}
.sidebar h3{
  margin:0 0 8px 0;
  font-size:13px;
  color:#d7d7d7;
  text-transform:uppercase;
  letter-spacing:.06em;
}
.field{
  display:flex;
  flex-direction:column;
  gap:6px;
  margin-bottom:10px;
}
.field label{font-size:12px;color:#ccc}
.field input,.field select{
  background:#0E0E0E;
  border:1px solid rgba(255,255,255,.16);
  border-radius:8px;
  color:#fff;
  padding:8px 10px;
  outline:none;
  font-size:12px;
}
.checks{display:flex;flex-direction:column;gap:8px}
.checks label{
  display:flex;
  gap:6px;
  align-items:center;
  font-size:13px;
  color:#ddd;
}
.checks input{accent-color:var(--gold)}

/* Board */
.board{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:10px;
  padding:10px;
  height:100%;
  overflow:auto;
}
.col{
  background:var(--panel);
  border-radius:12px;
  border:1px solid var(--border);
  display:flex;
  flex-direction:column;
  min-width:260px;
}
.col header{
  padding:10px;
  border-bottom:1px solid rgba(255,255,255,.08);
  display:flex;
  align-items:center;
  justify-content:space-between;
}
.col header .title{font-weight:700}
.col header .counter{font-size:12px;color:#cfcfcf}
.col .list{
  padding:10px;
  display:flex;
  flex-direction:column;
  gap:10px;
}

/* Cards */
.card{
  background:#0E0E0E;
  border-radius:12px;
  border:1px solid rgba(163,139,99,.35);
  padding:10px;
}
.card .top{
  display:flex;
  justify-content:space-between;
  gap:8px;
}
.card .name{font-weight:700}
.card .meta{font-size:11px;color:#bbb;text-transform:uppercase;letter-spacing:.04em}
.card .row{margin-top:5px;font-size:12px;color:#ddd}
.card .row small{color:#aaa}
.badge{
  display:inline-block;
  padding:2px 8px;
  font-size:11px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.18);
}
.badge.red{border-color:#ff6b6b;color:#ffb4b4}
.badge.green{border-color:#5ac48f;color:#bdf7d3}
.badge.yellow{border-color:#ffdd7a;color:#ffdd7a}
.actions{
  margin-top:8px;
  display:flex;
  flex-wrap:wrap;
  gap:6px;
}
.btn-sm{
  font-size:11px;
  padding:4px 7px;
  border-radius:8px;
  border:1px solid rgba(255,255,255,.18);
  background:transparent;
  color:#eee;
  cursor:pointer;
}
.btn-sm.danger{border-color:#cc4b4b;color:#ffdddd}
.btn-sm[disabled]{opacity:.45;cursor:not-allowed}
.select-move{
  background:#0E0E0E;
  border-radius:8px;
  border:1px solid rgba(255,255,255,.25);
  color:#ddd;
  font-size:11px;
  padding:3px 6px;
}
.select-move[disabled]{opacity:.45;cursor:not-allowed}

/* Mini gr√°fico por consultor */
.chart{
  margin-top:12px;
  border-top:1px dashed rgba(255,255,255,.2);
  padding-top:10px;
}
.chart h4{
  margin:0 0 6px 0;
  font-size:12px;
  color:#ccc;
  text-transform:uppercase;
  letter-spacing:.06em;
}
.chart-row{
  display:flex;
  align-items:center;
  gap:6px;
  margin-bottom:4px;
}
.chart-label{
  width:120px;
  font-size:11px;
  color:#ddd;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.chart-bar-wrap{
  flex:1;
  background:#222;
  border-radius:999px;
  overflow:hidden;
}
.chart-bar{
  height:6px;
  background:linear-gradient(90deg,#A38B63,#F4D188);
}

/* Modal */
.modal-backdrop{
  position:fixed;
  inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  background:rgba(0,0,0,.6);
  backdrop-filter:blur(2px);
  z-index:10000;
  padding:16px;
}
.modal-backdrop.show{display:flex}
.modal{
  width:min(1080px,96vw);
  background:#0F0F0F;
  border-radius:12px;
  border:1px solid var(--border);
  overflow:hidden;
}
.modal header{
  padding:10px 12px;
  border-bottom:1px solid var(--border);
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.modal .content{
  padding:12px;
  max-height:72vh;
  overflow:auto;
}
.section-title{
  margin:12px 0 6px 0;
  font-size:12px;
  color:#ccc;
  text-transform:uppercase;
  letter-spacing:.06em;
}
.form-grid2{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
}
.form-grid3{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:10px;
}
.form-field{
  display:flex;
  flex-direction:column;
  gap:4px;
}
.form-field label{font-size:12px;color:#ccc}
.form-field input,.form-field select,.form-field textarea{
  background:#0E0E0E;
  border-radius:8px;
  border:1px solid rgba(255,255,255,.16);
  color:#fff;
  padding:8px 10px;
  outline:none;
  font-size:12px;
}
textarea{resize:vertical}
.small-hint{font-size:11px;color:#9AA0A6}

/* Checkbox grids */
.check-grid-3{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:6px;
}
.check-grid-2{
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:6px;
}
.check-grid-3 label,
.check-grid-2 label{
  font-size:12px;
  display:flex;
  align-items:center;
  gap:6px;
  color:#ddd;
}
.check-grid-3 input,
.check-grid-2 input{accent-color:var(--gold)}

/* Responsive */
@media (max-width:1400px){ .board{grid-template-columns:repeat(3,1fr)} }
@media (max-width:1024px){ .board{grid-template-columns:repeat(2,1fr)} }
@media (max-width:768px){
  .main{grid-template-columns:1fr}
  .sidebar{order:2;height:280px}
  .board{order:1}
  .check-grid-3{grid-template-columns:repeat(2,1fr)}
}
</style>
</head>
<body>
<header>
  <div class="brand">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" style="color:var(--gold)">
      <circle cx="12" cy="12" r="10" stroke-width="1.5"/>
      <path d="M8 12l2.5 2.5L16 9" stroke-width="1.8"/>
    </svg>
    <h1>Garvetur Porto Pro ‚Äî Angaria√ß√µes</h1>
  </div>
  <nav class="nav">
    <a href="./index.html">Mapa</a>
    <a href="./kanban.html">Leads</a>
    <a class="active" href="./angariacoes.html">Angaria√ß√µes</a>
    <a href="./dashboard.html">Dashboard</a>
  </nav>
</header>

<div class="toolbar">
  <button class="btn primary" id="btnNew" disabled>+ Nova Angaria√ß√£o</button>
  <button class="btn" id="toggleEdit">üîí Edi√ß√£o bloqueada</button>
  <div style="margin-left:auto;display:flex;gap:8px;flex-wrap:wrap">
    <button class="btn" id="exportCsv">Exportar CSV</button>
  </div>
</div>

<div class="kpi-bar" id="kpiBar"></div>

<div class="main">
  <!-- Sidebar -->
  <aside class="sidebar">
    <h3>Pesquisa</h3>
    <div class="field">
      <input id="f_q" placeholder="Im√≥vel, propriet√°rio, consultor, ref., notas">
    </div>

    <h3>Filtros</h3>
    <div class="field">
      <label>Consultor</label>
      <select id="f_consultor">
        <option value="">(Todos)</option>
      </select>
    </div>
    <div class="field">
      <label>Estado</label>
      <select id="f_estado">
        <option value="">(Todos)</option>
        <option>Novo</option>
        <option>Em Negocia√ß√£o</option>
        <option>Aprovado</option>
        <option>Perdido</option>
      </select>
    </div>
    <div class="field">
      <label>Per√≠odo (Data)</label>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px">
        <input id="f_ini" type="date">
        <input id="f_fim" type="date">
      </div>
    </div>
    <div class="field">
      <label>% Ajustamento (min‚Äìm√°x)</label>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px">
        <input id="f_aj_min" type="number" step="1" placeholder="min">
        <input id="f_aj_max" type="number" step="1" placeholder="m√°x">
      </div>
    </div>
    <div class="checks">
      <label><input type="checkbox" id="f_show_hidden"> Mostrar invis√≠veis</label>
      <label><input type="checkbox" id="f_only_hidden"> S√≥ invis√≠veis</label>
    </div>
    <div style="display:flex;gap:8px;margin-top:10px">
      <button class="btn" id="applyFilters">Aplicar</button>
      <button class="btn ghost" id="clearFilters">Limpar</button>
    </div>

    <!-- Mini gr√°fico -->
    <div class="chart">
      <h4>Angaria√ß√µes por consultor</h4>
      <div id="chartRows"></div>
    </div>
  </aside>

  <!-- Board -->
  <section class="board" id="board"></section>
</div>

<!-- Modal Angaria√ß√£o -->
<div class="modal-backdrop" id="angModal">
  <div class="modal">
    <header>
      <div><strong id="modalTitle">Nova Angaria√ß√£o</strong></div>
      <div style="display:flex;gap:8px">
        <button class="btn" id="btnCancel">Cancelar</button>
        <button class="btn primary" id="btnSave">Guardar</button>
      </div>
    </header>
    <div class="content">
      <!-- Dados principais -->
      <div class="section-title">Dados principais</div>
      <div class="form-grid3">
        <div class="form-field">
          <label>Nome do empreendimento</label>
          <input id="a_nome_empreendimento" placeholder="Ex.: Essence, Madalena Vista Mar">
        </div>
        <div class="form-field">
          <label>Im√≥vel *</label>
          <input id="a_imovel" placeholder="Ex.: T3 Boavista, Moradia F√¢nzeres">
        </div>
        <div class="form-field">
          <label>Tipologias do empreendimento</label>
          <input id="a_tipologias" placeholder="Ex.: T1‚ÄìT4, T2 e T3">
        </div>

        <div class="form-field">
          <label>Consultor *</label>
          <select id="a_consultor">
            <option value="">‚Äî</option>
            <option>Rui Quelhas</option>
            <option>Manuel Oliveira</option>
            <option>Jo√£o Sousa</option>
            <option>Francisco dos Santos</option>
            <option>Ros√°rio Vasconcelos</option>
            <option>Armanda Meireles</option>
            <option>Audrey Lucas</option>
          </select>
        </div>
        <div class="form-field">
          <label>Gestor</label>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px">
            <select id="a_gestor">
              <option value="">‚Äî</option>
              <option>Rui Quelhas</option>
              <option>Manuel Oliveira</option>
              <option>Jo√£o Sousa</option>
              <option>Francisco dos Santos</option>
              <option>Ros√°rio Vasconcelos</option>
              <option>Armanda Meireles</option>
              <option>Audrey Lucas</option>
              <option value="outro">Outro</option>
            </select>
            <input id="a_gestor_outro" placeholder="Outro gestor" style="display:none">
          </div>
        </div>
        <div class="form-field">
          <label>Coordenador</label>
          <input id="a_coordenador" value="Rui Quelhas">
        </div>

        <div class="form-field">
          <label>Interveniente</label>
          <input id="a_interveniente" placeholder="Nome do interveniente">
        </div>
        <div class="form-field">
          <label>Propriet√°rio *</label>
          <input id="a_proprietario" placeholder="Nome do propriet√°rio">
        </div>
        <div class="form-field">
          <label>Email do propriet√°rio</label>
          <input id="a_email_proprietario" type="email" placeholder="email@exemplo.pt">
        </div>

        <div class="form-field">
          <label>Contacto propriet√°rio</label>
          <input id="a_contacto" placeholder="+351 ‚Ä¶">
        </div>
        <div class="form-field">
          <label>Data</label>
          <input id="a_data" type="date">
        </div>
        <div class="form-field">
          <label>Ref. Interna</label>
          <input id="a_ref">
        </div>

        <div class="form-field">
          <label>Nome do Promotor</label>
          <input id="a_nome_promotor">
        </div>
        <div class="form-field">
          <label>Contacto do Promotor</label>
          <input id="a_contacto_promotor">
        </div>
        <div class="form-field">
          <label>Email do Promotor</label>
          <input id="a_email_promotor" type="email">
        </div>

        <div class="form-field">
          <label>Ano de constru√ß√£o</label>
          <input id="a_ano_construcao" placeholder="Ex.: 2002">
        </div>
        <div class="form-field">
          <label>Ano de conclus√£o</label>
          <input id="a_ano_conclusao" placeholder="Ex.: 2025">
        </div>
        <div class="form-field">
          <label>Certificado energ√©tico</label>
          <select id="a_cert_energetico_classe">
            <option value="">‚Äî</option>
            <option>A+</option>
            <option>A</option>
            <option>B</option>
            <option>B-</option>
            <option>C</option>
            <option>D</option>
            <option>E</option>
            <option>F</option>
            <option>G</option>
            <option>Isento</option>
          </select>
        </div>

        <div class="form-field">
          <label>Total de Fra√ß√µes</label>
          <input id="a_total_fracoes" type="number" min="0" step="1">
        </div>
      </div>

      <!-- Localiza√ß√£o -->
      <div class="section-title">Localiza√ß√£o</div>
      <div class="form-grid3">
        <div class="form-field">
          <label>Morada</label>
          <input id="loc_morada">
        </div>
        <div class="form-field">
          <label>Zona</label>
          <input id="loc_zona">
        </div>
        <div class="form-field">
          <label>Distrito</label>
          <input id="loc_distrito">
        </div>
        <div class="form-field">
          <label>Concelho</label>
          <input id="loc_concelho">
        </div>
        <div class="form-field">
          <label>Freguesia</label>
          <input id="loc_freguesia">
        </div>
        <div class="form-field">
          <label>Coordenadas GPS</label>
          <input id="loc_gps" placeholder="Ex.: 41.15, -8.61">
        </div>
      </div>

      <!-- Natureza / Estado / Neg√≥cio -->
      <div class="section-title">Natureza, estado e neg√≥cio</div>
      <div class="form-grid3">
        <div class="form-field">
          <label>Natureza</label>
          <select id="a_natureza">
            <option value="">‚Äî</option>
            <option>Apartamento</option>
            <option>Moradia</option>
            <option>Terreno</option>
            <option>Loja</option>
            <option>Escrit√≥rio</option>
            <option>Empreendimento</option>
            <option>Outro</option>
          </select>
        </div>
        <div class="form-field">
          <label>Natureza (Outro)</label>
          <input id="a_natureza_outro">
        </div>
        <div class="form-field">
          <label>Estado</label>
          <select id="a_estado_imovel">
            <option value="">‚Äî</option>
            <option>Novo</option>
            <option>Usado</option>
            <option>Recuperado</option>
            <option>Em constru√ß√£o</option>
            <option>Em Projeto</option>
            <option>Outro</option>
          </select>
        </div>

        <div class="form-field">
          <label>Neg√≥cio</label>
          <select id="a_negocio">
            <option value="">‚Äî</option>
            <option>Venda</option>
            <option>Arrendamento</option>
            <option>Arrendamento para F√©rias</option>
            <option>Trespasse</option>
            <option>Permuta</option>
            <option>Outro</option>
          </select>
        </div>
        <div class="form-field">
          <label>Neg√≥cio (Outro)</label>
          <input id="a_negocio_outro">
        </div>
      </div>

      <!-- √Åreas -->
      <div class="section-title">√Åreas (m¬≤)</div>
      <div class="form-grid3">
        <div class="form-field">
          <label>√Årea √∫til</label>
          <input id="a_area_util" type="number" min="0" step="1">
        </div>
        <div class="form-field">
          <label>√Årea bruta</label>
          <input id="a_area_bruta" type="number" min="0" step="1">
        </div>
        <div class="form-field">
          <label>√Årea terreno</label>
          <input id="a_area_terreno" type="number" min="0" step="1">
        </div>
        <div class="form-field">
          <label>√Årea Bruta Privativa (ABP)</label>
          <input id="a_abp" type="number" min="0" step="1">
        </div>
        <div class="form-field">
          <label>√Årea Bruta Dependente (ABD)</label>
          <input id="a_abd" type="number" min="0" step="1">
        </div>
      </div>
      <div class="form-field">
        <label>Observa√ß√µes das √°reas</label>
        <textarea id="a_obs_areas" rows="2"></textarea>
      </div>

      <!-- Pre√ßo / Comiss√£o / Ajustamento -->
      <div class="section-title">Pre√ßo, comiss√£o e ajustamento</div>
      <div class="form-grid3">
        <div class="form-field">
          <label>Pre√ßo pedido (‚Ç¨)</label>
          <input id="a_preco_pedido" type="number" min="0" step="1000">
        </div>
        <div class="form-field">
          <label>Pre√ßo sugerido (‚Ç¨)</label>
          <input id="a_preco_sugerido" type="number" min="0" step="1000">
        </div>
        <div class="form-field">
          <label>% Ajustamento</label>
          <input id="a_ajustamento" type="number" step="0.1" placeholder="Ex.: -8">
        </div>
        <div class="form-field">
          <label>Comiss√£o</label>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px">
            <select id="a_comissao">
              <option value="">‚Äî</option>
              <option value="6">6%</option>
              <option value="5">5%</option>
              <option value="4">4%</option>
              <option value="3">3%</option>
              <option value="outro">Outro</option>
            </select>
            <input id="a_comissao_outro" placeholder="Ex.: 4.5%" style="display:none">
          </div>
        </div>
        <div class="form-field">
          <label>Origem do cliente</label>
          <select id="a_origem">
            <option value="">‚Äî</option>
            <option>Prospec√ß√£o ativa</option>
            <option>Recomenda√ß√£o</option>
            <option>Portal</option>
            <option>Walk-in</option>
            <option>Lead digital</option>
          </select>
        </div>
        <div class="form-field">
          <label>Estado da angaria√ß√£o</label>
          <select id="a_estado">
            <option>Novo</option>
            <option>Em Negocia√ß√£o</option>
            <option>Aprovado</option>
            <option>Perdido</option>
          </select>
        </div>
      </div>

      <!-- Destaques -->
      <div class="section-title">Destaques</div>
      <div class="check-grid-3">
        <label><input type="checkbox" id="d_exclusivo"> Exclusivo</label>
        <label><input type="checkbox" id="d_luxo"> Luxo</label>
        <label><input type="checkbox" id="d_banca"> Im√≥veis da Banca</label>
        <label><input type="checkbox" id="d_golden_visa"> Golden Visa</label>
        <label><input type="checkbox" id="d_rentab"> Rentabilidade Garantida</label>
      </div>

      <!-- Documenta√ß√£o -->
      <div class="section-title">Documenta√ß√£o entregue</div>
      <div class="check-grid-3">
        <label><input type="checkbox" id="d_cc"> Identifica√ß√£o dos Propriet√°rios</label>
        <label><input type="checkbox" id="d_contrato_med"> Contrato de Media√ß√£o</label>
        <label><input type="checkbox" id="d_caderneta"> Caderneta Predial</label>
        <label><input type="checkbox" id="d_crp"> Certid√£o Conservat√≥ria Reg. Predial</label>
        <label><input type="checkbox" id="d_cert_energetico"> Certificado Energ√©tico</label>
        <label><input type="checkbox" id="d_planta_loc"> Planta de Localiza√ß√£o / Plantas</label>
        <label><input type="checkbox" id="d_licenca"> Licen√ßa Utiliza√ß√£o/Constru√ß√£o/Dispensa</label>
        <label><input type="checkbox" id="d_fotos"> Fotografias / V√≠deo</label>
        <label><input type="checkbox" id="d_ficha_tec"> Ficha T√©cnica da Habita√ß√£o</label>
        <label><input type="checkbox" id="d_mapa_acab"> Mapa de Acabamentos</label>
        <label><input type="checkbox" id="d_titulo_ph"> T√≠tulo Constitutivo Propriedade Horizontal</label>
        <label><input type="checkbox" id="d_cert_comercial"> Certid√£o Comercial de Empresa</label>
        <label><input type="checkbox" id="d_id_socios"> Identifica√ß√£o do(s) S√≥cio(s)</label>
        <label><input type="checkbox" id="d_tabela_preco"> Tabela de Pre√ßos do Empreendimento</label>
        <label><input type="checkbox" id="d_desc_projeto"> Descri√ß√£o do Projeto</label>
        <label><input type="checkbox" id="d_minuta_cpcv"> CMI / Minuta CPCV / Plano Pagamentos</label>
        <label><input type="checkbox" id="d_pedido_info"> Pedido de Informa√ß√£o Pr√©vio</label>
        <label><input type="checkbox" id="d_proj_arq"> Projeto Arquitetura / Especialidades</label>
        <label><input type="checkbox" id="d_texto_1500"> Texto com 1500 caracteres</label>
        <label><input type="checkbox" id="d_bupi"> Registado no BUPI</label>
      </div>

      <!-- Zona envolvente -->
      <div class="section-title">Zona envolvente</div>
      <div class="check-grid-3">
        <label><input type="checkbox" id="z_aeroporto"> Aeroporto</label>
        <label><input type="checkbox" id="z_banco"> Banco</label>
        <label><input type="checkbox" id="z_areas_lazer"> √Åreas de Lazer Infantil</label>
        <label><input type="checkbox" id="z_autoestrada"> Auto-Estrada</label>
        <label><input type="checkbox" id="z_biblioteca"> Biblioteca</label>
        <label><input type="checkbox" id="z_centro_comercial"> Centro Comercial</label>
        <label><input type="checkbox" id="z_centro_cidade"> Centro da Cidade</label>
        <label><input type="checkbox" id="z_bombeiros"> Bombeiros</label>
        <label><input type="checkbox" id="z_campo"> Campo</label>
        <label><input type="checkbox" id="z_campo_golfe"> Campo de Golfe</label>
        <label><input type="checkbox" id="z_est_rodoviaria"> Esta√ß√£o Rodovi√°ria</label>
        <label><input type="checkbox" id="z_farmacia"> Farm√°cia</label>
        <label><input type="checkbox" id="z_escola"> Escola</label>
        <label><input type="checkbox" id="z_espacos_verdes"> Espa√ßos Verdes</label>
        <label><input type="checkbox" id="z_est_ferroviaria"> Esta√ß√£o Ferrovi√°ria</label>
        <label><input type="checkbox" id="z_ginasio"> Gin√°sio</label>
        <label><input type="checkbox" id="z_metro"> Metro</label>
        <label><input type="checkbox" id="z_hiper"> Hipermercado</label>
        <label><input type="checkbox" id="z_hospital"> Hospital</label>
        <label><input type="checkbox" id="z_mercado"> Mercado</label>
        <label><input type="checkbox" id="z_perto_praia"> Perto da praia</label>
        <label><input type="checkbox" id="z_praca_taxis"> Pra√ßa T√°xis</label>
        <label><input type="checkbox" id="z_piscinas"> Piscinas</label>
        <label><input type="checkbox" id="z_policia"> Pol√≠cia</label>
        <label><input type="checkbox" id="z_posto_combustivel"> Posto de Combust√≠vel</label>
        <label><input type="checkbox" id="z_transportes"> Transportes P√∫blicos</label>
        <label><input type="checkbox" id="z_zona_hist"> Zona Hist√≥rica</label>
        <label><input type="checkbox" id="z_zona_comercial"> Zona Comercial</label>
      </div>

      <!-- Infraestruturas -->
      <div class="section-title">Infraestruturas</div>
      <div class="check-grid-3">
        <label><input type="checkbox" id="i_acesso_def"> Acesso para Deficientes</label>
        <label><input type="checkbox" id="i_campo_tenis"> Campo de T√©nis</label>
        <label><input type="checkbox" id="i_adega"> Adega</label>
        <label><input type="checkbox" id="i_anexos"> Anexos</label>
        <label><input type="checkbox" id="i_arrecadacao"> Arrecada√ß√£o</label>
        <label><input type="checkbox" id="i_complexo_desportivo"> Complexo Desportivo</label>
        <label><input type="checkbox" id="i_ginasio"> Gin√°sio</label>
        <label><input type="checkbox" id="i_piscina"> Piscina</label>
        <label><input type="checkbox" id="i_jardim"> Jardim</label>
        <label><input type="checkbox" id="i_parque_infantil"> Parque infantil</label>
        <label><input type="checkbox" id="i_terraco"> Terra√ßo</label>
        <label><input type="checkbox" id="i_sala_festas"> Sal√£o de Festas</label>
        <label><input type="checkbox" id="i_sala_jogos"> Sal√£o de Jogos</label>
        <label><input type="checkbox" id="i_telheiro"> Telheiro</label>
        <label><input type="checkbox" id="i_est_ar_livre"> Estacionamento Ar-Livre</label>
        <label><input type="checkbox" id="i_est_coberto"> Estacionamento Coberto</label>
        <label><input type="checkbox" id="i_garagem"> Garagem</label>
        <label><input type="checkbox" id="i_portaria"> Portaria</label>
        <label><input type="checkbox" id="i_seg_24h"> Seguran√ßa 24 horas</label>
        <label><input type="checkbox" id="i_video_vigilancia"> V√≠deo vigil√¢ncia</label>
      </div>

      <!-- Equipamentos -->
      <div class="section-title">Equipamentos</div>
      <div class="check-grid-3">
        <label><input type="checkbox" id="e_ar_cond"> Ar Condicionado</label>
        <label><input type="checkbox" id="e_alarme"> Alarme</label>
        <label><input type="checkbox" id="e_antena"> Antena Parab√≥lica</label>
        <label><input type="checkbox" id="e_aquec_central"> Aquecimento Central</label>
        <label><input type="checkbox" id="e_barbecue"> Barbecue</label>
        <label><input type="checkbox" id="e_banheira_hidromassagem"> Banheira com Hidromassagem</label>
        <label><input type="checkbox" id="e_caldeira"> Caldeira</label>
        <label><input type="checkbox" id="e_det_gas"> Detector de G√°s</label>
        <label><input type="checkbox" id="e_det_incendio"> Detector de Inc√™ndio</label>
        <label><input type="checkbox" id="e_cofre"> Cofre</label>
        <label><input type="checkbox" id="e_det_intrusao"> Detector de Intrus√£o</label>
        <label><input type="checkbox" id="e_elevador"> Elevador</label>
        <label><input type="checkbox" id="e_esquentador"> Esquentador</label>
        <label><input type="checkbox" id="e_det_inundacao"> Detector de Inunda√ß√£o</label>
        <label><input type="checkbox" id="e_estores"> Estores El√©ctricos</label>
        <label><input type="checkbox" id="e_fogao_electrico"> Fog√£o El√©ctrico</label>
        <label><input type="checkbox" id="e_forno"> Forno</label>
        <label><input type="checkbox" id="e_exaustor"> Exaustor</label>
        <label><input type="checkbox" id="e_frigorifico"> Frigor√≠fico</label>
        <label><input type="checkbox" id="e_gerador"> Gerador</label>
        <label><input type="checkbox" id="e_isol_acustico"> Isolamento Ac√∫stico</label>
        <label><input type="checkbox" id="e_gas_botija"> G√°s Botija</label>
        <label><input type="checkbox" id="e_gas_natural"> G√°s Natural</label>
        <label><input type="checkbox" id="e_isol_termico"> Isolamento T√©rmico</label>
        <label><input type="checkbox" id="e_maq_louca"> M√°quina Lavar Lou√ßa</label>
        <label><input type="checkbox" id="e_lareira"> Lareira</label>
        <label><input type="checkbox" id="e_maq_roupa"> M√°quina Lavar Roupa</label>
        <label><input type="checkbox" id="e_mobilado"> Mobilado</label>
        <label><input type="checkbox" id="e_musica_amb"> M√∫sica ambiente</label>
        <label><input type="checkbox" id="e_maq_secar"> M√°quina Secar Roupa</label>
        <label><input type="checkbox" id="e_microondas"> Microondas</label>
        <label><input type="checkbox" id="e_piso_radiante"> Piso Radiante</label>
        <label><input type="checkbox" id="e_bomba_calor"> Bomba de Calor</label>
        <label><input type="checkbox" id="e_porta_seg"> Porta Alta Seguran√ßa</label>
        <label><input type="checkbox" id="e_agua_quente_solar"> √Ågua Quente Solar</label>
        <label><input type="checkbox" id="e_asp_central"> Aspira√ß√£o Central</label>
        <label><input type="checkbox" id="e_det_fumos"> Detector de Fumos</label>
        <label><input type="checkbox" id="e_domotica"> Dom√≥tica</label>
        <label><input type="checkbox" id="e_fogao"> Fog√£o</label>
        <label><input type="checkbox" id="e_gas_canalizado"> G√°s Canalizado</label>
        <label><input type="checkbox" id="e_jacuzzi"> Jacuzzi</label>
        <label><input type="checkbox" id="e_microgeracao"> Microgera√ß√£o Solar</label>
        <label><input type="checkbox" id="e_placa_gas"> Placa a g√°s</label>
        <label><input type="checkbox" id="e_placa_inducao"> Placa de Indu√ß√£o</label>
        <label><input type="checkbox" id="e_placa_vitro"> Placa Vitrocer√¢mica</label>
        <label><input type="checkbox" id="e_pre_alarme"> Pr√©-instala√ß√£o alarme</label>
        <label><input type="checkbox" id="e_pre_internet"> Pr√©-instala√ß√£o Internet</label>
        <label><input type="checkbox" id="e_pre_tv_cabo"> Pr√©-instala√ß√£o TV por Cabo</label>
        <label><input type="checkbox" id="e_pre_ar_cond"> Pr√©-instala√ß√£o ar condicionado</label>
        <label><input type="checkbox" id="e_pre_asp_central"> Pr√©-instala√ß√£o aspira√ß√£o central</label>
        <label><input type="checkbox" id="e_pre_aq_central"> Pr√©-instala√ß√£o Aquecimento Central</label>
        <label><input type="checkbox" id="e_pre_musica"> Pr√©-instala√ß√£o m√∫sica ambiente</label>
        <label><input type="checkbox" id="e_pre_paineis"> Pr√©-instala√ß√£o pain√©is solares</label>
        <label><input type="checkbox" id="e_recuperador"> Recuperador de calor</label>
        <label><input type="checkbox" id="e_roupeiros"> Roupeiros</label>
        <label><input type="checkbox" id="e_video_porteiro"> Video Porteiro</label>
        <label><input type="checkbox" id="e_vidros_duplos"> Vidros Duplos</label>
        <label><input type="checkbox" id="e_termoacumulador"> Termoacumulador</label>
        <label><input type="checkbox" id="e_toalheiros_aquecidos"> Toalheiros Aquecidos</label>
      </div>

      <!-- Observa√ß√µes principais -->
      <div class="section-title">Observa√ß√µes (quantitativo)</div>
      <div class="form-field">
        <label>Observa√ß√µes gerais</label>
        <textarea id="a_notas" rows="3"></textarea>
        <div id="obsCounter" class="small-hint">0/1500 caracteres</div>
      </div>

      <!-- Notas por interveniente -->
      <div class="section-title">Notas internas</div>
      <div class="form-grid3">
        <div class="form-field">
          <label>Notas do Consultor</label>
          <textarea id="a_notas_consultor" rows="2"></textarea>
        </div>
        <div class="form-field">
          <label>Notas do Coordenador de Zona</label>
          <textarea id="a_notas_coordenador" rows="2"></textarea>
        </div>
        <div class="form-field">
          <label>Notas da Assistente</label>
          <textarea id="a_notas_assistente" rows="2"></textarea>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* ===== Estado global ===== */
const LS_KEY = 'gpp_angaria√ß√µes_v3';
const EDIT_KEY = 'gpp_ang_edit_mode';
const COLS = ["Novo","Em Negocia√ß√£o","Aprovado","Perdido"];
const CONSULT = [
  "Rui Quelhas",
  "Manuel Oliveira",
  "Jo√£o Sousa",
  "Francisco dos Santos",
  "Ros√°rio Vasconcelos",
  "Armanda Meireles",
  "Audrey Lucas"
];

let ANG = [];
let FILTER = {
  q:'',
  consultor:'',
  estado:'',
  ini:'',
  fim:'',
  ajMin:'',
  ajMax:'',
  showHidden:false,
  onlyHidden:false
};
let EDIT_MODE = false;
let EDIT_ID = null;

const $ = id => document.getElementById(id);
const norm = s => String(s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');

/* ===== Storage helpers ===== */
function loadLS(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    return raw? JSON.parse(raw):[];
  }catch{return [];}
}
function saveLS(){
  localStorage.setItem(LS_KEY, JSON.stringify(ANG));
}

/* ===== Edit mode lock ===== */
function applyEditUI(){
  const btnNew = $('btnNew');
  const toggle = $('toggleEdit');

  if(EDIT_MODE){
    toggle.classList.add('primary');
    toggle.textContent = 'üîì Edi√ß√£o ativa';
    btnNew.disabled = false;
  } else {
    toggle.classList.remove('primary');
    toggle.textContent = 'üîí Edi√ß√£o bloqueada';
    btnNew.disabled = true;
  }
}
function setEditMode(on){
  EDIT_MODE = !!on;
  localStorage.setItem(EDIT_KEY, EDIT_MODE?'1':'0');
  applyEditUI();
  renderBoard();
}

/* ===== Filtros ===== */
function loadFilters(){
  const sel = $('f_consultor');
  sel.innerHTML = '<option value="">(Todos)</option>'+CONSULT.map(c=>`<option>${c}</option>`).join('');
}
function applyFilterStateFromUI(){
  FILTER.q = $('f_q').value.trim();
  FILTER.consultor = $('f_consultor').value;
  FILTER.estado = $('f_estado').value;
  FILTER.ini = $('f_ini').value;
  FILTER.fim = $('f_fim').value;
  FILTER.ajMin = $('f_aj_min').value;
  FILTER.ajMax = $('f_aj_max').value;
  FILTER.showHidden = $('f_show_hidden').checked;
  FILTER.onlyHidden = $('f_only_hidden').checked;
}
function clearFilterUI(){
  $('f_q').value = '';
  $('f_consultor').value = '';
  $('f_estado').value = '';
  $('f_ini').value = '';
  $('f_fim').value = '';
  $('f_aj_min').value = '';
  $('f_aj_max').value = '';
  $('f_show_hidden').checked = false;
  $('f_only_hidden').checked = false;
  FILTER = {q:'',consultor:'',estado:'',ini:'',fim:'',ajMin:'',ajMax:'',showHidden:false,onlyHidden:false};
}

$('applyFilters').addEventListener('click',()=>{
  applyFilterStateFromUI();
  renderBoard();
});
$('clearFilters').addEventListener('click',()=>{
  clearFilterUI();
  renderBoard();
});
let qTimer=null;
$('f_q').addEventListener('input',()=>{
  clearTimeout(qTimer);
  qTimer = setTimeout(()=>{ applyFilterStateFromUI(); renderBoard(); },200);
});

/* ===== Observa√ß√µes contador ===== */
function updateObsCounter(){
  const ta = $('a_notas');
  const c = $('obsCounter');
  if(!ta || !c) return;
  let txt = ta.value || '';
  if(txt.length > 1500){
    txt = txt.slice(0,1500);
    ta.value = txt;
  }
  c.textContent = txt.length + '/1500 caracteres';
  c.style.color = txt.length > 1400 ? '#ff8080' : '#9AA0A6';
}
$('a_notas').addEventListener('input', updateObsCounter);

/* ===== Modal ===== */
function openModal(edit=null){
  if(!EDIT_MODE){
    alert('Modo de edi√ß√£o bloqueado. Clique em "üîì Edi√ß√£o ativa" para criar ou editar angaria√ß√µes.');
    return;
  }
  EDIT_ID = edit? edit.id : null;
  $('modalTitle').textContent = edit? 'Editar Angaria√ß√£o' : 'Nova Angaria√ß√£o';

  const set = (id,val='') => { const el=$(id); if(el) el.value = (val ?? ''); };
  const chk = (id,val)=>{ const el=$(id); if(el) el.checked = !!val; };

  const a = edit || {};
  // principais
  set('a_nome_empreendimento', a.nome_empreendimento);
  set('a_imovel', a.imovel);
  set('a_tipologias', a.tipologias);
  set('a_consultor', a.consultor);

  // gestor
  if(a.gestor && CONSULT.includes(a.gestor)){
    set('a_gestor', a.gestor);
    $('a_gestor_outro').style.display='none';
    $('a_gestor_outro').value='';
  } else if(a.gestor){
    set('a_gestor','outro');
    $('a_gestor_outro').style.display='block';
    $('a_gestor_outro').value = a.gestor;
  } else {
    set('a_gestor','');
    $('a_gestor_outro').style.display='none';
    $('a_gestor_outro').value='';
  }

  set('a_coordenador', a.coordenador || 'Rui Quelhas');
  set('a_interveniente', a.interveniente);
  set('a_proprietario', a.proprietario);
  set('a_email_proprietario', a.email_proprietario);
  set('a_contacto', a.contacto);
  set('a_data', a.data || new Date().toISOString().slice(0,10));
  set('a_ref', a.ref);

  set('a_nome_promotor', a.nome_promotor);
  set('a_contacto_promotor', a.contacto_promotor);
  set('a_email_promotor', a.email_promotor);
  set('a_ano_construcao', a.ano_construcao);
  set('a_ano_conclusao', a.ano_conclusao);
  set('a_cert_energetico_classe', a.cert_energetico_classe);
  set('a_total_fracoes', a.total_fracoes);

  // localiza√ß√£o
  set('loc_morada', a.loc_morada);
  set('loc_zona', a.loc_zona);
  set('loc_distrito', a.loc_distrito);
  set('loc_concelho', a.loc_concelho);
  set('loc_freguesia', a.loc_freguesia);
  set('loc_gps', a.loc_gps);

  // natureza / estado / neg√≥cio
  set('a_natureza', a.natureza);
  set('a_natureza_outro', a.natureza_outro);
  set('a_estado_imovel', a.estado_imovel);
  set('a_negocio', a.negocio);
  set('a_negocio_outro', a.negocio_outro);

  // √°reas
  set('a_area_util', a.area_util);
  set('a_area_bruta', a.area_bruta);
  set('a_area_terreno', a.area_terreno);
  set('a_abp', a.abp);
  set('a_abd', a.abd);
  set('a_obs_areas', a.obs_areas);

  // pre√ßo / comiss√£o / ajustamento
  set('a_preco_pedido', a.preco_pedido);
  set('a_preco_sugerido', a.preco_sugerido);
  set('a_ajustamento', a.ajustamento);
  if(a.comissao_pct && ['6','5','4','3'].includes(String(a.comissao_pct))){
    set('a_comissao', String(a.comissao_pct));
    $('a_comissao_outro').style.display='none';
    $('a_comissao_outro').value='';
  } else if(a.comissao_pct){
    set('a_comissao','outro');
    $('a_comissao_outro').style.display='block';
    $('a_comissao_outro').value = a.comissao_pct+'%';
  } else {
    set('a_comissao','');
    $('a_comissao_outro').style.display='none';
    $('a_comissao_outro').value='';
  }
  set('a_origem', a.origem);
  set('a_estado', a.estado || 'Novo');

  // destaques
  chk('d_exclusivo', a.d_exclusivo);
  chk('d_luxo', a.d_luxo);
  chk('d_banca', a.d_banca);
  chk('d_golden_visa', a.d_golden_visa);
  chk('d_rentab', a.d_rentab);

  // docs
  chk('d_cc', a.d_cc);
  chk('d_contrato_med', a.d_contrato_med);
  chk('d_caderneta', a.d_caderneta);
  chk('d_crp', a.d_crp);
  chk('d_cert_energetico', a.d_cert_energetico);
  chk('d_planta_loc', a.d_planta_loc);
  chk('d_licenca', a.d_licenca);
  chk('d_fotos', a.d_fotos);
  chk('d_ficha_tec', a.d_ficha_tec);
  chk('d_mapa_acab', a.d_mapa_acab);
  chk('d_titulo_ph', a.d_titulo_ph);
  chk('d_cert_comercial', a.d_cert_comercial);
  chk('d_id_socios', a.d_id_socios);
  chk('d_tabela_preco', a.d_tabela_preco);
  chk('d_desc_projeto', a.d_desc_projeto);
  chk('d_minuta_cpcv', a.d_minuta_cpcv);
  chk('d_pedido_info', a.d_pedido_info);
  chk('d_proj_arq', a.d_proj_arq);
  chk('d_texto_1500', a.d_texto_1500);
  chk('d_bupi', a.d_bupi);

  // zona
  const zKeys = ['aeroporto','banco','areas_lazer','autoestrada','biblioteca','centro_comercial','centro_cidade',
    'bombeiros','campo','campo_golfe','est_rodoviaria','farmacia','escola','espacos_verdes',
    'est_ferroviaria','ginasio','metro','hiper','hospital','mercado','perto_praia','praca_taxis',
    'piscinas','policia','posto_combustivel','transportes','zona_hist','zona_comercial'];
  zKeys.forEach(k=>chk('z_'+k, a['z_'+k]));

  // infra
  const iKeys = ['acesso_def','campo_tenis','adega','anexos','arrecadacao','complexo_desportivo','ginasio',
    'piscina','jardim','parque_infantil','terraco','sala_festas','sala_jogos','telheiro',
    'est_ar_livre','est_coberto','garagem','portaria','seg_24h','video_vigilancia'];
  iKeys.forEach(k=>chk('i_'+k, a['i_'+k]));

  // equipamentos
  const eKeys = [
    'ar_cond','alarme','antena','aquec_central','barbecue','banheira_hidromassagem','caldeira','det_gas',
    'det_incendio','cofre','det_intrusao','elevador','esquentador','det_inundacao','estores',
    'fogao_electrico','forno','exaustor','frigorifico','gerador','isol_acustico','gas_botija','gas_natural',
    'isol_termico','maq_louca','lareira','maq_roupa','mobilado','musica_amb','maq_secar','microondas',
    'piso_radiante','bomba_calor','porta_seg','agua_quente_solar','asp_central','det_fumos','domotica',
    'fogao','gas_canalizado','jacuzzi','microgeracao','placa_gas','placa_inducao','placa_vitro',
    'pre_alarme','pre_internet','pre_tv_cabo','pre_ar_cond','pre_asp_central','pre_aq_central',
    'pre_musica','pre_paineis','recuperador','roupeiros','video_porteiro','vidros_duplos','termoacumulador',
    'toalheiros_aquecidos'
  ];
  eKeys.forEach(k=>chk('e_'+k, a['e_'+k]));

  // observa√ß√µes e notas
  set('a_notas', a.notas);
  set('a_notas_consultor', a.notas_consultor);
  set('a_notas_coordenador', a.notas_coordenador);
  set('a_notas_assistente', a.notas_assistente);
  updateObsCounter();

  $('angModal').classList.add('show');
}
$('btnCancel').addEventListener('click',()=> $('angModal').classList.remove('show'));
$('btnNew').addEventListener('click',()=> openModal(null));
$('a_comissao').addEventListener('change', e=>{
  if(e.target.value === 'outro'){
    $('a_comissao_outro').style.display='block';
  } else {
    $('a_comissao_outro').style.display='none';
    $('a_comissao_outro').value='';
  }
});
$('a_gestor').addEventListener('change', e=>{
  if(e.target.value === 'outro'){
    $('a_gestor_outro').style.display='block';
  } else {
    $('a_gestor_outro').style.display='none';
    $('a_gestor_outro').value='';
  }
});

/* ===== Guardar ===== */
$('btnSave').addEventListener('click',()=>{
  if(!EDIT_MODE){
    alert('Modo de edi√ß√£o bloqueado. Clique em "üîì Edi√ß√£o ativa" para guardar altera√ß√µes.');
    return;
  }

  const get = id => { const el=$(id); return el? el.value.trim():''; };
  const chk = id => { const el=$(id); return el? !!el.checked:false; };

  const imovel = get('a_imovel');
  const consultor = get('a_consultor');
  const proprietario = get('a_proprietario');

  if(!imovel){ alert('Indique o im√≥vel.'); return; }
  if(!consultor){ alert('Selecione o consultor.'); return; }
  if(!proprietario){ alert('Indique o propriet√°rio.'); return; }

  const preco_pedido = get('a_preco_pedido');
  const preco_sugerido = get('a_preco_sugerido');
  let ajust = get('a_ajustamento');

  if(preco_pedido && preco_sugerido && !ajust){
    const pp = Number(preco_pedido);
    const ps = Number(preco_sugerido);
    if(pp>0 && ps>0){
      ajust = (((ps-pp)/pp)*100).toFixed(1);
    }
  }

  // comiss√£o
  let comissao_pct = '';
  const comSel = get('a_comissao');
  if(comSel === 'outro'){
    const raw = get('a_comissao_outro').replace('%','').replace(',','.');
    const n = Number(raw);
    if(Number.isFinite(n)) comissao_pct = n;
  } else if(comSel){
    comissao_pct = Number(comSel);
  }

  // gestor
  let gestor = '';
  const gSel = get('a_gestor');
  if(gSel === 'outro'){
    gestor = get('a_gestor_outro') || '';
  } else {
    gestor = gSel;
  }

  const zKeys = ['aeroporto','banco','areas_lazer','autoestrada','biblioteca','centro_comercial','centro_cidade',
    'bombeiros','campo','campo_golfe','est_rodoviaria','farmacia','escola','espacos_verdes',
    'est_ferroviaria','ginasio','metro','hiper','hospital','mercado','perto_praia','praca_taxis',
    'piscinas','policia','posto_combustivel','transportes','zona_hist','zona_comercial'];
  const iKeys = ['acesso_def','campo_tenis','adega','anexos','arrecadacao','complexo_desportivo','ginasio',
    'piscina','jardim','parque_infantil','terraco','sala_festas','sala_jogos','telheiro',
    'est_ar_livre','est_coberto','garagem','portaria','seg_24h','video_vigilancia'];
  const eKeys = [
    'ar_cond','alarme','antena','aquec_central','barbecue','banheira_hidromassagem','caldeira','det_gas',
    'det_incendio','cofre','det_intrusao','elevador','esquentador','det_inundacao','estores',
    'fogao_electrico','forno','exaustor','frigorifico','gerador','isol_acustico','gas_botija','gas_natural',
    'isol_termico','maq_louca','lareira','maq_roupa','mobilado','musica_amb','maq_secar','microondas',
    'piso_radiante','bomba_calor','porta_seg','agua_quente_solar','asp_central','det_fumos','domotica',
    'fogao','gas_canalizado','jacuzzi','microgeracao','placa_gas','placa_inducao','placa_vitro',
    'pre_alarme','pre_internet','pre_tv_cabo','pre_ar_cond','pre_asp_central','pre_aq_central',
    'pre_musica','pre_paineis','recuperador','roupeiros','video_porteiro','vidros_duplos','termoacumulador',
    'toalheiros_aquecidos'
  ];

  const rec = {
    id: EDIT_ID || ('A'+Math.random().toString(36).slice(2,9)+Date.now().toString(36).slice(-4)),
    // principais
    nome_empreendimento: get('a_nome_empreendimento'),
    imovel,
    tipologias: get('a_tipologias'),
    consultor,
    gestor,
    coordenador: get('a_coordenador') || 'Rui Quelhas',
    interveniente: get('a_interveniente'),
    proprietario,
    email_proprietario: get('a_email_proprietario'),
    contacto: get('a_contacto'),
    data: get('a_data'),
    ref: get('a_ref'),
    nome_promotor: get('a_nome_promotor'),
    contacto_promotor: get('a_contacto_promotor'),
    email_promotor: get('a_email_promotor'),
    ano_construcao: get('a_ano_construcao'),
    ano_conclusao: get('a_ano_conclusao'),
    cert_energetico_classe: get('a_cert_energetico_classe'),
    total_fracoes: get('a_total_fracoes'),

    // localiza√ß√£o
    loc_morada: get('loc_morada'),
    loc_zona: get('loc_zona'),
    loc_distrito: get('loc_distrito'),
    loc_concelho: get('loc_concelho'),
    loc_freguesia: get('loc_freguesia'),
    loc_gps: get('loc_gps'),

    // natureza / estado / neg√≥cio
    natureza: get('a_natureza'),
    natureza_outro: get('a_natureza_outro'),
    estado_imovel: get('a_estado_imovel'),
    negocio: get('a_negocio'),
    negocio_outro: get('a_negocio_outro'),

    // √°reas
    area_util: get('a_area_util'),
    area_bruta: get('a_area_bruta'),
    area_terreno: get('a_area_terreno'),
    abp: get('a_abp'),
    abd: get('a_abd'),
    obs_areas: get('a_obs_areas'),

    // pre√ßo / comiss√£o / ajustamento
    preco_pedido,
    preco_sugerido,
    comissao_pct,
    ajustamento: ajust,
    origem: get('a_origem'),
    estado: get('a_estado') || 'Novo',

    // destaques
    d_exclusivo: chk('d_exclusivo'),
    d_luxo: chk('d_luxo'),
    d_banca: chk('d_banca'),
    d_golden_visa: chk('d_golden_visa'),
    d_rentab: chk('d_rentab'),

    // docs
    d_cc: chk('d_cc'),
    d_contrato_med: chk('d_contrato_med'),
    d_caderneta: chk('d_caderneta'),
    d_crp: chk('d_crp'),
    d_cert_energetico: chk('d_cert_energetico'),
    d_planta_loc: chk('d_planta_loc'),
    d_licenca: chk('d_licenca'),
    d_fotos: chk('d_fotos'),
    d_ficha_tec: chk('d_ficha_tec'),
    d_mapa_acab: chk('d_mapa_acab'),
    d_titulo_ph: chk('d_titulo_ph'),
    d_cert_comercial: chk('d_cert_comercial'),
    d_id_socios: chk('d_id_socios'),
    d_tabela_preco: chk('d_tabela_preco'),
    d_desc_projeto: chk('d_desc_projeto'),
    d_minuta_cpcv: chk('d_minuta_cpcv'),
    d_pedido_info: chk('d_pedido_info'),
    d_proj_arq: chk('d_proj_arq'),
    d_texto_1500: chk('d_texto_1500'),
    d_bupi: chk('d_bupi'),

    // observa√ß√µes e notas
    visivel: true,
    notas: get('a_notas'),
    notas_consultor: get('a_notas_consultor'),
    notas_coordenador: get('a_notas_coordenador'),
    notas_assistente: get('a_notas_assistente')
  };

  zKeys.forEach(k=> rec['z_'+k] = chk('z_'+k));
  iKeys.forEach(k=> rec['i_'+k] = chk('i_'+k));
  eKeys.forEach(k=> rec['e_'+k] = chk('e_'+k));

  const idx = ANG.findIndex(a=>a.id===rec.id);
  if(idx>=0) ANG[idx] = Object.assign(ANG[idx], rec);
  else ANG.push(rec);

  saveLS();
  $('angModal').classList.remove('show');
  EDIT_ID = null;
  renderBoard();
});

/* ===== Renderiza√ß√£o ===== */
function fmtDate(d){
  if(!d) return '‚Äî';
  try{ return new Date(d).toLocaleDateString('pt-PT'); }catch{return d;}
}
function fmtNum(v){
  if(!v) return '‚Äî';
  const n=Number(v);
  if(!Number.isFinite(n)) return v;
  return n.toLocaleString('pt-PT');
}
function fmtPct(v){
  if(v===undefined || v===null || v==='') return '‚Äî';
  const n=Number(v);
  if(!Number.isFinite(n)) return v;
  return n.toFixed(1)+'%';
}

function filterDataset(){
  let out = [...ANG];
  const t = norm(FILTER.q||'');

  if(t){
    out = out.filter(a=>{
      const blob = [
        a.nome_empreendimento,a.imovel,a.proprietario,a.consultor,a.ref,a.notas
      ].map(norm).join(' ');
      return blob.includes(t);
    });
  }
  if(FILTER.consultor) out = out.filter(a=>a.consultor===FILTER.consultor);
  if(FILTER.estado) out = out.filter(a=>a.estado===FILTER.estado);
  if(FILTER.ini) out = out.filter(a=>!a.data || a.data>=FILTER.ini);
  if(FILTER.fim) out = out.filter(a=>!a.data || a.data<=FILTER.fim);
  if(FILTER.ajMin){
    const m = Number(FILTER.ajMin);
    out = out.filter(a=>a.ajustamento==='' || a.ajustamento===undefined || Number(a.ajustamento)>=m);
  }
  if(FILTER.ajMax){
    const M = Number(FILTER.ajMax);
    out = out.filter(a=>a.ajustamento==='' || a.ajustamento===undefined || Number(a.ajustamento)<=M);
  }
  if(FILTER.onlyHidden) out = out.filter(a=>a.visivel===false);
  if(!FILTER.showHidden && !FILTER.onlyHidden) out = out.filter(a=>a.visivel!==false);
  return out;
}

function renderKpi(filtered){
  const el = $('kpiBar');
  if(!filtered.length){
    el.textContent = 'Sem angaria√ß√µes nos filtros atuais.';
    return;
  }
  const total = filtered.length;
  const aprov = filtered.filter(a=>a.estado==='Aprovado').length;
  const perdido = filtered.filter(a=>a.estado==='Perdido').length;
  const somaPedido = filtered.reduce((s,a)=>s+(Number(a.preco_pedido)||0),0);
  const somaSugerido = filtered.reduce((s,a)=>s+(Number(a.preco_sugerido)||0),0);
  const mediaAj = (()=>{
    const arr = filtered.map(a=>Number(a.ajustamento)).filter(Number.isFinite);
    if(!arr.length) return '‚Äî';
    const m = arr.reduce((s,x)=>s+x,0)/arr.length;
    return m.toFixed(1)+'%';
  })();

  el.innerHTML = `
    <span class="kpi-badge">Total: ${total}</span>
    <span class="kpi-badge">Aprovadas: ${aprov}</span>
    <span class="kpi-badge">Perdidas: ${perdido}</span>
    <span class="kpi-badge">Volume pedido: ${somaPedido.toLocaleString('pt-PT')} ‚Ç¨</span>
    <span class="kpi-badge">Volume sugerido: ${somaSugerido.toLocaleString('pt-PT')} ‚Ç¨</span>
    <span class="kpi-badge highlight">M√©dia ajustamento: ${mediaAj}</span>
  `;
}

function renderChart(filtered){
  const box = $('chartRows');
  box.innerHTML = '';
  if(!filtered.length) return;
  const map = {};
  filtered.forEach(a=>{
    if(!a.consultor) return;
    map[a.consultor] = (map[a.consultor] || 0) + 1;
  });
  const entries = Object.entries(map).sort((a,b)=>b[1]-a[1]);
  if(!entries.length) return;
  const max = entries[0][1];

  entries.forEach(([name,val])=>{
    const row = document.createElement('div');
    row.className = 'chart-row';
    row.innerHTML = `
      <div class="chart-label">${name}</div>
      <div class="chart-bar-wrap">
        <div class="chart-bar" style="width:${(val/max*100).toFixed(0)}%"></div>
      </div>
      <div style="font-size:11px;color:#ccc">${val}</div>
    `;
    box.appendChild(row);
  });
}

function renderBoard(){
  const board = $('board');
  board.innerHTML = '';

  const filtered = filterDataset();
  renderKpi(filtered);
  renderChart(filtered);

  const byState = COLS.map(col=>({
    estado: col,
    items: filtered.filter(a=>a.estado===col)
  }));

  byState.forEach(col=>{
    const cEl = document.createElement('div');
    cEl.className='col';
    cEl.innerHTML = `
      <header>
        <span class="title">${col.estado}</span>
        <span class="counter">${col.items.length}</span>
      </header>
      <div class="list" id="list_${col.estado.replace(/\s/g,'_')}"></div>
    `;
    board.appendChild(cEl);

    const listEl = cEl.querySelector('.list');
    col.items.forEach(a=>{
      const card = document.createElement('div');
      card.className = 'card';

      const docsOk = (a.d_cc && a.d_contrato_med && a.d_caderneta && a.d_crp && a.d_cert_energetico) ? 'Completa' : 'Incompleta';
      const badgeDocs = docsOk==='Completa' ? '<span class="badge green">Doc. completa</span>' : '<span class="badge yellow">Doc. incompleta</span>';

      let badgeAj='';
      if(a.ajustamento!=='' && a.ajustamento!==undefined){
        const n = Number(a.ajustamento);
        if(Number.isFinite(n)){
          if(n<=-10) badgeAj = '<span class="badge green">'+fmtPct(n)+'</span>';
          else if(n<0) badgeAj = '<span class="badge yellow">'+fmtPct(n)+'</span>';
          else badgeAj = '<span class="badge red">'+fmtPct(n)+'</span>';
        }
      }

      const disabledAttr = EDIT_MODE ? '' : 'disabled';

      card.innerHTML = `
        <div class="top">
          <div>
            <div class="name">${a.nome_empreendimento || a.imovel || '‚Äî'}</div>
            <div class="meta">
              ${a.consultor||'‚Äî'}
              ${a.ref? ' ¬∑ '+a.ref:''}
            </div>
          </div>
          <div>${badgeAj}</div>
        </div>
        ${a.imovel ? `<div class="row"><b>Im√≥vel:</b> ${a.imovel}</div>`:''}
        ${a.nome_promotor ? `<div class="row"><b>Promotor:</b> ${a.nome_promotor}</div>`:''}
        <div class="row"><b>Propriet√°rio:</b> ${a.proprietario||'‚Äî'}</div>
        <div class="row"><b>Localiza√ß√£o:</b> ${a.loc_concelho||'‚Äî'} ${a.loc_freguesia? ' ¬∑ '+a.loc_freguesia:''}</div>
        <div class="row"><b>Data:</b> ${fmtDate(a.data)}</div>
        <div class="row">
          <b>Pre√ßo pedido:</b> ${fmtNum(a.preco_pedido)} ‚Ç¨
          &nbsp;¬∑&nbsp;
          <b>Sugerido:</b> ${fmtNum(a.preco_sugerido)} ‚Ç¨
        </div>
        <div class="row">
          <b>Comiss√£o:</b> ${a.comissao_pct? a.comissao_pct+'%' : '‚Äî'}
          &nbsp;¬∑&nbsp;
          <b>Origem:</b> ${a.origem||'‚Äî'}
        </div>
        <div class="row">${badgeDocs} ${a.d_bupi ? ' ¬∑ <span class="badge">BUPI</span>' : ''}</div>
        ${a.notas? `<div class="row"><small>${a.notas}</small></div>`:''}
        <div class="row">
          <small>${
            [
              a.d_exclusivo?'Exclusivo':'',
              a.d_luxo?'Luxo':'',
              a.d_banca?'Banca':'',
              a.d_golden_visa?'Golden Visa':'',
              a.d_rentab?'Rentabilidade':''
            ].filter(Boolean).join(' ¬∑ ')
          }</small>
        </div>
        <div class="actions">
          <button class="btn-sm" data-act="edit" ${disabledAttr}>Editar</button>
          <button class="btn-sm" data-act="prop" ${disabledAttr}>Proposta Angaria√ß√£o</button>
          <select class="select-move" data-id="${a.id}" ${disabledAttr}>
            <option value="">Mover‚Ä¶</option>
            ${COLS.map(c=>`<option value="${c}" ${c===a.estado?'disabled':''}>${c}</option>`).join('')}
          </select>
          <button class="btn-sm danger" data-act="del" ${disabledAttr}>Apagar</button>
          <button class="btn-sm" data-act="toggle" ${disabledAttr}>${a.visivel===false?'Tornar vis√≠vel':'Tornar invis√≠vel'}</button>
        </div>
      `;
      if(a.visivel===false) card.style.opacity = .45;

      card.querySelector('[data-act="edit"]').addEventListener('click',()=>{
        if(!EDIT_MODE){ alert('Modo de edi√ß√£o bloqueado. Ative "üîì Edi√ß√£o ativa" para editar.'); return; }
        openModal(a);
      });
      card.querySelector('[data-act="prop"]').addEventListener('click',()=>{
        if(!EDIT_MODE){ alert('Modo de edi√ß√£o bloqueado. Ative "üîì Edi√ß√£o ativa" para gerar proposta.'); return; }
        gerarProposta(a);
      });
      card.querySelector('[data-act="del"]').addEventListener('click',()=>{
        if(!EDIT_MODE){ alert('Modo de edi√ß√£o bloqueado. Ative "üîì Edi√ß√£o ativa" para apagar.'); return; }
        if(!confirm('Eliminar esta angaria√ß√£o?')) return;
        ANG = ANG.filter(x=>x.id!==a.id);
        saveLS();
        renderBoard();
      });
      card.querySelector('[data-act="toggle"]').addEventListener('click',()=>{
        if(!EDIT_MODE){ alert('Modo de edi√ß√£o bloqueado. Ative "üîì Edi√ß√£o ativa" para alterar visibilidade.'); return; }
        a.visivel = a.visivel===false ? true : false;
        saveLS();
        renderBoard();
      });
      card.querySelector('.select-move').addEventListener('change',e=>{
        if(!EDIT_MODE){
          e.target.value='';
          alert('Modo de edi√ß√£o bloqueado. Ative "üîì Edi√ß√£o ativa" para mover.');
          return;
        }
        const destino = e.target.value;
        if(!destino || !COLS.includes(destino)) return;
        a.estado = destino;
        saveLS();
        renderBoard();
      });

      listEl.appendChild(card);
    });
  });
}

/* ===== Proposta Angaria√ß√£o (Word simples) ===== */
function gerarProposta(a){
  const texto = `
Proposta de Angaria√ß√£o

Empreendimento: ${a.nome_empreendimento||''}
Im√≥vel: ${a.imovel||''}
Tipologias: ${a.tipologias||''}

Natureza: ${a.natureza||''} ${a.natureza_outro? ' ('+a.natureza_outro+')':''}
Neg√≥cio: ${a.negocio||''} ${a.negocio_outro? ' ('+a.negocio_outro+')':''}
Estado do im√≥vel: ${a.estado_imovel||''}

Localiza√ß√£o:
  Morada: ${a.loc_morada||''}
  Zona: ${a.loc_zona||''}
  Distrito: ${a.loc_distrito||''}
  Concelho: ${a.loc_concelho||''}
  Freguesia: ${a.loc_freguesia||''}
  Coordenadas: ${a.loc_gps||''}

Propriet√°rio: ${a.proprietario||''}
Email propriet√°rio: ${a.email_proprietario||''}
Consultor: ${a.consultor||''}
Gestor: ${a.gestor||''}
Coordenador: ${a.coordenador||''}
Interveniente: ${a.interveniente||''}
Refer√™ncia interna: ${a.ref||''}
Data: ${fmtDate(a.data)||''}

Promotor:
  Nome: ${a.nome_promotor||''}
  Contacto: ${a.contacto_promotor||''}
  Email: ${a.email_promotor||''}

Ano de constru√ß√£o: ${a.ano_construcao||''}
Ano de conclus√£o: ${a.ano_conclusao||''}
Certificado energ√©tico: ${a.cert_energetico_classe||''}
Total de fra√ß√µes: ${a.total_fracoes||''}

√Åreas:
  √ötil: ${fmtNum(a.area_util)} m¬≤
  Bruta: ${fmtNum(a.area_bruta)} m¬≤
  Terreno: ${fmtNum(a.area_terreno)} m¬≤
  ABP: ${fmtNum(a.abp)} m¬≤
  ABD: ${fmtNum(a.abd)} m¬≤
  Observa√ß√µes: ${a.obs_areas||''}

Pre√ßo pedido: ${fmtNum(a.preco_pedido)} ‚Ç¨
Pre√ßo sugerido: ${fmtNum(a.preco_sugerido)} ‚Ç¨
% Ajustamento: ${fmtPct(a.ajustamento)}

Comiss√£o: ${a.comissao_pct? a.comissao_pct+'%' : '‚Äî'}
Origem do cliente: ${a.origem||''}
Estado da angaria√ß√£o: ${a.estado||''}

Documenta√ß√£o (resumo):
  Ident. Propriet√°rios: ${a.d_cc?'Sim':'N√£o'}
  Contrato de Media√ß√£o: ${a.d_contrato_med?'Sim':'N√£o'}
  Caderneta Predial: ${a.d_caderneta?'Sim':'N√£o'}
  CRP: ${a.d_crp?'Sim':'N√£o'}
  Cert. Energ√©tico: ${a.d_cert_energetico?'Sim':'N√£o'}
  Registado no BUPI: ${a.d_bupi?'Sim':'N√£o'}

Observa√ß√µes gerais:
${a.notas||''}

Notas Consultor:
${a.notas_consultor||''}

Notas Coordenador:
${a.notas_coordenador||''}

Notas Assistente:
${a.notas_assistente||''}
`;
  const blob = new Blob([texto],{type:'application/msword'});
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = `Proposta_Angariacao_${(a.ref||a.imovel||'angariacao').replace(/\s+/g,'_')}.doc`;
  document.body.appendChild(link);
  link.click();
  link.remove();
  URL.revokeObjectURL(url);
}

/* ===== Exporta√ß√£o CSV ===== */
function exportCsv(){
  const rows = [];
  const headers = [
    "ID","Empreendimento","Im√≥vel","Tipologias",
    "Natureza","Neg√≥cio","EstadoIm√≥vel",
    "Propriet√°rio","EmailPropriet√°rio","Consultor","Gestor","Coordenador","Interveniente",
    "Data","Ref","EstadoAngaria√ß√£o",
    "Morada","Zona","Concelho","Freguesia",
    "AnoConstru√ß√£o","AnoConclus√£o","CertEnerg√©tico","TotalFra√ß√µes",
    "Pre√ßoPedido","Pre√ßoSugerido","Comiss√£o(%)","Ajustamento(%)",
    "Origem","Vis√≠vel","Notas","BUPI","DocCompleta"
  ];
  rows.push(headers);

  const data = filterDataset();
  data.forEach(a=>{
    const docsOk = (a.d_cc && a.d_contrato_med && a.d_caderneta && a.d_crp && a.d_cert_energetico) ? 'Sim':'N√£o';
    rows.push([
      a.id,
      a.nome_empreendimento||'',
      a.imovel||'',
      a.tipologias||'',
      a.natureza||'',
      a.negocio||'',
      a.estado_imovel||'',
      a.proprietario||'',
      a.email_proprietario||'',
      a.consultor||'',
      a.gestor||'',
      a.coordenador||'',
      a.interveniente||'',
      a.data||'',
      a.ref||'',
      a.estado||'',
      a.loc_morada||'',
      a.loc_zona||'',
      a.loc_concelho||'',
      a.loc_freguesia||'',
      a.ano_construcao||'',
      a.ano_conclusao||'',
      a.cert_energetico_classe||'',
      a.total_fracoes||'',
      a.preco_pedido||'',
      a.preco_sugerido||'',
      (a.comissao_pct!==undefined && a.comissao_pct!==''? a.comissao_pct:''),
      (a.ajustamento!==undefined && a.ajustamento!==''? a.ajustamento:''),
      a.origem||'',
      (a.visivel===false?'N√£o':'Sim'),
      (a.notas||'').replace(/\r?\n/g,' '),
      a.d_bupi?'Sim':'N√£o',
      docsOk
    ]);
  });

  const csv = rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const aEl = document.createElement('a');
  aEl.href = url;
  aEl.download = 'angariacoes.csv';
  document.body.appendChild(aEl);
  aEl.click();
  aEl.remove();
  URL.revokeObjectURL(url);
}

/* ===== Init ===== */
(function init(){
  ANG = loadLS();
  loadFilters();

  const stored = localStorage.getItem(EDIT_KEY);
  EDIT_MODE = stored==='1';
  applyEditUI();

  $('toggleEdit').addEventListener('click',()=>{
    setEditMode(!EDIT_MODE);
  });

  $('exportCsv').addEventListener('click', exportCsv);

  renderBoard();
})();
</script>
</body>
</html>
