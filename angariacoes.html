<!doctype html>
<html lang="pt-PT">
<head>
  <meta charset="utf-8" />
  <title>Garvetur Porto Pro ‚Äî Angaria√ß√µes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://unpkg.com" crossorigin>
  <style>
    :root {
      --gold:#A38B63;
      --gold-soft:rgba(163,139,99,.35);
      --bg:#0B0B0B;
      --panel:#121212;
      --panel-soft:#181818;
      --text:#FFFFFF;
      --muted:#A0A0A0;
      --danger:#F25F5C;
      --success:#4CAF50;
      --warning:#FFC857;
      --card-border:rgba(163,139,99,.3);
      --chip-bg:#1E1E1E;
      --radius-lg:18px;
      --radius-md:12px;
      --shadow-soft:0 14px 25px rgba(0,0,0,.4);
    }

    *{box-sizing:border-box;}
    html,body{
      margin:0;
      height:100%;
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      background:radial-gradient(circle at top,#1c1c1c 0,#050505 55%,#000 100%);
      color:var(--text);
    }

    body{
      display:flex;
      flex-direction:column;
    }

    .app-shell{
      display:grid;
      grid-template-rows:64px auto;
      height:100%;
    }

    header.app-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 18px;
      border-bottom:1px solid rgba(163,139,99,.35);
      background:linear-gradient(90deg,#050505,#111,#050505);
      position:sticky;
      top:0;
      z-index:20;
      gap:16px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .brand-icon{
      width:26px;
      height:26px;
      border-radius:999px;
      border:1px solid var(--gold);
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:0 0 0 1px rgba(163,139,99,.3);
    }
    .brand h1{
      margin:0;
      font-size:17px;
      letter-spacing:.04em;
      text-transform:uppercase;
      color:var(--gold);
    }
    .brand span.sub{
      display:block;
      font-size:11px;
      color:var(--muted);
      letter-spacing:.12em;
      text-transform:uppercase;
    }

    .header-actions{
      display:flex;
      align-items:center;
      gap:8px;
    }

    .btn{
      border-radius:999px;
      border:1px solid var(--gold-soft);
      background:rgba(12,12,12,.9);
      color:var(--text);
      padding:7px 12px;
      font-size:13px;
      display:inline-flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
      transition:.18s border-color,.18s background,.18s transform;
    }
    .btn-primary{
      background:var(--gold);
      color:#0A0A0A;
      border-color:var(--gold);
      font-weight:500;
    }
    .btn-ghost{
      background:transparent;
    }
    .btn-icon{
      width:32px;
      height:32px;
      padding:0;
      border-radius:999px;
      justify-content:center;
    }
    .btn:hover{
      border-color:var(--gold);
      transform:translateY(-1px);
    }
    .btn:disabled{
      opacity:.45;
      cursor:not-allowed;
      transform:none;
    }

    .pill-lock{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:12px;
      padding:4px 9px;
      border-radius:999px;
      background:rgba(0,0,0,.45);
      border:1px solid rgba(255,255,255,.14);
      color:var(--muted);
    }
    .pill-lock span.state{
      font-weight:500;
      color:var(--gold);
    }
    .pill-lock button{
      all:unset;
      cursor:pointer;
      padding:2px 6px;
      border-radius:999px;
      background:rgba(255,255,255,.05);
    }

    /* NAV TABS */
    .nav-tabs{
      display:flex;
      align-items:center;
      gap:4px;
      background:rgba(0,0,0,.35);
      padding:4px;
      border-radius:999px;
      border:1px solid rgba(163,139,99,.35);
    }
    .nav-tab{
      padding:5px 10px;
      border-radius:999px;
      font-size:11px;
      text-decoration:none;
      color:var(--muted);
      letter-spacing:.12em;
      text-transform:uppercase;
      border:1px solid transparent;
      transition:.16s background,.16s color,.16s border-color,.16s transform;
    }
    .nav-tab:hover{
      color:#fff;
      border-color:rgba(163,139,99,.6);
      transform:translateY(-1px);
    }
    .nav-tab.active{
      background:var(--gold);
      color:#0A0A0A;
      border-color:var(--gold);
      font-weight:600;
    }

    .layout{
      display:grid;
      grid-template-columns:320px minmax(0,1fr);
      height:calc(100vh - 64px);
      max-height:calc(100vh - 64px);
      overflow:hidden;
    }
    @media (max-width: 960px){
      .layout{
        grid-template-columns:1fr;
        grid-template-rows:auto auto;
        height:auto;
        max-height:none;
      }
      .sidebar{
        max-height:none;
      }
      header.app-header{
        flex-wrap:wrap;
        align-items:flex-start;
      }
      .nav-tabs{
        order:2;
      }
    }

    .sidebar{
      border-right:1px solid rgba(163,139,99,.24);
      background:radial-gradient(circle at top left,#141414,#060606);
      padding:12px 14px;
      overflow-y:auto;
    }
    .sidebar-section{
      border-radius:var(--radius-md);
      padding:10px 11px;
      background:rgba(0,0,0,.45);
      border:1px solid rgba(163,139,99,.18);
      margin-bottom:10px;
    }
    .sidebar-section h3{
      margin:0 0 6px;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.16em;
      color:var(--muted);
    }
    .sidebar-section p{
      margin:2px 0 6px;
      font-size:12px;
      color:var(--muted);
    }

    .field{
      display:flex;
      flex-direction:column;
      gap:4px;
      margin-bottom:8px;
    }
    .field-row{
      display:flex;
      gap:6px;
    }
    label.field-label{
      font-size:11px;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.12em;
    }
    input[type="text"],
    input[type="number"],
    input[type="date"],
    input[type="email"],
    select,
    textarea{
      background:rgba(0,0,0,.7);
      color:var(--text);
      border-radius:10px;
      border:1px solid rgba(163,139,99,.22);
      padding:6px 8px;
      font-size:13px;
      outline:none;
      width:100%;
    }
    input:focus, select:focus, textarea:focus{
      border-color:var(--gold);
      box-shadow:0 0 0 1px rgba(163,139,99,.35);
    }
    textarea{
      resize:vertical;
      min-height:60px;
    }

    .filters-badges{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:4px;
    }
    .badge{
      font-size:11px;
      border-radius:999px;
      padding:3px 7px;
      border:1px solid rgba(163,139,99,.35);
      background:rgba(8,8,8,.8);
      color:var(--muted);
    }
    .badge strong{color:var(--gold);}

    .toggle-line{
      display:flex;
      align-items:center;
      justify-content:space-between;
      font-size:12px;
      margin-top:4px;
    }
    .toggle-line span{
      color:var(--muted);
    }

    .cards-area{
      padding:14px 16px 18px;
      overflow-y:auto;
      background:radial-gradient(circle at top,#1a1a1a,#050505 55%,#000 100%);
    }

    .cards-header{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      margin-bottom:8px;
      gap:10px;
    }
    .cards-header-left h2{
      margin:0;
      font-size:15px;
      letter-spacing:.16em;
      text-transform:uppercase;
      color:var(--muted);
    }
    .cards-header-left p{
      margin:2px 0 0;
      font-size:12px;
      color:var(--muted);
    }
    .pipeline-kpis{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:4px;
    }
    .kpi-chip{
      border-radius:999px;
      padding:4px 9px;
      border:1px solid rgba(163,139,99,.32);
      font-size:11px;
      color:var(--muted);
      background:rgba(8,8,8,.9);
    }
    .kpi-chip span.value{
      color:var(--gold);
      font-weight:600;
      margin-left:4px;
    }

    .cards-grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(320px,1fr));
      gap:10px;
    }

    .card{
      border-radius:var(--radius-lg);
      border:1px solid var(--card-border);
      padding:10px 11px 9px;
      background:radial-gradient(circle at top left,#181818,#070707);
      box-shadow:var(--shadow-soft);
      display:flex;
      flex-direction:column;
      gap:6px;
      position:relative;
      transition:box-shadow .2s, transform .2s, border-color .2s, background .2s;
    }
    .card.hidden-card{
      opacity:.45;
      border-style:dashed;
    }

    /* Destaque quando vindo de "Ver ficha original" em Tarefas */
    .card.card--highlight{
      border-color:#ffc857;
      box-shadow:0 0 0 2px rgba(255,200,87,.7), 0 22px 40px rgba(0,0,0,.85);
      transform:translateY(-1px);
      background:
        radial-gradient(circle at top left, rgba(255,200,87,.22), transparent 55%),
        radial-gradient(circle at bottom right,#181818,#070707);
    }

    .card-top-row{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:8px;
    }
    .card-title-block{
      flex:1;
      min-width:0;
    }
    .card-title{
      margin:0;
      font-size:14px;
      font-weight:600;
      color:#fff;
      text-overflow:ellipsis;
      white-space:nowrap;
      overflow:hidden;
    }
    .card-subtitle{
      margin:1px 0 0;
      font-size:11px;
      color:var(--muted);
      text-overflow:ellipsis;
      white-space:nowrap;
      overflow:hidden;
    }

    .chip-row{
      display:flex;
      flex-wrap:wrap;
      gap:4px;
      margin-top:4px;
    }
    .chip{
      border-radius:999px;
      padding:2px 7px;
      font-size:10px;
      border:1px solid rgba(163,139,99,.4);
      background:var(--chip-bg);
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.08em;
    }
    .chip-primary{
      border-color:var(--gold);
      color:var(--gold);
    }
    .chip-green{
      border-color:rgba(76,175,80,.7);
      color:#A5D6A7;
    }
    .chip-red{
      border-color:rgba(242,95,92,.8);
      color:#FFABAB;
    }
    .chip-yellow{
      border-color:rgba(255,200,87,.8);
      color:#FFE082;
    }

    .card-section{
      border-top:1px solid rgba(163,139,99,.18);
      padding-top:4px;
      margin-top:2px;
      font-size:12px;
      color:var(--muted);
    }
    .card-section strong{
      color:#f5f5f5;
      font-weight:500;
    }

    .card-footer{
      margin-top:6px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:6px;
      font-size:11px;
      color:var(--muted);
    }
    .card-footer-left{
      display:flex;
      flex-wrap:wrap;
      gap:4px;
      align-items:center;
    }
    .card-footer-right{
      display:flex;
      flex-wrap:wrap;
      gap:4px;
      justify-content:flex-end;
    }

    .btn-xs{
      border-radius:999px;
      padding:3px 7px;
      border:1px solid rgba(163,139,99,.35);
      background:rgba(5,5,5,.9);
      color:var(--muted);
      font-size:10px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:4px;
    }
    .btn-xs.primary{
      border-color:var(--gold);
      color:var(--gold);
    }
    .btn-xs.danger{
      border-color:var(--danger);
      color:#FFB3B0;
    }

    .empty{
      font-size:12px;
      color:var(--muted);
      padding:16px 4px;
    }

    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.7);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:40;
    }
    .modal-backdrop.open{
      display:flex;
    }
    .modal{
      width:min(980px,96vw);
      max-height:90vh;
      background:radial-gradient(circle at top,#151515,#050505);
      border-radius:22px;
      border:1px solid rgba(163,139,99,.5);
      box-shadow:0 24px 45px rgba(0,0,0,.8);
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }
    .modal-header{
      padding:10px 16px 8px;
      border-bottom:1px solid rgba(163,139,99,.25);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background:linear-gradient(90deg,#050505,#111,#050505);
    }
    .modal-header h2{
      margin:0;
      font-size:15px;
      letter-spacing:.12em;
      text-transform:uppercase;
      color:var(--gold);
    }
    .modal-body{
      padding:10px 14px 12px;
      overflow-y:auto;
    }
    .form-grid{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:10px;
    }
    @media (max-width: 900px){
      .form-grid{
        grid-template-columns:1fr;
      }
    }
    .form-section{
      border-radius:var(--radius-md);
      border:1px solid rgba(163,139,99,.22);
      background:rgba(0,0,0,.55);
      padding:8px 9px;
    }
    .form-section h3{
      margin:0 0 6px;
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.14em;
      color:var(--muted);
    }
    .form-section small{
      font-size:11px;
      color:var(--muted);
    }

    .checkbox-grid{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:4px 10px;
      margin-top:4px;
    }
    @media (max-width: 720px){
      .checkbox-grid{
        grid-template-columns:repeat(1,minmax(0,1fr));
      }
    }
    .chk{
      display:flex;
      align-items:center;
      gap:5px;
      font-size:12px;
      color:var(--muted);
    }
    .chk input{
      width:auto;
      accent-color:var(--gold);
    }

    .modal-footer{
      padding:8px 14px 10px;
      border-top:1px solid rgba(163,139,99,.25);
      display:flex;
      justify-content:space-between;
      gap:8px;
      background:#050505;
    }
    .modal-footer-left{
      font-size:11px;
      color:var(--muted);
    }

    .switch{
      position:relative;
      display:inline-block;
      width:34px;
      height:18px;
    }
    .switch input{
      opacity:0;
      width:0;
      height:0;
    }
    .slider{
      position:absolute;
      cursor:pointer;
      inset:0;
      background-color:#444;
      transition:.2s;
      border-radius:34px;
    }
    .slider:before{
      position:absolute;
      content:"";
      height:14px;
      width:14px;
      left:3px;
      bottom:2px;
      background-color:white;
      transition:.2s;
      border-radius:50%;
    }
    .switch input:checked + .slider{
      background-color:var(--gold);
    }
    .switch input:checked + .slider:before{
      transform:translateX(14px);
    }

  </style>
</head>
<body>
<div class="app-shell">
  <header class="app-header">
    <div class="brand">
      <div class="brand-icon">
        <svg width="16" height="16" viewBox="0 0 24 24" stroke="var(--gold)" fill="none" stroke-width="1.8">
          <circle cx="12" cy="12" r="9"></circle>
          <path d="M8 12.5l2.5 2.5L16 9"></path>
        </svg>
      </div>
      <div>
        <h1>Garvetur Porto Pro ‚Äî Angaria√ß√µes</h1>
        <span class="sub">Gest√£o avan√ßada de produto | Garvetur Luxury Porto</span>
      </div>
    </div>

    <!-- NAV BAR SUPERIOR -->
    <nav class="nav-tabs">
      <a href="index.html" class="nav-tab">In√≠cio</a>
      <a href="mapa.html" class="nav-tab">Mapa</a>
      <a href="kanban.html" class="nav-tab">Leads</a>
      <a href="angariacoes.html" class="nav-tab active">Angaria√ß√µes</a>
      <a href="dashboard.html" class="nav-tab">Dashboard</a>
      <a href="vendas.html" class="nav-tab">Vendas</a>
      <a href="tarefas.html" class="nav-tab">Tarefas</a>
    </nav>

  <div class="header-actions">
  <div class="pill-lock" id="lockPill">
    <span>Modo</span>
    <span class="state" id="lockStateLabel">Bloqueado</span>
    <button id="toggleLockBtn" title="Alternar entre edi√ß√£o bloqueada e ativa">
      üîí
    </button>
  </div>

  <button class="btn btn-ghost" id="importCsvBtn" title="Importar angaria√ß√µes de CSV">‚§í CSV</button>
  <button class="btn btn-ghost" id="exportCsvBtn" title="Exportar angaria√ß√µes para CSV">‚§ì CSV</button>
  <button class="btn btn-ghost" id="exportPdfBtn" title="Imprimir / PDF">‚§ì PDF</button>

  <!-- BOT√ïES NOVOS -->
  <button class="btn btn-ghost" id="backupBtn" title="Backup OneDrive">üíæ Backup</button>
  <button class="btn btn-ghost" id="restoreBtn" title="Restaurar dados">‚§∫ Restaurar</button>

  <button class="btn btn-primary" id="newDealBtn">+ Nova Angaria√ß√£o</button>
</div>
  </header>

  <div class="layout">
    <aside class="sidebar">
      <div class="sidebar-section">
        <h3>Filtros</h3>

        <div class="field">
          <label class="field-label" for="filterConsultor">Consultor</label>
          <select id="filterConsultor">
            <option value="">Todos</option>
          </select>
        </div>

        <!-- PESQUISA R√ÅPIDA / ABRANGENTE -->
        <div class="field">
          <label class="field-label" for="filterSearchText">Pesquisa r√°pida</label>
          <input type="text" id="filterSearchText" placeholder="Ref., t√≠tulo, zona, promotor, propriet√°rio‚Ä¶" />
        </div>

        <!-- PER√çODO -->
        <div class="field">
          <label class="field-label">Per√≠odo</label>
          <div class="field-row">
            <div class="field">
              <label class="field-label" for="filterDataDe">De</label>
              <input type="date" id="filterDataDe" />
            </div>
            <div class="field">
              <label class="field-label" for="filterDataAte">At√©</label>
              <input type="date" id="filterDataAte" />
            </div>
          </div>
        </div>

        <!-- VISIBILIDADE -->
        <div class="toggle-line">
          <span>Mostrar invis√≠veis</span>
          <label class="switch">
            <input type="checkbox" id="filterShowHidden">
            <span class="slider"></span>
          </label>
        </div>
        <div class="toggle-line">
          <span>S√≥ invis√≠veis</span>
          <label class="switch">
            <input type="checkbox" id="filterOnlyHidden">
            <span class="slider"></span>
          </label>
        </div>

        <!-- BOT√ïES -->
        <div class="field-row" style="margin-top:8px;">
          <button class="btn" id="filterApplyBtn" style="flex:1;">Aplicar</button>
          <button class="btn btn-ghost" id="filterClearBtn" style="flex:1;border-color:rgba(255,255,255,.2);">Limpar</button>
        </div>

        <p style="margin-top:6px;">Use estes filtros (consultor, pesquisa r√°pida, per√≠odo e visibilidade) para preparar reuni√µes e an√°lises. O bot√£o <strong>Aplicar</strong> guarda os filtros neste navegador.</p>
      </div>

      <div class="sidebar-section">
        <h3>Resumo r√°pido</h3>
        <div class="filters-badges" id="summaryBadges"></div>
      </div>

      <div class="sidebar-section">
        <h3>Notas</h3>
        <p>Quando o cadeado est√° em <strong>Bloqueado</strong>, n√£o h√° risco de alterar dados por engano.</p>
        <p>Quando est√° <strong>Edi√ß√£o ativa</strong>, pode criar, editar e apagar angaria√ß√µes.</p>
      </div>
    </aside>

    <main class="cards-area">
      <div class="cards-header">
        <div class="cards-header-left">
          <h2>Angaria√ß√µes</h2>
          <p>Vis√£o consolidada de produto em carteira ‚Äî focada na leitura r√°pida.</p>
          <div class="pipeline-kpis" id="pipelineKpis"></div>
        </div>
      </div>
      <div id="cardsGrid" class="cards-grid"></div>
      <div id="emptyState" class="empty" style="display:none;">
        Ainda n√£o existem angaria√ß√µes registadas com os filtros atuais.
      </div>
    </main>
  </div>
</div>
<!-- MODAL -->
<div class="modal-backdrop" id="modalBackdrop">
  <div class="modal">
    <div class="modal-header">
      <h2 id="modalTitle">Nova Angaria√ß√£o</h2>
      <button class="btn btn-icon btn-ghost" id="closeModalBtn" title="Fechar">‚úï</button>
    </div>
    <div class="modal-body">
      <form id="dealForm">
        <input type="hidden" id="dealId" />
        <div class="form-grid">

          <!-- COLUNA 1 -->
          <div class="form-section">
            <h3>Envolvidos & Refer√™ncia</h3>

            <div class="field-row">
              <div class="field">
                <label class="field-label" for="consultor">Consultor</label>
                <select id="consultor"></select>
              </div>
              <div class="field">
                <label class="field-label" for="gestor">Gestor</label>
                <select id="gestor"></select>
              </div>
            </div>

            <div class="field-row">
              <div class="field">
                <label class="field-label" for="coordenador">Coordenador</label>
                <input type="text" id="coordenador" value="Rui Quelhas" />
              </div>
              <div class="field">
                <label class="field-label" for="interveniente">Interveniente</label>
                <input type="text" id="interveniente" />
              </div>
            </div>

            <div class="field-row">
              <div class="field">
                <label class="field-label" for="refInterna">Ref. interna</label>
                <input type="text" id="refInterna" />
              </div>
              <div class="field">
                <label class="field-label" for="linkUrl">Link URL</label>
                <input type="text" id="linkUrl" placeholder="https://‚Ä¶" />
              </div>
            </div>

            <div class="field-row">
              <div class="field">
                <label class="field-label" for="dataAngariacao">Data angaria√ß√£o</label>
                <input type="date" id="dataAngariacao" />
              </div>
              <div class="field">
                <label class="field-label" for="estadoAng">Estado angaria√ß√£o</label>
                <select id="estadoAng">
                  <option value="novo">Novo</option>
                  <option value="negociacao">Em negocia√ß√£o</option>
                  <option value="aprovado">Aprovado</option>
                  <option value="perdido">Perdido</option>
                </select>
              </div>
            </div>

            <div class="field">
              <label class="field-label">Dura√ß√£o contrato</label>
              <div class="field-row">
                <select id="duracaoContrato">
                  <option value="">‚Äî</option>
                  <option value="3m">3 meses</option>
                  <option value="4m">4 meses</option>
                  <option value="5m">5 meses</option>
                  <option value="6m">6 meses</option>
                  <option value="outro">Outro</option>
                </select>
                <input type="text" id="duracaoOutro" placeholder="Se outro, indique" />
              </div>
            </div>

            <div class="field-row">
              <div class="field">
                <label class="field-label">Exclusividade</label>
                <div class="field-row">
                  <label class="chk"><input type="checkbox" id="exclusivo"> <span>Exclusivo</span></label>
                  <label class="chk"><input type="checkbox" id="naoExclusivo"> <span>N√£o exclusivo</span></label>
                </div>
              </div>
            </div>

          </div>

          <!-- COLUNA 2 -->
          <div class="form-section">
            <h3>Empreendimento & Propriet√°rio</h3>

            <div class="field-row">
              <div class="field">
                <label class="field-label">√â empreendimento?</label>
                <label class="chk"><input type="checkbox" id="isEmpreendimento"><span>Sim, trata-se de um empreendimento</span></label>
              </div>
            </div>

            <div id="empBlock">
              <div class="field-row">
                <div class="field">
                  <label class="field-label" for="nomeEmp">Nome empreendimento</label>
                  <input type="text" id="nomeEmp" />
                </div>
                <div class="field">
                  <label class="field-label" for="totalFracoes">Total de fra√ß√µes</label>
                  <input type="number" id="totalFracoes" min="0" />
                </div>
              </div>
              <div class="field-row">
                <div class="field">
                  <label class="field-label" for="tipologiasEmp">Tipologias</label>
                  <input type="text" id="tipologiasEmp" placeholder="Ex.: T1‚ÄìT4" />
                </div>
                <div class="field">
                  <label class="field-label" for="anoConstrEmp">Ano constru√ß√£o</label>
                  <input type="number" id="anoConstrEmp" min="1800" max="2100" />
                </div>
              </div>
              <div class="field-row">
                <div class="field">
                  <label class="field-label" for="mesConclEmp">M√™s conclus√£o</label>
                  <select id="mesConclEmp">
                    <option value="">‚Äî</option>
                    <option value="01">Janeiro</option>
                    <option value="02">Fevereiro</option>
                    <option value="03">Mar√ßo</option>
                    <option value="04">Abril</option>
                    <option value="05">Maio</option>
                    <option value="06">Junho</option>
                    <option value="07">Julho</option>
                    <option value="08">Agosto</option>
                    <option value="09">Setembro</option>
                    <option value="10">Outubro</option>
                    <option value="11">Novembro</option>
                    <option value="12">Dezembro</option>
                  </select>
                </div>
                <div class="field">
                  <label class="field-label" for="anoConclEmp">Ano conclus√£o</label>
                  <input type="number" id="anoConclEmp" min="1800" max="2100" />
                </div>
              </div>
              <div class="field-row">
                <div class="field">
                  <label class="field-label" for="promotor">Promotor</label>
                  <input type="text" id="promotor" />
                </div>
              </div>
              <div class="field-row">
                <div class="field">
                  <label class="field-label" for="telPromotor">Contacto promotor</label>
                  <input type="text" id="telPromotor" />
                </div>
                <div class="field">
                  <label class="field-label" for="emailPromotor">Email promotor</label>
                  <input type="email" id="emailPromotor" />
                </div>
              </div>
            </div>

            <hr style="border:none;border-top:1px solid rgba(163,139,99,.25);margin:6px 0 8px;">

            <div class="field-row">
              <div class="field">
                <label class="field-label" for="nomeProp">Nome propriet√°rio</label>
                <input type="text" id="nomeProp" />
              </div>
              <div class="field">
                <label class="field-label" for="telProp">Contacto telef√≥nico</label>
                <input type="text" id="telProp" />
              </div>
            </div>
            <div class="field-row">
              <div class="field">
                <label class="field-label" for="emailProp">Email propriet√°rio</label>
                <input type="email" id="emailProp" />
              </div>
            </div>
            <div class="field">
              <label class="field-label" for="moradaProp">Morada</label>
              <input type="text" id="moradaProp" />
            </div>
            <div class="field-row">
              <div class="field">
                <label class="field-label" for="estadoCivil">Estado civil</label>
                <select id="estadoCivil">
                  <option value="">‚Äî</option>
                  <option value="solteiro">Solteiro(a)</option>
                  <option value="casado">Casado(a)</option>
                  <option value="divorciado">Divorciado(a)</option>
                  <option value="viuvo">Vi√∫vo(a)</option>
                </select>
              </div>
              <div class="field">
                <label class="field-label" for="regimeCasamento">Regime casamento</label>
                <select id="regimeCasamento">
                  <option value="">‚Äî</option>
                  <option value="comunhaoAdquiridos">Comunh√£o de adquiridos</option>
                  <option value="comunhaoGeral">Comunh√£o geral de bens</option>
                  <option value="separacao">Separa√ß√£o de bens</option>
                </select>
              </div>
            </div>

          </div>

          <!-- COLUNA 3 -->
          <div class="form-section">
            <h3>Im√≥vel & Localiza√ß√£o</h3>

            <div class="field">
              <label class="field-label" for="tituloImovel">T√≠tulo / Designa√ß√£o</label>
              <input type="text" id="tituloImovel" placeholder="Ex.: Apartamento T3 com vista mar" />
            </div>

            <div class="field">
              <label class="field-label" for="localizacao">Localiza√ß√£o (zona/morada)</label>
              <input type="text" id="localizacao" />
            </div>

            <div class="field-row">
              <div class="field">
                <label class="field-label" for="distrito">Distrito</label>
                <input type="text" id="distrito" />
              </div>
              <div class="field">
                <label class="field-label" for="concelho">Concelho</label>
                <input type="text" id="concelho" />
              </div>
            </div>

            <div class="field-row">
              <div class="field">
                <label class="field-label" for="freguesia">Freguesia</label>
                <input type="text" id="freguesia" />
              </div>
              <div class="field">
                <label class="field-label" for="zona">Zona</label>
                <input type="text" id="zona" />
              </div>
            </div>

            <div class="field">
              <label class="field-label" for="gps">Coordenadas GPS</label>
              <input type="text" id="gps" placeholder="Ex.: 41.147, -8.61" />
            </div>

            <div class="field-row">
              <div class="field">
                <label class="field-label" for="anoConstrucao">Ano constru√ß√£o</label>
                <input type="number" id="anoConstrucao" min="1800" max="2100" />
              </div>
              <div class="field">
                <label class="field-label" for="anoConclusao">Ano conclus√£o / previs√£o</label>
                <input type="number" id="anoConclusao" min="1800" max="2100" />
              </div>
            </div>
            <div class="field-row">
              <div class="field">
                <label class="field-label" for="mesConclusao">M√™s conclus√£o / previs√£o</label>
                <select id="mesConclusao">
                  <option value="">‚Äî</option>
                  <option value="01">Janeiro</option>
                  <option value="02">Fevereiro</option>
                  <option value="03">Mar√ßo</option>
                  <option value="04">Abril</option>
                  <option value="05">Maio</option>
                  <option value="06">Junho</option>
                  <option value="07">Julho</option>
                  <option value="08">Agosto</option>
                  <option value="09">Setembro</option>
                  <option value="10">Outubro</option>
                  <option value="11">Novembro</option>
                  <option value="12">Dezembro</option>
                </select>
              </div>
              <div class="field">
                <label class="field-label">&nbsp;</label>
                <small>Usado para im√≥veis em constru√ß√£o ou em projeto.</small>
              </div>
            </div>

            <div class="field-row">
              <div class="field">
                <label class="field-label" for="certEnerg">Cert. energ√©tico</label>
                <input type="text" id="certEnerg" placeholder="Ex.: A+, B, C‚Ä¶" />
              </div>
              <div class="field">
                <label class="field-label" for="condominioValor">Condom√≠nio (‚Ç¨)</label>
                <input type="number" id="condominioValor" min="0" step="1" />
              </div>
            </div>

          </div>

          <!-- COLUNA 4 -->
          <div class="form-section">
            <h3>Natureza, √Åreas, Pre√ßo & Ajustamento</h3>

            <div class="field-row">
              <div class="field">
                <label class="field-label" for="natureza">Natureza</label>
                <select id="natureza">
                  <option value="">‚Äî</option>
                  <option value="apartamento">Apartamento</option>
                  <option value="moradia">Moradia</option>
                  <option value="terreno">Terreno</option>
                  <option value="loja">Loja</option>
                  <option value="escritorio">Escrit√≥rio</option>
                  <option value="empreendimento">Empreendimento</option>
                  <option value="outro">Outro</option>
                </select>
              </div>
              <div class="field">
                <label class="field-label" for="estadoImovel">Estado im√≥vel</label>
                <select id="estadoImovel">
                  <option value="">‚Äî</option>
                  <option value="novo">Novo</option>
                  <option value="usado">Usado</option>
                  <option value="recuperado">Recuperado</option>
                  <option value="construcao">Em constru√ß√£o</option>
                  <option value="projeto">Em projeto</option>
                </select>
              </div>
            </div>

            <div class="field-row">
              <div class="field">
                <label class="field-label" for="tipoNegocio">Tipo de neg√≥cio</label>
                <select id="tipoNegocio">
                  <option value="">‚Äî</option>
                  <option value="venda">Venda</option>
                  <option value="compra">Compra</option>
                  <option value="arrendamento">Arrendamento</option>
                  <option value="permuta">Permuta</option>
                </select>
              </div>
              <div class="field">
                <label class="field-label" for="origemCliente">Origem cliente</label>
                <input type="text" id="origemCliente" />
              </div>
            </div>

            <hr style="border:none;border-top:1px solid rgba(163,139,99,.25);margin:6px 0;">

            <div class="field-row">
              <div class="field">
                <label class="field-label" for="areaUtil">√Årea √∫til (m¬≤)</label>
                <input type="number" id="areaUtil" min="0" step="1" />
              </div>
              <div class="field">
                <label class="field-label" for="areaBruta">√Årea bruta (m¬≤)</label>
                <input type="number" id="areaBruta" min="0" step="1" />
              </div>
            </div>

            <div class="field-row">
              <div class="field">
                <label class="field-label" for="areaABP">ABP (m¬≤)</label>
                <input type="number" id="areaABP" min="0" step="1" />
              </div>
              <div class="field">
                <label class="field-label" for="areaABD">ABD (m¬≤)</label>
                <input type="number" id="areaABD" min="0" step="1" />
              </div>
            </div>

            <div class="field-row">
              <div class="field">
                <label class="field-label" for="areaTerreno">Terreno (m¬≤)</label>
                <input type="number" id="areaTerreno" min="0" step="1" />
              </div>
              <div class="field">
                <label class="field-label" for="areaImplantacao">Implanta√ß√£o (m¬≤)</label>
                <input type="number" id="areaImplantacao" min="0" step="1" />
              </div>
            </div>

            <hr style="border:none;border-top:1px solid rgba(163,139,99,.25);margin:6px 0;">

            <div class="field-row">
              <div class="field">
                <label class="field-label" for="precoPedido">Pre√ßo pedido (‚Ç¨)</label>
                <input type="number" id="precoPedido" min="0" step="1000" />
              </div>
              <div class="field">
                <label class="field-label" for="precoSugerido">Pre√ßo sugerido (‚Ç¨)</label>
                <input type="number" id="precoSugerido" min="0" step="1000" />
              </div>
            </div>

            <div class="field-row">
              <div class="field">
                <label class="field-label" for="comissao">Comiss√£o</label>
                <select id="comissao">
                  <option value="">‚Äî</option>
                  <option value="6">6%</option>
                  <option value="5">5%</option>
                  <option value="4">4%</option>
                  <option value="3">3%</option>
                  <option value="outro">Outro</option>
                </select>
              </div>
              <div class="field">
                <label class="field-label" for="comissaoOutro">Se outro (%)</label>
                <input type="number" id="comissaoOutro" min="0" max="100" step="0.1" />
              </div>
            </div>

            <div class="field-row">
              <div class="field">
                <label class="field-label" for="percentAjust">Ajustamento (%)</label>
                <input type="number" id="percentAjust" step="0.1" />
              </div>
              <div class="field">
                <label class="field-label">&nbsp;</label>
                <small>Se deixar vazio, √© calculado com base nos pre√ßos (se ambos preenchidos).</small>
              </div>
            </div>

          </div>

          <!-- COLUNA 5: 10.1 -->
          <div class="form-section">
            <h3>10.1 Caracter√≠sticas (num√©ricas)</h3>
            <div class="field-row">
              <div class="field">
                <label class="field-label" for="numSalas">Sala(s)</label>
                <input type="number" id="numSalas" min="0" />
              </div>
              <div class="field">
                <label class="field-label" for="numSalasJantar">Sala(s) jantar</label>
                <input type="number" id="numSalasJantar" min="0" />
              </div>
            </div>
            <div class="field-row">
              <div class="field">
                <label class="field-label" for="numSuites">Suite(s)</label>
                <input type="number" id="numSuites" min="0" />
              </div>
              <div class="field">
                <label class="field-label" for="numClosets">Closet(s)</label>
                <input type="number" id="numClosets" min="0" />
              </div>
            </div>
            <div class="field-row">
              <div class="field">
                <label class="field-label" for="numCozinhas">Cozinha(s)</label>
                <input type="number" id="numCozinhas" min="0" />
              </div>
              <div class="field">
                <label class="field-label" for="numDespensas">Despensa(s)</label>
                <input type="number" id="numDespensas" min="0" />
              </div>
            </div>
            <div class="field-row">
              <div class="field">
                <label class="field-label" for="numMarquises">Marquise(s)</label>
                <input type="number" id="numMarquises" min="0" />
              </div>
              <div class="field">
                <label class="field-label" for="numLavandarias">Lavandaria(s)</label>
                <input type="number" id="numLavandarias" min="0" />
              </div>
            </div>
            <div class="field-row">
              <div class="field">
                <label class="field-label" for="numSotaos">S√≥t√£o(s)</label>
                <input type="number" id="numSotaos" min="0" />
              </div>
              <div class="field">
                <label class="field-label" for="numVarandas">Varanda(s)</label>
                <input type="number" id="numVarandas" min="0" />
              </div>
            </div>
            <div class="field-row">
              <div class="field">
                <label class="field-label" for="numPisos">N¬∫ pisos</label>
                <input type="number" id="numPisos" min="0" />
              </div>
              <div class="field">
                <label class="field-label" for="numQuartos">Total quartos</label>
                <input type="number" id="numQuartos" min="0" />
              </div>
            </div>
          </div>

          <!-- COLUNA 6: 10.2‚Äì10.5 + Documenta√ß√£o -->
          <div class="form-section">
            <h3>10.2 Zona envolvente</h3>
            <div id="zonaEnvolventeGroup" class="checkbox-grid"></div>
            <h3 style="margin-top:8px;">10.3 Infraestruturas</h3>
            <div id="infraGroup" class="checkbox-grid"></div>
          </div>

          <div class="form-section">
            <h3>10.4 Equipamentos</h3>
            <div id="equipGroup" class="checkbox-grid"></div>
            <h3 style="margin-top:8px;">10.5 Seguran√ßa</h3>
            <div id="segGroup" class="checkbox-grid"></div>
          </div>

          <div class="form-section">
            <h3>Documenta√ß√£o & Notas</h3>
            <small>Marque o que j√° foi recebido e use as notas para alinhamento interno.</small>
            <div class="checkbox-grid" id="docsGroup"></div>

            <div class="field" style="margin-top:6px;">
              <label class="field-label" for="observacoes">Observa√ß√µes</label>
              <textarea id="observacoes"></textarea>
            </div>
            <div class="field">
              <label class="field-label" for="notasInternas">Notas internas</label>
              <textarea id="notasInternas"></textarea>
            </div>
          </div>

        </div>
      </form>
    </div>
    <div class="modal-footer">
      <div class="modal-footer-left">
        Dados guardados apenas neste navegador (localStorage). Use exporta√ß√µes para backup/partilha.
      </div>
      <div>
        <button class="btn btn-ghost" id="cancelModalBtn">Cancelar</button>
        <button class="btn btn-primary" id="saveDealBtn">Guardar</button>
      </div>
    </div>
  </div>
</div>
<script>
(function(){
  const STORAGE_KEY = 'gpp_angariacoes_v2';
  const FILTERS_STORAGE_KEY = 'gpp_ang_filters_v1';

  const CONSULTOR_OPTIONS = [
    "Rui Quelhas",
    "Manuel Oliveira",
    "Jo√£o Sousa",
    "Francisco dos Santos",
    "Ros√°rio Vasconcelos",
    "Armanda Meireles",
    "Audrey Lucas",
    "Outro"
  ];

  const ZONA_ENVOLVENTE = [
    "Aeroporto","Banco","√Åreas de Lazer Infantil","Auto-estrada","Biblioteca","Centro Comercial",
    "Centro da Cidade","Bombeiros","Campo","Campo de Golfe","Esta√ß√£o Rodovi√°ria","Farm√°cia","Escola",
    "Espa√ßos Verdes","Esta√ß√£o Ferrovi√°ria","Gin√°sio","Metro","Hipermercado","Hospital","Mercado",
    "Perto da praia","Pra√ßa de T√°xis","Piscinas","Pol√≠cia","Posto de Combust√≠vel",
    "Transportes P√∫blicos","Zona Hist√≥rica","Zona Comercial"
  ];

  const INFRAESTRUTURAS = [
    "Acesso para Deficientes","Campo de t√©nis","Adega","Anexos","Arrecada√ß√£o","Complexo Desportivo",
    "Gin√°sio","Piscina","Jardim","Parque infantil","Terra√ßo","Sal√£o de Festas","Sal√£o de Jogos",
    "Telheiro","Estacionamento ao ar livre","Estacionamento coberto","Garagem"
  ];

  const EQUIPAMENTOS = [
    "Ar Condicionado","Aquecimento Central","Lareira","Recuperador de calor","Estores el√©ctricos",
    "Vidros duplos","Porta Alta Seguran√ßa","Roupeiros","Aspira√ß√£o Central","Piso radiante",
    "Termoacumulador","Toalheiros aquecidos","Dom√≥tica","Sistema solar / √Ågua quente solar",
    "Pr√©-instala√ß√µes","G√°s canalizado","G√°s natural","G√°s botija","Jacuzzi","Microgera√ß√£o solar",
    "Placa a g√°s","Placa indu√ß√£o","Placa vitrocer√¢mica",
    "M√°quina lavar loi√ßa","M√°quina lavar roupa","M√°quina secar","Frigor√≠fico","Exaustor",
    "Forno","Fog√£o","Fog√£o el√©trico","Alarme","Detector de fumos","Detector de g√°s",
    "Detector de inunda√ß√£o","Detector de inc√™ndio","Elevador","Cofre","Isolamento t√©rmico",
    "Isolamento ac√∫stico","M√∫sica ambiente","Mobilado","Bomba de Calor"
  ];

  const SEGURANCA = [
    "Portaria","V√≠deo vigil√¢ncia","Seguran√ßa 24h"
  ];

  const DOCUMENTACAO = [
    "Contrato de Media√ß√£o","Identifica√ß√£o Propriet√°rios","Caderneta Predial",
    "Certid√£o Registo Predial","Certificado Energ√©tico","Planta de Localiza√ß√£o",
    "Planta do Im√≥vel","Licen√ßa de Utiliza√ß√£o","Licen√ßa de Constru√ß√£o",
    "Dispensa Licen√ßa (pr√©-1951)","Fotografias","V√≠deo","Ficha T√©cnica Habita√ß√£o",
    "Mapa de Acabamentos","T√≠tulo Constitutivo PH","Certid√£o Comercial Empresa",
    "Identifica√ß√£o S√≥cios","Tabela Pre√ßos Empreendimento","Descri√ß√£o Projeto",
    "Minuta CPCV","Plano Pagamentos","Pedido Informa√ß√£o Pr√©via","Projeto Arquitetura",
    "Projeto Especialidades","Registado no BUPI","Outros"
  ];

  function $(id){ return document.getElementById(id); }

  const lockStateLabel = $('lockStateLabel');
  const toggleLockBtn = $('toggleLockBtn');
  const newDealBtn = $('newDealBtn');
  const importCsvBtn = $('importCsvBtn');
  const exportCsvBtn = $('exportCsvBtn');
  const exportPdfBtn = $('exportPdfBtn');
  const cardsGrid = $('cardsGrid');
  const emptyState = $('emptyState');
  const pipelineKpis = $('pipelineKpis');
  const summaryBadges = $('summaryBadges');

  const filterConsultor = $('filterConsultor');
  const filterSearchText = $('filterSearchText');
  const filterDataDe = $('filterDataDe');
  const filterDataAte = $('filterDataAte');
  const filterShowHidden = $('filterShowHidden');
  const filterOnlyHidden = $('filterOnlyHidden');
  const filterApplyBtn = $('filterApplyBtn');
  const filterClearBtn = $('filterClearBtn');

  const modalBackdrop = $('modalBackdrop');
  const modalTitle = $('modalTitle');
  const closeModalBtn = $('closeModalBtn');
  const cancelModalBtn = $('cancelModalBtn');
  const saveDealBtn = $('saveDealBtn');
  const dealForm = $('dealForm');

  const consultorSelect = $('consultor');
  const gestorSelect = $('gestor');

  const isEmpreendimento = $('isEmpreendimento');
  const empBlock = $('empBlock');

  const camposNumericos = {
    numSalas: $('numSalas'),
    numSalasJantar: $('numSalasJantar'),
    numSuites: $('numSuites'),
    numClosets: $('numClosets'),
    numCozinhas: $('numCozinhas'),
    numDespensas: $('numDespensas'),
    numMarquises: $('numMarquises'),
    numLavandarias: $('numLavandarias'),
    numSotaos: $('numSotaos'),
    numVarandas: $('numVarandas'),
    numPisos: $('numPisos'),
    numQuartos: $('numQuartos')
  };

  const estadoImovelSelect = $('estadoImovel');
  const mesConclEmpInput = $('mesConclEmp');
  const mesConclusaoInput = $('mesConclusao');

  let state = {
    locked:true,
    deals:[]
  };

  function loadState(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(raw){
        const parsed = JSON.parse(raw);
        if(Array.isArray(parsed.deals)){
          state.deals = parsed.deals;
        }
        state.locked = parsed.locked !== false;
      }
    }catch(e){
      console.error('Erro ao carregar storage', e);
    }
    updateLockUI();
  }
  function saveState(){
    try{
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }catch(e){
      console.error('Erro ao guardar storage', e);
    }
  }
  function updateLockUI(){
    if(state.locked){
      lockStateLabel.textContent = 'Bloqueado';
      toggleLockBtn.textContent = 'üîí';
      newDealBtn.disabled = true;
    }else{
      lockStateLabel.textContent = 'Edi√ß√£o ativa';
      toggleLockBtn.textContent = 'üîì';
      newDealBtn.disabled = false;
    }
  }

  function initConsultores(){
    CONSULTOR_OPTIONS.forEach(name=>{
      const opt1 = document.createElement('option');
      opt1.value = name;
      opt1.textContent = name;
      consultorSelect.appendChild(opt1);

      const opt2 = document.createElement('option');
      opt2.value = name;
      opt2.textContent = name;
      gestorSelect.appendChild(opt2);

      const opt3 = document.createElement('option');
      opt3.value = name;
      opt3.textContent = name;
      filterConsultor.appendChild(opt3);
    });
  }

  function renderCheckboxGroup(containerId, groupKey, labels){
    const container = $(containerId);
    container.innerHTML = '';
    labels.forEach(label=>{
      const id = groupKey + '_' + label.replace(/[^a-z0-9]+/gi,'_').toLowerCase();
      const wrapper = document.createElement('label');
      wrapper.className = 'chk';
      const input = document.createElement('input');
      input.type = 'checkbox';
      input.dataset.group = groupKey;
      input.value = label;
      input.id = id;
      const span = document.createElement('span');
      span.textContent = label;
      wrapper.appendChild(input);
      wrapper.appendChild(span);
      container.appendChild(wrapper);
    });
  }

  function getGroupedCheckboxValues(){
    const groups = {};
    document.querySelectorAll('input[type="checkbox"][data-group]').forEach(chk=>{
      const key = chk.dataset.group;
      if(!groups[key]) groups[key] = [];
      if(chk.checked) groups[key].push(chk.value);
    });
    return groups;
  }

  function setGroupedCheckboxValues(deal){
    document.querySelectorAll('input[type="checkbox"][data-group]').forEach(chk=>{
      const key = chk.dataset.group;
      const list = deal[key];
      if(Array.isArray(list)){
        chk.checked = list.includes(chk.value);
      }else{
        chk.checked = false;
      }
    });
  }

  function openModal(deal){
    modalBackdrop.classList.add('open');
    if(deal){
      modalTitle.textContent = 'Editar Angaria√ß√£o';
      $('dealId').value = deal.id || '';
      consultorSelect.value = deal.consultor || '';
      gestorSelect.value = deal.gestor || '';
      $('coordenador').value = deal.coordenador || 'Rui Quelhas';
      $('interveniente').value = deal.interveniente || '';
      $('refInterna').value = deal.refInterna || '';
      $('linkUrl').value = deal.linkUrl || '';
      $('dataAngariacao').value = deal.dataAngariacao || '';
      $('estadoAng').value = deal.estadoAng || 'novo';
      $('duracaoContrato').value = deal.duracaoContrato || '';
      $('duracaoOutro').value = deal.duracaoOutro || '';
      $('exclusivo').checked = !!deal.exclusivo;
      $('naoExclusivo').checked = !!deal.naoExclusivo;

      $('isEmpreendimento').checked = !!deal.isEmpreendimento;

      $('nomeEmp').value = deal.nomeEmp || '';
      $('totalFracoes').value = deal.totalFracoes || '';
      $('tipologiasEmp').value = deal.tipologiasEmp || '';
      $('anoConstrEmp').value = deal.anoConstrEmp || '';
      $('mesConclEmp').value = deal.mesConclEmp || '';
      $('anoConclEmp').value = deal.anoConclEmp || '';
      $('promotor').value = deal.promotor || '';
      $('telPromotor').value = deal.telPromotor || '';
      $('emailPromotor').value = deal.emailPromotor || '';

      $('nomeProp').value = deal.nomeProp || '';
      $('telProp').value = deal.telProp || '';
      $('emailProp').value = deal.emailProp || '';
      $('moradaProp').value = deal.moradaProp || '';
      $('estadoCivil').value = deal.estadoCivil || '';
      $('regimeCasamento').value = deal.regimeCasamento || '';

      $('tituloImovel').value = deal.tituloImovel || '';
      $('localizacao').value = deal.localizacao || '';
      $('distrito').value = deal.distrito || '';
      $('concelho').value = deal.concelho || '';
      $('freguesia').value = deal.freguesia || '';
      $('zona').value = deal.zona || '';
      $('gps').value = deal.gps || '';
      $('anoConstrucao').value = deal.anoConstrucao || '';
      $('anoConclusao').value = deal.anoConclusao || '';
      $('mesConclusao').value = deal.mesConclusao || '';
      $('certEnerg').value = deal.certEnerg || '';
      $('condominioValor').value = deal.condominioValor || '';

      $('natureza').value = deal.natureza || '';
      $('estadoImovel').value = deal.estadoImovel || '';
      $('tipoNegocio').value = deal.tipoNegocio || '';
      $('origemCliente').value = deal.origemCliente || '';

      $('areaUtil').value = deal.areaUtil || '';
      $('areaBruta').value = deal.areaBruta || '';
      $('areaABP').value = deal.areaABP || '';
      $('areaABD').value = deal.areaABD || '';
      $('areaTerreno').value = deal.areaTerreno || '';
      $('areaImplantacao').value = deal.areaImplantacao || '';

      $('precoPedido').value = deal.precoPedido || '';
      $('precoSugerido').value = deal.precoSugerido || '';
      $('comissao').value = deal.comissao || '';
      $('comissaoOutro').value = deal.comissaoOutro || '';
      $('percentAjust').value = deal.percentAjust || '';

      Object.keys(camposNumericos).forEach(k=>{
        camposNumericos[k].value = deal[k] || '';
      });

      $('observacoes').value = deal.observacoes || '';
      $('notasInternas').value = deal.notasInternas || '';

      setGroupedCheckboxValues(deal);
    }else{
      modalTitle.textContent = 'Nova Angaria√ß√£o';
      dealForm.reset();
      $('dealId').value = '';
      Object.keys(camposNumericos).forEach(k=>camposNumericos[k].value='');
      document.querySelectorAll('input[type="checkbox"][data-group]').forEach(chk=>{ chk.checked=false; });
    }
    updateEmpBlockVisibility();
    updateConclusaoFieldsVisibility();
  }

  function closeModal(){
    modalBackdrop.classList.remove('open');
  }

  function updateEmpBlockVisibility(){
    empBlock.style.opacity = isEmpreendimento.checked ? '1' : '.4';
  }

  function updateConclusaoFieldsVisibility(){
    if(!estadoImovelSelect) return;
    const estado = estadoImovelSelect.value;
    const isConstrucao = (estado === 'construcao' || estado === 'projeto');
    const anoConclusaoField = $('anoConclusao');
    if(!anoConclusaoField || !mesConclusaoInput) return;

    const anoWrapper = anoConclusaoField.parentElement;
    const mesWrapper = mesConclusaoInput.parentElement;

    anoConclusaoField.disabled = !isConstrucao;
    mesConclusaoInput.disabled = !isConstrucao;

    if(anoWrapper) anoWrapper.style.opacity = isConstrucao ? '1' : '.4';
    if(mesWrapper) mesWrapper.style.opacity = isConstrucao ? '1' : '.4';

    if(!isConstrucao){
      anoConclusaoField.value = '';
      mesConclusaoInput.value = '';
    }
  }

  function collectFormData(){
    const id = $('dealId').value || 'ang_' + Date.now();
    const groups = getGroupedCheckboxValues();

    // Gera√ß√£o autom√°tica de Ref. interna se estiver vazia
    let refInternaVal = ($('refInterna').value || '').trim();
    if(!refInternaVal){
      const today = new Date();
      const year = today.getFullYear();
      const prefix = 'GPP-' + year + '-';
      const existing = state.deals
        .map(d => d.refInterna)
        .filter(r => typeof r === 'string' && r.startsWith(prefix));
      const seq = (existing.length + 1).toString().padStart(3,'0');
      refInternaVal = prefix + seq;
      $('refInterna').value = refInternaVal;
    }

    let comPerc = $('comissao').value;
    if(comPerc === 'outro'){
      comPerc = $('comissaoOutro').value || '';
    }
    let percentAjust = $('percentAjust').value;
    const precoP = parseFloat(($('precoPedido').value || '').replace(',', '.'));
    const precoS = parseFloat(($('precoSugerido').value || '').replace(',', '.'));
    if((percentAjust==='' || isNaN(parseFloat(percentAjust))) && isFinite(precoP) && isFinite(precoS) && precoP>0){
      percentAjust = (((precoS - precoP)/precoP)*100).toFixed(1);
    }

    const data = {
      id,
      consultor: consultorSelect.value || '',
      gestor: gestorSelect.value || '',
      coordenador: $('coordenador').value || 'Rui Quelhas',
      interveniente: $('interveniente').value || '',
      refInterna: refInternaVal,
      linkUrl: $('linkUrl').value || '',
      dataAngariacao: $('dataAngariacao').value || '',
      estadoAng: $('estadoAng').value || 'novo',
      duracaoContrato: $('duracaoContrato').value || '',
      duracaoOutro: $('duracaoOutro').value || '',
      exclusivo: $('exclusivo').checked,
      naoExclusivo: $('naoExclusivo').checked,

      isEmpreendimento: isEmpreendimento.checked,
      nomeEmp: $('nomeEmp').value || '',
      totalFracoes: $('totalFracoes').value || '',
      tipologiasEmp: $('tipologiasEmp').value || '',
      anoConstrEmp: $('anoConstrEmp').value || '',
      mesConclEmp: mesConclEmpInput ? (mesConclEmpInput.value || '') : '',
      anoConclEmp: $('anoConclEmp').value || '',
      promotor: $('promotor').value || '',
      telPromotor: $('telPromotor').value || '',
      emailPromotor: $('emailPromotor').value || '',

      nomeProp: $('nomeProp').value || '',
      telProp: $('telProp').value || '',
      emailProp: $('emailProp').value || '',
      moradaProp: $('moradaProp').value || '',
      estadoCivil: $('estadoCivil').value || '',
      regimeCasamento: $('regimeCasamento').value || '',

      tituloImovel: $('tituloImovel').value || '',
      localizacao: $('localizacao').value || '',
      distrito: $('distrito').value || '',
      concelho: $('concelho').value || '',
      freguesia: $('freguesia').value || '',
      zona: $('zona').value || '',
      gps: $('gps').value || '',
      anoConstrucao: $('anoConstrucao').value || '',
      anoConclusao: $('anoConclusao').value || '',
      mesConclusao: mesConclusaoInput ? (mesConclusaoInput.value || '') : '',
      certEnerg: $('certEnerg').value || '',
      condominioValor: $('condominioValor').value || '',

      natureza: $('natureza').value || '',
      estadoImovel: $('estadoImovel').value || '',
      tipoNegocio: $('tipoNegocio').value || '',
      origemCliente: $('origemCliente').value || '',

      areaUtil: $('areaUtil').value || '',
      areaBruta: $('areaBruta').value || '',
      areaABP: $('areaABP').value || '',
      areaABD: $('areaABD').value || '',
      areaTerreno: $('areaTerreno').value || '',
      areaImplantacao: $('areaImplantacao').value || '',

      precoPedido: $('precoPedido').value || '',
      precoSugerido: $('precoSugerido').value || '',
      comissao: $('comissao').value || '',
      comissaoOutro: $('comissaoOutro').value || '',
      percentAjust: percentAjust || '',

      observacoes: $('observacoes').value || '',
      notasInternas: $('notasInternas').value || '',

      visible: (typeof groups.visible === 'undefined') ? true : !!groups.visible,

      zonaEnvolvente: groups.zonaEnvolvente || [],
      infraestruturas: groups.infraestruturas || [],
      equipamentos: groups.equipamentos || [],
      seguranca: groups.seguranca || [],
      documentacao: groups.documentacao || []
    };

    Object.keys(camposNumericos).forEach(k=>{
      data[k] = camposNumericos[k].value || '';
    });

    return data;
  }

  function loadFilterState(){
    try{
      const raw = localStorage.getItem(FILTERS_STORAGE_KEY);
      if(!raw) return;
      const obj = JSON.parse(raw);
      if(!obj || typeof obj !== 'object') return;

      if(obj.consultor && filterConsultor.querySelector('option[value="'+obj.consultor+'"]')){
        filterConsultor.value = obj.consultor;
      }
      filterSearchText.value = obj.searchText || '';
      filterDataDe.value = obj.de || '';
      filterDataAte.value = obj.ate || '';
      filterShowHidden.checked = !!obj.mostrarInvisiveis;
      filterOnlyHidden.checked = !!obj.soInvisiveis;
    }catch(e){
      console.error('Erro a carregar filtros angaria√ß√µes', e);
    }
  }

  function saveFilterStateFromUI(){
    const data = {
      consultor: filterConsultor.value || '',
      searchText: filterSearchText.value || '',
      de: filterDataDe.value || '',
      ate: filterDataAte.value || '',
      mostrarInvisiveis: filterShowHidden.checked,
      soInvisiveis: filterOnlyHidden.checked
    };
    try{
      localStorage.setItem(FILTERS_STORAGE_KEY, JSON.stringify(data));
    }catch(e){
      console.error('Erro a guardar filtros angaria√ß√µes', e);
    }
  }

  function applyFilters(deals){
    const cons = filterConsultor.value;
    const search = (filterSearchText.value || '').trim().toLowerCase();
    const from = filterDataDe.value;
    const to = filterDataAte.value;
    const showHidden = filterShowHidden.checked;
    const onlyHidden = filterOnlyHidden.checked;

    return deals.filter(d=>{
      if(cons && d.consultor !== cons) return false;

      if(onlyHidden){
        if(d.visible !== false) return false;
      }else if(!showHidden && d.visible === false){
        return false;
      }

      if(from && d.dataAngariacao && d.dataAngariacao < from) return false;
      if(to && d.dataAngariacao && d.dataAngariacao > to) return false;

      if(search){
        const texto = [
          d.refInterna,
          d.tituloImovel,
          d.nomeEmp,
          d.nomeProp,
          d.consultor,
          d.gestor,
          d.concelho,
          d.zona,
          d.localizacao,
          d.promotor,
          d.origemCliente,
          d.natureza,
          d.tipoNegocio,
          d.estadoImovel
        ].filter(Boolean).join(' ').toLowerCase();

        if(!texto.includes(search)) return false;
      }

      return true;
    });
  }

  function formatMoney(v){
    const n = parseFloat(String(v).replace(',', '.'));
    if(!isFinite(n)) return '';
    return n.toLocaleString('pt-PT',{style:'currency',currency:'EUR',maximumFractionDigits:0});
  }
  function formatPercent(v){
    const n = parseFloat(String(v).replace(',', '.'));
    if(!isFinite(n)) return '';
    return n.toFixed(1).replace('.',',') + '%';
  }

  function classForAjust(p){
    const n = parseFloat(String(p).replace(',', '.'));
    if(!isFinite(n)) return '';
    if(n < -5) return 'chip-green';
    if(n >= -5 && n <= 0) return 'chip-yellow';
    return 'chip-red';
  }

  function renderCards(){
    const deals = state.deals.slice().sort((a,b)=>{
      const da = a.dataAngariacao || '';
      const db = b.dataAngariacao || '';
      return (db || '').localeCompare(da || '');
    });
    const filtered = applyFilters(deals);
    cardsGrid.innerHTML = '';
    if(!filtered.length){
      emptyState.style.display = 'block';
    }else{
      emptyState.style.display = 'none';
    }

    let total = deals.length;
    let visiveis = deals.filter(d=>d.visible!==false).length;
    let porEstado = {novo:0,negociacao:0,aprovado:0,perdido:0};
    deals.forEach(d=>{
      if(porEstado[d.estadoAng] !== undefined) porEstado[d.estadoAng]++;
    });

    summaryBadges.innerHTML = '';
    const badge1 = document.createElement('div');
    badge1.className = 'badge';
    badge1.innerHTML = 'Total <strong>' + total + '</strong>';
    summaryBadges.appendChild(badge1);
    const badge2 = document.createElement('div');
    badge2.className = 'badge';
    badge2.innerHTML = 'Vis√≠veis <strong>' + visiveis + '</strong>';
    summaryBadges.appendChild(badge2);

    const fil = applyFilters(deals);
    const porCons = {};
    fil.forEach(d=>{
      if(!d.consultor) return;
      porCons[d.consultor] = (porCons[d.consultor]||0)+1;
    });
    Object.keys(porCons).sort().forEach(n=>{
      const b = document.createElement('div');
      b.className = 'badge';
      b.innerHTML = '<strong>'+n+':</strong> ' + porCons[n];
      summaryBadges.appendChild(b);
    });

    pipelineKpis.innerHTML = '';
    const estadosLabels = {
      novo:'Novo',
      negociacao:'Em negocia√ß√£o',
      aprovado:'Aprovado',
      perdido:'Perdido'
    };
    Object.keys(porEstado).forEach(k=>{
      const chip = document.createElement('div');
      chip.className = 'kpi-chip';
      chip.innerHTML = estadosLabels[k] + '<span class="value">'+porEstado[k]+'</span>';
      pipelineKpis.appendChild(chip);
    });

    filtered.forEach(d=>{
      const card = document.createElement('div');
      card.className = 'card' + (d.visible===false ? ' hidden-card':'');
      card.dataset.id = d.id;

      const title = d.isEmpreendimento && d.nomeEmp ? d.nomeEmp
                   : d.tituloImovel || d.nomeProp || 'Angaria√ß√£o';

      const sub = d.isEmpreendimento
        ? [d.totalFracoes ? (d.totalFracoes+' fra√ß√µes') : '',
           d.tipologiasEmp || '',
           d.concelho || '',
           d.zona || ''
          ].filter(Boolean).join(' ¬∑ ')
        : [d.nomeProp || '',
           d.concelho || '',
           d.zona || ''
          ].filter(Boolean).join(' ¬∑ ');

      const cert = d.certEnerg ? d.certEnerg : '';

      const tipoLinha = [d.tipoNegocio, d.natureza, d.estadoImovel]
        .filter(Boolean)
        .join(' ¬∑ ');

      const areas = [];
      if(d.areaABP) areas.push('ABP ' + d.areaABP + ' m¬≤');
      if(d.areaABD) areas.push('ABD ' + d.areaABD + ' m¬≤');
      if(d.areaTerreno) areas.push('Terreno ' + d.areaTerreno + ' m¬≤');
      if(d.areaImplantacao) areas.push('Implanta√ß√£o ' + d.areaImplantacao + ' m¬≤');

      let comPerc = '';
      if(d.comissao === 'outro' && d.comissaoOutro){
        comPerc = d.comissaoOutro + '%';
      }else if(d.comissao){
        comPerc = d.comissao + '%';
      }

      const ajustCls = classForAjust(d.percentAjust);
      const ajustTxt = formatPercent(d.percentAjust);

      const linhaPreco = [
        d.precoPedido ? formatMoney(d.precoPedido) : '',
        comPerc ? ('Comiss√£o ' + comPerc) : '',
        ajustTxt ? ('Ajust. ' + ajustTxt) : ''
      ].filter(Boolean).join(' ¬∑ ');

      const linhaCaract = [];
      if(d.numQuartos) linhaCaract.push(d.numQuartos + ' quarto(s)');
      if(d.numSuites) linhaCaract.push(d.numSuites + ' suite(s)');
      if(d.numPisos) linhaCaract.push(d.numPisos + ' piso(s)');
      if(d.numVarandas) linhaCaract.push(d.numVarandas + ' varanda(s)');
      if(d.numSalas) linhaCaract.push(d.numSalas + ' sala(s)');
      if(d.numSalasJantar) linhaCaract.push(d.numSalasJantar + ' sala(s) jantar');

      const temPiscina = Array.isArray(d.infraestruturas) && d.infraestruturas.includes('Piscina');
      const temGaragem = Array.isArray(d.infraestruturas) && d.infraestruturas.includes('Garagem');
      const chipsExtras = [];
      if(temPiscina) chipsExtras.push('Piscina');
      if(temGaragem) chipsExtras.push('Garagem');
      if(Array.isArray(d.zonaEnvolvente) && d.zonaEnvolvente.includes('Perto da praia')){
        chipsExtras.push('Perto da praia');
      }

      const estLabel = {
        novo:'Novo',
        negociacao:'Em negocia√ß√£o',
        aprovado:'Aprovado',
        perdido:'Perdido'
      }[d.estadoAng] || '‚Äî';

      const estClass = d.estadoAng==='aprovado'
        ? 'chip-green'
        : d.estadoAng==='negociacao'
          ? 'chip-yellow'
          : d.estadoAng==='perdido'
            ? 'chip-red'
            : 'chip-primary';

      const topRow = document.createElement('div');
      topRow.className = 'card-top-row';

      const titleBlock = document.createElement('div');
      titleBlock.className = 'card-title-block';

      const h3 = document.createElement('h3');
      h3.className = 'card-title';
      h3.textContent = title;
      titleBlock.appendChild(h3);

      const subtitle = document.createElement('div');
      subtitle.className = 'card-subtitle';
      subtitle.textContent = sub;
      titleBlock.appendChild(subtitle);

      const chipsRow = document.createElement('div');
      chipsRow.className = 'chip-row';

      const chipEstado = document.createElement('span');
      chipEstado.className = 'chip ' + estClass;
      chipEstado.textContent = estLabel;
      chipsRow.appendChild(chipEstado);

      if(d.consultor){
        const ch = document.createElement('span');
        ch.className = 'chip';
        ch.textContent = d.consultor;
        chipsRow.appendChild(ch);
      }
      if(d.gestor && d.gestor !== d.consultor){
        const ch = document.createElement('span');
        ch.className = 'chip';
        ch.textContent = 'Gestor: ' + d.gestor;
        chipsRow.appendChild(ch);
      }
      if(d.isEmpreendimento){
        const ch = document.createElement('span');
        ch.className = 'chip';
        ch.textContent = 'Empreendimento';
        chipsRow.appendChild(ch);
      }
      if(d.exclusivo){
        const ch = document.createElement('span');
        ch.className = 'chip chip-primary';
        ch.textContent = 'Exclusivo';
        chipsRow.appendChild(ch);
      }else if(d.naoExclusivo){
        const ch = document.createElement('span');
        ch.className = 'chip';
        ch.textContent = 'N√£o exclusivo';
        chipsRow.appendChild(ch);
      }
      if(chipsExtras.length){
        chipsExtras.forEach(t=>{
          const ch = document.createElement('span');
          ch.className = 'chip';
          ch.textContent = t;
          chipsRow.appendChild(ch);
        });
      }
      if(cert){
        const ch = document.createElement('span');
        ch.className = 'chip';
        ch.textContent = 'CE ' + cert;
        chipsRow.appendChild(ch);
      }

      titleBlock.appendChild(chipsRow);
      topRow.appendChild(titleBlock);
      card.appendChild(topRow);

      if(tipoLinha){
        const sec = document.createElement('div');
        sec.className = 'card-section';
        const span = document.createElement('span');
        span.textContent = tipoLinha;
        sec.appendChild(span);
        card.appendChild(sec);
      }

      if(linhaCaract.length){
        const sec = document.createElement('div');
        sec.className = 'card-section';
        const span = document.createElement('span');
        span.textContent = linhaCaract.join(' ¬∑ ');
        sec.appendChild(span);
        card.appendChild(sec);
      }

      if(areas.length){
        const sec = document.createElement('div');
        sec.className = 'card-section';
        const span = document.createElement('span');
        span.textContent = areas.join(' ¬∑ ');
        sec.appendChild(span);
        card.appendChild(sec);
      }

      if(linhaPreco){
        const sec = document.createElement('div');
        sec.className = 'card-section';
        const span = document.createElement('span');
        span.textContent = linhaPreco;
        if(ajustTxt){
          const chipA = document.createElement('span');
          chipA.className = 'chip ' + ajustCls;
          chipA.style.marginLeft = '6px';
          chipA.textContent = ajustTxt;
          sec.appendChild(chipA);
        }
        sec.appendChild(span);
        card.appendChild(sec);
      }

      const foot = document.createElement('div');
      foot.className = 'card-footer';
      const left = document.createElement('div');
      left.className = 'card-footer-left';
      const partes = [];
      if(d.dataAngariacao) partes.push(d.dataAngariacao);
      if(d.duracaoContrato){
        partes.push('Contrato ' + d.duracaoContrato);
      }
      left.textContent = partes.join(' ¬∑ ');
      foot.appendChild(left);

      const right = document.createElement('div');
      right.className = 'card-footer-right';

      const btnEdit = document.createElement('button');
      btnEdit.className = 'btn-xs primary';
      btnEdit.textContent = 'Editar';
      btnEdit.addEventListener('click',()=>{
        if(state.locked) return;
        openModal(d);
      });
      right.appendChild(btnEdit);

      const btnPdf = document.createElement('button');
      btnPdf.className = 'btn-xs';
      btnPdf.textContent = 'PDF';
      btnPdf.addEventListener('click',()=>{
        exportOnePdf(d);
      });
      right.appendChild(btnPdf);

      const btnVis = document.createElement('button');
      btnVis.className = 'btn-xs';
      btnVis.textContent = d.visible===false ? 'Tornar vis√≠vel' : 'Tornar invis√≠vel';
      btnVis.addEventListener('click',()=>{
        if(state.locked) return;
        d.visible = d.visible===false ? true : false;
        saveState();
        renderCards();
      });
      right.appendChild(btnVis);

      const btnDel = document.createElement('button');
      btnDel.className = 'btn-xs danger';
      btnDel.textContent = 'Apagar';
      btnDel.addEventListener('click',()=>{
        if(state.locked) return;
        if(confirm('Tem a certeza que pretende apagar esta angaria√ß√£o?')){
          state.deals = state.deals.filter(x=>x.id !== d.id);
          saveState();
          renderCards();
        }
      });
      right.appendChild(btnDel);

      foot.appendChild(right);
      card.appendChild(foot);

      cardsGrid.appendChild(card);
    });
  }
  function exportCsv(){
    if(!state.deals.length){
      alert('N√£o existem angaria√ß√µes para exportar.');
      return;
    }
    const cols = [
      'id','consultor','gestor','coordenador','interveniente','refInterna','linkUrl',
      'dataAngariacao','estadoAng','duracaoContrato','duracaoOutro',
      'isEmpreendimento','nomeEmp','totalFracoes','tipologiasEmp','anoConstrEmp','mesConclEmp','anoConclEmp',
      'promotor','telPromotor','emailPromotor',
      'nomeProp','telProp','emailProp','moradaProp','estadoCivil','regimeCasamento',
      'tituloImovel','localizacao','distrito','concelho','freguesia','zona','gps',
      'anoConstrucao','anoConclusao','mesConclusao','certEnerg','condominioValor',
      'natureza','estadoImovel','tipoNegocio','origemCliente',
      'areaUtil','areaBruta','areaABP','areaABD','areaTerreno','areaImplantacao',
      'precoPedido','precoSugerido','comissao','comissaoOutro','percentAjust',
      'numSalas','numSalasJantar','numSuites','numClosets','numCozinhas','numDespensas',
      'numMarquises','numLavandarias','numSotaos','numVarandas','numPisos','numQuartos',
      'exclusivo','naoExclusivo','visible'
    ];

    function esc(v){
      if(v==null) return '';
      const s = String(v).replace(/"/g,'""');
      return '"' + s + '"';
    }

    let csv = cols.map(esc).join(';') + '\n';
    state.deals.forEach(d=>{
      const row = cols.map(c=>esc(d[c]));
      csv += row.join(';') + '\n';
    });

    const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'angariacoes_garvetur_porto_pro.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  // --- Importa√ß√£o de CSV (migra√ß√£o/backup controlado) ---

  // Pequeno parser para CSV com separador ";" e campos entre aspas
  function parseCsv(text){
    const rows = [];
    let row = [];
    let cur = '';
    let inQuotes = false;

    for(let i=0; i<text.length; i++){
      const ch = text[i];

      if(ch === '"'){
        if(inQuotes && text[i+1] === '"'){
          cur += '"';
          i++;
        }else{
          inQuotes = !inQuotes;
        }
      }else if(ch === ';' && !inQuotes){
        row.push(cur);
        cur = '';
      }else if((ch === '\n' || ch === '\r') && !inQuotes){
        if(ch === '\r' && text[i+1] === '\n') i++;
        row.push(cur);
        rows.push(row);
        row = [];
        cur = '';
      }else{
        cur += ch;
      }
    }
    if(cur.length>0 || row.length>0){
      row.push(cur);
      rows.push(row);
    }
    return rows;
  }

  function importFromCsvContent(text){
    const rows = parseCsv(text.trim());
    if(!rows.length){
      alert('Ficheiro CSV vazio ou n√£o reconhecido.');
      return;
    }

    const headerRaw = rows[0];
    const headers = headerRaw.map(h=>{
      return String(h || '').trim().replace(/^"|"$/g,'');
    });

    const KNOWN_FIELDS = new Set([
      'id','consultor','gestor','coordenador','interveniente','refInterna','linkUrl',
      'dataAngariacao','estadoAng','duracaoContrato','duracaoOutro',
      'isEmpreendimento','nomeEmp','totalFracoes','tipologiasEmp','anoConstrEmp','mesConclEmp','anoConclEmp',
      'promotor','telPromotor','emailPromotor',
      'nomeProp','telProp','emailProp','moradaProp','estadoCivil','regimeCasamento',
      'tituloImovel','localizacao','distrito','concelho','freguesia','zona','gps',
      'anoConstrucao','anoConclusao','mesConclusao','certEnerg','condominioValor',
      'natureza','estadoImovel','tipoNegocio','origemCliente',
      'areaUtil','areaBruta','areaABP','areaABD','areaTerreno','areaImplantacao',
      'precoPedido','precoSugerido','comissao','comissaoOutro','percentAjust',
      'numSalas','numSalasJantar','numSuites','numClosets','numCozinhas','numDespensas',
      'numMarquises','numLavandarias','numSotaos','numVarandas','numPisos','numQuartos',
      'exclusivo','naoExclusivo','visible'
    ]);

    let imported = 0;
    let created = 0;
    let updated = 0;

    for(let i=1;i<rows.length;i++){
      const row = rows[i];
      if(!row || row.length===0) continue;

      const record = {};
      headers.forEach((h,idx)=>{
        if(!h) return;
        let val = row[idx] || '';
        val = String(val).trim();
        val = val.replace(/^"|"$/g,'').replace(/""/g,'"');
        if(!KNOWN_FIELDS.has(h)) return;

        if(h === 'exclusivo' || h === 'naoExclusivo' || h === 'isEmpreendimento' || h === 'visible'){
          const low = val.toLowerCase();
          record[h] = (low === 'true' || low === '1' || low === 'sim');
        }else{
          record[h] = val;
        }
      });

      if(Object.keys(record).length === 0) continue;

      let id = record.id;
      if(!id){
        id = 'ang_' + Date.now() + '_' + i;
        record.id = id;
      }

      const idxExisting = state.deals.findIndex(d=>d.id === id);
      if(idxExisting >= 0){
        // Atualiza angaria√ß√£o existente preservando campos que n√£o v√™m no CSV
        const existing = state.deals[idxExisting];
        const merged = Object.assign({}, existing, record, { id });
        state.deals[idxExisting] = merged;
        updated++;
      }else{
        // Nova angaria√ß√£o
        const novo = Object.assign({
          zonaEnvolvente: [],
          infraestruturas: [],
          equipamentos: [],
          seguranca: [],
          documentacao: []
        }, record);
        state.deals.push(novo);
        created++;
      }
      imported++;
    }

    saveState();
    renderCards();

    alert(
      'Importa√ß√£o conclu√≠da.\n\n' +
      'Registos lidos: ' + imported +
      '\nNovos: ' + created +
      '\nAtualizados: ' + updated
    );
  }

  function handleImportCsv(){
    if(state.locked){
      alert('O modo de edi√ß√£o est√° bloqueado. Desbloqueie o cadeado no topo para importar dados.');
      return;
    }

    if(!confirm('Esta opera√ß√£o vai importar/atualizar angaria√ß√µes a partir de um ficheiro CSV (exportado do Garvetur Porto Pro).\n\nOs dados existentes com o mesmo ID ser√£o atualizados, os restantes ser√£o adicionados.\n\nPretende continuar?')){
      return;
    }

    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.csv,text/csv';

    input.addEventListener('change', (e)=>{
      const file = e.target.files && e.target.files[0];
      if(!file) return;

      const reader = new FileReader();
      reader.onload = (ev)=>{
        try{
          const text = ev.target.result;
          importFromCsvContent(text);
        }catch(err){
          console.error('Erro a importar CSV', err);
          alert('Ocorreu um erro ao ler o ficheiro CSV. Verifique se foi exportado a partir do Garvetur Porto Pro.');
        }
      };
      reader.readAsText(file,'utf-8');
    });

    input.click();
  }

  function exportOnePdf(deal){
    const w = window.open('', '_blank');
    if(!w){
      alert('O navegador bloqueou a abertura da janela de impress√£o.\n\nPor favor permita pop-ups para este site ou use a op√ß√£o de imprimir diretamente no browser.');
      return;
    }

    const titulo = deal.isEmpreendimento && deal.nomeEmp
      ? deal.nomeEmp
      : (deal.tituloImovel || deal.nomeProp || 'Angaria√ß√£o');

    const comPerc = deal.comissao === 'outro'
      ? (deal.comissaoOutro || '')
      : (deal.comissao || '');

    const conclEmpStr = (deal.mesConclEmp ? (deal.mesConclEmp + '/') : '') + (deal.anoConclEmp || '');
    const conclImovelStr = (deal.mesConclusao ? (deal.mesConclusao + '/') : '') + (deal.anoConclusao || '');

    const html = `
<!doctype html>
<html lang="pt-PT">
<head>
<meta charset="utf-8" />
<title>Ficha de Angaria√ß√£o ‚Äî ${titulo}</title>
<style>
  @page { size: A4; margin: 2cm; }
  body{
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
    margin:0;
    padding:0;
    color:#222;
    background:#fff;
  }
  .page{
    padding:0;
  }
  h1{
    font-size:18px;
    margin:0 0 4px;
    letter-spacing:.12em;
    text-transform:uppercase;
    color:#333;
  }
  .sub{
    font-size:11px;
    color:#777;
    letter-spacing:.18em;
    text-transform:uppercase;
  }
  header{
    border-bottom:2px solid #A38B63;
    padding-bottom:8px;
    margin-bottom:10px;
    display:flex;
    justify-content:space-between;
    align-items:flex-end;
  }
  .brand-block{
    max-width:70%;
  }
  .logo-block{
    font-size:11px;
    color:#555;
    text-align:right;
  }
  h2.section{
    font-size:11px;
    text-transform:uppercase;
    letter-spacing:.16em;
    color:#555;
    margin:14px 0 4px;
    border-bottom:1px solid #ddd;
    padding-bottom:2px;
  }
  .line{
    font-size:10px;
    margin:2px 0;
  }
  .muted{ color:#777; }
  .strong{ font-weight:600; }
</style>
</head>
<body>
<div class="page">
  <header>
    <div class="brand-block">
      <h1>Garvetur Luxury Porto</h1>
      <div class="sub">Ficha de Angaria√ß√£o ‚Äî Garvetur Porto Pro</div>
    </div>
    <div class="logo-block">
      <div>Data: ${new Date().toLocaleDateString('pt-PT')}</div>
      <div>Ref.: ${deal.refInterna || '-'}</div>
    </div>
  </header>

  <div class="line"><span class="strong">T√≠tulo:</span> ${titulo}</div>
  <div class="line"><span class="strong">Consultor:</span> ${deal.consultor || ''} &nbsp; | &nbsp;
    <span class="strong">Gestor:</span> ${deal.gestor || ''} &nbsp; | &nbsp;
    <span class="strong">Coordenador:</span> ${deal.coordenador || ''}</div>
  <div class="line"><span class="strong">Estado:</span> ${deal.estadoAng || ''} &nbsp; | &nbsp;
    <span class="strong">Data angaria√ß√£o:</span> ${deal.dataAngariacao || ''}</div>
  ${deal.linkUrl ? `<div class="line"><span class="strong">Link:</span> ${deal.linkUrl}</div>` : ''}

  <h2 class="section">Empreendimento</h2>
  ${
    deal.isEmpreendimento
      ? `
      <div class="line"><span class="strong">Nome empreendimento:</span> ${deal.nomeEmp || ''}</div>
      <div class="line"><span class="strong">Fra√ß√µes:</span> ${deal.totalFracoes || ''} &nbsp; | &nbsp;
        <span class="strong">Tipologias:</span> ${deal.tipologiasEmp || ''}</div>
      <div class="line"><span class="strong">Ano constru√ß√£o:</span> ${deal.anoConstrEmp || ''} &nbsp; | &nbsp;
        <span class="strong">Conclus√£o:</span> ${conclEmpStr || ''}</div>
      <div class="line"><span class="strong">Promotor:</span> ${deal.promotor || ''}</div>
      <div class="line"><span class="strong">Contacto promotor:</span> ${deal.telPromotor || ''} &nbsp; | &nbsp;
        <span class="strong">Email:</span> ${deal.emailPromotor || ''}</div>
    `
      : `<div class="line muted">N√£o assinalado como empreendimento.</div>`
  }

  <h2 class="section">Propriet√°rio</h2>
  <div class="line"><span class="strong">Nome:</span> ${deal.nomeProp || ''}</div>
  <div class="line"><span class="strong">Contacto:</span> ${deal.telProp || ''} &nbsp; | &nbsp;
    <span class="strong">Email:</span> ${deal.emailProp || ''}</div>
  <div class="line"><span class="strong">Morada:</span> ${deal.moradaProp || ''}</div>
  <div class="line"><span class="strong">Estado civil:</span> ${deal.estadoCivil || ''} &nbsp; | &nbsp;
    <span class="strong">Regime casamento:</span> ${deal.regimeCasamento || ''}</div>

  <h2 class="section">Im√≥vel & Localiza√ß√£o</h2>
  <div class="line"><span class="strong">T√≠tulo / Designa√ß√£o:</span> ${deal.tituloImovel || ''}</div>
  <div class="line"><span class="strong">Localiza√ß√£o:</span> ${deal.localizacao || ''}</div>
  <div class="line"><span class="strong">Distrito:</span> ${deal.distrito || ''} &nbsp; | &nbsp;
    <span class="strong">Concelho:</span> ${deal.concelho || ''} &nbsp; | &nbsp;
    <span class="strong">Freguesia:</span> ${deal.freguesia || ''} &nbsp; | &nbsp;
    <span class="strong">Zona:</span> ${deal.zona || ''}</div>
  <div class="line"><span class="strong">GPS:</span> ${deal.gps || ''}</div>
  <div class="line"><span class="strong">Ano constru√ß√£o:</span> ${deal.anoConstrucao || ''} &nbsp; | &nbsp;
    <span class="strong">Conclus√£o / previs√£o:</span> ${conclImovelStr || ''}</div>
  <div class="line"><span class="strong">Cert. energ√©tico:</span> ${deal.certEnerg || ''} &nbsp; | &nbsp;
    <span class="strong">Condom√≠nio:</span> ${deal.condominioValor || ''}</div>

  <h2 class="section">Natureza, √Åreas, Pre√ßo</h2>
  <div class="line"><span class="strong">Natureza:</span> ${deal.natureza || ''} &nbsp; | &nbsp;
    <span class="strong">Estado im√≥vel:</span> ${deal.estadoImovel || ''} &nbsp; | &nbsp;
    <span class="strong">Neg√≥cio:</span> ${deal.tipoNegocio || ''}</div>
  <div class="line"><span class="strong">Origem cliente:</span> ${deal.origemCliente || ''}</div>
  <div class="line"><span class="strong">√Åreas:</span>
    √∫til ${deal.areaUtil || '-'} m¬≤ ¬∑
    bruta ${deal.areaBruta || '-'} m¬≤ ¬∑
    ABP ${deal.areaABP || '-'} m¬≤ ¬∑
    ABD ${deal.areaABD || '-'} m¬≤ ¬∑
    terreno ${deal.areaTerreno || '-'} m¬≤ ¬∑
    implanta√ß√£o ${deal.areaImplantacao || '-'} m¬≤
  </div>
  <div class="line"><span class="strong">Pre√ßo pedido:</span> ${deal.precoPedido || '-'} &nbsp; | &nbsp;
    <span class="strong">Sugerido:</span> ${deal.precoSugerido || '-'}</div>
  <div class="line"><span class="strong">Comiss√£o:</span> ${comPerc ? comPerc + '%' : '-'} &nbsp; | &nbsp;
    <span class="strong">Ajustamento:</span> ${deal.percentAjust ? deal.percentAjust + '%' : '-'}</div>

  <h2 class="section">Caracter√≠sticas (10.1)</h2>
  <div class="line">
    ${
      [
        deal.numQuartos && (deal.numQuartos + ' quarto(s)'),
        deal.numSuites && (deal.numSuites + ' suite(s)'),
        deal.numPisos && (deal.numPisos + ' piso(s)'),
        deal.numVarandas && (deal.numVarandas + ' varanda(s)'),
        deal.numSalas && (deal.numSalas + ' sala(s)'),
        deal.numSalasJantar && (deal.numSalasJantar + ' sala(s) jantar'),
        deal.numCozinhas && (deal.numCozinhas + ' cozinha(s)')
      ].filter(Boolean).join(' ¬∑ ') || '‚Äî'
    }
  </div>

  <h2 class="section">Zona envolvente (10.2)</h2>
  <div class="line">
    ${Array.isArray(deal.zonaEnvolvente) && deal.zonaEnvolvente.length ? deal.zonaEnvolvente.join(', ') : '‚Äî'}
  </div>

  <h2 class="section">Infraestruturas (10.3)</h2>
  <div class="line">
    ${Array.isArray(deal.infraestruturas) && deal.infraestruturas.length ? deal.infraestruturas.join(', ') : '‚Äî'}
  </div>

  <h2 class="section">Equipamentos (10.4)</h2>
  <div class="line">
    ${Array.isArray(deal.equipamentos) && deal.equipamentos.length ? deal.equipamentos.join(', ') : '‚Äî'}
  </div>

  <h2 class="section">Seguran√ßa (10.5)</h2>
  <div class="line">
    ${Array.isArray(deal.seguranca) && deal.seguranca.length ? deal.seguranca.join(', ') : '‚Äî'}
  </div>

  <h2 class="section">Documenta√ß√£o & Notas</h2>
  <div class="line"><span class="strong">Documenta√ß√£o recebida:</span> ${
    Array.isArray(deal.documentacao) && deal.documentacao.length ? deal.documentacao.join(', ') : '‚Äî'
  }</div>
  ${deal.observacoes ? `<div class="line"><span class="strong">Observa√ß√µes:</span> ${deal.observacoes}</div>` : ''}
  ${deal.notasInternas ? `<div class="line"><span class="strong">Notas internas:</span> ${deal.notasInternas}</div>` : ''}

</div>
<script>
  window.print();
<\/script>
</body>
</html>
    `;

    w.document.open();
    w.document.write(html);
    w.document.close();
  }

  function exportPdfAll(){
    const filtered = applyFilters(state.deals);
    if(!filtered.length){
      alert('N√£o existem angaria√ß√µes com os filtros atuais para exportar.');
      return;
    }
    exportOnePdf(filtered[0]);
    if(filtered.length>1){
      alert('Neste momento a exporta√ß√£o em lote gera um PDF de cada vez. Para outras angaria√ß√µes, use o bot√£o PDF de cada cart√£o.');
    }
  }

  // Integra√ß√£o com Tarefas: abrir ficha original da angaria√ß√£o
  function applyUrlContext(){
    try{
      const params = new URLSearchParams(window.location.search);
      const refRaw = (params.get('ref') || '').trim();
      const abrir = (params.get('abrir') || '').trim();
      if(!refRaw) return;

      const refCompleta = refRaw.toLowerCase();
      const refBase = refRaw.split(/[-‚Äì|]/)[0].trim().toLowerCase();

      function matchRef(campo){
        if(!campo) return false;
        const v = String(campo).toLowerCase().trim();
        if(!v) return false;
        return (
          v === refBase ||
          v === refCompleta ||
          v.includes(refBase) ||
          refBase.includes(v) ||
          v.includes(refCompleta) ||
          refCompleta.includes(v)
        );
      }

      if(abrir === '1' || !abrir){
        const match = state.deals.find(d=>{
          return (
            matchRef(d.refInterna) ||
            matchRef(d.tituloImovel) ||
            matchRef(d.nomeEmp) ||
            matchRef(d.nomeProp)
          );
        });

        if(match){
          openModal(match);
          setTimeout(()=>{
            const el = document.querySelector('.card[data-id="'+match.id+'"]');
            if(el){
              el.scrollIntoView({behavior:'smooth', block:'center'});
              el.classList.add('card--highlight');
              setTimeout(()=>el.classList.remove('card--highlight'), 2500);
            }
          }, 300);
        }else{
          alert('N√£o foi poss√≠vel localizar a angaria√ß√£o associada a esta tarefa. Verifique se a refer√™ncia interna coincide.');
        }
      }
    }catch(e){
      console.error('Erro ao aplicar contexto vindo de tarefas em angaria√ß√µes', e);
    }
  }

  toggleLockBtn.addEventListener('click',()=>{
    state.locked = !state.locked;
    updateLockUI();
    saveState();
  });

  newDealBtn.addEventListener('click',()=>{
    if(state.locked) return;
    openModal(null);
  });

  closeModalBtn.addEventListener('click', closeModal);
  cancelModalBtn.addEventListener('click', closeModal);

  isEmpreendimento.addEventListener('change', updateEmpBlockVisibility);

  if(estadoImovelSelect){
    estadoImovelSelect.addEventListener('change', updateConclusaoFieldsVisibility);
  }

  filterApplyBtn.addEventListener('click', ()=>{
    saveFilterStateFromUI();
    renderCards();
  });

  filterClearBtn.addEventListener('click', ()=>{
    filterConsultor.value = '';
    filterSearchText.value = '';
    filterDataDe.value = '';
    filterDataAte.value = '';
    filterShowHidden.checked = false;
    filterOnlyHidden.checked = false;
    saveFilterStateFromUI();
    renderCards();
  });

  saveDealBtn.addEventListener('click', (e)=>{
    e.preventDefault();
    if(state.locked){
      alert('O modo de edi√ß√£o est√° bloqueado. Desbloqueie o cadeado no topo para guardar altera√ß√µes.');
      return;
    }
    const data = collectFormData();
    const idx = state.deals.findIndex(d=>d.id === data.id);
    if(idx>=0){
      state.deals[idx] = data;
    }else{
      state.deals.push(data);
    }
    saveState();
    renderCards();
    closeModal();
  });

  exportCsvBtn.addEventListener('click', exportCsv);
  importCsvBtn.addEventListener('click', handleImportCsv);
  exportPdfBtn.addEventListener('click', exportPdfAll);

  window.addEventListener('keydown', (e)=>{
    if(e.key==='Escape' && modalBackdrop.classList.contains('open')){
      closeModal();
    }
  });

  renderCheckboxGroup('zonaEnvolventeGroup','zonaEnvolvente',ZONA_ENVOLVENTE);
  renderCheckboxGroup('infraGroup','infraestruturas',INFRAESTRUTURAS);
  renderCheckboxGroup('equipGroup','equipamentos',EQUIPAMENTOS);
  renderCheckboxGroup('segGroup','seguranca',SEGURANCA);
  renderCheckboxGroup('docsGroup','documentacao',DOCUMENTACAO);

  initConsultores();
  loadState();
  loadFilterState();
  renderCards();
  applyUrlContext();
  updateConclusaoFieldsVisibility(); // garante estado correto no arranque

})();
</script>
</body>
</html>
