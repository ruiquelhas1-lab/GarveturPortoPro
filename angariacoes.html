<!doctype html>
<html lang="pt">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Garvetur Porto Pro ‚Äî Angaria√ß√µes</title>

<link rel="preconnect" href="https://unpkg.com" crossorigin>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>

<style>
:root{
  --gold:#A38B63;
  --bg:#0E0E0E;
  --panel:#131313;
  --text:#FFFFFF;
  --muted:#9AA0A6;
  --border:rgba(255,255,255,.12);
}
html,body{
  height:100%;
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;
}
a{color:#eaeaea;text-decoration:none}

/* Layout base */
.app{display:grid;grid-template-rows:56px auto auto 1fr;height:100%}

/* Header */
header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:10px 12px;
  border-bottom:1px solid var(--border);
  background:#0F0F0F;
}
.brand{display:flex;align-items:center;gap:10px}
.brand h1{font-size:16px;margin:0;color:var(--gold)}
.nav{display:flex;gap:8px}
.nav a{
  border:1px solid var(--border);
  padding:6px 10px;
  border-radius:8px;
  color:#ddd;
}
.nav a.active{
  background:var(--gold);
  color:#111;
  border-color:var(--gold);
  font-weight:700;
}

/* Toolbar */
.toolbar{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  padding:8px 12px;
  border-bottom:1px solid var(--border);
  background:#0F0F0F;
}
.btn{
  background:transparent;
  border:1px solid rgba(163,139,99,.5);
  color:#fff;
  padding:6px 10px;
  border-radius:10px;
  cursor:pointer;
  font-size:12px;
}
.btn.primary{background:var(--gold);color:#111;border-color:var(--gold);font-weight:700}
.btn.ghost{border-color:var(--border);color:#ddd}
.btn[disabled]{opacity:.45;cursor:not-allowed}

/* KPI Bar */
.kpi-bar{
  padding:6px 12px;
  border-bottom:1px solid var(--border);
  font-size:12px;
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  align-items:center;
  background:#101010;
}
.kpi-badge{
  padding:2px 8px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.18);
}
.kpi-badge.highlight{
  border-color:var(--gold);
  color:var(--gold);
  font-weight:600;
}

/* Main */
.main{
  display:grid;
  grid-template-columns:300px 1fr;
  height:calc(100vh - 56px - 48px - 32px);
}
.sidebar{
  background:var(--panel);
  border-right:1px solid var(--border);
  padding:12px;
  overflow:auto;
}
.sidebar h3{
  margin:0 0 8px 0;
  font-size:13px;
  color:#d7d7d7;
  text-transform:uppercase;
  letter-spacing:.06em;
}
.field{
  display:flex;
  flex-direction:column;
  gap:6px;
  margin-bottom:10px;
}
.field label{font-size:12px;color:#ccc}
.field input,.field select{
  background:#0E0E0E;
  border:1px solid rgba(255,255,255,.16);
  border-radius:8px;
  color:#fff;
  padding:8px 10px;
  outline:none;
  font-size:12px;
}
.checks{display:flex;flex-direction:column;gap:8px}
.checks label{
  display:flex;
  gap:6px;
  align-items:center;
  font-size:13px;
  color:#ddd;
}
.checks input{accent-color:var(--gold)}

/* Board */
.board{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:10px;
  padding:10px;
  height:100%;
  overflow:auto;
}
.col{
  background:var(--panel);
  border-radius:12px;
  border:1px solid var(--border);
  display:flex;
  flex-direction:column;
  min-width:260px;
}
.col header{
  padding:10px;
  border-bottom:1px solid rgba(255,255,255,.08);
  display:flex;
  align-items:center;
  justify-content:space-between;
}
.col header .title{font-weight:700}
.col header .counter{font-size:12px;color:#cfcfcf}
.col .list{
  padding:10px;
  display:flex;
  flex-direction:column;
  gap:10px;
}

/* Cards */
.card{
  background:#0E0E0E;
  border-radius:12px;
  border:1px solid rgba(163,139,99,.35);
  padding:10px;
}
.card .top{
  display:flex;
  justify-content:space-between;
  gap:8px;
}
.card .name{font-weight:700}
.card .meta{font-size:11px;color:#bbb;text-transform:uppercase;letter-spacing:.04em}
.card .row{margin-top:5px;font-size:12px;color:#ddd}
.card .row small{color:#aaa}
.badge{
  display:inline-block;
  padding:2px 8px;
  font-size:11px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.18);
}
.badge.red{border-color:#ff6b6b;color:#ffb4b4}
.badge.green{border-color:#5ac48f;color:#bdf7d3}
.badge.yellow{border-color:#ffdd7a;color:#ffdd7a}
.actions{
  margin-top:8px;
  display:flex;
  flex-wrap:wrap;
  gap:6px;
}
.btn-sm{
  font-size:11px;
  padding:4px 7px;
  border-radius:8px;
  border:1px solid rgba(255,255,255,.18);
  background:transparent;
  color:#eee;
  cursor:pointer;
}
.btn-sm.danger{border-color:#cc4b4b;color:#ffdddd}
.btn-sm[disabled]{opacity:.45;cursor:not-allowed}
.select-move{
  background:#0E0E0E;
  border-radius:8px;
  border:1px solid rgba(255,255,255,.25);
  color:#ddd;
  font-size:11px;
  padding:3px 6px;
}
.select-move[disabled]{opacity:.45;cursor:not-allowed}

/* Mini gr√°fico por consultor */
.chart{
  margin-top:12px;
  border-top:1px dashed rgba(255,255,255,.2);
  padding-top:10px;
}
.chart h4{
  margin:0 0 6px 0;
  font-size:12px;
  color:#ccc;
  text-transform:uppercase;
  letter-spacing:.06em;
}
.chart-row{
  display:flex;
  align-items:center;
  gap:6px;
  margin-bottom:4px;
}
.chart-label{
  width:120px;
  font-size:11px;
  color:#ddd;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.chart-bar-wrap{
  flex:1;
  background:#222;
  border-radius:999px;
  overflow:hidden;
}
.chart-bar{
  height:6px;
  background:linear-gradient(90deg,#A38B63,#F4D188);
}

/* Modal */
.modal-backdrop{
  position:fixed;
  inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  background:rgba(0,0,0,.6);
  backdrop-filter:blur(2px);
  z-index:10000;
  padding:16px;
}
.modal-backdrop.show{display:flex}
.modal{
  width:min(900px,96vw);
  background:#0F0F0F;
  border-radius:12px;
  border:1px solid var(--border);
  overflow:hidden;
}
.modal header{
  padding:10px 12px;
  border-bottom:1px solid var(--border);
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.modal .content{
  padding:12px;
  max-height:72vh;
  overflow:auto;
}
.form-grid2{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
}
.form-field{
  display:flex;
  flex-direction:column;
  gap:6px;
}
.form-field label{font-size:12px;color:#ccc}
.form-field input,.form-field select,.form-field textarea{
  background:#0E0E0E;
  border-radius:8px;
  border:1px solid rgba(255,255,255,.16);
  color:#fff;
  padding:8px 10px;
  outline:none;
  font-size:12px;
}
.docs-grid{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:6px;
}
.docs-grid label{
  font-size:12px;
  display:flex;
  align-items:center;
  gap:6px;
  color:#ddd;
}
.docs-grid input{accent-color:var(--gold)}
textarea{resize:vertical}

/* Responsive */
@media (max-width:1400px){ .board{grid-template-columns:repeat(3,1fr)} }
@media (max-width:1024px){ .board{grid-template-columns:repeat(2,1fr)} }
@media (max-width:768px){
  .main{grid-template-columns:1fr}
  .sidebar{order:2;height:280px}
  .board{order:1}
  .docs-grid{grid-template-columns:repeat(2,1fr)}
}
</style>
</head>
<body>
<header>
  <div class="brand">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" style="color:var(--gold)">
      <circle cx="12" cy="12" r="10" stroke-width="1.5"/>
      <path d="M8 12l2.5 2.5L16 9" stroke-width="1.8"/>
    </svg>
    <h1>Garvetur Porto Pro ‚Äî Angaria√ß√µes</h1>
  </div>
  <nav class="nav">
    <a href="./index.html">Mapa</a>
    <a href="./kanban.html">Leads</a>
    <a class="active" href="./angariacoes.html">Angaria√ß√µes</a>
    <a href="./dashboard.html">Dashboard</a>
  </nav>
</header>

<div class="toolbar">
  <button class="btn primary" id="btnNew" disabled>+ Nova Angaria√ß√£o</button>
  <button class="btn" id="toggleEdit">üîí Edi√ß√£o bloqueada</button>
  <div style="margin-left:auto;display:flex;gap:8px;flex-wrap:wrap">
    <button class="btn" id="exportCsv">Exportar CSV</button>
  </div>
</div>

<div class="kpi-bar" id="kpiBar"></div>

<div class="main">
  <!-- Sidebar -->
  <aside class="sidebar">
    <h3>Pesquisa</h3>
    <div class="field">
      <input id="f_q" placeholder="Im√≥vel, propriet√°rio, consultor, ref., notas">
    </div>

    <h3>Filtros</h3>
    <div class="field">
      <label>Consultor</label>
      <select id="f_consultor">
        <option value="">(Todos)</option>
      </select>
    </div>
    <div class="field">
      <label>Estado</label>
      <select id="f_estado">
        <option value="">(Todos)</option>
        <option>Novo</option>
        <option>Em Negocia√ß√£o</option>
        <option>Aprovado</option>
        <option>Perdido</option>
      </select>
    </div>
    <div class="field">
      <label>Per√≠odo (Data)</label>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px">
        <input id="f_ini" type="date">
        <input id="f_fim" type="date">
      </div>
    </div>
    <div class="field">
      <label>% Ajustamento (min-m√°x)</label>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px">
        <input id="f_aj_min" type="number" step="1" placeholder="min">
        <input id="f_aj_max" type="number" step="1" placeholder="m√°x">
      </div>
    </div>
    <div class="checks">
      <label><input type="checkbox" id="f_show_hidden"> Mostrar invis√≠veis</label>
      <label><input type="checkbox" id="f_only_hidden"> S√≥ invis√≠veis</label>
    </div>
    <div style="display:flex;gap:8px;margin-top:10px">
      <button class="btn" id="applyFilters">Aplicar</button>
      <button class="btn ghost" id="clearFilters">Limpar</button>
    </div>

    <!-- Mini gr√°fico -->
    <div class="chart" id="chartBox">
      <h4>Angaria√ß√µes por consultor</h4>
      <div id="chartRows"></div>
    </div>
  </aside>

  <!-- Board -->
  <section class="board" id="board"></section>
</div>

<!-- Modal Angaria√ß√£o -->
<div class="modal-backdrop" id="angModal">
  <div class="modal">
    <header>
      <div><strong id="modalTitle">Nova Angaria√ß√£o</strong></div>
      <div style="display:flex;gap:8px">
        <button class="btn" id="btnCancel">Cancelar</button>
        <button class="btn primary" id="btnSave">Guardar</button>
      </div>
    </header>
    <div class="content">
      <div class="form-grid2">
        <div class="form-field">
          <label>Im√≥vel *</label>
          <input id="a_imovel" placeholder="Ex.: T3 Boavista, Moradia F√¢nzeres">
        </div>
        <div class="form-field">
          <label>Consultor *</label>
          <select id="a_consultor">
            <option value="">‚Äî</option>
            <option>Rui Quelhas</option>
            <option>Manuel Oliveira</option>
            <option>Jo√£o Sousa</option>
            <option>Francisco dos Santos</option>
            <option>Ros√°rio Vasconcelos</option>
            <option>Armanda Meireles</option>
            <option>Audrey Lucas</option>
          </select>
        </div>

        <div class="form-field">
          <label>Propriet√°rio *</label>
          <input id="a_proprietario" placeholder="Nome do propriet√°rio">
        </div>
        <div class="form-field">
          <label>Contacto propriet√°rio</label>
          <input id="a_contacto" placeholder="+351 ‚Ä¶">
        </div>

        <div class="form-field">
          <label>Data</label>
          <input id="a_data" type="date">
        </div>
        <div class="form-field">
          <label>Ref. Interna</label>
          <input id="a_ref">
        </div>

        <div class="form-field">
          <label>Pre√ßo pedido (‚Ç¨)</label>
          <input id="a_preco_pedido" type="number" min="0" step="1000">
        </div>
        <div class="form-field">
          <label>Pre√ßo sugerido (‚Ç¨)</label>
          <input id="a_preco_sugerido" type="number" min="0" step="1000">
        </div>

        <div class="form-field">
          <label>Comiss√£o</label>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px">
            <select id="a_comissao">
              <option value="">‚Äî</option>
              <option value="6">6%</option>
              <option value="5">5%</option>
              <option value="4">4%</option>
              <option value="3">3%</option>
              <option value="outro">Outro</option>
            </select>
            <input id="a_comissao_outro" placeholder="Ex.: 4.5%" style="display:none">
          </div>
        </div>
        <div class="form-field">
          <label>% Ajustamento (dif. pedido vs sugerido)</label>
          <input id="a_ajustamento" type="number" step="0.1" placeholder="Ex.: -8">
        </div>

        <div class="form-field">
          <label>Origem</label>
          <select id="a_origem">
            <option value="">‚Äî</option>
            <option>Prospec√ß√£o ativa</option>
            <option>Recomenda√ß√£o</option>
            <option>Portal</option>
            <option>Walk-in</option>
            <option>Lead digital</option>
          </select>
        </div>
        <div class="form-field">
          <label>Estado</label>
          <select id="a_estado">
            <option>Novo</option>
            <option>Em Negocia√ß√£o</option>
            <option>Aprovado</option>
            <option>Perdido</option>
          </select>
        </div>

        <div class="form-field">
          <label>Notas internas</label>
          <textarea id="a_notas" rows="3"></textarea>
        </div>
      </div>

      <div class="form-field" style="margin-top:10px">
        <label>Documenta√ß√£o</label>
        <div class="docs-grid">
          <label><input type="checkbox" id="d_cc"> CC</label>
          <label><input type="checkbox" id="d_crp"> CRP</label>
          <label><input type="checkbox" id="d_caderneta"> Caderneta</label>
          <label><input type="checkbox" id="d_cmi"> CMI assinado</label>
          <label><input type="checkbox" id="d_cert_energetico"> Cert. Energ√©tico</label>
          <label><input type="checkbox" id="d_planta"> Plantas</label>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* ===== Estado global ===== */
const LS_KEY = 'gpp_angaria√ß√µes_v1';
const EDIT_KEY = 'gpp_ang_edit_mode';
const COLS = ["Novo","Em Negocia√ß√£o","Aprovado","Perdido"];
const CONSULT = [
  "Rui Quelhas",
  "Manuel Oliveira",
  "Jo√£o Sousa",
  "Francisco dos Santos",
  "Ros√°rio Vasconcelos",
  "Armanda Meireles",
  "Audrey Lucas"
];

let ANG = [];
let FILTER = {
  q:'',
  consultor:'',
  estado:'',
  ini:'',
  fim:'',
  ajMin:'',
  ajMax:'',
  showHidden:false,
  onlyHidden:false
};
let EDIT_MODE = false;
let EDIT_ID = null;

const $ = id => document.getElementById(id);
const norm = s => String(s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');

/* ===== Storage helpers ===== */
function loadLS(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    return raw? JSON.parse(raw):[];
  }catch{return [];}
}
function saveLS(){
  localStorage.setItem(LS_KEY, JSON.stringify(ANG));
}

/* ===== Edit mode lock ===== */
function applyEditUI(){
  const btnNew = $('btnNew');
  const toggle = $('toggleEdit');

  if(EDIT_MODE){
    toggle.classList.add('primary');
    toggle.textContent = 'üîì Edi√ß√£o ativa';
    btnNew.disabled = false;
  } else {
    toggle.classList.remove('primary');
    toggle.textContent = 'üîí Edi√ß√£o bloqueada';
    btnNew.disabled = true;
  }
}
function setEditMode(on){
  EDIT_MODE = !!on;
  localStorage.setItem(EDIT_KEY, EDIT_MODE?'1':'0');
  applyEditUI();
  renderBoard(); // recria bot√µes disabled/enabled
}

/* ===== Filtros ===== */
function loadFilters(){
  // preencher consultores
  const sel = $('f_consultor');
  sel.innerHTML = '<option value="">(Todos)</option>'+CONSULT.map(c=>`<option>${c}</option>`).join('');
}
function applyFilterStateFromUI(){
  FILTER.q = $('f_q').value.trim();
  FILTER.consultor = $('f_consultor').value;
  FILTER.estado = $('f_estado').value;
  FILTER.ini = $('f_ini').value;
  FILTER.fim = $('f_fim').value;
  FILTER.ajMin = $('f_aj_min').value;
  FILTER.ajMax = $('f_aj_max').value;
  FILTER.showHidden = $('f_show_hidden').checked;
  FILTER.onlyHidden = $('f_only_hidden').checked;
}
function clearFilterUI(){
  $('f_q').value = '';
  $('f_consultor').value = '';
  $('f_estado').value = '';
  $('f_ini').value = '';
  $('f_fim').value = '';
  $('f_aj_min').value = '';
  $('f_aj_max').value = '';
  $('f_show_hidden').checked = false;
  $('f_only_hidden').checked = false;
  FILTER = {q:'',consultor:'',estado:'',ini:'',fim:'',ajMin:'',ajMax:'',showHidden:false,onlyHidden:false};
}

$('applyFilters').addEventListener('click',()=>{
  applyFilterStateFromUI();
  renderBoard();
});
$('clearFilters').addEventListener('click',()=>{
  clearFilterUI();
  renderBoard();
});
let qTimer=null;
$('f_q').addEventListener('input',()=>{
  clearTimeout(qTimer);
  qTimer = setTimeout(()=>{ applyFilterStateFromUI(); renderBoard(); },200);
});

/* ===== Modal ===== */
function openModal(edit=null){
  if(!EDIT_MODE){
    alert('Modo de edi√ß√£o bloqueado. Clique em "üîì Edi√ß√£o ativa" para criar ou editar angaria√ß√µes.');
    return;
  }
  EDIT_ID = edit? edit.id : null;
  $('modalTitle').textContent = edit? 'Editar Angaria√ß√£o' : 'Nova Angaria√ß√£o';

  const set = (id,val='') => $(id).value = (val ?? '');

  const a = edit || {};
  set('a_imovel', a.imovel);
  set('a_consultor', a.consultor);
  set('a_proprietario', a.proprietario);
  set('a_contacto', a.contacto);
  set('a_data', a.data || new Date().toISOString().slice(0,10));
  set('a_ref', a.ref || '');
  set('a_preco_pedido', a.preco_pedido || '');
  set('a_preco_sugerido', a.preco_sugerido || '');
  // comiss√£o
  if(a.comissao_pct && ['6','5','4','3'].includes(String(a.comissao_pct))){
    $('a_comissao').value = String(a.comissao_pct);
    $('a_comissao_outro').style.display='none';
    $('a_comissao_outro').value='';
  } else if(a.comissao_pct){
    $('a_comissao').value = 'outro';
    $('a_comissao_outro').style.display='block';
    $('a_comissao_outro').value = a.comissao_pct+'%';
  } else {
    $('a_comissao').value = '';
    $('a_comissao_outro').style.display='none';
    $('a_comissao_outro').value='';
  }
  set('a_ajustamento', a.ajustamento || '');
  set('a_origem', a.origem || '');
  set('a_estado', a.estado || 'Novo');
  set('a_notas', a.notas || '');

  $('d_cc').checked = !!a.d_cc;
  $('d_crp').checked = !!a.d_crp;
  $('d_caderneta').checked = !!a.d_caderneta;
  $('d_cmi').checked = !!a.d_cmi;
  $('d_cert_energetico').checked = !!a.d_cert_energetico;
  $('d_planta').checked = !!a.d_planta;

  $('angModal').classList.add('show');
}
$('btnCancel').addEventListener('click',()=> $('angModal').classList.remove('show'));
$('btnNew').addEventListener('click',()=> openModal(null));
$('a_comissao').addEventListener('change', e=>{
  if(e.target.value === 'outro'){
    $('a_comissao_outro').style.display='block';
  } else {
    $('a_comissao_outro').style.display='none';
    $('a_comissao_outro').value='';
  }
});

$('btnSave').addEventListener('click',()=>{
  if(!EDIT_MODE){
    alert('Modo de edi√ß√£o bloqueado. Clique em "üîì Edi√ß√£o ativa" para guardar altera√ß√µes.');
    return;
  }

  const get = id => $(id).value.trim();
  const imovel = get('a_imovel');
  const consultor = get('a_consultor');
  const proprietario = get('a_proprietario');

  if(!imovel){ alert('Indique o im√≥vel.'); return; }
  if(!consultor){ alert('Selecione o consultor.'); return; }
  if(!proprietario){ alert('Indique o propriet√°rio.'); return; }

  const preco_pedido = get('a_preco_pedido');
  const preco_sugerido = get('a_preco_sugerido');
  let ajust = get('a_ajustamento');

  if(preco_pedido && preco_sugerido && !ajust){
    const pp = Number(preco_pedido);
    const ps = Number(preco_sugerido);
    if(pp>0 && ps>0){
      ajust = (((ps-pp)/pp)*100).toFixed(1);
    }
  }

  let comissao_pct = '';
  const comSel = get('a_comissao');
  if(comSel === 'outro'){
    const raw = get('a_comissao_outro').replace('%','').replace(',','.');
    const n = Number(raw);
    if(Number.isFinite(n)) comissao_pct = n;
  } else if(comSel){
    comissao_pct = Number(comSel);
  }

  const rec = {
    id: EDIT_ID || ('A'+Math.random().toString(36).slice(2,9)+Date.now().toString(36).slice(-4)),
    imovel,
    consultor,
    proprietario,
    contacto: get('a_contacto'),
    data: get('a_data'),
    ref: get('a_ref'),
    preco_pedido,
    preco_sugerido,
    comissao_pct,
    ajustamento: ajust,
    origem: get('a_origem'),
    estado: get('a_estado') || 'Novo',
    notas: get('a_notas'),
    d_cc: $('d_cc').checked,
    d_crp: $('d_crp').checked,
    d_caderneta: $('d_caderneta').checked,
    d_cmi: $('d_cmi').checked,
    d_cert_energetico: $('d_cert_energetico').checked,
    d_planta: $('d_planta').checked,
    visivel: true
  };

  const idx = ANG.findIndex(a=>a.id===rec.id);
  if(idx>=0) ANG[idx] = Object.assign(ANG[idx], rec);
  else ANG.push(rec);

  saveLS();
  $('angModal').classList.remove('show');
  EDIT_ID = null;
  renderBoard();
});

/* ===== Renderiza√ß√£o ===== */
function fmtDate(d){
  if(!d) return '‚Äî';
  try{ return new Date(d).toLocaleDateString('pt-PT'); }catch{return d;}
}
function fmtNum(v){
  if(!v) return '‚Äî';
  const n=Number(v);
  if(!Number.isFinite(n)) return v;
  return n.toLocaleString('pt-PT');
}
function fmtPct(v){
  if(v===undefined || v===null || v==='') return '‚Äî';
  const n=Number(v);
  if(!Number.isFinite(n)) return v;
  return n.toFixed(1)+'%';
}

function filterDataset(){
  let out = [...ANG];
  const t = norm(FILTER.q||'');

  if(t){
    out = out.filter(a=>{
      const blob = [
        a.imovel,a.proprietario,a.consultor,a.ref,a.notas
      ].map(norm).join(' ');
      return blob.includes(t);
    });
  }
  if(FILTER.consultor) out = out.filter(a=>a.consultor===FILTER.consultor);
  if(FILTER.estado) out = out.filter(a=>a.estado===FILTER.estado);
  if(FILTER.ini) out = out.filter(a=>!a.data || a.data>=FILTER.ini);
  if(FILTER.fim) out = out.filter(a=>!a.data || a.data<=FILTER.fim);
  if(FILTER.ajMin){
    const m = Number(FILTER.ajMin);
    out = out.filter(a=>a.ajustamento==='' || a.ajustamento===undefined || Number(a.ajustamento)>=m);
  }
  if(FILTER.ajMax){
    const M = Number(FILTER.ajMax);
    out = out.filter(a=>a.ajustamento==='' || a.ajustamento===undefined || Number(a.ajustamento)<=M);
  }
  if(FILTER.onlyHidden) out = out.filter(a=>a.visivel===false);
  if(!FILTER.showHidden && !FILTER.onlyHidden) out = out.filter(a=>a.visivel!==false);
  return out;
}

function renderKpi(filtered){
  const el = $('kpiBar');
  if(!filtered.length){
    el.textContent = 'Sem angaria√ß√µes nos filtros atuais.';
    return;
  }
  const total = filtered.length;
  const aprov = filtered.filter(a=>a.estado==='Aprovado').length;
  const perdido = filtered.filter(a=>a.estado==='Perdido').length;
  const somaPedido = filtered.reduce((s,a)=>s+(Number(a.preco_pedido)||0),0);
  const somaSugerido = filtered.reduce((s,a)=>s+(Number(a.preco_sugerido)||0),0);
  const mediaAj = (()=>{
    const arr = filtered.map(a=>Number(a.ajustamento)).filter(Number.isFinite);
    if(!arr.length) return '‚Äî';
    const m = arr.reduce((s,x)=>s+x,0)/arr.length;
    return m.toFixed(1)+'%';
  })();

  el.innerHTML = `
    <span class="kpi-badge">Total: ${total}</span>
    <span class="kpi-badge">Aprovadas: ${aprov}</span>
    <span class="kpi-badge">Perdidas: ${perdido}</span>
    <span class="kpi-badge">Volume pedido: ${somaPedido.toLocaleString('pt-PT')} ‚Ç¨</span>
    <span class="kpi-badge">Volume sugerido: ${somaSugerido.toLocaleString('pt-PT')} ‚Ç¨</span>
    <span class="kpi-badge highlight">M√©dia ajustamento: ${mediaAj}</span>
  `;
}

function renderChart(filtered){
  const box = $('chartRows');
  box.innerHTML = '';
  if(!filtered.length) return;
  const map = {};
  filtered.forEach(a=>{
    if(!a.consultor) return;
    map[a.consultor] = (map[a.consultor] || 0) + 1;
  });
  const entries = Object.entries(map).sort((a,b)=>b[1]-a[1]);
  if(!entries.length) return;
  const max = entries[0][1];

  entries.forEach(([name,val])=>{
    const row = document.createElement('div');
    row.className = 'chart-row';
    row.innerHTML = `
      <div class="chart-label">${name}</div>
      <div class="chart-bar-wrap">
        <div class="chart-bar" style="width:${(val/max*100).toFixed(0)}%"></div>
      </div>
      <div style="font-size:11px;color:#ccc">${val}</div>
    `;
    box.appendChild(row);
  });
}

function renderBoard(){
  const board = $('board');
  board.innerHTML = '';

  const filtered = filterDataset();
  renderKpi(filtered);
  renderChart(filtered);

  const byState = COLS.map(col=>({
    estado: col,
    items: filtered.filter(a=>a.estado===col)
  }));

  byState.forEach(col=>{
    const cEl = document.createElement('div');
    cEl.className='col';
    cEl.innerHTML = `
      <header>
        <span class="title">${col.estado}</span>
        <span class="counter">${col.items.length}</span>
      </header>
      <div class="list" id="list_${col.estado.replace(/\s/g,'_')}"></div>
    `;
    board.appendChild(cEl);

    const listEl = cEl.querySelector('.list');
    col.items.forEach(a=>{
      const card = document.createElement('div');
      card.className = 'card';
      const docsOk = (a.d_cc && a.d_crp && a.d_caderneta && a.d_cmi) ? 'Completa' : 'Incompleta';
      const badgeDocs = docsOk==='Completa' ? '<span class="badge green">Doc. completa</span>' : '<span class="badge yellow">Doc. incompleta</span>';
      let badgeAj='';
      if(a.ajustamento!=='' && a.ajustamento!==undefined){
        const n = Number(a.ajustamento);
        if(Number.isFinite(n)){
          if(n<=-10) badgeAj = '<span class="badge green">'+fmtPct(n)+'</span>';
          else if(n<0) badgeAj = '<span class="badge yellow">'+fmtPct(n)+'</span>';
          else badgeAj = '<span class="badge red">'+fmtPct(n)+'</span>';
        }
      }

      const disabledAttr = EDIT_MODE ? '' : 'disabled';

      card.innerHTML = `
        <div class="top">
          <div>
            <div class="name">${a.imovel||'‚Äî'}</div>
            <div class="meta">${a.consultor||'‚Äî'} ${a.ref? '¬∑ '+a.ref:''}</div>
          </div>
          <div>${badgeAj}</div>
        </div>
        <div class="row"><b>Propriet√°rio:</b> ${a.proprietario||'‚Äî'}</div>
        <div class="row"><b>Data:</b> ${fmtDate(a.data)}</div>
        <div class="row">
          <b>Pre√ßo pedido:</b> ${fmtNum(a.preco_pedido)} ‚Ç¨
          &nbsp;¬∑&nbsp;
          <b>Sugerido:</b> ${fmtNum(a.preco_sugerido)} ‚Ç¨
        </div>
        <div class="row">
          <b>Comiss√£o:</b> ${a.comissao_pct? a.comissao_pct+'%' : '‚Äî'}
          &nbsp;¬∑&nbsp;
          <b>Origem:</b> ${a.origem||'‚Äî'}
        </div>
        <div class="row">${badgeDocs}</div>
        ${a.notas? `<div class="row"><small>${a.notas}</small></div>`:''}
        <div class="row"><small>${[
          a.d_cc?'CC':'',
          a.d_crp?'CRP':'',
          a.d_caderneta?'Caderneta':'',
          a.d_cmi?'CMI assinado':'',
          a.d_cert_energetico?'Cert. Energ√©tico':'',
          a.d_planta?'Plantas':''
        ].filter(Boolean).join(' ¬∑ ')}</small></div>
        <div class="actions">
          <button class="btn-sm" data-act="edit" ${disabledAttr}>Editar</button>
          <button class="btn-sm" data-act="prop" ${disabledAttr}>Proposta Angaria√ß√£o</button>
          <select class="select-move" data-id="${a.id}" ${disabledAttr}>
            <option value="">Mover‚Ä¶</option>
            ${COLS.map(c=>`<option value="${c}" ${c===a.estado?'disabled':''}>${c}</option>`).join('')}
          </select>
          <button class="btn-sm danger" data-act="del" ${disabledAttr}>Apagar</button>
          <button class="btn-sm" data-act="toggle" ${disabledAttr}>${a.visivel===false?'Tornar vis√≠vel':'Tornar invis√≠vel'}</button>
        </div>
      `;
      if(a.visivel===false) card.style.opacity = .45;

      // eventos
      card.querySelector('[data-act="edit"]').addEventListener('click',()=>{
        if(!EDIT_MODE){ alert('Modo de edi√ß√£o bloqueado. Ative "üîì Edi√ß√£o ativa" para editar.'); return; }
        openModal(a);
      });
      card.querySelector('[data-act="prop"]').addEventListener('click',()=>{
        if(!EDIT_MODE){ alert('Modo de edi√ß√£o bloqueado. Ative "üîì Edi√ß√£o ativa" para gerar proposta.'); return; }
        gerarProposta(a);
      });
      card.querySelector('[data-act="del"]').addEventListener('click',()=>{
        if(!EDIT_MODE){ alert('Modo de edi√ß√£o bloqueado. Ative "üîì Edi√ß√£o ativa" para apagar.'); return; }
        if(!confirm('Eliminar esta angaria√ß√£o?')) return;
        ANG = ANG.filter(x=>x.id!==a.id);
        saveLS();
        renderBoard();
      });
      card.querySelector('[data-act="toggle"]').addEventListener('click',()=>{
        if(!EDIT_MODE){ alert('Modo de edi√ß√£o bloqueado. Ative "üîì Edi√ß√£o ativa" para alterar visibilidade.'); return; }
        a.visivel = a.visivel===false ? true : false;
        saveLS();
        renderBoard();
      });
      card.querySelector('.select-move').addEventListener('change',e=>{
        if(!EDIT_MODE){
          e.target.value='';
          alert('Modo de edi√ß√£o bloqueado. Ative "üîì Edi√ß√£o ativa" para mover.');
          return;
        }
        const destino = e.target.value;
        if(!destino || !COLS.includes(destino)) return;
        a.estado = destino;
        saveLS();
        renderBoard();
      });

      listEl.appendChild(card);
    });
  });
}

/* ===== Proposta Angaria√ß√£o (Word simples) ===== */
function gerarProposta(a){
  const texto = `
Proposta de Angaria√ß√£o

Im√≥vel: ${a.imovel||''}
Propriet√°rio: ${a.proprietario||''}
Consultor: ${a.consultor||''}
Refer√™ncia interna: ${a.ref||''}
Data: ${fmtDate(a.data)||''}

Pre√ßo pedido: ${fmtNum(a.preco_pedido)} ‚Ç¨
Pre√ßo sugerido: ${fmtNum(a.preco_sugerido)} ‚Ç¨
% Ajustamento: ${fmtPct(a.ajustamento)}

Comiss√£o: ${a.comissao_pct? a.comissao_pct+'%' : '‚Äî'}
Origem: ${a.origem||''}

Documenta√ß√£o:
  - CC: ${a.d_cc?'Sim':'N√£o'}
  - CRP: ${a.d_crp?'Sim':'N√£o'}
  - Caderneta: ${a.d_caderneta?'Sim':'N√£o'}
  - CMI assinado: ${a.d_cmi?'Sim':'N√£o'}
  - Cert. Energ√©tico: ${a.d_cert_energetico?'Sim':'N√£o'}
  - Plantas: ${a.d_planta?'Sim':'N√£o'}

Notas:
${a.notas||''}
`;
  const blob = new Blob([texto],{type:'application/msword'});
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = `Proposta_Angariacao_${(a.ref||a.imovel||'angariacao').replace(/\s+/g,'_')}.doc`;
  document.body.appendChild(link);
  link.click();
  link.remove();
  URL.revokeObjectURL(url);
}

/* ===== Exporta√ß√£o CSV ===== */
function exportCsv(){
  const rows = [];
  const headers = [
    "ID","Im√≥vel","Propriet√°rio","Consultor","Data","Ref","Estado",
    "Pre√ßoPedido","Pre√ßoSugerido","Comiss√£o(%)","Ajustamento(%)",
    "Origem","Vis√≠vel","Notas",
    "CC","CRP","Caderneta","CMI","CertEnerg√©tico","Plantas"
  ];
  rows.push(headers);

  const data = filterDataset();
  data.forEach(a=>{
    rows.push([
      a.id,
      a.imovel||'',
      a.proprietario||'',
      a.consultor||'',
      a.data||'',
      a.ref||'',
      a.estado||'',
      a.preco_pedido||'',
      a.preco_sugerido||'',
      (a.comissao_pct!==undefined && a.comissao_pct!==''? a.comissao_pct:''),
      (a.ajustamento!==undefined && a.ajustamento!==''? a.ajustamento:''),
      a.origem||'',
      (a.visivel===false?'N√£o':'Sim'),
      (a.notas||'').replace(/\r?\n/g,' '),
      a.d_cc?'Sim':'N√£o',
      a.d_crp?'Sim':'N√£o',
      a.d_caderneta?'Sim':'N√£o',
      a.d_cmi?'Sim':'N√£o',
      a.d_cert_energetico?'Sim':'N√£o',
      a.d_planta?'Sim':'N√£o'
    ]);
  });

  const csv = rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const aEl = document.createElement('a');
  aEl.href = url;
  aEl.download = 'angariacoes.csv';
  document.body.appendChild(aEl);
  aEl.click();
  aEl.remove();
  URL.revokeObjectURL(url);
}

/* ===== Init ===== */
(function init(){
  ANG = loadLS();
  loadFilters();

  // estado do lock
  const stored = localStorage.getItem(EDIT_KEY);
  EDIT_MODE = stored==='1';
  applyEditUI();

  $('toggleEdit').addEventListener('click',()=>{
    setEditMode(!EDIT_MODE);
  });

  $('exportCsv').addEventListener('click', exportCsv);

  renderBoard();
})();
</script>
</body>
</html>
