<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<title>Garvetur Porto Pro — Angariações</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<style>
  :root{--gold:#A38B63;--bg:#0E0E0E;--panel:#131313;--text:#fff;--muted:#bdbdbd;}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;}
  header{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.1);background:#0F0F0F;}
  nav a{margin-right:6px;text-decoration:none;color:#ddd;border:1px solid rgba(255,255,255,.12);padding:6px 10px;border-radius:8px;}
  nav a.active{background:var(--gold);color:#111;border-color:var(--gold);font-weight:600;}
  .actions{display:flex;gap:8px;}
  .btn{background:transparent;border:1px solid rgba(163,139,99,.5);color:#fff;padding:6px 9px;border-radius:8px;cursor:pointer;font-size:12px;}
  .wrap{display:grid;grid-template-columns:380px 1fr;gap:12px;padding:12px;}
  .panel{background:var(--panel);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px;}
  .panel h3{margin:0 0 8px 0;font-size:13px;color:#eaeaea;border-bottom:1px solid rgba(255,255,255,.06);padding-bottom:6px;}
  label{font-size:12px;color:#ddd;display:block;margin:7px 0 2px;}
  input,select,textarea{width:100%;background:#0E0E0E;color:#fff;border:1px solid rgba(255,255,255,.18);border-radius:8px;padding:8px 10px;}
  .filters{display:grid;grid-template-columns:200px 160px 160px 200px auto; gap:8px; align-items:end; padding:0 12px 12px 12px;}
  .list{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;}
  .card{background:#0E0E0E;border:1px solid rgba(255,255,255,.1);border-radius:10px;padding:8px;}
  .t{font-weight:600;margin-bottom:4px;}
  .m{font-size:12px;color:#cfcfcf;}
  .chk{display:flex;gap:10px;flex-wrap:wrap;margin-top:6px;}
  .chk label{display:flex;gap:6px;align-items:center;background:#0E0E0E;border:1px solid rgba(255,255,255,.18);padding:6px 8px;border-radius:8px;}
  .semaforo{display:inline-block;width:10px;height:10px;border-radius:50%;margin-left:8px;background:#888;}
  .muted{color:#c9c9c9;font-size:12px}
  @media(max-width:1200px){.list{grid-template-columns:repeat(2,1fr)}}
  @media(max-width:900px){.wrap{grid-template-columns:1fr}.filters{grid-template-columns:1fr 1fr;}}
</style>
</head>
<body>
<header>
  <div style="display:flex;align-items:center;gap:10px;">
    <strong style="color:#FFD166">Garvetur Porto Pro</strong>
    <nav>
      <a href="./index.html">Mapa</a>
      <a href="./kanban.html">Leads</a>
      <a class="active" href="./angariacoes.html">Angariações</a>
      <a href="./dashboard.html">Dashboard</a>
    </nav>
  </div>
  <div class="actions">
    <button id="seed" class="btn">Carregar dados de exemplo (5)</button>
    <button id="clear" class="btn">Limpar tudo</button>
  </div>
</header>

<div class="wrap">
  <div class="panel">
    <h3>Nova Angariação</h3>
    <label>Propriedade</label><input id="p" placeholder="Ex.: T3 Boavista | Porto">

    <!-- Fallback HTML: a lista aparece mesmo que o JS não carregue -->
    <label>Consultor</label>
    <select id="c">
      <option>Rui Quelhas</option>
      <option>Manuel Oliveira</option>
      <option>João Sousa</option>
      <option>Francisco dos Santos</option>
      <option>Rosário Vasconcelos</option>
      <option>Armanda Meireles</option>
      <option>Audrey Lucas</option>
      <option>Outro…</option>
    </select>

    <label>Proprietário</label><input id="propNome" placeholder="Ex.: Sr. António Silva">
    <label>Data</label><input id="dataAng" type="date">
    <label>Origem</label><input id="o" placeholder="Ex.: Referral / Porta-a-porta / Online">

    <label>Comissão</label>
    <select id="com">
      <option value="6">6%</option>
      <option value="5">5%</option>
      <option value="4">4%</option>
      <option value="3">3%</option>
    </select>

    <label>Preço pedido (€)</label><input id="pp" type="number" step="0.01" placeholder="Ex.: 650000">
    <label>Preço sugerido (€)</label><input id="ps" type="number" step="0.01" placeholder="Ex.: 620000">
    <div style="margin-top:8px;font-size:12px;">% Ajustamento: <span id="aj">—</span> <span class="semaforo" id="sf"></span></div>

    <div class="chk">
      <label><input type="checkbox" id="doc_cc"> CC</label>
      <label><input type="checkbox" id="doc_caderneta"> Caderneta</label>
      <label><input type="checkbox" id="doc_cert_ener"> Cert. Energético</label>
      <label><input type="checkbox" id="doc_planta"> Planta</label>
      <label><input type="checkbox" id="doc_cmi"> CMI assinado</label>
      <label><input type="checkbox" id="doc_crp"> CRP</label>
    </div>

    <label>Notas</label><textarea id="n" rows="3" placeholder="Observações relevantes"></textarea>
    <div style="margin-top:8px;display:flex;gap:8px;">
      <button class="btn" id="add">Guardar angariação</button>
    </div>
  </div>

  <div class="panel">
    <h3>Lista</h3>

    <!-- Filtros e ordenação -->
    <div class="filters">
      <div>
        <label>Consultor</label>
        <select id="f_consultor"><option value="">(todos)</option></select>
      </div>
      <div>
        <label>Data — De</label>
        <input type="date" id="f_de">
      </div>
      <div>
        <label>Data — Até</label>
        <input type="date" id="f_ate">
      </div>
      <div>
        <label>Ordenar por</label>
        <select id="f_sort">
          <option value="data_desc">Data (mais recente)</option>
          <option value="data_asc">Data (mais antiga)</option>
          <option value="aj_desc">% Ajustamento (↓)</option>
          <option value="aj_asc">% Ajustamento (↑)</option>
        </select>
      </div>
      <div style="display:flex;gap:8px;">
        <button class="btn" id="f_apply">Aplicar</button>
        <button class="btn" id="f_clear">Limpar filtros</button>
      </div>
    </div>

    <div class="list" id="list"></div>
    <div class="muted" id="resumo" style="padding:8px 12px 0 12px;">—</div>
  </div>
</div>

<script>
/* =========================
   CONFIG / STORAGE
========================= */
const LS_KEY = 'gpp_ang_v4'; // mantém versão
const CONSULTORS = [
  "Rui Quelhas",
  "Manuel Oliveira",
  "João Sousa",
  "Francisco dos Santos",
  "Rosário Vasconcelos",
  "Armanda Meireles",
  "Audrey Lucas",
  "Outro…"
];

function load(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||'[]'); }catch(e){ return []; } }
function save(d){ localStorage.setItem(LS_KEY, JSON.stringify(d)); }

/* =========================
   HELPERS
========================= */
function pct(pp,ps){ if(!pp||!ps) return null; const v=(ps-pp)/pp*100; return Math.round(v*10)/10; }
function semaforo(el, val){
  let c='#888';
  if(val!=null){
    if(val>=-3 && val<=3) c='#22c55e';
    else if(val>-7) c='#f59e0b';
    else c='#ef4444';
  }
  el.style.background=c;
}
function parseDate(s){ if(!s) return null; const t=Date.parse(s); return Number.isFinite(t)? new Date(t): null; }
function fmtDate(s){ const d=parseDate(s); if(!d) return '—'; return d.toISOString().slice(0,10); }
function sanitizeFile(s){ return String(s||'proposta').replace(/[^a-z0-9\-_. ]/gi,'_'); }

/* =========================
   UI BASE (consultores)
========================= */
// Preenche o <select id="c"> apenas se estiver vazio (respeita fallback HTML)
function fillConsultorSelects(){
  const sel = document.getElementById('c');
  if (sel && sel.options.length === 0) {
    sel.innerHTML = CONSULTORS.map(n=>`<option value="${n}">${n}</option>`).join('');
  }
  populateConsultoresFilter();
}

/* =========================
   RENDER LISTA / CARDS
========================= */
function cardEl(a, idx){
  const d = document.createElement('div');
  d.className='card';
  d.innerHTML = `
    <div class="t">${a.prop}</div>
    <div class="m">${a.consultor || ''} · ${a.origem || ''}</div>
    <div class="m">Proprietário: ${a.proprietario || '—'} · Data: ${fmtDate(a.data)}</div>
    <div class="m">Comissão: ${a.comissao!=null ? a.comissao+'%' : '—'}</div>
    <div class="m">Pedido: ${a.pp||'-'}€ · Sugerido: ${a.ps||'-'}€ · Ajuste: ${a.aj!=null?a.aj+'%':'—'}</div>
    <div class="m">Docs: ${a.docs?.join(', ')||'—'}</div>
    ${a.notas? `<div class="m"><em>${a.notas}</em></div>`:''}
    <div style="margin-top:6px;display:flex;gap:6px;flex-wrap:wrap">
      <button class="btn" data-a="edit">Editar</button>
      <button class="btn" data-a="del">Remover</button>
      <button class="btn" data-a="pdf">Proposta (PDF)</button>
      <button class="btn" data-a="doc">Proposta (Word)</button>
    </div>`;
  d.querySelector('[data-a="edit"]').onclick=()=> edit(idx);
  d.querySelector('[data-a="del"]').onclick=()=> del(idx);
  d.querySelector('[data-a="pdf"]').onclick=()=> exportPDF(load()[idx]);
  d.querySelector('[data-a="doc"]').onclick=()=> exportWord(load()[idx]);
  return d;
}

function render(list=null){
  const data = (list ?? view());
  const listEl = document.getElementById('list');
  listEl.innerHTML='';
  data.forEach((a,i)=> listEl.appendChild(cardEl(a,i)));

  // Resumo
  const total = data.length;
  const mediaAj = (()=>{
    const vals = data.map(x=>x.aj).filter(v=>v!=null);
    if(!vals.length) return '—';
    const m = Math.round(vals.reduce((s,v)=>s+v,0)/vals.length*10)/10;
    return m+'%';
  })();
  document.getElementById('resumo').textContent = `Total: ${total} · Média de ajustamento: ${mediaAj}`;
}

/* =========================
   CRUD
========================= */
function collectDocs(){
  const docs = [];
  if(document.getElementById('doc_cc').checked) docs.push('CC');
  if(document.getElementById('doc_caderneta').checked) docs.push('Caderneta');
  if(document.getElementById('doc_cert_ener').checked) docs.push('Cert. Energético');
  if(document.getElementById('doc_planta').checked) docs.push('Planta');
  if(document.getElementById('doc_cmi').checked) docs.push('CMI assinado');
  if(document.getElementById('doc_crp').checked) docs.push('CRP');
  return docs;
}

function add(){
  const prop = document.getElementById('p').value.trim();
  if(!prop) return alert('Indique a propriedade.');

  let consultor = document.getElementById('c').value;
  if(consultor === 'Outro…'){
    const alt = prompt('Nome do consultor:','');
    if(!alt) return alert('Indique o nome do consultor.');
    consultor = alt.trim();
  }

  const proprietario = document.getElementById('propNome').value.trim();
  const data = document.getElementById('dataAng').value;
  const origem = document.getElementById('o').value.trim();
  const comissao = Number(document.getElementById('com').value);
  const pp = Number(document.getElementById('pp').value) || null;
  const ps = Number(document.getElementById('ps').value) || null;
  const aj = pct(pp, ps);
  const docs = collectDocs();
  const notas = document.getElementById('n').value.trim();

  const arr = load();
  arr.unshift({prop, consultor, proprietario, data, origem, comissao, pp, ps, aj, docs, notas});
  save(arr);
  populateConsultoresFilter();
  clearForm();
  render();
}

function clearForm(){
  ['p','propNome','o','pp','ps','n','dataAng'].forEach(id=> document.getElementById(id).value='');
  document.getElementById('c').value = CONSULTORS[0];
  ['doc_cc','doc_caderneta','doc_cert_ener','doc_planta','doc_cmi','doc_crp'].forEach(id=> document.getElementById(id).checked=false);
  document.getElementById('com').value='6';
  document.getElementById('aj').textContent='—'; semaforo(document.getElementById('sf'), null);
}

function edit(idx){
  const dataAll = load(); const a = dataAll[idx];
  const prop = prompt('Propriedade:', a.prop)||a.prop;
  let consultor = prompt('Consultor:', a.consultor||'') ?? a.consultor;
  if(!consultor) consultor = a.consultor;

  const proprietario = prompt('Proprietário:', a.proprietario||'')??a.proprietario;
  const data = prompt('Data (AAAA-MM-DD):', a.data||'')??a.data;
  const origem = prompt('Origem:', a.origem||'')??a.origem;
  const comissao = Number(prompt('Comissão (%):', a.comissao ?? '6')) || a.comissao || 6;
  const pp = Number(prompt('Preço pedido (€):', a.pp ?? '')) || null;
  const ps = Number(prompt('Preço sugerido (€):', a.ps ?? '')) || null;
  const aj = pct(pp, ps);
  const notas = prompt('Notas:', a.notas||'')??a.notas;
  dataAll[idx] = {prop, consultor, proprietario, data, origem, comissao, pp, ps, aj, docs:a.docs||[], notas};
  save(dataAll);
  populateConsultoresFilter();
  render();
}

function del(idx){
  if(!confirm('Remover esta angariação?')) return;
  const arr = load();
  arr.splice(idx,1);
  save(arr);
  populateConsultoresFilter();
  render();
}

/* =========================
   FILTROS / ORDENAÇÃO
========================= */
const f_consultor = document.getElementById('f_consultor');
const f_de = document.getElementById('f_de');
const f_ate = document.getElementById('f_ate');
const f_sort = document.getElementById('f_sort');

function populateConsultoresFilter(){
  const data = load();
  const set = new Set([
    ...CONSULTORS.filter(n=>n!=='Outro…'),
    ...data.map(x=>x.consultor).filter(Boolean)
  ]);
  const vals = Array.from(set).sort((a,b)=>a.localeCompare(b,'pt'));
  const cur = f_consultor.value;
  f_consultor.innerHTML = '<option value="">(todos)</option>' + vals.map(v=>`<option value="${v}">${v}</option>`).join('');
  if(vals.includes(cur)) f_consultor.value = cur;
}

function view(){
  const data = load().slice();

  // filtro consultor
  let out = data.filter(x=> !f_consultor.value || x.consultor === f_consultor.value);

  // filtro datas
  const d1 = parseDate(f_de.value), d2 = parseDate(f_ate.value);
  if(d1) out = out.filter(x=> { const dx=parseDate(x.data); return dx ? dx>=d1 : false; });
  if(d2) out = out.filter(x=> { const dx=parseDate(x.data); return dx ? dx<=d2 : false; });

  // ordenação
  const sort = f_sort.value;
  out.sort((a,b)=>{
    if(sort==='aj_desc'){ const A=(a.aj==null?-Infinity:a.aj), B=(b.aj==null?-Infinity:b.aj); return B-A; }
    if(sort==='aj_asc'){  const A=(a.aj==null? Infinity:a.aj), B=(b.aj==null? Infinity:b.aj); return A-B; }
    if(sort==='data_asc'){const A=parseDate(a.data)?.getTime()??0, B=parseDate(b.data)?.getTime()??0; return A-B; }
    const A=parseDate(a.data)?.getTime()??0, B=parseDate(b.data)?.getTime()??0; return B-A; // data_desc
  });

  return out;
}

/* =========================
   EXPORTAÇÕES
========================= */
function buildProposalHTML(a){
  const css = `
    <style>
      body{font-family:Arial,Helvetica,sans-serif;color:#111;margin:28px;}
      h1{font-size:20px;margin:0 0 12px 0;color:#333;}
      .brand{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;padding-bottom:10px;border-bottom:2px solid #A38B63;}
      .brand .name{font-weight:700;color:#A38B63;font-size:18px;}
      table{width:100%;border-collapse:collapse;margin-top:10px;}
      th,td{padding:8px;border:1px solid #ddd;font-size:13px;text-align:left;}
      th{background:#f6f6f6;}
      .muted{color:#555}
      .foot{margin-top:18px;font-size:12px;color:#666;}
      @media print { .no-print{display:none} }
    </style>`;
  const docs = (a.docs&&a.docs.length)? a.docs.join(', ') : '—';
  const aj   = (a.aj!=null? (a.aj+'%') : '—');
  const data = a.data ? fmtDate(a.data) : '—';

  return `<!DOCTYPE html><html><head><meta charset="utf-8">${css}<title>Proposta de Angariação</title></head>
  <body>
    <div class="brand">
      <div class="name">Garvetur Luxury Porto</div>
      <div class="muted">Proposta de Angariação</div>
    </div>
    <h1>${a.prop || '(Sem título)'}</h1>
    <table>
      <tr><th>Consultor</th><td>${a.consultor||'—'}</td><th>Origem</th><td>${a.origem||'—'}</td></tr>
      <tr><th>Proprietário</th><td>${a.proprietario||'—'}</td><th>Data</th><td>${data}</td></tr>
      <tr><th>Comissão</th><td>${a.comissao!=null? a.comissao+'%':'—'}</td><th>Documentação</th><td>${docs}</td></tr>
      <tr><th>Preço pedido</th><td>${a.pp!=null? a.pp+'€':'—'}</td><th>Preço sugerido</th><td>${a.ps!=null? a.ps+'€':'—'}</td></tr>
      <tr><th>% Ajustamento</th><td>${aj}</td><th>Notas</th><td>${a.notas||'—'}</td></tr>
    </table>
    <div class="foot">Gerado por Garvetur Porto Pro — ${new Date().toLocaleString('pt-PT')}</div>
  </body></html>`;
}

function exportPDF(a){
  const w = window.open('', '_blank');
  w.document.open();
  w.document.write(buildProposalHTML(a));
  w.document.close();
  w.onload = ()=> { try{ w.focus(); w.print(); }catch(e){} };
}

function exportWord(a){
  const html = buildProposalHTML(a);
  const blob = new Blob(['\ufeff', html], {type: 'application/msword'});
  const url = URL.createObjectURL(blob);
  const aEl = document.createElement('a');
  aEl.href = url;
  aEl.download = sanitizeFile((a.prop||'proposta')) + '.doc';
  document.body.appendChild(aEl);
  aEl.click();
  aEl.remove();
  URL.revokeObjectURL(url);
}

/* =========================
   SEED DEMO
========================= */
function seedDemo(){
  if(!confirm('Carregar 5 angariações de exemplo? (substitui as atuais)')) return;
  const ex = [
    {prop:"T3 Boavista | Porto", consultor:"Manuel Oliveira", proprietario:"António Silva", data:"2025-11-06", origem:"Referral", comissao:6, pp:650000, ps:620000, aj:-4.6, docs:["CC","Caderneta","Cert. Energético","CMI assinado"], notas:"Avaliação agendada"},
    {prop:"T2 Madalena | V.N. Gaia", consultor:"Armanda Meireles", proprietario:"Maria Lopes", data:"2025-11-01", origem:"Porta-a-porta", comissao:5, pp:320000, ps:315000, aj:-1.6, docs:["CC","Caderneta","CRP"], notas:"Vendedor disponível negociar"},
    {prop:"Loja Foz | Porto", consultor:"João Sousa", proprietario:"ImoFoz Lda.", data:"2025-10-28", origem:"Online", comissao:4, pp:480000, ps:450000, aj:-6.3, docs:["CC","Caderneta","Planta"], notas:"Objetivo yield 6%"},
    {prop:"Terreno Gondomar", consultor:"Rui Quelhas", proprietario:"Joaquim Rocha", data:"2025-11-03", origem:"Investidor", comissao:3, pp:900000, ps:870000, aj:-3.3, docs:["CC","CRP"], notas:"Pedido de CMI assinado"},
    {prop:"Prédio Baixa | Porto", consultor:"Audrey Lucas", proprietario:"Gestora Norte, SA", data:"2025-11-05", origem:"Gestor de ativos", comissao:5, pp:2200000, ps:2100000, aj:-4.5, docs:["CC","Caderneta","Cert. Energético","Planta","CMI assinado","CRP"], notas:"Visita técnica 5ª feira"}
  ];
  save(ex);
  populateConsultoresFilter();
  render();
}

/* =========================
   LIGAÇÕES UI
========================= */
document.getElementById('add').onclick=add;
document.getElementById('seed').onclick=seedDemo;
document.getElementById('clear').onclick=()=>{ if(confirm('Apagar todas as angariações?')){ localStorage.removeItem(LS_KEY); populateConsultoresFilter(); render(); } };

// Atualização dinâmica do % ajustamento
['pp','ps'].forEach(id=>{
  document.getElementById(id).addEventListener('input', ()=>{
    const pp = Number(document.getElementById('pp').value)||null;
    const ps = Number(document.getElementById('ps').value)||null;
    const val = pct(pp, ps);
    document.getElementById('aj').textContent = (val!=null ? val+'%' : '—');
    semaforo(document.getElementById('sf'), val);
  });
});

// Filtros
document.getElementById('f_apply').onclick = ()=> render(view());
document.getElementById('f_clear').onclick = ()=>{
  document.getElementById('f_consultor').value=''; 
  document.getElementById('f_de').value=''; 
  document.getElementById('f_ate').value=''; 
  document.getElementById('f_sort').value='data_desc';
  render();
};

// Garantir que o dropdown de consultores aparece SEMPRE (fallback + carga dinâmica)
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', fillConsultorSelects);
} else {
  fillConsultorSelects();
}

// Primeira renderização
render();
</script>
</body>
</html>
