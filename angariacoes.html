<!doctype html>
<html lang="pt">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Garvetur Porto Pro ‚Äî Angaria√ß√µes</title>

<link rel="preconnect" href="https://unpkg.com" crossorigin>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>

<style>
:root{
  --gold:#A38B63;
  --bg:#0E0E0E;
  --panel:#131313;
  --text:#FFFFFF;
  --muted:#9AA0A6;
  --border:rgba(255,255,255,.12);
}
html,body{
  height:100%;
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;
}
a{color:#eaeaea;text-decoration:none}

/* Layout base */
.app{display:grid;grid-template-rows:56px auto auto 1fr;height:100%}

/* Header */
header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:10px 12px;
  border-bottom:1px solid var(--border);
  background:#0F0F0F;
}
.brand{display:flex;align-items:center;gap:10px}
.brand h1{font-size:16px;margin:0;color:var(--gold)}
.nav{display:flex;gap:8px}
.nav a{
  border:1px solid var(--border);
  padding:6px 10px;
  border-radius:8px;
  color:#ddd;
}
.nav a.active{
  background:var(--gold);
  color:#111;
  border-color:var(--gold);
  font-weight:700;
}

/* Toolbar */
.toolbar{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  padding:8px 12px;
  border-bottom:1px solid var(--border);
  background:#0F0F0F;
}
.btn{
  background:transparent;
  border:1px solid rgba(163,139,99,.5);
  color:#fff;
  padding:6px 10px;
  border-radius:10px;
  cursor:pointer;
  font-size:12px;
}
.btn.primary{background:var(--gold);color:#111;border-color:var(--gold);font-weight:700}
.btn.ghost{border-color:var(--border);color:#ddd}
.btn[disabled]{opacity:.45;cursor:not-allowed}

/* KPI Bar */
.kpi-bar{
  padding:6px 12px;
  border-bottom:1px solid var(--border);
  font-size:12px;
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  align-items:center;
  background:#101010;
}
.kpi-badge{
  padding:2px 8px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.18);
}
.kpi-badge.highlight{
  border-color:var(--gold);
  color:var(--gold);
  font-weight:600;
}

/* Main */
.main{
  display:grid;
  grid-template-columns:300px 1fr;
  height:calc(100vh - 56px - 48px - 32px);
}
.sidebar{
  background:var(--panel);
  border-right:1px solid var(--border);
  padding:12px;
  overflow:auto;
}
.sidebar h3{
  margin:0 0 8px 0;
  font-size:13px;
  color:#d7d7d7;
  text-transform:uppercase;
  letter-spacing:.06em;
}
.field{
  display:flex;
  flex-direction:column;
  gap:6px;
  margin-bottom:10px;
}
.field label{font-size:12px;color:#ccc}
.field input,.field select{
  background:#0E0E0E;
  border:1px solid rgba(255,255,255,.16);
  border-radius:8px;
  color:#fff;
  padding:8px 10px;
  outline:none;
  font-size:12px;
}
.checks{display:flex;flex-direction:column;gap:8px}
.checks label{
  display:flex;
  gap:6px;
  align-items:center;
  font-size:13px;
  color:#ddd;
}
.checks input{accent-color:var(--gold)}

/* Board */
.board{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:10px;
  padding:10px;
  height:100%;
  overflow:auto;
}
.col{
  background:var(--panel);
  border-radius:12px;
  border:1px solid var(--border);
  display:flex;
  flex-direction:column;
  min-width:260px;
}
.col header{
  padding:10px;
  border-bottom:1px solid rgba(255,255,255,.08);
  display:flex;
  align-items:center;
  justify-content:space-between;
}
.col header .title{font-weight:700}
.col header .counter{font-size:12px;color:#cfcfcf}
.col .list{
  padding:10px;
  display:flex;
  flex-direction:column;
  gap:10px;
}

/* Cards */
.card{
  background:#0E0E0E;
  border-radius:12px;
  border:1px solid rgba(163,139,99,.35);
  padding:10px;
}
.card .top{
  display:flex;
  justify-content:space-between;
  gap:8px;
}
.card .name{font-weight:700}
.card .meta{font-size:11px;color:#bbb;text-transform:uppercase;letter-spacing:.04em}
.card .row{margin-top:5px;font-size:12px;color:#ddd}
.card .row small{color:#aaa}
.section-sep{
  margin-top:6px;
  padding-top:6px;
  border-top:1px solid rgba(163,139,99,.4);
}
.badge{
  display:inline-block;
  padding:2px 8px;
  font-size:11px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.18);
}
.badge.red{border-color:#ff6b6b;color:#ffb4b4}
.badge.green{border-color:#5ac48f;color:#bdf7d3}
.badge.yellow{border-color:#ffdd7a;color:#ffdd7a}
.actions{
  margin-top:8px;
  display:flex;
  flex-wrap:wrap;
  gap:6px;
}
.btn-sm{
  font-size:11px;
  padding:4px 7px;
  border-radius:8px;
  border:1px solid rgba(255,255,255,.18);
  background:transparent;
  color:#eee;
  cursor:pointer;
}
.btn-sm.danger{border-color:#cc4b4b;color:#ffdddd}
.btn-sm[disabled]{opacity:.45;cursor:not-allowed}
.select-move{
  background:#0E0E0E;
  border-radius:8px;
  border:1px solid rgba(255,255,255,.25);
  color:#ddd;
  font-size:11px;
  padding:3px 6px;
}
.select-move[disabled]{opacity:.45;cursor:not-allowed}

/* Mini gr√°fico por consultor */
.chart{
  margin-top:12px;
  border-top:1px dashed rgba(255,255,255,.2);
  padding-top:10px;
}
.chart h4{
  margin:0 0 6px 0;
  font-size:12px;
  color:#ccc;
  text-transform:uppercase;
  letter-spacing:.06em;
}
.chart-row{
  display:flex;
  align-items:center;
  gap:6px;
  margin-bottom:4px;
}
.chart-label{
  width:120px;
  font-size:11px;
  color:#ddd;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.chart-bar-wrap{
  flex:1;
  background:#222;
  border-radius:999px;
  overflow:hidden;
}
.chart-bar{
  height:6px;
  background:linear-gradient(90deg,#A38B63,#F4D188);
}

/* Modal */
.modal-backdrop{
  position:fixed;
  inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  background:rgba(0,0,0,.6);
  backdrop-filter:blur(2px);
  z-index:10000;
  padding:16px;
}
.modal-backdrop.show{display:flex}
.modal{
  width:min(1080px,96vw);
  background:#0F0F0F;
  border-radius:12px;
  border:1px solid var(--border);
  overflow:hidden;
}
.modal header{
  padding:10px 12px;
  border-bottom:1px solid var(--border);
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.modal .content{
  padding:12px;
  max-height:72vh;
  overflow:auto;
}
.section-title{
  margin:12px 0 6px 0;
  font-size:12px;
  color:#ccc;
  text-transform:uppercase;
  letter-spacing:.06em;
}
.form-grid2{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
}
.form-grid3{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:10px;
}
.form-field{
  display:flex;
  flex-direction:column;
  gap:4px;
}
.form-field label{font-size:12px;color:#ccc}
.form-field input,.form-field select,.form-field textarea{
  background:#0E0E0E;
  border-radius:8px;
  border:1px solid rgba(255,255,255,.16);
  color:#fff;
  padding:8px 10px;
  outline:none;
  font-size:12px;
}
textarea{resize:vertical}
.small-hint{font-size:11px;color:#9AA0A6}

/* Checkbox grids (simplificado) */
.check-grid-3{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:6px;
}
.check-grid-3 label{
  font-size:12px;
  display:flex;
  align-items:center;
  gap:6px;
  color:#ddd;
}
.check-grid-3 input{accent-color:var(--gold)}

/* Responsive */
@media (max-width:1400px){ .board{grid-template-columns:repeat(3,1fr)} }
@media (max-width:1024px){ .board{grid-template-columns:repeat(2,1fr)} }
@media (max-width:768px){
  .main{grid-template-columns:1fr}
  .sidebar{order:2;height:280px}
  .board{order:1}
}
</style>
</head>
<body>
<header>
  <div class="brand">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" style="color:var(--gold)">
      <circle cx="12" cy="12" r="10" stroke-width="1.5"></circle>
      <path d="M8 12l2.5 2.5L16 9" stroke-width="1.8"></path>
    </svg>
    <h1>Garvetur Porto Pro ‚Äî Angaria√ß√µes</h1>
  </div>
  <nav class="nav">
    <a href="./index.html">Mapa</a>
    <a href="./kanban.html">Leads</a>
    <a class="active" href="./angariacoes.html">Angaria√ß√µes</a>
    <a href="./dashboard.html">Dashboard</a>
  </nav>
</header>

<div class="toolbar">
  <button class="btn primary" id="btnNew" disabled>+ Nova Angaria√ß√£o</button>
  <button class="btn" id="toggleEdit">üîí Edi√ß√£o bloqueada</button>
  <div style="margin-left:auto;display:flex;gap:8px;flex-wrap:wrap">
    <button class="btn" id="exportCsv">Exportar CSV</button>
  </div>
</div>

<div class="kpi-bar" id="kpiBar"></div>

<div class="main">
  <!-- Sidebar -->
  <aside class="sidebar">
    <h3>Pesquisa</h3>
    <div class="field">
      <input id="f_q" placeholder="Empreendimento, propriet√°rio, consultor, ref., notas">
    </div>

    <h3>Filtros</h3>
    <div class="field">
      <label>Consultor</label>
      <select id="f_consultor">
        <option value="">(Todos)</option>
      </select>
    </div>
    <div class="field">
      <label>Estado</label>
      <select id="f_estado">
        <option value="">(Todos)</option>
        <option>Novo</option>
        <option>Em Negocia√ß√£o</option>
        <option>Aprovado</option>
        <option>Perdido</option>
      </select>
    </div>
    <div class="field">
      <label>Per√≠odo (Data)</label>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px">
        <input id="f_ini" type="date">
        <input id="f_fim" type="date">
      </div>
    </div>
    <div class="field">
      <label>% Ajustamento (min‚Äìm√°x)</label>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px">
        <input id="f_aj_min" type="number" step="1" placeholder="min">
        <input id="f_aj_max" type="number" step="1" placeholder="m√°x">
      </div>
    </div>
    <div class="checks">
      <label><input type="checkbox" id="f_show_hidden"> Mostrar invis√≠veis</label>
      <label><input type="checkbox" id="f_only_hidden"> S√≥ invis√≠veis</label>
    </div>
    <div style="display:flex;gap:8px;margin-top:10px">
      <button class="btn" id="applyFilters">Aplicar</button>
      <button class="btn ghost" id="clearFilters">Limpar</button>
    </div>

    <!-- Mini gr√°fico -->
    <div class="chart">
      <h4>Angaria√ß√µes por consultor</h4>
      <div id="chartRows"></div>
    </div>
  </aside>

  <!-- Board -->
  <section class="board" id="board"></section>
</div>

<!-- Modal Angaria√ß√£o -->
<div class="modal-backdrop" id="angModal">
  <div class="modal">
    <header>
      <div><strong id="modalTitle">Nova Angaria√ß√£o</strong></div>
      <div style="display:flex;gap:8px">
        <button class="btn" id="btnCancel">Cancelar</button>
        <button class="btn primary" id="btnSave">Guardar</button>
      </div>
    </header>
    <div class="content">
      <!-- Cabe√ßalho -->
      <div class="section-title">Cabe√ßalho</div>
      <div class="form-grid3">
        <div class="form-field">
          <label>Consultor</label>
          <select id="a_consultor">
            <option value="">‚Äî</option>
            <option>Rui Quelhas</option>
            <option>Manuel Oliveira</option>
            <option>Jo√£o Sousa</option>
            <option>Francisco dos Santos</option>
            <option>Ros√°rio Vasconcelos</option>
            <option>Armanda Meireles</option>
            <option>Audrey Lucas</option>
          </select>
        </div>
        <div class="form-field">
          <label>Gestor</label>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px">
            <select id="a_gestor">
              <option value="">‚Äî</option>
              <option>Rui Quelhas</option>
              <option>Manuel Oliveira</option>
              <option>Jo√£o Sousa</option>
              <option>Francisco dos Santos</option>
              <option>Ros√°rio Vasconcelos</option>
              <option>Armanda Meireles</option>
              <option>Audrey Lucas</option>
              <option value="outro">Outro</option>
            </select>
            <input id="a_gestor_outro" placeholder="Outro gestor" style="display:none">
          </div>
        </div>
        <div class="form-field">
          <label>Coordenador</label>
          <input id="a_coordenador" value="Rui Quelhas">
        </div>
        <div class="form-field">
          <label>Interveniente</label>
          <input id="a_interveniente" placeholder="Nome do interveniente">
        </div>
        <div class="form-field">
          <label>Ref. Interna</label>
          <input id="a_ref">
        </div>
        <div class="form-field">
          <label>Link URL</label>
          <input id="a_link_url" placeholder="https://‚Ä¶">
        </div>
      </div>

      <!-- Empreendimento -->
      <div class="section-title">Empreendimento</div>
      <div class="form-grid3">
        <div class="form-field">
          <label>Nome do empreendimento</label>
          <input id="a_nome_empreendimento" placeholder="Ex.: Essence, Madalena Vista Mar">
        </div>
        <div class="form-field">
          <label>Total de Fra√ß√µes</label>
          <input id="a_total_fracoes" type="number" min="0" step="1">
        </div>
        <div class="form-field">
          <label>Tipologias</label>
          <input id="a_tipologias" placeholder="Ex.: T1‚ÄìT4, T2 e T3">
        </div>
        <div class="form-field">
          <label>Ano de constru√ß√£o</label>
          <input id="a_ano_construcao" placeholder="Ex.: 2002">
        </div>
        <div class="form-field">
          <label>Ano de conclus√£o</label>
          <input id="a_ano_conclusao" placeholder="Ex.: 2025">
        </div>
      </div>
      <div class="form-grid3">
        <div class="form-field">
          <label>Promotor</label>
          <input id="a_nome_promotor">
        </div>
        <div class="form-field">
          <label>Contacto telef√≥nico (Promotor)</label>
          <input id="a_contacto_promotor">
        </div>
        <div class="form-field">
          <label>Email do Promotor</label>
          <input id="a_email_promotor" type="email">
        </div>
      </div>

      <!-- Propriet√°rio -->
      <div class="section-title">Propriet√°rio</div>
      <div class="form-grid3">
        <div class="form-field">
          <label>Nome</label>
          <input id="a_proprietario" placeholder="Nome do propriet√°rio">
        </div>
        <div class="form-field">
          <label>Contacto telef√≥nico</label>
          <input id="a_contacto" placeholder="+351 ‚Ä¶">
        </div>
        <div class="form-field">
          <label>Email</label>
          <input id="a_email_proprietario" type="email" placeholder="email@exemplo.pt">
        </div>
      </div>
      <div class="form-field">
        <label>Morada</label>
        <input id="loc_morada">
      </div>
      <div class="form-grid2">
        <div class="form-field">
          <label>Estado civil</label>
          <select id="a_estado_civil">
            <option value="">‚Äî</option>
            <option>Solteiro</option>
            <option>Casado</option>
            <option>Divorciado</option>
          </select>
        </div>
        <div class="form-field">
          <label>Regime de casamento</label>
          <select id="a_regime">
            <option value="">‚Äî</option>
            <option>Comunh√£o de adquiridos</option>
            <option>Comunh√£o geral de bens</option>
            <option>Separa√ß√£o de bens</option>
          </select>
        </div>
      </div>

      <!-- Im√≥vel -->
      <div class="section-title">Im√≥vel</div>
      <div class="form-grid3">
        <div class="form-field">
          <label>T√≠tulo / Designa√ß√£o</label>
          <input id="a_titulo" placeholder="Ex.: Apartamento T3 com vista mar">
        </div>
        <div class="form-field">
          <label>Localiza√ß√£o</label>
          <input id="loc_zona" placeholder="Zona / localiza√ß√£o">
        </div>
        <div class="form-field">
          <label>Certificado Energ√©tico</label>
          <select id="a_cert_energetico_classe">
            <option value="">‚Äî</option>
            <option>A+</option>
            <option>A</option>
            <option>B</option>
            <option>B-</option>
            <option>C</option>
            <option>D</option>
            <option>E</option>
            <option>F</option>
            <option>G</option>
            <option>Isento</option>
          </select>
        </div>
      </div>
      <div class="form-grid3">
        <div class="form-field">
          <label>Distrito</label>
          <input id="loc_distrito">
        </div>
        <div class="form-field">
          <label>Concelho</label>
          <input id="loc_concelho">
        </div>
        <div class="form-field">
          <label>Freguesia</label>
          <input id="loc_freguesia">
        </div>
      </div>
      <div class="form-field">
        <label>Coordenadas GPS</label>
        <input id="loc_gps" placeholder="Ex.: 41.15, -8.61">
      </div>

      <!-- Natureza / Estado / Neg√≥cio -->
      <div class="section-title">Natureza, estado e neg√≥cio</div>
      <div class="form-grid3">
        <div class="form-field">
          <label>Natureza</label>
          <select id="a_natureza">
            <option value="">‚Äî</option>
            <option>Apartamento</option>
            <option>Moradia</option>
            <option>Terreno</option>
            <option>Loja</option>
            <option>Escrit√≥rio</option>
            <option>Empreendimento</option>
            <option>Outro</option>
          </select>
        </div>
        <div class="form-field">
          <label>Natureza (Outro)</label>
          <input id="a_natureza_outro">
        </div>
        <div class="form-field">
          <label>Estado do im√≥vel</label>
          <select id="a_estado_imovel">
            <option value="">‚Äî</option>
            <option>Novo</option>
            <option>Usado</option>
            <option>Recuperado</option>
            <option>Em constru√ß√£o</option>
            <option>Em Projeto</option>
            <option>Outro</option>
          </select>
        </div>
        <div class="form-field">
          <label>Neg√≥cio</label>
          <select id="a_negocio">
            <option value="">‚Äî</option>
            <option>Venda</option>
            <option>Arrendamento</option>
            <option>Arrendamento para F√©rias</option>
            <option>Trespasse</option>
            <option>Permuta</option>
            <option>Outro</option>
          </select>
        </div>
        <div class="form-field">
          <label>Neg√≥cio (Outro)</label>
          <input id="a_negocio_outro">
        </div>
        <div class="form-field">
          <label>Data</label>
          <input id="a_data" type="date">
        </div>
      </div>

      <!-- √Åreas -->
      <div class="section-title">√Åreas (m¬≤)</div>
      <div class="form-grid3">
        <div class="form-field">
          <label>ABP (√Årea Bruta Privativa)</label>
          <input id="a_abp" type="number" min="0" step="1">
        </div>
        <div class="form-field">
          <label>ABD (√Årea Bruta Dependente)</label>
          <input id="a_abd" type="number" min="0" step="1">
        </div>
        <div class="form-field">
          <label>√Årea Terreno</label>
          <input id="a_area_terreno" type="number" min="0" step="1">
        </div>
        <div class="form-field">
          <label>√Årea Implanta√ß√£o</label>
          <input id="a_area_implantacao" type="number" min="0" step="1">
        </div>
      </div>

      <!-- Pre√ßo / Comiss√£o / Ajustamento -->
      <div class="section-title">Pre√ßo, comiss√£o e ajustamento</div>
      <div class="form-grid3">
        <div class="form-field">
          <label>Pre√ßo pedido (‚Ç¨)</label>
          <input id="a_preco_pedido" type="number" min="0" step="1000">
        </div>
        <div class="form-field">
          <label>Pre√ßo sugerido (‚Ç¨)</label>
          <input id="a_preco_sugerido" type="number" min="0" step="1000">
        </div>
        <div class="form-field">
          <label>% Ajustamento</label>
          <input id="a_ajustamento" type="number" step="0.1" placeholder="Ex.: -8">
        </div>
        <div class="form-field">
          <label>Comiss√£o</label>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px">
            <select id="a_comissao">
              <option value="">‚Äî</option>
              <option value="6">6%</option>
              <option value="5">5%</option>
              <option value="4">4%</option>
              <option value="3">3%</option>
              <option value="outro">Outro</option>
            </select>
            <input id="a_comissao_outro" placeholder="Ex.: 4.5%" style="display:none">
          </div>
        </div>
        <div class="form-field">
          <label>Origem do cliente</label>
          <select id="a_origem">
            <option value="">‚Äî</option>
            <option>Prospec√ß√£o ativa</option>
            <option>Recomenda√ß√£o</option>
            <option>Portal</option>
            <option>Walk-in</option>
            <option>Lead digital</option>
          </select>
        </div>
        <div class="form-field">
          <label>Estado da angaria√ß√£o</label>
          <select id="a_estado">
            <option>Novo</option>
            <option>Em Negocia√ß√£o</option>
            <option>Aprovado</option>
            <option>Perdido</option>
          </select>
        </div>
      </div>

      <!-- Destaques (simplificado) -->
      <div class="section-title">Destaques</div>
      <div class="check-grid-3">
        <label><input type="checkbox" id="d_exclusivo"> Exclusivo</label>
        <label><input type="checkbox" id="d_nao_exclusivo"> N√£o exclusivo</label>
        <label><input type="checkbox" id="d_luxo"> Luxo</label>
        <label><input type="checkbox" id="d_banca"> Im√≥veis da Banca</label>
        <label><input type="checkbox" id="d_golden_visa"> Golden Visa</label>
        <label><input type="checkbox" id="d_rentab"> Rentabilidade Garantida</label>
      </div>
      <div class="form-grid3">
        <div class="form-field">
          <label>Dura√ß√£o do Contrato</label>
          <select id="d_duracao">
            <option value="">‚Äî</option>
            <option>3 meses</option>
            <option>4 meses</option>
            <option>5 meses</option>
            <option>6 meses</option>
            <option value="outro">Outro</option>
          </select>
        </div>
        <div class="form-field">
          <label>Dura√ß√£o (Outro)</label>
          <input id="d_duracao_outro" placeholder="Ex.: 9 meses" style="display:none">
        </div>
      </div>

      <!-- Documenta√ß√£o (resumo) -->
      <div class="section-title">Documenta√ß√£o entregue (resumo)</div>
      <div class="check-grid-3">
        <label><input type="checkbox" id="d_cc"> Identifica√ß√£o Propriet√°rios</label>
        <label><input type="checkbox" id="d_contrato_med"> Contrato Media√ß√£o</label>
        <label><input type="checkbox" id="d_caderneta"> Caderneta Predial</label>
        <label><input type="checkbox" id="d_crp"> Certid√£o Registo Predial</label>
        <label><input type="checkbox" id="d_cert_energetico"> Certificado Energ√©tico</label>
        <label><input type="checkbox" id="d_bupi"> Registado no BUPI</label>
      </div>

      <!-- Observa√ß√µes principais -->
      <div class="section-title">Observa√ß√µes (quantitativo)</div>
      <div class="form-field">
        <label>Observa√ß√µes gerais</label>
        <textarea id="a_notas" rows="3"></textarea>
        <div id="obsCounter" class="small-hint">0/1500 caracteres</div>
      </div>

      <!-- Notas internas -->
      <div class="section-title">Notas internas</div>
      <div class="form-grid3">
        <div class="form-field">
          <label>Notas do Consultor</label>
          <textarea id="a_notas_consultor" rows="2"></textarea>
        </div>
        <div class="form-field">
          <label>Notas do Coordenador</label>
          <textarea id="a_notas_coordenador" rows="2"></textarea>
        </div>
        <div class="form-field">
          <label>Notas da Assistente</label>
          <textarea id="a_notas_assistente" rows="2"></textarea>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* ===== Estado global ===== */
const LS_KEY = 'gpp_angariacoes_v5';
const EDIT_KEY = 'gpp_ang_edit_mode';
const COLS = ["Novo","Em Negocia√ß√£o","Aprovado","Perdido"];
const CONSULT = [
  "Rui Quelhas",
  "Manuel Oliveira",
  "Jo√£o Sousa",
  "Francisco dos Santos",
  "Ros√°rio Vasconcelos",
  "Armanda Meireles",
  "Audrey Lucas"
];

let ANG = [];
let FILTER = {
  q:'',
  consultor:'',
  estado:'',
  ini:'',
  fim:'',
  ajMin:'',
  ajMax:'',
  showHidden:false,
  onlyHidden:false
};
let EDIT_MODE = false;
let EDIT_ID = null;

const $ = id => document.getElementById(id);
const norm = s => String(s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');

/* ===== Storage helpers ===== */
function loadLS(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    return raw? JSON.parse(raw):[];
  }catch{return [];}
}
function saveLS(){
  localStorage.setItem(LS_KEY, JSON.stringify(ANG));
}

/* ===== Edit mode lock ===== */
function applyEditUI(){
  const btnNew = $('btnNew');
  const toggle = $('toggleEdit');
  if(EDIT_MODE){
    toggle.classList.add('primary');
    toggle.textContent = 'üîì Edi√ß√£o ativa';
    btnNew.disabled = false;
  } else {
    toggle.classList.remove('primary');
    toggle.textContent = 'üîí Edi√ß√£o bloqueada';
    btnNew.disabled = true;
  }
}
function setEditMode(on){
  EDIT_MODE = !!on;
  localStorage.setItem(EDIT_KEY, EDIT_MODE?'1':'0');
  applyEditUI();
  renderBoard();
}

/* ===== Filtros ===== */
function loadFilters(){
  const sel = $('f_consultor');
  sel.innerHTML = '<option value="">(Todos)</option>'+CONSULT.map(c=>`<option>${c}</option>`).join('');
}
function applyFilterStateFromUI(){
  FILTER.q = $('f_q').value.trim();
  FILTER.consultor = $('f_consultor').value;
  FILTER.estado = $('f_estado').value;
  FILTER.ini = $('f_ini').value;
  FILTER.fim = $('f_fim').value;
  FILTER.ajMin = $('f_aj_min').value;
  FILTER.ajMax = $('f_aj_max').value;
  FILTER.showHidden = $('f_show_hidden').checked;
  FILTER.onlyHidden = $('f_only_hidden').checked;
}
function clearFilterUI(){
  $('f_q').value = '';
  $('f_consultor').value = '';
  $('f_estado').value = '';
  $('f_ini').value = '';
  $('f_fim').value = '';
  $('f_aj_min').value = '';
  $('f_aj_max').value = '';
  $('f_show_hidden').checked = false;
  $('f_only_hidden').checked = false;
  FILTER = {q:'',consultor:'',estado:'',ini:'',fim:'',ajMin:'',ajMax:'',showHidden:false,onlyHidden:false};
}
$('applyFilters').addEventListener('click',()=>{ applyFilterStateFromUI(); renderBoard(); });
$('clearFilters').addEventListener('click',()=>{ clearFilterUI(); renderBoard(); });
let qTimer=null;
$('f_q').addEventListener('input',()=>{
  clearTimeout(qTimer);
  qTimer = setTimeout(()=>{ applyFilterStateFromUI(); renderBoard(); },200);
});

/* ===== Observa√ß√µes contador ===== */
function updateObsCounter(){
  const ta = $('a_notas');
  const c = $('obsCounter');
  if(!ta || !c) return;
  let txt = ta.value || '';
  if(txt.length > 1500){
    txt = txt.slice(0,1500);
    ta.value = txt;
  }
  c.textContent = txt.length + '/1500 caracteres';
  c.style.color = txt.length > 1400 ? '#ff8080' : '#9AA0A6';
}
$('a_notas').addEventListener('input', updateObsCounter);

/* ===== Modal ===== */
function openModal(edit=null){
  if(!EDIT_MODE){
    alert('Modo de edi√ß√£o bloqueado. Clique em "üîì Edi√ß√£o ativa" para criar ou editar angaria√ß√µes.');
    return;
  }
  EDIT_ID = edit? edit.id : null;
  $('modalTitle').textContent = edit? 'Editar Angaria√ß√£o' : 'Nova Angaria√ß√£o';

  const set = (id,val='') => { const el=$(id); if(el) el.value = (val ?? ''); };
  const chk = (id,val)=>{ const el=$(id); if(el) el.checked = !!val; };

  const a = edit || {};
  // Cabe√ßalho
  set('a_consultor', a.consultor);
  if(a.gestor && CONSULT.includes(a.gestor)){
    set('a_gestor', a.gestor);
    $('a_gestor_outro').style.display='none';
    $('a_gestor_outro').value='';
  } else if(a.gestor){
    set('a_gestor','outro');
    $('a_gestor_outro').style.display='block';
    $('a_gestor_outro').value = a.gestor;
  } else {
    set('a_gestor','');
    $('a_gestor_outro').style.display='none';
    $('a_gestor_outro').value='';
  }
  set('a_coordenador', a.coordenador || 'Rui Quelhas');
  set('a_interveniente', a.interveniente);
  set('a_ref', a.ref);
  set('a_link_url', a.link_url);

  // Empreendimento
  set('a_nome_empreendimento', a.nome_empreendimento);
  set('a_total_fracoes', a.total_fracoes);
  set('a_tipologias', a.tipologias);
  set('a_ano_construcao', a.ano_construcao);
  set('a_ano_conclusao', a.ano_conclusao);
  set('a_nome_promotor', a.nome_promotor);
  set('a_contacto_promotor', a.contacto_promotor);
  set('a_email_promotor', a.email_promotor);

  // Propriet√°rio
  set('a_proprietario', a.proprietario);
  set('a_contacto', a.contacto);
  set('a_email_proprietario', a.email_proprietario);
  set('loc_morada', a.loc_morada);
  set('a_estado_civil', a.estado_civil);
  set('a_regime', a.regime);

  // Im√≥vel
  set('a_titulo', a.titulo);
  set('loc_zona', a.loc_zona);
  set('a_cert_energetico_classe', a.cert_energetico_classe);
  set('loc_distrito', a.loc_distrito);
  set('loc_concelho', a.loc_concelho);
  set('loc_freguesia', a.loc_freguesia);
  set('loc_gps', a.loc_gps);

  // Natureza / neg√≥cio / data
  set('a_natureza', a.natureza);
  set('a_natureza_outro', a.natureza_outro);
  set('a_estado_imovel', a.estado_imovel);
  set('a_negocio', a.negocio);
  set('a_negocio_outro', a.negocio_outro);
  set('a_data', a.data || new Date().toISOString().slice(0,10));

  // √Åreas
  set('a_abp', a.abp);
  set('a_abd', a.abd);
  set('a_area_terreno', a.area_terreno);
  set('a_area_implantacao', a.area_implantacao);

  // pre√ßo / comiss√£o / ajustamento
  set('a_preco_pedido', a.preco_pedido);
  set('a_preco_sugerido', a.preco_sugerido);
  set('a_ajustamento', a.ajustamento);
  if(a.comissao_pct && ['6','5','4','3'].includes(String(a.comissao_pct))){
    set('a_comissao', String(a.comissao_pct));
    $('a_comissao_outro').style.display='none';
    $('a_comissao_outro').value='';
  } else if(a.comissao_pct){
    set('a_comissao','outro');
    $('a_comissao_outro').style.display='block';
    $('a_comissao_outro').value = a.comissao_pct+'%';
  } else {
    set('a_comissao','');
    $('a_comissao_outro').style.display='none';
    $('a_comissao_outro').value='';
  }
  set('a_origem', a.origem);
  set('a_estado', a.estado || 'Novo');

  // destaques
  chk('d_exclusivo', a.d_exclusivo);
  chk('d_nao_exclusivo', a.d_nao_exclusivo);
  chk('d_luxo', a.d_luxo);
  chk('d_banca', a.d_banca);
  chk('d_golden_visa', a.d_golden_visa);
  chk('d_rentab', a.d_rentab);
  set('d_duracao', a.duracao_contrato);
  if(a.duracao_contrato && !['3 meses','4 meses','5 meses','6 meses'].includes(a.duracao_contrato)){
    $('d_duracao').value = 'outro';
    $('d_duracao_outro').style.display='block';
    $('d_duracao_outro').value = a.duracao_contrato;
  } else {
    $('d_duracao_outro').style.display='none';
    $('d_duracao_outro').value='';
  }

  // docs resumo
  chk('d_cc', a.d_cc);
  chk('d_contrato_med', a.d_contrato_med);
  chk('d_caderneta', a.d_caderneta);
  chk('d_crp', a.d_crp);
  chk('d_cert_energetico', a.d_cert_energetico);
  chk('d_bupi', a.d_bupi);

  // observa√ß√µes e notas
  set('a_notas', a.notas);
  set('a_notas_consultor', a.notas_consultor);
  set('a_notas_coordenador', a.notas_coordenador);
  set('a_notas_assistente', a.notas_assistente);
  updateObsCounter();

  $('angModal').classList.add('show');
}
$('btnCancel').addEventListener('click',()=> $('angModal').classList.remove('show'));
$('btnNew').addEventListener('click',()=> openModal(null));
$('a_comissao').addEventListener('change', e=>{
  if(e.target.value === 'outro'){
    $('a_comissao_outro').style.display='block';
  } else {
    $('a_comissao_outro').style.display='none';
    $('a_comissao_outro').value='';
  }
});
$('a_gestor').addEventListener('change', e=>{
  if(e.target.value === 'outro'){
    $('a_gestor_outro').style.display='block';
  } else {
    $('a_gestor_outro').style.display='none';
    $('a_gestor_outro').value='';
  }
});
$('d_duracao').addEventListener('change', e=>{
  if(e.target.value === 'outro'){
    $('d_duracao_outro').style.display='block';
  } else {
    $('d_duracao_outro').style.display='none';
    $('d_duracao_outro').value='';
  }
});

/* ===== Guardar (sem obrigat√≥rios) ===== */
$('btnSave').addEventListener('click',()=>{
  if(!EDIT_MODE){
    alert('Modo de edi√ß√£o bloqueado. Clique em "üîì Edi√ß√£o ativa" para guardar altera√ß√µes.');
    return;
  }

  const get = id => { const el=$(id); return el? el.value.trim():''; };
  const chk = id => { const el=$(id); return el? !!el.checked:false; };

  // recolher principais campos
  const consultor = get('a_consultor');
  const gestorSel = get('a_gestor');
  const gestorOutro = get('a_gestor_outro');
  let gestor = '';
  if(gestorSel === 'outro'){ gestor = gestorOutro || ''; }
  else { gestor = gestorSel || ''; }

  const proprietario = get('a_proprietario');
  const nomeEmp = get('a_nome_empreendimento');
  const tituloImovel = get('a_titulo');

  // valida√ß√£o m√≠nima: tem de haver algum conte√∫do relevante
  const concatMain = [
    consultor, gestor, proprietario, nomeEmp, tituloImovel,
    get('a_preco_pedido'),
    get('a_preco_sugerido')
  ].join('').trim();
  if(!concatMain){
    alert('Preencha pelo menos um dos campos principais (consultor, propriet√°rio, empreendimento, im√≥vel ou pre√ßo) antes de guardar.');
    return;
  }

  const preco_pedido = get('a_preco_pedido');
  const preco_sugerido = get('a_preco_sugerido');
  let ajust = get('a_ajustamento');

  if(preco_pedido && preco_sugerido && !ajust){
    const pp = Number(preco_pedido);
    const ps = Number(preco_sugerido);
    if(pp>0 && ps>0){
      ajust = (((ps-pp)/pp)*100).toFixed(1);
    }
  }

  // comiss√£o
  let comissao_pct = '';
  const comSel = get('a_comissao');
  if(comSel === 'outro'){
    const raw = get('a_comissao_outro').replace('%','').replace(',','.');
    const n = Number(raw);
    if(Number.isFinite(n)) comissao_pct = n;
  } else if(comSel){
    comissao_pct = Number(comSel);
  }

  // dura√ß√£o contrato
  let duracao = get('d_duracao');
  if(duracao === 'outro'){
    const outro = get('d_duracao_outro');
    if(outro) duracao = outro;
    else duracao = '';
  }

  const rec = {
    id: EDIT_ID || ('A'+Math.random().toString(36).slice(2,9)+Date.now().toString(36).slice(-4)),

    // Cabe√ßalho
    consultor,
    gestor,
    coordenador: get('a_coordenador') || 'Rui Quelhas',
    interveniente: get('a_interveniente'),
    ref: get('a_ref'),
    link_url: get('a_link_url'),

    // Empreendimento
    nome_empreendimento: nomeEmp,
    total_fracoes: get('a_total_fracoes'),
    tipologias: get('a_tipologias'),
    ano_construcao: get('a_ano_construcao'),
    ano_conclusao: get('a_ano_conclusao'),
    nome_promotor: get('a_nome_promotor'),
    contacto_promotor: get('a_contacto_promotor'),
    email_promotor: get('a_email_promotor'),

    // Propriet√°rio
    proprietario,
    contacto: get('a_contacto'),
    email_proprietario: get('a_email_proprietario'),
    loc_morada: get('loc_morada'),
    estado_civil: get('a_estado_civil'),
    regime: get('a_regime'),

    // Im√≥vel
    titulo: tituloImovel,
    loc_zona: get('loc_zona'),
    cert_energetico_classe: get('a_cert_energetico_classe'),
    loc_distrito: get('loc_distrito'),
    loc_concelho: get('loc_concelho'),
    loc_freguesia: get('loc_freguesia'),
    loc_gps: get('loc_gps'),

    // natureza / neg√≥cio / data
    natureza: get('a_natureza'),
    natureza_outro: get('a_natureza_outro'),
    estado_imovel: get('a_estado_imovel'),
    negocio: get('a_negocio'),
    negocio_outro: get('a_negocio_outro'),
    data: get('a_data'),

    // √°reas
    abp: get('a_abp'),
    abd: get('a_abd'),
    area_terreno: get('a_area_terreno'),
    area_implantacao: get('a_area_implantacao'),

    // pre√ßo / comiss√£o / ajustamento
    preco_pedido,
    preco_sugerido,
    comissao_pct,
    ajustamento: ajust,
    origem: get('a_origem'),
    estado: get('a_estado') || 'Novo',

    // destaques
    d_exclusivo: chk('d_exclusivo'),
    d_nao_exclusivo: chk('d_nao_exclusivo'),
    d_luxo: chk('d_luxo'),
    d_banca: chk('d_banca'),
    d_golden_visa: chk('d_golden_visa'),
    d_rentab: chk('d_rentab'),
    duracao_contrato: duracao,

    // docs resumo
    d_cc: chk('d_cc'),
    d_contrato_med: chk('d_contrato_med'),
    d_caderneta: chk('d_caderneta'),
    d_crp: chk('d_crp'),
    d_cert_energetico: chk('d_cert_energetico'),
    d_bupi: chk('d_bupi'),

    // observa√ß√µes e notas
    visivel: (EDIT_ID && ANG.find(x=>x.id===EDIT_ID) && ANG.find(x=>x.id===EDIT_ID).visivel===false)? false : true,
    notas: get('a_notas'),
    notas_consultor: get('a_notas_consultor'),
    notas_coordenador: get('a_notas_coordenador'),
    notas_assistente: get('a_notas_assistente')
  };

  const idx = ANG.findIndex(a=>a.id===rec.id);
  if(idx>=0) ANG[idx] = Object.assign(ANG[idx], rec);
  else ANG.push(rec);

  saveLS();
  $('angModal').classList.remove('show');
  EDIT_ID = null;
  renderBoard();
});

/* ===== Helpers de formata√ß√£o ===== */
function fmtDate(d){
  if(!d) return '‚Äî';
  try{ return new Date(d).toLocaleDateString('pt-PT'); }catch{return d;}
}
function fmtNum(v){
  if(!v) return '‚Äî';
  const n=Number(v);
  if(!Number.isFinite(n)) return v;
  return n.toLocaleString('pt-PT');
}
function fmtPct(v){
  if(v===undefined || v===null || v==='') return '‚Äî';
  const n=Number(v);
  if(!Number.isFinite(n)) return v;
  return n.toFixed(1)+'%';
}

/* ===== Filtragem ===== */
function filterDataset(){
  let out = [...ANG];
  const t = norm(FILTER.q||'');

  if(t){
    out = out.filter(a=>{
      const blob = [
        a.nome_empreendimento,a.titulo,a.proprietario,a.consultor,a.ref,a.notas,
        a.loc_concelho,a.loc_zona
      ].map(norm).join(' ');
      return blob.includes(t);
    });
  }
  if(FILTER.consultor) out = out.filter(a=>a.consultor===FILTER.consultor);
  if(FILTER.estado) out = out.filter(a=>a.estado===FILTER.estado);
  if(FILTER.ini) out = out.filter(a=>!a.data || a.data>=FILTER.ini);
  if(FILTER.fim) out = out.filter(a=>!a.data || a.data<=FILTER.fim);
  if(FILTER.ajMin){
    const m = Number(FILTER.ajMin);
    out = out.filter(a=>a.ajustamento==='' || a.ajustamento===undefined || Number(a.ajustamento)>=m);
  }
  if(FILTER.ajMax){
    const M = Number(FILTER.ajMax);
    out = out.filter(a=>a.ajustamento==='' || a.ajustamento===undefined || Number(a.ajustamento)<=M);
  }
  if(FILTER.onlyHidden) out = out.filter(a=>a.visivel===false);
  if(!FILTER.showHidden && !FILTER.onlyHidden) out = out.filter(a=>a.visivel!==false);
  return out;
}

/* ===== KPI + gr√°fico ===== */
function renderKpi(filtered){
  const el = $('kpiBar');
  if(!filtered.length){
    el.textContent = 'Sem angaria√ß√µes nos filtros atuais.';
    return;
  }
  const total = filtered.length;
  const aprov = filtered.filter(a=>a.estado==='Aprovado').length;
  const perdido = filtered.filter(a=>a.estado==='Perdido').length;
  const somaPedido = filtered.reduce((s,a)=>s+(Number(a.preco_pedido)||0),0);
  const somaSugerido = filtered.reduce((s,a)=>s+(Number(a.preco_sugerido)||0),0);
  const mediaAj = (()=>{
    const arr = filtered.map(a=>Number(a.ajustamento)).filter(Number.isFinite);
    if(!arr.length) return '‚Äî';
    const m = arr.reduce((s,x)=>s+x,0)/arr.length;
    return m.toFixed(1)+'%';
  })();

  el.innerHTML = `
    <span class="kpi-badge">Total: ${total}</span>
    <span class="kpi-badge">Aprovadas: ${aprov}</span>
    <span class="kpi-badge">Perdidas: ${perdido}</span>
    <span class="kpi-badge">Volume pedido: ${somaPedido.toLocaleString('pt-PT')} ‚Ç¨</span>
    <span class="kpi-badge">Volume sugerido: ${somaSugerido.toLocaleString('pt-PT')} ‚Ç¨</span>
    <span class="kpi-badge highlight">M√©dia ajustamento: ${mediaAj}</span>
  `;
}
function renderChart(filtered){
  const box = $('chartRows');
  box.innerHTML = '';
  if(!filtered.length) return;
  const map = {};
  filtered.forEach(a=>{
    if(!a.consultor) return;
    map[a.consultor] = (map[a.consultor] || 0) + 1;
  });
  const entries = Object.entries(map).sort((a,b)=>b[1]-a[1]);
  if(!entries.length) return;
  const max = entries[0][1];

  entries.forEach(([name,val])=>{
    const row = document.createElement('div');
    row.className = 'chart-row';
    row.innerHTML = `
      <div class="chart-label">${name}</div>
      <div class="chart-bar-wrap">
        <div class="chart-bar" style="width:${(val/max*100).toFixed(0)}%"></div>
      </div>
      <div style="font-size:11px;color:#ccc">${val}</div>
    `;
    box.appendChild(row);
  });
}

/* ===== Card ===== */
function isEmpreendimento(a){
  return norm(a.natureza).includes('empreendimento');
}

function renderBoard(){
  const board = $('board');
  board.innerHTML = '';

  const filtered = filterDataset();
  renderKpi(filtered);
  renderChart(filtered);

  const byState = COLS.map(col=>({
    estado: col,
    items: filtered.filter(a=>a.estado===col)
  }));

  byState.forEach(col=>{
    const cEl = document.createElement('div');
    cEl.className='col';
    cEl.innerHTML = `
      <header>
        <span class="title">${col.estado}</span>
        <span class="counter">${col.items.length}</span>
      </header>
      <div class="list" id="list_${col.estado.replace(/\s/g,'_')}"></div>
    `;
    board.appendChild(cEl);

    const listEl = cEl.querySelector('.list');
    col.items.forEach(a=>{
      const card = document.createElement('div');
      card.className = 'card';

      const docsOk = (a.d_cc && a.d_contrato_med && a.d_caderneta && a.d_crp && a.d_cert_energetico) ? 'Completa' : 'Incompleta';
      const badgeDocs = docsOk==='Completa' ? '<span class="badge green">Doc. completa</span>' : '<span class="badge yellow">Doc. incompleta</span>';

      let badgeAj='';
      if(a.ajustamento!=='' && a.ajustamento!==undefined){
        const n = Number(a.ajustamento);
        if(Number.isFinite(n)){
          if(n<=-10) badgeAj = '<span class="badge green">'+fmtPct(n)+'</span>';
          else if(n<0) badgeAj = '<span class="badge yellow">'+fmtPct(n)+'</span>';
          else badgeAj = '<span class="badge red">'+fmtPct(n)+'</span>';
        }
      }

      const disabledAttr = EDIT_MODE ? '' : 'disabled';

      const emp = isEmpreendimento(a);

      // Linha 2 ‚Äì Empreendimento vs Propriet√°rio
      let linha2 = '';
      if(emp){
        const parts = [];
        if(a.nome_empreendimento) parts.push('<b>Empreendimento:</b> '+a.nome_empreendimento);
        const sub = [];
        if(a.total_fracoes) sub.push(`Fra√ß√µes: ${a.total_fracoes}`);
        if(a.tipologias) sub.push(`Tipologias: ${a.tipologias}`);
        if(a.ano_construcao) sub.push(`Ano constr.: ${a.ano_construcao}`);
        if(a.ano_conclusao) sub.push(`Ano concl.: ${a.ano_conclusao}`);
        if(sub.length) parts.push(sub.join(' ¬∑ '));
        if(a.nome_promotor) parts.push('<b>Promotor:</b> '+a.nome_promotor);
        if(a.contacto_promotor) parts.push('Tel. promotor: '+a.contacto_promotor);
        if(a.email_promotor) parts.push('Email promotor: '+a.email_promotor);
        linha2 = parts.length ? `<div class="row section-sep">${parts.join('<br>')}</div>` : '';
      } else {
        const ownerParts = [];
        if(a.proprietario) ownerParts.push('<b>Propriet√°rio:</b> '+a.proprietario);
        if(a.contacto) ownerParts.push('Contacto: '+a.contacto);
        if(a.email_proprietario) ownerParts.push('Email: '+a.email_proprietario);
        if(ownerParts.length) linha2 = `<div class="row section-sep">${ownerParts.join(' ¬∑ ')}</div>`;
      }

      // Linha 3 ‚Äì Im√≥vel
      const imovParts = [];
      if(a.titulo) imovParts.push('<b>Im√≥vel:</b> '+a.titulo);
      const locBits = [];
      if(a.loc_zona) locBits.push(a.loc_zona);
      if(a.loc_concelho) locBits.push(a.loc_concelho);
      if(a.loc_freguesia) locBits.push(a.loc_freguesia);
      if(locBits.length) imovParts.push('Localiza√ß√£o: '+locBits.join(' ¬∑ '));
      if(a.cert_energetico_classe) imovParts.push('Cert. Energ√©tico: '+a.cert_energetico_classe);
      const linha3 = imovParts.length ? `<div class="row section-sep">${imovParts.join('<br>')}</div>` : '';

      // Linha 4 ‚Äì Natureza / Estado / Neg√≥cio
      const natBits = [];
      if(a.negocio) natBits.push(a.negocio);
      if(a.natureza) natBits.push(a.natureza);
      if(a.estado_imovel) natBits.push(a.estado_imovel);
      const linha4 = natBits.length ? `<div class="row section-sep"><b>Natureza / Neg√≥cio:</b> ${natBits.join(' ‚Äî ')}</div>` : '';

      // Linha 5 ‚Äì √Åreas
      const areaBits = [];
      if(a.abp) areaBits.push(`ABP: ${fmtNum(a.abp)} m¬≤`);
      if(a.abd) areaBits.push(`ABD: ${fmtNum(a.abd)} m¬≤`);
      if(a.area_terreno) areaBits.push(`Terreno: ${fmtNum(a.area_terreno)} m¬≤`);
      if(a.area_implantacao) areaBits.push(`Implanta√ß√£o: ${fmtNum(a.area_implantacao)} m¬≤`);
      const linha5 = areaBits.length ? `<div class="row section-sep"><b>√Åreas:</b> ${areaBits.join(' ¬∑ ')}</div>` : '';

      // Linha 6 ‚Äì Pre√ßo / Comiss√£o / Ajustamento
      const precoBits = [];
      if(a.preco_pedido) precoBits.push('Pedido: '+fmtNum(a.preco_pedido)+' ‚Ç¨');
      if(a.preco_sugerido) precoBits.push('Sugerido: '+fmtNum(a.preco_sugerido)+' ‚Ç¨');
      if(a.comissao_pct!=='' && a.comissao_pct!==undefined) precoBits.push('Comiss√£o: '+a.comissao_pct+'%');
      if(a.ajustamento!=='' && a.ajustamento!==undefined) precoBits.push('Ajust.: '+fmtPct(a.ajustamento));
      const linha6 = precoBits.length ? `<div class="row section-sep"><b>Pre√ßo / Comiss√£o / Ajustamento:</b> ${precoBits.join(' ¬∑ ')}</div>` : '';

      const tooltip = [
        a.nome_empreendimento || a.titulo || '',
        emp ? (a.nome_promotor||'') : (a.proprietario||''),
        a.loc_concelho || a.loc_zona || ''
      ].filter(Boolean).join(' ‚Äî ');

      card.innerHTML = `
        <div class="top">
          <div>
            <div class="name">${a.nome_empreendimento || a.titulo || '‚Äî'}</div>
            <div class="meta">
              ${a.consultor ? 'Angariador: '+a.consultor : ''}
              ${a.consultor && a.gestor ? ' ¬∑ ' : ''}
              ${a.gestor ? 'Gestor: '+a.gestor : ''}
              ${a.ref ? ' ¬∑ Ref: '+a.ref : ''}
            </div>
          </div>
          <div>${badgeAj}</div>
        </div>

        ${linha2}
        ${linha3}
        ${linha4}
        ${linha5}
        ${linha6}

        <div class="row section-sep">
          <b>Data:</b> ${fmtDate(a.data)}
          ${a.duracao_contrato ? ' ¬∑ <b>Contrato:</b> '+a.duracao_contrato : ''}
          ${a.d_exclusivo ? ' ¬∑ Exclusivo' : ''}
          ${a.d_nao_exclusivo ? ' ¬∑ N√£o exclusivo' : ''}
        </div>

        <div class="row">
          ${badgeDocs} ${a.d_bupi ? ' ¬∑ <span class="badge">BUPI</span>' : ''}
        </div>

        ${a.notas ? `<div class="row"><small>${a.notas}</small></div>`:''}

        <div class="actions">
          <button class="btn-sm" data-act="edit" ${disabledAttr}>Editar</button>
          <button class="btn-sm" data-act="pdf" ${disabledAttr}>Ficha PDF</button>
          <select class="select-move" data-id="${a.id}" ${disabledAttr}>
            <option value="">Mover‚Ä¶</option>
            ${COLS.map(c=>`<option value="${c}" ${c===a.estado?'disabled':''}>${c}</option>`).join('')}
          </select>
          <button class="btn-sm danger" data-act="del" ${disabledAttr}>Apagar</button>
          <button class="btn-sm" data-act="toggle" ${disabledAttr}>${a.visivel===false?'Tornar vis√≠vel':'Tornar invis√≠vel'}</button>
        </div>
      `;
      card.title = tooltip;
      if(a.visivel===false) card.style.opacity = .45;

      card.querySelector('[data-act="edit"]').addEventListener('click',()=>{
        if(!EDIT_MODE){ alert('Modo de edi√ß√£o bloqueado. Ative "üîì Edi√ß√£o ativa" para editar.'); return; }
        openModal(a);
      });
      card.querySelector('[data-act="pdf"]').addEventListener('click',()=>{
        if(!EDIT_MODE){ alert('Modo de edi√ß√£o bloqueado. Ative "üîì Edi√ß√£o ativa" para gerar a ficha.'); return; }
        abrirFichaPdf(a);
      });
      card.querySelector('[data-act="del"]').addEventListener('click',()=>{
        if(!EDIT_MODE){ alert('Modo de edi√ß√£o bloqueado. Ative "üîì Edi√ß√£o ativa" para apagar.'); return; }
        if(!confirm('Eliminar esta angaria√ß√£o?')) return;
        ANG = ANG.filter(x=>x.id!==a.id);
        saveLS();
        renderBoard();
      });
      card.querySelector('[data-act="toggle"]').addEventListener('click',()=>{
        if(!EDIT_MODE){ alert('Modo de edi√ß√£o bloqueado. Ative "üîì Edi√ß√£o ativa" para alterar visibilidade.'); return; }
        a.visivel = a.visivel===false ? true : false;
        saveLS();
        renderBoard();
      });
      card.querySelector('.select-move').addEventListener('change',e=>{
        if(!EDIT_MODE){
          e.target.value='';
          alert('Modo de edi√ß√£o bloqueado. Ative "üîì Edi√ß√£o ativa" para mover.');
          return;
        }
        const destino = e.target.value;
        if(!destino || !COLS.includes(destino)) return;
        a.estado = destino;
        saveLS();
        renderBoard();
      });

      listEl.appendChild(card);
    });
  });
}

/* ===== PDF ===== */
function escapeHtml(str){
  return String(str||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}
function abrirFichaPdf(a){
  const w = window.open('', '_blank');
  if(!w){
    alert('O navegador bloqueou a janela de impress√£o. Autorize pop-ups para gerar o PDF.');
    return;
  }
  const logoUrl = 'logo-garvetur.png'; // coloque aqui o logo da Garvetur

  const html = `
<!doctype html>
<html lang="pt">
<head>
<meta charset="utf-8">
<title>Ficha de Angaria√ß√£o</title>
<style>
@page { margin:20mm; }
body{
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
  color:#222;
  font-size:11pt;
}
header{
  display:flex;
  align-items:center;
  gap:12px;
  border-bottom:2px solid #A38B63;
  padding-bottom:8px;
  margin-bottom:12px;
}
header img{
  height:40px;
}
header .title-block{
  display:flex;
  flex-direction:column;
}
header .title-block h1{
  margin:0;
  font-size:15pt;
  letter-spacing:.06em;
  text-transform:uppercase;
}
header .title-block span{
  font-size:9pt;
  color:#555;
}
h2{
  font-size:11pt;
  margin:14px 0 4px 0;
  color:#6A5530;
  border-bottom:1px solid #D0C2A2;
  padding-bottom:2px;
}
.section{
  margin-bottom:6px;
}
.grid-2{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:4px 12px;
}
.grid-3{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:4px 12px;
}
.row{
  margin:2px 0;
}
label{
  font-weight:600;
}
.small{
  font-size:9pt;
  color:#666;
}
hr{
  border:0;
  border-top:1px dashed #ccc;
  margin:8px 0;
}
</style>
</head>
<body>
<header>
  <img src="${logoUrl}" alt="Garvetur Luxury Porto" onerror="this.style.display='none'">
  <div class="title-block">
    <h1>Garvetur Luxury Porto</h1>
    <span>Ficha de Angaria√ß√£o</span>
  </div>
</header>

<div class="section">
  <h2>Cabe√ßalho</h2>
  <div class="grid-3">
    <div><label>Consultor:</label> ${escapeHtml(a.consultor||'')}</div>
    <div><label>Gestor:</label> ${escapeHtml(a.gestor||'')}</div>
    <div><label>Coordenador:</label> ${escapeHtml(a.coordenador||'')}</div>
    <div><label>Interveniente:</label> ${escapeHtml(a.interveniente||'')}</div>
    <div><label>Ref. Interna:</label> ${escapeHtml(a.ref||'')}</div>
    <div><label>Link:</label> ${escapeHtml(a.link_url||'')}</div>
  </div>
</div>

<div class="section">
  <h2>Empreendimento</h2>
  <div class="grid-3">
    <div><label>Nome:</label> ${escapeHtml(a.nome_empreendimento||'')}</div>
    <div><label>Total Fra√ß√µes:</label> ${escapeHtml(a.total_fracoes||'')}</div>
    <div><label>Tipologias:</label> ${escapeHtml(a.tipologias||'')}</div>
    <div><label>Ano constru√ß√£o:</label> ${escapeHtml(a.ano_construcao||'')}</div>
    <div><label>Ano conclus√£o:</label> ${escapeHtml(a.ano_conclusao||'')}</div>
  </div>
  <div class="grid-3">
    <div><label>Promotor:</label> ${escapeHtml(a.nome_promotor||'')}</div>
    <div><label>Contacto Promotor:</label> ${escapeHtml(a.contacto_promotor||'')}</div>
    <div><label>Email Promotor:</label> ${escapeHtml(a.email_promotor||'')}</div>
  </div>
</div>

<div class="section">
  <h2>Propriet√°rio</h2>
  <div class="grid-3">
    <div><label>Nome:</label> ${escapeHtml(a.proprietario||'')}</div>
    <div><label>Contacto:</label> ${escapeHtml(a.contacto||'')}</div>
    <div><label>Email:</label> ${escapeHtml(a.email_proprietario||'')}</div>
  </div>
  <div class="row"><label>Morada:</label> ${escapeHtml(a.loc_morada||'')}</div>
  <div class="grid-2">
    <div><label>Estado civil:</label> ${escapeHtml(a.estado_civil||'')}</div>
    <div><label>Regime casamento:</label> ${escapeHtml(a.regime||'')}</div>
  </div>
</div>

<div class="section">
  <h2>Im√≥vel</h2>
  <div class="grid-3">
    <div><label>T√≠tulo / Designa√ß√£o:</label> ${escapeHtml(a.titulo||'')}</div>
    <div><label>Localiza√ß√£o:</label> ${escapeHtml(a.loc_zona||'')}</div>
    <div><label>Certificado Energ√©tico:</label> ${escapeHtml(a.cert_energetico_classe||'')}</div>
  </div>
  <div class="grid-3">
    <div><label>Distrito:</label> ${escapeHtml(a.loc_distrito||'')}</div>
    <div><label>Concelho:</label> ${escapeHtml(a.loc_concelho||'')}</div>
    <div><label>Freguesia:</label> ${escapeHtml(a.loc_freguesia||'')}</div>
  </div>
  <div class="row"><label>Coordenadas GPS:</label> ${escapeHtml(a.loc_gps||'')}</div>
</div>

<div class="section">
  <h2>Natureza, estado e neg√≥cio</h2>
  <div class="grid-3">
    <div><label>Natureza:</label> ${escapeHtml(a.natureza||'')} ${a.natureza_outro? ' ('+escapeHtml(a.natureza_outro)+')':''}</div>
    <div><label>Estado do im√≥vel:</label> ${escapeHtml(a.estado_imovel||'')}</div>
    <div><label>Neg√≥cio:</label> ${escapeHtml(a.negocio||'')} ${a.negocio_outro? ' ('+escapeHtml(a.negocio_outro)+')':''}</div>
    <div><label>Data:</label> ${escapeHtml(a.data? new Date(a.data).toLocaleDateString('pt-PT'): '')}</div>
  </div>
</div>

<div class="section">
  <h2>√Åreas</h2>
  <div class="grid-3">
    <div><label>ABP:</label> ${fmtNum(a.abp)} m¬≤</div>
    <div><label>ABD:</label> ${fmtNum(a.abd)} m¬≤</div>
    <div><label>Terreno:</label> ${fmtNum(a.area_terreno)} m¬≤</div>
    <div><label>Implanta√ß√£o:</label> ${fmtNum(a.area_implantacao)} m¬≤</div>
  </div>
</div>

<div class="section">
  <h2>Pre√ßo, comiss√£o e ajustamento</h2>
  <div class="grid-3">
    <div><label>Pre√ßo pedido:</label> ${fmtNum(a.preco_pedido)} ‚Ç¨</div>
    <div><label>Pre√ßo sugerido:</label> ${fmtNum(a.preco_sugerido)} ‚Ç¨</div>
    <div><label>% Ajustamento:</label> ${fmtPct(a.ajustamento)}</div>
    <div><label>Comiss√£o:</label> ${a.comissao_pct? a.comissao_pct+'%' : '‚Äî'}</div>
    <div><label>Origem do cliente:</label> ${escapeHtml(a.origem||'')}</div>
    <div><label>Estado da angaria√ß√£o:</label> ${escapeHtml(a.estado||'')}</div>
  </div>
</div>

<div class="section">
  <h2>Destaques & Documenta√ß√£o</h2>
  <div class="row">
    <label>Destaques:</label>
    ${
      [
        a.d_exclusivo?'Exclusivo':'',
        a.d_nao_exclusivo?'N√£o exclusivo':'',
        a.d_luxo?'Luxo':'',
        a.d_banca?'Banca':'',
        a.d_golden_visa?'Golden Visa':'',
        a.d_rentab?'Rentabilidade Garantida':''
      ].filter(Boolean).join(' ¬∑ ')
    }
  </div>
  <div class="row"><label>Dura√ß√£o do contrato:</label> ${escapeHtml(a.duracao_contrato||'')}</div>
  <div class="small">
    Ident. Propriet√°rios: ${a.d_cc?'Sim':'N√£o'} ¬∑
    Contrato Media√ß√£o: ${a.d_contrato_med?'Sim':'N√£o'} ¬∑
    Caderneta: ${a.d_caderneta?'Sim':'N√£o'} ¬∑
    CRP: ${a.d_crp?'Sim':'N√£o'} ¬∑
    Cert. Energ√©tico: ${a.d_cert_energetico?'Sim':'N√£o'} ¬∑
    BUPI: ${a.d_bupi?'Sim':'N√£o'}
  </div>
</div>

<div class="section">
  <h2>Observa√ß√µes</h2>
  <div class="row">${escapeHtml(a.notas||'')}</div>
</div>

<div class="section">
  <h2>Notas internas</h2>
  <div class="row"><label>Consultor:</label> ${escapeHtml(a.notas_consultor||'')}</div>
  <div class="row"><label>Coordenador:</label> ${escapeHtml(a.notas_coordenador||'')}</div>
  <div class="row"><label>Assistente:</label> ${escapeHtml(a.notas_assistente||'')}</div>
</div>

<hr>
<div class="small">Gerado por Garvetur Porto Pro ‚Äî ${new Date().toLocaleString('pt-PT')}</div>

</body>
</html>
`;
  w.document.open();
  w.document.write(html);
  w.document.close();
  w.focus();
  w.print();
}

/* ===== Exporta√ß√£o CSV ===== */
function exportCsv(){
  const rows = [];
  const headers = [
    "ID","Empreendimento","TituloImovel","Tipologias",
    "Natureza","Negocio","EstadoImovel",
    "Proprietario","EmailProprietario","Consultor","Gestor","Coordenador","Interveniente",
    "Data","Ref","Link","EstadoAngariacao",
    "Morada","Zona","Concelho","Freguesia",
    "AnoConstrucao","AnoConclusao","CertEnerg","TotalFracoes",
    "ABP","ABD","AreaTerreno","AreaImplantacao",
    "PrecoPedido","PrecoSugerido","Comissao","Ajustamento",
    "Origem","Visivel","Notas","BUPI","DocsOK","DuracaoContrato"
  ];
  rows.push(headers);

  const data = filterDataset();
  data.forEach(a=>{
    const docsOk = (a.d_cc && a.d_contrato_med && a.d_caderneta && a.d_crp && a.d_cert_energetico) ? 'Sim':'N√£o';
    rows.push([
      a.id,
      a.nome_empreendimento||'',
      a.titulo||'',
      a.tipologias||'',
      a.natureza||'',
      a.negocio||'',
      a.estado_imovel||'',
      a.proprietario||'',
      a.email_proprietario||'',
      a.consultor||'',
      a.gestor||'',
      a.coordenador||'',
      a.interveniente||'',
      a.data||'',
      a.ref||'',
      a.link_url||'',
      a.estado||'',
      a.loc_morada||'',
      a.loc_zona||'',
      a.loc_concelho||'',
      a.loc_freguesia||'',
      a.ano_construcao||'',
      a.ano_conclusao||'',
      a.cert_energetico_classe||'',
      a.total_fracoes||'',
      a.abp||'',
      a.abd||'',
      a.area_terreno||'',
      a.area_implantacao||'',
      a.preco_pedido||'',
      a.preco_sugerido||'',
      (a.comissao_pct!==undefined && a.comissao_pct!==''? a.comissao_pct:''),
      (a.ajustamento!==undefined && a.ajustamento!==''? a.ajustamento:''),
      a.origem||'',
      (a.visivel===false?'N√£o':'Sim'),
      (a.notas||'').replace(/\r?\n/g,' '),
      a.d_bupi?'Sim':'N√£o',
      docsOk,
      a.duracao_contrato||''
    ]);
  });

  const csv = rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const aEl = document.createElement('a');
  aEl.href = url;
  aEl.download = 'angariacoes.csv';
  document.body.appendChild(aEl);
  aEl.click();
  aEl.remove();
  URL.revokeObjectURL(url);
}

/* ===== Init ===== */
(function init(){
  ANG = loadLS();
  loadFilters();

  const stored = localStorage.getItem(EDIT_KEY);
  EDIT_MODE = stored==='1';
  applyEditUI();

  $('toggleEdit').addEventListener('click',()=>{
    setEditMode(!EDIT_MODE);
  });

  $('exportCsv').addEventListener('click', exportCsv);

  renderBoard();
})();
</script>
</body>
</html>
