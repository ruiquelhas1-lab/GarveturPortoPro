

<!doctype html>
<html lang="pt">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Garvetur Porto Pro ‚Äî Mapa (PDF inteligente)</title>

<link rel="preconnect" href="https://unpkg.com" crossorigin>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>

<!-- Leaflet + Cluster CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" crossorigin="anonymous">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" crossorigin="anonymous">

<!-- PapaParse (CSV) -->
<script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js" crossorigin="anonymous" defer></script>

<!-- idb-keyval (IndexedDB) ‚Äî sem defer -->
<script src="https://cdn.jsdelivr.net/npm/idb-keyval@6/dist/idb-keyval.iife.min.js" crossorigin="anonymous"></script>

<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" crossorigin="anonymous"></script>
<script>
  if (window['pdfjsLib']) {
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
  }
</script>

<style>
:root{
  --gold:#A38B63;
  --bg:#0E0E0E;
  --panel:#131313;
  --text:#fff;
  --muted:#9AA0A6;
  --ok:#43A047;
  --info:#1E88E5;
  --warn:#E53935;
  --border:rgba(255,255,255,.12);
}

html,body{
  height:100%;
  margin:0;
  background:#0E0E0E;
  color:var(--text);
  font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
}
a{color:#e6e6e6;text-decoration:none}

.app{
  display:grid;
  grid-template-columns:380px 1fr;
  grid-template-rows:56px 40px 1fr;
  height:100%;
}

/* Header / barra superior */
header{
  grid-column:1 / span 2;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:10px 12px;
  border-bottom:1px solid var(--border);
  background:linear-gradient(90deg,#050505,#111,#050505);
}
.brand{
  display:flex;
  align-items:center;
  gap:10px;
}
.brand h1{
  font-size:16px;
  margin:0;
  color:var(--gold);
}
.nav{
  display:flex;
  gap:6px;
  flex-wrap:wrap;
}
.nav a{
  border:1px solid var(--border);
  padding:6px 10px;
  border-radius:999px;
  color:#ddd;
  font-size:11px;
  text-transform:uppercase;
  letter-spacing:.12em;
}
.nav a.active{
  background:var(--gold);
  color:#111;
  border-color:var(--gold);
  font-weight:700;
}

/* KPIs */
.kpis{
  grid-column:1 / span 2;
  display:flex;
  gap:8px;
  align-items:center;
  padding:6px 12px;
  background:#0F0F0F;
  border-bottom:1px solid var(--border);
}
.kpi{
  display:flex;
  align-items:center;
  gap:6px;
  border:1px solid var(--border);
  border-radius:10px;
  padding:6px 10px;
  font-size:12px;
}
.dot{
  width:10px;
  height:10px;
  border-radius:50%;
  background:#999;
  display:inline-block;
  border:1px solid rgba(0,0,0,.2);
}
.dot.c{background:var(--warn)}
.dot.l{background:var(--info)}
.dot.f{background:var(--ok)}
.toolbar{
  margin-left:auto;
  display:flex;
  gap:6px;
  flex-wrap:wrap;
}
.btn{
  background:transparent;
  border:1px solid rgba(163,139,99,.5);
  color:#fff;
  padding:6px 10px;
  border-radius:10px;
  cursor:pointer;
  font-size:12px;
}
.btn.primary{
  background:var(--gold);
  color:#111;
  border-color:var(--gold);
  font-weight:700;
}
.btn.ghost{
  border-color:var(--border);
  color:#ddd;
}
.btn-sm{
  font-size:12px;
  border:1px solid var(--border);
  padding:4px 8px;
  border-radius:8px;
  background:transparent;
  color:#eee;
}
input[type="file"]{display:none}

/* Sidebar */
.sidebar{
  background:var(--panel);
  border-right:1px solid var(--border);
  overflow:auto;
}
.section{
  padding:10px;
  border-bottom:1px solid rgba(255,255,255,.08);
}
.hint{
  font-size:11px;
  color:#bdbdbd;
}
.label{
  font-size:12px;
  color:#cfcfcf;
  margin:6px 0 4px;
}
.field{
  display:flex;
  gap:6px;
}
.field input,.field select{
  flex:1;
  background:#0E0E0E;
  border:1px solid rgba(255,255,255,.15);
  border-radius:8px;
  padding:8px 10px;
  color:#fff;
  outline:none;
}
.chips{
  display:flex;
  flex-wrap:wrap;
  gap:6px;
  margin-top:6px;
}
.chip{
  font-size:12px;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.16);
  background:#0E0E0E;
  color:#ddd;
  cursor:pointer;
}
.chip.active{
  background:var(--gold);
  color:#111;
  border-color:var(--gold);
  font-weight:700;
}
.list{
  padding:8px 12px;
}

/* Cart√µes de resultados */
.card{
  border:1px solid rgba(163,139,99,.25);
  border-radius:12px;
  padding:12px 12px 10px;
  margin-bottom:12px;
  background:#0E0E0E;
}
.card .row{
  display:flex;
  justify-content:space-between;
  gap:8px;
  align-items:center; /* garante alinhamento vertical entre t√≠tulo e badge de estado */
}
.card .name{
  font-weight:700;
}
.card .meta{
  font-size:11px;
  color:#bbb;
  text-transform:uppercase;
  letter-spacing:.05em;
  margin-top:4px;
  display:flex;          /* mant√©m concelho + badge de tipo na mesma linha */
  align-items:center;
  gap:6px;
  flex-wrap:wrap;
}
.card .state{
  font-size:12px;
  color:#bbb;
  margin-top:6px;
  line-height:1.4;
}
.card .actions{
  display:flex;
  gap:8px;
  margin-top:10px;
  flex-wrap:wrap;
}

/* Badges gen√©ricos */
.badge{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  padding:3px 10px;
  border-radius:999px;
  border:1px solid var(--border);
  font-size:11px;
  line-height:1;
  white-space:nowrap;   /* n√£o quebra a meio da palavra */
}

/* Badges espec√≠ficos de ESTADO ‚Äî tamanho uniforme */
.badge-estado{
  min-width:100px;       /* largura fixa para ‚ÄúEm constru√ß√£o / Licenciado / Conclu√≠do‚Äù */
  justify-content:center;
  text-transform:uppercase;
}

.empty{
  padding:10px;
  color:#bbb;
  font-size:13px;
}

/* Mapa */
#map{
  width:100%;
  height:100%;
}
.leaflet-container{background:#eaeaea}

/* Legenda */
.legend{
  position:absolute;
  left:12px;
  bottom:16px;
  z-index:5000;
  background:#111;
  border:1px solid var(--border);
  border-radius:10px;
  padding:8px 10px;
  font-size:12px;
  color:#fff;
}
.legend .row{
  display:flex;
  gap:8px;
  align-items:center;
}
.legend .swatch{
  width:12px;
  height:12px;
  border-radius:3px;
  border:1px solid rgba(0,0,0,.3);
}
.legend .c{background:#E53935}
.legend .l{background:#1E88E5}
.legend .f{background:#43A047}

/* Mensagem discreta topo mapa */
.status-bar{
  position:absolute;
  top:8px;
  left:50%;
  transform:translateX(-50%);
  background:rgba(10,10,10,.95);
  border-radius:999px;
  border:1px solid var(--border);
  padding:4px 10px;
  font-size:11px;
  color:var(--muted);
  z-index:6000;
  display:none;
}
.status-bar.show{
  display:flex;
  align-items:center;
  gap:6px;
}

/* Painel lateral detalhes */
#side-panel{
  position:absolute;
  right:12px;
  top:80px;
  bottom:12px;
  width:min(470px,92vw);
  z-index:5001;
  background:#0F0F0F;
  border:1px solid var(--border);
  border-radius:12px;
  overflow:auto;
  display:none;
}
#side-panel.show{display:block}
.panel-head{
  position:sticky;
  top:0;
  background:#0F0F0F;
  border-bottom:1px solid var(--border);
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:10px 12px;
}
.panel-inner{padding:12px}
.meta-line{
  font-size:13px;
  margin:4px 0;
  color:#ddd;
}

/* Pins base (empreendimentos) ‚Äî c√≠rculo cheio */
.pin{
  width:28px;
  height:28px;
  border-radius:50%;
  border:2px solid #111;
  box-shadow:0 2px 6px rgba(0,0,0,.35);
  display:flex;
  align-items:center;
  justify-content:center;
  color:#fff;
  font-weight:800;
  font-size:12px;
  position:relative;
}

/* ESTADOS ‚Äî tamb√©m definem "color" para os isolados usarem currentColor no anel */
.pin.c{ background:#E53935; color:#E53935; }
.pin.l{ background:#1E88E5; color:#1E88E5; }
.pin.f{ background:#43A047; color:#43A047; }

/* Pulso apenas para empreendimentos em constru√ß√£o (n√£o aplica aos isolados) */
.pin:not(.iso).c::after{
  content:"";
  position:absolute;
  width:28px;
  height:28px;
  border-radius:50%;
  box-shadow:0 0 0 0 rgba(229,57,53,.55);
  animation:pulse 1.8s ease-out infinite;
}

/* Pins especiais para IM√ìVEIS ISOLADOS: anel circular oco */
.pin.iso{
  width:28px;
  height:28px;
  border-radius:50%;
  border:3px solid currentColor;   /* cor do estado (verde, azul, vermelho) */
  background:transparent;          /* interior transparente */
  box-shadow:0 2px 6px rgba(0,0,0,.35);
  position:relative;
}

/* c√≠rculo interior s√≥ para dar ‚Äúespessura‚Äù ao anel e contraste */
.pin.iso::before{
  content:"";
  position:absolute;
  inset:6px;                       /* controla a espessura do anel */
  border-radius:50%;
  border:2px solid rgba(0,0,0,.65); /* ligeiro aro interior escuro */
  background:transparent;
}

/* nenhum ::after para os isolados ‚Äî sem pulso */

@keyframes pulse{
  0%{ box-shadow:0 0 0 0 rgba(229,57,53,.55)}
  70%{ box-shadow:0 0 0 18px rgba(229,57,53,0)}
  100%{ box-shadow:0 0 0 0 rgba(229,57,53,0)}
}

/* Modal edi√ß√£o */
.modal-backdrop{
  display:none;
  position:fixed;
  inset:0;
  z-index:10000;
  background:rgba(0,0,0,.6);
  backdrop-filter:blur(2px);
  align-items:center;
  justify-content:center;
  padding:16px;
}
.modal-backdrop.show{display:flex}
.modal{
  width:min(900px,96vw);
  background:#0F0F0F;
  border:1px solid var(--border);
  border-radius:12px;
  overflow:hidden;
}
.modal header{
  padding:10px 12px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  border-bottom:1px solid var(--border);
}
.modal .content{
  padding:12px;
  max-height:72vh;
  overflow:auto;
}
.grid2{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
}
.form-field{
  display:flex;
  flex-direction:column;
  gap:6px;
}
.form-field input,.form-field select,.form-field textarea{
  background:#0E0E0E;
  border:1px solid rgba(255,255,255,.15);
  border-radius:8px;
  padding:8px 10px;
  color:#fff;
  outline:none;
}
.doc-row{
  display:grid;
  grid-template-columns:1fr 120px 1fr auto;
  gap:6px;
  align-items:center;
}
.doc-row .del{
  border-color:#cc4b4b;
  color:#ffdddd;
}

/* Modal PDF fullscreen */
.pdf-backdrop{
  display:none;
  position:fixed;
  inset:0;
  z-index:11000;
  background:rgba(0,0,0,.6);
  backdrop-filter:blur(2px);
  align-items:center;
  justify-content:center;
  padding:16px;
}
.pdf-backdrop.show{display:flex}
.pdf-card{
  width:min(1100px,96vw);
  height:min(88vh,900px);
  background:#0F0F0F;
  border:1px solid var(--border);
  border-radius:12px;
  overflow:hidden;
  display:flex;
  flex-direction:column;
}
.pdf-card header{
  padding:8px 10px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  border-bottom:1px solid var(--border);
}
.pdf-card .frame{flex:1}
.pdf-card iframe{
  width:100%;
  height:100%;
  border:0;
}

/* Loading mask para anexos grandes */
#loadingMask{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.35);
  z-index:12000;
  display:none;
  align-items:center;
  justify-content:center;
  color:#fff;
  font-weight:700;
  font-size:14px;
}
#loadingMask.show{display:flex}

.hidden{display:none !important}

@media (max-width: 1000px){
  .app{
    grid-template-columns:1fr;
    grid-template-rows:56px 40px 280px 1fr;
  }
  .sidebar{grid-row:3}
  #map{grid-row:4}
  #side-panel{top:auto;bottom:72px}
}
</style>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" style="color:var(--gold)">
          <circle cx="12" cy="12" r="10" stroke-width="1.5"/>
          <path d="M8 12l2.5 2.5L16 9" stroke-width="1.8"/>
        </svg>
        <h1>Garvetur Porto Pro ‚Äî Mapa</h1>
      </div>
      <div class="nav">
        <a href="./index.html">In√≠cio</a>
        <a class="active" href="./mapa.html">Mapa</a>
        <a href="./kanban.html">Leads</a>
        <a href="./angariacoes.html">Angaria√ß√µes</a>
        <a href="./dashboard.html">Dashboard</a>
        <a href="./vendas.html">Vendas</a>
        <a href="./tarefas.html">Tarefas</a>
      </div>
    </header>

       <div class="kpis">
      <div class="kpi"><span class="dot"></span>Total: <b id="k_total">0</b></div>
      <div class="kpi"><span class="dot c"></span>Em constru√ß√£o: <b id="k_c">0</b></div>
      <div class="kpi"><span class="dot l"></span>Licenciado: <b id="k_l">0</b></div>
      <div class="kpi"><span class="dot f"></span>Conclu√≠do: <b id="k_f">0</b></div>
      <div class="toolbar">
        <button class="btn" id="focusAmp">Focar AMP/Porto</button>
        <button class="btn" id="exportCsv">Exportar CSV</button>
        <button class="btn" id="exportGeo">Exportar GeoJSON</button>
        <button class="btn ghost" id="toggleEdit" title="Modo Edi√ß√£o">üîí Editar</button>

        <label class="btn" for="csvFile" id="btnImport" style="display:none">Importar CSV</label>
        <input id="csvFile" type="file" accept=".csv" />
        <button class="btn primary" id="btnNew" style="display:none">+ Novo</button>
        <button class="btn ghost" id="btnSave" style="display:none">Guardar</button>
        <button class="btn ghost" id="btnClearAll" style="display:none">Limpar Tudo</button>

        <!-- Bot√µes de backup OneDrive -->
        <button class="btn" id="backupOneDrive">Backup OneDrive</button>
        <button class="btn ghost" id="restoreBackup">Restaurar</button>
      </div>
    </div>

    <aside class="sidebar">
      <div class="section">
        <div class="label">Pesquisa global</div>
        <div class="field"><input id="q" placeholder="Ex.: 'Gaia licenciado 2027 promotor X'"></div>
        <div class="hint">
          Pesquisa por ref. interna, nome, concelho, promotor, tipologias, estado, propriet√°rio, contactos,
          conclus√£o, notas, ‚Ç¨/m¬≤ e pre√ßo pedido.
        </div>
      </div>
      <div class="section">
        <div class="label">Concelho</div>
        <div class="field"><select id="f_concelho"><option value="">(Todos)</option></select></div>
        <div class="label">Estado</div>
        <div class="chips" id="estadoChips">
          <div class="chip active" data-v="">Todos</div>
          <div class="chip" data-v="em_construcao">Em constru√ß√£o</div>
          <div class="chip" data-v="licenciado">Licenciado</div>
          <div class="chip" data-v="concluido">Conclu√≠do</div>
        </div>
        <div class="label" style="margin-top:6px">Tipo</div>
        <div class="chips" id="tipoChips">
          <div class="chip active" data-v="">Todos</div>
          <div class="chip" data-v="emp">Empreendimentos</div>
          <div class="chip" data-v="iso">Im√≥veis isolados</div>
        </div>
      </div>
      <div class="section">
        <div class="label">Conclus√£o (ano)</div>
        <div class="field">
          <input id="f_cmin" type="number" placeholder="M√≠n. ex.: 2025">
          <input id="f_cmax" type="number" placeholder="M√°x. ex.: 2029">
        </div>
        <div class="label" style="margin-top:6px">Pre√ßo ‚Ç¨/m¬≤</div>
        <div class="field">
          <input id="f_pmin" type="number" placeholder="M√≠n.">
          <input id="f_pmax" type="number" placeholder="M√°x.">
        </div>
        <div class="label" style="margin-top:6px">Pre√ßo pedido (‚Ç¨)</div>
        <div class="field">
          <input id="f_vmin" type="number" placeholder="M√≠n.">
          <input id="f_vmax" type="number" placeholder="M√°x.">
        </div>
      </div>
      <div class="section">
        <div class="label">Promotor</div>
        <div class="field"><select id="f_promotor"><option value="">(Todos)</option></select></div>
        <div class="label" style="margin-top:6px">Tipologias (texto)</div>
        <div class="field"><input id="f_tipos" placeholder="Ex.: T1,T2"></div>
      </div>
      <div class="section">
        <div class="actions">
          <button class="btn primary" id="apply">Aplicar</button>
          <button class="btn ghost" id="clear">Limpar</button>
        </div>
      </div>
      <div class="section"><div class="label">Resultados</div></div>
      <div class="list" id="list"></div>
    </aside>

    <div style="position:relative">
      <div id="map"></div>

      <!-- Barra discreta de estado / carregamento -->
      <div id="statusBar" class="status-bar"></div>

      <div class="legend">
        <div class="row"><span class="swatch c"></span> Em constru√ß√£o</div>
        <div class="row"><span class="swatch l"></span> Licenciado</div>
        <div class="row"><span class="swatch f"></span> Conclu√≠do</div>
      </div>

      <div id="side-panel">
        <div class="panel-head">
          <div style="font-weight:700">Detalhes</div>
          <button class="btn" id="closePanel">Fechar ‚úï</button>
        </div>
        <div class="panel-inner" id="panelInner"></div>
      </div>
    </div>
  </div>

<!-- Modal Empreendimento -->
<div id="editModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-label="Empreendimento">
  <div class="modal">
    <header>
      <div><strong id="editTitle">Novo Empreendimento</strong></div>
      <div style="display:flex;gap:8px">
        <button class="btn ghost" id="pickCoord">Definir no mapa</button>
        <label class="btn" id="attachLocalLabel" for="attachLocalInput" style="display:none">üìé Anexar ficheiro</label>
        <input id="attachLocalInput" type="file" accept="application/pdf,image/*" style="display:none">
        <button class="btn" id="cancelEdit">Cancelar</button>
        <button class="btn primary" id="saveEdit">Guardar</button>
      </div>
    </header>
    <div class="content">
      <div class="grid2">
        <div class="form-field"><label>Nome</label><input id="f_nome"></div>
        <div class="form-field"><label>Concelho</label><input id="f_concelho_e"></div>
        <div class="form-field"><label>Estado</label>
          <select id="f_estado">
            <option value="">‚Äî</option>
            <option value="em_construcao">Em constru√ß√£o</option>
            <option value="licenciado">Licenciado</option>
            <option value="concluido">Conclu√≠do</option>
          </select>
        </div>
        <div class="form-field"><label>Promotor</label><input id="f_promotor_e"></div>
        <div class="form-field"><label>Tipologias</label><input id="f_tipologias"></div>
        <!-- Conclus√£o m√™s/ano -->
        <div class="form-field">
          <label>Conclus√£o (m√™s/ano)</label>
          <div style="display:flex; gap:6px;">
            <select id="f_conclusao_mes">
              <option value="">M√™s</option>
              <option value="1">Jan</option>
              <option value="2">Fev</option>
              <option value="3">Mar</option>
              <option value="4">Abr</option>
              <option value="5">Mai</option>
              <option value="6">Jun</option>
              <option value="7">Jul</option>
              <option value="8">Ago</option>
              <option value="9">Set</option>
              <option value="10">Out</option>
              <option value="11">Nov</option>
              <option value="12">Dez</option>
            </select>
            <input id="f_conclusao_ano" type="number" min="1900" max="2100" placeholder="Ano">
          </div>
        </div>
        <div class="form-field"><label>‚Ç¨/m¬≤</label><input id="f_preco" type="number" min="0" step="1"></div>
        <div class="form-field"><label>Link</label><input id="f_link"></div>
        <div class="form-field"><label>Latitude</label><input id="f_lat" type="number" step="0.000001"></div>
        <div class="form-field"><label>Longitude</label><input id="f_lng" type="number" step="0.000001"></div>
        <div class="form-field" style="grid-column:1 / span 2"><label>Notas</label><textarea id="f_notas" rows="3"></textarea></div>
      </div>

      <div style="margin-top:10px">
        <div class="label">Documentos & Media</div>
        <div id="docsBox"></div>
        <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap">
          <button class="btn" id="addDoc">+ Adicionar documento (URL)</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal PDF fullscreen -->
<div id="pdfModal" class="pdf-backdrop" role="dialog" aria-modal="true" aria-label="Documento">
  <div class="pdf-card">
    <header>
      <div><strong>Documento</strong></div>
      <div style="display:flex;gap:8px">
        <a id="pdfOpenNew" class="btn" target="_blank" rel="noreferrer">Abrir em nova aba</a>
        <button class="btn" id="pdfClose">Fechar ‚úï</button>
      </div>
    </header>
    <div class="frame"><iframe id="pdfFrame"></iframe></div>
  </div>
</div>

<!-- Loading mask -->
<div id="loadingMask"><div>‚è≥ A guardar anexo‚Ä¶</div></div>

<script>
/* ===== Helpers de carregamento din√¢mico ===== */
function loadScript(src){
  return new Promise((res,rej)=>{
    const s=document.createElement('script');
    s.src=src; s.defer=true; s.crossOrigin='anonymous';
    s.onload=()=>res(true); s.onerror=()=>rej(new Error('Falha a carregar '+src));
    document.head.appendChild(s);
  });
}
</script>

<script>
/* ===== Estado global ===== */
const AMP_CENTER=[41.15,-8.61], AMP_ZOOM=12;
const LS_KEY='gpp_dataset_v1';
const FILTERS_KEY='gpp_mapa_filters_v1';
const PDF_INLINE_LIMIT=4*1024*1024; // 4 MB

let MAP, CLUSTER, LAYER, CLUSTER_OK=false;
let RAW=[], FILT=[];
let ACTIVE=null;
let EDIT_MODE=false;
let EDIT_INDEX=-1;
let PICKING=false;
let UIState={
  q:'', concelho:'', estado:'',
  cmin:'', cmax:'',
  pmin:'', pmax:'',
  vmin:'', vmax:'',
  promotor:'', tipos:'',
  tipo:''
};

let LS_SKIPPED=false;
let LS_ERROR=false;

const el=id=>document.getElementById(id);
function norm(s){return String(s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');}
function stateKey(s){
  const x=norm(s);
  if(x.includes('constr'))return 'em_construcao';
  if(x.includes('licen'))return 'licenciado';
  if(x.includes('concl'))return 'concluido';
  return x||'';
}
function colorByState(k){
  if(k==='em_construcao')return '#E53935';
  if(k==='licenciado')return '#1E88E5';
  if(k==='concluido')return '#43A047';
  return '#A38B63';
}
function toCSV(rows){
  return rows.map(r=>r.map(v=>`"${String(v??'').replaceAll('"','""')}"`).join(',')).join('\n');
}
function slugify(s){ return norm(s).replace(/\s+/g,'-').replace(/[^a-z0-9\-]/g,''); }
function numPT(v){
  if(v===null||v===undefined||v==='') return null;
  const n=Number(String(v).replace(',','.'));
  return Number.isFinite(n)? n : null;
}

/* Parser simples de coordenadas GPS vindas das angaria√ß√µes */
function parseGps(gps){
  if(!gps) return {lat:null,lng:null};
  const m = String(gps).match(/-?\d+(?:[.,]\d+)?/g);
  if(!m || m.length<2) return {lat:null,lng:null};
  const lat = numPT(m[0]);
  const lng = numPT(m[1]);
  return {lat,lng};
}

/* ===== Formata√ß√£o conclus√£o (m√™s/ano) ===== */
function formatConclusao(p){
  const ano = p.conclusaoAno || p.conclusao;
  const mes = p.conclusaoMes;
  if(!ano && !mes) return '‚Äî';
  if(!ano) return '‚Äî';
  if(!mes) return String(ano);
  const m = String(mes).padStart(2,'0');
  return `${m}/${ano}`;
}

/* Formatador simples de pre√ßo pedido */
function formatPrecoPedido(p){
  const n = numPT(p.precoPedido);
  if(n===null) return '‚Äî';
  return n.toLocaleString('pt-PT') + ' ‚Ç¨';
}

/* ===== Barra de estado ===== */
function setStatus(msg){
  const bar = el('statusBar');
  if(!bar) return;
  if(!msg){
    bar.classList.remove('show');
    bar.textContent='';
    return;
  }
  bar.textContent = msg;
  bar.classList.add('show');
}

/* ===== Leaflet & Cluster ===== */
async function loadLeafletAndCluster(){
  if(!window.L){
    try{ await loadScript('https://unpkg.com/leaflet@1.9.4/dist/leaflet.js'); }
    catch{ await loadScript('https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js'); }
  }
  try{
    if(!window.L.markerClusterGroup){
      try{ await loadScript('https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js'); }
      catch{ await loadScript('https://cdn.jsdelivr.net/npm/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js'); }
    }
    CLUSTER_OK=!!window.L.markerClusterGroup;
  }catch{
    CLUSTER_OK=false;
  }
}
function initMap(){
  MAP = L.map('map',{ zoomControl:true, scrollWheelZoom:true }).setView(AMP_CENTER, AMP_ZOOM);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    maxZoom:19,
    attribution:'&copy; OpenStreetMap'
  }).addTo(MAP);
  if(CLUSTER_OK){
    const clusterOpts={ spiderfyOnEveryZoom:false, showCoverageOnHover:false, maxClusterRadius:48 };
    CLUSTER=L.markerClusterGroup(clusterOpts);
    LAYER=L.layerGroup().addTo(CLUSTER);
    MAP.addLayer(CLUSTER);
  }else{
    LAYER=L.layerGroup().addTo(MAP);
  }
  el('focusAmp').addEventListener('click',()=>MAP.setView(AMP_CENTER,AMP_ZOOM,{animate:true}));
}

/* ===== Filtros: persist√™ncia ===== */
function loadFilterState(){
  try{
    const raw = localStorage.getItem(FILTERS_KEY);
    if(!raw) return;
    const obj = JSON.parse(raw);
    if(!obj || typeof obj !== 'object') return;

    UIState.q        = obj.q        || '';
    UIState.concelho = obj.concelho || '';
    UIState.estado   = obj.estado   || '';
    UIState.cmin     = obj.cmin     || '';
    UIState.cmax     = obj.cmax     || '';
    UIState.pmin     = obj.pmin     || '';
    UIState.pmax     = obj.pmax     || '';
    UIState.vmin     = obj.vmin     || '';
    UIState.vmax     = obj.vmax     || '';
    UIState.promotor = obj.promotor || '';
    UIState.tipos    = obj.tipos    || '';
    UIState.tipo     = obj.tipo     || '';

    if(el('q'))           el('q').value           = UIState.q;
    if(el('f_concelho'))  el('f_concelho').value  = UIState.concelho;
    if(el('f_cmin'))      el('f_cmin').value      = UIState.cmin;
    if(el('f_cmax'))      el('f_cmax').value      = UIState.cmax;
    if(el('f_pmin'))      el('f_pmin').value      = UIState.pmin;
    if(el('f_pmax'))      el('f_pmax').value      = UIState.pmax;
    if(el('f_vmin'))      el('f_vmin').value      = UIState.vmin;
    if(el('f_vmax'))      el('f_vmax').value      = UIState.vmax;
    if(el('f_promotor'))  el('f_promotor').value  = UIState.promotor;
    if(el('f_tipos'))     el('f_tipos').value     = UIState.tipos;

    // Estado (chips)
    const chips = document.querySelectorAll('#estadoChips .chip');
    chips.forEach(c => c.classList.remove('active'));
    let matched = false;
    chips.forEach(c=>{
      if((c.dataset.v || '') === UIState.estado){
        c.classList.add('active');
        matched = true;
      }
    });
    if(!matched){
      const chipTodos = document.querySelector('#estadoChips .chip[data-v=""]');
      if(chipTodos) chipTodos.classList.add('active');
      UIState.estado = '';
    }

    // Tipo (Empreendimento / Isolado)
    const chipsTipo = document.querySelectorAll('#tipoChips .chip');
    chipsTipo.forEach(c => c.classList.remove('active'));
    matched = false;
    chipsTipo.forEach(c=>{
      if((c.dataset.v || '') === UIState.tipo){
        c.classList.add('active');
        matched = true;
      }
    });
    if(!matched){
      const chipT = document.querySelector('#tipoChips .chip[data-v=""]');
      if(chipT) chipT.classList.add('active');
      UIState.tipo = '';
    }
  }catch(e){
    console.error('Erro a carregar filtros do mapa', e);
  }
}
function saveFilterStateFromUI(){
  const obj = { ...UIState };
  try{
    localStorage.setItem(FILTERS_KEY, JSON.stringify(obj));
  }catch(e){
    console.error('Erro a guardar filtros do mapa', e);
  }
}

/* ===== Facetas / Filtros ===== */
function buildFacetOptions(){
  const concelhos=[...new Set(RAW.map(x=>x.concelho).filter(Boolean))].sort();
  const promotores=[...new Set(RAW.map(x=>x.promotor).filter(Boolean))].sort();
  el('f_concelho').innerHTML='<option value="">(Todos)</option>'+concelhos.map(c=>`<option>${c}</option>`).join('');
  el('f_promotor').innerHTML='<option value="">(Todos)</option>'+promotores.map(c=>`<option>${c}</option>`).join('');
}

/* ===== Match/Pesquisa (inclui propriet√°rio, contactos e pre√ßos) ===== */
function matchTokens(obj,tokens){
  if(!tokens.length) return true;

  const hay=norm([
    obj.refInterna,
    obj.nome,
    obj.concelho,
    obj.promotor,
    obj.tipologias,
    obj.estado,
    obj.notas,
    obj.conclusao,
    obj.preco_m2,
    obj.precoPedido,
    obj._ownerNome,
    obj._ownerTelefone,
    obj._ownerTelemovel,
    obj._contactos
  ].join(' '));

  return tokens.every(tok=>hay.includes(tok));
}

function applyFilters(){
  const tokens=norm(UIState.q).split(/\s+/).filter(Boolean);
  const tiposTokens=norm(UIState.tipos||'').split(/[,\s]+/).filter(Boolean);

  FILT=RAW.filter(p=>{
    if(!matchTokens(p,tokens)) return false;
    if(UIState.concelho && p.concelho!==UIState.concelho) return false;
    if(UIState.estado && p.estado!==UIState.estado) return false;

    // Filtro por tipo (Empreendimento vs Isolado)
    if(UIState.tipo === 'emp'){
      // Empreendimento = tudo o que n√£o for explicitamente isolado
      if(p.isEmpreendimento === false) return false;
    }else if(UIState.tipo === 'iso'){
      if(p.isEmpreendimento !== false) return false;
    }

    const ano = p.conclusaoAno || p.conclusao;
    const c = numPT(ano);
    if(UIState.cmin && c!==null && c<Number(UIState.cmin)) return false;
    if(UIState.cmax && c!==null && c>Number(UIState.cmax)) return false;

    const m2=numPT(p.preco_m2);
    if(UIState.pmin && m2!==null && m2<Number(UIState.pmin)) return false;
    if(UIState.pmax && m2!==null && m2>Number(UIState.pmax)) return false;

    const precoTot = numPT(p.precoPedido);
    if(UIState.vmin && precoTot!==null && precoTot<Number(UIState.vmin)) return false;
    if(UIState.vmax && precoTot!==null && precoTot>Number(UIState.vmax)) return false;

    if(UIState.promotor && p.promotor!==UIState.promotor) return false;
    if(tiposTokens.length){
      const base=norm(p.tipologias||'');
      const hit=tiposTokens.some(t=>base.includes(t));
      if(!hit) return false;
    }
    return true;
  });
}
function renderKPIs(){
  const t=FILT.length;
  const c=FILT.filter(x=>x.estado==='em_construcao').length;
  const l=FILT.filter(x=>x.estado==='licenciado').length;
  const f=FILT.filter(x=>x.estado==='concluido').length;
  el('k_total').textContent=t;
  el('k_c').textContent=c;
  el('k_l').textContent=l;
  el('k_f').textContent=f;
}

/* ===== Helpers de apresenta√ß√£o ===== */
function stateLabel(s){
  const c=colorByState(s);
  return `<span class="badge badge-estado" style="border-color:${c};color:${c}">${s||'‚Äî'}</span>`;
}
function tipoLabel(p){
  if(p.isEmpreendimento === false) return 'Im√≥vel isolado';
  return 'Empreendimento';
}
function tipoBadge(p){
  const t=tipoLabel(p);
  if(!t) return '';
  return `<span class="badge" style="border-color:var(--gold);color:var(--gold);margin-left:4px">${t}</span>`;
}

/* ===== Lista ===== */
/* ===== Lista ===== */
function renderList(){
  const box = el('list');
  box.innerHTML = '';

  if (!FILT.length) {
    box.innerHTML = '<div class="empty">Sem resultados com os filtros atuais.</div>';
    return;
  }

  FILT.forEach(p => {
    // T√çTULO: apenas o nome
    const nameLine = `${p.nome || '‚Äî'}`;
    const div = document.createElement('div');
    div.className = 'card';
    const precoPedidoStr = formatPrecoPedido(p);

    div.innerHTML = `
      <div class="row">
        <div>
          <div class="name">${nameLine}</div>
          <div class="meta">
            ${p.refInterna ? `<span>${p.refInterna}</span> ¬∑ ` : ''}
            <span>${p.concelho || '‚Äî'}</span>
            ${tipoBadge(p)}
          </div>
        </div>
        ${stateLabel(p.estado)}
      </div>
      <div class="state">
        Conclus√£o: ${formatConclusao(p)}
        ¬∑ ‚Ç¨/m¬≤: ${
          p.preco_m2
            ? Number(String(p.preco_m2).replace(',', '.')).toLocaleString('pt-PT')
            : '‚Äî'
        }
        ¬∑ Pre√ßo: ${precoPedidoStr}
      </div>
      <div class="actions">
        <button class="btn" data-act="zoom">Abrir no mapa</button>
        ${p.link
          ? `<a class="btn" href="${p.link}" target="_blank" rel="noreferrer">Abrir link</a>`
          : ''
        }
        <button class="btn" data-act="open">Detalhes</button>
        ${
          p._fromAngariacoes && p.refInterna
            ? `
          <a class="btn" data-act="ang"
             href="./angariacoes.html?ref=${encodeURIComponent(p.refInterna)}&abrir=1"
             target="_blank" rel="noreferrer">
            Ficha angaria√ß√£o
          </a>`
            : ''
        }
        ${
          EDIT_MODE
            ? `
          <button class="btn ghost" data-act="edit">Editar</button>
          <button class="btn"
                  style="border-color:#cc4b4b;color:#ffdddd"
                  data-act="del">Apagar</button>`
            : ''
        }
      </div>
    `;

    // A√ß√µes dos bot√µes
    const btnZoom = div.querySelector('[data-act="zoom"]');
    if (btnZoom) {
      btnZoom.addEventListener('click', () => {
        if (p._lat && p._lng) MAP?.setView([p._lat, p._lng], 16, { animate: true });
      });
    }

    const btnOpen = div.querySelector('[data-act="open"]');
    if (btnOpen) {
      btnOpen.addEventListener('click', () => openFicha(p, true));
    }

    if (EDIT_MODE) {
      const btnEdit = div.querySelector('[data-act="edit"]');
      const btnDel  = div.querySelector('[data-act="del"]');
      if (btnEdit) btnEdit.addEventListener('click', () => openEditBySlug(p.slug));
      if (btnDel)  btnDel.addEventListener('click', () => deleteBySlug(p.slug));
    }

    box.appendChild(div);
  });
}

/* ===== Mapa (marcadores) ===== */
function pinClassFromState(p){
  const st = p.estado;
  let suffix='';
  if(st==='em_construcao') suffix=' c';
  else if(st==='licenciado') suffix=' l';
  else if(st==='concluido') suffix=' f';

  const iso = (p.isEmpreendimento === false) ? ' iso' : '';
  return 'pin' + iso + suffix;
}
function makeDivIcon(p){
  const iso = (p.isEmpreendimento === false);
  return L.divIcon({
    className: pinClassFromState(p),
    html:'',
    iconSize: [28,28],
    iconAnchor:[14,14],
    popupAnchor:[0,-14]
  });
}
function renderMarkers(){
  if(!window.L||!LAYER) return;
  if(CLUSTER){ CLUSTER.clearLayers(); }
  LAYER.clearLayers();
  const pts=[];
  FILT.forEach(p=>{
    const lat=numPT(p._lat), lng=numPT(p._lng);
    if(lat===null||lng===null) return;
    pts.push([lat,lng]);
    const m=L.marker([lat,lng],{icon:makeDivIcon(p)});
    const tooltip = p.refInterna ? `[${p.refInterna}] ${p.nome||''}` : (p.nome||'');
    m.on('click',()=>openFicha(p,true));
    m.bindTooltip(tooltip,{direction:'top',offset:[0,-8],opacity:.9});
    (CLUSTER||LAYER).addLayer ? (CLUSTER||LAYER).addLayer(m) : m.addTo(LAYER);
  });
  if(pts.length && MAP){
    const b=L.latLngBounds(pts);
    if(b.isValid()) MAP.fitBounds(b.pad(0.2));
  }
}

/* ===== Documentos & pr√©-visualiza√ß√£o ===== */
const IS_SAFARI=/^((?!chrome|android).)*safari/i.test(navigator.userAgent||'');
let STORAGE_MODE='idb'; // 'idb' | 'dataurl'
const DB_PREFIX='gpp_docs_';
const TEMP_URLS=new Set();

async function detectStorageMode(){
  if(!window.idbKeyval){ STORAGE_MODE='dataurl'; return; }
  try{
    const test='__gpp_test__';
    await idbKeyval.set(test,new Blob(['ok']));
    const v=await idbKeyval.get(test);
    await idbKeyval.del(test);
    if(!v) throw new Error('sem leitura IDB');
    STORAGE_MODE='idb';
  }catch{
    STORAGE_MODE='dataurl';
  }
}
async function saveLocalBlob(file, slug){
  const name=file.name||('file_'+Date.now());
  const blob=file;
  if(STORAGE_MODE==='idb'){
    try{
      const key=DB_PREFIX+(slug||'sem-slug')+'_'+name;
      await idbKeyval.set(key,{
        meta:{name,type:blob.type||'application/octet-stream',size:blob.size||0,ts:Date.now()},
        blob
      });
      return 'idb://'+key;
    }catch{
      // fallback
    }
  }
  const dataUrl=await new Promise((res,rej)=>{
    const fr=new FileReader();
    fr.onload=()=>res(fr.result);
    fr.onerror=()=>rej(new Error('Falha FileReader'));
    fr.readAsDataURL(blob);
  });
  return dataUrl;
}
async function getLocal(idbUrl){
  if(!idbUrl || !idbUrl.startsWith('idb://') || !window.idbKeyval) return null;
  try{ return await idbKeyval.get(idbUrl.replace('idb://','')); }catch{ return null; }
}
async function getLocalBlobUrl(idbUrl){
  const rec=await getLocal(idbUrl); if(!rec) return null;
  const u=URL.createObjectURL(rec.blob); TEMP_URLS.add(u); return u;
}
async function resolveLocalUrl(rawUrl){
  if(!rawUrl) return null;
  if(rawUrl.startsWith('data:') || rawUrl.startsWith('http')) return rawUrl;
  if(rawUrl.startsWith('idb://')) return await getLocalBlobUrl(rawUrl);
  return rawUrl;
}
function revokeTempUrls(){
  TEMP_URLS.forEach(u=>URL.revokeObjectURL(u));
  TEMP_URLS.clear();
}

function openPDF(url){
  el('pdfFrame').src=url;
  el('pdfOpenNew').href=url;
  el('pdfModal').classList.add('show');
}
el('pdfClose').addEventListener('click',()=>{
  el('pdfModal').classList.remove('show');
  el('pdfFrame').src='about:blank';
  revokeTempUrls();
});

async function renderDocPreview(container, rawUrl, type){
  const url=await resolveLocalUrl(rawUrl);
  if(!url){
    container.innerHTML='<div class="hint">Documento indispon√≠vel.</div>';
    return;
  }

  container.innerHTML='';

  if(type==='img'){
    const img=document.createElement('img');
    img.src=url;
    img.alt='';
    img.style.maxWidth='100%';
    img.style.borderRadius='8px';
    container.appendChild(img);
    const bar=document.createElement('div');
    bar.style.marginTop='6px';
    bar.style.display='flex';
    bar.style.gap='6px';
    bar.innerHTML=`<a class="btn-sm" href="${url}" download>Transferir</a>
                   <a class="btn-sm" href="${url}" target="_blank" rel="noreferrer noopener">Abrir em nova aba</a>`;
    container.appendChild(bar);
    return;
  }

  if(type==='link'){
    container.innerHTML=`<a class="btn-sm" href="${url}" target="_blank" rel="noreferrer noopener">Abrir link</a>`;
    return;
  }

  if(type==='pdf'){
    if(rawUrl.startsWith('idb://')){
      const rec=await getLocal(rawUrl);
      const size=rec?.meta?.size ?? 0;
      if(size > PDF_INLINE_LIMIT){
        const resolved = await resolveLocalUrl(rawUrl);
        container.innerHTML = `
          <div class="hint" style="line-height:1.5">
            Ficheiro grande (${(size/1024/1024).toFixed(1)} MB). Para pr√©-visualizar sem bloqueios, hospede num URL HTTPS (ex.: <code>docs/</code> no reposit√≥rio) e use o link aqui.<br>
            Ainda assim, pode <a class="btn-sm" href="${resolved}" target="_blank" rel="noreferrer noopener">Abrir em nova aba</a> ou <a class="btn-sm" href="${resolved}" download>Transferir</a>.
          </div>`;
        return;
      }
    }

    if(!window['pdfjsLib']){
      container.innerHTML = `<div class="hint">Pr√©-visualiza√ß√£o indispon√≠vel. <a class="btn-sm" href="${url}" target="_blank" rel="noreferrer noopener">Abrir em nova aba</a></div>`;
      return;
    }

    const wrap=document.createElement('div');
    wrap.style.border='1px solid var(--border)';
    wrap.style.borderRadius='8px';
    wrap.style.overflow='hidden';
    wrap.style.background='#fff';
    wrap.style.height='420px';
    wrap.style.display='flex';
    wrap.style.alignItems='center';
    wrap.style.justifyContent='center';
    wrap.innerHTML='<div style="color:#666;font:13px/1.4 system-ui">A carregar PDF‚Ä¶</div>';
    container.appendChild(wrap);

    const bar=document.createElement('div');
    bar.style.marginTop='6px';
    bar.style.display='flex';
    bar.style.gap='6px';
    bar.innerHTML=`<a class="btn-sm" href="${url}" download>Transferir</a>
                   <a class="btn-sm" href="${url}" target="_blank" rel="noreferrer noopener">Abrir em nova aba</a>
                   <button class="btn-sm" id="btnExpandLocal">Expandir</button>`;
    container.appendChild(bar);

    try{
      const loadingTask=pdfjsLib.getDocument(url);
      const pdf=await loadingTask.promise;
      const page=await pdf.getPage(1);
      const viewport=page.getViewport({ scale: 1.4 });
      const canvas=document.createElement('canvas');
      const ctx=canvas.getContext('2d');
      canvas.width=viewport.width;
      canvas.height=viewport.height;
      wrap.innerHTML='';
      wrap.appendChild(canvas);
      await page.render({ canvasContext: ctx, viewport }).promise;

      bar.querySelector('#btnExpandLocal')?.addEventListener('click',()=> openPDF(url));
    }catch(e){
      console.error(e);
      wrap.innerHTML=`<div style="padding:10px;color:#444">N√£o foi poss√≠vel pr√©-visualizar. <a class="btn-sm" href="${url}" target="_blank" rel="noreferrer noopener">Abrir em nova aba</a></div>`;
    }
    return;
  }

  container.innerHTML=`<a class="btn-sm" href="${url}" target="_blank" rel="noreferrer noopener">Abrir</a>`;
}

/* ===== Painel lateral (Ficha) ===== */
function openFicha(p,focus=false){
  ACTIVE = p;

  // T√≠tulo: apenas o nome
  const titleLine = `${p.nome || '‚Äî'}`;
  const precoPedidoStr = formatPrecoPedido(p);

  const html = `
    <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
      <div>
        <div style="font-weight:800;font-size:16px">${titleLine}</div>
        <div style="font-size:12px;color:#bbb">
          ${p.refInterna ? `Ref. ${p.refInterna} ¬∑ ` : ''}${p.concelho || '‚Äî'}
          ¬∑ ${stateLabel(p.estado)}
          ${tipoBadge(p)}
        </div>
      </div>
      <div style="display:flex;gap:6px;flex-wrap:wrap">
        <button class="btn" data-act="center">Centrar</button>
        <a class="btn"
           href="https://www.google.com/maps?q=${p._lat},${p._lng}"
           target="_blank"
           rel="noreferrer">Google Maps</a>
        ${p.link
          ? `<a class="btn" href="${p.link}" target="_blank" rel="noreferrer">Abrir link</a>`
          : ''
        }
        ${
          p._fromAngariacoes && p.refInterna
            ? `
        <a class="btn"
           href="./angariacoes.html?ref=${encodeURIComponent(p.refInterna)}&abrir=1"
           target="_blank"
           rel="noreferrer">
          Ficha angaria√ß√£o
        </a>`
            : ''
        }
        <button class="btn" data-act="copy">Copiar resumo</button>
        <button class="btn" data-act="share">Partilhar</button>
        ${EDIT_MODE ? `<button class="btn ghost" data-act="edit">Editar</button>` : ''}
      </div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:10px">
      <div>
        <div class="meta-line"><b>Tipo:</b> ${tipoLabel(p)}</div>
        <div class="meta-line"><b>Promotor:</b> ${p.promotor || '‚Äî'}</div>
        <div class="meta-line"><b>Ref. interna:</b> ${p.refInterna || '‚Äî'}</div>
        <div class="meta-line"><b>Tipologias:</b> ${p.tipologias || '‚Äî'}</div>
        <div class="meta-line"><b>Conclus√£o:</b> ${formatConclusao(p)}</div>
        <div class="meta-line"><b>‚Ç¨/m¬≤:</b> ${
          p.preco_m2
            ? Number(String(p.preco_m2).replace(',', '.')).toLocaleString('pt-PT')
            : '‚Äî'
        }</div>
        <div class="meta-line"><b>Pre√ßo pedido:</b> ${precoPedidoStr}</div>
        <div class="meta-line"><b>Notas:</b> ${p.notas || '‚Äî'}</div>
        <div class="meta-line"><b>Coordenadas:</b> ${numPT(p._lat) ?? '‚Äî'}, ${numPT(p._lng) ?? '‚Äî'}</div>
      </div>
      <div>
        <div class="label">Documentos & Media</div>
        ${buildDocsHTML(p.docs || [])}
      </div>
    </div>
  `;

  el('panelInner').innerHTML = html;
  el('side-panel').classList.add('show');

  if (focus && numPT(p._lat) !== null && numPT(p._lng) !== null) {
    MAP?.setView([numPT(p._lat), numPT(p._lng)], 16, { animate: true });
  }

  // Bot√£o "Centrar"
  const btnCenter = el('panelInner').querySelector('[data-act="center"]');
  if (btnCenter) {
    btnCenter.addEventListener('click', () => {
      if (numPT(p._lat) !== null && numPT(p._lng) !== null) {
        MAP?.setView([p._lat, p._lng], 16, { animate: true });
      }
    });
  }

  // Copiar resumo (mantemos a Ref. na frase, apenas muda o t√≠tulo visual)
  const btnCopy = el('panelInner').querySelector('[data-act="copy"]');
  if (btnCopy) {
    btnCopy.addEventListener('click', async () => {
      const resumo = `${
        p.refInterna ? '[' + p.refInterna + '] ' : ''
      }${p.nome || ''} ‚Äî ${p.concelho || ''} (${p.estado || ''}) ¬∑ ${tipoLabel(p)} ¬∑ Conclus√£o ${
        formatConclusao(p)
      } ¬∑ Pre√ßo: ${precoPedidoStr} ¬∑ Ref. ${p.refInterna || '-'} ¬∑ ${p.link || ''}`.trim();
      try { await navigator.clipboard.writeText(resumo); } catch {}
    });
  }

  // Partilhar
  const btnShare = el('panelInner').querySelector('[data-act="share"]');
  if (btnShare) {
    btnShare.addEventListener('click', async () => {
      const shareData = {
        title: p.nome || 'Empreendimento',
        text: `${
          p.refInterna ? '[' + p.refInterna + '] ' : ''
        }${p.nome || ''} ‚Äî ${p.concelho || ''} (${p.estado || ''}) ¬∑ ${tipoLabel(p)} ¬∑ Conclus√£o ${
          formatConclusao(p)
        } ¬∑ Pre√ßo: ${precoPedidoStr}${
          p.refInterna ? ' ¬∑ Ref. ' + p.refInterna : ''
        }`,
        url: location.href
      };
      if (navigator.share) {
        try { await navigator.share(shareData); } catch {}
      } else {
        try {
          await navigator.clipboard.writeText(
            shareData.text + ' ' + (p.link || location.href)
          );
        } catch {}
      }
    });
  }

  // Clique nos documentos
  const ul = el('panelInner').querySelector('#docList');
  if (ul) {
    ul.querySelectorAll('li').forEach(li => {
      li.addEventListener('click', async () => {
        const rawUrl = li.getAttribute('data-url');
        const tp = li.getAttribute('data-type');
        const view = el('panelInner').querySelector('#docView');
        await renderDocPreview(view, rawUrl, tp);
      });
      li.querySelector('[data-act="expand"]')?.addEventListener('click', async e => {
        e.stopPropagation();
        const raw = e.target.getAttribute('data-url');
        const u = await resolveLocalUrl(raw);
        openPDF(u);
      });
    });
  }
}
function buildDocsHTML(docs){
  if(!Array.isArray(docs)||!docs.length) return '<div class="hint">Sem documentos anexados.</div>';
  const items=docs.map(d=>{
    const icon=d.type==='pdf'?'üìÑ':(d.type==='img'?'üñºÔ∏è':'üîó');
    const extra=d.type==='pdf'?` <button class="btn-sm" data-act="expand" data-url="${d.url}">Expandir</button>`:'';
    return `<li style="margin-bottom:6px;border:1px solid var(--border);padding:6px 8px;border-radius:8px" data-type="${d.type}" data-url="${d.url}">
      ${icon} <a class="btn-sm" href="${d.url}" target="_blank" rel="noreferrer noopener">Abrir</a> ¬∑ ${d.title||d.url}${extra}
    </li>`;
  }).join('');
  return `<ul id="docList" style="list-style:none;margin:0;padding:0">${items}</ul><div id="docView" style="margin-top:8px"></div>`;
}
el('closePanel').addEventListener('click',()=>{
  el('side-panel').classList.remove('show');
  revokeTempUrls();
});

/* ===== Exporta√ß√µes ===== */
function exportCSV(){
  const headers=[
    "nome","concelho","estado","promotor","tipologias",
    "conclusao","preco_m2","precoPedido","notas","link",
    "latitude","longitude","isEmpreendimento"
  ];
  const rows=FILT.map(p=>[
    p.nome,
    p.concelho,
    p.estado,
    p.promotor,
    p.tipologias,
    (p.conclusaoAno||p.conclusao||''),
    p.preco_m2||'',
    p.precoPedido||'',
    p.notas||'',
    p.link||'',
    p._lat||'',
    p._lng||'',
    (p.isEmpreendimento===false?'0':'1')
  ]);
  const csv=toCSV([headers,...rows]);
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;
  a.download='empreendimentos.csv';
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}
function exportGeo(){
  const fc={
    type:"FeatureCollection",
    features: RAW.filter(p=>numPT(p._lat)!==null && numPT(p._lng)!==null).map(p=>({
      type:"Feature",
      geometry:{type:"Point",coordinates:[numPT(p._lng),numPT(p._lat)]},
      properties:{
        slug:p.slug,
        nome:p.nome,
        concelho:p.concelho,
        estado:p.estado,
        promotor:p.promotor,
        tipologias:p.tipologias,
        conclusao:p.conclusao,
        conclusaoAno:p.conclusaoAno,
        conclusaoMes:p.conclusaoMes,
        preco_m2:p.preco_m2,
        precoPedido:p.precoPedido,
        notas:p.notas,
        link:p.link,
        docs:p.docs||[],
        isEmpreendimento:(p.isEmpreendimento===false?false:true)
      }
    }))
  };
  const blob=new Blob([JSON.stringify(fc,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;
  a.download='empreendimentos.geojson';
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

el('exportCsv').addEventListener('click', exportCSV);
el('exportGeo').addEventListener('click', exportGeo);
  
  /* ===== Backup OneDrive / Restauro (Mapa) ===== */

function backupOneDrive(){
  if(!Array.isArray(RAW) || !RAW.length){
    const proceed = confirm('N√£o existem registos no mapa. Pretende ainda assim gerar um ficheiro de backup vazio?');
    if(!proceed) return;
  }

  const headers = [
    "slug","refInterna","nome","concelho","estado","promotor","tipologias",
    "conclusaoAno","conclusaoMes","conclusao",
    "preco_m2","precoPedido","notas","link",
    "lat","lng","isEmpreendimento",
    "docs","ownerNome","ownerTelefone","ownerTelemovel","contactos"
  ];

  const rows = RAW.map(p=>[
    p.slug || slugify(p.nome||''),
    p.refInterna || '',
    p.nome || '',
    p.concelho || '',
    p.estado || '',
    p.promotor || '',
    p.tipologias || '',
    p.conclusaoAno || '',
    p.conclusaoMes || '',
    p.conclusao || '',
    p.preco_m2 || '',
    p.precoPedido || '',
    p.notas || '',
    p.link || '',
    p._lat != null ? p._lat : '',
    p._lng != null ? p._lng : '',
    (p.isEmpreendimento === false ? '0' : '1'),
    JSON.stringify(p.docs || []),
    p._ownerNome || '',
    p._ownerTelefone || '',
    p._ownerTelemovel || '',
    p._contactos || ''
  ]);

  const csv = toCSV([headers, ...rows]);

  const now = new Date();
  const yyyy = now.getFullYear();
  const mm   = String(now.getMonth()+1).padStart(2,'0');
  const dd   = String(now.getDate()).padStart(2,'0');
  const hh   = String(now.getHours()).padStart(2,'0');
  const mi   = String(now.getMinutes()).padStart(2,'0');

  const filename = `gpp-mapa-backup-${yyyy}${mm}${dd}-${hh}${mi}.csv`;

  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;
  a.download=filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);

  alert('Backup criado. Guarde o ficheiro na pasta OneDrive: Garvetur Porto Pro / Backups / Mapa.');
}

function restoreFromBackup(file){
  if(!file) return;
  if(!window.Papa){
    alert('Leitor CSV indispon√≠vel (PapaParse).');
    return;
  }

  Papa.parse(file,{
    header:true,
    dynamicTyping:false,
    skipEmptyLines:true,
    complete:res=>{
      const data = res.data || [];
      if(!data.length){
        alert('O ficheiro de backup est√° vazio ou n√£o tem linhas v√°lidas.');
        return;
      }

      const next = [];

      data.forEach(row=>{
        const nome = row.nome || row.Nome || '';
        if(!nome) return;

        const obj = {
          slug: row.slug || slugify(nome),
          refInterna: row.refInterna || row["refInterna"] || '',
          nome,
          concelho: row.concelho || row["concelho"] || row.Concelho || '',
          estado: stateKey(row.estado || row["estado"] || ''),
          promotor: row.promotor || '',
          tipologias: row.tipologias || '',
          conclusaoAno: row.conclusaoAno ? Number(row.conclusaoAno) : (row.conclusao ? Number(row.conclusao) : ''),
          conclusaoMes: row.conclusaoMes ? Number(row.conclusaoMes) : '',
          conclusao: row.conclusao || '',
          preco_m2: row.preco_m2 || '',
          precoPedido: row.precoPedido || '',
          notas: row.notas || '',
          link: row.link || '',
          _lat: row.lat ? numPT(row.lat) : (row.latitude ? numPT(row.latitude) : null),
          _lng: row.lng ? numPT(row.lng) : (row.longitude ? numPT(row.longitude) : null),
          isEmpreendimento: (String(row.isEmpreendimento||'1') === '0' || String(row.isEmpreendimento).toLowerCase()==='false')
            ? false
            : true,
          docs: [],
          _ownerNome: row.ownerNome || '',
          _ownerTelefone: row.ownerTelefone || '',
          _ownerTelemovel: row.ownerTelemovel || '',
          _contactos: row.contactos || ''
        };

        if(row.docs){
          try{
            obj.docs = JSON.parse(row.docs);
          }catch(e){
            obj.docs = [];
          }
        }

        next.push(obj);
      });

      if(!next.length){
        alert('N√£o foi poss√≠vel extrair registos v√°lidos do ficheiro de backup.');
        return;
      }

      const ok = confirm(
        'Este restauro vai substituir TODOS os registos atuais do mapa pelos registos do backup. Pretende continuar?'
      );
      if(!ok) return;

      RAW = next;
      normalizeConclusaoFields();
      const changed = autoUpdateEstadosByConclusao();
      saveLS();
      buildFacetOptions();
      run();

      alert('Backup restaurado com sucesso.');
    },
    error:()=>{
      alert('Falha a ler o ficheiro de backup.');
    }
  });
}

/* Ligar bot√µes da toolbar ao backup/restauro */
const btnBackup = el('btnBackup');
if(btnBackup){
  btnBackup.addEventListener('click', backupOneDrive);
}

const btnRestore = el('btnRestore');
const backupInput = el('backupFile');
if(btnRestore && backupInput){
  btnRestore.addEventListener('click', ()=>{
    backupInput.value = '';
    backupInput.click();
  });
  backupInput.addEventListener('change',(ev)=>{
    const file = ev.target.files && ev.target.files[0];
    if(file) restoreFromBackup(file);
  });
}

/* ===== Backup / Restauro (ficheiro JSON) ===== */
function doBackupToFile(){
  try{
    const payload = {
      version: 1,
      ts: Date.now(),
      data: RAW || []
    };

    const blob = new Blob(
      [JSON.stringify(payload)],
      { type:'application/json;charset=utf-8;' }
    );

    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'gpp-mapa-backup.json';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);

    alert('Backup do mapa exportado com sucesso.\nGuarde o ficheiro na pasta OneDrive > Garvetur Porto Pro > Backups > Mapa.');
  }catch(e){
    console.error('Erro ao gerar backup', e);
    alert('N√£o foi poss√≠vel gerar o backup. Verifique a consola (F12).');
  }
}

async function handleRestoreFile(ev){
  const file = ev.target.files && ev.target.files[0];
  if(!file) return;

  try{
    const text = await file.text();
    let payload;
    try{
      payload = JSON.parse(text);
    }catch{
      alert('Ficheiro de backup inv√°lido (n√£o √© JSON).');
      return;
    }

    // Aceita dois formatos:
    // 1) { version, ts, data: [...] }
    // 2) [ ... ] diretamente
    const data = Array.isArray(payload.data)
      ? payload.data
      : (Array.isArray(payload) ? payload : null);

    if(!data){
      alert('Ficheiro de backup n√£o cont√©m dados v√°lidos.');
      return;
    }

    // Substitui o RAW atual pelos dados do backup
    RAW = data;
    saveLS();               // Atualiza localStorage
    buildFacetOptions();    // Refaz concelhos / promotores
    run();                  // Re-renderiza KPIs, lista e mapa

    alert('Backup restaurado com sucesso.');
  }catch(e){
    console.error('Erro a restaurar backup', e);
    alert('N√£o foi poss√≠vel restaurar o backup. Verifique se o ficheiro √© o correto.');
  }finally{
    ev.target.value = '';
  }
}

// Ligar eventos aos bot√µes, se existirem
const btnBackup = el('btnBackup');
if(btnBackup){
  btnBackup.addEventListener('click', doBackupToFile);
}

const inputRestore = el('restoreFile');
if(inputRestore){
  inputRestore.addEventListener('change', handleRestoreFile);
}

/* ===== Persist√™ncia (robusta) ===== */
function saveLS(){
  try{
    localStorage.setItem(LS_KEY, JSON.stringify(RAW));
  }catch(e){
    console.warn('Falha ao guardar em localStorage:', e);
  }
}
function loadLS(){
  try{
    const x=localStorage.getItem(LS_KEY);
    if(!x) return null;
    if(x.length > 500000){
      console.warn('Dataset local demasiado grande, a ignorar para evitar bloqueios.');
      LS_SKIPPED=true;
      return null;
    }
    return JSON.parse(x);
  }catch(e){
    console.warn('Falha a ler dados locais, a iniciar base vazia.', e);
    LS_ERROR=true;
    return null;
  }
}

/* ===== Integra√ß√£o com Angaria√ß√µes (gpp_angariacoes_v2) ===== */
function mergeAngariacoesIntoRAW(){
  let raw=null;
  try{
    raw = localStorage.getItem('gpp_angariacoes_v2');
  }catch(e){
    console.warn('Sem acesso ao localStorage de angaria√ß√µes', e);
    return;
  }
  if(!raw) return;
  let store;
  try{
    store = JSON.parse(raw);
  }catch(e){
    console.warn('JSON inv√°lido em gpp_angariacoes_v2', e);
    return;
  }
  if(!store || !Array.isArray(store.deals)) return;

  const deals = store.deals;
  const bySlug = new Map(RAW.map(p=>[p.slug || slugify(p.nome||''), p]));

  deals.forEach(d=>{
    if(!d) return;

    const gps = d.gps || '';
    const coords = parseGps(gps);
    if(coords.lat===null || coords.lng===null) return;

    const isEmp = !!d.isEmpreendimento;
    const nome = d.nomeEmp || d.tituloImovel || d.refInterna || (isEmp ? 'Empreendimento' : 'Im√≥vel');
    const baseId = d.id || slugify(nome);
    const slug = 'ang-' + baseId;

    let ano = d.anoConclEmp || d.anoConclusao || '';
    ano = ano ? Number(ano) : '';
    let mes = d.mesConclEmp || d.mesConclusao || '';
    mes = mes ? Number(mes) : '';

    const estado = (function(){
      const e = d.estadoImovel;
      if(e === 'construcao') return 'em_construcao';
      if(e === 'projeto') return 'licenciado';
      if(e === 'novo' || e === 'usado' || e === 'recuperado') return 'concluido';
      return '';
    })();

    const preco = numPT(d.precoPedido);
    let preco_m2 = '';
    const areaABP = numPT(d.areaABP || d.areaBruta);
    if(preco !== null && areaABP && areaABP>0){
      preco_m2 = Math.round(preco/areaABP);
    }

    const obj = {
      slug,
      nome,
      concelho: d.concelho || '',
      estado,
      promotor: d.promotor || '',
      tipologias: d.tipologiasEmp || '',
      conclusaoAno: ano || '',
      conclusaoMes: mes || '',
      conclusao: ano || '',
      preco_m2: preco_m2 || '',
      precoPedido: preco !== null ? preco : '',
      notas: d.observacoes || '',
      link: d.linkUrl || '',
      _lat: coords.lat,
      _lng: coords.lng,
      docs: [],
      _fromAngariacoes: true,
      isEmpreendimento: isEmp,
      refInterna: d.refInterna || '',
      _ownerNome: d.nomeProprietario || d.proprietario || '',
      _ownerTelefone: d.telefoneProprietario || d.telefone || '',
      _ownerTelemovel: d.telemovelProprietario || d.telemovel || '',
      _contactos: d.contactos || ''
    };

    if(bySlug.has(slug)){
      Object.assign(bySlug.get(slug), obj);
    }else{
      RAW.push(obj);
    }
  });
}

/* ===== Normaliza√ß√£o tipo (Empreendimento por defeito) ===== */
function normalizeTipoImovel(){
  RAW.forEach(p=>{
    if(typeof p.isEmpreendimento === 'undefined'){
      p.isEmpreendimento = true;
    }
  });
}

/* ===== Conclus√£o (m√™s/ano) + auto-update de estado ===== */
function normalizeConclusaoFields(){
  RAW.forEach(p=>{
    const anoStored = p.conclusaoAno || p.conclusao;
    if(anoStored && !p.conclusaoAno){
      p.conclusaoAno = Number(anoStored);
    }
    if(p.conclusaoAno && !p.conclusao){
      p.conclusao = p.conclusaoAno;
    }
    if(p.conclusaoAno && (p.conclusaoMes === undefined || p.conclusaoMes === null || p.conclusaoMes === '')){
      p.conclusaoMes = 12;
    }
  });
}
function autoUpdateEstadosByConclusao(){
  const today = new Date();
  let changed=false;

  RAW.forEach(p=>{
    const ano = Number(p.conclusaoAno || p.conclusao || '');
    const mes = Number(p.conclusaoMes || '');
    if(!ano || !mes) return;
    if(p.estado !== 'em_construcao') return;
    const lastDay = new Date(ano, mes, 0);
    if(today >= lastDay){
      p.estado = 'concluido';
      changed = true;
    }
  });

  return changed;
}

/* ===== Modo Edi√ß√£o ===== */
function setEditMode(on){
  EDIT_MODE=on;
  el('toggleEdit').textContent= on? 'üîì Edi√ß√£o ON' : 'üîí Editar';
  ['btnImport','btnNew','btnSave','btnClearAll','attachLocalLabel'].forEach(id=>{
    const b=el(id);
    if(!b) return;
    b.style.display= on? 'inline-block' : 'none';
  });
  renderList();
}
el('toggleEdit').addEventListener('click',()=> setEditMode(!EDIT_MODE));
el('btnClearAll').addEventListener('click',()=>{
  if(confirm('Tem a certeza que pretende limpar todos os empreendimentos?')){
    RAW=[];
    saveLS();
    run();
  }
});
el('btnSave').addEventListener('click',()=>{
  saveLS();
  alert('Dados guardados localmente.');
});

/* ===== CSV Import ===== */
el('csvFile').addEventListener('change', async (ev)=>{
  const file=ev.target.files?.[0]; if(!file) return;
  if(!window.Papa){ alert('Leitor CSV indispon√≠vel.'); return; }
  const text=await file.text();
  Papa.parse(text,{
    header:true,
    dynamicTyping:false,
    skipEmptyLines:true,
    complete:res=>{
      const incoming=(res.data||[]).map(row=>{
        const precoCsv = row.precoPedido || row.preco_pedido || row["Pre√ßo Pedido"] || row["preco_total"] || '';
        const p={
          slug: slugify(row.nome||row.Nome||''),
          nome: row.nome||row.Nome||'',
          concelho: row.concelho||row.Concelho||row.municipio||'',
          estado: stateKey(row.estado||row.status||''),
          promotor: row.promotor||'',
          tipologias: row.tipologias||'',
          conclusao: row.conclusao||row["Ano de Conclus√£o"]||'',
          preco_m2: row.preco_m2||row["preco_m2"]||row["Pre√ßo_m2"]||'',
          precoPedido: precoCsv || '',
          notas: row.notas||row.Observacoes||row["Observa√ß√µes"]||'',
          link: row.link||row.url||'',
          _lat: numPT(row.latitude||row.Lat||row.lat),
          _lng: numPT(row.longitude||row.Lng||row.lng),
          docs:[],
          isEmpreendimento:true
        };
        return p;
      }).filter(p=>p.nome);
      if(!incoming.length){
        alert('Nenhuma linha v√°lida encontrada no CSV.');
        return;
      }
      const bySlug=new Map(RAW.map(p=>[p.slug||slugify(p.nome),p]));
      incoming.forEach(n=>{
        const key=n.slug||slugify(n.nome);
        if(bySlug.has(key)){
          Object.assign(bySlug.get(key),n);
        } else {
          RAW.push(n);
        }
      });

      normalizeConclusaoFields();
      const changed = autoUpdateEstadosByConclusao();
      if(changed) saveLS(); else saveLS();

      buildFacetOptions();
      run();
      alert(`Importa√ß√£o conclu√≠da: ${incoming.length} registos processados.`);
      ev.target.value='';
    },
    error:()=> alert('Falha a ler CSV.')
  });
});

/* ===== Modal Edi√ß√£o ===== */
function updateLocalAttachVisibility(){
  const lab=el('attachLocalLabel');
  if(lab) lab.style.display= EDIT_MODE ? 'inline-block' : 'none';
}
function addDocRow(d){
  const row=document.createElement('div');
  row.className='doc-row';
  row.innerHTML=`
    <input placeholder="T√≠tulo (ex.: Brochura)" value="${d.title||''}">
    <select>
      <option value="pdf" ${d.type==='pdf'?'selected':''}>pdf</option>
      <option value="img" ${d.type==='img'?'selected':''}>img</option>
      <option value="link" ${d.type==='link'?'selected':''}>link</option>
    </select>
    <input placeholder="URL (https://‚Ä¶ ou idb://‚Ä¶ ou data:‚Ä¶)" value="${d.url||''}">
    <button class="btn del">Apagar</button>
  `;
  row.querySelector('.del').addEventListener('click', async ()=>{
    const inputs=row.querySelectorAll('input,select');
    const u=inputs[2].value.trim();
    if(u.startsWith('idb://')){
      try{ await idbKeyval.del(u.replace('idb://','')); }catch{}
    }
    row.remove();
  });
  el('docsBox').appendChild(row);
}
function fillEditForm(p){
  el('f_nome').value=p.nome||'';
  el('f_concelho_e').value=p.concelho||'';
  el('f_estado').value=p.estado||'';
  el('f_promotor_e').value=p.promotor||'';
  el('f_tipologias').value=p.tipologias||'';

  el('f_conclusao_mes').value = p.conclusaoMes || '';
  el('f_conclusao_ano').value = p.conclusaoAno || p.conclusao || '';

  el('f_preco').value=p.preco_m2||'';
  el('f_link').value=p.link||'';
  el('f_lat').value=p._lat!=null? p._lat : '';
  el('f_lng').value=p._lng!=null? p._lng : '';
  el('f_notas').value=p.notas||'';
  const box=el('docsBox');
  box.innerHTML='';
  (p.docs||[]).forEach(d=> addDocRow(d));
}

el('btnNew').addEventListener('click',()=>{
  EDIT_INDEX=-1;
  fillEditForm({
    nome:'',concelho:'',estado:'',promotor:'',
    tipologias:'',conclusao:'',conclusaoAno:'',conclusaoMes:'',
    preco_m2:'',
    notas:'',link:'',_lat:'',_lng:'',docs:[]
  });
  el('editTitle').textContent='Novo Empreendimento';
  el('editModal').classList.add('show');
});
function openEditBySlug(slug){
  const idx=RAW.findIndex(p=>p.slug===slug);
  if(idx<0) return;
  EDIT_INDEX=idx;
  const p=RAW[idx];
  fillEditForm(p);
  el('editTitle').textContent='Editar Empreendimento';
  el('editModal').classList.add('show');
}
el('cancelEdit').addEventListener('click',()=>{
  el('editModal').classList.remove('show');
  PICKING=false;
});

el('attachLocalInput').addEventListener('change', async (ev)=>{
  const file=ev.target.files?.[0]; if(!file) return;
  const slugCurrent=slugify(el('f_nome').value || (EDIT_INDEX>=0 ? RAW[EDIT_INDEX].nome : 'novo'));
  el('loadingMask').classList.add('show');
  try{
    const url=await saveLocalBlob(file, slugCurrent);
    const ext=(file.name.split('.').pop()||'').toLowerCase();
    const type=(ext==='pdf')?'pdf':(['png','jpg','jpeg','webp','gif'].includes(ext)?'img':'link');
    addDocRow({ title:file.name, type, url });
  }catch(e){
    alert('N√£o foi poss√≠vel anexar o ficheiro. '+(e.message||''));
  }finally{
    el('loadingMask').classList.remove('show');
    ev.target.value='';
  }
});
el('addDoc').addEventListener('click',()=> addDocRow({title:'', type:'pdf', url:''}));

el('saveEdit').addEventListener('click',()=>{
  const anoC = el('f_conclusao_ano').value ? Number(el('f_conclusao_ano').value) : '';
  const mesC = el('f_conclusao_mes').value ? Number(el('f_conclusao_mes').value) : '';

  const base = (EDIT_INDEX>=0 ? RAW[EDIT_INDEX] : null);

  const p={
    nome:el('f_nome').value.trim(),
    concelho:el('f_concelho_e').value.trim(),
    estado:el('f_estado').value,
    promotor:el('f_promotor_e').value.trim(),
    tipologias:el('f_tipologias').value.trim(),
    conclusaoAno: anoC,
    conclusaoMes: mesC,
    conclusao: anoC || '',
    preco_m2:el('f_preco').value? Number(el('f_preco').value): '',
    notas:el('f_notas').value.trim(),
    link:el('f_link').value.trim(),
    _lat:el('f_lat').value? numPT(el('f_lat').value): null,
    _lng:el('f_lng').value? numPT(el('f_lng').value): null,
    docs:[]
  };

  el('docsBox').querySelectorAll('.doc-row').forEach(r=>{
    const inputs=r.querySelectorAll('input,select');
    const d={
      title:inputs[0].value.trim(),
      type:inputs[1].value,
      url:inputs[2].value.trim()
    };
    if(d.url) p.docs.push(d);
  });
  if(!p.nome){
    alert('O nome √© obrigat√≥rio.');
    return;
  }
  p.slug=slugify(p.nome);

  if(base && typeof base.isEmpreendimento === 'boolean'){
    p.isEmpreendimento = base.isEmpreendimento;
  }else{
    p.isEmpreendimento = true;
  }

  if(base && base.precoPedido !== undefined){
    p.precoPedido = base.precoPedido;
  }

  if(EDIT_INDEX>=0){
    RAW[EDIT_INDEX]=Object.assign(RAW[EDIT_INDEX],p);
  } else {
    const exist=RAW.find(x=>x.slug===p.slug);
    if(exist){
      if(!confirm('J√° existe um empreendimento com este nome. Substituir?')) return;
      Object.assign(exist,p);
    } else {
      RAW.push(p);
    }
  }

  normalizeConclusaoFields();
  const changed = autoUpdateEstadosByConclusao();
  saveLS();

  el('editModal').classList.remove('show');
  PICKING=false;
  buildFacetOptions();
  run();
});

/* ===== Apagar por slug ===== */
function deleteBySlug(slug){
  if(!EDIT_MODE) return;
  const idx = RAW.findIndex(p => p.slug === slug);
  if(idx === -1) return;

  if(!confirm('Tem a certeza que pretende apagar este registo do mapa? Esta a√ß√£o n√£o pode ser anulada.')) return;

  const wasActive = ACTIVE && ACTIVE.slug === slug;
  RAW.splice(idx, 1);
  saveLS();
  run();

  if(wasActive){
    el('side-panel').classList.remove('show');
    revokeTempUrls();
  }
}

/* ===== UI filtros ===== */
document.querySelectorAll('#estadoChips .chip').forEach(ch=>{
  ch.addEventListener('click',()=>{
    document.querySelectorAll('#estadoChips .chip').forEach(c=>c.classList.remove('active'));
    ch.classList.add('active');
    UIState.estado=ch.dataset.v||'';
    saveFilterStateFromUI();
    run();
  });
});
document.querySelectorAll('#tipoChips .chip').forEach(ch=>{
  ch.addEventListener('click',()=>{
    document.querySelectorAll('#tipoChips .chip').forEach(c=>c.classList.remove('active'));
    ch.classList.add('active');
    UIState.tipo=ch.dataset.v||'';
    saveFilterStateFromUI();
    run();
  });
});
el('apply').addEventListener('click',()=>{
  UIState.q=el('q').value.trim();
  UIState.concelho=el('f_concelho').value;
  UIState.cmin=el('f_cmin').value;
  UIState.cmax=el('f_cmax').value;
  UIState.pmin=el('f_pmin').value;
  UIState.pmax=el('f_pmax').value;
  UIState.vmin=el('f_vmin').value;
  UIState.vmax=el('f_vmax').value;
  UIState.promotor=el('f_promotor').value;
  UIState.tipos=el('f_tipos').value.trim();
  saveFilterStateFromUI();
  run();
});
el('clear').addEventListener('click',()=>{
  ['q','f_concelho','f_cmin','f_cmax','f_pmin','f_pmax','f_vmin','f_vmax','f_promotor','f_tipos'].forEach(id=>el(id).value='');
  document.querySelectorAll('#estadoChips .chip').forEach(c=>c.classList.remove('active'));
  document.querySelector('#estadoChips .chip[data-v=""]').classList.add('active');
  document.querySelectorAll('#tipoChips .chip').forEach(c=>c.classList.remove('active'));
  document.querySelector('#tipoChips .chip[data-v=""]').classList.add('active');
  UIState={
    q:'', concelho:'', estado:'',
    cmin:'', cmax:'',
    pmin:'', pmax:'',
    vmin:'', vmax:'',
    promotor:'', tipos:'',
    tipo:''
  };
  saveFilterStateFromUI();
  run();
});

/* ===== Eventos diversos ===== */
function setEditModeVisibility(){
  ['btnImport','btnNew','btnSave','btnClearAll','attachLocalLabel'].forEach(id=>{
    const b=el(id);
    if(!b) return;
    b.style.display= EDIT_MODE ? 'inline-block' : 'none';
  });
}
el('toggleEdit').addEventListener('click',()=> setTimeout(setEditModeVisibility,0));

/* ===== Ciclo render ===== */
function run(){
  applyFilters();
  renderKPIs();
  renderList();
  renderMarkers();
}

/* ===== Picking coordenadas ===== */
document.addEventListener('click',(e)=>{
  if(!PICKING || !MAP) return;
  if(!e.target.closest('#map')) return;
  const latlng=MAP.mouseEventToLatLng(e);
  el('f_lat').value=latlng.lat.toFixed(6);
  el('f_lng').value=latlng.lng.toFixed(6);
  PICKING=false;
  el('pickCoord').textContent='Definir no mapa';
  el('pickCoord').classList.remove('primary');
});
el('pickCoord').addEventListener('click',()=>{
  PICKING=!PICKING;
  const b=el('pickCoord');
  b.textContent= PICKING? 'Clique no mapa‚Ä¶' : 'Definir no mapa';
  b.classList.toggle('primary',PICKING);
});

/* ===== Contexto vindo de outras p√°ginas (ex.: Tarefas) ===== */
function applyUrlContext(){
  try{
    const params = new URLSearchParams(window.location.search);
    const slugParam = (params.get('slug') || '').trim();
    const nomeParam = (params.get('nome') || params.get('ref') || '').trim();

    if(!slugParam && !nomeParam) return;

    let target = null;

    if(slugParam){
      const slugNorm = slugParam.toLowerCase();
      target = RAW.find(p=>{
        const s = (p.slug || slugify(p.nome||'')).toLowerCase();
        return s === slugNorm;
      });
    }

    if(!target && nomeParam){
      const busc = norm(nomeParam);
      target = RAW.find(p=>{
        const n = norm(p.nome||'');
        const r = norm(p.refInterna || '');
        return n === busc || n.includes(busc) || busc.includes(n) ||
               (r && (r === busc || r.includes(busc) || busc.includes(r)));
      });
    }

    if(target){
      openFicha(target,true);
      setStatus('');
    }else{
      alert('N√£o foi poss√≠vel localizar o empreendimento associado ao pedido.');
    }
  }catch(e){
    console.error('Erro ao aplicar contexto vindo de outra p√°gina no mapa', e);
  }
}

/* ===== Arranque ===== */
(async function init(){
  setStatus('A iniciar mapa‚Ä¶');

  try{ await loadLeafletAndCluster(); }catch{}
  if(window.L){
    initMap();
  } else {
    document.getElementById('map')?.classList.add('hidden');
    setStatus('‚ö† N√£o foi poss√≠vel carregar o motor de mapa (Leaflet). Verifique a liga√ß√£o √† internet.');
    return;
  }

  await detectStorageMode();

  const mem=loadLS();
  RAW=Array.isArray(mem)? mem : [];

  mergeAngariacoesIntoRAW();
  normalizeTipoImovel();
  normalizeConclusaoFields();
  const changed = autoUpdateEstadosByConclusao();
  if(changed) saveLS();

  buildFacetOptions();
  loadFilterState();
  run();

  if(LS_SKIPPED){
    setStatus('‚ö† Dados locais antigos eram muito pesados e foram ignorados. O mapa foi aberto vazio.');
  } else if(LS_ERROR){
    setStatus('‚ö† N√£o foi poss√≠vel ler os dados locais guardados anteriormente. O mapa foi aberto vazio.');
  } else {
    setStatus('');
  }

  setEditMode(false);
  applyUrlContext();
})();
</script>
</body>
</html>

