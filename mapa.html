<!doctype html>
<html lang="pt">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Garvetur Porto Pro ‚Äî Mapa</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
:root {
  --gold: #A38B63;
  --bg: #0B0B0B;
  --panel: #141414;
  --border: rgba(255,255,255,.14);
  --text: #FFFFFF;
  --muted: #A0A0A0;
}
html,body {
  margin:0; height:100%;
  font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
  background: radial-gradient(circle at top,#1c1c1c 0,#050505 55%,#000 100%);
  color: var(--text);
}
.app-shell {display:grid; grid-template-rows:64px auto; height:100%;}
header.app-header {
  display:flex; align-items:center; justify-content:space-between;
  padding:10px 18px; border-bottom:1px solid rgba(163,139,99,.35);
  background:linear-gradient(90deg,#050505,#111,#050505);
  flex-wrap:wrap; gap:16px;
}
.brand {display:flex; align-items:center; gap:10px;}
.brand h1 {margin:0; font-size:17px; color:var(--gold); text-transform:uppercase;}
.brand span.sub {font-size:11px; color:var(--muted);}
.nav-tabs {
  display:flex; flex-wrap:wrap; align-items:center; gap:4px;
  background:rgba(0,0,0,.35); padding:4px;
  border-radius:999px; border:1px solid rgba(163,139,99,.35);
}
.nav-tab {
  padding:5px 10px; border-radius:999px; font-size:11px;
  text-decoration:none; color:var(--muted); text-transform:uppercase;
  transition:.16s background,.16s color,.16s border-color,.16s transform;
}
.nav-tab:hover {color:#fff; border-color:rgba(163,139,99,.6);}
.nav-tab.active {
  background:var(--gold); color:#0A0A0A; border-color:var(--gold); font-weight:600;
}
#map {width:100%; height:calc(100vh - 64px);}
#msg {
  position:absolute; top:70px; left:50%; transform:translateX(-50%);
  background:rgba(0,0,0,.8); border:1px solid var(--gold);
  padding:8px 14px; border-radius:8px; color:var(--gold);
  font-size:13px; display:none; z-index:5000;
}
</style>
</head>
<body>
<div class="app-shell">
  <header class="app-header">
    <div class="brand">
      <svg width="20" height="20" viewBox="0 0 24 24" stroke="#A38B63" fill="none" stroke-width="1.8">
        <circle cx="12" cy="12" r="9"></circle><path d="M8 12.5l2.5 2.5L16 9"></path>
      </svg>
      <div>
        <h1>Garvetur Porto Pro ‚Äî Mapa</h1>
        <span class="sub">Produto em promo√ß√£o & PDF inteligente</span>
      </div>
    </div>

    <nav class="nav-tabs">
      <a href="index.html" class="nav-tab">In√≠cio</a>
      <a href="mapa.html" class="nav-tab active">Mapa</a>
      <a href="kanban.html" class="nav-tab">Leads</a>
      <a href="angariacoes.html" class="nav-tab">Angaria√ß√µes</a>
      <a href="dashboard.html" class="nav-tab">Dashboard</a>
      <a href="vendas.html" class="nav-tab">Vendas</a>
      <a href="tarefas.html" class="nav-tab">Tarefas</a>
    </nav>
  </header>

  <div id="map"></div>
  <div id="msg">‚öôÔ∏è A recuperar m√≥dulo Mapa‚Ä¶ aguarde um momento.</div>
</div>

<script>
(function(){
  const LS_KEY = 'gpp_dataset_v1';
  const msg = document.getElementById('msg');

  // Fun√ß√£o segura para ler o dataset
  function safeLoadDataset(){
    try {
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return [];
      const parsed = JSON.parse(raw);
      if(!Array.isArray(parsed)) throw new Error("Formato inv√°lido");
      return parsed;
    } catch(e){
      console.warn("Erro ao ler dataset:", e);
      // limpar apenas o dataset deste m√≥dulo
      localStorage.removeItem(LS_KEY);
      msg.style.display = "block";
      msg.textContent = "üßπ Dados corrompidos removidos ‚Äî m√≥dulo recuperado.";
      setTimeout(()=>msg.style.display="none", 4000);
      return [];
    }
  }

  // Inicializar o mapa
  function initMap(){
    const map = L.map('map').setView([41.15, -8.61], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19, attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    const data = safeLoadDataset();
    if(!data.length){
      L.marker([41.15, -8.61]).addTo(map)
        .bindPopup("Mapa pronto. Nenhum empreendimento registado ainda.")
        .openPopup();
      return;
    }

    data.forEach(d=>{
      if(d._lat && d._lng){
        L.circleMarker([d._lat, d._lng], {
          radius:6, color:"#A38B63", fillColor:"#A38B63", fillOpacity:0.8
        }).addTo(map)
        .bindPopup(`<b>${d.nome||'Sem nome'}</b><br>${d.concelho||''}`);
      }
    });
  }

  // Execu√ß√£o protegida
  try {
    initMap();
  } catch(e){
    console.error("Falha ao iniciar o mapa:", e);
    localStorage.removeItem(LS_KEY);
    msg.style.display="block";
    msg.textContent="‚ö†Ô∏è M√≥dulo Mapa foi reiniciado devido a erro. Recarregue a p√°gina.";
  }
})();
</script>
</body>
</html>
