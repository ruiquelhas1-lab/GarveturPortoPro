<!doctype html>
<html lang="pt">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Garvetur Porto Pro — Mapa Lite</title>

<link rel="preconnect" href="https://unpkg.com" crossorigin>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" crossorigin>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" crossorigin>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js" crossorigin></script>

<style>
:root{
  --gold:#A38B63;--bg:#0E0E0E;--panel:#131313;--text:#fff;
  --border:rgba(255,255,255,.12);
}
html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui}
.app{display:grid;grid-template-columns:360px 1fr;grid-template-rows:56px 44px 1fr;height:100%}
header{grid-column:1/3;display:flex;align-items:center;justify-content:space-between;
padding:10px 14px;border-bottom:1px solid var(--border)}
header h1{margin:0;font-size:16px;color:var(--gold)}
.badge{font-size:11px;border:1px solid var(--border);padding:6px 10px;border-radius:999px}
.kpis{grid-column:1/3;display:flex;gap:10px;align-items:center;
padding:6px 14px;border-bottom:1px solid var(--border)}
.kpi{border:1px solid var(--border);padding:6px 10px;border-radius:10px;font-size:12px}
.sidebar{background:var(--panel);border-right:1px solid var(--border);overflow:auto}
.section{padding:10px;border-bottom:1px solid rgba(255,255,255,.08)}
label{font-size:12px}
input,select{width:100%;margin-top:4px;padding:8px;border-radius:8px;
background:#0E0E0E;color:#fff;border:1px solid var(--border)}
button{background:transparent;border:1px solid var(--border);
color:#fff;padding:6px 10px;border-radius:8px;cursor:pointer}
#map{width:100%;height:100%}
.list{padding:10px}
.card{border:1px solid rgba(163,139,99,.35);border-radius:10px;padding:10px;margin-bottom:10px}
.card b{color:var(--gold)}
</style>
</head>

<body>
<div class="app">
<header>
  <h1>Garvetur Porto Pro — Mapa Lite</h1>
  <div class="badge">Acesso Equipa · Modo Leitura</div>
</header>

<div class="kpis">
  <div class="kpi">Total: <b id="k_total">0</b></div>
  <div class="kpi">Em construção: <b id="k_c">0</b></div>
  <div class="kpi">Licenciado: <b id="k_l">0</b></div>
  <div class="kpi">Concluído: <b id="k_f">0</b></div>
  <button id="focus">Focar AMP/Porto</button>
  <button id="reload">Recarregar</button>
</div>

<aside class="sidebar">
  <div class="section">
    <label>Pesquisa global</label>
    <input id="q" placeholder="Nome, concelho, promotor…">
    <p style="font-size:11px;opacity:.7;margin-top:6px">
      Versão Lite: carrega apenas dados essenciais. Cache local ativa.
    </p>
  </div>

  <div class="section">
    <label>Concelho</label>
    <select id="f_concelho"><option value="">(Todos)</option></select>

    <label style="margin-top:6px">Estado</label>
    <select id="f_estado">
      <option value="">Todos</option>
      <option value="em_construcao">Em construção</option>
      <option value="licenciado">Licenciado</option>
      <option value="concluido">Concluído</option>
    </select>
  </div>

  <div class="section">
    <button id="apply">Aplicar</button>
    <button id="clear">Limpar</button>
  </div>

  <div class="section">
    <b>Resultados</b>
    <div id="list" class="list"></div>
  </div>
</aside>

<div id="map"></div>
</div>

<script>
const AMP=[41.15,-8.61], ZOOM=12;
const CSV='data/gpp-mapa.csv';
let MAP, CLUSTER, RAW=[], FILT=[];

const el=id=>document.getElementById(id);
const norm=s=>String(s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');

function stateKey(s){
  const x=norm(s);
  if(x.includes('constr'))return'em_construcao';
  if(x.includes('licen'))return'licenciado';
  if(x.includes('concl'))return'concluido';
  return'';
}

function loadCSV(){
  return new Promise(res=>{
    Papa.parse(CSV,{
      download:true,header:true,skipEmptyLines:true,worker:true,
      complete:r=>res(r.data||[])
    });
  });
}

function apply(){
  const q=norm(el('q').value);
  const c=el('f_concelho').value;
  const e=el('f_estado').value;

  FILT=RAW.filter(p=>{
    if(q && !norm(p.nome+p.concelho+p.promotor).includes(q))return false;
    if(c && p.concelho!==c)return false;
    if(e && p.estado!==e)return false;
    return true;
  });
}

function renderKPIs(){
  el('k_total').textContent=FILT.length;
  el('k_c').textContent=FILT.filter(x=>x.estado==='em_construcao').length;
  el('k_l').textContent=FILT.filter(x=>x.estado==='licenciado').length;
  el('k_f').textContent=FILT.filter(x=>x.estado==='concluido').length;
}

function renderList(){
  const box=el('list'); box.innerHTML='';
  FILT.forEach(p=>{
    const d=document.createElement('div');
    d.className='card';
    d.innerHTML=`<b>${p.nome||'—'}</b><br>${p.concelho||''}<br>${p.estado||''}`;
    d.onclick=()=>MAP.setView([p.lat,p.lng],16);
    box.appendChild(d);
  });
}

function renderMap(){
  if(CLUSTER)CLUSTER.clearLayers();
  FILT.forEach(p=>{
    if(!p.lat||!p.lng)return;
    const m=L.marker([p.lat,p.lng]);
    m.bindPopup(`<b>${p.nome||''}</b><br>${p.concelho||''}`);
    CLUSTER.addLayer(m);
  });
}

async function init(){
  RAW=await loadCSV();
  RAW=RAW.map(r=>({
    id:r.refInterna||Math.random().toString(36).slice(2),
    nome:r.nome||'',
    concelho:r.concelho||'',
    promotor:r.promotor||'',
    estado:stateKey(r.estado),
    lat:Number(r.lat||r._lat),
    lng:Number(r.lng||r._lng)
  }));

  MAP=L.map('map').setView(AMP,ZOOM);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(MAP);
  CLUSTER=L.markerClusterGroup(); MAP.addLayer(CLUSTER);

  const conc=[...new Set(RAW.map(x=>x.concelho).filter(Boolean))].sort();
  el('f_concelho').innerHTML='<option value="">(Todos)</option>'+conc.map(c=>`<option>${c}</option>`).join('');

  run();
}

function run(){apply();renderKPIs();renderList();renderMap();}

el('apply').onclick=run;
el('clear').onclick=()=>{el('q').value='';el('f_concelho').value='';el('f_estado').value='';run();}
el('reload').onclick=()=>location.reload();
el('focus').onclick=()=>MAP.setView(AMP,ZOOM);

init();
</script>
</body>
</html>
